<html>
<head>
<title>GenerateViewConfigJs.js.flow</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
GenerateViewConfigJs.js.flow</font>
</center></td></tr></table>
<pre><span class="s0">/**</span>
 <span class="s0">* Copyright (c) Meta Platforms, Inc. and affiliates.</span>
 <span class="s0">*</span>
 <span class="s0">* This source code is licensed under the MIT license found in the</span>
 <span class="s0">* LICENSE file in the root directory of this source tree.</span>
 <span class="s0">*</span>
 <span class="s0">* @flow</span>
 <span class="s0">* @format</span>
 <span class="s0">*/</span>

<span class="s0">'use strict';</span>
<span class="s0">import type {</span>
  <span class="s0">ComponentShape,</span>
  <span class="s0">EventTypeShape,</span>
  <span class="s0">PropTypeAnnotation,</span>
<span class="s0">} from '../../CodegenSchema';</span>
<span class="s0">import type {SchemaType} from '../../CodegenSchema';</span>

<span class="s0">const j = require('jscodeshift');</span>

<span class="s0">// File path -&gt; contents</span>
<span class="s0">type FilesOutput = Map&lt;string, string&gt;;</span>

<span class="s0">const FileTemplate = ({</span>
  <span class="s0">imports,</span>
  <span class="s0">componentConfig,</span>
<span class="s0">}: {</span>
  <span class="s0">imports: string,</span>
  <span class="s0">componentConfig: string,</span>
<span class="s0">}) =&gt; `</span>
<span class="s0">/**</span>
 <span class="s0">* This code was generated by [react-native-codegen](https://www.npmjs.com/package/react-native-codegen).</span>
 <span class="s0">*</span>
 <span class="s0">* Do not edit this file as changes may cause incorrect behavior and will be lost</span>
 <span class="s0">* once the code is regenerated.</span>
 <span class="s0">*</span>
 <span class="s0">* @flow</span>
 <span class="s0">*</span>
 <span class="s0">* ${'@'}generated by codegen project: GenerateViewConfigJs.js</span>
 <span class="s0">*/</span>

<span class="s0">'use strict';</span>

<span class="s0">${imports}</span>

<span class="s0">${componentConfig}</span>
<span class="s0">`;</span>

<span class="s0">// We use this to add to a set. Need to make sure we aren't importing</span>
<span class="s0">// this multiple times.</span>
<span class="s0">const UIMANAGER_IMPORT = 'const {UIManager} = require(&quot;react-native&quot;)';</span>

<span class="s0">function getReactDiffProcessValue(typeAnnotation: PropTypeAnnotation) {</span>
  <span class="s0">switch (typeAnnotation.type) {</span>
    <span class="s0">case 'BooleanTypeAnnotation':</span>
    <span class="s0">case 'StringTypeAnnotation':</span>
    <span class="s0">case 'Int32TypeAnnotation':</span>
    <span class="s0">case 'DoubleTypeAnnotation':</span>
    <span class="s0">case 'FloatTypeAnnotation':</span>
    <span class="s0">case 'ObjectTypeAnnotation':</span>
    <span class="s0">case 'StringEnumTypeAnnotation':</span>
    <span class="s0">case 'Int32EnumTypeAnnotation':</span>
    <span class="s0">case 'MixedTypeAnnotation':</span>
      <span class="s0">return j.literal(true);</span>
    <span class="s0">case 'ReservedPropTypeAnnotation':</span>
      <span class="s0">switch (typeAnnotation.name) {</span>
        <span class="s0">case 'ColorPrimitive':</span>
          <span class="s0">return j.template</span>
            <span class="s0">.expression`{ process: require('react-native/Libraries/StyleSheet/processColor').default }`;</span>
        <span class="s0">case 'ImageSourcePrimitive':</span>
          <span class="s0">return j.template</span>
            <span class="s0">.expression`{ process: require('react-native/Libraries/Image/resolveAssetSource') }`;</span>
        <span class="s0">case 'ImageRequestPrimitive':</span>
          <span class="s0">throw new Error('ImageRequest should not be used in props');</span>
        <span class="s0">case 'PointPrimitive':</span>
          <span class="s0">return j.template</span>
            <span class="s0">.expression`{ diff: require('react-native/Libraries/Utilities/differ/pointsDiffer') }`;</span>
        <span class="s0">case 'EdgeInsetsPrimitive':</span>
          <span class="s0">return j.template</span>
            <span class="s0">.expression`{ diff: require('react-native/Libraries/Utilities/differ/insetsDiffer') }`;</span>
        <span class="s0">case 'DimensionPrimitive':</span>
          <span class="s0">return j.literal(true);</span>
        <span class="s0">default:</span>
          <span class="s0">(typeAnnotation.name: empty);</span>
          <span class="s0">throw new Error(</span>
            <span class="s0">`Received unknown native typeAnnotation: &quot;${typeAnnotation.name}&quot;`,</span>
          <span class="s0">);</span>
      <span class="s0">}</span>
    <span class="s0">case 'ArrayTypeAnnotation':</span>
      <span class="s0">if (typeAnnotation.elementType.type === 'ReservedPropTypeAnnotation') {</span>
        <span class="s0">switch (typeAnnotation.elementType.name) {</span>
          <span class="s0">case 'ColorPrimitive':</span>
            <span class="s0">return j.template</span>
              <span class="s0">.expression`{ process: require('react-native/Libraries/StyleSheet/processColorArray') }`;</span>
          <span class="s0">case 'ImageSourcePrimitive':</span>
          <span class="s0">case 'PointPrimitive':</span>
          <span class="s0">case 'EdgeInsetsPrimitive':</span>
          <span class="s0">case 'DimensionPrimitive':</span>
            <span class="s0">return j.literal(true);</span>
          <span class="s0">default:</span>
            <span class="s0">throw new Error(</span>
              <span class="s0">`Received unknown array native typeAnnotation: &quot;${typeAnnotation.elementType.name}&quot;`,</span>
            <span class="s0">);</span>
        <span class="s0">}</span>
      <span class="s0">}</span>
      <span class="s0">return j.literal(true);</span>
    <span class="s0">default:</span>
      <span class="s0">(typeAnnotation: empty);</span>
      <span class="s0">throw new Error(</span>
        <span class="s0">`Received unknown typeAnnotation: &quot;${typeAnnotation.type}&quot;`,</span>
      <span class="s0">);</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s0">const ComponentTemplate = ({</span>
  <span class="s0">componentName,</span>
  <span class="s0">paperComponentName,</span>
  <span class="s0">paperComponentNameDeprecated,</span>
<span class="s0">}: {</span>
  <span class="s0">componentName: string,</span>
  <span class="s0">paperComponentName: ?string,</span>
  <span class="s0">paperComponentNameDeprecated: ?string,</span>
<span class="s0">}) =&gt; {</span>
  <span class="s0">const nativeComponentName = paperComponentName ?? componentName;</span>

  <span class="s0">return `</span>
<span class="s0">let nativeComponentName = '${nativeComponentName}';</span>
<span class="s0">${</span>
  <span class="s0">paperComponentNameDeprecated != null</span>
    <span class="s0">? DeprecatedComponentNameCheckTemplate({</span>
        <span class="s0">componentName,</span>
        <span class="s0">paperComponentNameDeprecated,</span>
      <span class="s0">})</span>
    <span class="s0">: ''</span>
<span class="s0">}</span>

<span class="s0">export const __INTERNAL_VIEW_CONFIG = VIEW_CONFIG;</span>

<span class="s0">export default NativeComponentRegistry.get(nativeComponentName, () =&gt; __INTERNAL_VIEW_CONFIG);</span>
<span class="s0">`.trim();</span>
<span class="s0">};</span>

<span class="s0">// Check whether the native component exists in the app binary.</span>
<span class="s0">// Old getViewManagerConfig() checks for the existance of the native Paper view manager. Not available in Bridgeless.</span>
<span class="s0">// New hasViewManagerConfig() queries Fabricâ€™s native component registry directly.</span>
<span class="s0">const DeprecatedComponentNameCheckTemplate = ({</span>
  <span class="s0">componentName,</span>
  <span class="s0">paperComponentNameDeprecated,</span>
<span class="s0">}: {</span>
  <span class="s0">componentName: string,</span>
  <span class="s0">paperComponentNameDeprecated: string,</span>
<span class="s0">}) =&gt;</span>
  <span class="s0">`</span>
<span class="s0">if (UIManager.hasViewManagerConfig('${componentName}')) {</span>
  <span class="s0">nativeComponentName = '${componentName}';</span>
<span class="s0">} else if (UIManager.hasViewManagerConfig('${paperComponentNameDeprecated}')) {</span>
  <span class="s0">nativeComponentName = '${paperComponentNameDeprecated}';</span>
<span class="s0">} else {</span>
  <span class="s0">throw new Error('Failed to find native component for either &quot;${componentName}&quot; or &quot;${paperComponentNameDeprecated}&quot;');</span>
<span class="s0">}</span>
<span class="s0">`.trim();</span>

<span class="s0">// Replicates the behavior of RCTNormalizeInputEventName in RCTEventDispatcher.m</span>
<span class="s0">function normalizeInputEventName(name: string) {</span>
  <span class="s0">if (name.startsWith('on')) {</span>
    <span class="s0">return name.replace(/^on/, 'top');</span>
  <span class="s0">} else if (!name.startsWith('top')) {</span>
    <span class="s0">return `top${name[0].toUpperCase()}${name.slice(1)}`;</span>
  <span class="s0">}</span>

  <span class="s0">return name;</span>
<span class="s0">}</span>

<span class="s0">// Replicates the behavior of viewConfig in RCTComponentData.m</span>
<span class="s0">function getValidAttributesForEvents(</span>
  <span class="s0">events: $ReadOnlyArray&lt;EventTypeShape&gt;,</span>
  <span class="s0">imports: Set&lt;string&gt;,</span>
<span class="s0">) {</span>
  <span class="s0">imports.add(</span>
    <span class="s0">&quot;const {ConditionallyIgnoredEventHandlers} = require('react-native/Libraries/NativeComponent/ViewConfigIgnore');&quot;,</span>
  <span class="s0">);</span>

  <span class="s0">const validAttributes = j.objectExpression(</span>
    <span class="s0">events.map(eventType =&gt; {</span>
      <span class="s0">return j.property('init', j.identifier(eventType.name), j.literal(true));</span>
    <span class="s0">}),</span>
  <span class="s0">);</span>

  <span class="s0">return j.callExpression(j.identifier('ConditionallyIgnoredEventHandlers'), [</span>
    <span class="s0">validAttributes,</span>
  <span class="s0">]);</span>
<span class="s0">}</span>

<span class="s0">function generateBubblingEventInfo(</span>
  <span class="s0">event: EventTypeShape,</span>
  <span class="s0">nameOveride: void | string,</span>
<span class="s0">) {</span>
  <span class="s0">return j.property(</span>
    <span class="s0">'init',</span>
    <span class="s0">j.identifier(nameOveride || normalizeInputEventName(event.name)),</span>
    <span class="s0">j.objectExpression([</span>
      <span class="s0">j.property(</span>
        <span class="s0">'init',</span>
        <span class="s0">j.identifier('phasedRegistrationNames'),</span>
        <span class="s0">j.objectExpression([</span>
          <span class="s0">j.property(</span>
            <span class="s0">'init',</span>
            <span class="s0">j.identifier('captured'),</span>
            <span class="s0">j.literal(`${event.name}Capture`),</span>
          <span class="s0">),</span>
          <span class="s0">j.property('init', j.identifier('bubbled'), j.literal(event.name)),</span>
        <span class="s0">]),</span>
      <span class="s0">),</span>
    <span class="s0">]),</span>
  <span class="s0">);</span>
<span class="s0">}</span>

<span class="s0">function generateDirectEventInfo(</span>
  <span class="s0">event: EventTypeShape,</span>
  <span class="s0">nameOveride: void | string,</span>
<span class="s0">) {</span>
  <span class="s0">return j.property(</span>
    <span class="s0">'init',</span>
    <span class="s0">j.identifier(nameOveride || normalizeInputEventName(event.name)),</span>
    <span class="s0">j.objectExpression([</span>
      <span class="s0">j.property(</span>
        <span class="s0">'init',</span>
        <span class="s0">j.identifier('registrationName'),</span>
        <span class="s0">j.literal(event.name),</span>
      <span class="s0">),</span>
    <span class="s0">]),</span>
  <span class="s0">);</span>
<span class="s0">}</span>

<span class="s0">function buildViewConfig(</span>
  <span class="s0">schema: SchemaType,</span>
  <span class="s0">componentName: string,</span>
  <span class="s0">component: ComponentShape,</span>
  <span class="s0">imports: Set&lt;string&gt;,</span>
<span class="s0">) {</span>
  <span class="s0">const componentProps = component.props;</span>
  <span class="s0">const componentEvents = component.events;</span>

  <span class="s0">component.extendsProps.forEach(extendProps =&gt; {</span>
    <span class="s0">switch (extendProps.type) {</span>
      <span class="s0">case 'ReactNativeBuiltInType':</span>
        <span class="s0">switch (extendProps.knownTypeName) {</span>
          <span class="s0">case 'ReactNativeCoreViewProps':</span>
            <span class="s0">imports.add(</span>
              <span class="s0">&quot;const NativeComponentRegistry = require('react-native/Libraries/NativeComponent/NativeComponentRegistry');&quot;,</span>
            <span class="s0">);</span>

            <span class="s0">return;</span>
          <span class="s0">default:</span>
            <span class="s0">(extendProps.knownTypeName: empty);</span>
            <span class="s0">throw new Error('Invalid knownTypeName');</span>
        <span class="s0">}</span>
      <span class="s0">default:</span>
        <span class="s0">(extendProps.type: empty);</span>
        <span class="s0">throw new Error('Invalid extended type');</span>
    <span class="s0">}</span>
  <span class="s0">});</span>

  <span class="s0">const validAttributes = j.objectExpression([</span>
    <span class="s0">...componentProps.map(schemaProp =&gt; {</span>
      <span class="s0">return j.property(</span>
        <span class="s0">'init',</span>
        <span class="s0">j.identifier(schemaProp.name),</span>
        <span class="s0">getReactDiffProcessValue(schemaProp.typeAnnotation),</span>
      <span class="s0">);</span>
    <span class="s0">}),</span>
    <span class="s0">...(componentEvents.length &gt; 0</span>
      <span class="s0">? [</span>
          <span class="s0">j.spreadProperty(</span>
            <span class="s0">getValidAttributesForEvents(componentEvents, imports),</span>
          <span class="s0">),</span>
        <span class="s0">]</span>
      <span class="s0">: []),</span>
  <span class="s0">]);</span>

  <span class="s0">const bubblingEventNames = component.events</span>
    <span class="s0">.filter(event =&gt; event.bubblingType === 'bubble')</span>
    <span class="s0">.reduce((bubblingEvents: Array&lt;any&gt;, event) =&gt; {</span>
      <span class="s0">// We add in the deprecated paper name so that it is in the view config.</span>
      <span class="s0">// This means either the old event name or the new event name can fire</span>
      <span class="s0">// and be sent to the listener until the old top level name is removed.</span>
      <span class="s0">if (event.paperTopLevelNameDeprecated) {</span>
        <span class="s0">bubblingEvents.push(</span>
          <span class="s0">generateBubblingEventInfo(event, event.paperTopLevelNameDeprecated),</span>
        <span class="s0">);</span>
      <span class="s0">} else {</span>
        <span class="s0">bubblingEvents.push(generateBubblingEventInfo(event));</span>
      <span class="s0">}</span>
      <span class="s0">return bubblingEvents;</span>
    <span class="s0">}, []);</span>

  <span class="s0">const bubblingEvents =</span>
    <span class="s0">bubblingEventNames.length &gt; 0</span>
      <span class="s0">? j.property(</span>
          <span class="s0">'init',</span>
          <span class="s0">j.identifier('bubblingEventTypes'),</span>
          <span class="s0">j.objectExpression(bubblingEventNames),</span>
        <span class="s0">)</span>
      <span class="s0">: null;</span>

  <span class="s0">const directEventNames = component.events</span>
    <span class="s0">.filter(event =&gt; event.bubblingType === 'direct')</span>
    <span class="s0">.reduce((directEvents: Array&lt;any&gt;, event) =&gt; {</span>
      <span class="s0">// We add in the deprecated paper name so that it is in the view config.</span>
      <span class="s0">// This means either the old event name or the new event name can fire</span>
      <span class="s0">// and be sent to the listener until the old top level name is removed.</span>
      <span class="s0">if (event.paperTopLevelNameDeprecated) {</span>
        <span class="s0">directEvents.push(</span>
          <span class="s0">generateDirectEventInfo(event, event.paperTopLevelNameDeprecated),</span>
        <span class="s0">);</span>
      <span class="s0">} else {</span>
        <span class="s0">directEvents.push(generateDirectEventInfo(event));</span>
      <span class="s0">}</span>
      <span class="s0">return directEvents;</span>
    <span class="s0">}, []);</span>

  <span class="s0">const directEvents =</span>
    <span class="s0">directEventNames.length &gt; 0</span>
      <span class="s0">? j.property(</span>
          <span class="s0">'init',</span>
          <span class="s0">j.identifier('directEventTypes'),</span>
          <span class="s0">j.objectExpression(directEventNames),</span>
        <span class="s0">)</span>
      <span class="s0">: null;</span>

  <span class="s0">const properties = [</span>
    <span class="s0">j.property(</span>
      <span class="s0">'init',</span>
      <span class="s0">j.identifier('uiViewClassName'),</span>
      <span class="s0">j.literal(componentName),</span>
    <span class="s0">),</span>
    <span class="s0">bubblingEvents,</span>
    <span class="s0">directEvents,</span>
    <span class="s0">j.property('init', j.identifier('validAttributes'), validAttributes),</span>
  <span class="s0">].filter(Boolean);</span>

  <span class="s0">return j.objectExpression(properties);</span>
<span class="s0">}</span>

<span class="s0">function buildCommands(</span>
  <span class="s0">schema: SchemaType,</span>
  <span class="s0">componentName: string,</span>
  <span class="s0">component: ComponentShape,</span>
  <span class="s0">imports: Set&lt;string&gt;,</span>
<span class="s0">) {</span>
  <span class="s0">const commands = component.commands;</span>

  <span class="s0">if (commands.length === 0) {</span>
    <span class="s0">return null;</span>
  <span class="s0">}</span>

  <span class="s0">imports.add(</span>
    <span class="s0">'const {dispatchCommand} = require(&quot;react-native/Libraries/ReactNative/RendererProxy&quot;);',</span>
  <span class="s0">);</span>

  <span class="s0">const properties = commands.map(command =&gt; {</span>
    <span class="s0">const commandName = command.name;</span>
    <span class="s0">const params = command.typeAnnotation.params;</span>

    <span class="s0">const commandNameLiteral = j.literal(commandName);</span>
    <span class="s0">const commandNameIdentifier = j.identifier(commandName);</span>
    <span class="s0">const arrayParams = j.arrayExpression(</span>
      <span class="s0">params.map(param =&gt; {</span>
        <span class="s0">return j.identifier(param.name);</span>
      <span class="s0">}),</span>
    <span class="s0">);</span>

    <span class="s0">const expression = j.template</span>
      <span class="s0">.expression`dispatchCommand(ref, ${commandNameLiteral}, ${arrayParams})`;</span>

    <span class="s0">const functionParams = params.map(param =&gt; {</span>
      <span class="s0">return j.identifier(param.name);</span>
    <span class="s0">});</span>

    <span class="s0">const property = j.property(</span>
      <span class="s0">'init',</span>
      <span class="s0">commandNameIdentifier,</span>
      <span class="s0">j.functionExpression(</span>
        <span class="s0">null,</span>
        <span class="s0">[j.identifier('ref'), ...functionParams],</span>
        <span class="s0">j.blockStatement([j.expressionStatement(expression)]),</span>
      <span class="s0">),</span>
    <span class="s0">);</span>
    <span class="s0">property.method = true;</span>

    <span class="s0">return property;</span>
  <span class="s0">});</span>

  <span class="s0">return j.exportNamedDeclaration(</span>
    <span class="s0">j.variableDeclaration('const', [</span>
      <span class="s0">j.variableDeclarator(</span>
        <span class="s0">j.identifier('Commands'),</span>
        <span class="s0">j.objectExpression(properties),</span>
      <span class="s0">),</span>
    <span class="s0">]),</span>
  <span class="s0">);</span>
<span class="s0">}</span>

<span class="s0">module.exports = {</span>
  <span class="s0">generate(libraryName: string, schema: SchemaType): FilesOutput {</span>
    <span class="s0">try {</span>
      <span class="s0">const fileName = `${libraryName}NativeViewConfig.js`;</span>
      <span class="s0">const imports: Set&lt;string&gt; = new Set();</span>

      <span class="s0">const moduleResults = Object.keys(schema.modules)</span>
        <span class="s0">.map(moduleName =&gt; {</span>
          <span class="s0">const module = schema.modules[moduleName];</span>
          <span class="s0">if (module.type !== 'Component') {</span>
            <span class="s0">return;</span>
          <span class="s0">}</span>

          <span class="s0">const {components} = module;</span>

          <span class="s0">return Object.keys(components)</span>
            <span class="s0">.map((componentName: string) =&gt; {</span>
              <span class="s0">const component = components[componentName];</span>

              <span class="s0">if (component.paperComponentNameDeprecated) {</span>
                <span class="s0">imports.add(UIMANAGER_IMPORT);</span>
              <span class="s0">}</span>

              <span class="s0">const replacedTemplate = ComponentTemplate({</span>
                <span class="s0">componentName,</span>
                <span class="s0">paperComponentName: component.paperComponentName,</span>
                <span class="s0">paperComponentNameDeprecated:</span>
                  <span class="s0">component.paperComponentNameDeprecated,</span>
              <span class="s0">});</span>

              <span class="s0">const replacedSourceRoot = j.withParser('flow')(replacedTemplate);</span>

              <span class="s0">const paperComponentName =</span>
                <span class="s0">component.paperComponentName ?? componentName;</span>

              <span class="s0">replacedSourceRoot</span>
                <span class="s0">.find(j.Identifier, {</span>
                  <span class="s0">name: 'VIEW_CONFIG',</span>
                <span class="s0">})</span>
                <span class="s0">.replaceWith(</span>
                  <span class="s0">buildViewConfig(</span>
                    <span class="s0">schema,</span>
                    <span class="s0">paperComponentName,</span>
                    <span class="s0">component,</span>
                    <span class="s0">imports,</span>
                  <span class="s0">),</span>
                <span class="s0">);</span>

              <span class="s0">const commands = buildCommands(</span>
                <span class="s0">schema,</span>
                <span class="s0">paperComponentName,</span>
                <span class="s0">component,</span>
                <span class="s0">imports,</span>
              <span class="s0">);</span>
              <span class="s0">if (commands) {</span>
                <span class="s0">replacedSourceRoot</span>
                  <span class="s0">.find(j.ExportDefaultDeclaration)</span>
                  <span class="s0">.insertAfter(j(commands).toSource());</span>
              <span class="s0">}</span>

              <span class="s0">const replacedSource: string = replacedSourceRoot.toSource({</span>
                <span class="s0">quote: 'single',</span>
                <span class="s0">trailingComma: true,</span>
              <span class="s0">});</span>

              <span class="s0">return replacedSource;</span>
            <span class="s0">})</span>
            <span class="s0">.join('\n\n');</span>
        <span class="s0">})</span>
        <span class="s0">.filter(Boolean)</span>
        <span class="s0">.join('\n\n');</span>

      <span class="s0">const replacedTemplate = FileTemplate({</span>
        <span class="s0">componentConfig: moduleResults,</span>
        <span class="s0">imports: Array.from(imports).sort().join('\n'),</span>
      <span class="s0">});</span>

      <span class="s0">return new Map([[fileName, replacedTemplate]]);</span>
    <span class="s0">} catch (error) {</span>
      <span class="s0">console.error(`\nError parsing schema for ${libraryName}\n`);</span>
      <span class="s0">console.error(JSON.stringify(schema));</span>
      <span class="s0">throw error;</span>
    <span class="s0">}</span>
  <span class="s0">},</span>
<span class="s0">};</span>
</pre>
</body>
</html>