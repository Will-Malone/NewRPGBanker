<html>
<head>
<title>GestureDetector.tsx</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #a9b7c6;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #6897bb; font-style: italic;}
.s6 { color: #ffc66d;}
.s7 { color: #9876aa; font-style: italic;}
.s8 { color: #cc7832; font-style: italic;}
.s9 { color: #a9b7c6;}
.s10 { color: #e8bf6a;}
.s11 { color: #bbb529;}
.s12 { color: #d0d0ff;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
GestureDetector.tsx</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s2">React</span><span class="s1">, { </span><span class="s2">useContext</span><span class="s1">, </span><span class="s2">useEffect</span><span class="s1">, </span><span class="s2">useRef</span><span class="s1">, </span><span class="s2">useState </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'react'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">GestureType</span><span class="s1">,</span>
  <span class="s2">HandlerCallbacks</span><span class="s1">,</span>
  <span class="s2">BaseGesture</span><span class="s1">,</span>
  <span class="s2">GestureRef</span><span class="s1">,</span>
  <span class="s2">CALLBACK_TYPE</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'./gesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">Reanimated</span><span class="s1">, </span><span class="s2">SharedValue </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'./reanimatedWrapper'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">registerHandler</span><span class="s1">, </span><span class="s2">unregisterHandler </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlersRegistry'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">RNGestureHandlerModule </span><span class="s0">from </span><span class="s3">'../../RNGestureHandlerModule'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">baseGestureHandlerWithMonitorProps</span><span class="s1">,</span>
  <span class="s2">filterConfig</span><span class="s1">,</span>
  <span class="s2">findNodeHandle</span><span class="s1">,</span>
  <span class="s2">GestureTouchEvent</span><span class="s1">,</span>
  <span class="s2">GestureUpdateEvent</span><span class="s1">,</span>
  <span class="s2">GestureStateChangeEvent</span><span class="s1">,</span>
  <span class="s2">HandlerStateChangeEvent</span><span class="s1">,</span>
  <span class="s2">scheduleFlushOperations</span><span class="s1">,</span>
  <span class="s2">UserSelect</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../gestureHandlerCommon'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">GestureStateManager</span><span class="s1">,</span>
  <span class="s2">GestureStateManagerType</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'./gestureStateManager'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">flingGestureHandlerProps </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../FlingGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">forceTouchGestureHandlerProps </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../ForceTouchGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">longPressGestureHandlerProps </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../LongPressGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">panGestureHandlerProps</span><span class="s1">,</span>
  <span class="s2">panGestureHandlerCustomNativeProps</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../PanGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">tapGestureHandlerProps </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../TapGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">State </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../../State'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">TouchEventType </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../../TouchEventType'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">ComposedGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'./gestureComposition'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">ActionType </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../../ActionType'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">isFabric</span><span class="s1">,</span>
  <span class="s2">isJestEnv</span><span class="s1">,</span>
  <span class="s2">REACT_NATIVE_VERSION</span><span class="s1">,</span>
  <span class="s2">tagMessage</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../../utils'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">getShadowNodeFromRef </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../../getShadowNodeFromRef'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">Platform </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'react-native'</span><span class="s1">;</span>
<span class="s0">import type </span><span class="s2">RNGestureHandlerModuleWeb </span><span class="s0">from </span><span class="s3">'../../RNGestureHandlerModule.web'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">onGestureHandlerEvent </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'./eventReceiver'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">RNRenderer </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../../RNRenderer'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">isNewWebImplementationEnabled </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../../EnableNewWebImplementation'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">nativeViewGestureHandlerProps </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../NativeViewGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">GestureHandlerRootViewContext </span><span class="s0">from </span><span class="s3">'../../GestureHandlerRootViewContext'</span><span class="s1">;</span>

<span class="s0">declare const </span><span class="s1">global</span><span class="s0">: </span><span class="s1">{</span>
  <span class="s1">isFormsStackingContext</span><span class="s0">: </span><span class="s1">(</span><span class="s2">node</span><span class="s0">: </span><span class="s2">unknown</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">boolean </span><span class="s0">| </span><span class="s2">null</span><span class="s1">; </span><span class="s4">// JSI function</span>
<span class="s1">};</span>

<span class="s0">const </span><span class="s1">ALLOWED_PROPS </span><span class="s0">= </span><span class="s1">[</span>
  <span class="s0">...</span><span class="s2">baseGestureHandlerWithMonitorProps</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">tapGestureHandlerProps</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">panGestureHandlerProps</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">panGestureHandlerCustomNativeProps</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">longPressGestureHandlerProps</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">forceTouchGestureHandlerProps</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">flingGestureHandlerProps</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">nativeViewGestureHandlerProps</span><span class="s1">,</span>
<span class="s1">];</span>

<span class="s0">export type </span><span class="s2">GestureConfigReference </span><span class="s0">= </span><span class="s1">{</span>
  <span class="s1">config</span><span class="s0">: </span><span class="s2">GestureType</span><span class="s1">[];</span>
  <span class="s1">animatedEventHandler</span><span class="s0">: </span><span class="s2">unknown</span><span class="s1">;</span>
  <span class="s1">animatedHandlers</span><span class="s0">: </span><span class="s2">SharedValue</span><span class="s1">&lt;</span>
    <span class="s2">HandlerCallbacks</span><span class="s1">&lt;</span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt;&gt;[] </span><span class="s0">| </span><span class="s2">null</span>
  <span class="s1">&gt; </span><span class="s0">| </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s1">firstExecution</span><span class="s0">: </span><span class="s2">boolean</span><span class="s1">;</span>
  <span class="s1">useReanimatedHook</span><span class="s0">: </span><span class="s2">boolean</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s0">function </span><span class="s1">convertToHandlerTag(</span><span class="s2">ref</span><span class="s0">: </span><span class="s2">GestureRef</span><span class="s1">)</span><span class="s0">: </span><span class="s2">number </span><span class="s1">{</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s0">typeof </span><span class="s2">ref </span><span class="s0">=== </span><span class="s3">'number'</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s2">ref</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s2">ref </span><span class="s0">instanceof </span><span class="s2">BaseGesture</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s2">ref</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
    <span class="s4">// @ts-ignore in this case it should be a ref either to gesture object or</span>
    <span class="s4">// a gesture handler component, in both cases handlerTag property exists</span>
    <span class="s0">return </span><span class="s2">ref</span><span class="s1">.</span><span class="s2">current</span><span class="s1">?.</span><span class="s2">handlerTag </span><span class="s0">?? -</span><span class="s5">1</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">extractValidHandlerTags(</span><span class="s2">interactionGroup</span><span class="s0">: </span><span class="s2">GestureRef</span><span class="s1">[] </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">) {</span>
  <span class="s0">return </span><span class="s1">(</span>
    <span class="s2">interactionGroup</span><span class="s1">?.</span><span class="s6">map</span><span class="s1">(</span><span class="s2">convertToHandlerTag</span><span class="s1">)?.</span><span class="s6">filter</span><span class="s1">((</span><span class="s2">tag</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">tag </span><span class="s0">&gt; </span><span class="s5">0</span><span class="s1">) </span><span class="s0">?? </span><span class="s1">[]</span>
  <span class="s1">);</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">dropHandlers(</span><span class="s2">preparedGesture</span><span class="s0">: </span><span class="s2">GestureConfigReference</span><span class="s1">) {</span>
  <span class="s0">for </span><span class="s1">(</span><span class="s0">const </span><span class="s1">handler </span><span class="s0">of </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">) {</span>
    <span class="s2">RNGestureHandlerModule</span><span class="s1">.</span><span class="s6">dropGestureHandler</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">);</span>

    <span class="s6">unregisterHandler</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">testId</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s6">scheduleFlushOperations</span><span class="s1">();</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">checkGestureCallbacksForWorklets(</span><span class="s2">gesture</span><span class="s0">: </span><span class="s2">GestureType</span><span class="s1">) {</span>
  <span class="s4">// if a gesture is explicitly marked to run on the JS thread there is no need to check</span>
  <span class="s4">// if callbacks are worklets as the user is aware they will be ran on the JS thread</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">runOnJS</span><span class="s1">) {</span>
    <span class="s0">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">areSomeNotWorklets </span><span class="s0">= </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlers</span><span class="s1">.</span><span class="s2">isWorklet</span><span class="s1">.</span><span class="s6">includes</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
  <span class="s0">const </span><span class="s1">areSomeWorklets </span><span class="s0">= </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlers</span><span class="s1">.</span><span class="s2">isWorklet</span><span class="s1">.</span><span class="s6">includes</span><span class="s1">(</span><span class="s7">true</span><span class="s1">);</span>

  <span class="s4">// if some of the callbacks are worklets and some are not, and the gesture is not</span>
  <span class="s4">// explicitly marked with `.runOnJS(true)` show an error</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">areSomeNotWorklets </span><span class="s0">&amp;&amp; </span><span class="s2">areSomeWorklets</span><span class="s1">) {</span>
    <span class="s2">console</span><span class="s1">.</span><span class="s6">error</span><span class="s1">(</span>
      <span class="s6">tagMessage</span><span class="s1">(</span>
        <span class="s3">`Some of the callbacks in the gesture are worklets and some are not. Either make sure that all calbacks are marked as 'worklet' if you wish to run them on the UI thread or use '.runOnJS(true)' modifier on the gesture explicitly to run all callbacks on the JS thread.`</span>
      <span class="s1">)</span>
    <span class="s1">);</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">interface </span><span class="s2">WebEventHandler </span><span class="s1">{</span>
  <span class="s1">onGestureHandlerEvent</span><span class="s0">: </span><span class="s1">(</span><span class="s2">event</span><span class="s0">: </span><span class="s2">HandlerStateChangeEvent</span><span class="s1">&lt;</span><span class="s2">unknown</span><span class="s1">&gt;) </span><span class="s0">=&gt; </span><span class="s2">void</span><span class="s1">;</span>
  <span class="s1">onGestureHandlerStateChange</span><span class="s0">?: </span><span class="s1">(</span>
    <span class="s2">event</span><span class="s0">: </span><span class="s2">HandlerStateChangeEvent</span><span class="s1">&lt;</span><span class="s2">unknown</span><span class="s1">&gt;</span>
  <span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">void</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">interface </span><span class="s2">AttachHandlersConfig </span><span class="s1">{</span>
  <span class="s1">preparedGesture</span><span class="s0">: </span><span class="s2">GestureConfigReference</span><span class="s1">;</span>
  <span class="s1">gestureConfig</span><span class="s0">: </span><span class="s2">ComposedGesture </span><span class="s0">| </span><span class="s2">GestureType</span><span class="s1">;</span>
  <span class="s1">gesture</span><span class="s0">: </span><span class="s2">GestureType</span><span class="s1">[];</span>
  <span class="s1">viewTag</span><span class="s0">: </span><span class="s2">number</span><span class="s1">;</span>
  <span class="s1">webEventHandlersRef</span><span class="s0">: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">RefObject</span><span class="s1">&lt;</span><span class="s2">WebEventHandler</span><span class="s1">&gt;;</span>
  <span class="s1">mountedRef</span><span class="s0">: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">RefObject</span><span class="s1">&lt;</span><span class="s2">boolean</span><span class="s1">&gt;;</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">attachHandlers({</span>
  <span class="s2">preparedGesture</span><span class="s1">,</span>
  <span class="s2">gestureConfig</span><span class="s1">,</span>
  <span class="s2">gesture</span><span class="s1">,</span>
  <span class="s2">viewTag</span><span class="s1">,</span>
  <span class="s2">webEventHandlersRef</span><span class="s1">,</span>
  <span class="s2">mountedRef</span><span class="s1">,</span>
<span class="s1">}</span><span class="s0">: </span><span class="s2">AttachHandlersConfig</span><span class="s1">) {</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">firstExecution</span><span class="s1">) {</span>
    <span class="s2">gestureConfig</span><span class="s1">.</span><span class="s6">initialize</span><span class="s1">();</span>
  <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
    <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">firstExecution </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">// use queueMicrotask to extract handlerTags, because all refs should be initialized</span>
  <span class="s4">// when it's ran</span>
  <span class="s6">queueMicrotask</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">mountedRef</span><span class="s1">.</span><span class="s2">current</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">gestureConfig</span><span class="s1">.</span><span class="s6">prepare</span><span class="s1">();</span>
  <span class="s1">});</span>

  <span class="s0">for </span><span class="s1">(</span><span class="s0">const </span><span class="s1">handler </span><span class="s0">of </span><span class="s2">gesture</span><span class="s1">) {</span>
    <span class="s6">checkGestureCallbacksForWorklets</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
    <span class="s2">RNGestureHandlerModule</span><span class="s1">.</span><span class="s6">createGestureHandler</span><span class="s1">(</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerName</span><span class="s1">,</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">,</span>
      <span class="s6">filterConfig</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">, </span><span class="s2">ALLOWED_PROPS</span><span class="s1">)</span>
    <span class="s1">);</span>

    <span class="s6">registerHandler</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">testId</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">// use queueMicrotask to extract handlerTags, because all refs should be initialized</span>
  <span class="s4">// when it's ran</span>
  <span class="s6">queueMicrotask</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">mountedRef</span><span class="s1">.</span><span class="s2">current</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">const </span><span class="s1">handler </span><span class="s0">of </span><span class="s2">gesture</span><span class="s1">) {</span>
      <span class="s0">let </span><span class="s1">requireToFail</span><span class="s0">: </span><span class="s2">number</span><span class="s1">[] </span><span class="s0">= </span><span class="s1">[];</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">requireToFail</span><span class="s1">) {</span>
        <span class="s2">requireToFail </span><span class="s0">= </span><span class="s6">extractValidHandlerTags</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">requireToFail</span><span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s0">let </span><span class="s1">simultaneousWith</span><span class="s0">: </span><span class="s2">number</span><span class="s1">[] </span><span class="s0">= </span><span class="s1">[];</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">simultaneousWith</span><span class="s1">) {</span>
        <span class="s2">simultaneousWith </span><span class="s0">= </span><span class="s6">extractValidHandlerTags</span><span class="s1">(</span>
          <span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">simultaneousWith</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s2">RNGestureHandlerModule</span><span class="s1">.</span><span class="s6">updateGestureHandler</span><span class="s1">(</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">,</span>
        <span class="s6">filterConfig</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">, </span><span class="s2">ALLOWED_PROPS</span><span class="s1">, {</span>
          <span class="s1">simultaneousHandlers: </span><span class="s2">simultaneousWith</span><span class="s1">,</span>
          <span class="s1">waitFor: </span><span class="s2">requireToFail</span><span class="s1">,</span>
        <span class="s1">})</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s6">scheduleFlushOperations</span><span class="s1">();</span>
  <span class="s1">});</span>

  <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config </span><span class="s0">= </span><span class="s2">gesture</span><span class="s1">;</span>

  <span class="s0">for </span><span class="s1">(</span><span class="s0">const </span><span class="s1">gesture </span><span class="s0">of </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">) {</span>
    <span class="s0">const </span><span class="s1">actionType </span><span class="s0">= </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">shouldUseReanimated</span>
      <span class="s0">? </span><span class="s2">ActionType</span><span class="s1">.</span><span class="s2">REANIMATED_WORKLET</span>
      <span class="s0">: </span><span class="s2">ActionType</span><span class="s1">.</span><span class="s2">JS_FUNCTION_NEW_API</span><span class="s1">;</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">Platform</span><span class="s1">.</span><span class="s2">OS </span><span class="s0">=== </span><span class="s3">'web'</span><span class="s1">) {</span>
      <span class="s1">(</span>
        <span class="s2">RNGestureHandlerModule</span><span class="s1">.</span><span class="s2">attachGestureHandler </span><span class="s0">as typeof </span><span class="s2">RNGestureHandlerModuleWeb</span><span class="s1">.</span><span class="s2">attachGestureHandler</span>
      <span class="s1">)(</span>
        <span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">,</span>
        <span class="s2">viewTag</span><span class="s1">,</span>
        <span class="s2">ActionType</span><span class="s1">.</span><span class="s2">JS_FUNCTION_OLD_API</span><span class="s1">, </span><span class="s4">// ignored on web</span>
        <span class="s2">webEventHandlersRef</span>
      <span class="s1">); 
    } </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s2">RNGestureHandlerModule</span><span class="s1">.</span><span class="s6">attachGestureHandler</span><span class="s1">(</span>
        <span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">,</span>
        <span class="s2">viewTag</span><span class="s1">,</span>
        <span class="s2">actionType</span>
      <span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">animatedHandlers</span><span class="s1">) {</span>
    <span class="s0">const </span><span class="s1">isAnimatedGesture </span><span class="s0">= </span><span class="s1">(</span><span class="s2">g</span><span class="s0">: </span><span class="s2">GestureType</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">g</span><span class="s1">.</span><span class="s2">shouldUseReanimated</span><span class="s1">;</span>

    <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">animatedHandlers</span><span class="s1">.</span><span class="s2">value </span><span class="s0">= </span><span class="s2">gesture</span>
      <span class="s1">.</span><span class="s6">filter</span><span class="s1">(</span><span class="s2">isAnimatedGesture</span><span class="s1">)</span>
      <span class="s1">.</span><span class="s6">map</span><span class="s1">((</span><span class="s2">g</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">g</span><span class="s1">.</span><span class="s2">handlers</span><span class="s1">) </span><span class="s0">as </span><span class="s2">unknown </span><span class="s0">as </span><span class="s2">HandlerCallbacks</span><span class="s1">&lt;</span>
      <span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt;</span>
    <span class="s1">&gt;[];</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">updateHandlers(</span>
  <span class="s2">preparedGesture</span><span class="s0">: </span><span class="s2">GestureConfigReference</span><span class="s1">,</span>
  <span class="s2">gestureConfig</span><span class="s0">: </span><span class="s2">ComposedGesture </span><span class="s0">| </span><span class="s2">GestureType</span><span class="s1">,</span>
  <span class="s2">gesture</span><span class="s0">: </span><span class="s2">GestureType</span><span class="s1">[],</span>
  <span class="s2">mountedRef</span><span class="s0">: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">RefObject</span><span class="s1">&lt;</span><span class="s2">boolean</span><span class="s1">&gt;</span>
<span class="s1">) {</span>
  <span class="s2">gestureConfig</span><span class="s1">.</span><span class="s6">prepare</span><span class="s1">();</span>

  <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&lt; </span><span class="s2">gesture</span><span class="s1">.length; </span><span class="s2">i</span><span class="s0">++</span><span class="s1">) {</span>
    <span class="s0">const </span><span class="s1">handler </span><span class="s0">= </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>
    <span class="s6">checkGestureCallbacksForWorklets</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>

    <span class="s4">// only update handlerTag when it's actually different, it may be the same</span>
    <span class="s4">// if gesture config object is wrapped with useMemo</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">gesture</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">handlerTag </span><span class="s0">!== </span><span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">) {</span>
      <span class="s2">gesture</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">handlerTag </span><span class="s0">= </span><span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">;</span>
      <span class="s2">gesture</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">handlers</span><span class="s1">.</span><span class="s2">handlerTag </span><span class="s0">= </span><span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">// use queueMicrotask to extract handlerTags, because when it's ran, all refs should be updated</span>
  <span class="s4">// and handlerTags in BaseGesture references should be updated in the loop above (we need to wait</span>
  <span class="s4">// in case of external relations)</span>
  <span class="s6">queueMicrotask</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">mountedRef</span><span class="s1">.</span><span class="s2">current</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&lt; </span><span class="s2">gesture</span><span class="s1">.length; </span><span class="s2">i</span><span class="s0">++</span><span class="s1">) {</span>
      <span class="s0">const </span><span class="s1">handler </span><span class="s0">= </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

      <span class="s2">handler</span><span class="s1">.</span><span class="s2">config </span><span class="s0">= </span><span class="s2">gesture</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">config</span><span class="s1">;</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s2">handlers </span><span class="s0">= </span><span class="s2">gesture</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">handlers</span><span class="s1">;</span>

      <span class="s0">const </span><span class="s1">requireToFail </span><span class="s0">= </span><span class="s6">extractValidHandlerTags</span><span class="s1">(</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">requireToFail</span>
      <span class="s1">);</span>

      <span class="s0">const </span><span class="s1">simultaneousWith </span><span class="s0">= </span><span class="s6">extractValidHandlerTags</span><span class="s1">(</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">simultaneousWith</span>
      <span class="s1">);</span>

      <span class="s2">RNGestureHandlerModule</span><span class="s1">.</span><span class="s6">updateGestureHandler</span><span class="s1">(</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">,</span>
        <span class="s6">filterConfig</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">, </span><span class="s2">ALLOWED_PROPS</span><span class="s1">, {</span>
          <span class="s1">simultaneousHandlers: </span><span class="s2">simultaneousWith</span><span class="s1">,</span>
          <span class="s1">waitFor: </span><span class="s2">requireToFail</span><span class="s1">,</span>
        <span class="s1">})</span>
      <span class="s1">);</span>

      <span class="s6">registerHandler</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">testId</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">animatedHandlers</span><span class="s1">) {</span>
      <span class="s0">const </span><span class="s1">previousHandlersValue </span><span class="s0">=</span>
        <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">animatedHandlers</span><span class="s1">.</span><span class="s2">value </span><span class="s0">?? </span><span class="s1">[];</span>
      <span class="s0">const </span><span class="s1">newHandlersValue </span><span class="s0">= </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span>
        <span class="s1">.</span><span class="s6">filter</span><span class="s1">((</span><span class="s2">g</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">g</span><span class="s1">.</span><span class="s2">shouldUseReanimated</span><span class="s1">) </span><span class="s4">// ignore gestures that shouldn't run on UI</span>
        <span class="s1">.</span><span class="s6">map</span><span class="s1">((</span><span class="s2">g</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">g</span><span class="s1">.</span><span class="s2">handlers</span><span class="s1">) </span><span class="s0">as </span><span class="s2">unknown </span><span class="s0">as </span><span class="s2">HandlerCallbacks</span><span class="s1">&lt;</span>
        <span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt;</span>
      <span class="s1">&gt;[];</span>

      <span class="s4">// if amount of gesture configs changes, we need to update the callbacks in shared value</span>
      <span class="s0">let </span><span class="s1">shouldUpdateSharedValue </span><span class="s0">=</span>
        <span class="s2">previousHandlersValue</span><span class="s1">.length </span><span class="s0">!== </span><span class="s2">newHandlersValue</span><span class="s1">.length;</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">shouldUpdateSharedValue</span><span class="s1">) {</span>
        <span class="s4">// if the amount is the same, we need to check if any of the configs inside has changed</span>
        <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&lt; </span><span class="s2">newHandlersValue</span><span class="s1">.length; </span><span class="s2">i</span><span class="s0">++</span><span class="s1">) {</span>
          <span class="s0">if </span><span class="s1">(</span>
            <span class="s4">// we can use the `gestureId` prop as it's unique for every config instance</span>
            <span class="s2">newHandlersValue</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">gestureId </span><span class="s0">!== </span><span class="s2">previousHandlersValue</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">gestureId</span>
          <span class="s1">) {</span>
            <span class="s2">shouldUpdateSharedValue </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>
            <span class="s0">break</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s2">shouldUpdateSharedValue</span><span class="s1">) {</span>
        <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">animatedHandlers</span><span class="s1">.</span><span class="s2">value </span><span class="s0">= </span><span class="s2">newHandlersValue</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s6">scheduleFlushOperations</span><span class="s1">();</span>
  <span class="s1">});</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">needsToReattach(</span>
  <span class="s2">preparedGesture</span><span class="s0">: </span><span class="s2">GestureConfigReference</span><span class="s1">,</span>
  <span class="s2">gesture</span><span class="s0">: </span><span class="s2">GestureType</span><span class="s1">[]</span>
<span class="s1">) {</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">gesture</span><span class="s1">.length </span><span class="s0">!== </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.length) {</span>
    <span class="s0">return </span><span class="s7">true</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&lt; </span><span class="s2">gesture</span><span class="s1">.length; </span><span class="s2">i</span><span class="s0">++</span><span class="s1">) {</span>
    <span class="s0">if </span><span class="s1">(</span>
      <span class="s2">gesture</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">handlerName </span><span class="s0">!== </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">handlerName </span><span class="s0">||</span>
      <span class="s2">gesture</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">shouldUseReanimated </span><span class="s0">!==</span>
        <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">config</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s2">shouldUseReanimated</span>
    <span class="s1">) {</span>
      <span class="s0">return </span><span class="s7">true</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">return </span><span class="s7">false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">isStateChangeEvent(</span>
  <span class="s2">event</span><span class="s0">: </span><span class="s2">GestureUpdateEvent </span><span class="s0">| </span><span class="s2">GestureStateChangeEvent </span><span class="s0">| </span><span class="s2">GestureTouchEvent</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">event </span><span class="s0">is </span><span class="s2">GestureStateChangeEvent </span><span class="s1">{</span>
  <span class="s3">'worklet'</span><span class="s1">;</span>
  <span class="s4">// @ts-ignore Yes, the oldState prop is missing on GestureTouchEvent, that's the point</span>
  <span class="s0">return </span><span class="s2">event</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">!= </span><span class="s7">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">isTouchEvent(</span>
  <span class="s2">event</span><span class="s0">: </span><span class="s2">GestureUpdateEvent </span><span class="s0">| </span><span class="s2">GestureStateChangeEvent </span><span class="s0">| </span><span class="s2">GestureTouchEvent</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">event </span><span class="s0">is </span><span class="s2">GestureTouchEvent </span><span class="s1">{</span>
  <span class="s3">'worklet'</span><span class="s1">;</span>
  <span class="s0">return </span><span class="s2">event</span><span class="s1">.</span><span class="s2">eventType </span><span class="s0">!= </span><span class="s7">null</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">getHandler(</span>
  <span class="s2">type</span><span class="s0">: </span><span class="s2">CALLBACK_TYPE</span><span class="s1">,</span>
  <span class="s2">gesture</span><span class="s0">: </span><span class="s2">HandlerCallbacks</span><span class="s1">&lt;</span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt;&gt;</span>
<span class="s1">) {</span>
  <span class="s3">'worklet'</span><span class="s1">;</span>
  <span class="s0">switch </span><span class="s1">(</span><span class="s2">type</span><span class="s1">) {</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onBegin</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">START</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onStart</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">UPDATE</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onUpdate</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">CHANGE</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onChange</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">END</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onEnd</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">FINALIZE</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onFinalize</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_DOWN</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onTouchesDown</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_MOVE</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onTouchesMove</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_UP</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onTouchesUp</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_CANCELLED</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onTouchesCancelled</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">touchEventTypeToCallbackType(</span>
  <span class="s2">eventType</span><span class="s0">: </span><span class="s2">TouchEventType</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">CALLBACK_TYPE </span><span class="s1">{</span>
  <span class="s3">'worklet'</span><span class="s1">;</span>
  <span class="s0">switch </span><span class="s1">(</span><span class="s2">eventType</span><span class="s1">) {</span>
    <span class="s0">case </span><span class="s2">TouchEventType</span><span class="s1">.</span><span class="s2">TOUCHES_DOWN</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_DOWN</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">TouchEventType</span><span class="s1">.</span><span class="s2">TOUCHES_MOVE</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_MOVE</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">TouchEventType</span><span class="s1">.</span><span class="s2">TOUCHES_UP</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_UP</span><span class="s1">;</span>
    <span class="s0">case </span><span class="s2">TouchEventType</span><span class="s1">.</span><span class="s2">TOUCHES_CANCELLED</span><span class="s1">:</span>
      <span class="s0">return </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">TOUCHES_CANCELLED</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">return </span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">UNDEFINED</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">runWorklet(</span>
  <span class="s2">type</span><span class="s0">: </span><span class="s2">CALLBACK_TYPE</span><span class="s1">,</span>
  <span class="s2">gesture</span><span class="s0">: </span><span class="s2">HandlerCallbacks</span><span class="s1">&lt;</span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt;&gt;,</span>
  <span class="s2">event</span><span class="s0">: </span><span class="s2">GestureStateChangeEvent </span><span class="s0">| </span><span class="s2">GestureUpdateEvent </span><span class="s0">| </span><span class="s2">GestureTouchEvent</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">args</span><span class="s0">: </span><span class="s2">any</span><span class="s1">[]</span>
<span class="s1">) {</span>
  <span class="s3">'worklet'</span><span class="s1">;</span>
  <span class="s0">const </span><span class="s1">handler </span><span class="s0">= </span><span class="s6">getHandler</span><span class="s1">(</span><span class="s2">type</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">);</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">isWorklet</span><span class="s1">[</span><span class="s2">type</span><span class="s1">]) {</span>
    <span class="s4">// @ts-ignore Logic below makes sure the correct event is send to the</span>
    <span class="s4">// correct handler.</span>
    <span class="s6">handler</span><span class="s1">?.(</span><span class="s2">event</span><span class="s1">, </span><span class="s0">...</span><span class="s2">args</span><span class="s1">);</span>
  <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">) {</span>
    <span class="s2">console</span><span class="s1">.</span><span class="s6">warn</span><span class="s1">(</span><span class="s6">tagMessage</span><span class="s1">(</span><span class="s3">'Animated gesture callback must be a worklet'</span><span class="s1">));</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">useAnimatedGesture(</span>
  <span class="s2">preparedGesture</span><span class="s0">: </span><span class="s2">GestureConfigReference</span><span class="s1">,</span>
  <span class="s2">needsRebuild</span><span class="s0">: </span><span class="s2">boolean</span>
<span class="s1">) {</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">Reanimated</span><span class="s1">) {</span>
    <span class="s0">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s4">// Hooks are called conditionally, but the condition is whether the</span>
  <span class="s4">// react-native-reanimated is installed, which shouldn't change while running</span>
  <span class="s4">// eslint-disable-next-line react-hooks/rules-of-hooks</span>
  <span class="s0">const </span><span class="s1">sharedHandlersCallbacks </span><span class="s0">= </span><span class="s2">Reanimated</span><span class="s1">.</span><span class="s2">useSharedValue</span><span class="s0">&lt;</span>
    <span class="s2">HandlerCallbacks</span><span class="s0">&lt;</span><span class="s2">Record</span><span class="s0">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s0">&gt;&gt;</span><span class="s1">[] </span><span class="s0">| </span><span class="s7">null</span>
  <span class="s0">&gt;</span><span class="s1">(</span><span class="s7">null</span><span class="s1">);</span>

  <span class="s4">// eslint-disable-next-line react-hooks/rules-of-hooks</span>
  <span class="s0">const </span><span class="s1">lastUpdateEvent </span><span class="s0">= </span><span class="s2">Reanimated</span><span class="s1">.</span><span class="s2">useSharedValue</span><span class="s0">&lt;</span>
    <span class="s1">(</span><span class="s2">GestureUpdateEvent </span><span class="s0">| </span><span class="s7">undefined</span><span class="s1">)[]</span>
  <span class="s0">&gt;</span><span class="s1">([]);</span>

  <span class="s4">// not every gesture needs a state controller, init them lazily</span>
  <span class="s0">const </span><span class="s1">stateControllers</span><span class="s0">: </span><span class="s2">GestureStateManagerType</span><span class="s1">[] </span><span class="s0">= </span><span class="s1">[];</span>

  <span class="s0">const </span><span class="s1">callback </span><span class="s0">= </span><span class="s1">(</span>
    <span class="s2">event</span><span class="s0">: </span><span class="s2">GestureStateChangeEvent </span><span class="s0">| </span><span class="s2">GestureUpdateEvent </span><span class="s0">| </span><span class="s2">GestureTouchEvent</span>
  <span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s3">'worklet'</span><span class="s1">;</span>

    <span class="s0">const </span><span class="s1">currentCallback </span><span class="s0">= </span><span class="s2">sharedHandlersCallbacks</span><span class="s1">.</span><span class="s2">value</span><span class="s1">;</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">currentCallback</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s5">0</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&lt; </span><span class="s2">currentCallback</span><span class="s1">.length; </span><span class="s2">i</span><span class="s0">++</span><span class="s1">) {</span>
      <span class="s0">const </span><span class="s1">gesture </span><span class="s0">= </span><span class="s2">currentCallback</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">handlerTag </span><span class="s0">=== </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">) {</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s6">isStateChangeEvent</span><span class="s1">(</span><span class="s2">event</span><span class="s1">)) {</span>
          <span class="s0">if </span><span class="s1">(</span>
            <span class="s2">event</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">UNDETERMINED </span><span class="s0">&amp;&amp;</span>
            <span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span>
          <span class="s1">) {</span>
            <span class="s6">runWorklet</span><span class="s1">(</span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">event</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN </span><span class="s0">||</span>
              <span class="s2">event</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">UNDETERMINED</span><span class="s1">) </span><span class="s0">&amp;&amp;</span>
            <span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span>
          <span class="s1">) {</span>
            <span class="s6">runWorklet</span><span class="s1">(</span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">START</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">event</span><span class="s1">);</span>
            <span class="s2">lastUpdateEvent</span><span class="s1">.</span><span class="s2">value</span><span class="s1">[</span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">] </span><span class="s0">= </span><span class="s7">undefined</span><span class="s1">;</span>
          <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
            <span class="s2">event</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">!== </span><span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">&amp;&amp;</span>
            <span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span>
          <span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">) {</span>
              <span class="s6">runWorklet</span><span class="s1">(</span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">END</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">event</span><span class="s1">, </span><span class="s7">true</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s6">runWorklet</span><span class="s1">(</span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">FINALIZE</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">event</span><span class="s1">, </span><span class="s7">true</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
            <span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">FAILED </span><span class="s0">|| </span><span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED</span><span class="s1">) </span><span class="s0">&amp;&amp;</span>
            <span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">!== </span><span class="s2">event</span><span class="s1">.</span><span class="s2">oldState</span>
          <span class="s1">) {</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">) {</span>
              <span class="s6">runWorklet</span><span class="s1">(</span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">END</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">event</span><span class="s1">, </span><span class="s7">false</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s6">runWorklet</span><span class="s1">(</span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">FINALIZE</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">event</span><span class="s1">, </span><span class="s7">false</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s6">isTouchEvent</span><span class="s1">(</span><span class="s2">event</span><span class="s1">)) {</span>
          <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">stateControllers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]) {</span>
            <span class="s2">stateControllers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] </span><span class="s0">= </span><span class="s2">GestureStateManager</span><span class="s1">.</span><span class="s6">create</span><span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">);</span>
          <span class="s1">}</span>

          <span class="s0">if </span><span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">eventType </span><span class="s0">!== </span><span class="s2">TouchEventType</span><span class="s1">.</span><span class="s2">UNDETERMINED</span><span class="s1">) {</span>
            <span class="s6">runWorklet</span><span class="s1">(</span>
              <span class="s6">touchEventTypeToCallbackType</span><span class="s1">(</span><span class="s2">event</span><span class="s1">.</span><span class="s2">eventType</span><span class="s1">),</span>
              <span class="s2">gesture</span><span class="s1">,</span>
              <span class="s2">event</span><span class="s1">,</span>
              <span class="s2">stateControllers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]</span>
            <span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
          <span class="s6">runWorklet</span><span class="s1">(</span><span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">UPDATE</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">event</span><span class="s1">);</span>

          <span class="s0">if </span><span class="s1">(</span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">onChange </span><span class="s0">&amp;&amp; </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">changeEventCalculator</span><span class="s1">) {</span>
            <span class="s6">runWorklet</span><span class="s1">(</span>
              <span class="s2">CALLBACK_TYPE</span><span class="s1">.</span><span class="s2">CHANGE</span><span class="s1">,</span>
              <span class="s2">gesture</span><span class="s1">,</span>
              <span class="s2">gesture</span><span class="s1">.</span><span class="s6">changeEventCalculator</span><span class="s1">?.(</span>
                <span class="s2">event</span><span class="s1">,</span>
                <span class="s2">lastUpdateEvent</span><span class="s1">.</span><span class="s2">value</span><span class="s1">[</span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">]</span>
              <span class="s1">)</span>
            <span class="s1">);</span>

            <span class="s2">lastUpdateEvent</span><span class="s1">.</span><span class="s2">value</span><span class="s1">[</span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">] </span><span class="s0">= </span><span class="s2">event</span><span class="s1">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}; 
</span>
  <span class="s4">// eslint-disable-next-line react-hooks/rules-of-hooks</span>
  <span class="s0">const </span><span class="s1">event </span><span class="s0">= </span><span class="s2">Reanimated</span><span class="s1">.</span><span class="s6">useEvent</span><span class="s1">(</span>
    <span class="s2">callback</span><span class="s1">,</span>
    <span class="s1">[</span><span class="s3">'onGestureHandlerStateChange'</span><span class="s1">, </span><span class="s3">'onGestureHandlerEvent'</span><span class="s1">],</span>
    <span class="s2">needsRebuild</span>
  <span class="s1">);</span>

  <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">animatedEventHandler </span><span class="s0">= </span><span class="s2">event</span><span class="s1">;</span>
  <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">animatedHandlers </span><span class="s0">= </span><span class="s2">sharedHandlersCallbacks</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
<span class="s0">function </span><span class="s1">validateDetectorChildren(</span><span class="s2">ref</span><span class="s0">: </span><span class="s2">any</span><span class="s1">) {</span>
  <span class="s4">// finds the first native view under the Wrap component and traverses the fiber tree upwards</span>
  <span class="s4">// to check whether there is more than one native view as a pseudo-direct child of GestureDetector</span>
  <span class="s4">// i.e. this is not ok:</span>
  <span class="s4">//            Wrap</span>
  <span class="s4">//             |</span>
  <span class="s4">//            / \</span>
  <span class="s4">//           /   \</span>
  <span class="s4">//          /     \</span>
  <span class="s4">//         /       \</span>
  <span class="s4">//   NativeView  NativeView</span>
  <span class="s4">//</span>
  <span class="s4">// but this is fine:</span>
  <span class="s4">//            Wrap</span>
  <span class="s4">//             |</span>
  <span class="s4">//         NativeView</span>
  <span class="s4">//             |</span>
  <span class="s4">//            / \</span>
  <span class="s4">//           /   \</span>
  <span class="s4">//          /     \</span>
  <span class="s4">//         /       \</span>
  <span class="s4">//   NativeView  NativeView</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">__DEV__ </span><span class="s0">&amp;&amp; </span><span class="s2">Platform</span><span class="s1">.</span><span class="s2">OS </span><span class="s0">!== </span><span class="s3">'web'</span><span class="s1">) {</span>
    <span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment</span>
    <span class="s0">const </span><span class="s1">wrapType </span><span class="s0">=</span>
      <span class="s2">REACT_NATIVE_VERSION</span><span class="s1">.</span><span class="s2">minor </span><span class="s0">&gt; </span><span class="s5">63 </span><span class="s0">|| </span><span class="s2">REACT_NATIVE_VERSION</span><span class="s1">.</span><span class="s2">major </span><span class="s0">&gt; </span><span class="s5">0</span>
        <span class="s0">? </span><span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access</span>
          <span class="s2">ref</span><span class="s1">.</span><span class="s2">_reactInternals</span><span class="s1">.</span><span class="s2">elementType</span>
        <span class="s0">: </span><span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access</span>
          <span class="s2">ref</span><span class="s1">.</span><span class="s2">_reactInternalFiber</span><span class="s1">.</span><span class="s2">elementType</span><span class="s1">;</span>
    <span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment</span>
    <span class="s0">let </span><span class="s1">instance </span><span class="s0">=</span>
      <span class="s2">RNRenderer</span><span class="s1">.</span><span class="s6">findHostInstance_DEPRECATED</span><span class="s1">(</span>
        <span class="s2">ref</span>
      <span class="s1">).</span><span class="s2">_internalFiberInstanceHandleDEV</span><span class="s1">;</span>

    <span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access</span>
    <span class="s0">while </span><span class="s1">(</span><span class="s2">instance </span><span class="s0">&amp;&amp; </span><span class="s2">instance</span><span class="s1">.</span><span class="s2">elementType </span><span class="s0">!== </span><span class="s2">wrapType</span><span class="s1">) {</span>
      <span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">instance</span><span class="s1">.</span><span class="s2">sibling</span><span class="s1">) {</span>
        <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
          <span class="s3">'GestureDetector has more than one native view as its children. This can happen if you are using a custom component that renders multiple views, like React.Fragment. You should wrap content of GestureDetector with a &lt;View&gt; or &lt;Animated.View&gt;.'</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-member-access</span>
      <span class="s2">instance </span><span class="s0">= </span><span class="s2">instance</span><span class="s1">.</span><span class="s2">return</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">const </span><span class="s1">applyUserSelectProp </span><span class="s0">= </span><span class="s1">(</span>
  <span class="s2">userSelect</span><span class="s0">: </span><span class="s2">UserSelect</span><span class="s1">,</span>
  <span class="s2">gesture</span><span class="s0">: </span><span class="s2">ComposedGesture </span><span class="s0">| </span><span class="s2">GestureType</span>
<span class="s1">): </span><span class="s2">void </span><span class="s0">=&gt; </span><span class="s1">{</span>
  <span class="s0">for </span><span class="s1">(</span><span class="s0">const </span><span class="s1">g </span><span class="s0">of </span><span class="s2">gesture</span><span class="s1">.</span><span class="s6">toGestureArray</span><span class="s1">()) {</span>
    <span class="s2">g</span><span class="s1">.</span><span class="s2">config</span><span class="s1">.</span><span class="s2">userSelect </span><span class="s0">= </span><span class="s2">userSelect</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s0">interface </span><span class="s2">GestureDetectorProps </span><span class="s1">{</span>
  <span class="s1">gesture</span><span class="s0">: </span><span class="s2">ComposedGesture </span><span class="s0">| </span><span class="s2">GestureType</span><span class="s1">;</span>
  <span class="s1">userSelect</span><span class="s0">?: </span><span class="s2">UserSelect</span><span class="s1">;</span>
  <span class="s1">children</span><span class="s0">?: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">ReactNode</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s0">interface </span><span class="s2">GestureDetectorState </span><span class="s1">{</span>
  <span class="s1">firstRender</span><span class="s0">: </span><span class="s2">boolean</span><span class="s1">;</span>
  <span class="s1">viewRef</span><span class="s0">: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">Component </span><span class="s0">| </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s1">previousViewTag</span><span class="s0">: </span><span class="s2">number</span><span class="s1">;</span>
  <span class="s1">forceReattach</span><span class="s0">: </span><span class="s2">boolean</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s0">export const </span><span class="s1">GestureDetector </span><span class="s0">= </span><span class="s1">(</span><span class="s2">props</span><span class="s0">: </span><span class="s2">GestureDetectorProps</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
  <span class="s0">const </span><span class="s1">rootViewContext </span><span class="s0">= </span><span class="s6">useContext</span><span class="s1">(</span><span class="s2">GestureHandlerRootViewContext</span><span class="s1">);</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">__DEV__ </span><span class="s0">&amp;&amp; !</span><span class="s2">rootViewContext </span><span class="s0">&amp;&amp; !</span><span class="s6">isJestEnv</span><span class="s1">()) {</span>
    <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
      <span class="s3">'GestureDetector must be used as a descendant of GestureHandlerRootView. Otherwise the gestures will not be recognized. See https://docs.swmansion.com/react-native-gesture-handler/docs/installation for more details.'</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">gestureConfig </span><span class="s0">= </span><span class="s2">props</span><span class="s1">.</span><span class="s2">gesture</span><span class="s1">;</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">props</span><span class="s1">.</span><span class="s2">userSelect</span><span class="s1">) {</span>
    <span class="s6">applyUserSelectProp</span><span class="s1">(</span><span class="s2">props</span><span class="s1">.</span><span class="s2">userSelect</span><span class="s1">, </span><span class="s2">gestureConfig</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">gesture </span><span class="s0">= </span><span class="s2">gestureConfig</span><span class="s1">.</span><span class="s6">toGestureArray</span><span class="s1">();</span>
  <span class="s0">const </span><span class="s1">useReanimatedHook </span><span class="s0">= </span><span class="s2">gesture</span><span class="s1">.</span><span class="s6">some</span><span class="s1">((</span><span class="s2">g</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">g</span><span class="s1">.</span><span class="s2">shouldUseReanimated</span><span class="s1">);</span>

  <span class="s4">// store state in ref to prevent unnecessary renders</span>
  <span class="s0">const </span><span class="s1">state </span><span class="s0">= </span><span class="s6">useRef</span><span class="s1">&lt;</span><span class="s2">GestureDetectorState</span><span class="s1">&gt;({</span>
    <span class="s1">firstRender: </span><span class="s7">true</span><span class="s1">,</span>
    <span class="s1">viewRef: </span><span class="s7">null</span><span class="s1">,</span>
    <span class="s1">previousViewTag: </span><span class="s0">-</span><span class="s5">1</span><span class="s1">,</span>
    <span class="s1">forceReattach: </span><span class="s7">false</span><span class="s1">,</span>
  <span class="s1">}).</span><span class="s2">current</span><span class="s1">;</span>
  <span class="s0">const </span><span class="s1">mountedRef </span><span class="s0">= </span><span class="s6">useRef</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
  <span class="s0">const </span><span class="s1">webEventHandlersRef </span><span class="s0">= </span><span class="s6">useRef</span><span class="s1">&lt;</span><span class="s2">WebEventHandler</span><span class="s1">&gt;({</span>
    <span class="s6">onGestureHandlerEvent</span><span class="s1">: (</span><span class="s2">e</span><span class="s0">: </span><span class="s2">HandlerStateChangeEvent</span><span class="s1">&lt;</span><span class="s2">unknown</span><span class="s1">&gt;) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s6">onGestureHandlerEvent</span><span class="s1">(</span><span class="s2">e</span><span class="s1">.</span><span class="s2">nativeEvent</span><span class="s1">);</span>
    <span class="s1">},</span>
    <span class="s1">onGestureHandlerStateChange: </span><span class="s6">isNewWebImplementationEnabled</span><span class="s1">()</span>
      <span class="s0">? </span><span class="s1">(</span><span class="s2">e</span><span class="s0">: </span><span class="s2">HandlerStateChangeEvent</span><span class="s1">&lt;</span><span class="s2">unknown</span><span class="s1">&gt;) </span><span class="s0">=&gt; </span><span class="s1">{</span>
          <span class="s6">onGestureHandlerEvent</span><span class="s1">(</span><span class="s2">e</span><span class="s1">.</span><span class="s2">nativeEvent</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s0">: </span><span class="s7">undefined</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s0">const </span><span class="s1">[renderState, setRenderState] </span><span class="s0">= </span><span class="s6">useState</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
  <span class="s0">function </span><span class="s1">forceRender() {</span>
    <span class="s6">setRenderState</span><span class="s1">(</span><span class="s0">!</span><span class="s2">renderState</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">preparedGesture </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useRef</span><span class="s1">&lt;</span><span class="s2">GestureConfigReference</span><span class="s1">&gt;({</span>
    <span class="s1">config: </span><span class="s2">gesture</span><span class="s1">,</span>
    <span class="s1">animatedEventHandler: </span><span class="s7">null</span><span class="s1">,</span>
    <span class="s1">animatedHandlers: </span><span class="s7">null</span><span class="s1">,</span>
    <span class="s1">firstExecution: </span><span class="s7">true</span><span class="s1">,</span>
    <span class="s1">useReanimatedHook: </span><span class="s2">useReanimatedHook</span><span class="s1">,</span>
  <span class="s1">}).</span><span class="s2">current</span><span class="s1">;</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">useReanimatedHook </span><span class="s0">!== </span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">useReanimatedHook</span><span class="s1">) {</span>
    <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
      <span class="s6">tagMessage</span><span class="s1">(</span>
        <span class="s3">'You cannot change the thread the callbacks are ran on while the app is running'</span>
      <span class="s1">)</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">function </span><span class="s1">onHandlersUpdate(</span><span class="s2">skipConfigUpdate</span><span class="s0">?: </span><span class="s2">boolean</span><span class="s1">) {</span>
    <span class="s4">// if the underlying view has changed we need to reattach handlers to the new view</span>
    <span class="s0">const </span><span class="s1">viewTag </span><span class="s0">= </span><span class="s6">findNodeHandle</span><span class="s1">(</span><span class="s2">state</span><span class="s1">.</span><span class="s2">viewRef</span><span class="s1">) </span><span class="s0">as </span><span class="s2">number</span><span class="s1">;</span>
    <span class="s0">const </span><span class="s1">forceReattach </span><span class="s0">= </span><span class="s2">viewTag </span><span class="s0">!== </span><span class="s2">state</span><span class="s1">.</span><span class="s2">previousViewTag</span><span class="s1">;</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">forceReattach </span><span class="s0">|| </span><span class="s6">needsToReattach</span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">)) {</span>
      <span class="s6">validateDetectorChildren</span><span class="s1">(</span><span class="s2">state</span><span class="s1">.</span><span class="s2">viewRef</span><span class="s1">);</span>
      <span class="s6">dropHandlers</span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">);</span>
      <span class="s6">attachHandlers</span><span class="s1">({</span>
        <span class="s2">preparedGesture</span><span class="s1">,</span>
        <span class="s2">gestureConfig</span><span class="s1">,</span>
        <span class="s2">gesture</span><span class="s1">,</span>
        <span class="s2">webEventHandlersRef</span><span class="s1">,</span>
        <span class="s2">viewTag</span><span class="s1">,</span>
        <span class="s2">mountedRef</span><span class="s1">,</span>
      <span class="s1">});</span>

      <span class="s2">state</span><span class="s1">.</span><span class="s2">previousViewTag </span><span class="s0">= </span><span class="s2">viewTag</span><span class="s1">;</span>
      <span class="s2">state</span><span class="s1">.</span><span class="s2">forceReattach </span><span class="s0">= </span><span class="s2">forceReattach</span><span class="s1">;</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">forceReattach</span><span class="s1">) {</span>
        <span class="s6">forceRender</span><span class="s1">();</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">skipConfigUpdate</span><span class="s1">) {</span>
      <span class="s6">updateHandlers</span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">, </span><span class="s2">gestureConfig</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">, </span><span class="s2">mountedRef</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">// Reanimated event should be rebuilt only when gestures are reattached, otherwise</span>
  <span class="s4">// config update will be enough as all necessary items are stored in shared values anyway</span>
  <span class="s0">const </span><span class="s1">needsToRebuildReanimatedEvent </span><span class="s0">=</span>
    <span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">firstExecution </span><span class="s0">||</span>
    <span class="s6">needsToReattach</span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">, </span><span class="s2">gesture</span><span class="s1">) </span><span class="s0">||</span>
    <span class="s2">state</span><span class="s1">.</span><span class="s2">forceReattach</span><span class="s1">;</span>

  <span class="s2">state</span><span class="s1">.</span><span class="s2">forceReattach </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">.</span><span class="s2">firstExecution</span><span class="s1">) {</span>
    <span class="s2">gestureConfig</span><span class="s1">.</span><span class="s6">initialize</span><span class="s1">();</span>
  <span class="s1">}</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">useReanimatedHook</span><span class="s1">) {</span>
    <span class="s4">// Whether animatedGesture or gesture is used shouldn't change while the app is running</span>
    <span class="s4">// eslint-disable-next-line react-hooks/rules-of-hooks</span>
    <span class="s6">useAnimatedGesture</span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">, </span><span class="s2">needsToRebuildReanimatedEvent</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s6">useEffect</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">const </span><span class="s1">viewTag </span><span class="s0">= </span><span class="s6">findNodeHandle</span><span class="s1">(</span><span class="s2">state</span><span class="s1">.</span><span class="s2">viewRef</span><span class="s1">) </span><span class="s0">as </span><span class="s2">number</span><span class="s1">;</span>
    <span class="s2">state</span><span class="s1">.</span><span class="s2">firstRender </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>
    <span class="s2">mountedRef</span><span class="s1">.</span><span class="s2">current </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>

    <span class="s6">validateDetectorChildren</span><span class="s1">(</span><span class="s2">state</span><span class="s1">.</span><span class="s2">viewRef</span><span class="s1">);</span>

    <span class="s6">attachHandlers</span><span class="s1">({</span>
      <span class="s2">preparedGesture</span><span class="s1">,</span>
      <span class="s2">gestureConfig</span><span class="s1">,</span>
      <span class="s2">gesture</span><span class="s1">,</span>
      <span class="s2">webEventHandlersRef</span><span class="s1">,</span>
      <span class="s2">viewTag</span><span class="s1">,</span>
      <span class="s2">mountedRef</span><span class="s1">,</span>
    <span class="s1">});</span>

    <span class="s0">return </span><span class="s1">() </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s2">mountedRef</span><span class="s1">.</span><span class="s2">current </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>
      <span class="s6">dropHandlers</span><span class="s1">(</span><span class="s2">preparedGesture</span><span class="s1">);</span>
    <span class="s1">};</span>
  <span class="s1">}, []);</span>

  <span class="s6">useEffect</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">state</span><span class="s1">.</span><span class="s2">firstRender</span><span class="s1">) {</span>
      <span class="s6">onHandlersUpdate</span><span class="s1">();</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s2">state</span><span class="s1">.</span><span class="s2">firstRender </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}, [</span><span class="s2">props</span><span class="s1">]);</span>

  <span class="s0">const </span><span class="s1">refFunction </span><span class="s0">= </span><span class="s1">(</span><span class="s2">ref</span><span class="s0">: </span><span class="s2">unknown</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">ref </span><span class="s0">!== </span><span class="s7">null</span><span class="s1">) {</span>
      <span class="s4">// @ts-ignore Just setting the view ref</span>
      <span class="s2">state</span><span class="s1">.</span><span class="s2">viewRef </span><span class="s0">= </span><span class="s2">ref</span><span class="s1">;</span>

      <span class="s4">// if it's the first render, also set the previousViewTag to prevent reattaching gestures when not needed</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">state</span><span class="s1">.</span><span class="s2">previousViewTag </span><span class="s0">=== -</span><span class="s5">1</span><span class="s1">) {</span>
        <span class="s2">state</span><span class="s1">.</span><span class="s2">previousViewTag </span><span class="s0">= </span><span class="s6">findNodeHandle</span><span class="s1">(</span><span class="s2">state</span><span class="s1">.</span><span class="s2">viewRef</span><span class="s1">) </span><span class="s0">as </span><span class="s2">number</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s4">// pass true as `skipConfigUpdate`, here we only want to trigger the eventual reattaching of handlers</span>
      <span class="s4">// in case the view has changed, while config update would be handled be the `useEffect` above</span>
      <span class="s6">onHandlersUpdate</span><span class="s1">(</span><span class="s7">true</span><span class="s1">);</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s6">isFabric</span><span class="s1">()) {</span>
        <span class="s0">const </span><span class="s1">node </span><span class="s0">= </span><span class="s6">getShadowNodeFromRef</span><span class="s1">(</span><span class="s2">ref</span><span class="s1">);</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s2">global</span><span class="s1">.</span><span class="s6">isFormsStackingContext</span><span class="s1">(</span><span class="s2">node</span><span class="s1">) </span><span class="s0">=== </span><span class="s7">false</span><span class="s1">) {</span>
          <span class="s2">console</span><span class="s1">.</span><span class="s6">error</span><span class="s1">(</span>
            <span class="s6">tagMessage</span><span class="s1">(</span>
              <span class="s3">'GestureDetector has received a child that may get view-flattened. ' </span><span class="s0">+</span>
                <span class="s3">'</span><span class="s8">\n</span><span class="s3">To prevent it from misbehaving you need to wrap the child with a `&lt;View collapsable={false}&gt;`.'</span>
            <span class="s1">)</span>
          <span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">};</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">useReanimatedHook</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s1">(</span>
      <span class="s9">&lt;</span><span class="s10">AnimatedWrap</span>
        <span class="s12">ref</span><span class="s0">=</span><span class="s11">{</span><span class="s2">refFunction</span><span class="s11">}</span>
        <span class="s12">onGestureHandlerEvent</span><span class="s0">=</span><span class="s11">{</span><span class="s2">preparedGesture</span><span class="s11">.</span><span class="s2">animatedEventHandler</span><span class="s11">}</span><span class="s9">&gt;</span>
        <span class="s11">{</span><span class="s2">props</span><span class="s11">.</span><span class="s2">children</span><span class="s11">}</span>
      <span class="s9">&lt;/</span><span class="s10">AnimatedWrap</span><span class="s9">&gt;</span>
    <span class="s1">);</span>
  <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
    <span class="s0">return </span><span class="s9">&lt;</span><span class="s10">Wrap </span><span class="s12">ref</span><span class="s0">=</span><span class="s11">{</span><span class="s2">refFunction</span><span class="s11">}</span><span class="s9">&gt;</span><span class="s11">{</span><span class="s2">props</span><span class="s11">.</span><span class="s2">children</span><span class="s11">}</span><span class="s9">&lt;/</span><span class="s10">Wrap</span><span class="s9">&gt;</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s0">class </span><span class="s2">Wrap </span><span class="s0">extends </span><span class="s2">React</span><span class="s1">.</span><span class="s6">Component</span><span class="s1">&lt;{</span>
  <span class="s1">onGestureHandlerEvent</span><span class="s0">?: </span><span class="s2">unknown</span><span class="s1">;</span>
  <span class="s4">// implicit `children` prop has been removed in @types/react^18.0.0</span>
  <span class="s1">children</span><span class="s0">?: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">ReactNode</span><span class="s1">;</span>
<span class="s1">}&gt; {</span>
  <span class="s1">render() {</span>
    <span class="s0">try </span><span class="s1">{</span>
      <span class="s4">// I don't think that fighting with types over such a simple function is worth it</span>
      <span class="s4">// The only thing it does is add 'collapsable: false' to the child component</span>
      <span class="s4">// to make sure it is in the native view hierarchy so the detector can find</span>
      <span class="s4">// correct viewTag to attach to.</span>
      <span class="s4">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
      <span class="s0">const </span><span class="s1">child</span><span class="s0">: </span><span class="s2">any </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s2">Children</span><span class="s1">.</span><span class="s6">only</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">children</span><span class="s1">);</span>
      <span class="s0">return </span><span class="s2">React</span><span class="s1">.</span><span class="s6">cloneElement</span><span class="s1">(</span>
        <span class="s2">child</span><span class="s1">,</span>
        <span class="s1">{ collapsable: </span><span class="s7">false </span><span class="s1">},</span>
        <span class="s4">// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access</span>
        <span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">children</span>
      <span class="s1">);</span>
    <span class="s1">} </span><span class="s0">catch </span><span class="s1">(</span><span class="s2">e</span><span class="s1">) {</span>
      <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
        <span class="s6">tagMessage</span><span class="s1">(</span>
          <span class="s3">`GestureDetector got more than one view as a child. If you want the gesture to work on multiple views, wrap them with a common parent and attach the gesture to that view.`</span>
        <span class="s1">)</span>
      <span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">const </span><span class="s1">AnimatedWrap </span><span class="s0">= </span><span class="s2">Reanimated</span><span class="s1">?.</span><span class="s2">default</span><span class="s1">?.</span><span class="s6">createAnimatedComponent</span><span class="s1">(</span><span class="s2">Wrap</span><span class="s1">) </span><span class="s0">?? </span><span class="s2">Wrap</span><span class="s1">;</span>
</pre>
</body>
</html>