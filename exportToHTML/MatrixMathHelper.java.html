<html>
<head>
<title>MatrixMathHelper.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #6897bb;}
.s5 { color: #629755; font-weight: bold; font-style: italic;}
.s6 { color: #77b767; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
MatrixMathHelper.java</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">package </span><span class="s1">com.facebook.react.uimanager</span><span class="s2">;</span>

<span class="s2">import </span><span class="s1">com.facebook.infer.annotation.Assertions</span><span class="s2">;</span>

<span class="s3">/**</span>
 <span class="s3">* Provides helper methods for converting transform operations into a matrix and then into a list of</span>
 <span class="s3">* translate, scale and rotate commands.</span>
 <span class="s3">*/</span>
<span class="s2">public class </span><span class="s1">MatrixMathHelper {</span>

  <span class="s2">private static final double </span><span class="s1">EPSILON = </span><span class="s4">.00001d</span><span class="s2">;</span>

  <span class="s2">public static class </span><span class="s1">MatrixDecompositionContext {</span>
    <span class="s2">double</span><span class="s1">[] perspective = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">4</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">double</span><span class="s1">[] scale = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">double</span><span class="s1">[] skew = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">double</span><span class="s1">[] translation = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">double</span><span class="s1">[] rotationDegrees = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">;</span>

    <span class="s2">private static void </span><span class="s1">resetArray(</span><span class="s2">double</span><span class="s1">[] arr) {</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">i = </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i &lt; arr.length</span><span class="s2">; </span><span class="s1">i++) {</span>
        <span class="s1">arr[i] = </span><span class="s4">0</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">public void </span><span class="s1">reset() {</span>
      <span class="s1">MatrixDecompositionContext.resetArray(perspective)</span><span class="s2">;</span>
      <span class="s1">MatrixDecompositionContext.resetArray(scale)</span><span class="s2">;</span>
      <span class="s1">MatrixDecompositionContext.resetArray(skew)</span><span class="s2">;</span>
      <span class="s1">MatrixDecompositionContext.resetArray(translation)</span><span class="s2">;</span>
      <span class="s1">MatrixDecompositionContext.resetArray(rotationDegrees)</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private static boolean </span><span class="s1">isZero(</span><span class="s2">double </span><span class="s1">d) {</span>
    <span class="s2">if </span><span class="s1">(Double.isNaN(d)) {</span>
      <span class="s2">return false;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">Math.abs(d) &lt; EPSILON</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">multiplyInto(</span><span class="s2">double</span><span class="s1">[] out</span><span class="s2">, double</span><span class="s1">[] a</span><span class="s2">, double</span><span class="s1">[] b) {</span>
    <span class="s2">double </span><span class="s1">a00 = a[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a01 = a[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a02 = a[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a03 = a[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a10 = a[</span><span class="s4">4</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a11 = a[</span><span class="s4">5</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a12 = a[</span><span class="s4">6</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a13 = a[</span><span class="s4">7</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a20 = a[</span><span class="s4">8</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a21 = a[</span><span class="s4">9</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a22 = a[</span><span class="s4">10</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a23 = a[</span><span class="s4">11</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a30 = a[</span><span class="s4">12</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a31 = a[</span><span class="s4">13</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a32 = a[</span><span class="s4">14</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">a33 = a[</span><span class="s4">15</span><span class="s1">]</span><span class="s2">;</span>

    <span class="s2">double </span><span class="s1">b0 = b[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">b1 = b[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">b2 = b[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">b3 = b[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">0</span><span class="s1">] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">1</span><span class="s1">] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">2</span><span class="s1">] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">3</span><span class="s1">] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33</span><span class="s2">;</span>

    <span class="s1">b0 = b[</span><span class="s4">4</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b1 = b[</span><span class="s4">5</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b2 = b[</span><span class="s4">6</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b3 = b[</span><span class="s4">7</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">4</span><span class="s1">] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">5</span><span class="s1">] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">6</span><span class="s1">] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">7</span><span class="s1">] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33</span><span class="s2">;</span>

    <span class="s1">b0 = b[</span><span class="s4">8</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b1 = b[</span><span class="s4">9</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b2 = b[</span><span class="s4">10</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b3 = b[</span><span class="s4">11</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">8</span><span class="s1">] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">9</span><span class="s1">] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">10</span><span class="s1">] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">11</span><span class="s1">] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33</span><span class="s2">;</span>

    <span class="s1">b0 = b[</span><span class="s4">12</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b1 = b[</span><span class="s4">13</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b2 = b[</span><span class="s4">14</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">b3 = b[</span><span class="s4">15</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">12</span><span class="s1">] = b0 * a00 + b1 * a10 + b2 * a20 + b3 * a30</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">13</span><span class="s1">] = b0 * a01 + b1 * a11 + b2 * a21 + b3 * a31</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">14</span><span class="s1">] = b0 * a02 + b1 * a12 + b2 * a22 + b3 * a32</span><span class="s2">;</span>
    <span class="s1">out[</span><span class="s4">15</span><span class="s1">] = b0 * a03 + b1 * a13 + b2 * a23 + b3 * a33</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/** </span><span class="s5">@param </span><span class="s3">transformMatrix 16-element array of numbers representing 4x4 transform matrix */</span>
  <span class="s2">public static void </span><span class="s1">decomposeMatrix(</span><span class="s2">double</span><span class="s1">[] transformMatrix</span><span class="s2">, </span><span class="s1">MatrixDecompositionContext ctx) {</span>
    <span class="s1">Assertions.assertCondition(transformMatrix.length == </span><span class="s4">16</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s0">// output values</span>
    <span class="s2">final double</span><span class="s1">[] perspective = ctx.perspective</span><span class="s2">;</span>
    <span class="s2">final double</span><span class="s1">[] scale = ctx.scale</span><span class="s2">;</span>
    <span class="s2">final double</span><span class="s1">[] skew = ctx.skew</span><span class="s2">;</span>
    <span class="s2">final double</span><span class="s1">[] translation = ctx.translation</span><span class="s2">;</span>
    <span class="s2">final double</span><span class="s1">[] rotationDegrees = ctx.rotationDegrees</span><span class="s2">;</span>

    <span class="s0">// create normalized, 2d array matrix</span>
    <span class="s0">// and normalized 1d array perspectiveMatrix with redefined 4th column</span>
    <span class="s2">if </span><span class="s1">(isZero(transformMatrix[</span><span class="s4">15</span><span class="s1">])) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>
    <span class="s2">double</span><span class="s1">[][] matrix = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">4</span><span class="s1">][</span><span class="s4">4</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">double</span><span class="s1">[] perspectiveMatrix = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">16</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">i = </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i &lt; </span><span class="s4">4</span><span class="s2">; </span><span class="s1">i++) {</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">j = </span><span class="s4">0</span><span class="s2">; </span><span class="s1">j &lt; </span><span class="s4">4</span><span class="s2">; </span><span class="s1">j++) {</span>
        <span class="s2">double </span><span class="s1">value = transformMatrix[(i * </span><span class="s4">4</span><span class="s1">) + j] / transformMatrix[</span><span class="s4">15</span><span class="s1">]</span><span class="s2">;</span>
        <span class="s1">matrix[i][j] = value</span><span class="s2">;</span>
        <span class="s1">perspectiveMatrix[(i * </span><span class="s4">4</span><span class="s1">) + j] = j == </span><span class="s4">3 </span><span class="s1">? </span><span class="s4">0 </span><span class="s1">: value</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s1">perspectiveMatrix[</span><span class="s4">15</span><span class="s1">] = </span><span class="s4">1</span><span class="s2">;</span>

    <span class="s0">// test for singularity of upper 3x3 part of the perspective matrix</span>
    <span class="s2">if </span><span class="s1">(isZero(determinant(perspectiveMatrix))) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s0">// isolate perspective</span>
    <span class="s2">if </span><span class="s1">(!isZero(matrix[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]) || !isZero(matrix[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]) || !isZero(matrix[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">3</span><span class="s1">])) {</span>
      <span class="s0">// rightHandSide is the right hand side of the equation.</span>
      <span class="s0">// rightHandSide is a vector, or point in 3d space relative to the origin.</span>
      <span class="s2">double</span><span class="s1">[] rightHandSide = {matrix[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">matrix[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">matrix[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">matrix[</span><span class="s4">3</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]}</span><span class="s2">;</span>

      <span class="s0">// Solve the equation by inverting perspectiveMatrix and multiplying</span>
      <span class="s0">// rightHandSide by the inverse.</span>
      <span class="s2">double</span><span class="s1">[] inversePerspectiveMatrix = inverse(perspectiveMatrix)</span><span class="s2">;</span>
      <span class="s2">double</span><span class="s1">[] transposedInversePerspectiveMatrix = transpose(inversePerspectiveMatrix)</span><span class="s2">;</span>
      <span class="s1">multiplyVectorByMatrix(rightHandSide</span><span class="s2">, </span><span class="s1">transposedInversePerspectiveMatrix</span><span class="s2">, </span><span class="s1">perspective)</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s0">// no perspective</span>
      <span class="s1">perspective[</span><span class="s4">0</span><span class="s1">] = perspective[</span><span class="s4">1</span><span class="s1">] = perspective[</span><span class="s4">2</span><span class="s1">] = </span><span class="s4">0d</span><span class="s2">;</span>
      <span class="s1">perspective[</span><span class="s4">3</span><span class="s1">] = </span><span class="s4">1d</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s0">// translation is simple</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">i = </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i &lt; </span><span class="s4">3</span><span class="s2">; </span><span class="s1">i++) {</span>
      <span class="s1">translation[i] = matrix[</span><span class="s4">3</span><span class="s1">][i]</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s0">// Now get scale and shear.</span>
    <span class="s0">// 'row' is a 3 element array of 3 component vectors</span>
    <span class="s2">double</span><span class="s1">[][] row = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">3</span><span class="s1">][</span><span class="s4">3</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">i = </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i &lt; </span><span class="s4">3</span><span class="s2">; </span><span class="s1">i++) {</span>
      <span class="s1">row[i][</span><span class="s4">0</span><span class="s1">] = matrix[i][</span><span class="s4">0</span><span class="s1">]</span><span class="s2">;</span>
      <span class="s1">row[i][</span><span class="s4">1</span><span class="s1">] = matrix[i][</span><span class="s4">1</span><span class="s1">]</span><span class="s2">;</span>
      <span class="s1">row[i][</span><span class="s4">2</span><span class="s1">] = matrix[i][</span><span class="s4">2</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s0">// Compute X scale factor and normalize first row.</span>
    <span class="s1">scale[</span><span class="s4">0</span><span class="s1">] = v3Length(row[</span><span class="s4">0</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">row[</span><span class="s4">0</span><span class="s1">] = v3Normalize(row[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">scale[</span><span class="s4">0</span><span class="s1">])</span><span class="s2">;</span>

    <span class="s0">// Compute XY shear factor and make 2nd row orthogonal to 1st.</span>
    <span class="s1">skew[</span><span class="s4">0</span><span class="s1">] = v3Dot(row[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">1</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">row[</span><span class="s4">1</span><span class="s1">] = v3Combine(row[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">-skew[</span><span class="s4">0</span><span class="s1">])</span><span class="s2">;</span>

    <span class="s0">// Now, compute Y scale and normalize 2nd row.</span>
    <span class="s1">scale[</span><span class="s4">1</span><span class="s1">] = v3Length(row[</span><span class="s4">1</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">row[</span><span class="s4">1</span><span class="s1">] = v3Normalize(row[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">scale[</span><span class="s4">1</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">skew[</span><span class="s4">0</span><span class="s1">] /= scale[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">;</span>

    <span class="s0">// Compute XZ and YZ shears, orthogonalize 3rd row</span>
    <span class="s1">skew[</span><span class="s4">1</span><span class="s1">] = v3Dot(row[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">2</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">row[</span><span class="s4">2</span><span class="s1">] = v3Combine(row[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">-skew[</span><span class="s4">1</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">skew[</span><span class="s4">2</span><span class="s1">] = v3Dot(row[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">2</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">row[</span><span class="s4">2</span><span class="s1">] = v3Combine(row[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">1.0</span><span class="s2">, </span><span class="s1">-skew[</span><span class="s4">2</span><span class="s1">])</span><span class="s2">;</span>

    <span class="s0">// Next, get Z scale and normalize 3rd row.</span>
    <span class="s1">scale[</span><span class="s4">2</span><span class="s1">] = v3Length(row[</span><span class="s4">2</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">row[</span><span class="s4">2</span><span class="s1">] = v3Normalize(row[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">scale[</span><span class="s4">2</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s1">skew[</span><span class="s4">1</span><span class="s1">] /= scale[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">skew[</span><span class="s4">2</span><span class="s1">] /= scale[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">;</span>

    <span class="s0">// At this point, the matrix (in rows) is orthonormal.</span>
    <span class="s0">// Check for a coordinate system flip.  If the determinant</span>
    <span class="s0">// is -1, then negate the matrix and the scaling factors.</span>
    <span class="s2">double</span><span class="s1">[] pdum3 = v3Cross(row[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">2</span><span class="s1">])</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(v3Dot(row[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">pdum3) &lt; </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">i = </span><span class="s4">0</span><span class="s2">; </span><span class="s1">i &lt; </span><span class="s4">3</span><span class="s2">; </span><span class="s1">i++) {</span>
        <span class="s1">scale[i] *= -</span><span class="s4">1</span><span class="s2">;</span>
        <span class="s1">row[i][</span><span class="s4">0</span><span class="s1">] *= -</span><span class="s4">1</span><span class="s2">;</span>
        <span class="s1">row[i][</span><span class="s4">1</span><span class="s1">] *= -</span><span class="s4">1</span><span class="s2">;</span>
        <span class="s1">row[i][</span><span class="s4">2</span><span class="s1">] *= -</span><span class="s4">1</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">// Now, get the rotations out</span>
    <span class="s0">// Based on: http://nghiaho.com/?page_id=846</span>
    <span class="s2">double </span><span class="s1">conv = </span><span class="s4">180 </span><span class="s1">/ Math.PI</span><span class="s2">;</span>
    <span class="s1">rotationDegrees[</span><span class="s4">0</span><span class="s1">] = roundTo3Places(-Math.atan2(row[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">2</span><span class="s1">]) * conv)</span><span class="s2">;</span>
    <span class="s1">rotationDegrees[</span><span class="s4">1</span><span class="s1">] =</span>
        <span class="s1">roundTo3Places(</span>
            <span class="s1">-Math.atan2(-row[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">Math.sqrt(row[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] * row[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">1</span><span class="s1">] + row[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">2</span><span class="s1">] * row[</span><span class="s4">2</span><span class="s1">][</span><span class="s4">2</span><span class="s1">]))</span>
                <span class="s1">* conv)</span><span class="s2">;</span>
    <span class="s1">rotationDegrees[</span><span class="s4">2</span><span class="s1">] = roundTo3Places(-Math.atan2(row[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">row[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">]) * conv)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static double </span><span class="s1">determinant(</span><span class="s2">double</span><span class="s1">[] matrix) {</span>
    <span class="s2">double </span><span class="s1">m00 = matrix[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m01 = matrix[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m02 = matrix[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m03 = matrix[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m10 = matrix[</span><span class="s4">4</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m11 = matrix[</span><span class="s4">5</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m12 = matrix[</span><span class="s4">6</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m13 = matrix[</span><span class="s4">7</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m20 = matrix[</span><span class="s4">8</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m21 = matrix[</span><span class="s4">9</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m22 = matrix[</span><span class="s4">10</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m23 = matrix[</span><span class="s4">11</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m30 = matrix[</span><span class="s4">12</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m31 = matrix[</span><span class="s4">13</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m32 = matrix[</span><span class="s4">14</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m33 = matrix[</span><span class="s4">15</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">return </span><span class="s1">(m03 * m12 * m21 * m30</span>
        <span class="s1">- m02 * m13 * m21 * m30</span>
        <span class="s1">- m03 * m11 * m22 * m30</span>
        <span class="s1">+ m01 * m13 * m22 * m30</span>
        <span class="s1">+ m02 * m11 * m23 * m30</span>
        <span class="s1">- m01 * m12 * m23 * m30</span>
        <span class="s1">- m03 * m12 * m20 * m31</span>
        <span class="s1">+ m02 * m13 * m20 * m31</span>
        <span class="s1">+ m03 * m10 * m22 * m31</span>
        <span class="s1">- m00 * m13 * m22 * m31</span>
        <span class="s1">- m02 * m10 * m23 * m31</span>
        <span class="s1">+ m00 * m12 * m23 * m31</span>
        <span class="s1">+ m03 * m11 * m20 * m32</span>
        <span class="s1">- m01 * m13 * m20 * m32</span>
        <span class="s1">- m03 * m10 * m21 * m32</span>
        <span class="s1">+ m00 * m13 * m21 * m32</span>
        <span class="s1">+ m01 * m10 * m23 * m32</span>
        <span class="s1">- m00 * m11 * m23 * m32</span>
        <span class="s1">- m02 * m11 * m20 * m33</span>
        <span class="s1">+ m01 * m12 * m20 * m33</span>
        <span class="s1">+ m02 * m10 * m21 * m33</span>
        <span class="s1">- m00 * m12 * m21 * m33</span>
        <span class="s1">- m01 * m10 * m22 * m33</span>
        <span class="s1">+ m00 * m11 * m22 * m33)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/**</span>
   <span class="s3">* Inverse of a matrix. Multiplying by the inverse is used in matrix math instead of division.</span>
   <span class="s3">*</span>
   <span class="s3">* </span><span class="s6">&lt;p&gt;</span><span class="s3">Formula from:</span>
   <span class="s3">* http://www.euclideanspace.com/maths/algebra/matrix/functions/inverse/fourD/index.htm</span>
   <span class="s3">*/</span>
  <span class="s2">public static double</span><span class="s1">[] inverse(</span><span class="s2">double</span><span class="s1">[] matrix) {</span>
    <span class="s2">double </span><span class="s1">det = determinant(matrix)</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(isZero(det)) {</span>
      <span class="s2">return </span><span class="s1">matrix</span><span class="s2">;</span>
    <span class="s1">}</span>
    <span class="s2">double </span><span class="s1">m00 = matrix[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m01 = matrix[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m02 = matrix[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m03 = matrix[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m10 = matrix[</span><span class="s4">4</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m11 = matrix[</span><span class="s4">5</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m12 = matrix[</span><span class="s4">6</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m13 = matrix[</span><span class="s4">7</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m20 = matrix[</span><span class="s4">8</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m21 = matrix[</span><span class="s4">9</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m22 = matrix[</span><span class="s4">10</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m23 = matrix[</span><span class="s4">11</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m30 = matrix[</span><span class="s4">12</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m31 = matrix[</span><span class="s4">13</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m32 = matrix[</span><span class="s4">14</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">m33 = matrix[</span><span class="s4">15</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s2">return new double</span><span class="s1">[] {</span>
      <span class="s1">(m12 * m23 * m31</span>
              <span class="s1">- m13 * m22 * m31</span>
              <span class="s1">+ m13 * m21 * m32</span>
              <span class="s1">- m11 * m23 * m32</span>
              <span class="s1">- m12 * m21 * m33</span>
              <span class="s1">+ m11 * m22 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m03 * m22 * m31</span>
              <span class="s1">- m02 * m23 * m31</span>
              <span class="s1">- m03 * m21 * m32</span>
              <span class="s1">+ m01 * m23 * m32</span>
              <span class="s1">+ m02 * m21 * m33</span>
              <span class="s1">- m01 * m22 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m02 * m13 * m31</span>
              <span class="s1">- m03 * m12 * m31</span>
              <span class="s1">+ m03 * m11 * m32</span>
              <span class="s1">- m01 * m13 * m32</span>
              <span class="s1">- m02 * m11 * m33</span>
              <span class="s1">+ m01 * m12 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m03 * m12 * m21</span>
              <span class="s1">- m02 * m13 * m21</span>
              <span class="s1">- m03 * m11 * m22</span>
              <span class="s1">+ m01 * m13 * m22</span>
              <span class="s1">+ m02 * m11 * m23</span>
              <span class="s1">- m01 * m12 * m23)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m13 * m22 * m30</span>
              <span class="s1">- m12 * m23 * m30</span>
              <span class="s1">- m13 * m20 * m32</span>
              <span class="s1">+ m10 * m23 * m32</span>
              <span class="s1">+ m12 * m20 * m33</span>
              <span class="s1">- m10 * m22 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m02 * m23 * m30</span>
              <span class="s1">- m03 * m22 * m30</span>
              <span class="s1">+ m03 * m20 * m32</span>
              <span class="s1">- m00 * m23 * m32</span>
              <span class="s1">- m02 * m20 * m33</span>
              <span class="s1">+ m00 * m22 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m03 * m12 * m30</span>
              <span class="s1">- m02 * m13 * m30</span>
              <span class="s1">- m03 * m10 * m32</span>
              <span class="s1">+ m00 * m13 * m32</span>
              <span class="s1">+ m02 * m10 * m33</span>
              <span class="s1">- m00 * m12 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m02 * m13 * m20</span>
              <span class="s1">- m03 * m12 * m20</span>
              <span class="s1">+ m03 * m10 * m22</span>
              <span class="s1">- m00 * m13 * m22</span>
              <span class="s1">- m02 * m10 * m23</span>
              <span class="s1">+ m00 * m12 * m23)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m11 * m23 * m30</span>
              <span class="s1">- m13 * m21 * m30</span>
              <span class="s1">+ m13 * m20 * m31</span>
              <span class="s1">- m10 * m23 * m31</span>
              <span class="s1">- m11 * m20 * m33</span>
              <span class="s1">+ m10 * m21 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m03 * m21 * m30</span>
              <span class="s1">- m01 * m23 * m30</span>
              <span class="s1">- m03 * m20 * m31</span>
              <span class="s1">+ m00 * m23 * m31</span>
              <span class="s1">+ m01 * m20 * m33</span>
              <span class="s1">- m00 * m21 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m01 * m13 * m30</span>
              <span class="s1">- m03 * m11 * m30</span>
              <span class="s1">+ m03 * m10 * m31</span>
              <span class="s1">- m00 * m13 * m31</span>
              <span class="s1">- m01 * m10 * m33</span>
              <span class="s1">+ m00 * m11 * m33)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m03 * m11 * m20</span>
              <span class="s1">- m01 * m13 * m20</span>
              <span class="s1">- m03 * m10 * m21</span>
              <span class="s1">+ m00 * m13 * m21</span>
              <span class="s1">+ m01 * m10 * m23</span>
              <span class="s1">- m00 * m11 * m23)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m12 * m21 * m30</span>
              <span class="s1">- m11 * m22 * m30</span>
              <span class="s1">- m12 * m20 * m31</span>
              <span class="s1">+ m10 * m22 * m31</span>
              <span class="s1">+ m11 * m20 * m32</span>
              <span class="s1">- m10 * m21 * m32)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m01 * m22 * m30</span>
              <span class="s1">- m02 * m21 * m30</span>
              <span class="s1">+ m02 * m20 * m31</span>
              <span class="s1">- m00 * m22 * m31</span>
              <span class="s1">- m01 * m20 * m32</span>
              <span class="s1">+ m00 * m21 * m32)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m02 * m11 * m30</span>
              <span class="s1">- m01 * m12 * m30</span>
              <span class="s1">- m02 * m10 * m31</span>
              <span class="s1">+ m00 * m12 * m31</span>
              <span class="s1">+ m01 * m10 * m32</span>
              <span class="s1">- m00 * m11 * m32)</span>
          <span class="s1">/ det</span><span class="s2">,</span>
      <span class="s1">(m01 * m12 * m20</span>
              <span class="s1">- m02 * m11 * m20</span>
              <span class="s1">+ m02 * m10 * m21</span>
              <span class="s1">- m00 * m12 * m21</span>
              <span class="s1">- m01 * m10 * m22</span>
              <span class="s1">+ m00 * m11 * m22)</span>
          <span class="s1">/ det</span>
    <span class="s1">}</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/** Turns columns into rows and rows into columns. */</span>
  <span class="s2">public static double</span><span class="s1">[] transpose(</span><span class="s2">double</span><span class="s1">[] m) {</span>
    <span class="s2">return new double</span><span class="s1">[] {</span>
      <span class="s1">m[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">8</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">12</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">m[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">9</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">13</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">m[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">14</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">m[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">7</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">11</span><span class="s1">]</span><span class="s2">, </span><span class="s1">m[</span><span class="s4">15</span><span class="s1">]</span>
    <span class="s1">}</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/** Based on: http://tog.acm.org/resources/GraphicsGems/gemsii/unmatrix.c */</span>
  <span class="s2">public static void </span><span class="s1">multiplyVectorByMatrix(</span><span class="s2">double</span><span class="s1">[] v</span><span class="s2">, double</span><span class="s1">[] m</span><span class="s2">, double</span><span class="s1">[] result) {</span>
    <span class="s2">double </span><span class="s1">vx = v[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">vy = v[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">vz = v[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">vw = v[</span><span class="s4">3</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">result[</span><span class="s4">0</span><span class="s1">] = vx * m[</span><span class="s4">0</span><span class="s1">] + vy * m[</span><span class="s4">4</span><span class="s1">] + vz * m[</span><span class="s4">8</span><span class="s1">] + vw * m[</span><span class="s4">12</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">result[</span><span class="s4">1</span><span class="s1">] = vx * m[</span><span class="s4">1</span><span class="s1">] + vy * m[</span><span class="s4">5</span><span class="s1">] + vz * m[</span><span class="s4">9</span><span class="s1">] + vw * m[</span><span class="s4">13</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">result[</span><span class="s4">2</span><span class="s1">] = vx * m[</span><span class="s4">2</span><span class="s1">] + vy * m[</span><span class="s4">6</span><span class="s1">] + vz * m[</span><span class="s4">10</span><span class="s1">] + vw * m[</span><span class="s4">14</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">result[</span><span class="s4">3</span><span class="s1">] = vx * m[</span><span class="s4">3</span><span class="s1">] + vy * m[</span><span class="s4">7</span><span class="s1">] + vz * m[</span><span class="s4">11</span><span class="s1">] + vw * m[</span><span class="s4">15</span><span class="s1">]</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/** From: https://code.google.com/p/webgl-mjs/source/browse/mjs.js */</span>
  <span class="s2">public static double </span><span class="s1">v3Length(</span><span class="s2">double</span><span class="s1">[] a) {</span>
    <span class="s2">return </span><span class="s1">Math.sqrt(a[</span><span class="s4">0</span><span class="s1">] * a[</span><span class="s4">0</span><span class="s1">] + a[</span><span class="s4">1</span><span class="s1">] * a[</span><span class="s4">1</span><span class="s1">] + a[</span><span class="s4">2</span><span class="s1">] * a[</span><span class="s4">2</span><span class="s1">])</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/** Based on: https://code.google.com/p/webgl-mjs/source/browse/mjs.js */</span>
  <span class="s2">public static double</span><span class="s1">[] v3Normalize(</span><span class="s2">double</span><span class="s1">[] vector</span><span class="s2">, double </span><span class="s1">norm) {</span>
    <span class="s2">double </span><span class="s1">im = </span><span class="s4">1 </span><span class="s1">/ (isZero(norm) ? v3Length(vector) : norm)</span><span class="s2">;</span>
    <span class="s2">return new double</span><span class="s1">[] {vector[</span><span class="s4">0</span><span class="s1">] * im</span><span class="s2">, </span><span class="s1">vector[</span><span class="s4">1</span><span class="s1">] * im</span><span class="s2">, </span><span class="s1">vector[</span><span class="s4">2</span><span class="s1">] * im}</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/**</span>
   <span class="s3">* The dot product of a and b, two 3-element vectors. From:</span>
   <span class="s3">* https://code.google.com/p/webgl-mjs/source/browse/mjs.js</span>
   <span class="s3">*/</span>
  <span class="s2">public static double </span><span class="s1">v3Dot(</span><span class="s2">double</span><span class="s1">[] a</span><span class="s2">, double</span><span class="s1">[] b) {</span>
    <span class="s2">return </span><span class="s1">a[</span><span class="s4">0</span><span class="s1">] * b[</span><span class="s4">0</span><span class="s1">] + a[</span><span class="s4">1</span><span class="s1">] * b[</span><span class="s4">1</span><span class="s1">] + a[</span><span class="s4">2</span><span class="s1">] * b[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/**</span>
   <span class="s3">* From:</span>
   <span class="s3">* http://www.opensource.apple.com/source/WebCore/WebCore-514/platform/graphics/transforms/TransformationMatrix.cpp</span>
   <span class="s3">*/</span>
  <span class="s2">public static double</span><span class="s1">[] v3Combine(</span><span class="s2">double</span><span class="s1">[] a</span><span class="s2">, double</span><span class="s1">[] b</span><span class="s2">, double </span><span class="s1">aScale</span><span class="s2">, double </span><span class="s1">bScale) {</span>
    <span class="s2">return new double</span><span class="s1">[] {</span>
      <span class="s1">aScale * a[</span><span class="s4">0</span><span class="s1">] + bScale * b[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">aScale * a[</span><span class="s4">1</span><span class="s1">] + bScale * b[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">aScale * a[</span><span class="s4">2</span><span class="s1">] + bScale * b[</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">}</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/**</span>
   <span class="s3">* From:</span>
   <span class="s3">* http://www.opensource.apple.com/source/WebCore/WebCore-514/platform/graphics/transforms/TransformationMatrix.cpp</span>
   <span class="s3">*/</span>
  <span class="s2">public static double</span><span class="s1">[] v3Cross(</span><span class="s2">double</span><span class="s1">[] a</span><span class="s2">, double</span><span class="s1">[] b) {</span>
    <span class="s2">return new double</span><span class="s1">[] {</span>
      <span class="s1">a[</span><span class="s4">1</span><span class="s1">] * b[</span><span class="s4">2</span><span class="s1">] - a[</span><span class="s4">2</span><span class="s1">] * b[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">a[</span><span class="s4">2</span><span class="s1">] * b[</span><span class="s4">0</span><span class="s1">] - a[</span><span class="s4">0</span><span class="s1">] * b[</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">a[</span><span class="s4">0</span><span class="s1">] * b[</span><span class="s4">1</span><span class="s1">] - a[</span><span class="s4">1</span><span class="s1">] * b[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">}</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static double </span><span class="s1">roundTo3Places(</span><span class="s2">double </span><span class="s1">n) {</span>
    <span class="s2">return </span><span class="s1">Math.round(n * </span><span class="s4">1000d</span><span class="s1">) * </span><span class="s4">0.001</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static double</span><span class="s1">[] createIdentityMatrix() {</span>
    <span class="s2">double</span><span class="s1">[] res = </span><span class="s2">new double</span><span class="s1">[</span><span class="s4">16</span><span class="s1">]</span><span class="s2">;</span>
    <span class="s1">resetIdentityMatrix(res)</span><span class="s2">;</span>
    <span class="s2">return </span><span class="s1">res</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static double </span><span class="s1">degreesToRadians(</span><span class="s2">double </span><span class="s1">degrees) {</span>
    <span class="s2">return </span><span class="s1">degrees * Math.PI / </span><span class="s4">180</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">resetIdentityMatrix(</span><span class="s2">double</span><span class="s1">[] matrix) {</span>
    <span class="s1">matrix[</span><span class="s4">1</span><span class="s1">] =</span>
        <span class="s1">matrix[</span><span class="s4">2</span><span class="s1">] =</span>
            <span class="s1">matrix[</span><span class="s4">3</span><span class="s1">] =</span>
                <span class="s1">matrix[</span><span class="s4">4</span><span class="s1">] =</span>
                    <span class="s1">matrix[</span><span class="s4">6</span><span class="s1">] =</span>
                        <span class="s1">matrix[</span><span class="s4">7</span><span class="s1">] =</span>
                            <span class="s1">matrix[</span><span class="s4">8</span><span class="s1">] =</span>
                                <span class="s1">matrix[</span><span class="s4">9</span><span class="s1">] = matrix[</span><span class="s4">11</span><span class="s1">] = matrix[</span><span class="s4">12</span><span class="s1">] = matrix[</span><span class="s4">13</span><span class="s1">] = matrix[</span><span class="s4">14</span><span class="s1">] = </span><span class="s4">0</span><span class="s2">;</span>
    <span class="s1">matrix[</span><span class="s4">0</span><span class="s1">] = matrix[</span><span class="s4">5</span><span class="s1">] = matrix[</span><span class="s4">10</span><span class="s1">] = matrix[</span><span class="s4">15</span><span class="s1">] = </span><span class="s4">1</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyPerspective(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">perspective) {</span>
    <span class="s1">m[</span><span class="s4">11</span><span class="s1">] = -</span><span class="s4">1 </span><span class="s1">/ perspective</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyScaleX(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">factor) {</span>
    <span class="s1">m[</span><span class="s4">0</span><span class="s1">] = factor</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyScaleY(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">factor) {</span>
    <span class="s1">m[</span><span class="s4">5</span><span class="s1">] = factor</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyScaleZ(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">factor) {</span>
    <span class="s1">m[</span><span class="s4">10</span><span class="s1">] = factor</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyTranslate2D(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">x</span><span class="s2">, double </span><span class="s1">y) {</span>
    <span class="s1">m[</span><span class="s4">12</span><span class="s1">] = x</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">13</span><span class="s1">] = y</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyTranslate3D(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">x</span><span class="s2">, double </span><span class="s1">y</span><span class="s2">, double </span><span class="s1">z) {</span>
    <span class="s1">m[</span><span class="s4">12</span><span class="s1">] = x</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">13</span><span class="s1">] = y</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">14</span><span class="s1">] = z</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applySkewX(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">radians) {</span>
    <span class="s1">m[</span><span class="s4">4</span><span class="s1">] = Math.tan(radians)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applySkewY(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">radians) {</span>
    <span class="s1">m[</span><span class="s4">1</span><span class="s1">] = Math.tan(radians)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyRotateX(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">radians) {</span>
    <span class="s1">m[</span><span class="s4">5</span><span class="s1">] = Math.cos(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">6</span><span class="s1">] = Math.sin(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">9</span><span class="s1">] = -Math.sin(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">10</span><span class="s1">] = Math.cos(radians)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public static void </span><span class="s1">applyRotateY(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">radians) {</span>
    <span class="s1">m[</span><span class="s4">0</span><span class="s1">] = Math.cos(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">2</span><span class="s1">] = -Math.sin(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">8</span><span class="s1">] = Math.sin(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">10</span><span class="s1">] = Math.cos(radians)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s0">// http://www.w3.org/TR/css3-transforms/#recomposing-to-a-2d-matrix</span>
  <span class="s2">public static void </span><span class="s1">applyRotateZ(</span><span class="s2">double</span><span class="s1">[] m</span><span class="s2">, double </span><span class="s1">radians) {</span>
    <span class="s1">m[</span><span class="s4">0</span><span class="s1">] = Math.cos(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">1</span><span class="s1">] = Math.sin(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">4</span><span class="s1">] = -Math.sin(radians)</span><span class="s2">;</span>
    <span class="s1">m[</span><span class="s4">5</span><span class="s1">] = Math.cos(radians)</span><span class="s2">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>