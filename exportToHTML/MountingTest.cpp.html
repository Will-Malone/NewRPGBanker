<html>
<head>
<title>MountingTest.cpp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
MountingTest.cpp</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#include </span><span class="s3">&lt;memory&gt;</span>

<span class="s2">#include </span><span class="s3">&lt;react/renderer/components/root/RootComponentDescriptor.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/renderer/components/view/ViewComponentDescriptor.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/renderer/core/PropsParserContext.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/renderer/mounting/Differentiator.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/renderer/mounting/stubs.h&gt;</span>

<span class="s2">#include </span><span class="s3">&lt;react/test_utils/shadowTreeGeneration.h&gt;</span>

<span class="s2">#include </span><span class="s3">&lt;glog/logging.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;gtest/gtest.h&gt;</span>

<span class="s4">namespace </span><span class="s1">facebook::react {</span>

<span class="s4">static </span><span class="s1">SharedViewProps nonFlattenedDefaultProps(</span>
    <span class="s1">ComponentDescriptor </span><span class="s4">const </span><span class="s1">&amp;componentDescriptor) {</span>
  <span class="s1">folly::dynamic dynamic = folly::dynamic::object()</span><span class="s4">;</span>
  <span class="s1">dynamic[</span><span class="s3">&quot;position&quot;</span><span class="s1">] = </span><span class="s3">&quot;absolute&quot;</span><span class="s4">;</span>
  <span class="s1">dynamic[</span><span class="s3">&quot;top&quot;</span><span class="s1">] = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">dynamic[</span><span class="s3">&quot;left&quot;</span><span class="s1">] = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">dynamic[</span><span class="s3">&quot;width&quot;</span><span class="s1">] = </span><span class="s5">100</span><span class="s4">;</span>
  <span class="s1">dynamic[</span><span class="s3">&quot;height&quot;</span><span class="s1">] = </span><span class="s5">100</span><span class="s4">;</span>
  <span class="s1">dynamic[</span><span class="s3">&quot;nativeId&quot;</span><span class="s1">] = </span><span class="s3">&quot;NativeId&quot;</span><span class="s4">;</span>
  <span class="s1">dynamic[</span><span class="s3">&quot;accessible&quot;</span><span class="s1">] = </span><span class="s4">true;</span>

  <span class="s1">ContextContainer contextContainer{}</span><span class="s4">;</span>
  <span class="s1">PropsParserContext parserContext{-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">contextContainer}</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">std::static_pointer_cast&lt;ViewProps </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">componentDescriptor.cloneProps(</span>
          <span class="s1">parserContext</span><span class="s4">, nullptr, </span><span class="s1">RawProps{dynamic}))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">static </span><span class="s1">ShadowNode::Shared makeNode(</span>
    <span class="s1">ComponentDescriptor </span><span class="s4">const </span><span class="s1">&amp;componentDescriptor</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">tag</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">ShadowNode::ListOfShared &amp;children</span><span class="s4">,</span>
    <span class="s4">bool </span><span class="s1">flattened = </span><span class="s4">false</span><span class="s1">) {</span>
  <span class="s4">auto </span><span class="s1">props = flattened ? generateDefaultProps(componentDescriptor)</span>
                         <span class="s1">: nonFlattenedDefaultProps(componentDescriptor)</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">componentDescriptor.createShadowNode(</span>
      <span class="s1">ShadowNodeFragment{</span>
          <span class="s1">props</span><span class="s4">, </span><span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(children)}</span><span class="s4">,</span>
      <span class="s1">componentDescriptor.createFamily({tag</span><span class="s4">, </span><span class="s1">SurfaceId(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, nullptr</span><span class="s1">}</span><span class="s4">, nullptr</span><span class="s1">))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s0">/** 
 * Test reordering of views with the same parent: 
 * 
 * For instance: 
 *    A -&gt; [B,C,D]  ==&gt; A -&gt; [D,B,C] 
 * 
 * In the V1 of diffing this would produce 3 removes and 3 inserts, but with 
 * some cleverness we can reduce this to 1 remove and 1 insert. 
 */</span>
<span class="s1">TEST(MountingTest</span><span class="s4">, </span><span class="s1">testReorderingInstructionGeneration) {</span>
  <span class="s4">auto </span><span class="s1">eventDispatcher = EventDispatcher::Shared{}</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">contextContainer = std::make_shared&lt;ContextContainer&gt;()</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">componentDescriptorParameters =</span>
      <span class="s1">ComponentDescriptorParameters{eventDispatcher</span><span class="s4">, </span><span class="s1">contextContainer</span><span class="s4">, nullptr</span><span class="s1">}</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">viewComponentDescriptor =</span>
      <span class="s1">ViewComponentDescriptor(componentDescriptorParameters)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootComponentDescriptor =</span>
      <span class="s1">RootComponentDescriptor(componentDescriptorParameters)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">rootFamily = rootComponentDescriptor.createFamily(</span>
      <span class="s1">{Tag(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">SurfaceId(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, nullptr</span><span class="s1">}</span><span class="s4">, nullptr</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Creating an initial root shadow node.</span>
  <span class="s4">auto </span><span class="s1">emptyRootNode = std::const_pointer_cast&lt;RootShadowNode&gt;(</span>
      <span class="s1">std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
          <span class="s1">rootComponentDescriptor.createShadowNode(</span>
              <span class="s1">ShadowNodeFragment{RootShadowNode::defaultSharedProps()}</span><span class="s4">,</span>
              <span class="s1">rootFamily)))</span><span class="s4">;</span>

  <span class="s1">PropsParserContext parserContext{-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">*contextContainer}</span><span class="s4">;</span>

  <span class="s0">// Applying size constraints.</span>
  <span class="s1">emptyRootNode = emptyRootNode-&gt;clone(</span>
      <span class="s1">parserContext</span><span class="s4">,</span>
      <span class="s1">LayoutConstraints{</span>
          <span class="s1">Size{</span><span class="s5">512</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">, </span><span class="s1">Size{</span><span class="s5">512</span><span class="s4">, </span><span class="s1">std::numeric_limits&lt;Float&gt;::infinity()}}</span><span class="s4">,</span>
      <span class="s1">LayoutContext{})</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">childA = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">100</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childB = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">101</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childC = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">102</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childD = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">103</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childE = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">104</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childF = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">105</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childG = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">106</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childH = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">107</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childI = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">108</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childJ = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">109</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childK = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">110</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">family = viewComponentDescriptor.createFamily(</span>
      <span class="s1">{</span><span class="s5">10</span><span class="s4">, </span><span class="s1">SurfaceId(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, nullptr</span><span class="s1">}</span><span class="s4">, nullptr</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Construct &quot;identical&quot; shadow nodes: they differ only in children.</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV1 = viewComponentDescriptor.createShadowNode(</span>
      <span class="s1">ShadowNodeFragment{</span>
          <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{childB</span><span class="s4">, </span><span class="s1">childC</span><span class="s4">, </span><span class="s1">childD})}</span><span class="s4">,</span>
      <span class="s1">family)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV2 = shadowNodeV1-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childA</span><span class="s4">, </span><span class="s1">childB</span><span class="s4">, </span><span class="s1">childC</span><span class="s4">, </span><span class="s1">childD})})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV3 = shadowNodeV2-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childB</span><span class="s4">, </span><span class="s1">childC</span><span class="s4">, </span><span class="s1">childD})})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV4 = shadowNodeV3-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childB</span><span class="s4">, </span><span class="s1">childD</span><span class="s4">, </span><span class="s1">childE})})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV5 = shadowNodeV4-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childB</span><span class="s4">, </span><span class="s1">childA</span><span class="s4">, </span><span class="s1">childE</span><span class="s4">, </span><span class="s1">childC})})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV6 = shadowNodeV5-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(ShadowNode::ListOfShared{</span>
          <span class="s1">childB</span><span class="s4">, </span><span class="s1">childA</span><span class="s4">, </span><span class="s1">childD</span><span class="s4">, </span><span class="s1">childF</span><span class="s4">, </span><span class="s1">childE</span><span class="s4">, </span><span class="s1">childC})})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV7 = shadowNodeV6-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(ShadowNode::ListOfShared{</span>
          <span class="s1">childF</span><span class="s4">,</span>
          <span class="s1">childE</span><span class="s4">,</span>
          <span class="s1">childC</span><span class="s4">,</span>
          <span class="s1">childD</span><span class="s4">,</span>
          <span class="s1">childG</span><span class="s4">,</span>
          <span class="s1">childH</span><span class="s4">,</span>
          <span class="s1">childI</span><span class="s4">,</span>
          <span class="s1">childJ</span><span class="s4">,</span>
          <span class="s1">childK})})</span><span class="s4">;</span>

  <span class="s0">// Injecting a tree into the root node.</span>
  <span class="s4">auto </span><span class="s1">rootNodeV1 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">emptyRootNode-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV1})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV2 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV1-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV2})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV3 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV2-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV3})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV4 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV3-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV4})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV5 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV4-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV5})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV6 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV5-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV6})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV7 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV6-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV7})}))</span><span class="s4">;</span>

  <span class="s0">// Layout</span>
  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV1{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV1.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV1)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV1)</span><span class="s4">;</span>
  <span class="s1">rootNodeV1-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV2{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV2.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV2)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV2)</span><span class="s4">;</span>
  <span class="s1">rootNodeV2-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV3{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV3.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV3)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV3)</span><span class="s4">;</span>
  <span class="s1">rootNodeV3-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV4{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV4.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV4)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV4)</span><span class="s4">;</span>
  <span class="s1">rootNodeV4-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV5{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV5.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV5)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV5)</span><span class="s4">;</span>
  <span class="s1">rootNodeV5-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV6{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV6.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV6)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV6)</span><span class="s4">;</span>
  <span class="s1">rootNodeV6-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s0">// This block displays all the mutations for debugging purposes.</span>
  <span class="s0">/* 
      LOG(ERROR) &lt;&lt; &quot;Num mutations: &quot; &lt;&lt; mutations.size(); 
      for (auto const &amp;mutation : mutations) { 
      switch (mutation.type) { 
        case ShadowViewMutation::Create: { 
          LOG(ERROR) &lt;&lt; &quot;CREATE &quot; &lt;&lt; mutation.newChildShadowView.tag; 
          break; 
        } 
        case ShadowViewMutation::Delete: { 
          LOG(ERROR) &lt;&lt; &quot;DELETE &quot; &lt;&lt; mutation.oldChildShadowView.tag; 
          break; 
        } 
        case ShadowViewMutation::Remove: { 
          LOG(ERROR) &lt;&lt; &quot;REMOVE &quot; &lt;&lt; mutation.oldChildShadowView.tag &lt;&lt; &quot; &quot; &lt;&lt; 
    mutation.index; break; 
        } 
        case ShadowViewMutation::Insert: { 
          LOG(ERROR) &lt;&lt; &quot;INSERT &quot; &lt;&lt; mutation.newChildShadowView.tag &lt;&lt; &quot; &quot; &lt;&lt; 
    mutation.index; break; 
        } 
        case ShadowViewMutation::Update: { 
          LOG(ERROR) &lt;&lt; &quot;UPDATE &quot; &lt;&lt; mutation.newChildShadowView.tag; 
          break; 
        } 
      } 
    }*/</span>

  <span class="s0">// Calculating mutations.</span>
  <span class="s4">auto </span><span class="s1">mutations1 = calculateShadowViewMutations(*rootNodeV1</span><span class="s4">, </span><span class="s1">*rootNodeV2)</span><span class="s4">;</span>

  <span class="s0">// The order and exact mutation instructions here may change at any time.</span>
  <span class="s0">// This test just ensures that any changes are intentional.</span>
  <span class="s0">// This test, in particular, ensures that inserting a node at the beginning</span>
  <span class="s0">// produces a single &quot;Insert&quot; instruction, and no remove/insert (move)</span>
  <span class="s0">// operations. All these nodes are laid out with absolute positioning, so</span>
  <span class="s0">// moving them around does not change layout.</span>
  <span class="s1">EXPECT_TRUE(mutations1.size() == </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations1[</span><span class="s5">0</span><span class="s1">].type == ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations1[</span><span class="s5">0</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">100</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations1[</span><span class="s5">1</span><span class="s1">].type == ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations1[</span><span class="s5">1</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">100</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations1[</span><span class="s5">1</span><span class="s1">].index == </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Calculating mutations.</span>
  <span class="s4">auto </span><span class="s1">mutations2 = calculateShadowViewMutations(*rootNodeV2</span><span class="s4">, </span><span class="s1">*rootNodeV3)</span><span class="s4">;</span>

  <span class="s0">// The order and exact mutation instructions here may change at any time.</span>
  <span class="s0">// This test just ensures that any changes are intentional.</span>
  <span class="s0">// This test, in particular, ensures that removing a node at the beginning</span>
  <span class="s0">// produces a single remove (and delete) instruction, and no remove/insert</span>
  <span class="s0">// (move) operations. All these nodes are laid out with absolute positioning,</span>
  <span class="s0">// so moving them around does not change layout.</span>
  <span class="s1">EXPECT_TRUE(mutations2.size() == </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations2[</span><span class="s5">0</span><span class="s1">].type == ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations2[</span><span class="s5">0</span><span class="s1">].oldChildShadowView.tag == </span><span class="s5">100</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations2[</span><span class="s5">0</span><span class="s1">].index == </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations2[</span><span class="s5">1</span><span class="s1">].type == ShadowViewMutation::Delete)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations2[</span><span class="s5">1</span><span class="s1">].oldChildShadowView.tag == </span><span class="s5">100</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Calculating mutations.</span>
  <span class="s4">auto </span><span class="s1">mutations3 = calculateShadowViewMutations(*rootNodeV3</span><span class="s4">, </span><span class="s1">*rootNodeV4)</span><span class="s4">;</span>
  <span class="s1">LOG(ERROR) &lt;&lt; </span><span class="s3">&quot;Num mutations IN OLD TEST mutations3: &quot; </span><span class="s1">&lt;&lt; mutations3.size()</span><span class="s4">;</span>

  <span class="s0">// The order and exact mutation instructions here may change at any time.</span>
  <span class="s0">// This test just ensures that any changes are intentional.</span>
  <span class="s0">// This test, in particular, ensures that removing a node in the middle</span>
  <span class="s0">// produces a single remove (and delete) instruction, and no remove/insert</span>
  <span class="s0">// (move) operations; and that simultaneously, we can insert a node at the</span>
  <span class="s0">// end.</span>
  <span class="s1">EXPECT_TRUE(mutations3.size() == </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">0</span><span class="s1">].type == ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">0</span><span class="s1">].oldChildShadowView.tag == </span><span class="s5">102</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">0</span><span class="s1">].index == </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">1</span><span class="s1">].type == ShadowViewMutation::Delete)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">1</span><span class="s1">].oldChildShadowView.tag == </span><span class="s5">102</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">2</span><span class="s1">].type == ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">2</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">104</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">3</span><span class="s1">].type == ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">3</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">104</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations3[</span><span class="s5">3</span><span class="s1">].index == </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Calculating mutations.</span>
  <span class="s4">auto </span><span class="s1">mutations4 = calculateShadowViewMutations(*rootNodeV4</span><span class="s4">, </span><span class="s1">*rootNodeV5)</span><span class="s4">;</span>

  <span class="s0">// The order and exact mutation instructions here may change at any time.</span>
  <span class="s0">// This test just ensures that any changes are intentional.</span>
  <span class="s0">// This test, in particular, ensures that inserting a child at the middle, and</span>
  <span class="s0">// at the end, and removing a node in the middle, produces the minimal set of</span>
  <span class="s0">// instructions. All these nodes are laid out with absolute positioning, so</span>
  <span class="s0">// moving them around does not change layout.</span>
  <span class="s1">EXPECT_TRUE(mutations4.size() == </span><span class="s5">6</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">0</span><span class="s1">].type == ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">0</span><span class="s1">].oldChildShadowView.tag == </span><span class="s5">103</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">0</span><span class="s1">].index == </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">1</span><span class="s1">].type == ShadowViewMutation::Delete)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">1</span><span class="s1">].oldChildShadowView.tag == </span><span class="s5">103</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">2</span><span class="s1">].type == ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">2</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">100</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">3</span><span class="s1">].type == ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">3</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">102</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">4</span><span class="s1">].type == ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">4</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">100</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">4</span><span class="s1">].index == </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">5</span><span class="s1">].type == ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">5</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">102</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations4[</span><span class="s5">5</span><span class="s1">].index == </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">mutations5 = calculateShadowViewMutations(*rootNodeV5</span><span class="s4">, </span><span class="s1">*rootNodeV6)</span><span class="s4">;</span>

  <span class="s0">// The order and exact mutation instructions here may change at any time.</span>
  <span class="s0">// This test just ensures that any changes are intentional.</span>
  <span class="s0">// This test, in particular, ensures that inserting TWO children in the middle</span>
  <span class="s0">// produces the minimal set of instructions. All these nodes are laid out with</span>
  <span class="s0">// absolute positioning, so moving them around does not change layout.</span>
  <span class="s1">EXPECT_TRUE(mutations5.size() == </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">0</span><span class="s1">].type == ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">0</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">103</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">1</span><span class="s1">].type == ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">1</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">105</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">2</span><span class="s1">].type == ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">2</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">103</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">2</span><span class="s1">].index == </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">3</span><span class="s1">].type == ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">3</span><span class="s1">].newChildShadowView.tag == </span><span class="s5">105</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(mutations5[</span><span class="s5">3</span><span class="s1">].index == </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">mutations6 = calculateShadowViewMutations(*rootNodeV6</span><span class="s4">, </span><span class="s1">*rootNodeV7)</span><span class="s4">;</span>

  <span class="s0">// The order and exact mutation instructions here may change at any time.</span>
  <span class="s0">// This test just ensures that any changes are intentional.</span>
  <span class="s0">// This test, in particular, ensures that a bug has been fixed: that with</span>
  <span class="s0">// a particular sequence of inserts/removes/moves, we don't unintentionally</span>
  <span class="s0">// create more &quot;CREATE&quot; mutations than necessary.</span>
  <span class="s0">// The actual nodes that should be created in this transaction have a tag &gt;</span>
  <span class="s0">// 105.</span>
  <span class="s1">EXPECT_TRUE(mutations6.size() == </span><span class="s5">25</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s4">auto </span><span class="s1">&amp;i : mutations6) {</span>
    <span class="s4">if </span><span class="s1">(i.type == ShadowViewMutation::Create) {</span>
      <span class="s1">EXPECT_TRUE(i.newChildShadowView.tag &gt; </span><span class="s5">105</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">/** 
 * Test reparenting mutation instruction generation. 
 * We cannot practically handle all possible use-cases here. 
 * It would be helpful to do verification with randomized trees, but it's 
 * much easier to do that in JS. 
 */</span>
<span class="s1">TEST(MountingTest</span><span class="s4">, </span><span class="s1">testViewReparentingInstructionGeneration) {</span>
  <span class="s4">auto </span><span class="s1">eventDispatcher = EventDispatcher::Shared{}</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">contextContainer = std::make_shared&lt;ContextContainer&gt;()</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">componentDescriptorParameters =</span>
      <span class="s1">ComponentDescriptorParameters{eventDispatcher</span><span class="s4">, </span><span class="s1">contextContainer</span><span class="s4">, nullptr</span><span class="s1">}</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">viewComponentDescriptor =</span>
      <span class="s1">ViewComponentDescriptor(componentDescriptorParameters)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootComponentDescriptor =</span>
      <span class="s1">RootComponentDescriptor(componentDescriptorParameters)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">rootFamily = rootComponentDescriptor.createFamily(</span>
      <span class="s1">{Tag(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">SurfaceId(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, nullptr</span><span class="s1">}</span><span class="s4">, nullptr</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Creating an initial root shadow node.</span>
  <span class="s4">auto </span><span class="s1">emptyRootNode = std::const_pointer_cast&lt;RootShadowNode&gt;(</span>
      <span class="s1">std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
          <span class="s1">rootComponentDescriptor.createShadowNode(</span>
              <span class="s1">ShadowNodeFragment{RootShadowNode::defaultSharedProps()}</span><span class="s4">,</span>
              <span class="s1">rootFamily)))</span><span class="s4">;</span>

  <span class="s1">PropsParserContext parserContext{-</span><span class="s5">1</span><span class="s4">, </span><span class="s1">*contextContainer}</span><span class="s4">;</span>

  <span class="s0">// Applying size constraints.</span>
  <span class="s1">emptyRootNode = emptyRootNode-&gt;clone(</span>
      <span class="s1">parserContext</span><span class="s4">,</span>
      <span class="s1">LayoutConstraints{</span>
          <span class="s1">Size{</span><span class="s5">512</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">, </span><span class="s1">Size{</span><span class="s5">512</span><span class="s4">, </span><span class="s1">std::numeric_limits&lt;Float&gt;::infinity()}}</span><span class="s4">,</span>
      <span class="s1">LayoutContext{})</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">childA = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">100</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childB = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">101</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childC = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">102</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childD = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">103</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childE = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">104</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childF = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">105</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">childG = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">106</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childH = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">107</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childI = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">108</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childJ = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">109</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">childK = makeNode(viewComponentDescriptor</span><span class="s4">, </span><span class="s5">110</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">family = viewComponentDescriptor.createFamily(</span>
      <span class="s1">{</span><span class="s5">10</span><span class="s4">, </span><span class="s1">SurfaceId(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, nullptr</span><span class="s1">}</span><span class="s4">, nullptr</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">reparentedViewA = makeNode(</span>
      <span class="s1">viewComponentDescriptor</span><span class="s4">,</span>
      <span class="s5">1000</span><span class="s4">,</span>
      <span class="s1">ShadowNode::ListOfShared{</span>
          <span class="s1">childC-&gt;clone({})</span><span class="s4">, </span><span class="s1">childA-&gt;clone({})</span><span class="s4">, </span><span class="s1">childB-&gt;clone({})})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">reparentedViewB = makeNode(</span>
      <span class="s1">viewComponentDescriptor</span><span class="s4">,</span>
      <span class="s5">2000</span><span class="s4">,</span>
      <span class="s1">ShadowNode::ListOfShared{</span>
          <span class="s1">childF-&gt;clone({})</span><span class="s4">, </span><span class="s1">childE-&gt;clone({})</span><span class="s4">, </span><span class="s1">childD-&gt;clone({})})</span><span class="s4">;</span>

  <span class="s0">// Root -&gt; G* -&gt; H -&gt; I -&gt; J -&gt; A* [nodes with * are _not_ flattened]</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV1 = viewComponentDescriptor.createShadowNode(</span>
      <span class="s1">ShadowNodeFragment{</span>
          <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{childG-&gt;clone(ShadowNodeFragment{</span>
                  <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                  <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                      <span class="s1">ShadowNode::ListOfShared{childH-&gt;clone(ShadowNodeFragment{</span>
                          <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                              <span class="s1">ShadowNode::ListOfShared{</span>
                                  <span class="s1">childI-&gt;clone(ShadowNodeFragment{</span>
                                      <span class="s1">generateDefaultProps(</span>
                                          <span class="s1">viewComponentDescriptor)</span><span class="s4">,</span>
                                      <span class="s1">std::make_shared&lt;</span>
                                          <span class="s1">ShadowNode::ListOfShared&gt;(</span>
                                          <span class="s1">ShadowNode::ListOfShared{</span>
                                              <span class="s1">childJ-&gt;clone(ShadowNodeFragment{</span>
                                                  <span class="s1">generateDefaultProps(</span>
                                                      <span class="s1">viewComponentDescriptor)</span><span class="s4">,</span>
                                                  <span class="s1">std::make_shared&lt;</span>
                                                      <span class="s1">ShadowNode::ListOfShared&gt;(</span>
                                                      <span class="s1">ShadowNode::ListOfShared{</span>
                                                          <span class="s1">reparentedViewA-&gt;clone(</span>
                                                              <span class="s1">{})})})})})})})})})})}</span><span class="s4">,</span>
      <span class="s1">family)</span><span class="s4">;</span>

  <span class="s0">// Root -&gt; G* -&gt; H* -&gt; I -&gt; J -&gt; A* [nodes with * are _not_ flattened]</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV2 = shadowNodeV1-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childG-&gt;clone(ShadowNodeFragment{</span>
              <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                  <span class="s1">ShadowNode::ListOfShared{childH-&gt;clone(ShadowNodeFragment{</span>
                      <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                      <span class="s1">std::make_shared&lt;</span>
                          <span class="s1">ShadowNode::ListOfShared&gt;(ShadowNode::ListOfShared{</span>
                          <span class="s1">childI-&gt;clone(ShadowNodeFragment{</span>
                              <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                                  <span class="s1">ShadowNode::ListOfShared{</span>
                                      <span class="s1">childJ-&gt;clone(ShadowNodeFragment{</span>
                                          <span class="s1">generateDefaultProps(</span>
                                              <span class="s1">viewComponentDescriptor)</span><span class="s4">,</span>
                                          <span class="s1">std::make_shared&lt;</span>
                                              <span class="s1">ShadowNode::ListOfShared&gt;(</span>
                                              <span class="s1">ShadowNode::ListOfShared{</span>
                                                  <span class="s1">reparentedViewA-&gt;clone(</span>
                                                      <span class="s1">{})})})})})})})})})})})</span><span class="s4">;</span>

  <span class="s0">// Root -&gt; G* -&gt; H -&gt; I -&gt; J -&gt; A* [nodes with * are _not_ flattened]</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV3 = shadowNodeV2-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childG-&gt;clone(ShadowNodeFragment{</span>
              <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                  <span class="s1">ShadowNode::ListOfShared{childH-&gt;clone(ShadowNodeFragment{</span>
                      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                      <span class="s1">std::make_shared&lt;</span>
                          <span class="s1">ShadowNode::ListOfShared&gt;(ShadowNode::ListOfShared{</span>
                          <span class="s1">childI-&gt;clone(ShadowNodeFragment{</span>
                              <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                                  <span class="s1">ShadowNode::ListOfShared{</span>
                                      <span class="s1">childJ-&gt;clone(ShadowNodeFragment{</span>
                                          <span class="s1">generateDefaultProps(</span>
                                              <span class="s1">viewComponentDescriptor)</span><span class="s4">,</span>
                                          <span class="s1">std::make_shared&lt;</span>
                                              <span class="s1">ShadowNode::ListOfShared&gt;(</span>
                                              <span class="s1">ShadowNode::ListOfShared{</span>
                                                  <span class="s1">reparentedViewA-&gt;clone(</span>
                                                      <span class="s1">{})})})})})})})})})})})</span><span class="s4">;</span>

  <span class="s0">// The view is reparented 1 level down with a different sibling</span>
  <span class="s0">// Root -&gt; G* -&gt; H* -&gt; I* -&gt; J -&gt; [B*, A*] [nodes with * are _not_ flattened]</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV4 = shadowNodeV3-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childG-&gt;clone(ShadowNodeFragment{</span>
              <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                  <span class="s1">ShadowNode::ListOfShared{childH-&gt;clone(ShadowNodeFragment{</span>
                      <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                      <span class="s1">std::make_shared&lt;</span>
                          <span class="s1">ShadowNode::ListOfShared&gt;(ShadowNode::ListOfShared{</span>
                          <span class="s1">childI-&gt;clone(ShadowNodeFragment{</span>
                              <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                                  <span class="s1">ShadowNode::ListOfShared{</span>
                                      <span class="s1">childJ-&gt;clone(ShadowNodeFragment{</span>
                                          <span class="s1">generateDefaultProps(</span>
                                              <span class="s1">viewComponentDescriptor)</span><span class="s4">,</span>
                                          <span class="s1">std::make_shared&lt;</span>
                                              <span class="s1">ShadowNode::ListOfShared&gt;(</span>
                                              <span class="s1">ShadowNode::ListOfShared{</span>
                                                  <span class="s1">reparentedViewB-&gt;clone({})</span><span class="s4">,</span>
                                                  <span class="s1">reparentedViewA-&gt;clone(</span>
                                                      <span class="s1">{})})})})})})})})})})})</span><span class="s4">;</span>

  <span class="s0">// The view is reparented 1 level further down with its order with the sibling</span>
  <span class="s0">// swapped</span>
  <span class="s0">// Root -&gt; G* -&gt; H* -&gt; I* -&gt; J* -&gt; [A*, B*] [nodes with * are _not_ flattened]</span>
  <span class="s4">auto </span><span class="s1">shadowNodeV5 = shadowNodeV4-&gt;clone(ShadowNodeFragment{</span>
      <span class="s1">generateDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
      <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
          <span class="s1">ShadowNode::ListOfShared{childG-&gt;clone(ShadowNodeFragment{</span>
              <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                  <span class="s1">ShadowNode::ListOfShared{childH-&gt;clone(ShadowNodeFragment{</span>
                      <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                      <span class="s1">std::make_shared&lt;</span>
                          <span class="s1">ShadowNode::ListOfShared&gt;(ShadowNode::ListOfShared{</span>
                          <span class="s1">childI-&gt;clone(ShadowNodeFragment{</span>
                              <span class="s1">nonFlattenedDefaultProps(viewComponentDescriptor)</span><span class="s4">,</span>
                              <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
                                  <span class="s1">ShadowNode::ListOfShared{</span>
                                      <span class="s1">childJ-&gt;clone(ShadowNodeFragment{</span>
                                          <span class="s1">nonFlattenedDefaultProps(</span>
                                              <span class="s1">viewComponentDescriptor)</span><span class="s4">,</span>
                                          <span class="s1">std::make_shared&lt;</span>
                                              <span class="s1">ShadowNode::ListOfShared&gt;(</span>
                                              <span class="s1">ShadowNode::ListOfShared{</span>
                                                  <span class="s1">reparentedViewA-&gt;clone({})</span><span class="s4">,</span>
                                                  <span class="s1">reparentedViewB-&gt;clone(</span>
                                                      <span class="s1">{})})})})})})})})})})})</span><span class="s4">;</span>

  <span class="s0">// Injecting a tree into the root node.</span>
  <span class="s4">auto </span><span class="s1">rootNodeV1 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">emptyRootNode-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV1})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV2 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV1-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV2})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV3 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV2-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV3})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV4 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV3-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV4})}))</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">rootNodeV5 = std::static_pointer_cast&lt;RootShadowNode </span><span class="s4">const</span><span class="s1">&gt;(</span>
      <span class="s1">rootNodeV4-&gt;ShadowNode::clone(ShadowNodeFragment{</span>
          <span class="s1">ShadowNodeFragment::propsPlaceholder()</span><span class="s4">,</span>
          <span class="s1">std::make_shared&lt;ShadowNode::ListOfShared&gt;(</span>
              <span class="s1">ShadowNode::ListOfShared{shadowNodeV5})}))</span><span class="s4">;</span>

  <span class="s0">// Layout</span>
  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV1{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV1.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV1)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV1)</span><span class="s4">;</span>
  <span class="s1">rootNodeV1-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV2{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV2.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV2)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV2)</span><span class="s4">;</span>
  <span class="s1">rootNodeV2-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV3{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV3.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV3)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV3)</span><span class="s4">;</span>
  <span class="s1">rootNodeV3-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV4{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV4.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV4)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV4)</span><span class="s4">;</span>
  <span class="s1">rootNodeV4-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s1">std::vector&lt;LayoutableShadowNode </span><span class="s4">const </span><span class="s1">*&gt; affectedLayoutableNodesV5{}</span><span class="s4">;</span>
  <span class="s1">affectedLayoutableNodesV5.reserve(</span><span class="s5">1024</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::const_pointer_cast&lt;RootShadowNode&gt;(rootNodeV5)</span>
      <span class="s1">-&gt;layoutIfNeeded(&amp;affectedLayoutableNodesV5)</span><span class="s4">;</span>
  <span class="s1">rootNodeV5-&gt;sealRecursive()</span><span class="s4">;</span>

  <span class="s0">// Calculating mutations.</span>
  <span class="s4">auto </span><span class="s1">mutations1 = calculateShadowViewMutations(*rootNodeV1</span><span class="s4">, </span><span class="s1">*rootNodeV2)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(mutations1.size()</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">0</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Update)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">0</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">106</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">1</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">1</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">2</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">2</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">107</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">3</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">3</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">107</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">4</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations1[</span><span class="s5">4</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">mutations2 = calculateShadowViewMutations(*rootNodeV2</span><span class="s4">, </span><span class="s1">*rootNodeV3)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(mutations2.size()</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">0</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Update)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">0</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">106</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">1</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">1</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">2</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">2</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">107</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s1">mutations2[</span><span class="s5">3</span><span class="s1">].type</span><span class="s4">,</span>
      <span class="s1">ShadowViewMutation::Delete)</span><span class="s4">; </span><span class="s0">// correct, 107 is removed from tree entirely</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">3</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">107</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">4</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations2[</span><span class="s5">4</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">mutations3 = calculateShadowViewMutations(*rootNodeV3</span><span class="s4">, </span><span class="s1">*rootNodeV4)</span><span class="s4">;</span>

  <span class="s0">// between these two trees, lots of new nodes are created and inserted - this</span>
  <span class="s0">// is all correct, and this is the minimal amount of mutations</span>

  <span class="s1">EXPECT_EQ(mutations3.size()</span><span class="s4">, </span><span class="s5">15</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">0</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Update)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">0</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">106</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">1</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">1</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">2</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">2</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">107</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">3</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">3</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">2000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">4</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">4</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">108</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">5</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">5</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">105</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">6</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">6</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">104</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">7</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">7</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">103</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">8</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">8</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">105</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">9</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">9</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">104</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">10</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">10</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">103</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">11</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">11</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">107</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">12</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">12</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">108</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">13</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">13</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">2000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">14</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations3[</span><span class="s5">14</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">mutations4 = calculateShadowViewMutations(*rootNodeV4</span><span class="s4">, </span><span class="s1">*rootNodeV5)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(mutations4.size()</span><span class="s4">, </span><span class="s5">9</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">0</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Update)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">0</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">106</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">1</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Update)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">1</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">107</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">2</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Update)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">2</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">108</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">3</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">3</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">4</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Remove)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">4</span><span class="s1">].oldChildShadowView.tag</span><span class="s4">, </span><span class="s5">2000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">5</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Create)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">5</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">109</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">6</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">6</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">109</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">7</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">7</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">1000</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">8</span><span class="s1">].type</span><span class="s4">, </span><span class="s1">ShadowViewMutation::Insert)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(mutations4[</span><span class="s5">8</span><span class="s1">].newChildShadowView.tag</span><span class="s4">, </span><span class="s5">2000</span><span class="s1">)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">} </span><span class="s0">// namespace facebook::react</span>
</pre>
</body>
</html>