<html>
<head>
<title>OrderedObjParser.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6a8759;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #4646f1;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
OrderedObjParser.js</font>
</center></td></tr></table>
<pre><span class="s0">'use strict'</span><span class="s1">;</span>
<span class="s2">///@ts-check</span>

<span class="s1">const util = require(</span><span class="s0">'../util'</span><span class="s1">);</span>
<span class="s1">const xmlNode = require(</span><span class="s0">'./xmlNode'</span><span class="s1">);</span>
<span class="s1">const readDocType = require(</span><span class="s0">&quot;./DocTypeReader&quot;</span><span class="s1">);</span>
<span class="s1">const toNumber = require(</span><span class="s0">&quot;strnum&quot;</span><span class="s1">);</span>

<span class="s1">const regx =</span>
  <span class="s0">'&lt;((!</span><span class="s3">\\</span><span class="s0">[CDATA</span><span class="s3">\\</span><span class="s0">[([</span><span class="s3">\\</span><span class="s0">s</span><span class="s3">\\</span><span class="s0">S]*?)(]]&gt;))|((NAME:)?(NAME))([^&gt;]*)&gt;|((</span><span class="s3">\\</span><span class="s0">/)(NAME)</span><span class="s3">\\</span><span class="s0">s*&gt;))([^&lt;]*)'</span>
  <span class="s1">.replace(/NAME/g, util.nameRegexp);</span>

<span class="s2">//const tagsRegx = new RegExp(&quot;&lt;(\\/?[\\w:\\-\._]+)([^&gt;]*)&gt;(\\s*&quot;+cdataRegx+&quot;)*([^&lt;]+)?&quot;,&quot;g&quot;);</span>
<span class="s2">//const tagsRegx = new RegExp(&quot;&lt;(\\/?)((\\w*:)?([\\w:\\-\._]+))([^&gt;]*)&gt;([^&lt;]*)(&quot;+cdataRegx+&quot;([^&lt;]*))*([^&lt;]+)?&quot;,&quot;g&quot;);</span>

<span class="s1">class OrderedObjParser{</span>
  <span class="s1">constructor(options){</span>
    <span class="s4">this</span><span class="s1">.options = options;</span>
    <span class="s4">this</span><span class="s1">.currentNode = </span><span class="s4">null</span><span class="s1">;</span>
    <span class="s4">this</span><span class="s1">.tagsNodeStack = [];</span>
    <span class="s4">this</span><span class="s1">.docTypeEntities = {};</span>
    <span class="s4">this</span><span class="s1">.lastEntities = {</span>
      <span class="s0">&quot;apos&quot; </span><span class="s1">: { regex: /&amp;(apos|#</span><span class="s5">39</span><span class="s1">|#x27);/g, val : </span><span class="s0">&quot;'&quot;</span><span class="s1">},</span>
      <span class="s0">&quot;gt&quot; </span><span class="s1">: { regex: /&amp;(gt|#</span><span class="s5">62</span><span class="s1">|#x3E);/g, val : </span><span class="s0">&quot;&gt;&quot;</span><span class="s1">},</span>
      <span class="s0">&quot;lt&quot; </span><span class="s1">: { regex: /&amp;(lt|#</span><span class="s5">60</span><span class="s1">|#x3C);/g, val : </span><span class="s0">&quot;&lt;&quot;</span><span class="s1">},</span>
      <span class="s0">&quot;quot&quot; </span><span class="s1">: { regex: /&amp;(quot|#</span><span class="s5">34</span><span class="s1">|#x22);/g, val : </span><span class="s0">&quot;</span><span class="s3">\&quot;</span><span class="s0">&quot;</span><span class="s1">},</span>
    <span class="s1">};</span>
    <span class="s4">this</span><span class="s1">.ampEntity = { regex: /&amp;(amp|#</span><span class="s5">38</span><span class="s1">|#x26);/g, val : </span><span class="s0">&quot;&amp;&quot;</span><span class="s1">};</span>
    <span class="s4">this</span><span class="s1">.htmlEntities = {</span>
      <span class="s0">&quot;space&quot;</span><span class="s1">: { regex: /&amp;(nbsp|#</span><span class="s5">160</span><span class="s1">);/g, val: </span><span class="s0">&quot; &quot; </span><span class="s1">},</span>
      <span class="s2">// &quot;lt&quot; : { regex: /&amp;(lt|#60);/g, val: &quot;&lt;&quot; },</span>
      <span class="s2">// &quot;gt&quot; : { regex: /&amp;(gt|#62);/g, val: &quot;&gt;&quot; },</span>
      <span class="s2">// &quot;amp&quot; : { regex: /&amp;(amp|#38);/g, val: &quot;&amp;&quot; },</span>
      <span class="s2">// &quot;quot&quot; : { regex: /&amp;(quot|#34);/g, val: &quot;\&quot;&quot; },</span>
      <span class="s2">// &quot;apos&quot; : { regex: /&amp;(apos|#39);/g, val: &quot;'&quot; },</span>
      <span class="s0">&quot;cent&quot; </span><span class="s1">: { regex: /&amp;(cent|#</span><span class="s5">162</span><span class="s1">);/g, val: </span><span class="s0">&quot;¢&quot; </span><span class="s1">},</span>
      <span class="s0">&quot;pound&quot; </span><span class="s1">: { regex: /&amp;(pound|#</span><span class="s5">163</span><span class="s1">);/g, val: </span><span class="s0">&quot;£&quot; </span><span class="s1">},</span>
      <span class="s0">&quot;yen&quot; </span><span class="s1">: { regex: /&amp;(yen|#</span><span class="s5">165</span><span class="s1">);/g, val: </span><span class="s0">&quot;¥&quot; </span><span class="s1">},</span>
      <span class="s0">&quot;euro&quot; </span><span class="s1">: { regex: /&amp;(euro|#</span><span class="s5">8364</span><span class="s1">);/g, val: </span><span class="s0">&quot;€&quot; </span><span class="s1">},</span>
      <span class="s0">&quot;copyright&quot; </span><span class="s1">: { regex: /&amp;(copy|#</span><span class="s5">169</span><span class="s1">);/g, val: </span><span class="s0">&quot;©&quot; </span><span class="s1">},</span>
      <span class="s0">&quot;reg&quot; </span><span class="s1">: { regex: /&amp;(reg|#</span><span class="s5">174</span><span class="s1">);/g, val: </span><span class="s0">&quot;®&quot; </span><span class="s1">},</span>
      <span class="s0">&quot;inr&quot; </span><span class="s1">: { regex: /&amp;(inr|#</span><span class="s5">8377</span><span class="s1">);/g, val: </span><span class="s0">&quot;₹&quot; </span><span class="s1">},</span>
    <span class="s1">};</span>
    <span class="s4">this</span><span class="s1">.addExternalEntities = addExternalEntities;</span>
    <span class="s4">this</span><span class="s1">.parseXml = parseXml;</span>
    <span class="s4">this</span><span class="s1">.parseTextData = parseTextData;</span>
    <span class="s4">this</span><span class="s1">.resolveNameSpace = resolveNameSpace;</span>
    <span class="s4">this</span><span class="s1">.buildAttributesMap = buildAttributesMap;</span>
    <span class="s4">this</span><span class="s1">.isItStopNode = isItStopNode;</span>
    <span class="s4">this</span><span class="s1">.replaceEntitiesValue = replaceEntitiesValue;</span>
    <span class="s4">this</span><span class="s1">.readStopNodeData = readStopNodeData;</span>
    <span class="s4">this</span><span class="s1">.saveTextToParentTag = saveTextToParentTag;</span>
    <span class="s4">this</span><span class="s1">.addChild = addChild;</span>
  <span class="s1">}</span>

<span class="s1">}</span>

<span class="s4">function </span><span class="s1">addExternalEntities(externalEntities){</span>
  <span class="s1">const entKeys = Object.keys(externalEntities);</span>
  <span class="s4">for </span><span class="s1">(let i = </span><span class="s5">0</span><span class="s1">; i &lt; entKeys.length; i++) {</span>
    <span class="s1">const ent = entKeys[i];</span>
    <span class="s4">this</span><span class="s1">.lastEntities[ent] = {</span>
       <span class="s1">regex: </span><span class="s4">new </span><span class="s1">RegExp(</span><span class="s0">&quot;&amp;&quot;</span><span class="s1">+ent+</span><span class="s0">&quot;;&quot;</span><span class="s1">,</span><span class="s0">&quot;g&quot;</span><span class="s1">),</span>
       <span class="s1">val : externalEntities[ent]</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">/** 
 * @param {string} val 
 * @param {string} tagName 
 * @param {string} jPath 
 * @param {boolean} dontTrim 
 * @param {boolean} hasAttributes 
 * @param {boolean} isLeafNode 
 * @param {boolean} escapeEntities 
 */</span>
<span class="s4">function </span><span class="s1">parseTextData(val, tagName, jPath, dontTrim, hasAttributes, isLeafNode, escapeEntities) {</span>
  <span class="s4">if </span><span class="s1">(val !== undefined) {</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.trimValues &amp;&amp; !dontTrim) {</span>
      <span class="s1">val = val.trim();</span>
    <span class="s1">}</span>
    <span class="s4">if</span><span class="s1">(val.length &gt; </span><span class="s5">0</span><span class="s1">){</span>
      <span class="s4">if</span><span class="s1">(!escapeEntities) val = </span><span class="s4">this</span><span class="s1">.replaceEntitiesValue(val);</span>
      
      <span class="s1">const newval = </span><span class="s4">this</span><span class="s1">.options.tagValueProcessor(tagName, val, jPath, hasAttributes, isLeafNode);</span>
      <span class="s4">if</span><span class="s1">(newval === </span><span class="s4">null </span><span class="s1">|| newval === undefined){</span>
        <span class="s2">//don't parse</span>
        <span class="s4">return </span><span class="s1">val;</span>
      <span class="s1">}</span><span class="s4">else if</span><span class="s1">(</span><span class="s4">typeof </span><span class="s1">newval !== </span><span class="s4">typeof </span><span class="s1">val || newval !== val){</span>
        <span class="s2">//overwrite</span>
        <span class="s4">return </span><span class="s1">newval;</span>
      <span class="s1">}</span><span class="s4">else if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.trimValues){</span>
        <span class="s4">return </span><span class="s1">parseValue(val, </span><span class="s4">this</span><span class="s1">.options.parseTagValue, </span><span class="s4">this</span><span class="s1">.options.numberParseOptions);</span>
      <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
        <span class="s1">const trimmedVal = val.trim();</span>
        <span class="s4">if</span><span class="s1">(trimmedVal === val){</span>
          <span class="s4">return </span><span class="s1">parseValue(val, </span><span class="s4">this</span><span class="s1">.options.parseTagValue, </span><span class="s4">this</span><span class="s1">.options.numberParseOptions);</span>
        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
          <span class="s4">return </span><span class="s1">val;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">function </span><span class="s1">resolveNameSpace(tagname) {</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.removeNSPrefix) {</span>
    <span class="s1">const tags = tagname.split(</span><span class="s0">':'</span><span class="s1">);</span>
    <span class="s1">const prefix = tagname.charAt(</span><span class="s5">0</span><span class="s1">) === </span><span class="s0">'/' </span><span class="s1">? </span><span class="s0">'/' </span><span class="s1">: </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s4">if </span><span class="s1">(tags[</span><span class="s5">0</span><span class="s1">] === </span><span class="s0">'xmlns'</span><span class="s1">) {</span>
      <span class="s4">return </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(tags.length === </span><span class="s5">2</span><span class="s1">) {</span>
      <span class="s1">tagname = prefix + tags[</span><span class="s5">1</span><span class="s1">];</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">tagname;</span>
<span class="s1">}</span>

<span class="s2">//TODO: change regex to capture NS</span>
<span class="s2">//const attrsRegx = new RegExp(&quot;([\\w\\-\\.\\:]+)\\s*=\\s*(['\&quot;])((.|\n)*?)\\2&quot;,&quot;gm&quot;);</span>
<span class="s1">const attrsRegx = </span><span class="s4">new </span><span class="s1">RegExp(</span><span class="s0">'([^</span><span class="s3">\\</span><span class="s0">s=]+)</span><span class="s3">\\</span><span class="s0">s*(=</span><span class="s3">\\</span><span class="s0">s*([</span><span class="s3">\'</span><span class="s0">&quot;])([</span><span class="s3">\\</span><span class="s0">s</span><span class="s3">\\</span><span class="s0">S]*?)</span><span class="s3">\\</span><span class="s0">3)?'</span><span class="s1">, </span><span class="s0">'gm'</span><span class="s1">);</span>

<span class="s4">function </span><span class="s1">buildAttributesMap(attrStr, jPath, tagName) {</span>
  <span class="s4">if </span><span class="s1">(!</span><span class="s4">this</span><span class="s1">.options.ignoreAttributes &amp;&amp; </span><span class="s4">typeof </span><span class="s1">attrStr === </span><span class="s0">'string'</span><span class="s1">) {</span>
    <span class="s2">// attrStr = attrStr.replace(/\r?\n/g, ' ');</span>
    <span class="s2">//attrStr = attrStr || attrStr.trim();</span>

    <span class="s1">const matches = util.getAllMatches(attrStr, attrsRegx);</span>
    <span class="s1">const len = matches.length; </span><span class="s2">//don't make it inline</span>
    <span class="s1">const attrs = {};</span>
    <span class="s4">for </span><span class="s1">(let i = </span><span class="s5">0</span><span class="s1">; i &lt; len; i++) {</span>
      <span class="s1">const attrName = </span><span class="s4">this</span><span class="s1">.resolveNameSpace(matches[i][</span><span class="s5">1</span><span class="s1">]);</span>
      <span class="s1">let oldVal = matches[i][</span><span class="s5">4</span><span class="s1">];</span>
      <span class="s1">let aName = </span><span class="s4">this</span><span class="s1">.options.attributeNamePrefix + attrName;</span>
      <span class="s4">if </span><span class="s1">(attrName.length) {</span>
        <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.transformAttributeName) {</span>
          <span class="s1">aName = </span><span class="s4">this</span><span class="s1">.options.transformAttributeName(aName);</span>
        <span class="s1">}</span>
        <span class="s4">if</span><span class="s1">(aName === </span><span class="s0">&quot;__proto__&quot;</span><span class="s1">) aName  = </span><span class="s0">&quot;#__proto__&quot;</span><span class="s1">;</span>
        <span class="s4">if </span><span class="s1">(oldVal !== undefined) {</span>
          <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.trimValues) {</span>
            <span class="s1">oldVal = oldVal.trim();</span>
          <span class="s1">}</span>
          <span class="s1">oldVal = </span><span class="s4">this</span><span class="s1">.replaceEntitiesValue(oldVal);</span>
          <span class="s1">const newVal = </span><span class="s4">this</span><span class="s1">.options.attributeValueProcessor(attrName, oldVal, jPath);</span>
          <span class="s4">if</span><span class="s1">(newVal === </span><span class="s4">null </span><span class="s1">|| newVal === undefined){</span>
            <span class="s2">//don't parse</span>
            <span class="s1">attrs[aName] = oldVal;</span>
          <span class="s1">}</span><span class="s4">else if</span><span class="s1">(</span><span class="s4">typeof </span><span class="s1">newVal !== </span><span class="s4">typeof </span><span class="s1">oldVal || newVal !== oldVal){</span>
            <span class="s2">//overwrite</span>
            <span class="s1">attrs[aName] = newVal;</span>
          <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
            <span class="s2">//parse</span>
            <span class="s1">attrs[aName] = parseValue(</span>
              <span class="s1">oldVal,</span>
              <span class="s4">this</span><span class="s1">.options.parseAttributeValue,</span>
              <span class="s4">this</span><span class="s1">.options.numberParseOptions</span>
            <span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s4">else if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.allowBooleanAttributes) {</span>
          <span class="s1">attrs[aName] = </span><span class="s4">true</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(!Object.keys(attrs).length) {</span>
      <span class="s4">return</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.attributesGroupName) {</span>
      <span class="s1">const attrCollection = {};</span>
      <span class="s1">attrCollection[</span><span class="s4">this</span><span class="s1">.options.attributesGroupName] = attrs;</span>
      <span class="s4">return </span><span class="s1">attrCollection;</span>
    <span class="s1">}</span>
    <span class="s4">return </span><span class="s1">attrs</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">const parseXml = </span><span class="s4">function</span><span class="s1">(xmlData) {</span>
  <span class="s1">xmlData = xmlData.replace(/\r\n?/g, </span><span class="s0">&quot;</span><span class="s3">\n</span><span class="s0">&quot;</span><span class="s1">); </span><span class="s2">//TODO: remove this line</span>
  <span class="s1">const xmlObj = </span><span class="s4">new </span><span class="s1">xmlNode(</span><span class="s0">'!xml'</span><span class="s1">);</span>
  <span class="s1">let currentNode = xmlObj;</span>
  <span class="s1">let textData = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">let jPath = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s4">for</span><span class="s1">(let i=</span><span class="s5">0</span><span class="s1">; i&lt; xmlData.length; i++){</span><span class="s2">//for each char in XML data</span>
    <span class="s1">const ch = xmlData[i];</span>
    <span class="s4">if</span><span class="s1">(ch === </span><span class="s0">'&lt;'</span><span class="s1">){</span>
      <span class="s2">// const nextIndex = i+1;</span>
      <span class="s2">// const _2ndChar = xmlData[nextIndex];</span>
      <span class="s4">if</span><span class="s1">( xmlData[i+</span><span class="s5">1</span><span class="s1">] === </span><span class="s0">'/'</span><span class="s1">) {</span><span class="s2">//Closing Tag</span>
        <span class="s1">const closeIndex = findClosingIndex(xmlData, </span><span class="s0">&quot;&gt;&quot;</span><span class="s1">, i, </span><span class="s0">&quot;Closing Tag is not closed.&quot;</span><span class="s1">)</span>
        <span class="s1">let tagName = xmlData.substring(i+</span><span class="s5">2</span><span class="s1">,closeIndex).trim();</span>

        <span class="s4">if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.removeNSPrefix){</span>
          <span class="s1">const colonIndex = tagName.indexOf(</span><span class="s0">&quot;:&quot;</span><span class="s1">);</span>
          <span class="s4">if</span><span class="s1">(colonIndex !== -</span><span class="s5">1</span><span class="s1">){</span>
            <span class="s1">tagName = tagName.substr(colonIndex+</span><span class="s5">1</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s4">if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.transformTagName) {</span>
          <span class="s1">tagName = </span><span class="s4">this</span><span class="s1">.options.transformTagName(tagName);</span>
        <span class="s1">}</span>

        <span class="s4">if</span><span class="s1">(currentNode){</span>
          <span class="s1">textData = </span><span class="s4">this</span><span class="s1">.saveTextToParentTag(textData, currentNode, jPath);</span>
        <span class="s1">}</span>

        <span class="s2">//check if last tag of nested tag was unpaired tag</span>
        <span class="s1">const lastTagName = jPath.substring(jPath.lastIndexOf(</span><span class="s0">&quot;.&quot;</span><span class="s1">)+</span><span class="s5">1</span><span class="s1">);</span>
        <span class="s4">if</span><span class="s1">(tagName &amp;&amp; </span><span class="s4">this</span><span class="s1">.options.unpairedTags.indexOf(tagName) !== -</span><span class="s5">1 </span><span class="s1">){</span>
          <span class="s4">throw new </span><span class="s1">Error(`Unpaired tag can not be used as closing tag: &lt;/${tagName}&gt;`);</span>
        <span class="s1">}</span>
        <span class="s1">let propIndex = </span><span class="s5">0</span>
        <span class="s4">if</span><span class="s1">(lastTagName &amp;&amp; </span><span class="s4">this</span><span class="s1">.options.unpairedTags.indexOf(lastTagName) !== -</span><span class="s5">1 </span><span class="s1">){</span>
          <span class="s1">propIndex = jPath.lastIndexOf(</span><span class="s0">'.'</span><span class="s1">, jPath.lastIndexOf(</span><span class="s0">'.'</span><span class="s1">)-</span><span class="s5">1</span><span class="s1">)</span>
          <span class="s4">this</span><span class="s1">.tagsNodeStack.pop();</span>
        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
          <span class="s1">propIndex = jPath.lastIndexOf(</span><span class="s0">&quot;.&quot;</span><span class="s1">);</span>
        <span class="s1">}</span>
        <span class="s1">jPath = jPath.substring(</span><span class="s5">0</span><span class="s1">, propIndex);</span>

        <span class="s1">currentNode = </span><span class="s4">this</span><span class="s1">.tagsNodeStack.pop();</span><span class="s2">//avoid recursion, set the parent tag scope</span>
        <span class="s1">textData = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s1">i = closeIndex;</span>
      <span class="s1">} </span><span class="s4">else if</span><span class="s1">( xmlData[i+</span><span class="s5">1</span><span class="s1">] === </span><span class="s0">'?'</span><span class="s1">) {</span>

        <span class="s1">let tagData = readTagExp(xmlData,i, </span><span class="s4">false</span><span class="s1">, </span><span class="s0">&quot;?&gt;&quot;</span><span class="s1">);</span>
        <span class="s4">if</span><span class="s1">(!tagData) </span><span class="s4">throw new </span><span class="s1">Error(</span><span class="s0">&quot;Pi Tag is not closed.&quot;</span><span class="s1">);</span>

        <span class="s1">textData = </span><span class="s4">this</span><span class="s1">.saveTextToParentTag(textData, currentNode, jPath);</span>
        <span class="s4">if</span><span class="s1">( (</span><span class="s4">this</span><span class="s1">.options.ignoreDeclaration &amp;&amp; tagData.tagName === </span><span class="s0">&quot;?xml&quot;</span><span class="s1">) || </span><span class="s4">this</span><span class="s1">.options.ignorePiTags){</span>

        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
  
          <span class="s1">const childNode = </span><span class="s4">new </span><span class="s1">xmlNode(tagData.tagName);</span>
          <span class="s1">childNode.add(</span><span class="s4">this</span><span class="s1">.options.textNodeName, </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
          
          <span class="s4">if</span><span class="s1">(tagData.tagName !== tagData.tagExp &amp;&amp; tagData.attrExpPresent){</span>
            <span class="s1">childNode[</span><span class="s0">&quot;:@&quot;</span><span class="s1">] = </span><span class="s4">this</span><span class="s1">.buildAttributesMap(tagData.tagExp, jPath, tagData.tagName);</span>
          <span class="s1">}</span>
          <span class="s4">this</span><span class="s1">.addChild(currentNode, childNode, jPath)</span>

        <span class="s1">}</span>


        <span class="s1">i = tagData.closeIndex + </span><span class="s5">1</span><span class="s1">;</span>
      <span class="s1">} </span><span class="s4">else if</span><span class="s1">(xmlData.substr(i + </span><span class="s5">1</span><span class="s1">, </span><span class="s5">3</span><span class="s1">) === </span><span class="s0">'!--'</span><span class="s1">) {</span>
        <span class="s1">const endIndex = findClosingIndex(xmlData, </span><span class="s0">&quot;--&gt;&quot;</span><span class="s1">, i+</span><span class="s5">4</span><span class="s1">, </span><span class="s0">&quot;Comment is not closed.&quot;</span><span class="s1">)</span>
        <span class="s4">if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.commentPropName){</span>
          <span class="s1">const comment = xmlData.substring(i + </span><span class="s5">4</span><span class="s1">, endIndex - </span><span class="s5">2</span><span class="s1">);</span>

          <span class="s1">textData = </span><span class="s4">this</span><span class="s1">.saveTextToParentTag(textData, currentNode, jPath);</span>

          <span class="s1">currentNode.add(</span><span class="s4">this</span><span class="s1">.options.commentPropName, [ { [</span><span class="s4">this</span><span class="s1">.options.textNodeName] : comment } ]);</span>
        <span class="s1">}</span>
        <span class="s1">i = endIndex;</span>
      <span class="s1">} </span><span class="s4">else if</span><span class="s1">( xmlData.substr(i + </span><span class="s5">1</span><span class="s1">, </span><span class="s5">2</span><span class="s1">) === </span><span class="s0">'!D'</span><span class="s1">) {</span>
        <span class="s1">const result = readDocType(xmlData, i);</span>
        <span class="s4">this</span><span class="s1">.docTypeEntities = result.entities;</span>
        <span class="s1">i = result.i;</span>
      <span class="s1">}</span><span class="s4">else if</span><span class="s1">(xmlData.substr(i + </span><span class="s5">1</span><span class="s1">, </span><span class="s5">2</span><span class="s1">) === </span><span class="s0">'!['</span><span class="s1">) {</span>
        <span class="s1">const closeIndex = findClosingIndex(xmlData, </span><span class="s0">&quot;]]&gt;&quot;</span><span class="s1">, i, </span><span class="s0">&quot;CDATA is not closed.&quot;</span><span class="s1">) - </span><span class="s5">2</span><span class="s1">;</span>
        <span class="s1">const tagExp = xmlData.substring(i + </span><span class="s5">9</span><span class="s1">,closeIndex);</span>

        <span class="s1">textData = </span><span class="s4">this</span><span class="s1">.saveTextToParentTag(textData, currentNode, jPath);</span>

        <span class="s2">//cdata should be set even if it is 0 length string</span>
        <span class="s4">if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.cdataPropName){</span>
          <span class="s2">// let val = this.parseTextData(tagExp, this.options.cdataPropName, jPath + &quot;.&quot; + this.options.cdataPropName, true, false, true);</span>
          <span class="s2">// if(!val) val = &quot;&quot;;</span>
          <span class="s1">currentNode.add(</span><span class="s4">this</span><span class="s1">.options.cdataPropName, [ { [</span><span class="s4">this</span><span class="s1">.options.textNodeName] : tagExp } ]);</span>
        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
          <span class="s1">let val = </span><span class="s4">this</span><span class="s1">.parseTextData(tagExp, currentNode.tagname, jPath, </span><span class="s4">true</span><span class="s1">, </span><span class="s4">false</span><span class="s1">, </span><span class="s4">true</span><span class="s1">);</span>
          <span class="s4">if</span><span class="s1">(val == undefined) val = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
          <span class="s1">currentNode.add(</span><span class="s4">this</span><span class="s1">.options.textNodeName, val);</span>
        <span class="s1">}</span>
        
        <span class="s1">i = closeIndex + </span><span class="s5">2</span><span class="s1">;</span>
      <span class="s1">}</span><span class="s4">else </span><span class="s1">{</span><span class="s2">//Opening tag</span>
        <span class="s1">let result = readTagExp(xmlData,i, </span><span class="s4">this</span><span class="s1">.options.removeNSPrefix);</span>
        <span class="s1">let tagName= result.tagName;</span>
        <span class="s1">let tagExp = result.tagExp;</span>
        <span class="s1">let attrExpPresent = result.attrExpPresent;</span>
        <span class="s1">let closeIndex = result.closeIndex;</span>

        <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.transformTagName) {</span>
          <span class="s1">tagName = </span><span class="s4">this</span><span class="s1">.options.transformTagName(tagName);</span>
        <span class="s1">}</span>
        
        <span class="s2">//save text as child node</span>
        <span class="s4">if </span><span class="s1">(currentNode &amp;&amp; textData) {</span>
          <span class="s4">if</span><span class="s1">(currentNode.tagname !== </span><span class="s0">'!xml'</span><span class="s1">){</span>
            <span class="s2">//when nested tag is found</span>
            <span class="s1">textData = </span><span class="s4">this</span><span class="s1">.saveTextToParentTag(textData, currentNode, jPath, </span><span class="s4">false</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">//check if last tag was unpaired tag</span>
        <span class="s1">const lastTag = currentNode;</span>
        <span class="s4">if</span><span class="s1">(lastTag &amp;&amp; </span><span class="s4">this</span><span class="s1">.options.unpairedTags.indexOf(lastTag.tagname) !== -</span><span class="s5">1 </span><span class="s1">){</span>
          <span class="s1">currentNode = </span><span class="s4">this</span><span class="s1">.tagsNodeStack.pop();</span>
          <span class="s1">jPath = jPath.substring(</span><span class="s5">0</span><span class="s1">, jPath.lastIndexOf(</span><span class="s0">&quot;.&quot;</span><span class="s1">));</span>
        <span class="s1">}</span>
        <span class="s4">if</span><span class="s1">(tagName !== xmlObj.tagname){</span>
          <span class="s1">jPath += jPath ? </span><span class="s0">&quot;.&quot; </span><span class="s1">+ tagName : tagName;</span>
        <span class="s1">}</span>
        <span class="s4">if </span><span class="s1">(</span><span class="s4">this</span><span class="s1">.isItStopNode(</span><span class="s4">this</span><span class="s1">.options.stopNodes, jPath, tagName)) { </span><span class="s2">//TODO: namespace</span>
          <span class="s1">let tagContent = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
          <span class="s2">//self-closing tag</span>
          <span class="s4">if</span><span class="s1">(tagExp.length &gt; </span><span class="s5">0 </span><span class="s1">&amp;&amp; tagExp.lastIndexOf(</span><span class="s0">&quot;/&quot;</span><span class="s1">) === tagExp.length - </span><span class="s5">1</span><span class="s1">){</span>
            <span class="s1">i = result.closeIndex;</span>
          <span class="s1">}</span>
          <span class="s2">//unpaired tag</span>
          <span class="s4">else if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.unpairedTags.indexOf(tagName) !== -</span><span class="s5">1</span><span class="s1">){</span>
            <span class="s1">i = result.closeIndex;</span>
          <span class="s1">}</span>
          <span class="s2">//normal tag</span>
          <span class="s4">else</span><span class="s1">{</span>
            <span class="s2">//read until closing tag is found</span>
            <span class="s1">const result = </span><span class="s4">this</span><span class="s1">.readStopNodeData(xmlData, tagName, closeIndex + </span><span class="s5">1</span><span class="s1">);</span>
            <span class="s4">if</span><span class="s1">(!result) </span><span class="s4">throw new </span><span class="s1">Error(`Unexpected end of ${tagName}`);</span>
            <span class="s1">i = result.i;</span>
            <span class="s1">tagContent = result.tagContent;</span>
          <span class="s1">}</span>

          <span class="s1">const childNode = </span><span class="s4">new </span><span class="s1">xmlNode(tagName);</span>
          <span class="s4">if</span><span class="s1">(tagName !== tagExp &amp;&amp; attrExpPresent){</span>
            <span class="s1">childNode[</span><span class="s0">&quot;:@&quot;</span><span class="s1">] = </span><span class="s4">this</span><span class="s1">.buildAttributesMap(tagExp, jPath, tagName);</span>
          <span class="s1">}</span>
          <span class="s4">if</span><span class="s1">(tagContent) {</span>
            <span class="s1">tagContent = </span><span class="s4">this</span><span class="s1">.parseTextData(tagContent, tagName, jPath, </span><span class="s4">true</span><span class="s1">, attrExpPresent, </span><span class="s4">true</span><span class="s1">, </span><span class="s4">true</span><span class="s1">);</span>
          <span class="s1">}</span>
          
          <span class="s1">jPath = jPath.substr(</span><span class="s5">0</span><span class="s1">, jPath.lastIndexOf(</span><span class="s0">&quot;.&quot;</span><span class="s1">));</span>
          <span class="s1">childNode.add(</span><span class="s4">this</span><span class="s1">.options.textNodeName, tagContent);</span>
          
          <span class="s4">this</span><span class="s1">.addChild(currentNode, childNode, jPath)</span>
        <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
  <span class="s2">//selfClosing tag</span>
          <span class="s4">if</span><span class="s1">(tagExp.length &gt; </span><span class="s5">0 </span><span class="s1">&amp;&amp; tagExp.lastIndexOf(</span><span class="s0">&quot;/&quot;</span><span class="s1">) === tagExp.length - </span><span class="s5">1</span><span class="s1">){</span>
            <span class="s4">if</span><span class="s1">(tagName[tagName.length - </span><span class="s5">1</span><span class="s1">] === </span><span class="s0">&quot;/&quot;</span><span class="s1">){ </span><span class="s2">//remove trailing '/'</span>
              <span class="s1">tagName = tagName.substr(</span><span class="s5">0</span><span class="s1">, tagName.length - </span><span class="s5">1</span><span class="s1">);</span>
              <span class="s1">jPath = jPath.substr(</span><span class="s5">0</span><span class="s1">, jPath.length - </span><span class="s5">1</span><span class="s1">);</span>
              <span class="s1">tagExp = tagName;</span>
            <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
              <span class="s1">tagExp = tagExp.substr(</span><span class="s5">0</span><span class="s1">, tagExp.length - </span><span class="s5">1</span><span class="s1">);</span>
            <span class="s1">}</span>
            
            <span class="s4">if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.transformTagName) {</span>
              <span class="s1">tagName = </span><span class="s4">this</span><span class="s1">.options.transformTagName(tagName);</span>
            <span class="s1">}</span>

            <span class="s1">const childNode = </span><span class="s4">new </span><span class="s1">xmlNode(tagName);</span>
            <span class="s4">if</span><span class="s1">(tagName !== tagExp &amp;&amp; attrExpPresent){</span>
              <span class="s1">childNode[</span><span class="s0">&quot;:@&quot;</span><span class="s1">] = </span><span class="s4">this</span><span class="s1">.buildAttributesMap(tagExp, jPath, tagName);</span>
            <span class="s1">}</span>
            <span class="s4">this</span><span class="s1">.addChild(currentNode, childNode, jPath)</span>
            <span class="s1">jPath = jPath.substr(</span><span class="s5">0</span><span class="s1">, jPath.lastIndexOf(</span><span class="s0">&quot;.&quot;</span><span class="s1">));</span>
          <span class="s1">}</span>
    <span class="s2">//opening tag</span>
          <span class="s4">else</span><span class="s1">{</span>
            <span class="s1">const childNode = </span><span class="s4">new </span><span class="s1">xmlNode( tagName);</span>
            <span class="s4">this</span><span class="s1">.tagsNodeStack.push(currentNode);</span>
            
            <span class="s4">if</span><span class="s1">(tagName !== tagExp &amp;&amp; attrExpPresent){</span>
              <span class="s1">childNode[</span><span class="s0">&quot;:@&quot;</span><span class="s1">] = </span><span class="s4">this</span><span class="s1">.buildAttributesMap(tagExp, jPath, tagName);</span>
            <span class="s1">}</span>
            <span class="s4">this</span><span class="s1">.addChild(currentNode, childNode, jPath)</span>
            <span class="s1">currentNode = childNode;</span>
          <span class="s1">}</span>
          <span class="s1">textData = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
          <span class="s1">i = closeIndex;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
      <span class="s1">textData += xmlData[i];</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">xmlObj.child;</span>
<span class="s1">}</span>

<span class="s4">function </span><span class="s1">addChild(currentNode, childNode, jPath){</span>
  <span class="s1">const result = </span><span class="s4">this</span><span class="s1">.options.updateTag(childNode.tagname, jPath, childNode[</span><span class="s0">&quot;:@&quot;</span><span class="s1">])</span>
  <span class="s4">if</span><span class="s1">(result === </span><span class="s4">false</span><span class="s1">){</span>
  <span class="s1">}</span><span class="s4">else if</span><span class="s1">(</span><span class="s4">typeof </span><span class="s1">result === </span><span class="s0">&quot;string&quot;</span><span class="s1">){</span>
    <span class="s1">childNode.tagname = result</span>
    <span class="s1">currentNode.addChild(childNode);</span>
  <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
    <span class="s1">currentNode.addChild(childNode);</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">const replaceEntitiesValue = </span><span class="s4">function</span><span class="s1">(val){</span>

  <span class="s4">if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.processEntities){</span>
    <span class="s4">for</span><span class="s1">(let entityName </span><span class="s4">in this</span><span class="s1">.docTypeEntities){</span>
      <span class="s1">const entity = </span><span class="s4">this</span><span class="s1">.docTypeEntities[entityName];</span>
      <span class="s1">val = val.replace( entity.regx, entity.val);</span>
    <span class="s1">}</span>
    <span class="s4">for</span><span class="s1">(let entityName </span><span class="s4">in this</span><span class="s1">.lastEntities){</span>
      <span class="s1">const entity = </span><span class="s4">this</span><span class="s1">.lastEntities[entityName];</span>
      <span class="s1">val = val.replace( entity.regex, entity.val);</span>
    <span class="s1">}</span>
    <span class="s4">if</span><span class="s1">(</span><span class="s4">this</span><span class="s1">.options.htmlEntities){</span>
      <span class="s4">for</span><span class="s1">(let entityName </span><span class="s4">in this</span><span class="s1">.htmlEntities){</span>
        <span class="s1">const entity = </span><span class="s4">this</span><span class="s1">.htmlEntities[entityName];</span>
        <span class="s1">val = val.replace( entity.regex, entity.val);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s1">val = val.replace( </span><span class="s4">this</span><span class="s1">.ampEntity.regex, </span><span class="s4">this</span><span class="s1">.ampEntity.val);</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">val;</span>
<span class="s1">}</span>
<span class="s4">function </span><span class="s1">saveTextToParentTag(textData, currentNode, jPath, isLeafNode) {</span>
  <span class="s4">if </span><span class="s1">(textData) { </span><span class="s2">//store previously collected data as textNode</span>
    <span class="s4">if</span><span class="s1">(isLeafNode === undefined) isLeafNode = Object.keys(currentNode.child).length === </span><span class="s5">0</span>
    
    <span class="s1">textData = </span><span class="s4">this</span><span class="s1">.parseTextData(textData,</span>
      <span class="s1">currentNode.tagname,</span>
      <span class="s1">jPath,</span>
      <span class="s4">false</span><span class="s1">,</span>
      <span class="s1">currentNode[</span><span class="s0">&quot;:@&quot;</span><span class="s1">] ? Object.keys(currentNode[</span><span class="s0">&quot;:@&quot;</span><span class="s1">]).length !== </span><span class="s5">0 </span><span class="s1">: </span><span class="s4">false</span><span class="s1">,</span>
      <span class="s1">isLeafNode);</span>

    <span class="s4">if </span><span class="s1">(textData !== undefined &amp;&amp; textData !== </span><span class="s0">&quot;&quot;</span><span class="s1">)</span>
      <span class="s1">currentNode.add(</span><span class="s4">this</span><span class="s1">.options.textNodeName, textData);</span>
    <span class="s1">textData = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">textData;</span>
<span class="s1">}</span>

<span class="s2">//TODO: use jPath to simplify the logic</span>
<span class="s2">/** 
 *  
 * @param {string[]} stopNodes  
 * @param {string} jPath 
 * @param {string} currentTagName  
 */</span>
<span class="s4">function </span><span class="s1">isItStopNode(stopNodes, jPath, currentTagName){</span>
  <span class="s1">const allNodesExp = </span><span class="s0">&quot;*.&quot; </span><span class="s1">+ currentTagName;</span>
  <span class="s4">for </span><span class="s1">(const stopNodePath </span><span class="s4">in </span><span class="s1">stopNodes) {</span>
    <span class="s1">const stopNodeExp = stopNodes[stopNodePath];</span>
    <span class="s4">if</span><span class="s1">( allNodesExp === stopNodeExp || jPath === stopNodeExp  ) </span><span class="s4">return true</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s4">return false</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s2">/** 
 * Returns the tag Expression and where it is ending handling single-double quotes situation 
 * @param {string} xmlData  
 * @param {number} i starting index 
 * @returns  
 */</span>
<span class="s4">function </span><span class="s1">tagExpWithClosingIndex(xmlData, i, closingChar = </span><span class="s0">&quot;&gt;&quot;</span><span class="s1">){</span>
  <span class="s1">let attrBoundary;</span>
  <span class="s1">let tagExp = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s4">for </span><span class="s1">(let index = i; index &lt; xmlData.length; index++) {</span>
    <span class="s1">let ch = xmlData[index];</span>
    <span class="s4">if </span><span class="s1">(attrBoundary) {</span>
        <span class="s4">if </span><span class="s1">(ch === attrBoundary) attrBoundary = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span><span class="s2">//reset</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(ch === </span><span class="s0">'&quot;' </span><span class="s1">|| ch === </span><span class="s0">&quot;'&quot;</span><span class="s1">) {</span>
        <span class="s1">attrBoundary = ch;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(ch === closingChar[</span><span class="s5">0</span><span class="s1">]) {</span>
      <span class="s4">if</span><span class="s1">(closingChar[</span><span class="s5">1</span><span class="s1">]){</span>
        <span class="s4">if</span><span class="s1">(xmlData[index + </span><span class="s5">1</span><span class="s1">] === closingChar[</span><span class="s5">1</span><span class="s1">]){</span>
          <span class="s4">return </span><span class="s1">{</span>
            <span class="s1">data: tagExp,</span>
            <span class="s1">index: index</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
        <span class="s4">return </span><span class="s1">{</span>
          <span class="s1">data: tagExp,</span>
          <span class="s1">index: index</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">(ch === </span><span class="s0">'</span><span class="s3">\t</span><span class="s0">'</span><span class="s1">) {</span>
      <span class="s1">ch = </span><span class="s0">&quot; &quot;</span>
    <span class="s1">}</span>
    <span class="s1">tagExp += ch;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">function </span><span class="s1">findClosingIndex(xmlData, str, i, errMsg){</span>
  <span class="s1">const closingIndex = xmlData.indexOf(str, i);</span>
  <span class="s4">if</span><span class="s1">(closingIndex === -</span><span class="s5">1</span><span class="s1">){</span>
    <span class="s4">throw new </span><span class="s1">Error(errMsg)</span>
  <span class="s1">}</span><span class="s4">else</span><span class="s1">{</span>
    <span class="s4">return </span><span class="s1">closingIndex + str.length - </span><span class="s5">1</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">function </span><span class="s1">readTagExp(xmlData,i, removeNSPrefix, closingChar = </span><span class="s0">&quot;&gt;&quot;</span><span class="s1">){</span>
  <span class="s1">const result = tagExpWithClosingIndex(xmlData, i+</span><span class="s5">1</span><span class="s1">, closingChar);</span>
  <span class="s4">if</span><span class="s1">(!result) </span><span class="s4">return</span><span class="s1">;</span>
  <span class="s1">let tagExp = result.data;</span>
  <span class="s1">const closeIndex = result.index;</span>
  <span class="s1">const separatorIndex = tagExp.search(/\s/);</span>
  <span class="s1">let tagName = tagExp;</span>
  <span class="s1">let attrExpPresent = </span><span class="s4">true</span><span class="s1">;</span>
  <span class="s4">if</span><span class="s1">(separatorIndex !== -</span><span class="s5">1</span><span class="s1">){</span><span class="s2">//separate tag name and attributes expression</span>
    <span class="s1">tagName = tagExp.substr(</span><span class="s5">0</span><span class="s1">, separatorIndex).replace(/\s\s*$/, </span><span class="s0">''</span><span class="s1">);</span>
    <span class="s1">tagExp = tagExp.substr(separatorIndex + </span><span class="s5">1</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s4">if</span><span class="s1">(removeNSPrefix){</span>
    <span class="s1">const colonIndex = tagName.indexOf(</span><span class="s0">&quot;:&quot;</span><span class="s1">);</span>
    <span class="s4">if</span><span class="s1">(colonIndex !== -</span><span class="s5">1</span><span class="s1">){</span>
      <span class="s1">tagName = tagName.substr(colonIndex+</span><span class="s5">1</span><span class="s1">);</span>
      <span class="s1">attrExpPresent = tagName !== result.data.substr(colonIndex + </span><span class="s5">1</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">return </span><span class="s1">{</span>
    <span class="s1">tagName: tagName,</span>
    <span class="s1">tagExp: tagExp,</span>
    <span class="s1">closeIndex: closeIndex,</span>
    <span class="s1">attrExpPresent: attrExpPresent,</span>
  <span class="s1">}</span>
<span class="s1">}</span>
<span class="s2">/** 
 * find paired tag for a stop node 
 * @param {string} xmlData  
 * @param {string} tagName  
 * @param {number} i  
 */</span>
<span class="s4">function </span><span class="s1">readStopNodeData(xmlData, tagName, i){</span>
  <span class="s1">const startIndex = i;</span>
  <span class="s2">// Starting at 1 since we already have an open tag</span>
  <span class="s1">let openTagCount = </span><span class="s5">1</span><span class="s1">;</span>

  <span class="s4">for </span><span class="s1">(; i &lt; xmlData.length; i++) {</span>
    <span class="s4">if</span><span class="s1">( xmlData[i] === </span><span class="s0">&quot;&lt;&quot;</span><span class="s1">){ </span>
      <span class="s4">if </span><span class="s1">(xmlData[i+</span><span class="s5">1</span><span class="s1">] === </span><span class="s0">&quot;/&quot;</span><span class="s1">) {</span><span class="s2">//close tag</span>
          <span class="s1">const closeIndex = findClosingIndex(xmlData, </span><span class="s0">&quot;&gt;&quot;</span><span class="s1">, i, `${tagName} is not closed`);</span>
          <span class="s1">let closeTagName = xmlData.substring(i+</span><span class="s5">2</span><span class="s1">,closeIndex).trim();</span>
          <span class="s4">if</span><span class="s1">(closeTagName === tagName){</span>
            <span class="s1">openTagCount--;</span>
            <span class="s4">if </span><span class="s1">(openTagCount === </span><span class="s5">0</span><span class="s1">) {</span>
              <span class="s4">return </span><span class="s1">{</span>
                <span class="s1">tagContent: xmlData.substring(startIndex, i),</span>
                <span class="s1">i : closeIndex</span>
              <span class="s1">}</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
          <span class="s1">i=closeIndex;</span>
        <span class="s1">} </span><span class="s4">else if</span><span class="s1">(xmlData[i+</span><span class="s5">1</span><span class="s1">] === </span><span class="s0">'?'</span><span class="s1">) { </span>
          <span class="s1">const closeIndex = findClosingIndex(xmlData, </span><span class="s0">&quot;?&gt;&quot;</span><span class="s1">, i+</span><span class="s5">1</span><span class="s1">, </span><span class="s0">&quot;StopNode is not closed.&quot;</span><span class="s1">)</span>
          <span class="s1">i=closeIndex;</span>
        <span class="s1">} </span><span class="s4">else if</span><span class="s1">(xmlData.substr(i + </span><span class="s5">1</span><span class="s1">, </span><span class="s5">3</span><span class="s1">) === </span><span class="s0">'!--'</span><span class="s1">) { </span>
          <span class="s1">const closeIndex = findClosingIndex(xmlData, </span><span class="s0">&quot;--&gt;&quot;</span><span class="s1">, i+</span><span class="s5">3</span><span class="s1">, </span><span class="s0">&quot;StopNode is not closed.&quot;</span><span class="s1">)</span>
          <span class="s1">i=closeIndex;</span>
        <span class="s1">} </span><span class="s4">else if</span><span class="s1">(xmlData.substr(i + </span><span class="s5">1</span><span class="s1">, </span><span class="s5">2</span><span class="s1">) === </span><span class="s0">'!['</span><span class="s1">) { </span>
          <span class="s1">const closeIndex = findClosingIndex(xmlData, </span><span class="s0">&quot;]]&gt;&quot;</span><span class="s1">, i, </span><span class="s0">&quot;StopNode is not closed.&quot;</span><span class="s1">) - </span><span class="s5">2</span><span class="s1">;</span>
          <span class="s1">i=closeIndex;</span>
        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
          <span class="s1">const tagData = readTagExp(xmlData, i, </span><span class="s0">'&gt;'</span><span class="s1">)</span>

          <span class="s4">if </span><span class="s1">(tagData) {</span>
            <span class="s1">const openTagName = tagData &amp;&amp; tagData.tagName;</span>
            <span class="s4">if </span><span class="s1">(openTagName === tagName &amp;&amp; tagData.tagExp[tagData.tagExp.length-1] !== </span><span class="s0">&quot;/&quot;</span><span class="s1">) {</span>
              <span class="s1">openTagCount++;</span>
            <span class="s1">}</span>
            <span class="s1">i=tagData.closeIndex;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
  <span class="s1">}</span><span class="s2">//end for loop</span>
<span class="s1">}</span>

<span class="s4">function </span><span class="s1">parseValue(val, shouldParse, options) {</span>
  <span class="s4">if </span><span class="s1">(shouldParse &amp;&amp; </span><span class="s4">typeof </span><span class="s1">val === </span><span class="s0">'string'</span><span class="s1">) {</span>
    <span class="s2">//console.log(options)</span>
    <span class="s1">const newval = val.trim();</span>
    <span class="s4">if</span><span class="s1">(newval === </span><span class="s0">'true' </span><span class="s1">) </span><span class="s4">return true</span><span class="s1">;</span>
    <span class="s4">else if</span><span class="s1">(newval === </span><span class="s0">'false' </span><span class="s1">) </span><span class="s4">return false</span><span class="s1">;</span>
    <span class="s4">else return </span><span class="s1">toNumber(val, options);</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s4">if </span><span class="s1">(util.isExist(val)) {</span>
      <span class="s4">return </span><span class="s1">val;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s4">return </span><span class="s0">''</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>


<span class="s1">module.exports = OrderedObjParser;</span>
</pre>
</body>
</html>