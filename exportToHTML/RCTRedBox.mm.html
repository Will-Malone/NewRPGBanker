<html>
<head>
<title>RCTRedBox.mm</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
RCTRedBox.mm</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#import </span><span class="s3">&quot;RCTRedBox.h&quot;</span>

<span class="s2">#import </span><span class="s3">&lt;FBReactNativeSpec/FBReactNativeSpec.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTBridge.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTConvert.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTDefines.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTErrorInfo.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTEventDispatcherProtocol.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTJSStackFrame.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTRedBoxExtraDataViewController.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTRedBoxSetEnabled.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTReloadCommand.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTUtils.h&gt;</span>

<span class="s2">#import </span><span class="s3">&lt;objc/runtime.h&gt;</span>

<span class="s2">#import </span><span class="s3">&quot;CoreModulesPlugins.h&quot;</span>

<span class="s2">#if </span><span class="s1">RCT_DEV_MENU</span>

<span class="s4">@class </span><span class="s1">RCTRedBoxWindow</span><span class="s4">;</span>

<span class="s4">@interface </span><span class="s1">UIButton (RCTRedBox)</span>

<span class="s4">@property </span><span class="s1">(nonatomic) RCTRedBoxButtonPressHandler rct_handler</span><span class="s4">;</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)rct_addBlock:(RCTRedBoxButtonPressHandler)handler forControlEvents:(UIControlEvents)controlEvents</span><span class="s4">;</span>

<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">UIButton (RCTRedBox)</span>

<span class="s1">- (RCTRedBoxButtonPressHandler)rct_handler</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">objc_getAssociatedObject(self</span><span class="s4">, @selector</span><span class="s1">(rct_handler))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setRct_handler:(RCTRedBoxButtonPressHandler)rct_handler</span>
<span class="s1">{</span>
  <span class="s1">objc_setAssociatedObject(self</span><span class="s4">, @selector</span><span class="s1">(rct_handler)</span><span class="s4">, </span><span class="s1">rct_handler</span><span class="s4">, </span><span class="s1">OBJC_ASSOCIATION_RETAIN_NONATOMIC)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)rct_callBlock</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self.rct_handler) {</span>
    <span class="s1">self.rct_handler()</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)rct_addBlock:(RCTRedBoxButtonPressHandler)handler forControlEvents:(UIControlEvents)controlEvents</span>
<span class="s1">{</span>
  <span class="s1">self.rct_handler = handler</span><span class="s4">;</span>
  <span class="s1">[self addTarget:self action:</span><span class="s4">@selector</span><span class="s1">(rct_callBlock) forControlEvents:controlEvents]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s4">@protocol </span><span class="s1">RCTRedBoxWindowActionDelegate &lt;NSObject&gt;</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)redBoxWindow:(RCTRedBoxWindow *)redBoxWindow openStackFrameInEditor:(RCTJSStackFrame *)stackFrame</span><span class="s4">;</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)reloadFromRedBoxWindow:(RCTRedBoxWindow *)redBoxWindow</span><span class="s4">;</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)loadExtraDataViewController</span><span class="s4">;</span>

<span class="s4">@end</span>

<span class="s4">@interface </span><span class="s1">RCTRedBoxWindow : NSObject &lt;UITableViewDelegate</span><span class="s4">, </span><span class="s1">UITableViewDataSource&gt;</span>
<span class="s4">@property </span><span class="s1">(nonatomic</span><span class="s4">, </span><span class="s1">strong) UIViewController *rootViewController</span><span class="s4">;</span>
<span class="s4">@property </span><span class="s1">(nonatomic</span><span class="s4">, </span><span class="s1">weak) id&lt;RCTRedBoxWindowActionDelegate&gt; actionDelegate</span><span class="s4">;</span>
<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTRedBoxWindow {</span>
  <span class="s1">UITableView *_stackTraceTableView</span><span class="s4">;</span>
  <span class="s1">NSString *_lastErrorMessage</span><span class="s4">;</span>
  <span class="s1">NSArray&lt;RCTJSStackFrame *&gt; *_lastStackTrace</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">_lastErrorCookie</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (instancetype)initWithFrame:(CGRect)frame</span>
           <span class="s1">customButtonTitles:(NSArray&lt;NSString *&gt; *)customButtonTitles</span>
         <span class="s1">customButtonHandlers:(NSArray&lt;RCTRedBoxButtonPressHandler&gt; *)customButtonHandlers</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self = [super init]) {</span>
    <span class="s1">_lastErrorCookie = -</span><span class="s5">1</span><span class="s4">;</span>

    <span class="s1">_rootViewController = [UIViewController </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">UIView *rootView = _rootViewController.view</span><span class="s4">;</span>
    <span class="s1">rootView.frame = frame</span><span class="s4">;</span>
    <span class="s1">rootView.backgroundColor = [UIColor blackColor]</span><span class="s4">;</span>

    <span class="s4">const </span><span class="s1">CGFloat buttonHeight = </span><span class="s5">60</span><span class="s4">;</span>

    <span class="s1">CGRect detailsFrame = rootView.bounds</span><span class="s4">;</span>
    <span class="s1">detailsFrame.size.height -= buttonHeight + (</span><span class="s4">double</span><span class="s1">)[self bottomSafeViewHeight]</span><span class="s4">;</span>

    <span class="s1">_stackTraceTableView = [[UITableView alloc] initWithFrame:detailsFrame style:UITableViewStylePlain]</span><span class="s4">;</span>
    <span class="s1">_stackTraceTableView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight</span><span class="s4">;</span>
    <span class="s1">_stackTraceTableView.delegate = self</span><span class="s4">;</span>
    <span class="s1">_stackTraceTableView.dataSource = self</span><span class="s4">;</span>
    <span class="s1">_stackTraceTableView.backgroundColor = [UIColor clearColor]</span><span class="s4">;</span>
    <span class="s1">_stackTraceTableView.separatorColor = [UIColor colorWithWhite:</span><span class="s5">1 </span><span class="s1">alpha:</span><span class="s5">0.3</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">_stackTraceTableView.separatorStyle = UITableViewCellSeparatorStyleNone</span><span class="s4">;</span>
    <span class="s1">_stackTraceTableView.indicatorStyle = UIScrollViewIndicatorStyleWhite</span><span class="s4">;</span>
    <span class="s1">[rootView addSubview:_stackTraceTableView]</span><span class="s4">;</span>

<span class="s2">#if </span><span class="s1">TARGET_OS_SIMULATOR || TARGET_OS_MACCATALYST</span>
    <span class="s1">NSString *reloadText = </span><span class="s4">@</span><span class="s3">&quot;Reload</span><span class="s4">\n</span><span class="s3">(</span><span class="s4">\u2318</span><span class="s3">R)&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *dismissText = </span><span class="s4">@</span><span class="s3">&quot;Dismiss</span><span class="s4">\n</span><span class="s3">(ESC)&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *copyText = </span><span class="s4">@</span><span class="s3">&quot;Copy</span><span class="s4">\n</span><span class="s3">(</span><span class="s4">\u2325\u2318</span><span class="s3">C)&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *extraText = </span><span class="s4">@</span><span class="s3">&quot;Extra Info</span><span class="s4">\n</span><span class="s3">(</span><span class="s4">\u2318</span><span class="s3">E)&quot;</span><span class="s4">;</span>
<span class="s2">#else</span>
    <span class="s1">NSString *reloadText = </span><span class="s4">@</span><span class="s3">&quot;Reload JS&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *dismissText = </span><span class="s4">@</span><span class="s3">&quot;Dismiss&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *copyText = </span><span class="s4">@</span><span class="s3">&quot;Copy&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *extraText = </span><span class="s4">@</span><span class="s3">&quot;Extra Info&quot;</span><span class="s4">;</span>
<span class="s2">#endif</span>

    <span class="s1">UIButton *dismissButton = [self redBoxButton:dismissText</span>
                         <span class="s1">accessibilityIdentifier:</span><span class="s4">@</span><span class="s3">&quot;redbox-dismiss&quot;</span>
                                        <span class="s4">selector</span><span class="s1">:</span><span class="s4">@selector</span><span class="s1">(dismiss)</span>
                                           <span class="s1">block:nil]</span><span class="s4">;</span>
    <span class="s1">UIButton *reloadButton = [self redBoxButton:reloadText</span>
                        <span class="s1">accessibilityIdentifier:</span><span class="s4">@</span><span class="s3">&quot;redbox-reload&quot;</span>
                                       <span class="s4">selector</span><span class="s1">:</span><span class="s4">@selector</span><span class="s1">(reload)</span>
                                          <span class="s1">block:nil]</span><span class="s4">;</span>
    <span class="s1">UIButton *copyButton = [self redBoxButton:copyText</span>
                      <span class="s1">accessibilityIdentifier:</span><span class="s4">@</span><span class="s3">&quot;redbox-copy&quot;</span>
                                     <span class="s4">selector</span><span class="s1">:</span><span class="s4">@selector</span><span class="s1">(copyStack)</span>
                                        <span class="s1">block:nil]</span><span class="s4">;</span>
    <span class="s1">UIButton *extraButton = [self redBoxButton:extraText</span>
                       <span class="s1">accessibilityIdentifier:</span><span class="s4">@</span><span class="s3">&quot;redbox-extra&quot;</span>
                                      <span class="s4">selector</span><span class="s1">:</span><span class="s4">@selector</span><span class="s1">(showExtraDataViewController)</span>
                                         <span class="s1">block:nil]</span><span class="s4">;</span>

    <span class="s1">CGFloat buttonWidth = frame.size.width / (CGFloat)(</span><span class="s5">4 </span><span class="s1">+ [customButtonTitles count])</span><span class="s4">;</span>
    <span class="s1">CGFloat bottomButtonHeight = frame.size.height - buttonHeight - (CGFloat)[self bottomSafeViewHeight]</span><span class="s4">;</span>
    <span class="s1">dismissButton.frame = CGRectMake(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">bottomButtonHeight</span><span class="s4">, </span><span class="s1">buttonWidth</span><span class="s4">, </span><span class="s1">buttonHeight)</span><span class="s4">;</span>
    <span class="s1">reloadButton.frame = CGRectMake(buttonWidth</span><span class="s4">, </span><span class="s1">bottomButtonHeight</span><span class="s4">, </span><span class="s1">buttonWidth</span><span class="s4">, </span><span class="s1">buttonHeight)</span><span class="s4">;</span>
    <span class="s1">copyButton.frame = CGRectMake(buttonWidth * </span><span class="s5">2</span><span class="s4">, </span><span class="s1">bottomButtonHeight</span><span class="s4">, </span><span class="s1">buttonWidth</span><span class="s4">, </span><span class="s1">buttonHeight)</span><span class="s4">;</span>
    <span class="s1">extraButton.frame = CGRectMake(buttonWidth * </span><span class="s5">3</span><span class="s4">, </span><span class="s1">bottomButtonHeight</span><span class="s4">, </span><span class="s1">buttonWidth</span><span class="s4">, </span><span class="s1">buttonHeight)</span><span class="s4">;</span>

    <span class="s1">[rootView addSubview:dismissButton]</span><span class="s4">;</span>
    <span class="s1">[rootView addSubview:reloadButton]</span><span class="s4">;</span>
    <span class="s1">[rootView addSubview:copyButton]</span><span class="s4">;</span>
    <span class="s1">[rootView addSubview:extraButton]</span><span class="s4">;</span>

    <span class="s4">for </span><span class="s1">(NSUInteger i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; [customButtonTitles count]</span><span class="s4">; </span><span class="s1">i++) {</span>
      <span class="s1">UIButton *button = [self redBoxButton:customButtonTitles[i]</span>
                    <span class="s1">accessibilityIdentifier:</span><span class="s4">@</span><span class="s3">&quot;&quot;</span>
                                   <span class="s4">selector</span><span class="s1">:nil</span>
                                      <span class="s1">block:customButtonHandlers[i]]</span><span class="s4">;</span>
      <span class="s1">button.frame = CGRectMake(buttonWidth * (</span><span class="s4">double</span><span class="s1">)(</span><span class="s5">4 </span><span class="s1">+ i)</span><span class="s4">, </span><span class="s1">bottomButtonHeight</span><span class="s4">, </span><span class="s1">buttonWidth</span><span class="s4">, </span><span class="s1">buttonHeight)</span><span class="s4">;</span>
      <span class="s1">[rootView addSubview:button]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">UIView *topBorder =</span>
        <span class="s1">[[UIView alloc] initWithFrame:CGRectMake(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">bottomButtonHeight + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">rootView.frame.size.width</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s4">;</span>
    <span class="s1">topBorder.backgroundColor = [UIColor colorWithRed:</span><span class="s5">0.70 </span><span class="s1">green:</span><span class="s5">0.70 </span><span class="s1">blue:</span><span class="s5">0.70 </span><span class="s1">alpha:</span><span class="s5">1.0</span><span class="s1">]</span><span class="s4">;</span>

    <span class="s1">[rootView addSubview:topBorder]</span><span class="s4">;</span>

    <span class="s1">UIView *bottomSafeView = [UIView </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">bottomSafeView.backgroundColor = [UIColor colorWithRed:</span><span class="s5">0.1 </span><span class="s1">green:</span><span class="s5">0.1 </span><span class="s1">blue:</span><span class="s5">0.1 </span><span class="s1">alpha:</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">bottomSafeView.frame = CGRectMake(</span>
        <span class="s5">0</span><span class="s4">,</span>
        <span class="s1">frame.size.height - (CGFloat)[self bottomSafeViewHeight]</span><span class="s4">,</span>
        <span class="s1">frame.size.width</span><span class="s4">,</span>
        <span class="s1">(CGFloat)[self bottomSafeViewHeight])</span><span class="s4">;</span>

    <span class="s1">[rootView addSubview:bottomSafeView]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">self</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (UIButton *)redBoxButton:(NSString *)title</span>
    <span class="s1">accessibilityIdentifier:(NSString *)accessibilityIdentifier</span>
                   <span class="s4">selector</span><span class="s1">:(SEL)</span><span class="s4">selector</span>
                      <span class="s1">block:(RCTRedBoxButtonPressHandler)block</span>
<span class="s1">{</span>
  <span class="s1">UIButton *button = [UIButton buttonWithType:UIButtonTypeCustom]</span><span class="s4">;</span>
  <span class="s1">button.autoresizingMask =</span>
      <span class="s1">UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleTopMargin | UIViewAutoresizingFlexibleRightMargin</span><span class="s4">;</span>
  <span class="s1">button.accessibilityIdentifier = accessibilityIdentifier</span><span class="s4">;</span>
  <span class="s1">button.titleLabel.font = [UIFont systemFontOfSize:</span><span class="s5">13</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">button.titleLabel.lineBreakMode = NSLineBreakByWordWrapping</span><span class="s4">;</span>
  <span class="s1">button.titleLabel.textAlignment = NSTextAlignmentCenter</span><span class="s4">;</span>
  <span class="s1">button.backgroundColor = [UIColor colorWithRed:</span><span class="s5">0.1 </span><span class="s1">green:</span><span class="s5">0.1 </span><span class="s1">blue:</span><span class="s5">0.1 </span><span class="s1">alpha:</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">[button setTitle:title forState:UIControlStateNormal]</span><span class="s4">;</span>
  <span class="s1">[button setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal]</span><span class="s4">;</span>
  <span class="s1">[button setTitleColor:[UIColor colorWithWhite:</span><span class="s5">1 </span><span class="s1">alpha:</span><span class="s5">0.5</span><span class="s1">] forState:UIControlStateHighlighted]</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(</span><span class="s4">selector</span><span class="s1">) {</span>
    <span class="s1">[button addTarget:self action:</span><span class="s4">selector </span><span class="s1">forControlEvents:UIControlEventTouchUpInside]</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(block) {</span>
    <span class="s1">[button rct_addBlock:block forControlEvents:UIControlEventTouchUpInside]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">button</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (NSInteger)bottomSafeViewHeight</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">RCTSharedApplication().delegate.window.safeAreaInsets.bottom</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_NOT_IMPLEMENTED(-(instancetype)initWithCoder : (NSCoder *)aDecoder)</span>

<span class="s1">- (NSString *)stripAnsi:(NSString *)text</span>
<span class="s1">{</span>
  <span class="s1">NSError *error = nil</span><span class="s4">;</span>
  <span class="s1">NSRegularExpression *regex = [NSRegularExpression regularExpressionWithPattern:</span><span class="s4">@</span><span class="s3">&quot;</span><span class="s4">\\</span><span class="s3">x1b</span><span class="s4">\\</span><span class="s3">[[0-9;]*m&quot;</span>
                                                                         <span class="s1">options:NSRegularExpressionCaseInsensitive</span>
                                                                           <span class="s1">error:&amp;error]</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">[regex stringByReplacingMatchesInString:text options:</span><span class="s5">0 </span><span class="s1">range:NSMakeRange(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">[text length]) withTemplate:</span><span class="s4">@</span><span class="s3">&quot;&quot;</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message</span>
               <span class="s1">withStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
                <span class="s1">isUpdate:(BOOL)isUpdate</span>
             <span class="s1">errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s0">// Remove ANSI color codes from the message</span>
  <span class="s1">NSString *messageWithoutAnsi = [self stripAnsi:message]</span><span class="s4">;</span>

  <span class="s1">BOOL isRootViewControllerPresented = self.rootViewController.presentingViewController != nil</span><span class="s4">;</span>
  <span class="s0">// Show if this is a new message, or if we're updating the previous message</span>
  <span class="s1">BOOL isNew = !isRootViewControllerPresented &amp;&amp; !isUpdate</span><span class="s4">;</span>
  <span class="s1">BOOL isUpdateForSameMessage = !isNew &amp;&amp;</span>
      <span class="s1">(isRootViewControllerPresented &amp;&amp; isUpdate &amp;&amp;</span>
       <span class="s1">((errorCookie == -</span><span class="s5">1 </span><span class="s1">&amp;&amp; [_lastErrorMessage isEqualToString:messageWithoutAnsi]) ||</span>
        <span class="s1">(errorCookie == _lastErrorCookie)))</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(isNew || isUpdateForSameMessage) {</span>
    <span class="s1">_lastStackTrace = stack</span><span class="s4">;</span>
    <span class="s0">// message is displayed using UILabel, which is unable to render text of</span>
    <span class="s0">// unlimited length, so we truncate it</span>
    <span class="s1">_lastErrorMessage = [messageWithoutAnsi substringToIndex:MIN((NSUInteger)</span><span class="s5">10000</span><span class="s4">, </span><span class="s1">messageWithoutAnsi.length)]</span><span class="s4">;</span>
    <span class="s1">_lastErrorCookie = errorCookie</span><span class="s4">;</span>

    <span class="s1">[_stackTraceTableView reloadData]</span><span class="s4">;</span>

    <span class="s4">if </span><span class="s1">(!isRootViewControllerPresented) {</span>
      <span class="s1">[_stackTraceTableView scrollToRowAtIndexPath:[NSIndexPath indexPathForRow:</span><span class="s5">0 </span><span class="s1">inSection:</span><span class="s5">0</span><span class="s1">]</span>
                                  <span class="s1">atScrollPosition:UITableViewScrollPositionTop</span>
                                          <span class="s1">animated:NO]</span><span class="s4">;</span>
      <span class="s1">[RCTKeyWindow().rootViewController presentViewController:self.rootViewController animated:YES completion:nil]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)dismiss</span>
<span class="s1">{</span>
  <span class="s1">[self.rootViewController dismissViewControllerAnimated:YES completion:nil]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)reload</span>
<span class="s1">{</span>
  <span class="s1">[_actionDelegate reloadFromRedBoxWindow:self]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showExtraDataViewController</span>
<span class="s1">{</span>
  <span class="s1">[_actionDelegate loadExtraDataViewController]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)copyStack</span>
<span class="s1">{</span>
  <span class="s1">NSMutableString *fullStackTrace</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(_lastErrorMessage != nil) {</span>
    <span class="s1">fullStackTrace = [_lastErrorMessage mutableCopy]</span><span class="s4">;</span>
    <span class="s1">[fullStackTrace appendString:</span><span class="s4">@</span><span class="s3">&quot;</span><span class="s4">\n\n</span><span class="s3">&quot;</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">fullStackTrace = [NSMutableString string]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">for </span><span class="s1">(RCTJSStackFrame *stackFrame in _lastStackTrace) {</span>
    <span class="s1">[fullStackTrace appendString:[NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;%@</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s4">, </span><span class="s1">stackFrame.methodName]]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(stackFrame.file) {</span>
      <span class="s1">[fullStackTrace appendFormat:</span><span class="s4">@</span><span class="s3">&quot;    %@</span><span class="s4">\n</span><span class="s3">&quot;</span><span class="s4">, </span><span class="s1">[self formatFrameSource:stackFrame]]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s1">UIPasteboard *pb = [UIPasteboard generalPasteboard]</span><span class="s4">;</span>
  <span class="s1">[pb setString:fullStackTrace]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (NSString *)formatFrameSource:(RCTJSStackFrame *)stackFrame</span>
<span class="s1">{</span>
  <span class="s1">NSString *fileName = RCTNilIfNull(stackFrame.file) ? [stackFrame.file lastPathComponent] : </span><span class="s4">@</span><span class="s3">&quot;&lt;unknown file&gt;&quot;</span><span class="s4">;</span>
  <span class="s1">NSString *lineInfo = [NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;%@:%lld&quot;</span><span class="s4">, </span><span class="s1">fileName</span><span class="s4">, </span><span class="s1">(</span><span class="s4">long long</span><span class="s1">)stackFrame.lineNumber]</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(stackFrame.column != </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s1">lineInfo = [lineInfo stringByAppendingFormat:</span><span class="s4">@</span><span class="s3">&quot;:%lld&quot;</span><span class="s4">, </span><span class="s1">(</span><span class="s4">long long</span><span class="s1">)stackFrame.column]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">lineInfo</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s2">#pragma </span><span class="s1">mark - TableView</span>

<span class="s1">- (NSInteger)numberOfSectionsInTableView:(__unused UITableView *)tableView</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s5">2</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (NSInteger)tableView:(__unused UITableView *)tableView numberOfRowsInSection:(NSInteger)section</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">section == </span><span class="s5">0 </span><span class="s1">? </span><span class="s5">1 </span><span class="s1">: _lastStackTrace.count</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(indexPath.section == </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s1">UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:</span><span class="s4">@</span><span class="s3">&quot;msg-cell&quot;</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">[self reuseCell:cell forErrorMessage:_lastErrorMessage]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:</span><span class="s4">@</span><span class="s3">&quot;cell&quot;</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">NSUInteger index = indexPath.row</span><span class="s4">;</span>
  <span class="s1">RCTJSStackFrame *stackFrame = _lastStackTrace[index]</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">[self reuseCell:cell forStackFrame:stackFrame]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (UITableViewCell *)reuseCell:(UITableViewCell *)cell forErrorMessage:(NSString *)message</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(!cell) {</span>
    <span class="s1">cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:</span><span class="s4">@</span><span class="s3">&quot;msg-cell&quot;</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">cell.textLabel.accessibilityIdentifier = </span><span class="s4">@</span><span class="s3">&quot;redbox-error&quot;</span><span class="s4">;</span>
    <span class="s1">cell.textLabel.textColor = [UIColor whiteColor]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(</span><span class="s4">@available</span><span class="s1">(iOS </span><span class="s5">13.0</span><span class="s4">, </span><span class="s1">*)) {</span>
      <span class="s0">// Prefer a monofont for formatting messages that were designed</span>
      <span class="s0">// to be displayed in a terminal.</span>
      <span class="s1">cell.textLabel.font = [UIFont monospacedSystemFontOfSize:</span><span class="s5">14 </span><span class="s1">weight:UIFontWeightBold]</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s1">cell.textLabel.font = [UIFont boldSystemFontOfSize:</span><span class="s5">14</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">cell.textLabel.lineBreakMode = NSLineBreakByWordWrapping</span><span class="s4">;</span>
    <span class="s1">cell.textLabel.numberOfLines = </span><span class="s5">0</span><span class="s4">;</span>
    <span class="s1">cell.detailTextLabel.textColor = [UIColor whiteColor]</span><span class="s4">;</span>
    <span class="s1">cell.backgroundColor = [UIColor colorWithRed:</span><span class="s5">0.82 </span><span class="s1">green:</span><span class="s5">0.10 </span><span class="s1">blue:</span><span class="s5">0.15 </span><span class="s1">alpha:</span><span class="s5">1.0</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">cell.selectionStyle = UITableViewCellSelectionStyleNone</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">cell.textLabel.text = message</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">cell</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (UITableViewCell *)reuseCell:(UITableViewCell *)cell forStackFrame:(RCTJSStackFrame *)stackFrame</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(!cell) {</span>
    <span class="s1">cell = [[UITableViewCell alloc] initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:</span><span class="s4">@</span><span class="s3">&quot;cell&quot;</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">cell.textLabel.font = [UIFont fontWithName:</span><span class="s4">@</span><span class="s3">&quot;Menlo-Regular&quot; </span><span class="s1">size:</span><span class="s5">14</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">cell.textLabel.lineBreakMode = NSLineBreakByCharWrapping</span><span class="s4">;</span>
    <span class="s1">cell.textLabel.numberOfLines = </span><span class="s5">2</span><span class="s4">;</span>
    <span class="s1">cell.detailTextLabel.textColor = [UIColor colorWithRed:</span><span class="s5">0.70 </span><span class="s1">green:</span><span class="s5">0.70 </span><span class="s1">blue:</span><span class="s5">0.70 </span><span class="s1">alpha:</span><span class="s5">1.0</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">cell.detailTextLabel.font = [UIFont fontWithName:</span><span class="s4">@</span><span class="s3">&quot;Menlo-Regular&quot; </span><span class="s1">size:</span><span class="s5">11</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">cell.detailTextLabel.lineBreakMode = NSLineBreakByTruncatingMiddle</span><span class="s4">;</span>
    <span class="s1">cell.backgroundColor = [UIColor clearColor]</span><span class="s4">;</span>
    <span class="s1">cell.selectedBackgroundView = [UIView </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">cell.selectedBackgroundView.backgroundColor = [UIColor colorWithWhite:</span><span class="s5">0 </span><span class="s1">alpha:</span><span class="s5">0.2</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">cell.textLabel.text = stackFrame.methodName ?: </span><span class="s4">@</span><span class="s3">&quot;(unnamed method)&quot;</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(stackFrame.file) {</span>
    <span class="s1">cell.detailTextLabel.text = [self formatFrameSource:stackFrame]</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">cell.detailTextLabel.text = </span><span class="s4">@</span><span class="s3">&quot;&quot;</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">cell.textLabel.textColor = stackFrame.collapse ? [UIColor lightGrayColor] : [UIColor whiteColor]</span><span class="s4">;</span>
  <span class="s1">cell.detailTextLabel.textColor = stackFrame.collapse ? [UIColor colorWithRed:</span><span class="s5">0.50 </span><span class="s1">green:</span><span class="s5">0.50 </span><span class="s1">blue:</span><span class="s5">0.50 </span><span class="s1">alpha:</span><span class="s5">1.0</span><span class="s1">]</span>
                                                       <span class="s1">: [UIColor colorWithRed:</span><span class="s5">0.70 </span><span class="s1">green:</span><span class="s5">0.70 </span><span class="s1">blue:</span><span class="s5">0.70 </span><span class="s1">alpha:</span><span class="s5">1.0</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">cell</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(indexPath.section == </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s1">NSMutableParagraphStyle *paragraphStyle = [[NSParagraphStyle defaultParagraphStyle] mutableCopy]</span><span class="s4">;</span>
    <span class="s1">paragraphStyle.lineBreakMode = NSLineBreakByWordWrapping</span><span class="s4">;</span>

    <span class="s1">NSDictionary *attributes =</span>
        <span class="s4">@</span><span class="s1">{NSFontAttributeName : [UIFont boldSystemFontOfSize:</span><span class="s5">16</span><span class="s1">]</span><span class="s4">, </span><span class="s1">NSParagraphStyleAttributeName : paragraphStyle}</span><span class="s4">;</span>
    <span class="s1">CGRect boundingRect =</span>
        <span class="s1">[_lastErrorMessage boundingRectWithSize:CGSizeMake(tableView.frame.size.width - </span><span class="s5">30</span><span class="s4">, </span><span class="s1">CGFLOAT_MAX)</span>
                                        <span class="s1">options:NSStringDrawingUsesLineFragmentOrigin</span>
                                     <span class="s1">attributes:attributes</span>
                                        <span class="s1">context:nil]</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">ceil(boundingRect.size.height) + </span><span class="s5">40</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s4">return </span><span class="s5">50</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(indexPath.section == </span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s1">NSUInteger row = indexPath.row</span><span class="s4">;</span>
    <span class="s1">RCTJSStackFrame *stackFrame = _lastStackTrace[row]</span><span class="s4">;</span>
    <span class="s1">[_actionDelegate redBoxWindow:self openStackFrameInEditor:stackFrame]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">[tableView deselectRowAtIndexPath:indexPath animated:YES]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s2">#pragma </span><span class="s1">mark - Key commands</span>

<span class="s1">- (NSArray&lt;UIKeyCommand *&gt; *)keyCommands</span>
<span class="s1">{</span>
  <span class="s0">// NOTE: We could use RCTKeyCommands for this, but since</span>
  <span class="s0">// we control this window, we can use the standard, non-hacky</span>
  <span class="s0">// mechanism instead</span>

  <span class="s4">return @</span><span class="s1">[</span>
    <span class="s0">// Dismiss red box</span>
    <span class="s1">[UIKeyCommand keyCommandWithInput:UIKeyInputEscape modifierFlags:</span><span class="s5">0 </span><span class="s1">action:</span><span class="s4">@selector</span><span class="s1">(dismiss)]</span><span class="s4">,</span>

    <span class="s0">// Reload</span>
    <span class="s1">[UIKeyCommand keyCommandWithInput:</span><span class="s4">@</span><span class="s3">&quot;r&quot; </span><span class="s1">modifierFlags:UIKeyModifierCommand action:</span><span class="s4">@selector</span><span class="s1">(reload)]</span><span class="s4">,</span>

    <span class="s0">// Copy = Cmd-Option C since Cmd-C in the simulator copies the pasteboard from</span>
    <span class="s0">// the simulator to the desktop pasteboard.</span>
    <span class="s1">[UIKeyCommand keyCommandWithInput:</span><span class="s4">@</span><span class="s3">&quot;c&quot;</span>
                        <span class="s1">modifierFlags:UIKeyModifierCommand | UIKeyModifierAlternate</span>
                               <span class="s1">action:</span><span class="s4">@selector</span><span class="s1">(copyStack)]</span><span class="s4">,</span>

    <span class="s0">// Extra data</span>
    <span class="s1">[UIKeyCommand keyCommandWithInput:</span><span class="s4">@</span><span class="s3">&quot;e&quot;</span>
                        <span class="s1">modifierFlags:UIKeyModifierCommand</span>
                               <span class="s1">action:</span><span class="s4">@selector</span><span class="s1">(showExtraDataViewController)]</span>
  <span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)canBecomeFirstResponder</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">YES</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s4">@interface </span><span class="s1">RCTRedBox () &lt;</span>
    <span class="s1">RCTInvalidating</span><span class="s4">,</span>
    <span class="s1">RCTRedBoxWindowActionDelegate</span><span class="s4">,</span>
    <span class="s1">RCTRedBoxExtraDataActionDelegate</span><span class="s4">,</span>
    <span class="s1">NativeRedBoxSpec&gt;</span>
<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTRedBox {</span>
  <span class="s1">RCTRedBoxWindow *_window</span><span class="s4">;</span>
  <span class="s1">NSMutableArray&lt;id&lt;RCTErrorCustomizer&gt;&gt; *_errorCustomizers</span><span class="s4">;</span>
  <span class="s1">RCTRedBoxExtraDataViewController *_extraDataViewController</span><span class="s4">;</span>
  <span class="s1">NSMutableArray&lt;NSString *&gt; *_customButtonTitles</span><span class="s4">;</span>
  <span class="s1">NSMutableArray&lt;RCTRedBoxButtonPressHandler&gt; *_customButtonHandlers</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@synthesize </span><span class="s1">bridge = _bridge</span><span class="s4">;</span>
<span class="s4">@synthesize </span><span class="s1">moduleRegistry = _moduleRegistry</span><span class="s4">;</span>
<span class="s4">@synthesize </span><span class="s1">bundleManager = _bundleManager</span><span class="s4">;</span>

<span class="s1">RCT_EXPORT_MODULE()</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)registerErrorCustomizer:(id&lt;RCTErrorCustomizer&gt;)errorCustomizer</span>
<span class="s1">{</span>
  <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s4">if </span><span class="s1">(!self-&gt;_errorCustomizers) {</span>
      <span class="s1">self-&gt;_errorCustomizers = [NSMutableArray array]</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s4">if </span><span class="s1">(![self-&gt;_errorCustomizers containsObject:errorCustomizer]) {</span>
      <span class="s1">[self-&gt;_errorCustomizers addObject:errorCustomizer]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">})</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s0">// WARNING: Should only be called from the main thread/dispatch queue.</span>
<span class="s1">- (RCTErrorInfo *)_customizeError:(RCTErrorInfo *)error</span>
<span class="s1">{</span>
  <span class="s1">RCTAssertMainQueue()</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(!self-&gt;_errorCustomizers) {</span>
    <span class="s4">return </span><span class="s1">error</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">for </span><span class="s1">(id&lt;RCTErrorCustomizer&gt; customizer in self-&gt;_errorCustomizers) {</span>
    <span class="s1">RCTErrorInfo *newInfo = [customizer customizeErrorInfo:error]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(newInfo) {</span>
      <span class="s1">error = newInfo</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">error</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showError:(NSError *)error</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:error.localizedDescription</span>
             <span class="s1">withDetails:error.localizedFailureReason</span>
                   <span class="s1">stack:error.userInfo[RCTJSStackTraceKey]</span>
             <span class="s1">errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message withParsedStack:nil isUpdate:NO errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withDetails:(NSString *)details</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message withDetails:details stack:nil errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message</span>
             <span class="s1">withDetails:(NSString *)details</span>
                   <span class="s1">stack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
             <span class="s1">errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s1">NSString *combinedMessage = message</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(details) {</span>
    <span class="s1">combinedMessage = [NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;%@</span><span class="s4">\n\n</span><span class="s3">%@&quot;</span><span class="s4">, </span><span class="s1">message</span><span class="s4">, </span><span class="s1">details]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">[self showErrorMessage:combinedMessage withParsedStack:stack isUpdate:NO errorCookie:errorCookie]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withRawStack:(NSString *)rawStack</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message withRawStack:rawStack errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withRawStack:(NSString *)rawStack errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s1">NSArray&lt;RCTJSStackFrame *&gt; *stack = [RCTJSStackFrame stackFramesWithLines:rawStack]</span><span class="s4">;</span>
  <span class="s1">[self showErrorMessage:message withParsedStack:stack isUpdate:NO errorCookie:errorCookie]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message withStack:stack errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack</span>
<span class="s1">{</span>
  <span class="s1">[self updateErrorMessage:message withStack:stack errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message</span>
         <span class="s1">withParsedStack:[RCTJSStackFrame stackFramesWithDictionaries:stack]</span>
                <span class="s1">isUpdate:NO</span>
             <span class="s1">errorCookie:errorCookie]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message</span>
         <span class="s1">withParsedStack:[RCTJSStackFrame stackFramesWithDictionaries:stack]</span>
                <span class="s1">isUpdate:YES</span>
             <span class="s1">errorCookie:errorCookie]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message withParsedStack:stack errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
<span class="s1">{</span>
  <span class="s1">[self updateErrorMessage:message withParsedStack:stack errorCookie:-</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message</span>
         <span class="s1">withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
             <span class="s1">errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message withParsedStack:stack isUpdate:NO errorCookie:errorCookie]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message</span>
           <span class="s1">withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
               <span class="s1">errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s1">[self showErrorMessage:message withParsedStack:stack isUpdate:YES errorCookie:errorCookie]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message</span>
         <span class="s1">withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
                <span class="s1">isUpdate:(BOOL)isUpdate</span>
             <span class="s1">errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
  <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s4">if </span><span class="s1">(self-&gt;_extraDataViewController == nil) {</span>
      <span class="s1">self-&gt;_extraDataViewController = [RCTRedBoxExtraDataViewController </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
      <span class="s1">self-&gt;_extraDataViewController.actionDelegate = self</span><span class="s4">;</span>
    <span class="s1">}</span>

<span class="s2">#pragma </span><span class="s1">clang diagnostic push</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic ignored </span><span class="s3">&quot;-Wdeprecated-declarations&quot;</span>
    <span class="s1">[[self-&gt;_moduleRegistry moduleForName:</span><span class="s3">&quot;EventDispatcher&quot;</span><span class="s1">] sendDeviceEventWithName:</span><span class="s4">@</span><span class="s3">&quot;collectRedBoxExtraData&quot;</span>
                                                                                <span class="s1">body:nil]</span><span class="s4">;</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic pop</span>

    <span class="s4">if </span><span class="s1">(!self-&gt;_window) {</span>
      <span class="s1">self-&gt;_window = [[RCTRedBoxWindow alloc] initWithFrame:[UIScreen mainScreen].bounds</span>
                                          <span class="s1">customButtonTitles:self-&gt;_customButtonTitles</span>
                                        <span class="s1">customButtonHandlers:self-&gt;_customButtonHandlers]</span><span class="s4">;</span>
      <span class="s1">self-&gt;_window.actionDelegate = self</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">RCTErrorInfo *errorInfo = [[RCTErrorInfo alloc] initWithErrorMessage:message stack:stack]</span><span class="s4">;</span>
    <span class="s1">errorInfo = [self _customizeError:errorInfo]</span><span class="s4">;</span>
    <span class="s1">[self-&gt;_window showErrorMessage:errorInfo.errorMessage</span>
                          <span class="s1">withStack:errorInfo.stack</span>
                           <span class="s1">isUpdate:isUpdate</span>
                        <span class="s1">errorCookie:errorCookie]</span><span class="s4">;</span>
  <span class="s1">})</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)loadExtraDataViewController</span>
<span class="s1">{</span>
  <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s0">// Make sure the CMD+E shortcut doesn't call this twice</span>
    <span class="s4">if </span><span class="s1">(self-&gt;_extraDataViewController != nil &amp;&amp; ![self-&gt;_window.rootViewController presentedViewController]) {</span>
      <span class="s1">[self-&gt;_window.rootViewController presentViewController:self-&gt;_extraDataViewController</span>
                                                     <span class="s1">animated:YES</span>
                                                   <span class="s1">completion:nil]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">})</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(setExtraData : (NSDictionary *)extraData forIdentifier : (NSString *)identifier)</span>
<span class="s1">{</span>
  <span class="s1">[_extraDataViewController addExtraData:extraData forIdentifier:identifier]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(dismiss)</span>
<span class="s1">{</span>
  <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s1">[self-&gt;_window dismiss]</span><span class="s4">;</span>
  <span class="s1">})</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)invalidate</span>
<span class="s1">{</span>
  <span class="s1">[self dismiss]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)redBoxWindow:(__unused RCTRedBoxWindow *)redBoxWindow openStackFrameInEditor:(RCTJSStackFrame *)stackFrame</span>
<span class="s1">{</span>
  <span class="s1">NSURL *</span><span class="s4">const </span><span class="s1">bundleURL = _overrideBundleURL ?: _bundleManager.bundleURL</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(![bundleURL.scheme hasPrefix:</span><span class="s4">@</span><span class="s3">&quot;http&quot;</span><span class="s1">]) {</span>
    <span class="s1">RCTLogWarn(</span><span class="s4">@</span><span class="s3">&quot;Cannot open stack frame in editor because you're not connected to the packager.&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">return;</span>
  <span class="s1">}</span>

  <span class="s1">NSData *stackFrameJSON = [RCTJSONStringify([stackFrame toDictionary]</span><span class="s4">, </span><span class="s1">NULL) dataUsingEncoding:NSUTF8StringEncoding]</span><span class="s4">;</span>
  <span class="s1">NSString *postLength = [NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;%tu&quot;</span><span class="s4">, </span><span class="s1">stackFrameJSON.length]</span><span class="s4">;</span>
  <span class="s1">NSMutableURLRequest *request = [NSMutableURLRequest </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">request.URL = [NSURL URLWithString:</span><span class="s4">@</span><span class="s3">&quot;/open-stack-frame&quot; </span><span class="s1">relativeToURL:bundleURL]</span><span class="s4">;</span>
  <span class="s1">request.HTTPMethod = </span><span class="s4">@</span><span class="s3">&quot;POST&quot;</span><span class="s4">;</span>
  <span class="s1">request.HTTPBody = stackFrameJSON</span><span class="s4">;</span>
  <span class="s1">[request setValue:postLength forHTTPHeaderField:</span><span class="s4">@</span><span class="s3">&quot;Content-Length&quot;</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">[request setValue:</span><span class="s4">@</span><span class="s3">&quot;application/json&quot; </span><span class="s1">forHTTPHeaderField:</span><span class="s4">@</span><span class="s3">&quot;Content-Type&quot;</span><span class="s1">]</span><span class="s4">;</span>

  <span class="s1">[[[NSURLSession sharedSession] dataTaskWithRequest:request] resume]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)reload</span>
<span class="s1">{</span>
  <span class="s0">// Window is not used and can be nil</span>
  <span class="s1">[self reloadFromRedBoxWindow:nil]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)reloadFromRedBoxWindow:(__unused RCTRedBoxWindow *)redBoxWindow</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(_overrideReloadAction) {</span>
    <span class="s1">_overrideReloadAction()</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">RCTTriggerReloadCommandListeners(</span><span class="s4">@</span><span class="s3">&quot;Redbox&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">[self dismiss]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)addCustomButton:(NSString *)title onPressHandler:(RCTRedBoxButtonPressHandler)handler</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(!_customButtonTitles) {</span>
    <span class="s1">_customButtonTitles = [NSMutableArray </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">_customButtonHandlers = [NSMutableArray </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">[_customButtonTitles addObject:title]</span><span class="s4">;</span>
  <span class="s1">[_customButtonHandlers addObject:handler]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:</span>
    <span class="s1">(</span><span class="s4">const </span><span class="s1">facebook::react::ObjCTurboModule::InitParams &amp;)params</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">std::make_shared&lt;facebook::react::NativeRedBoxSpecJSI&gt;(params)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTBridge (RCTRedBox)</span>

<span class="s1">- (RCTRedBox *)redBox</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">RCTRedBoxGetEnabled() ? [self moduleForClass:[RCTRedBox </span><span class="s4">class</span><span class="s1">]] : nil</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s2">#else </span><span class="s0">// Disabled</span>

<span class="s4">@interface </span><span class="s1">RCTRedBox () &lt;NativeRedBoxSpec&gt;</span>
<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTRedBox</span>

<span class="s1">+ (NSString *)moduleName</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">nil</span><span class="s4">;</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)registerErrorCustomizer:(id&lt;RCTErrorCustomizer&gt;)errorCustomizer</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showError:(NSError *)error</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withDetails:(NSString *)details</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withRawStack:(NSString *)rawStack</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withRawStack:(NSString *)rawStack errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message withStack:(NSArray&lt;NSDictionary *&gt; *)stack errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)showErrorMessage:(NSString *)message</span>
         <span class="s1">withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
             <span class="s1">errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateErrorMessage:(NSString *)message</span>
           <span class="s1">withParsedStack:(NSArray&lt;RCTJSStackFrame *&gt; *)stack</span>
               <span class="s1">errorCookie:(</span><span class="s4">int</span><span class="s1">)errorCookie</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setExtraData:(NSDictionary *)extraData forIdentifier:(NSString *)identifier</span>
<span class="s1">{</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)dismiss</span>
<span class="s1">{</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)addCustomButton:(NSString *)title onPressHandler:(RCTRedBoxButtonPressHandler)handler</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:</span>
    <span class="s1">(</span><span class="s4">const </span><span class="s1">facebook::react::ObjCTurboModule::InitParams &amp;)params</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">std::make_shared&lt;facebook::react::NativeRedBoxSpecJSI&gt;(params)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTBridge (RCTRedBox)</span>

<span class="s1">- (RCTRedBox *)redBox</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">nil</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s2">#endif</span>

<span class="s1">Class RCTRedBoxCls(</span><span class="s4">void</span><span class="s1">)</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">RCTRedBox.</span><span class="s4">class;</span>
<span class="s1">}</span>
</pre>
</body>
</html>