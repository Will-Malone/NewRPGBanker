<html>
<head>
<title>ReactPropertyProcessor.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #629755; font-weight: bold; font-style: italic;}
.s5 { color: #77b767; font-style: italic;}
.s6 { color: #6a8759;}
.s7 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ReactPropertyProcessor.java</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">package </span><span class="s1">com.facebook.react.processing</span><span class="s2">;</span>

<span class="s2">import static </span><span class="s1">javax.lang.model.element.Modifier.ABSTRACT</span><span class="s2">;</span>
<span class="s2">import static </span><span class="s1">javax.lang.model.element.Modifier.PRIVATE</span><span class="s2">;</span>
<span class="s2">import static </span><span class="s1">javax.lang.model.element.Modifier.PUBLIC</span><span class="s2">;</span>
<span class="s2">import static </span><span class="s1">javax.tools.Diagnostic.Kind.ERROR</span><span class="s2">;</span>
<span class="s2">import static </span><span class="s1">javax.tools.Diagnostic.Kind.WARNING</span><span class="s2">;</span>

<span class="s2">import </span><span class="s1">com.facebook.infer.annotation.SuppressFieldNotInitialized</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.Dynamic</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.DynamicFromObject</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.ReadableArray</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.ReadableMap</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.uimanager.annotations.ReactProp</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.uimanager.annotations.ReactPropGroup</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.uimanager.annotations.ReactPropertyHolder</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.yoga.YogaValue</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.ClassName</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.CodeBlock</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.JavaFile</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.MethodSpec</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.ParameterizedTypeName</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.TypeName</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.TypeSpec</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.squareup.javapoet.TypeVariableName</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.io.IOException</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.ArrayList</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Collections</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Comparator</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.HashMap</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.HashSet</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.List</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Map</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Set</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.Nullable</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.processing.AbstractProcessor</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.processing.Filer</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.processing.Messager</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.processing.ProcessingEnvironment</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.processing.RoundEnvironment</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.processing.SupportedAnnotationTypes</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.annotation.processing.SupportedSourceVersion</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.SourceVersion</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.element.Element</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.element.ElementKind</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.element.ExecutableElement</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.element.TypeElement</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.element.VariableElement</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.type.TypeMirror</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.util.Elements</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">javax.lang.model.util.Types</span><span class="s2">;</span>

<span class="s3">/**</span>
 <span class="s3">* This annotation processor crawls subclasses of ReactShadowNode and ViewManager and finds their</span>
 <span class="s3">* exported properties with the @ReactProp or @ReactGroupProp annotation. It generates a class per</span>
 <span class="s3">* shadow node/view manager that is named {</span><span class="s4">@code </span><span class="s5">&lt;classname&gt;</span><span class="s3">$$PropsSetter}. This class contains</span>
 <span class="s3">* methods to retrieve the name and type of all methods and a way to set these properties without</span>
 <span class="s3">* reflection.</span>
 <span class="s3">*/</span>
<span class="s1">@SupportedAnnotationTypes(</span><span class="s6">&quot;com.facebook.react.uimanager.annotations.ReactPropertyHolder&quot;</span><span class="s1">)</span>
<span class="s1">@SupportedSourceVersion(SourceVersion.RELEASE_7)</span>
<span class="s2">public class </span><span class="s1">ReactPropertyProcessor </span><span class="s2">extends </span><span class="s1">AbstractProcessor {</span>
  <span class="s2">private static final </span><span class="s1">Map&lt;TypeName</span><span class="s2">, </span><span class="s1">String&gt; DEFAULT_TYPES</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">Set&lt;TypeName&gt; BOXED_PRIMITIVES</span><span class="s2">;</span>

  <span class="s2">private static final </span><span class="s1">TypeName OBJECT_TYPE = TypeName.get(Object.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">TypeName STRING_TYPE = TypeName.get(String.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">TypeName READABLE_MAP_TYPE = TypeName.get(ReadableMap.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">TypeName READABLE_ARRAY_TYPE = TypeName.get(ReadableArray.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">TypeName DYNAMIC_TYPE = TypeName.get(Dynamic.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">TypeName DYNAMIC_FROM_OBJECT_TYPE = TypeName.get(DynamicFromObject.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">TypeName YOGA_VALUE_TYPE = TypeName.get(YogaValue.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>

  <span class="s2">private static final </span><span class="s1">TypeName VIEW_MANAGER_TYPE =</span>
      <span class="s1">ClassName.get(</span><span class="s6">&quot;com.facebook.react.uimanager&quot;</span><span class="s2">, </span><span class="s6">&quot;ViewManager&quot;</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">TypeName SHADOW_NODE_IMPL_TYPE =</span>
      <span class="s1">ClassName.get(</span><span class="s6">&quot;com.facebook.react.uimanager&quot;</span><span class="s2">, </span><span class="s6">&quot;ReactShadowNodeImpl&quot;</span><span class="s1">)</span><span class="s2">;</span>

  <span class="s2">private static final </span><span class="s1">ClassName VIEW_MANAGER_SETTER_TYPE =</span>
      <span class="s1">ClassName.get(</span>
          <span class="s6">&quot;com.facebook.react.uimanager&quot;</span><span class="s2">, </span><span class="s6">&quot;ViewManagerPropertyUpdater&quot;</span><span class="s2">, </span><span class="s6">&quot;ViewManagerSetter&quot;</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">ClassName SHADOW_NODE_SETTER_TYPE =</span>
      <span class="s1">ClassName.get(</span>
          <span class="s6">&quot;com.facebook.react.uimanager&quot;</span><span class="s2">, </span><span class="s6">&quot;ViewManagerPropertyUpdater&quot;</span><span class="s2">, </span><span class="s6">&quot;ShadowNodeSetter&quot;</span><span class="s1">)</span><span class="s2">;</span>

  <span class="s2">private static final </span><span class="s1">TypeName PROPERTY_MAP_TYPE =</span>
      <span class="s1">ParameterizedTypeName.get(Map.</span><span class="s2">class, </span><span class="s1">String.</span><span class="s2">class, </span><span class="s1">String.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>

  <span class="s2">private final </span><span class="s1">Map&lt;ClassName</span><span class="s2">, </span><span class="s1">ClassInfo&gt; mClasses</span><span class="s2">;</span>

  <span class="s1">@SuppressFieldNotInitialized </span><span class="s2">private </span><span class="s1">Filer mFiler</span><span class="s2">;</span>
  <span class="s1">@SuppressFieldNotInitialized </span><span class="s2">private </span><span class="s1">Messager mMessager</span><span class="s2">;</span>
  <span class="s1">@SuppressFieldNotInitialized </span><span class="s2">private </span><span class="s1">Elements mElements</span><span class="s2">;</span>
  <span class="s1">@SuppressFieldNotInitialized </span><span class="s2">private </span><span class="s1">Types mTypes</span><span class="s2">;</span>

  <span class="s2">static </span><span class="s1">{</span>
    <span class="s1">DEFAULT_TYPES = </span><span class="s2">new </span><span class="s1">HashMap&lt;&gt;()</span><span class="s2">;</span>

    <span class="s0">// Primitives</span>
    <span class="s1">DEFAULT_TYPES.put(TypeName.BOOLEAN</span><span class="s2">, </span><span class="s6">&quot;boolean&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(TypeName.DOUBLE</span><span class="s2">, </span><span class="s6">&quot;number&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(TypeName.FLOAT</span><span class="s2">, </span><span class="s6">&quot;number&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(TypeName.INT</span><span class="s2">, </span><span class="s6">&quot;number&quot;</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s0">// Boxed primitives</span>
    <span class="s1">DEFAULT_TYPES.put(TypeName.BOOLEAN.box()</span><span class="s2">, </span><span class="s6">&quot;boolean&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(TypeName.INT.box()</span><span class="s2">, </span><span class="s6">&quot;number&quot;</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s0">// Class types</span>
    <span class="s1">DEFAULT_TYPES.put(STRING_TYPE</span><span class="s2">, </span><span class="s6">&quot;String&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(READABLE_ARRAY_TYPE</span><span class="s2">, </span><span class="s6">&quot;Array&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(READABLE_MAP_TYPE</span><span class="s2">, </span><span class="s6">&quot;Map&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(DYNAMIC_TYPE</span><span class="s2">, </span><span class="s6">&quot;Dynamic&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">DEFAULT_TYPES.put(YOGA_VALUE_TYPE</span><span class="s2">, </span><span class="s6">&quot;YogaValue&quot;</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s1">BOXED_PRIMITIVES = </span><span class="s2">new </span><span class="s1">HashSet&lt;&gt;()</span><span class="s2">;</span>
    <span class="s1">BOXED_PRIMITIVES.add(TypeName.BOOLEAN.box())</span><span class="s2">;</span>
    <span class="s1">BOXED_PRIMITIVES.add(TypeName.FLOAT.box())</span><span class="s2">;</span>
    <span class="s1">BOXED_PRIMITIVES.add(TypeName.INT.box())</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">ReactPropertyProcessor() {</span>
    <span class="s1">mClasses = </span><span class="s2">new </span><span class="s1">HashMap&lt;&gt;()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public synchronized void </span><span class="s1">init(ProcessingEnvironment processingEnv) {</span>
    <span class="s2">super</span><span class="s1">.init(processingEnv)</span><span class="s2">;</span>

    <span class="s1">mFiler = processingEnv.getFiler()</span><span class="s2">;</span>
    <span class="s1">mMessager = processingEnv.getMessager()</span><span class="s2">;</span>
    <span class="s1">mElements = processingEnv.getElementUtils()</span><span class="s2">;</span>
    <span class="s1">mTypes = processingEnv.getTypeUtils()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public boolean </span><span class="s1">process(Set&lt;? </span><span class="s2">extends </span><span class="s1">TypeElement&gt; annotations</span><span class="s2">, </span><span class="s1">RoundEnvironment roundEnv) {</span>
    <span class="s0">// Clear properties from previous rounds</span>
    <span class="s1">mClasses.clear()</span><span class="s2">;</span>

    <span class="s1">Set&lt;? </span><span class="s2">extends </span><span class="s1">Element&gt; elements = roundEnv.getElementsAnnotatedWith(ReactPropertyHolder.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s2">for </span><span class="s1">(Element element : elements) {</span>
      <span class="s2">try </span><span class="s1">{</span>
        <span class="s1">TypeElement classType = (TypeElement) element</span><span class="s2">;</span>
        <span class="s1">ClassName className = ClassName.get(classType)</span><span class="s2">;</span>
        <span class="s1">mClasses.put(className</span><span class="s2">, </span><span class="s1">parseClass(className</span><span class="s2">, </span><span class="s1">classType))</span><span class="s2">;</span>
      <span class="s1">} </span><span class="s2">catch </span><span class="s1">(Exception e) {</span>
        <span class="s1">error(element</span><span class="s2">, </span><span class="s1">e.getMessage())</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">for </span><span class="s1">(ClassInfo classInfo : mClasses.values()) {</span>
      <span class="s2">try </span><span class="s1">{</span>
        <span class="s2">if </span><span class="s1">(!shouldIgnoreClass(classInfo)) {</span>
          <span class="s0">// Sort by name</span>
          <span class="s1">Collections.sort(</span>
              <span class="s1">classInfo.mProperties</span><span class="s2">,</span>
              <span class="s2">new </span><span class="s1">Comparator&lt;PropertyInfo&gt;() {</span>
                <span class="s1">@Override</span>
                <span class="s2">public int </span><span class="s1">compare(PropertyInfo a</span><span class="s2">, </span><span class="s1">PropertyInfo b) {</span>
                  <span class="s2">return </span><span class="s1">a.mProperty.name().compareTo(b.mProperty.name())</span><span class="s2">;</span>
                <span class="s1">}</span>
              <span class="s1">})</span><span class="s2">;</span>
          <span class="s1">generateCode(classInfo</span><span class="s2">, </span><span class="s1">classInfo.mProperties)</span><span class="s2">;</span>
        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(shouldWarnClass(classInfo)) {</span>
          <span class="s1">warning(classInfo.mElement</span><span class="s2">, </span><span class="s6">&quot;Class was skipped. Classes need to be non-private.&quot;</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s2">catch </span><span class="s1">(IOException e) {</span>
        <span class="s1">error(e.getMessage())</span><span class="s2">;</span>
      <span class="s1">} </span><span class="s2">catch </span><span class="s1">(ReactPropertyException e) {</span>
        <span class="s1">error(e.element</span><span class="s2">, </span><span class="s1">e.getMessage())</span><span class="s2">;</span>
      <span class="s1">} </span><span class="s2">catch </span><span class="s1">(Exception e) {</span>
        <span class="s1">error(classInfo.mElement</span><span class="s2">, </span><span class="s1">e.getMessage())</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">return true;</span>
  <span class="s1">}</span>

  <span class="s2">private static boolean </span><span class="s1">isShadowNodeType(TypeName typeName) {</span>
    <span class="s2">return </span><span class="s1">typeName.equals(SHADOW_NODE_IMPL_TYPE)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">ClassInfo parseClass(ClassName className</span><span class="s2">, </span><span class="s1">TypeElement typeElement) {</span>
    <span class="s1">TypeName targetType = getTargetType(typeElement.asType())</span><span class="s2">;</span>
    <span class="s1">TypeName viewType = isShadowNodeType(targetType) ? </span><span class="s2">null </span><span class="s1">: targetType</span><span class="s2">;</span>

    <span class="s1">ClassInfo classInfo = </span><span class="s2">new </span><span class="s1">ClassInfo(className</span><span class="s2">, </span><span class="s1">typeElement</span><span class="s2">, </span><span class="s1">viewType)</span><span class="s2">;</span>
    <span class="s1">findProperties(classInfo</span><span class="s2">, </span><span class="s1">typeElement)</span><span class="s2">;</span>

    <span class="s2">return </span><span class="s1">classInfo</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">findProperties(ClassInfo classInfo</span><span class="s2">, </span><span class="s1">TypeElement typeElement) {</span>
    <span class="s1">PropertyInfo.Builder propertyBuilder = </span><span class="s2">new </span><span class="s1">PropertyInfo.Builder(mTypes</span><span class="s2">, </span><span class="s1">mElements</span><span class="s2">, </span><span class="s1">classInfo)</span><span class="s2">;</span>

    <span class="s0">// Recursively search class hierarchy</span>
    <span class="s2">while </span><span class="s1">(typeElement != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">for </span><span class="s1">(Element element : typeElement.getEnclosedElements()) {</span>
        <span class="s1">ReactProp prop = element.getAnnotation(ReactProp.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s1">ReactPropGroup propGroup = element.getAnnotation(ReactPropGroup.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>

        <span class="s2">try </span><span class="s1">{</span>
          <span class="s2">if </span><span class="s1">(prop != </span><span class="s2">null </span><span class="s1">|| propGroup != </span><span class="s2">null</span><span class="s1">) {</span>
            <span class="s1">checkElement(element)</span><span class="s2">;</span>
          <span class="s1">}</span>

          <span class="s2">if </span><span class="s1">(prop != </span><span class="s2">null</span><span class="s1">) {</span>
            <span class="s1">classInfo.addProperty(propertyBuilder.build(element</span><span class="s2">, new </span><span class="s1">RegularProperty(prop)))</span><span class="s2">;</span>
          <span class="s1">} </span><span class="s2">else if </span><span class="s1">(propGroup != </span><span class="s2">null</span><span class="s1">) {</span>
            <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">i = </span><span class="s7">0</span><span class="s2">, </span><span class="s1">size = propGroup.names().length</span><span class="s2">; </span><span class="s1">i &lt; size</span><span class="s2">; </span><span class="s1">i++) {</span>
              <span class="s1">classInfo.addProperty(</span>
                  <span class="s1">propertyBuilder.build(element</span><span class="s2">, new </span><span class="s1">GroupProperty(propGroup</span><span class="s2">, </span><span class="s1">i)))</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">} </span><span class="s2">catch </span><span class="s1">(ReactPropertyException e) {</span>
          <span class="s1">error(e.element</span><span class="s2">, </span><span class="s1">e.getMessage())</span><span class="s2">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s1">typeElement = (TypeElement) mTypes.asElement(typeElement.getSuperclass())</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">TypeName getTargetType(TypeMirror mirror) {</span>
    <span class="s1">TypeName typeName = TypeName.get(mirror)</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(typeName </span><span class="s2">instanceof </span><span class="s1">ParameterizedTypeName) {</span>
      <span class="s1">ParameterizedTypeName parameterizedTypeName = (ParameterizedTypeName) typeName</span><span class="s2">;</span>
      <span class="s2">if </span><span class="s1">(parameterizedTypeName.rawType.equals(VIEW_MANAGER_TYPE)) {</span>
        <span class="s2">return </span><span class="s1">parameterizedTypeName.typeArguments.get(</span><span class="s7">0</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(isShadowNodeType(typeName)) {</span>
      <span class="s2">return </span><span class="s1">SHADOW_NODE_IMPL_TYPE</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(typeName.equals(TypeName.OBJECT)) {</span>
      <span class="s2">throw new </span><span class="s1">IllegalArgumentException(</span><span class="s6">&quot;Could not find target type &quot; </span><span class="s1">+ typeName)</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">List&lt;? </span><span class="s2">extends </span><span class="s1">TypeMirror&gt; types = mTypes.directSupertypes(mirror)</span><span class="s2">;</span>
    <span class="s2">return </span><span class="s1">getTargetType(types.get(</span><span class="s7">0</span><span class="s1">))</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">generateCode(ClassInfo classInfo</span><span class="s2">, </span><span class="s1">List&lt;PropertyInfo&gt; properties)</span>
      <span class="s2">throws </span><span class="s1">IOException</span><span class="s2">, </span><span class="s1">ReactPropertyException {</span>
    <span class="s1">MethodSpec getMethods =</span>
        <span class="s1">MethodSpec.methodBuilder(</span><span class="s6">&quot;getProperties&quot;</span><span class="s1">)</span>
            <span class="s1">.addModifiers(PUBLIC)</span>
            <span class="s1">.addAnnotation(Override.</span><span class="s2">class</span><span class="s1">)</span>
            <span class="s1">.addParameter(PROPERTY_MAP_TYPE</span><span class="s2">, </span><span class="s6">&quot;props&quot;</span><span class="s1">)</span>
            <span class="s1">.returns(TypeName.VOID)</span>
            <span class="s1">.addCode(generateGetProperties(properties))</span>
            <span class="s1">.build()</span><span class="s2">;</span>

    <span class="s1">TypeName superType = getSuperType(classInfo)</span><span class="s2">;</span>
    <span class="s1">ClassName className = classInfo.mClassName</span><span class="s2">;</span>

    <span class="s1">String holderClassName =</span>
        <span class="s1">getClassName((TypeElement) classInfo.mElement</span><span class="s2">, </span><span class="s1">className.packageName()) + </span><span class="s6">&quot;$$PropsSetter&quot;</span><span class="s2">;</span>
    <span class="s1">TypeSpec holderClass =</span>
        <span class="s1">TypeSpec.classBuilder(holderClassName)</span>
            <span class="s1">.addSuperinterface(superType)</span>
            <span class="s1">.addModifiers(PUBLIC)</span>
            <span class="s1">.addMethod(generateSetPropertySpec(classInfo</span><span class="s2">, </span><span class="s1">properties))</span>
            <span class="s1">.addMethod(getMethods)</span>
            <span class="s1">.build()</span><span class="s2">;</span>

    <span class="s1">JavaFile javaFile =</span>
        <span class="s1">JavaFile.builder(className.packageName()</span><span class="s2">, </span><span class="s1">holderClass)</span>
            <span class="s1">.addFileComment(</span><span class="s6">&quot;Generated by &quot; </span><span class="s1">+ getClass().getName())</span>
            <span class="s1">.build()</span><span class="s2">;</span>

    <span class="s1">javaFile.writeTo(mFiler)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">String getClassName(TypeElement type</span><span class="s2">, </span><span class="s1">String packageName) {</span>
    <span class="s2">int </span><span class="s1">packageLen = packageName.length() + </span><span class="s7">1</span><span class="s2">;</span>
    <span class="s2">return </span><span class="s1">type.getQualifiedName().toString().substring(packageLen).replace(</span><span class="s6">'.'</span><span class="s2">, </span><span class="s6">'$'</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">TypeName getSuperType(ClassInfo classInfo) {</span>
    <span class="s2">switch </span><span class="s1">(classInfo.getType()) {</span>
      <span class="s2">case </span><span class="s1">VIEW_MANAGER:</span>
        <span class="s2">return </span><span class="s1">ParameterizedTypeName.get(</span>
            <span class="s1">VIEW_MANAGER_SETTER_TYPE</span><span class="s2">, </span><span class="s1">classInfo.mClassName</span><span class="s2">, </span><span class="s1">classInfo.mViewType)</span><span class="s2">;</span>
      <span class="s2">case </span><span class="s1">SHADOW_NODE:</span>
        <span class="s2">return </span><span class="s1">ParameterizedTypeName.get(SHADOW_NODE_SETTER_TYPE</span><span class="s2">, </span><span class="s1">classInfo.mClassName)</span><span class="s2">;</span>
      <span class="s2">default</span><span class="s1">:</span>
        <span class="s2">throw new </span><span class="s1">IllegalArgumentException()</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">MethodSpec generateSetPropertySpec(</span>
      <span class="s1">ClassInfo classInfo</span><span class="s2">, </span><span class="s1">List&lt;PropertyInfo&gt; properties) {</span>
    <span class="s1">MethodSpec.Builder builder =</span>
        <span class="s1">MethodSpec.methodBuilder(</span><span class="s6">&quot;setProperty&quot;</span><span class="s1">)</span>
            <span class="s1">.addModifiers(PUBLIC)</span>
            <span class="s1">.addAnnotation(Override.</span><span class="s2">class</span><span class="s1">)</span>
            <span class="s1">.returns(TypeName.VOID)</span><span class="s2">;</span>

    <span class="s2">switch </span><span class="s1">(classInfo.getType()) {</span>
      <span class="s2">case </span><span class="s1">VIEW_MANAGER:</span>
        <span class="s1">builder</span>
            <span class="s1">.addParameter(classInfo.mClassName</span><span class="s2">, </span><span class="s6">&quot;manager&quot;</span><span class="s1">)</span>
            <span class="s1">.addParameter(classInfo.mViewType</span><span class="s2">, </span><span class="s6">&quot;view&quot;</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s2">break;</span>
      <span class="s2">case </span><span class="s1">SHADOW_NODE:</span>
        <span class="s1">builder.addParameter(classInfo.mClassName</span><span class="s2">, </span><span class="s6">&quot;node&quot;</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s2">break;</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s1">builder</span>
        <span class="s1">.addParameter(STRING_TYPE</span><span class="s2">, </span><span class="s6">&quot;name&quot;</span><span class="s1">)</span>
        <span class="s1">.addParameter(OBJECT_TYPE</span><span class="s2">, </span><span class="s6">&quot;value&quot;</span><span class="s1">)</span>
        <span class="s1">.addCode(generateSetProperty(classInfo</span><span class="s2">, </span><span class="s1">properties))</span>
        <span class="s1">.build()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">CodeBlock generateSetProperty(ClassInfo info</span><span class="s2">, </span><span class="s1">List&lt;PropertyInfo&gt; properties) {</span>
    <span class="s2">if </span><span class="s1">(properties.isEmpty()) {</span>
      <span class="s2">return </span><span class="s1">CodeBlock.builder().build()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">CodeBlock.Builder builder = CodeBlock.builder()</span><span class="s2">;</span>

    <span class="s1">builder.add(</span><span class="s6">&quot;switch (name) {</span><span class="s2">\n</span><span class="s6">&quot;</span><span class="s1">).indent()</span><span class="s2">;</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">int </span><span class="s1">i = </span><span class="s7">0</span><span class="s2">, </span><span class="s1">size = properties.size()</span><span class="s2">; </span><span class="s1">i &lt; size</span><span class="s2">; </span><span class="s1">i++) {</span>
      <span class="s1">PropertyInfo propertyInfo = properties.get(i)</span><span class="s2">;</span>
      <span class="s1">builder.add(</span><span class="s6">&quot;case </span><span class="s2">\&quot;</span><span class="s6">$L</span><span class="s2">\&quot;</span><span class="s6">:</span><span class="s2">\n</span><span class="s6">&quot;</span><span class="s2">, </span><span class="s1">propertyInfo.mProperty.name()).indent()</span><span class="s2">;</span>

      <span class="s2">switch </span><span class="s1">(info.getType()) {</span>
        <span class="s2">case </span><span class="s1">VIEW_MANAGER:</span>
          <span class="s1">builder.add(</span><span class="s6">&quot;manager.$L(view, &quot;</span><span class="s2">, </span><span class="s1">propertyInfo.methodName)</span><span class="s2">;</span>
          <span class="s2">break;</span>
        <span class="s2">case </span><span class="s1">SHADOW_NODE:</span>
          <span class="s1">builder.add(</span><span class="s6">&quot;node.$L(&quot;</span><span class="s2">, </span><span class="s1">propertyInfo.methodName)</span><span class="s2">;</span>
          <span class="s2">break;</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(propertyInfo.mProperty </span><span class="s2">instanceof </span><span class="s1">GroupProperty) {</span>
        <span class="s1">builder.add(</span><span class="s6">&quot;$L, &quot;</span><span class="s2">, </span><span class="s1">((GroupProperty) propertyInfo.mProperty).mGroupIndex)</span><span class="s2">;</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(BOXED_PRIMITIVES.contains(propertyInfo.propertyType)) {</span>
        <span class="s1">builder.add(</span><span class="s6">&quot;value == null ? null : &quot;</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s1">}</span>
      <span class="s1">getPropertyExtractor(info</span><span class="s2">, </span><span class="s1">propertyInfo</span><span class="s2">, </span><span class="s1">builder)</span><span class="s2">;</span>
      <span class="s1">builder.addStatement(</span><span class="s6">&quot;)&quot;</span><span class="s1">)</span><span class="s2">;</span>

      <span class="s1">builder.addStatement(</span><span class="s6">&quot;break&quot;</span><span class="s1">).unindent()</span><span class="s2">;</span>
    <span class="s1">}</span>
    <span class="s1">builder.unindent().add(</span><span class="s6">&quot;}</span><span class="s2">\n</span><span class="s6">&quot;</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s2">return </span><span class="s1">builder.build()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static void </span><span class="s1">getPropertyExtractor(</span>
      <span class="s1">ClassInfo classInfo</span><span class="s2">, </span><span class="s1">PropertyInfo info</span><span class="s2">, </span><span class="s1">CodeBlock.Builder builder) {</span>
    <span class="s1">TypeName propertyType = info.propertyType</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(propertyType.equals(STRING_TYPE)) {</span>
      <span class="s1">builder.add(</span><span class="s6">&quot;value instanceof $L ? ($L)value : null&quot;</span><span class="s2">, </span><span class="s1">STRING_TYPE</span><span class="s2">, </span><span class="s1">STRING_TYPE)</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(propertyType.equals(READABLE_ARRAY_TYPE)) {</span>
      <span class="s1">builder.add(</span>
          <span class="s6">&quot;value instanceof $L ? ($L)value : null&quot;</span><span class="s2">, </span><span class="s1">READABLE_ARRAY_TYPE</span><span class="s2">, </span><span class="s1">READABLE_ARRAY_TYPE)</span><span class="s2">;</span>
      <span class="s2">return; </span><span class="s0">// TODO: use real type but needs import</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(propertyType.equals(READABLE_MAP_TYPE)) {</span>
      <span class="s1">builder.add(</span><span class="s6">&quot;value instanceof $L ? ($L)value : null&quot;</span><span class="s2">, </span><span class="s1">READABLE_MAP_TYPE</span><span class="s2">, </span><span class="s1">READABLE_MAP_TYPE)</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(propertyType.equals(DYNAMIC_TYPE)) {</span>
      <span class="s1">builder.add(</span><span class="s6">&quot;new $L(value)&quot;</span><span class="s2">, </span><span class="s1">DYNAMIC_FROM_OBJECT_TYPE)</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(propertyType.equals(YOGA_VALUE_TYPE)) {</span>
      <span class="s1">builder.add(</span><span class="s6">&quot;$T.getDimension(value)&quot;</span><span class="s2">, </span><span class="s1">com.facebook.react.bridge.DimensionPropConverter.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(BOXED_PRIMITIVES.contains(propertyType)) {</span>
      <span class="s1">propertyType = propertyType.unbox()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(propertyType.equals(TypeName.BOOLEAN)) {</span>
      <span class="s1">builder.add(</span>
          <span class="s6">&quot;!(value instanceof Boolean) ? $L : (boolean)value&quot;</span><span class="s2">, </span><span class="s1">info.mProperty.defaultBoolean())</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(propertyType.equals(TypeName.DOUBLE)) {</span>
      <span class="s2">double </span><span class="s1">defaultDouble = info.mProperty.defaultDouble()</span><span class="s2">;</span>
      <span class="s2">if </span><span class="s1">(Double.isNaN(defaultDouble)) {</span>
        <span class="s1">builder.add(</span><span class="s6">&quot;!(value instanceof Double) ? $T.NaN : (double)value&quot;</span><span class="s2">, </span><span class="s1">Double.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s2">return;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s1">builder.add(</span><span class="s6">&quot;!(value instanceof Double) ? $Lf : (double)value&quot;</span><span class="s2">, </span><span class="s1">defaultDouble)</span><span class="s2">;</span>
        <span class="s2">return;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(propertyType.equals(TypeName.FLOAT)) {</span>
      <span class="s2">float </span><span class="s1">defaultFloat = info.mProperty.defaultFloat()</span><span class="s2">;</span>
      <span class="s2">if </span><span class="s1">(Float.isNaN(defaultFloat)) {</span>
        <span class="s1">builder.add(</span>
            <span class="s6">&quot;!(value instanceof Double) ? $T.NaN : ((Double)value).floatValue()&quot;</span><span class="s2">, </span><span class="s1">Float.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s2">return;</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s1">builder.add(</span>
            <span class="s6">&quot;!(value instanceof Double) ? $Lf : ((Double)value).floatValue()&quot;</span><span class="s2">, </span><span class="s1">defaultFloat)</span><span class="s2">;</span>
        <span class="s2">return;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s6">&quot;Color&quot;</span><span class="s1">.equals(info.mProperty.customType())) {</span>
      <span class="s2">switch </span><span class="s1">(classInfo.getType()) {</span>
        <span class="s2">case </span><span class="s1">VIEW_MANAGER:</span>
          <span class="s1">builder.add(</span>
              <span class="s6">&quot;value == null ? $L : $T.getColor(value, view.getContext(), $L)&quot;</span><span class="s2">,</span>
              <span class="s1">info.mProperty.defaultInt()</span><span class="s2">,</span>
              <span class="s1">com.facebook.react.bridge.ColorPropConverter.</span><span class="s2">class,</span>
              <span class="s1">info.mProperty.defaultInt())</span><span class="s2">;</span>
          <span class="s2">return;</span>
        <span class="s2">case </span><span class="s1">SHADOW_NODE:</span>
          <span class="s1">builder.add(</span>
              <span class="s6">&quot;value == null ? $L : $T.getColor(value, node.getThemedContext(), $L)&quot;</span><span class="s2">,</span>
              <span class="s1">info.mProperty.defaultInt()</span><span class="s2">,</span>
              <span class="s1">com.facebook.react.bridge.ColorPropConverter.</span><span class="s2">class,</span>
              <span class="s1">info.mProperty.defaultInt())</span><span class="s2">;</span>
          <span class="s2">return;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(propertyType.equals(TypeName.INT)) {</span>
      <span class="s1">builder.add(</span>
          <span class="s6">&quot;!(value instanceof Double) ? $L : ((Double)value).intValue()&quot;</span><span class="s2">,</span>
          <span class="s1">info.mProperty.defaultInt())</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s2">throw new </span><span class="s1">IllegalArgumentException()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">CodeBlock generateGetProperties(List&lt;PropertyInfo&gt; properties)</span>
      <span class="s2">throws </span><span class="s1">ReactPropertyException {</span>
    <span class="s1">CodeBlock.Builder builder = CodeBlock.builder()</span><span class="s2">;</span>
    <span class="s2">for </span><span class="s1">(PropertyInfo propertyInfo : properties) {</span>
      <span class="s2">try </span><span class="s1">{</span>
        <span class="s1">String typeName = getPropertyTypeName(propertyInfo.mProperty</span><span class="s2">, </span><span class="s1">propertyInfo.propertyType)</span><span class="s2">;</span>
        <span class="s1">builder.addStatement(</span><span class="s6">&quot;props.put($S, $S)&quot;</span><span class="s2">, </span><span class="s1">propertyInfo.mProperty.name()</span><span class="s2">, </span><span class="s1">typeName)</span><span class="s2">;</span>
      <span class="s1">} </span><span class="s2">catch </span><span class="s1">(IllegalArgumentException e) {</span>
        <span class="s2">throw new </span><span class="s1">ReactPropertyException(e.getMessage()</span><span class="s2">, </span><span class="s1">propertyInfo)</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s1">builder.build()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">String getPropertyTypeName(Property property</span><span class="s2">, </span><span class="s1">TypeName propertyType) {</span>
    <span class="s1">String defaultType = DEFAULT_TYPES.get(propertyType)</span><span class="s2">;</span>
    <span class="s1">String useDefaultType =</span>
        <span class="s1">property </span><span class="s2">instanceof </span><span class="s1">RegularProperty</span>
            <span class="s1">? ReactProp.USE_DEFAULT_TYPE</span>
            <span class="s1">: ReactPropGroup.USE_DEFAULT_TYPE</span><span class="s2">;</span>
    <span class="s2">return </span><span class="s1">useDefaultType.equals(property.customType()) ? defaultType : property.customType()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static void </span><span class="s1">checkElement(Element element) </span><span class="s2">throws </span><span class="s1">ReactPropertyException {</span>
    <span class="s2">if </span><span class="s1">(element.getKind() == ElementKind.METHOD &amp;&amp; element.getModifiers().contains(PUBLIC)) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s2">throw new </span><span class="s1">ReactPropertyException(</span>
        <span class="s6">&quot;@ReactProp and @ReachPropGroup annotation must be on a public method&quot;</span><span class="s2">, </span><span class="s1">element)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static boolean </span><span class="s1">shouldIgnoreClass(ClassInfo classInfo) {</span>
    <span class="s2">return </span><span class="s1">classInfo.mElement.getModifiers().contains(PRIVATE)</span>
        <span class="s1">|| classInfo.mElement.getModifiers().contains(ABSTRACT)</span>
        <span class="s1">|| classInfo.mViewType </span><span class="s2">instanceof </span><span class="s1">TypeVariableName</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static boolean </span><span class="s1">shouldWarnClass(ClassInfo classInfo) {</span>
    <span class="s2">return </span><span class="s1">classInfo.mElement.getModifiers().contains(PRIVATE)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">error(Element element</span><span class="s2">, </span><span class="s1">String message) {</span>
    <span class="s1">mMessager.printMessage(ERROR</span><span class="s2">, </span><span class="s1">message</span><span class="s2">, </span><span class="s1">element)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">error(String message) {</span>
    <span class="s1">mMessager.printMessage(ERROR</span><span class="s2">, </span><span class="s1">message)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">warning(Element element</span><span class="s2">, </span><span class="s1">String message) {</span>
    <span class="s1">mMessager.printMessage(WARNING</span><span class="s2">, </span><span class="s1">message</span><span class="s2">, </span><span class="s1">element)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private interface </span><span class="s1">Property {</span>
    <span class="s1">String name()</span><span class="s2">;</span>

    <span class="s1">String customType()</span><span class="s2">;</span>

    <span class="s2">double </span><span class="s1">defaultDouble()</span><span class="s2">;</span>

    <span class="s2">float </span><span class="s1">defaultFloat()</span><span class="s2">;</span>

    <span class="s2">int </span><span class="s1">defaultInt()</span><span class="s2">;</span>

    <span class="s2">boolean </span><span class="s1">defaultBoolean()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static class </span><span class="s1">RegularProperty </span><span class="s2">implements </span><span class="s1">Property {</span>
    <span class="s2">private final </span><span class="s1">ReactProp mProp</span><span class="s2">;</span>

    <span class="s2">public </span><span class="s1">RegularProperty(ReactProp prop) {</span>
      <span class="s1">mProp = prop</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public </span><span class="s1">String name() {</span>
      <span class="s2">return </span><span class="s1">mProp.name()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public </span><span class="s1">String customType() {</span>
      <span class="s2">return </span><span class="s1">mProp.customType()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public double </span><span class="s1">defaultDouble() {</span>
      <span class="s2">return </span><span class="s1">mProp.defaultDouble()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public float </span><span class="s1">defaultFloat() {</span>
      <span class="s2">return </span><span class="s1">mProp.defaultFloat()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public int </span><span class="s1">defaultInt() {</span>
      <span class="s2">return </span><span class="s1">mProp.defaultInt()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public boolean </span><span class="s1">defaultBoolean() {</span>
      <span class="s2">return </span><span class="s1">mProp.defaultBoolean()</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private static class </span><span class="s1">GroupProperty </span><span class="s2">implements </span><span class="s1">Property {</span>
    <span class="s2">private final </span><span class="s1">ReactPropGroup mProp</span><span class="s2">;</span>
    <span class="s2">private final int </span><span class="s1">mGroupIndex</span><span class="s2">;</span>

    <span class="s2">public </span><span class="s1">GroupProperty(ReactPropGroup prop</span><span class="s2">, int </span><span class="s1">groupIndex) {</span>
      <span class="s1">mProp = prop</span><span class="s2">;</span>
      <span class="s1">mGroupIndex = groupIndex</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public </span><span class="s1">String name() {</span>
      <span class="s2">return </span><span class="s1">mProp.names()[mGroupIndex]</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public </span><span class="s1">String customType() {</span>
      <span class="s2">return </span><span class="s1">mProp.customType()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public double </span><span class="s1">defaultDouble() {</span>
      <span class="s2">return </span><span class="s1">mProp.defaultDouble()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public float </span><span class="s1">defaultFloat() {</span>
      <span class="s2">return </span><span class="s1">mProp.defaultFloat()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public int </span><span class="s1">defaultInt() {</span>
      <span class="s2">return </span><span class="s1">mProp.defaultInt()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">@Override</span>
    <span class="s2">public boolean </span><span class="s1">defaultBoolean() {</span>
      <span class="s2">throw new </span><span class="s1">UnsupportedOperationException()</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private enum </span><span class="s1">SettableType {</span>
    <span class="s1">VIEW_MANAGER</span><span class="s2">,</span>
    <span class="s1">SHADOW_NODE</span>
  <span class="s1">}</span>

  <span class="s2">private static class </span><span class="s1">ClassInfo {</span>
    <span class="s2">public final </span><span class="s1">ClassName mClassName</span><span class="s2">;</span>
    <span class="s2">public final </span><span class="s1">Element mElement</span><span class="s2">;</span>
    <span class="s2">public final </span><span class="s1">@Nullable TypeName mViewType</span><span class="s2">;</span>
    <span class="s2">public final </span><span class="s1">List&lt;PropertyInfo&gt; mProperties</span><span class="s2">;</span>

    <span class="s2">public </span><span class="s1">ClassInfo(ClassName className</span><span class="s2">, </span><span class="s1">TypeElement element</span><span class="s2">, </span><span class="s1">@Nullable TypeName viewType) {</span>
      <span class="s1">mClassName = className</span><span class="s2">;</span>
      <span class="s1">mElement = element</span><span class="s2">;</span>
      <span class="s1">mViewType = viewType</span><span class="s2">;</span>
      <span class="s1">mProperties = </span><span class="s2">new </span><span class="s1">ArrayList&lt;&gt;()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">public </span><span class="s1">SettableType getType() {</span>
      <span class="s2">return </span><span class="s1">mViewType == </span><span class="s2">null </span><span class="s1">? SettableType.SHADOW_NODE : SettableType.VIEW_MANAGER</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">public void </span><span class="s1">addProperty(PropertyInfo propertyInfo) </span><span class="s2">throws </span><span class="s1">ReactPropertyException {</span>
      <span class="s1">String name = propertyInfo.mProperty.name()</span><span class="s2">;</span>
      <span class="s2">if </span><span class="s1">(checkPropertyExists(name)) {</span>
        <span class="s2">throw new </span><span class="s1">ReactPropertyException(</span>
            <span class="s6">&quot;Module &quot;</span>
                <span class="s1">+ mClassName</span>
                <span class="s1">+ </span><span class="s6">&quot; has already registered a property named </span><span class="s2">\&quot;</span><span class="s6">&quot;</span>
                <span class="s1">+ name</span>
                <span class="s1">+ </span><span class="s6">&quot;</span><span class="s2">\&quot;</span><span class="s6">. If you want to override a property, don't add&quot;</span>
                <span class="s1">+ </span><span class="s6">&quot; the @ReactProp annotation to the property in the subclass&quot;</span><span class="s2">,</span>
            <span class="s1">propertyInfo)</span><span class="s2">;</span>
      <span class="s1">}</span>

      <span class="s1">mProperties.add(propertyInfo)</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">private boolean </span><span class="s1">checkPropertyExists(String name) {</span>
      <span class="s2">for </span><span class="s1">(PropertyInfo propertyInfo : mProperties) {</span>
        <span class="s2">if </span><span class="s1">(propertyInfo.mProperty.name().equals(name)) {</span>
          <span class="s2">return true;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s2">return false;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private static class </span><span class="s1">PropertyInfo {</span>
    <span class="s2">public final </span><span class="s1">String methodName</span><span class="s2">;</span>
    <span class="s2">public final </span><span class="s1">TypeName propertyType</span><span class="s2">;</span>
    <span class="s2">public final </span><span class="s1">Element element</span><span class="s2">;</span>
    <span class="s2">public final </span><span class="s1">Property mProperty</span><span class="s2">;</span>

    <span class="s2">private </span><span class="s1">PropertyInfo(</span>
        <span class="s1">String methodName</span><span class="s2">, </span><span class="s1">TypeName propertyType</span><span class="s2">, </span><span class="s1">Element element</span><span class="s2">, </span><span class="s1">Property property) {</span>
      <span class="s2">this</span><span class="s1">.methodName = methodName</span><span class="s2">;</span>
      <span class="s2">this</span><span class="s1">.propertyType = propertyType</span><span class="s2">;</span>
      <span class="s2">this</span><span class="s1">.element = element</span><span class="s2">;</span>
      <span class="s1">mProperty = property</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">public static class </span><span class="s1">Builder {</span>
      <span class="s2">private final </span><span class="s1">Types mTypes</span><span class="s2">;</span>
      <span class="s2">private final </span><span class="s1">Elements mElements</span><span class="s2">;</span>
      <span class="s2">private final </span><span class="s1">ClassInfo mClassInfo</span><span class="s2">;</span>

      <span class="s2">public </span><span class="s1">Builder(Types types</span><span class="s2">, </span><span class="s1">Elements elements</span><span class="s2">, </span><span class="s1">ClassInfo classInfo) {</span>
        <span class="s1">mTypes = types</span><span class="s2">;</span>
        <span class="s1">mElements = elements</span><span class="s2">;</span>
        <span class="s1">mClassInfo = classInfo</span><span class="s2">;</span>
      <span class="s1">}</span>

      <span class="s2">public </span><span class="s1">PropertyInfo build(Element element</span><span class="s2">, </span><span class="s1">Property property) </span><span class="s2">throws </span><span class="s1">ReactPropertyException {</span>
        <span class="s1">String methodName = element.getSimpleName().toString()</span><span class="s2">;</span>

        <span class="s1">ExecutableElement method = (ExecutableElement) element</span><span class="s2">;</span>
        <span class="s1">List&lt;? </span><span class="s2">extends </span><span class="s1">VariableElement&gt; parameters = method.getParameters()</span><span class="s2">;</span>

        <span class="s2">if </span><span class="s1">(parameters.size() != getArgCount(mClassInfo.getType()</span><span class="s2">, </span><span class="s1">property)) {</span>
          <span class="s2">throw new </span><span class="s1">ReactPropertyException(</span><span class="s6">&quot;Wrong number of args&quot;</span><span class="s2">, </span><span class="s1">element)</span><span class="s2">;</span>
        <span class="s1">}</span>

        <span class="s2">int </span><span class="s1">index = </span><span class="s7">0</span><span class="s2">;</span>
        <span class="s2">if </span><span class="s1">(mClassInfo.getType() == SettableType.VIEW_MANAGER) {</span>
          <span class="s1">TypeMirror mirror = parameters.get(index++).asType()</span><span class="s2">;</span>
          <span class="s2">if </span><span class="s1">(!mTypes.isSubtype(mirror</span><span class="s2">, </span><span class="s1">mElements.getTypeElement(</span><span class="s6">&quot;android.view.View&quot;</span><span class="s1">).asType())) {</span>
            <span class="s2">throw new </span><span class="s1">ReactPropertyException(</span><span class="s6">&quot;First argument must be a subclass of View&quot;</span><span class="s2">, </span><span class="s1">element)</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">if </span><span class="s1">(property </span><span class="s2">instanceof </span><span class="s1">GroupProperty) {</span>
          <span class="s1">TypeName indexType = TypeName.get(parameters.get(index++).asType())</span><span class="s2">;</span>
          <span class="s2">if </span><span class="s1">(!indexType.equals(TypeName.INT)) {</span>
            <span class="s2">throw new </span><span class="s1">ReactPropertyException(</span>
                <span class="s6">&quot;Argument &quot; </span><span class="s1">+ index + </span><span class="s6">&quot; must be an int for @ReactPropGroup&quot;</span><span class="s2">, </span><span class="s1">element)</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s1">TypeName propertyType = TypeName.get(parameters.get(index++).asType())</span><span class="s2">;</span>
        <span class="s2">if </span><span class="s1">(!DEFAULT_TYPES.containsKey(propertyType)) {</span>
          <span class="s2">throw new </span><span class="s1">ReactPropertyException(</span>
              <span class="s6">&quot;Argument &quot; </span><span class="s1">+ index + </span><span class="s6">&quot; must be of a supported type&quot;</span><span class="s2">, </span><span class="s1">element)</span><span class="s2">;</span>
        <span class="s1">}</span>

        <span class="s2">return new </span><span class="s1">PropertyInfo(methodName</span><span class="s2">, </span><span class="s1">propertyType</span><span class="s2">, </span><span class="s1">element</span><span class="s2">, </span><span class="s1">property)</span><span class="s2">;</span>
      <span class="s1">}</span>

      <span class="s2">private static int </span><span class="s1">getArgCount(SettableType type</span><span class="s2">, </span><span class="s1">Property property) {</span>
        <span class="s2">int </span><span class="s1">baseCount = type == SettableType.SHADOW_NODE ? </span><span class="s7">1 </span><span class="s1">: </span><span class="s7">2</span><span class="s2">;</span>
        <span class="s2">return </span><span class="s1">property </span><span class="s2">instanceof </span><span class="s1">GroupProperty ? baseCount + </span><span class="s7">1 </span><span class="s1">: baseCount</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private static class </span><span class="s1">ReactPropertyException </span><span class="s2">extends </span><span class="s1">Exception {</span>
    <span class="s2">public final </span><span class="s1">Element element</span><span class="s2">;</span>

    <span class="s2">public </span><span class="s1">ReactPropertyException(String message</span><span class="s2">, </span><span class="s1">PropertyInfo propertyInfo) {</span>
      <span class="s2">super</span><span class="s1">(message)</span><span class="s2">;</span>
      <span class="s2">this</span><span class="s1">.element = propertyInfo.element</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">public </span><span class="s1">ReactPropertyException(String message</span><span class="s2">, </span><span class="s1">Element element) {</span>
      <span class="s2">super</span><span class="s1">(message)</span><span class="s2">;</span>
      <span class="s2">this</span><span class="s1">.element = element</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>