<html>
<head>
<title>utils-test.rb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #a9b7c6;}
.s5 { color: #ffc66d;}
.s6 { color: #9876aa; font-style: italic;}
.s7 { color: #6897bb; font-style: italic;}
.s8 { color: #cc7832; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
utils-test.rb</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This source code is licensed under the MIT license found in the</span>
<span class="s0"># LICENSE file in the root directory of this source tree.</span>

<span class="s2">require </span><span class="s3">&quot;test/unit&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;../utils.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;../flipper.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/PodMock.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/InstallerMock.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/EnvironmentMock.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/SysctlCheckerMock.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/FileMock.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/systemUtils.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/PathnameMock.rb&quot;</span>
<span class="s2">require_relative </span><span class="s3">&quot;./test_utils/TargetDefinitionMock.rb&quot;</span>

<span class="s2">class </span><span class="s4">UtilsTests </span><span class="s2">&lt; </span><span class="s4">Test::Unit::TestCase</span>
    <span class="s2">def </span><span class="s5">setup</span>
        <span class="s4">@base_path </span><span class="s2">= </span><span class="s3">&quot;~/app/ios&quot;</span>
        <span class="s1">Pathname.pwd!(</span><span class="s4">@base_path</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">teardown</span>
        <span class="s1">FileMock.reset()</span>
        <span class="s1">Pod::UI.reset()</span>
        <span class="s1">Pathname.reset()</span>
        <span class="s1">Pod::Config.reset()</span>
        <span class="s1">SysctlChecker.reset()</span>
        <span class="s1">Environment.reset()</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'0'</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_HERMES'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'1'</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_FRAMEWORKS'</span><span class="s1">] </span><span class="s2">= </span><span class="s6">nil</span>
        <span class="s1">system_reset_commands 
    </span><span class="s2">end</span>

    <span class="s0"># ======================= #</span>
    <span class="s0"># TEST - warnIfNotOnArm64 #</span>
    <span class="s0"># ======================= #</span>

    <span class="s2">def </span><span class="s5">test_warnIfNotOnArm64_whenSysctlReturnsNot1_printsNothing</span>
        <span class="s0"># Arrange</span>
        <span class="s1">SysctlChecker.set_call_sysctl_arm64_return_value(</span><span class="s7">23</span><span class="s1">)</span>
        <span class="s1">Environment.set_ruby_platform(</span><span class="s3">&quot;something&quot;</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.warn_if_not_on_arm64()</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [])</span>
        <span class="s1">assert_equal(Pod::UI.collected_warns, [])</span>

    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_warnIfNotOnArm64_whenSysctlReturns1AndRubyIncludeArm64_printsNothing</span>
        <span class="s0"># Arrange</span>
        <span class="s1">SysctlChecker.set_call_sysctl_arm64_return_value(</span><span class="s7">1</span><span class="s1">)</span>
        <span class="s1">Environment.set_ruby_platform(</span><span class="s3">&quot;arm64-darwin21&quot;</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.warn_if_not_on_arm64()</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [])</span>
        <span class="s1">assert_equal(Pod::UI.collected_warns, [])</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_warnIfNotOnArm64_whenSysctlReturns1AndRubyNotIncludeArm64_warns</span>
        <span class="s0"># Arrange</span>
        <span class="s1">SysctlChecker.set_call_sysctl_arm64_return_value(</span><span class="s7">1</span><span class="s1">)</span>
        <span class="s1">Environment.set_ruby_platform(</span><span class="s3">&quot;something else&quot;</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.warn_if_not_on_arm64()</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [])</span>
        <span class="s1">assert_equal(Pod::UI.collected_warns, [</span>
            <span class="s3">'Do not use &quot;pod install&quot; from inside Rosetta2 (x86_64 emulation on arm64).'</span><span class="s1">,</span>
            <span class="s3">' - Emulated x86_64 is slower than native arm64'</span><span class="s1">,</span>
            <span class="s3">' - May result in mixed architectures in rubygems (eg: ffi_c.bundle files may be x86_64 with an arm64 interpreter)'</span><span class="s1">,</span>
            <span class="s3">'Run &quot;env /usr/bin/arch -arm64 /bin/bash --login&quot; then try again.'</span><span class="s1">,</span>
        <span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s0"># ====================== #</span>
    <span class="s0"># TEST - getDefaultFlags #</span>
    <span class="s0"># ====================== #</span>
    <span class="s2">def </span><span class="s5">test_getDefaultFlag_whenOldArchitecture</span><span class="s1">()</span>
        <span class="s0"># Arrange</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'0'</span>

        <span class="s0"># Act</span>
        <span class="s1">flags </span><span class="s2">= </span><span class="s1">ReactNativePodsUtils.get_default_flags()</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(flags, {</span>
            <span class="s6">:fabric_enabled </span><span class="s1">=&gt; </span><span class="s6">false</span><span class="s1">,</span>
            <span class="s6">:hermes_enabled </span><span class="s1">=&gt; </span><span class="s6">true</span><span class="s1">,</span>
            <span class="s6">:flipper_configuration </span><span class="s1">=&gt; FlipperConfiguration.disabled 
        })</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_getDefaultFlag_whenOldArchitectureButHermesDisabled</span><span class="s1">()</span>
        <span class="s0"># Arrange</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'0'</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_HERMES'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'0'</span>

        <span class="s0"># Act</span>
        <span class="s1">flags </span><span class="s2">= </span><span class="s1">ReactNativePodsUtils.get_default_flags()</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(flags, {</span>
            <span class="s6">:fabric_enabled </span><span class="s1">=&gt; </span><span class="s6">false</span><span class="s1">,</span>
            <span class="s6">:hermes_enabled </span><span class="s1">=&gt; </span><span class="s6">false</span><span class="s1">,</span>
            <span class="s6">:flipper_configuration </span><span class="s1">=&gt; FlipperConfiguration.disabled 
        })</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_getDefaultFlag_whenNewArchitecture</span><span class="s1">()</span>
        <span class="s0"># Arrange</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'1'</span>

        <span class="s0"># Act</span>
        <span class="s1">flags </span><span class="s2">= </span><span class="s1">ReactNativePodsUtils.get_default_flags()</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(flags, {</span>
            <span class="s6">:fabric_enabled </span><span class="s1">=&gt; </span><span class="s6">true</span><span class="s1">,</span>
            <span class="s6">:hermes_enabled </span><span class="s1">=&gt; </span><span class="s6">true</span><span class="s1">,</span>
            <span class="s6">:flipper_configuration </span><span class="s1">=&gt; FlipperConfiguration.disabled 
        })</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_getDefaultFlag_whenNewArchitectureButHermesDisabled</span><span class="s1">()</span>
        <span class="s0"># Arrange</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'1'</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_HERMES'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'0'</span>

        <span class="s0"># Act</span>
        <span class="s1">flags </span><span class="s2">= </span><span class="s1">ReactNativePodsUtils.get_default_flags()</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(flags, {</span>
            <span class="s6">:fabric_enabled </span><span class="s1">=&gt; </span><span class="s6">true</span><span class="s1">,</span>
            <span class="s6">:hermes_enabled </span><span class="s1">=&gt; </span><span class="s6">false</span><span class="s1">,</span>
            <span class="s6">:flipper_configuration </span><span class="s1">=&gt; FlipperConfiguration.disabled 
        })</span>
    <span class="s2">end</span>

    <span class="s0"># ============== #</span>
    <span class="s0"># TEST - has_pod #</span>
    <span class="s0"># ============== #</span>
    <span class="s2">def </span><span class="s5">test_hasPod_whenInstallerDoesNotHavePod_returnFalse</span>
        <span class="s0"># Arrange</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(PodsProjectMock.</span><span class="s2">new</span><span class="s1">([], {</span><span class="s3">&quot;other_pod&quot; </span><span class="s1">=&gt; {}}))</span>

        <span class="s0"># Act</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">ReactNativePodsUtils.has_pod(installer, </span><span class="s3">&quot;some_pod&quot;</span><span class="s1">)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(result, </span><span class="s6">false</span><span class="s1">)</span>

    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_hasPod_whenInstallerHasPod_returnTrue</span>
        <span class="s0"># Arrange</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(PodsProjectMock.</span><span class="s2">new</span><span class="s1">([], {</span><span class="s3">&quot;some_pod&quot; </span><span class="s1">=&gt; {}}))</span>

        <span class="s0"># Act</span>
        <span class="s1">result </span><span class="s2">= </span><span class="s1">ReactNativePodsUtils.has_pod(installer, </span><span class="s3">&quot;some_pod&quot;</span><span class="s1">)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(result, </span><span class="s6">true</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s0"># ============================ #</span>
    <span class="s0"># Test - Exclude Architectures #</span>
    <span class="s0"># ============================ #</span>
    <span class="s2">def </span><span class="s5">test_excludeArchitectures_whenHermesEngineIsNotIncluded_excludeNothing</span>
        <span class="s0"># Arrange</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">prepare_empty_user_project_mock()</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">()</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(PodsProjectMock.</span><span class="s2">new</span><span class="s1">(), [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.exclude_i386_architecture_while_using_hermes(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;EXCLUDED_ARCHS[sdk=iphonesimulator*]&quot;</span><span class="s1">], </span><span class="s3">&quot;&quot;</span><span class="s1">)</span>
        <span class="s2">end</span>
        <span class="s1">assert_equal(user_project_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(pods_projects_mock.save_invocation_count, </span><span class="s7">0</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_excludeArchitectures_whenHermesEngineIsIncluded_excludeI386</span>
        <span class="s0"># Arrange</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">prepare_empty_user_project_mock()</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}})</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.exclude_i386_architecture_while_using_hermes(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;EXCLUDED_ARCHS[sdk=iphonesimulator*]&quot;</span><span class="s1">], </span><span class="s3">&quot;i386&quot;</span><span class="s1">)</span>
        <span class="s2">end</span>

        <span class="s1">assert_equal(user_project_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(pods_projects_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s0"># ================= #</span>
    <span class="s0"># Test - Fix Config #</span>
    <span class="s0"># ================= #</span>

    <span class="s2">def </span><span class="s5">test_fixLibrarySearchPath_whenThereIsNoSearchPaths_doNothing</span>
        <span class="s0"># Arrange</span>
        <span class="s1">buildConfig </span><span class="s2">= </span><span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.fix_library_search_path(buildConfig)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_nil(buildConfig.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_fixLibrarySearchPath_whenThereAreSearchPathsAndSwiftUnescaped_removesSwift5_5</span>
        <span class="s0"># Arrange</span>
        <span class="s1">buildConfig </span><span class="s2">= </span><span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">, {</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot; </span><span class="s1">=&gt; [</span>
            <span class="s3">&quot;$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)&quot;</span><span class="s1">,</span>
            <span class="s3">&quot;</span><span class="s8">\&quot;</span><span class="s3">$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)</span><span class="s8">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
            <span class="s3">&quot;$(SDKROOT)/usr/lib/swift&quot;</span>
        <span class="s1">]})</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.fix_library_search_path(buildConfig)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(buildConfig.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">], [</span><span class="s3">&quot;$(SDKROOT)/usr/lib/swift&quot;</span><span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_fixLibrarySearchPath_whenThereAreSearchPathsAndSwiftEscaped_removesSwift5_5</span>
        <span class="s0"># Arrange</span>
        <span class="s1">buildConfig </span><span class="s2">= </span><span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">, {</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot; </span><span class="s1">=&gt; [</span>
            <span class="s3">&quot;$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)&quot;</span><span class="s1">,</span>
            <span class="s3">&quot;</span><span class="s8">\&quot;</span><span class="s3">$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)</span><span class="s8">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
            <span class="s3">&quot;another/path&quot;</span><span class="s1">,</span>
            <span class="s3">&quot;</span><span class="s8">\&quot;</span><span class="s3">$(SDKROOT)/usr/lib/swift</span><span class="s8">\&quot;</span><span class="s3">&quot;</span>
        <span class="s1">]})</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.fix_library_search_path(buildConfig)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(buildConfig.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">], [</span><span class="s3">&quot;another/path&quot;</span><span class="s1">, </span><span class="s3">&quot;</span><span class="s8">\&quot;</span><span class="s3">$(SDKROOT)/usr/lib/swift</span><span class="s8">\&quot;</span><span class="s3">&quot;</span><span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_fixLibrarySearchPath_whenThereAreSearchPathsAndNoSwift_removesSwift5_5AndAddsSwiftAsFirst</span>
        <span class="s0"># Arrange</span>
        <span class="s1">buildConfig </span><span class="s2">= </span><span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">, {</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot; </span><span class="s1">=&gt; [</span>
            <span class="s3">&quot;another/path&quot;</span>
        <span class="s1">]})</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.fix_library_search_path(buildConfig)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(buildConfig.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">], [</span><span class="s3">&quot;$(SDKROOT)/usr/lib/swift&quot;</span><span class="s1">, </span><span class="s3">&quot;another/path&quot;</span><span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s0"># ============================== #</span>
    <span class="s0"># Test - Fix Library Search Path #</span>
    <span class="s0"># ============================== #</span>

    <span class="s2">def </span><span class="s5">test_fixLibrarySearchPaths_correctlySetsTheSearchPathsForAllProjects</span>
        <span class="s1">first_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;FirstTarget&quot;</span><span class="s1">)</span>
        <span class="s1">second_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;SecondTarget&quot;</span><span class="s1">)</span>
        <span class="s1">third_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;ThirdTarget&quot;</span><span class="s1">)</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
            <span class="s1">],</span>
            <span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
                <span class="s1">first_target,</span>
                <span class="s1">second_target 
            ]</span>
        <span class="s1">)</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}}, </span><span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
            <span class="s1">third_target 
        ])</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.fix_library_search_paths(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">], [</span>
                <span class="s3">&quot;$(SDKROOT)/usr/lib/swift&quot;</span><span class="s1">, </span><span class="s3">&quot;another/path&quot;</span>
            <span class="s1">])</span>
        <span class="s2">end</span>

        <span class="s1">user_project_mock.native_targets.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">target</span><span class="s1">|</span>
            <span class="s1">target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
                <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">], [</span>
                    <span class="s3">&quot;$(SDKROOT)/usr/lib/swift&quot;</span><span class="s1">, </span><span class="s3">&quot;another/path&quot;</span>
                <span class="s1">])</span>
            <span class="s2">end</span>
        <span class="s2">end</span>

        <span class="s1">pods_projects_mock.native_targets.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">target</span><span class="s1">|</span>
            <span class="s1">target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
                <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">], [</span>
                    <span class="s3">&quot;$(SDKROOT)/usr/lib/swift&quot;</span><span class="s1">, </span><span class="s3">&quot;another/path&quot;</span>
                <span class="s1">])</span>
            <span class="s2">end</span>
        <span class="s2">end</span>

        <span class="s1">assert_equal(user_project_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(pods_projects_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s0"># ===================================== #</span>
    <span class="s0"># Test - Apply Xcode14 React-Core patch #</span>
    <span class="s0"># ===================================== #</span>

    <span class="s2">def </span><span class="s5">test_turnOffResourceBundleReactCore_correctlyAppliesPatch</span>
        <span class="s0"># Arrange</span>
        <span class="s1">react_core_target </span><span class="s2">= </span><span class="s1">TargetMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'React-Core'</span><span class="s1">)</span>
        <span class="s1">react_core_target_native_target </span><span class="s2">= </span><span class="s1">react_core_target 
        react_core_debug_config </span><span class="s2">= </span><span class="s1">prepare_Code_Signing_build_configuration(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">, </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>
        <span class="s1">react_core_release_config </span><span class="s2">= </span><span class="s1">prepare_Code_Signing_build_configuration(</span><span class="s3">&quot;Release&quot;</span><span class="s1">, </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>

        <span class="s1">hermes_engine_target </span><span class="s2">= </span><span class="s1">TargetMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'hermes-engine'</span><span class="s1">)</span>
        <span class="s1">hermes_engine_target_native_target </span><span class="s2">= </span><span class="s1">hermes_engine_target 
        hermes_engine_debug_config </span><span class="s2">= </span><span class="s1">prepare_Code_Signing_build_configuration(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">, </span><span class="s3">&quot;NO&quot;</span><span class="s1">)</span>
        <span class="s1">hermes_engine_release_config </span><span class="s2">= </span><span class="s1">prepare_Code_Signing_build_configuration(</span><span class="s3">&quot;Release&quot;</span><span class="s1">, </span><span class="s3">&quot;NO&quot;</span><span class="s1">)</span>

        <span class="s1">assets_target </span><span class="s2">= </span><span class="s1">TargetMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'assets'</span><span class="s1">)</span>
        <span class="s1">assets_target_native_target </span><span class="s2">= </span><span class="s1">assets_target 
        assets_debug_config </span><span class="s2">= </span><span class="s1">prepare_Code_Signing_build_configuration(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">, </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>
        <span class="s1">assets_release_config </span><span class="s2">= </span><span class="s1">prepare_Code_Signing_build_configuration(</span><span class="s3">&quot;Release&quot;</span><span class="s1">, </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>

        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s6">pod_target_installation_results: </span><span class="s1">{</span>
            <span class="s3">'React-Core'</span><span class="s1">:</span>
                <span class="s1">TargetInstallationResultMock.</span><span class="s2">new</span><span class="s1">(</span>
                    <span class="s1">react_core_target,</span>
                    <span class="s1">react_core_target_native_target,</span>
                    <span class="s1">[TargetMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'React-Core'</span><span class="s1">,[react_core_debug_config, react_core_release_config])]</span>
                <span class="s1">),</span>
            <span class="s3">'hermes-engine'</span><span class="s1">:</span>
                <span class="s1">TargetInstallationResultMock.</span><span class="s2">new</span><span class="s1">(</span>
                    <span class="s1">hermes_engine_target,</span>
                    <span class="s1">hermes_engine_target_native_target,</span>
                    <span class="s1">[TargetMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'hermes-engine'</span><span class="s1">,[hermes_engine_debug_config, hermes_engine_release_config])]</span>
                <span class="s1">),</span>
            <span class="s3">'assets'</span><span class="s1">:</span>
                <span class="s1">TargetInstallationResultMock.</span><span class="s2">new</span><span class="s1">(</span>
                    <span class="s1">assets_target,</span>
                    <span class="s1">assets_target_native_target,</span>
                    <span class="s1">[TargetMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'assets'</span><span class="s1">,[assets_debug_config, assets_release_config])]</span>
                <span class="s1">),</span>
        <span class="s1">})</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.turn_off_resource_bundle_react_core(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s0"># these must have changed</span>
        <span class="s1">assert_equal(react_core_debug_config.build_settings[</span><span class="s3">&quot;CODE_SIGNING_ALLOWED&quot;</span><span class="s1">], </span><span class="s3">&quot;NO&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(react_core_release_config.build_settings[</span><span class="s3">&quot;CODE_SIGNING_ALLOWED&quot;</span><span class="s1">], </span><span class="s3">&quot;NO&quot;</span><span class="s1">)</span>
        <span class="s0"># these needs to stay the same</span>
        <span class="s1">assert_equal(hermes_engine_debug_config.build_settings[</span><span class="s3">&quot;CODE_SIGNING_ALLOWED&quot;</span><span class="s1">], </span><span class="s3">&quot;NO&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(hermes_engine_release_config.build_settings[</span><span class="s3">&quot;CODE_SIGNING_ALLOWED&quot;</span><span class="s1">], </span><span class="s3">&quot;NO&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(assets_debug_config.build_settings[</span><span class="s3">&quot;CODE_SIGNING_ALLOWED&quot;</span><span class="s1">], </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(assets_release_config.build_settings[</span><span class="s3">&quot;CODE_SIGNING_ALLOWED&quot;</span><span class="s1">], </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s0"># ================================= #</span>
    <span class="s0"># Test - Apply Mac Catalyst Patches #</span>
    <span class="s0"># ================================= #</span>

    <span class="s2">def </span><span class="s5">test_applyMacCatalystPatches_correctlyAppliesNecessaryPatches</span>
        <span class="s1">first_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;FirstTarget&quot;</span><span class="s1">)</span>
        <span class="s1">second_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;SecondTarget&quot;</span><span class="s1">)</span>
        <span class="s1">third_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;ThirdTarget&quot;</span><span class="s1">, </span><span class="s3">&quot;com.apple.product-type.bundle&quot;</span><span class="s1">)</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
            <span class="s1">],</span>
            <span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
                <span class="s1">first_target,</span>
                <span class="s1">second_target 
            ]</span>
        <span class="s1">)</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([third_target], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}}, </span><span class="s6">:native_targets </span><span class="s1">=&gt; [])</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.apply_mac_catalyst_patches(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s1">first_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
          <span class="s1">assert_nil(config.build_settings[</span><span class="s3">&quot;CODE_SIGN_IDENTITY[sdk=macosx*]&quot;</span><span class="s1">])</span>
        <span class="s2">end</span>

        <span class="s1">second_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
          <span class="s1">assert_nil(config.build_settings[</span><span class="s3">&quot;CODE_SIGN_IDENTITY[sdk=macosx*]&quot;</span><span class="s1">])</span>
        <span class="s2">end</span>

        <span class="s1">third_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
          <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;CODE_SIGN_IDENTITY[sdk=macosx*]&quot;</span><span class="s1">], </span><span class="s3">&quot;-&quot;</span><span class="s1">)</span>
        <span class="s2">end</span>

        <span class="s1">user_project_mock.native_targets.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">target</span><span class="s1">|</span>
            <span class="s1">target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
                <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;DEAD_CODE_STRIPPING&quot;</span><span class="s1">], </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>
                <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;PRESERVE_DEAD_CODE_INITS_AND_TERMS&quot;</span><span class="s1">], </span><span class="s3">&quot;YES&quot;</span><span class="s1">)</span>
                <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot;</span><span class="s1">], [</span><span class="s3">&quot;$(SDKROOT)/usr/lib/swift&quot;</span><span class="s1">, </span><span class="s3">&quot;$(SDKROOT)/System/iOSSupport/usr/lib/swift&quot;</span><span class="s1">, </span><span class="s3">&quot;$(inherited)&quot;</span><span class="s1">])</span>
            <span class="s2">end</span>
        <span class="s2">end</span>

        <span class="s1">assert_equal(user_project_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s0"># ================================= #</span>
    <span class="s0"># Test - Apply Xcode 15 Patch       #</span>
    <span class="s0"># ================================= #</span>

    <span class="s2">def </span><span class="s5">test_applyXcode15Patch_correctlyAppliesNecessaryPatch</span>
        <span class="s0"># Arrange</span>
        <span class="s1">first_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;FirstTarget&quot;</span><span class="s1">)</span>
        <span class="s1">second_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;SecondTarget&quot;</span><span class="s1">)</span>
        <span class="s1">third_target </span><span class="s2">= </span><span class="s1">TargetMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;ThirdTarget&quot;</span><span class="s1">, [</span>
            <span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">, {</span>
              <span class="s3">&quot;GCC_PREPROCESSOR_DEFINITIONS&quot; </span><span class="s1">=&gt; </span><span class="s3">'$(inherited) &quot;SomeFlag=1&quot; '</span>
            <span class="s1">}),</span>
            <span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Release&quot;</span><span class="s1">, {</span>
              <span class="s3">&quot;GCC_PREPROCESSOR_DEFINITIONS&quot; </span><span class="s1">=&gt; </span><span class="s3">'$(inherited) &quot;SomeFlag=1&quot; '</span>
            <span class="s1">}),</span>
        <span class="s1">], </span><span class="s6">nil</span><span class="s1">)</span>

        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
            <span class="s1">],</span>
            <span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
                <span class="s1">first_target,</span>
                <span class="s1">second_target 
            ]</span>
        <span class="s1">)</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}}, </span><span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
            <span class="s1">third_target 
        ])</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.apply_xcode_15_patch(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s1">first_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;GCC_PREPROCESSOR_DEFINITIONS&quot;</span><span class="s1">].strip,</span>
                <span class="s3">'$(inherited) &quot;_LIBCPP_ENABLE_CXX17_REMOVED_UNARY_BINARY_FUNCTION&quot;'</span>
            <span class="s1">)</span>
        <span class="s2">end</span>
        <span class="s1">second_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;GCC_PREPROCESSOR_DEFINITIONS&quot;</span><span class="s1">].strip,</span>
                <span class="s3">'$(inherited) &quot;_LIBCPP_ENABLE_CXX17_REMOVED_UNARY_BINARY_FUNCTION&quot;'</span>
            <span class="s1">)</span>
        <span class="s2">end</span>
        <span class="s1">third_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;GCC_PREPROCESSOR_DEFINITIONS&quot;</span><span class="s1">].strip,</span>
                <span class="s3">'$(inherited) &quot;SomeFlag=1&quot; &quot;_LIBCPP_ENABLE_CXX17_REMOVED_UNARY_BINARY_FUNCTION&quot;'</span>
            <span class="s1">)</span>
        <span class="s2">end</span>
    <span class="s2">end</span>

    <span class="s0"># ==================================== #</span>
    <span class="s0"># Test - Set Node_Modules User Setting #</span>
    <span class="s0"># ==================================== #</span>

    <span class="s2">def </span><span class="s5">test_setNodeModulesUserSettings_addTheUserSetting</span>
        <span class="s0"># Arrange</span>
        <span class="s1">react_native_path </span><span class="s2">= </span><span class="s3">&quot;react_native/node_modules&quot;</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">prepare_empty_user_project_mock()</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}})</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.set_node_modules_user_settings(installer, react_native_path)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;REACT_NATIVE_PATH&quot;</span><span class="s1">], </span><span class="s3">&quot;${PODS_ROOT}/../#{react_native_path}&quot;</span><span class="s1">)</span>
        <span class="s2">end</span>

        <span class="s1">assert_equal(user_project_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(pods_projects_mock.save_invocation_count, </span><span class="s7">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [</span><span class="s3">&quot;Setting REACT_NATIVE build settings&quot;</span><span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s0"># =================================== #</span>
    <span class="s0"># Test - Prepare React Native Project #</span>
    <span class="s0"># =================================== #</span>
    <span class="s2">def </span><span class="s5">test_createXcodeEnvIfMissing_whenItIsPresent_doNothing</span>
        <span class="s0"># Arrange</span>
        <span class="s1">FileMock.mocked_existing_files(</span><span class="s3">&quot;/.xcode.env&quot;</span><span class="s1">)</span>
        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.create_xcode_env_if_missing(</span><span class="s6">file_manager: </span><span class="s4">FileMock</span><span class="s1">)</span>
        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(FileMock.exist_invocation_params, [</span><span class="s3">&quot;/.xcode.env&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(</span><span class="s4">$collected_commands</span><span class="s1">, [])</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_createXcodeEnvIfMissing_whenItIsNotPresent_createsIt</span>
        <span class="s0"># Arrange</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.create_xcode_env_if_missing(</span><span class="s6">file_manager: </span><span class="s4">FileMock</span><span class="s1">)</span>
        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(FileMock.exist_invocation_params, [</span><span class="s3">&quot;/.xcode.env&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(</span><span class="s4">$collected_commands</span><span class="s1">, [</span><span class="s3">&quot;echo 'export NODE_BINARY=$(command -v node)' &gt; /.xcode.env&quot;</span><span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s0"># ============================ #</span>
    <span class="s0"># Test - Detect Use Frameworks #</span>
    <span class="s0"># ============================ #</span>
    <span class="s2">def </span><span class="s5">test_detectUseFrameworks_whenEnvAlreadySet_DoesNothing</span>
        <span class="s0"># Arrange</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_FRAMEWORKS'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'static'</span>
        <span class="s1">target_definition </span><span class="s2">= </span><span class="s1">TargetDefinitionMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'something'</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.detect_use_frameworks(target_definition)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [])</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_detectUseFrameworks_whenEnvNotSetAndNotUsed_setEnvVarToNil</span>
        <span class="s0"># Arrange</span>
        <span class="s1">target_definition </span><span class="s2">= </span><span class="s1">TargetDefinitionMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'static library'</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.detect_use_frameworks(target_definition)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [</span><span class="s3">&quot;Framework build type is static library&quot;</span><span class="s1">])</span>
        <span class="s1">assert_nil(</span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_FRAMEWORKS'</span><span class="s1">])</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_detectUseFrameworks_whenEnvNotSetAndStaticFrameworks_setEnvVarToStatic</span>
        <span class="s0"># Arrange</span>
        <span class="s1">target_definition </span><span class="s2">= </span><span class="s1">TargetDefinitionMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'static framework'</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.detect_use_frameworks(target_definition)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [</span><span class="s3">&quot;Framework build type is static framework&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(</span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_FRAMEWORKS'</span><span class="s1">], </span><span class="s3">'static'</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_detectUseFrameworks_whenEnvNotSetAndDynamicFrameworks_setEnvVarToDynamic</span>
        <span class="s0"># Arrange</span>
        <span class="s1">target_definition </span><span class="s2">= </span><span class="s1">TargetDefinitionMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">'dynamic framework'</span><span class="s1">)</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.detect_use_frameworks(target_definition)</span>

        <span class="s0"># Assert</span>
        <span class="s1">assert_equal(Pod::UI.collected_messages, [</span><span class="s3">&quot;Framework build type is dynamic framework&quot;</span><span class="s1">])</span>
        <span class="s1">assert_equal(</span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_FRAMEWORKS'</span><span class="s1">], </span><span class="s3">'dynamic'</span><span class="s1">)</span>
    <span class="s2">end</span>

    <span class="s0"># ============================ #</span>
    <span class="s0"># Test - Update Search Paths   #</span>
    <span class="s0"># ============================ #</span>
    <span class="s2">def </span><span class="s5">test_updateSearchPaths_whenUseFrameworks_addsSearchPaths</span>
        <span class="s0"># Arrange</span>
        <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_FRAMEWORKS'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'static'</span>
        <span class="s1">first_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;FirstTarget&quot;</span><span class="s1">)</span>
        <span class="s1">second_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;SecondTarget&quot;</span><span class="s1">, </span><span class="s6">nil</span><span class="s1">, [</span>
            <span class="s1">DependencyMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;RCT-Folly&quot;</span><span class="s1">),</span>
            <span class="s1">DependencyMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;React-Codegen&quot;</span><span class="s1">),</span>
            <span class="s1">DependencyMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;ReactCommon&quot;</span><span class="s1">),</span>
            <span class="s1">DependencyMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;React-RCTFabric&quot;</span><span class="s1">),</span>
            <span class="s1">DependencyMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;React-ImageManager&quot;</span><span class="s1">),</span>
        <span class="s1">])</span>
        <span class="s1">third_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;ThirdTarget&quot;</span><span class="s1">, </span><span class="s3">&quot;com.apple.product-type.bundle&quot;</span><span class="s1">)</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
            <span class="s1">],</span>
            <span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
                <span class="s1">first_target,</span>
                <span class="s1">second_target 
            ]</span>
        <span class="s1">)</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([third_target], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}})</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.update_search_paths(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">received_search_path </span><span class="s2">= </span><span class="s1">config.build_settings[</span><span class="s3">&quot;HEADER_SEARCH_PATHS&quot;</span><span class="s1">]</span>
            <span class="s1">expected_search_path </span><span class="s2">= </span><span class="s3">&quot;$(inherited) ${PODS_CONFIGURATION_BUILD_DIR}/ReactCommon-Samples/ReactCommon_Samples.framework/Headers ${PODS_CONFIGURATION_BUILD_DIR}/ReactCommon/ReactCommon.framework/Headers/react/nativemodule/core ${PODS_CONFIGURATION_BUILD_DIR}/ReactCommon-Samples/ReactCommon_Samples.framework/Headers/platform/ios ${PODS_CONFIGURATION_BUILD_DIR}/React-NativeModulesApple/React_NativeModulesApple.framework/Headers ${PODS_CONFIGURATION_BUILD_DIR}/React-graphics/React_graphics.framework/Headers/react/renderer/graphics/platform/ios&quot;</span>
            <span class="s1">assert_equal(expected_search_path, received_search_path)</span>
        <span class="s2">end</span>

        <span class="s1">installer.target_installation_results.pod_target_installation_results.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">pod_name</span><span class="s1">, </span><span class="s4">target_installation_result</span><span class="s1">|</span>
            <span class="s2">if </span><span class="s1">pod_name </span><span class="s2">== </span><span class="s3">&quot;SecondTarget&quot;</span>
                <span class="s1">target_installation_result.native_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
                    <span class="s1">received_search_path </span><span class="s2">= </span><span class="s1">config.build_settings[</span><span class="s3">&quot;HEADER_SEARCH_PATHS&quot;</span><span class="s1">]</span>
                    <span class="s1">expected_Search_path </span><span class="s2">= </span><span class="s3">&quot;$(inherited) </span><span class="s8">\&quot;</span><span class="s3">$(PODS_ROOT)/RCT-Folly</span><span class="s8">\&quot; \&quot;</span><span class="s3">$(PODS_ROOT)/DoubleConversion</span><span class="s8">\&quot; \&quot;</span><span class="s3">$(PODS_ROOT)/boost</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/React-Codegen/React_Codegen.framework/Headers</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/ReactCommon/ReactCommon.framework/Headers</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/ReactCommon/ReactCommon.framework/Headers/react/nativemodule/core</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/React-RCTFabric/RCTFabric.framework/Headers</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/React-Fabric/React_Fabric.framework/Headers</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/React-Graphics/React_graphics.framework/Headers</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/React-Graphics/React_graphics.framework/Headers/react/renderer/graphics/platform/ios</span><span class="s8">\&quot; \&quot;</span><span class="s3">${PODS_CONFIGURATION_BUILD_DIR}/React-Fabric/React_Fabric.framework/Headers/react/renderer/imagemanager/platform/ios</span><span class="s8">\&quot;</span><span class="s3">&quot;</span>
                    <span class="s1">assert_equal(received_search_path, expected_Search_path)</span>
                <span class="s2">end</span>
            <span class="s2">else</span>
                <span class="s1">target_installation_result.native_target.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
                    <span class="s1">assert_nil(config.build_settings[</span><span class="s3">&quot;HEADER_SEARCH_PATHS&quot;</span><span class="s1">])</span>
                <span class="s2">end</span>
            <span class="s2">end</span>
        <span class="s2">end</span>
    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_updateSearchPaths_whenNotUseFrameworks_addsSearchPaths</span>
        <span class="s0"># Arrange</span>
        <span class="s1">first_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;FirstTarget&quot;</span><span class="s1">)</span>
        <span class="s1">second_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;SecondTarget&quot;</span><span class="s1">)</span>
        <span class="s1">third_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;ThirdTarget&quot;</span><span class="s1">, </span><span class="s3">&quot;com.apple.product-type.bundle&quot;</span><span class="s1">)</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
            <span class="s1">],</span>
            <span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
                <span class="s1">first_target,</span>
                <span class="s1">second_target 
            ]</span>
        <span class="s1">)</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([third_target], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}})</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.update_search_paths(installer)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_nil(config.build_settings[</span><span class="s3">&quot;HEADER_SEARCH_PATHS&quot;</span><span class="s1">])</span>
        <span class="s2">end</span>
    <span class="s2">end</span>

    <span class="s0"># ============================= #</span>
    <span class="s0"># Test - Apply Flags For Fabric #</span>
    <span class="s0"># ============================= #</span>
    <span class="s2">def </span><span class="s5">test_applyFlagsForFabric_whenFabricEnabled_addsTheFlag</span>
        <span class="s0"># Arrange</span>
        <span class="s1">first_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;FirstTarget&quot;</span><span class="s1">)</span>
        <span class="s1">second_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;SecondTarget&quot;</span><span class="s1">)</span>
        <span class="s1">third_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;ThirdTarget&quot;</span><span class="s1">, </span><span class="s3">&quot;com.apple.product-type.bundle&quot;</span><span class="s1">)</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
            <span class="s1">],</span>
            <span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
                <span class="s1">first_target,</span>
                <span class="s1">second_target 
            ]</span>
        <span class="s1">)</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([third_target], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}})</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.apply_flags_for_fabric(installer, </span><span class="s6">fabric_enabled: true</span><span class="s1">)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">received_cflags </span><span class="s2">= </span><span class="s1">config.build_settings[</span><span class="s3">&quot;OTHER_CFLAGS&quot;</span><span class="s1">]</span>
            <span class="s1">expected_cflags </span><span class="s2">= </span><span class="s3">&quot;$(inherited) -DRN_FABRIC_ENABLED&quot;</span>
            <span class="s1">assert_equal(received_cflags, expected_cflags)</span>
        <span class="s2">end</span>

    <span class="s2">end</span>

    <span class="s2">def </span><span class="s5">test_applyFlagsForFabric_whenFabricDisabled_doNothing</span>
        <span class="s0"># Arrange</span>
        <span class="s1">first_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;FirstTarget&quot;</span><span class="s1">)</span>
        <span class="s1">second_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;SecondTarget&quot;</span><span class="s1">)</span>
        <span class="s1">third_target </span><span class="s2">= </span><span class="s1">prepare_target(</span><span class="s3">&quot;ThirdTarget&quot;</span><span class="s1">, </span><span class="s3">&quot;com.apple.product-type.bundle&quot;</span><span class="s1">)</span>
        <span class="s1">user_project_mock </span><span class="s2">= </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
                <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
            <span class="s1">],</span>
            <span class="s6">:native_targets </span><span class="s1">=&gt; [</span>
                <span class="s1">first_target,</span>
                <span class="s1">second_target 
            ]</span>
        <span class="s1">)</span>
        <span class="s1">pods_projects_mock </span><span class="s2">= </span><span class="s1">PodsProjectMock.</span><span class="s2">new</span><span class="s1">([third_target], {</span><span class="s3">&quot;hermes-engine&quot; </span><span class="s1">=&gt; {}})</span>
        <span class="s1">installer </span><span class="s2">= </span><span class="s1">InstallerMock.</span><span class="s2">new</span><span class="s1">(pods_projects_mock, [</span>
            <span class="s1">AggregatedProjectMock.</span><span class="s2">new</span><span class="s1">(user_project_mock)</span>
        <span class="s1">])</span>

        <span class="s0"># Act</span>
        <span class="s1">ReactNativePodsUtils.apply_flags_for_fabric(installer, </span><span class="s6">fabric_enabled: false</span><span class="s1">)</span>

        <span class="s0"># Assert</span>
        <span class="s1">user_project_mock.build_configurations.each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
            <span class="s1">assert_equal(config.build_settings[</span><span class="s3">&quot;OTHER_CFLAGS&quot;</span><span class="s1">], </span><span class="s3">&quot;$(inherited)&quot;</span><span class="s1">)</span>
        <span class="s2">end</span>
    <span class="s2">end</span>
<span class="s2">end</span>

<span class="s0"># ===== #</span>
<span class="s0"># UTILS #</span>
<span class="s0"># ===== #</span>

<span class="s2">def </span><span class="s5">prepare_empty_user_project_mock</span>
    <span class="s2">return </span><span class="s1">UserProjectMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;a/path&quot;</span><span class="s1">, [</span>
        <span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
        <span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(</span><span class="s3">&quot;Release&quot;</span><span class="s1">),</span>
    <span class="s1">])</span>
<span class="s2">end</span>

<span class="s2">def </span><span class="s5">prepare_config</span><span class="s1">(</span><span class="s4">config_name</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(config_name, {</span><span class="s3">&quot;LIBRARY_SEARCH_PATHS&quot; </span><span class="s1">=&gt; [</span>
        <span class="s3">&quot;$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;</span><span class="s8">\&quot;</span><span class="s3">$(TOOLCHAIN_DIR)/usr/lib/swift-5.0/$(PLATFORM_NAME)</span><span class="s8">\&quot;</span><span class="s3">&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;another/path&quot;</span><span class="s1">,</span>
    <span class="s1">]})</span>
<span class="s2">end</span>

<span class="s2">def </span><span class="s5">prepare_target</span><span class="s1">(</span><span class="s4">name</span><span class="s1">, </span><span class="s4">product_type </span><span class="s2">= </span><span class="s6">nil</span><span class="s1">, </span><span class="s4">dependencies </span><span class="s2">= </span><span class="s1">[])</span>
  <span class="s2">return </span><span class="s1">TargetMock.</span><span class="s2">new</span><span class="s1">(name, [</span>
      <span class="s1">prepare_config(</span><span class="s3">&quot;Debug&quot;</span><span class="s1">),</span>
      <span class="s1">prepare_config(</span><span class="s3">&quot;Release&quot;</span><span class="s1">)</span>
  <span class="s1">], product_type, dependencies)</span>
<span class="s2">end</span>

<span class="s2">def </span><span class="s5">prepare_Code_Signing_build_configuration</span><span class="s1">(</span><span class="s4">name</span><span class="s1">, </span><span class="s4">param</span><span class="s1">)</span>
    <span class="s2">return </span><span class="s1">BuildConfigurationMock.</span><span class="s2">new</span><span class="s1">(name, {</span>
        <span class="s3">&quot;CODE_SIGNING_ALLOWED&quot; </span><span class="s1">=&gt; param 
    })</span>
<span class="s2">end</span>
</pre>
</body>
</html>