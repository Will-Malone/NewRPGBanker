<html>
<head>
<title>RCTRedBoxExtraDataViewController.m</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
RCTRedBoxExtraDataViewController.m</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#import </span><span class="s3">&quot;RCTRedBoxExtraDataViewController.h&quot;</span>

<span class="s4">@interface </span><span class="s1">RCTRedBoxExtraDataCell : UITableViewCell</span>

<span class="s4">@property </span><span class="s1">(nonatomic</span><span class="s4">, </span><span class="s1">strong) UILabel *keyLabel</span><span class="s4">;</span>
<span class="s4">@property </span><span class="s1">(nonatomic</span><span class="s4">, </span><span class="s1">strong) UILabel *valueLabel</span><span class="s4">;</span>

<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTRedBoxExtraDataCell</span>

<span class="s1">- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {</span>
    <span class="s1">self.backgroundColor = [UIColor colorWithRed:</span><span class="s5">0.8 </span><span class="s1">green:</span><span class="s5">0 </span><span class="s1">blue:</span><span class="s5">0 </span><span class="s1">alpha:</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">UILayoutGuide *contentLayout = self.contentView.layoutMarginsGuide</span><span class="s4">;</span>

    <span class="s1">self.keyLabel = [UILabel new]</span><span class="s4">;</span>
    <span class="s1">[self.contentView addSubview:self.keyLabel]</span><span class="s4">;</span>

    <span class="s1">self.keyLabel.translatesAutoresizingMaskIntoConstraints = NO</span><span class="s4">;</span>
    <span class="s1">[self.keyLabel.leadingAnchor constraintEqualToAnchor:contentLayout.leadingAnchor].active = YES</span><span class="s4">;</span>
    <span class="s1">[self.keyLabel.topAnchor constraintEqualToAnchor:contentLayout.topAnchor].active = YES</span><span class="s4">;</span>
    <span class="s1">[self.keyLabel.bottomAnchor constraintEqualToAnchor:contentLayout.bottomAnchor].active = YES</span><span class="s4">;</span>
    <span class="s1">[self.keyLabel.widthAnchor constraintEqualToAnchor:contentLayout.widthAnchor multiplier:</span><span class="s5">0.3</span><span class="s1">].active = YES</span><span class="s4">;</span>

    <span class="s1">self.keyLabel.textColor = [UIColor whiteColor]</span><span class="s4">;</span>
    <span class="s1">self.keyLabel.numberOfLines = </span><span class="s5">0</span><span class="s4">;</span>
    <span class="s1">self.keyLabel.lineBreakMode = NSLineBreakByWordWrapping</span><span class="s4">;</span>
    <span class="s1">self.keyLabel.font = [UIFont fontWithName:</span><span class="s4">@</span><span class="s3">&quot;Menlo-Regular&quot; </span><span class="s1">size:</span><span class="s5">12.0f</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">self.valueLabel = [UILabel new]</span><span class="s4">;</span>
    <span class="s1">[self.contentView addSubview:self.valueLabel]</span><span class="s4">;</span>

    <span class="s1">self.valueLabel.translatesAutoresizingMaskIntoConstraints = NO</span><span class="s4">;</span>
    <span class="s1">[self.valueLabel.leadingAnchor constraintEqualToAnchor:self.keyLabel.trailingAnchor constant:</span><span class="s5">10.f</span><span class="s1">].active = YES</span><span class="s4">;</span>
    <span class="s1">[self.valueLabel.trailingAnchor constraintEqualToAnchor:contentLayout.trailingAnchor].active = YES</span><span class="s4">;</span>
    <span class="s1">[self.valueLabel.topAnchor constraintEqualToAnchor:contentLayout.topAnchor].active = YES</span><span class="s4">;</span>
    <span class="s1">[self.valueLabel.bottomAnchor constraintEqualToAnchor:contentLayout.bottomAnchor].active = YES</span><span class="s4">;</span>

    <span class="s1">self.valueLabel.textColor = [UIColor whiteColor]</span><span class="s4">;</span>
    <span class="s1">self.valueLabel.numberOfLines = </span><span class="s5">0</span><span class="s4">;</span>
    <span class="s1">self.valueLabel.lineBreakMode = NSLineBreakByWordWrapping</span><span class="s4">;</span>
    <span class="s1">self.valueLabel.font = [UIFont fontWithName:</span><span class="s4">@</span><span class="s3">&quot;Menlo-Regular&quot; </span><span class="s1">size:</span><span class="s5">12.0f</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">self</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s4">@interface </span><span class="s1">RCTRedBoxExtraDataViewController ()</span>

<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTRedBoxExtraDataViewController {</span>
  <span class="s1">UITableView *_tableView</span><span class="s4">;</span>
  <span class="s1">NSMutableArray *_extraDataTitle</span><span class="s4">;</span>
  <span class="s1">NSMutableArray *_extraData</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@synthesize </span><span class="s1">actionDelegate = _actionDelegate</span><span class="s4">;</span>

<span class="s1">- (instancetype)init</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self = [super init]) {</span>
    <span class="s1">_extraData = [NSMutableArray new]</span><span class="s4">;</span>
    <span class="s1">_extraDataTitle = [NSMutableArray new]</span><span class="s4">;</span>
    <span class="s1">self.view.backgroundColor = [UIColor colorWithRed:</span><span class="s5">0.8 </span><span class="s1">green:</span><span class="s5">0 </span><span class="s1">blue:</span><span class="s5">0 </span><span class="s1">alpha:</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>

    <span class="s1">_tableView = [UITableView new]</span><span class="s4">;</span>
    <span class="s1">_tableView.delegate = self</span><span class="s4">;</span>
    <span class="s1">_tableView.dataSource = self</span><span class="s4">;</span>
    <span class="s1">_tableView.backgroundColor = [UIColor clearColor]</span><span class="s4">;</span>
    <span class="s1">_tableView.estimatedRowHeight = </span><span class="s5">200</span><span class="s4">;</span>
    <span class="s1">_tableView.separatorStyle = UITableViewCellSeparatorStyleNone</span><span class="s4">;</span>
    <span class="s1">_tableView.rowHeight = UITableViewAutomaticDimension</span><span class="s4">;</span>
    <span class="s1">_tableView.allowsSelection = NO</span><span class="s4">;</span>

<span class="s2">#if </span><span class="s1">TARGET_OS_SIMULATOR || TARGET_OS_MACCATALYST</span>
    <span class="s1">NSString *reloadText = </span><span class="s4">@</span><span class="s3">&quot;Reload JS (</span><span class="s4">\u2318</span><span class="s3">R)&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *dismissText = </span><span class="s4">@</span><span class="s3">&quot;Dismiss (ESC)&quot;</span><span class="s4">;</span>
<span class="s2">#else</span>
    <span class="s1">NSString *reloadText = </span><span class="s4">@</span><span class="s3">&quot;Reload JS&quot;</span><span class="s4">;</span>
    <span class="s1">NSString *dismissText = </span><span class="s4">@</span><span class="s3">&quot;Dismiss&quot;</span><span class="s4">;</span>
<span class="s2">#endif</span>

    <span class="s1">UIButton *dismissButton = [UIButton buttonWithType:UIButtonTypeCustom]</span><span class="s4">;</span>
    <span class="s1">dismissButton.translatesAutoresizingMaskIntoConstraints = NO</span><span class="s4">;</span>
    <span class="s1">dismissButton.accessibilityIdentifier = </span><span class="s4">@</span><span class="s3">&quot;redbox-extra-data-dismiss&quot;</span><span class="s4">;</span>
    <span class="s1">dismissButton.titleLabel.font = [UIFont systemFontOfSize:</span><span class="s5">13</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">[dismissButton setTitle:dismissText forState:UIControlStateNormal]</span><span class="s4">;</span>
    <span class="s1">[dismissButton setTitleColor:[UIColor colorWithWhite:</span><span class="s5">1 </span><span class="s1">alpha:</span><span class="s5">0.5</span><span class="s1">] forState:UIControlStateNormal]</span><span class="s4">;</span>
    <span class="s1">[dismissButton setTitleColor:[UIColor whiteColor] forState:UIControlStateHighlighted]</span><span class="s4">;</span>
    <span class="s1">[dismissButton addTarget:self action:</span><span class="s4">@selector</span><span class="s1">(dismiss) forControlEvents:UIControlEventTouchUpInside]</span><span class="s4">;</span>

    <span class="s1">UIButton *reloadButton = [UIButton buttonWithType:UIButtonTypeCustom]</span><span class="s4">;</span>
    <span class="s1">reloadButton.accessibilityIdentifier = </span><span class="s4">@</span><span class="s3">&quot;redbox-reload&quot;</span><span class="s4">;</span>
    <span class="s1">reloadButton.titleLabel.font = [UIFont systemFontOfSize:</span><span class="s5">13</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">[reloadButton setTitle:reloadText forState:UIControlStateNormal]</span><span class="s4">;</span>
    <span class="s1">[reloadButton setTitleColor:[UIColor colorWithWhite:</span><span class="s5">1 </span><span class="s1">alpha:</span><span class="s5">0.5</span><span class="s1">] forState:UIControlStateNormal]</span><span class="s4">;</span>
    <span class="s1">[reloadButton setTitleColor:[UIColor whiteColor] forState:UIControlStateHighlighted]</span><span class="s4">;</span>
    <span class="s1">[reloadButton addTarget:self action:</span><span class="s4">@selector</span><span class="s1">(reload) forControlEvents:UIControlEventTouchUpInside]</span><span class="s4">;</span>

    <span class="s1">UIStackView *buttonStackView = [UIStackView new]</span><span class="s4">;</span>
    <span class="s1">buttonStackView.axis = UILayoutConstraintAxisHorizontal</span><span class="s4">;</span>
    <span class="s1">buttonStackView.distribution = UIStackViewDistributionEqualSpacing</span><span class="s4">;</span>
    <span class="s1">buttonStackView.alignment = UIStackViewAlignmentFill</span><span class="s4">;</span>
    <span class="s1">buttonStackView.spacing = </span><span class="s5">20</span><span class="s4">;</span>

    <span class="s1">[buttonStackView addArrangedSubview:dismissButton]</span><span class="s4">;</span>
    <span class="s1">[buttonStackView addArrangedSubview:reloadButton]</span><span class="s4">;</span>
    <span class="s1">buttonStackView.translatesAutoresizingMaskIntoConstraints = NO</span><span class="s4">;</span>

    <span class="s1">UIStackView *mainStackView = [UIStackView new]</span><span class="s4">;</span>
    <span class="s1">mainStackView.axis = UILayoutConstraintAxisVertical</span><span class="s4">;</span>
    <span class="s1">mainStackView.backgroundColor = [UIColor colorWithRed:</span><span class="s5">0.8 </span><span class="s1">green:</span><span class="s5">0 </span><span class="s1">blue:</span><span class="s5">0 </span><span class="s1">alpha:</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">[mainStackView addArrangedSubview:_tableView]</span><span class="s4">;</span>
    <span class="s1">[mainStackView addArrangedSubview:buttonStackView]</span><span class="s4">;</span>
    <span class="s1">mainStackView.translatesAutoresizingMaskIntoConstraints = NO</span><span class="s4">;</span>

    <span class="s1">[self.view addSubview:mainStackView]</span><span class="s4">;</span>

    <span class="s1">CGFloat tableHeight = self.view.bounds.size.height - </span><span class="s5">60.f</span><span class="s4">;</span>
    <span class="s1">[_tableView.heightAnchor constraintEqualToConstant:tableHeight].active = YES</span><span class="s4">;</span>
    <span class="s1">[_tableView.widthAnchor constraintEqualToAnchor:self.view.widthAnchor].active = YES</span><span class="s4">;</span>

    <span class="s1">CGFloat buttonWidth = self.view.bounds.size.width / </span><span class="s5">4</span><span class="s4">;</span>
    <span class="s1">[dismissButton.heightAnchor constraintEqualToConstant:</span><span class="s5">60</span><span class="s1">].active = YES</span><span class="s4">;</span>
    <span class="s1">[dismissButton.widthAnchor constraintEqualToConstant:buttonWidth].active = YES</span><span class="s4">;</span>
    <span class="s1">[reloadButton.heightAnchor constraintEqualToConstant:</span><span class="s5">60</span><span class="s1">].active = YES</span><span class="s4">;</span>
    <span class="s1">[reloadButton.widthAnchor constraintEqualToConstant:buttonWidth].active = YES</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">self</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)viewDidAppear:(BOOL)animated</span>
<span class="s1">{</span>
  <span class="s1">[super viewDidAppear:animated]</span><span class="s4">;</span>
  <span class="s1">[_tableView reloadData]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (NSInteger)tableView:(__unused UITableView *)tableView numberOfRowsInSection:(NSInteger)section</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[[_extraData objectAtIndex:section] count]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (CGFloat)tableView:(__unused UITableView *)tableView heightForHeaderInSection:(__unused NSInteger)section</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s5">40</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (UIView *)tableView:(__unused UITableView *)tableView viewForHeaderInSection:(NSInteger)section</span>
<span class="s1">{</span>
  <span class="s1">UIView *view = [UIView new]</span><span class="s4">;</span>
  <span class="s1">view.backgroundColor = [UIColor colorWithRed:</span><span class="s5">1 </span><span class="s1">green:</span><span class="s5">0 </span><span class="s1">blue:</span><span class="s5">0 </span><span class="s1">alpha:</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>

  <span class="s1">UILabel *header = [UILabel new]</span><span class="s4">;</span>
  <span class="s1">[view addSubview:header]</span><span class="s4">;</span>

  <span class="s1">header.translatesAutoresizingMaskIntoConstraints = NO</span><span class="s4">;</span>
  <span class="s1">[header.leadingAnchor constraintEqualToAnchor:view.leadingAnchor constant:</span><span class="s5">5</span><span class="s1">].active = YES</span><span class="s4">;</span>
  <span class="s1">[header.trailingAnchor constraintEqualToAnchor:view.trailingAnchor].active = YES</span><span class="s4">;</span>
  <span class="s1">[header.topAnchor constraintEqualToAnchor:view.topAnchor].active = YES</span><span class="s4">;</span>
  <span class="s1">[header.bottomAnchor constraintEqualToAnchor:view.bottomAnchor].active = YES</span><span class="s4">;</span>

  <span class="s1">header.textColor = [UIColor whiteColor]</span><span class="s4">;</span>
  <span class="s1">header.font = [UIFont fontWithName:</span><span class="s4">@</span><span class="s3">&quot;Menlo-Bold&quot; </span><span class="s1">size:</span><span class="s5">14.0f</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">header.text = [_extraDataTitle[section] uppercaseString]</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">view</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath</span>
<span class="s1">{</span>
  <span class="s4">static </span><span class="s1">NSString *reuseIdentifier = </span><span class="s4">@</span><span class="s3">&quot;RedBoxExtraData&quot;</span><span class="s4">;</span>

  <span class="s1">RCTRedBoxExtraDataCell *cell =</span>
      <span class="s1">(RCTRedBoxExtraDataCell *)[tableView dequeueReusableCellWithIdentifier:reuseIdentifier]</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(cell == nil) {</span>
    <span class="s1">cell = [[RCTRedBoxExtraDataCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:reuseIdentifier]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">NSArray *dataKVPair = _extraData[indexPath.section][indexPath.row]</span><span class="s4">;</span>
  <span class="s1">cell.keyLabel.text = dataKVPair[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">cell.valueLabel.text = dataKVPair[</span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">cell</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (NSInteger)numberOfSectionsInTableView:(__unused UITableView *)tableView</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">_extraDataTitle.count</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)addExtraData:(NSDictionary *)data forIdentifier:(NSString *)identifier</span>
<span class="s1">{</span>
  <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s1">NSMutableArray *newData = [NSMutableArray new]</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(id key in data) {</span>
      <span class="s1">[newData addObject:</span><span class="s4">@</span><span class="s1">[</span>
        <span class="s1">[NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;%@&quot;</span><span class="s4">, </span><span class="s1">key]</span><span class="s4">,</span>
        <span class="s1">[NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;%@&quot;</span><span class="s4">, </span><span class="s1">[data objectForKey:key]]</span>
      <span class="s1">]]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">NSInteger idx = [self-&gt;_extraDataTitle indexOfObject:identifier]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(idx == NSNotFound) {</span>
      <span class="s1">[self-&gt;_extraDataTitle addObject:identifier]</span><span class="s4">;</span>
      <span class="s1">[self-&gt;_extraData addObject:newData]</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s1">[self-&gt;_extraData replaceObjectAtIndex:idx withObject:newData]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">[self-&gt;_tableView reloadData]</span><span class="s4">;</span>
  <span class="s1">})</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)dismiss</span>
<span class="s1">{</span>
  <span class="s1">[self dismissViewControllerAnimated:YES completion:nil]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)reload</span>
<span class="s1">{</span>
  <span class="s1">[_actionDelegate reload]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s2">#pragma </span><span class="s1">mark - Key commands</span>

<span class="s1">- (NSArray&lt;UIKeyCommand *&gt; *)keyCommands</span>
<span class="s1">{</span>
  <span class="s4">return @</span><span class="s1">[</span>
    <span class="s0">// Dismiss</span>
    <span class="s1">[UIKeyCommand keyCommandWithInput:UIKeyInputEscape modifierFlags:</span><span class="s5">0 </span><span class="s1">action:</span><span class="s4">@selector</span><span class="s1">(dismiss)]</span><span class="s4">,</span>
    <span class="s0">// Reload</span>
    <span class="s1">[UIKeyCommand keyCommandWithInput:</span><span class="s4">@</span><span class="s3">&quot;r&quot; </span><span class="s1">modifierFlags:UIKeyModifierCommand action:</span><span class="s4">@selector</span><span class="s1">(reload)]</span>
  <span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>
</pre>
</body>
</html>