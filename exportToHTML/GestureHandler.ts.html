<html>
<head>
<title>GestureHandler.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #a9b7c6;}
.s4 { color: #6a8759;}
.s5 { color: #9876aa; font-style: italic;}
.s6 { color: #6897bb; font-style: italic;}
.s7 { color: #ffc66d;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
GestureHandler.ts</font>
</center></td></tr></table>
<pre><span class="s0">/* eslint-disable eslint-comments/no-unlimited-disable */</span>
<span class="s0">/* eslint-disable */</span>
<span class="s2">import </span><span class="s3">Hammer </span><span class="s2">from </span><span class="s4">'@egjs/hammerjs'</span><span class="s1">;</span>
<span class="s2">import </span><span class="s1">{ </span><span class="s3">findNodeHandle </span><span class="s1">} </span><span class="s2">from </span><span class="s4">'react-native'</span><span class="s1">;</span>

<span class="s2">import </span><span class="s1">{ </span><span class="s3">State </span><span class="s1">} </span><span class="s2">from </span><span class="s4">'../State'</span><span class="s1">;</span>
<span class="s2">import </span><span class="s1">{ </span><span class="s3">EventMap </span><span class="s1">} </span><span class="s2">from </span><span class="s4">'./constants'</span><span class="s1">;</span>
<span class="s2">import </span><span class="s5">* </span><span class="s2">as </span><span class="s3">NodeManager </span><span class="s2">from </span><span class="s4">'./NodeManager'</span><span class="s1">;</span>

<span class="s0">// TODO(TS) Replace with HammerInput if https://github.com/DefinitelyTyped/DefinitelyTyped/pull/50438/files is merged</span>
<span class="s2">export type </span><span class="s3">HammerInputExt </span><span class="s2">= </span><span class="s3">Omit</span><span class="s1">&lt;</span><span class="s3">HammerInput</span><span class="s1">, </span><span class="s4">'destroy' </span><span class="s2">| </span><span class="s4">'handler' </span><span class="s2">| </span><span class="s4">'init'</span><span class="s1">&gt;;</span>

<span class="s2">export type </span><span class="s3">Config </span><span class="s2">= </span><span class="s3">Partial</span><span class="s1">&lt;{</span>
  <span class="s1">enabled</span><span class="s2">: </span><span class="s3">boolean</span><span class="s1">;</span>
  <span class="s1">minPointers</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">maxPointers</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">minDist</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">minDistSq</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">minVelocity</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">minVelocitySq</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">maxDist</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">maxDistSq</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">failOffsetXStart</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">failOffsetYStart</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">failOffsetXEnd</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">failOffsetYEnd</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">activeOffsetXStart</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">activeOffsetXEnd</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">activeOffsetYStart</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">activeOffsetYEnd</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s1">waitFor</span><span class="s2">: </span><span class="s3">any</span><span class="s1">[] </span><span class="s2">| </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">simultaneousHandlers</span><span class="s2">: </span><span class="s3">any</span><span class="s1">[] </span><span class="s2">| </span><span class="s3">null</span><span class="s1">;</span>
<span class="s1">}&gt;;</span>

<span class="s2">type </span><span class="s3">NativeEvent </span><span class="s2">= </span><span class="s3">ReturnType</span><span class="s1">&lt;</span><span class="s3">GestureHandler</span><span class="s1">[</span><span class="s4">'transformEventData'</span><span class="s1">]&gt;;</span>

<span class="s2">let </span><span class="s1">gestureInstances </span><span class="s2">= </span><span class="s6">0</span><span class="s1">;</span>

<span class="s2">abstract class </span><span class="s3">GestureHandler </span><span class="s1">{</span>
  <span class="s2">public </span><span class="s1">handlerTag</span><span class="s2">: </span><span class="s3">any</span><span class="s1">;</span>
  <span class="s2">public </span><span class="s1">isGestureRunning </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
  <span class="s2">public </span><span class="s1">view</span><span class="s2">: </span><span class="s3">number </span><span class="s2">| </span><span class="s3">null </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
  <span class="s2">protected </span><span class="s1">hasCustomActivationCriteria</span><span class="s2">: </span><span class="s3">boolean</span><span class="s1">;</span>
  <span class="s2">protected </span><span class="s1">hasGestureFailed </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
  <span class="s2">protected </span><span class="s1">hammer</span><span class="s2">: </span><span class="s3">HammerManager </span><span class="s2">| </span><span class="s3">null </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
  <span class="s2">protected </span><span class="s1">initialRotation</span><span class="s2">: </span><span class="s3">number </span><span class="s2">| </span><span class="s3">null </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
  <span class="s2">protected </span><span class="s1">__initialX</span><span class="s2">: </span><span class="s3">any</span><span class="s1">;</span>
  <span class="s2">protected </span><span class="s1">__initialY</span><span class="s2">: </span><span class="s3">any</span><span class="s1">;</span>
  <span class="s2">protected </span><span class="s1">config</span><span class="s2">: </span><span class="s3">Config </span><span class="s2">= </span><span class="s1">{};</span>
  <span class="s2">protected </span><span class="s1">previousState</span><span class="s2">: </span><span class="s3">State </span><span class="s2">= </span><span class="s3">State</span><span class="s1">.</span><span class="s3">UNDETERMINED</span><span class="s1">;</span>
  <span class="s2">private </span><span class="s1">pendingGestures</span><span class="s2">: </span><span class="s3">Record</span><span class="s1">&lt;</span><span class="s3">string</span><span class="s1">, </span><span class="s3">this</span><span class="s1">&gt; </span><span class="s2">= </span><span class="s1">{};</span>
  <span class="s2">private </span><span class="s1">oldState</span><span class="s2">: </span><span class="s3">State </span><span class="s2">= </span><span class="s3">State</span><span class="s1">.</span><span class="s3">UNDETERMINED</span><span class="s1">;</span>
  <span class="s2">private </span><span class="s1">lastSentState</span><span class="s2">: </span><span class="s3">State </span><span class="s2">| </span><span class="s3">null </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
  <span class="s2">private </span><span class="s1">gestureInstance</span><span class="s2">: </span><span class="s3">number</span><span class="s1">;</span>
  <span class="s2">private </span><span class="s1">_stillWaiting</span><span class="s2">: </span><span class="s3">any</span><span class="s1">;</span>
  <span class="s2">private </span><span class="s1">propsRef</span><span class="s2">: </span><span class="s3">any</span><span class="s1">;</span>
  <span class="s2">private </span><span class="s1">ref</span><span class="s2">: </span><span class="s3">any</span><span class="s1">;</span>

  <span class="s2">abstract get </span><span class="s1">name()</span><span class="s2">: </span><span class="s3">string</span><span class="s1">;</span>

  <span class="s2">get </span><span class="s1">id() {</span>
    <span class="s2">return </span><span class="s4">`${</span><span class="s3">this</span><span class="s4">.</span><span class="s3">name</span><span class="s4">}${</span><span class="s3">this</span><span class="s4">.</span><span class="s3">gestureInstance</span><span class="s4">}`</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">// a simple way to check if GestureHandler is NativeViewGestureHandler, since importing it</span>
  <span class="s0">// here to use instanceof would cause import cycle</span>
  <span class="s2">get </span><span class="s1">isNative() {</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get </span><span class="s1">isDiscrete() {</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s2">get </span><span class="s1">shouldEnableGestureOnSetup()</span><span class="s2">: </span><span class="s3">boolean </span><span class="s1">{</span>
    <span class="s2">throw new </span><span class="s7">Error</span><span class="s1">(</span><span class="s4">'Must override GestureHandler.shouldEnableGestureOnSetup'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s2">constructor</span><span class="s1">() {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">gestureInstance </span><span class="s2">= </span><span class="s3">gestureInstances</span><span class="s2">++</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">hasCustomActivationCriteria </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">getConfig() {</span>
    <span class="s2">return </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">onWaitingEnded(</span><span class="s3">_gesture</span><span class="s2">: </span><span class="s3">this</span><span class="s1">) {}</span>

  <span class="s1">removePendingGesture(</span><span class="s3">id</span><span class="s2">: </span><span class="s3">string</span><span class="s1">) {</span>
    <span class="s2">delete </span><span class="s3">this</span><span class="s1">.</span><span class="s3">pendingGestures</span><span class="s1">[</span><span class="s3">id</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s1">addPendingGesture(</span><span class="s3">gesture</span><span class="s2">: </span><span class="s3">this</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">pendingGestures</span><span class="s1">[</span><span class="s3">gesture</span><span class="s1">.</span><span class="s3">id</span><span class="s1">] </span><span class="s2">= </span><span class="s3">gesture</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">isGestureEnabledForEvent(</span>
    <span class="s3">_config</span><span class="s2">: </span><span class="s3">any</span><span class="s1">,</span>
    <span class="s3">_recognizer</span><span class="s2">: </span><span class="s3">any</span><span class="s1">,</span>
    <span class="s3">_event</span><span class="s2">: </span><span class="s3">any</span>
  <span class="s1">)</span><span class="s2">: </span><span class="s1">{ failed</span><span class="s2">?: </span><span class="s3">boolean</span><span class="s1">; success</span><span class="s2">?: </span><span class="s3">boolean </span><span class="s1">} {</span>
    <span class="s2">return </span><span class="s1">{ success: </span><span class="s5">true </span><span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s2">get </span><span class="s1">NativeGestureClass()</span><span class="s2">: </span><span class="s3">RecognizerStatic </span><span class="s1">{</span>
    <span class="s2">throw new </span><span class="s7">Error</span><span class="s1">(</span><span class="s4">'Must override GestureHandler.NativeGestureClass'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s1">updateHasCustomActivationCriteria(</span><span class="s3">_config</span><span class="s2">: </span><span class="s3">Config</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s5">true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">clearSelfAsPending </span><span class="s2">= </span><span class="s1">() </span><span class="s2">=&gt; </span><span class="s1">{</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s7">isArray</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">)) {</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">gesture </span><span class="s2">of </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">) {</span>
        <span class="s3">gesture</span><span class="s1">.</span><span class="s7">removePendingGesture</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">id</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">};</span>

  <span class="s1">updateGestureConfig({ </span><span class="s3">enabled </span><span class="s2">= </span><span class="s5">true</span><span class="s1">, </span><span class="s2">...</span><span class="s3">props </span><span class="s1">}) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">clearSelfAsPending</span><span class="s1">();</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s3">config </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">ensureConfig</span><span class="s1">({ </span><span class="s3">enabled</span><span class="s1">, </span><span class="s2">...</span><span class="s3">props </span><span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">hasCustomActivationCriteria </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">updateHasCustomActivationCriteria</span><span class="s1">(</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">config</span>
    <span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s7">isArray</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">)) {</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">gesture </span><span class="s2">of </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">) {</span>
        <span class="s3">gesture</span><span class="s1">.</span><span class="s7">addPendingGesture</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s7">sync</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">destroy </span><span class="s2">= </span><span class="s1">() </span><span class="s2">=&gt; </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">clearSelfAsPending</span><span class="s1">();</span>

    <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s1">.</span><span class="s7">stop</span><span class="s1">(</span><span class="s5">false</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s1">.</span><span class="s7">destroy</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s1">isPointInView </span><span class="s2">= </span><span class="s1">({ </span><span class="s3">x</span><span class="s1">, </span><span class="s3">y </span><span class="s1">}</span><span class="s2">: </span><span class="s1">{ x</span><span class="s2">: </span><span class="s3">number</span><span class="s1">; y</span><span class="s2">: </span><span class="s3">number </span><span class="s1">}) </span><span class="s2">=&gt; </span><span class="s1">{</span>
    <span class="s0">// @ts-ignore FIXME(TS)</span>
    <span class="s2">const </span><span class="s1">rect </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s3">view</span><span class="s2">!</span><span class="s1">.</span><span class="s7">getBoundingClientRect</span><span class="s1">();</span>
    <span class="s2">const </span><span class="s1">pointerInside </span><span class="s2">=</span>
      <span class="s3">x </span><span class="s2">&gt;= </span><span class="s3">rect</span><span class="s1">.</span><span class="s3">left </span><span class="s2">&amp;&amp; </span><span class="s3">x </span><span class="s2">&lt;= </span><span class="s3">rect</span><span class="s1">.</span><span class="s3">right </span><span class="s2">&amp;&amp; </span><span class="s3">y </span><span class="s2">&gt;= </span><span class="s3">rect</span><span class="s1">.</span><span class="s3">top </span><span class="s2">&amp;&amp; </span><span class="s3">y </span><span class="s2">&lt;= </span><span class="s3">rect</span><span class="s1">.</span><span class="s3">bottom</span><span class="s1">;</span>
    <span class="s2">return </span><span class="s3">pointerInside</span><span class="s1">;</span>
  <span class="s1">};</span>

  <span class="s1">getState(</span><span class="s3">type</span><span class="s2">: keyof typeof </span><span class="s3">EventMap</span><span class="s1">)</span><span class="s2">: </span><span class="s3">State </span><span class="s1">{</span>
    <span class="s0">// @ts-ignore TODO(TS) check if this is needed</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">type </span><span class="s2">== </span><span class="s6">0</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s3">EventMap</span><span class="s1">[</span><span class="s3">type</span><span class="s1">];</span>
  <span class="s1">}</span>

  <span class="s1">transformEventData(</span><span class="s3">event</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s2">const </span><span class="s1">{ eventType, </span><span class="s3">maxPointers</span><span class="s1">: numberOfPointers } </span><span class="s2">= </span><span class="s3">event</span><span class="s1">;</span>
    <span class="s0">// const direction = DirectionMap[ev.direction];</span>
    <span class="s2">const </span><span class="s1">changedTouch </span><span class="s2">= </span><span class="s3">event</span><span class="s1">.</span><span class="s3">changedPointers</span><span class="s1">[</span><span class="s6">0</span><span class="s1">];</span>
    <span class="s2">const </span><span class="s1">pointerInside </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">isPointInView</span><span class="s1">({</span>
      <span class="s1">x: </span><span class="s3">changedTouch</span><span class="s1">.</span><span class="s3">clientX</span><span class="s1">,</span>
      <span class="s1">y: </span><span class="s3">changedTouch</span><span class="s1">.</span><span class="s3">clientY</span><span class="s1">,</span>
    <span class="s1">});</span>

    <span class="s0">// TODO(TS) Remove cast after https://github.com/DefinitelyTyped/DefinitelyTyped/pull/50966 is merged.</span>
    <span class="s2">const </span><span class="s1">state </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">getState</span><span class="s1">(</span><span class="s3">eventType </span><span class="s2">as </span><span class="s6">1 </span><span class="s2">| </span><span class="s6">2 </span><span class="s2">| </span><span class="s6">4 </span><span class="s2">| </span><span class="s6">8</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">state </span><span class="s2">!== </span><span class="s3">this</span><span class="s1">.</span><span class="s3">previousState</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">oldState </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s3">previousState</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">previousState </span><span class="s2">= </span><span class="s3">state</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s1">{</span>
      <span class="s1">nativeEvent: {</span>
        <span class="s3">numberOfPointers</span><span class="s1">,</span>
        <span class="s3">state</span><span class="s1">,</span>
        <span class="s3">pointerInside</span><span class="s1">,</span>
        <span class="s2">...</span><span class="s3">this</span><span class="s1">.</span><span class="s7">transformNativeEvent</span><span class="s1">(</span><span class="s3">event</span><span class="s1">),</span>
        <span class="s0">// onHandlerStateChange only</span>
        <span class="s1">handlerTag: </span><span class="s3">this</span><span class="s1">.</span><span class="s3">handlerTag</span><span class="s1">,</span>
        <span class="s1">target: </span><span class="s3">this</span><span class="s1">.</span><span class="s3">ref</span><span class="s1">,</span>
        <span class="s0">// send oldState only when the state was changed, or is different than ACTIVE</span>
        <span class="s0">// GestureDetector relies on the presence of `oldState` to differentiate between</span>
        <span class="s0">// update events and state change events</span>
        <span class="s1">oldState:</span>
          <span class="s3">state </span><span class="s2">!== </span><span class="s3">this</span><span class="s1">.</span><span class="s3">previousState </span><span class="s2">|| </span><span class="s3">state </span><span class="s2">!= </span><span class="s6">4</span>
            <span class="s2">? </span><span class="s3">this</span><span class="s1">.</span><span class="s3">oldState</span>
            <span class="s2">: </span><span class="s5">undefined</span><span class="s1">,</span>
      <span class="s1">},</span>
      <span class="s1">timeStamp: </span><span class="s3">Date</span><span class="s1">.</span><span class="s7">now</span><span class="s1">(),</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s1">transformNativeEvent(</span><span class="s3">_event</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s1">{};</span>
  <span class="s1">}</span>

  <span class="s1">sendEvent </span><span class="s2">= </span><span class="s1">(</span><span class="s3">nativeEvent</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s1">{</span>
    <span class="s2">const </span><span class="s1">{ onGestureHandlerEvent, onGestureHandlerStateChange } </span><span class="s2">=</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">propsRef</span><span class="s1">.</span><span class="s3">current</span><span class="s1">;</span>

    <span class="s2">const </span><span class="s1">event </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">transformEventData</span><span class="s1">(</span><span class="s3">nativeEvent</span><span class="s1">);</span>

    <span class="s7">invokeNullableMethod</span><span class="s1">(</span><span class="s3">onGestureHandlerEvent</span><span class="s1">, </span><span class="s3">event</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">lastSentState </span><span class="s2">!== </span><span class="s3">event</span><span class="s1">.</span><span class="s3">nativeEvent</span><span class="s1">.</span><span class="s3">state</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">lastSentState </span><span class="s2">= </span><span class="s3">event</span><span class="s1">.</span><span class="s3">nativeEvent</span><span class="s1">.</span><span class="s3">state </span><span class="s2">as </span><span class="s3">State</span><span class="s1">;</span>
      <span class="s7">invokeNullableMethod</span><span class="s1">(</span><span class="s3">onGestureHandlerStateChange</span><span class="s1">, </span><span class="s3">event</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">};</span>

  <span class="s1">cancelPendingGestures(</span><span class="s3">event</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">gesture </span><span class="s2">of </span><span class="s3">Object</span><span class="s1">.</span><span class="s7">values</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">pendingGestures</span><span class="s1">)) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">gesture </span><span class="s2">&amp;&amp; </span><span class="s3">gesture</span><span class="s1">.</span><span class="s3">isGestureRunning</span><span class="s1">) {</span>
        <span class="s3">gesture</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">true</span><span class="s1">;</span>
        <span class="s3">gesture</span><span class="s1">.</span><span class="s7">cancelEvent</span><span class="s1">(</span><span class="s3">event</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">notifyPendingGestures() {</span>
    <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">gesture </span><span class="s2">of </span><span class="s3">Object</span><span class="s1">.</span><span class="s7">values</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">pendingGestures</span><span class="s1">)) {</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">gesture</span><span class="s1">) {</span>
        <span class="s3">gesture</span><span class="s1">.</span><span class="s7">onWaitingEnded</span><span class="s1">(</span><span class="s3">this</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">// FIXME event is undefined in runtime when firstly invoked (see Draggable example), check other functions taking event as input</span>
  <span class="s1">onGestureEnded(</span><span class="s3">event</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">isGestureRunning </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">cancelPendingGestures</span><span class="s1">(</span><span class="s3">event</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s1">forceInvalidate(</span><span class="s3">event</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">isGestureRunning</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">true</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s7">cancelEvent</span><span class="s1">(</span><span class="s3">event</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">cancelEvent(</span><span class="s3">event</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">notifyPendingGestures</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">sendEvent</span><span class="s1">({</span>
      <span class="s2">...</span><span class="s3">event</span><span class="s1">,</span>
      <span class="s1">eventType: </span><span class="s3">Hammer</span><span class="s1">.</span><span class="s3">INPUT_CANCEL</span><span class="s1">,</span>
      <span class="s1">isFinal: </span><span class="s5">true</span><span class="s1">,</span>
    <span class="s1">});</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">onGestureEnded</span><span class="s1">(</span><span class="s3">event</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s1">onRawEvent({ </span><span class="s3">isFirst </span><span class="s1">}</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">isFirst</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">shouldUseTouchEvents(</span><span class="s3">config</span><span class="s2">: </span><span class="s3">Config</span><span class="s1">) {</span>
    <span class="s2">return </span><span class="s1">(</span>
      <span class="s3">config</span><span class="s1">.</span><span class="s3">simultaneousHandlers</span><span class="s1">?.</span><span class="s7">some</span><span class="s1">((</span><span class="s3">handler</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s3">handler</span><span class="s1">.</span><span class="s3">isNative</span><span class="s1">) </span><span class="s2">?? </span><span class="s5">false</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s1">setView(</span><span class="s3">ref</span><span class="s2">: </span><span class="s3">Parameters</span><span class="s1">&lt;</span><span class="s2">typeof </span><span class="s3">findNodeHandle</span><span class="s1">&gt;[</span><span class="s4">'0'</span><span class="s1">], </span><span class="s3">propsRef</span><span class="s2">: </span><span class="s3">any</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">ref </span><span class="s2">== </span><span class="s5">null</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s7">destroy</span><span class="s1">();</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">view </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
      <span class="s2">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">// @ts-ignore window doesn't exist on global type as we don't want to use Node types</span>
    <span class="s2">const </span><span class="s1">SUPPORTS_TOUCH </span><span class="s2">= </span><span class="s4">'ontouchstart' </span><span class="s2">in </span><span class="s3">window</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">propsRef </span><span class="s2">= </span><span class="s3">propsRef</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">ref </span><span class="s2">= </span><span class="s3">ref</span><span class="s1">;</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s3">view </span><span class="s2">= </span><span class="s7">findNodeHandle</span><span class="s1">(</span><span class="s3">ref</span><span class="s1">);</span>

    <span class="s0">// When the browser starts handling the gesture (e.g. scrolling), it sends a pointercancel event and stops</span>
    <span class="s0">// sending additional pointer events. This is not the case with touch events, so if the gesture is simultaneous</span>
    <span class="s0">// with a NativeGestureHandler, we need to check if touch events are supported and use them if possible.</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer </span><span class="s2">=</span>
      <span class="s3">SUPPORTS_TOUCH </span><span class="s2">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s7">shouldUseTouchEvents</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">)</span>
        <span class="s2">? new </span><span class="s3">Hammer</span><span class="s1">.</span><span class="s7">Manager</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">view </span><span class="s2">as </span><span class="s3">any</span><span class="s1">, {</span>
            <span class="s1">inputClass: </span><span class="s3">Hammer</span><span class="s1">.</span><span class="s3">TouchInput</span><span class="s1">,</span>
          <span class="s1">})</span>
        <span class="s2">: new </span><span class="s3">Hammer</span><span class="s1">.</span><span class="s7">Manager</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">view </span><span class="s2">as </span><span class="s3">any</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s3">oldState </span><span class="s2">= </span><span class="s3">State</span><span class="s1">.</span><span class="s3">UNDETERMINED</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">previousState </span><span class="s2">= </span><span class="s3">State</span><span class="s1">.</span><span class="s3">UNDETERMINED</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">lastSentState </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>

    <span class="s2">const </span><span class="s1">{ NativeGestureClass } </span><span class="s2">= </span><span class="s3">this</span><span class="s1">;</span>
    <span class="s0">// @ts-ignore TODO(TS)</span>
    <span class="s2">const </span><span class="s1">gesture </span><span class="s2">= new </span><span class="s7">NativeGestureClass</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s7">getHammerConfig</span><span class="s1">());</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s1">.</span><span class="s7">add</span><span class="s1">(</span><span class="s3">gesture</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s1">.</span><span class="s7">on</span><span class="s1">(</span><span class="s4">'hammer.input'</span><span class="s1">, (</span><span class="s3">ev</span><span class="s2">: </span><span class="s3">HammerInput</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s1">{</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">enabled</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">isGestureRunning </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
        <span class="s2">return</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">this</span><span class="s1">.</span><span class="s7">onRawEvent</span><span class="s1">(</span><span class="s3">ev </span><span class="s2">as </span><span class="s3">unknown </span><span class="s2">as </span><span class="s3">HammerInputExt</span><span class="s1">);</span>

      <span class="s0">// TODO: Bacon: Check against something other than null</span>
      <span class="s0">// The isFirst value is not called when the first rotation is calculated.</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">initialRotation </span><span class="s2">=== </span><span class="s5">null </span><span class="s2">&amp;&amp; </span><span class="s3">ev</span><span class="s1">.</span><span class="s3">rotation </span><span class="s2">!== </span><span class="s6">0</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">initialRotation </span><span class="s2">= </span><span class="s3">ev</span><span class="s1">.</span><span class="s3">rotation</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s3">ev</span><span class="s1">.</span><span class="s3">isFinal</span><span class="s1">) {</span>
        <span class="s0">// in favor of a willFail otherwise the last frame of the gesture will be captured.</span>
        <span class="s7">setTimeout</span><span class="s1">(() </span><span class="s2">=&gt; </span><span class="s1">{</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s3">initialRotation </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
        <span class="s1">});</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s7">setupEvents</span><span class="s1">();</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">sync</span><span class="s1">();</span>
  <span class="s1">}</span>

  <span class="s1">setupEvents() {</span>
    <span class="s0">// TODO(TS) Hammer types aren't exactly that what we get in runtime</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span><span class="s3">this</span><span class="s1">.</span><span class="s3">isDiscrete</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s2">!</span><span class="s1">.</span><span class="s7">on</span><span class="s1">(</span><span class="s4">`${</span><span class="s3">this</span><span class="s4">.</span><span class="s3">name</span><span class="s4">}start`</span><span class="s1">, (</span><span class="s3">event</span><span class="s2">: </span><span class="s3">HammerInput</span><span class="s1">) </span><span class="s2">=&gt;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s7">onStart</span><span class="s1">(</span><span class="s3">event </span><span class="s2">as </span><span class="s3">unknown </span><span class="s2">as </span><span class="s3">HammerInputExt</span><span class="s1">)</span>
      <span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s2">!</span><span class="s1">.</span><span class="s7">on</span><span class="s1">(</span>
        <span class="s4">`${</span><span class="s3">this</span><span class="s4">.</span><span class="s3">name</span><span class="s4">}end ${</span><span class="s3">this</span><span class="s4">.</span><span class="s3">name</span><span class="s4">}cancel`</span><span class="s1">,</span>
        <span class="s1">(</span><span class="s3">event</span><span class="s2">: </span><span class="s3">HammerInput</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s1">{</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s7">onGestureEnded</span><span class="s1">(</span><span class="s3">event </span><span class="s2">as </span><span class="s3">unknown </span><span class="s2">as </span><span class="s3">HammerInputExt</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s2">!</span><span class="s1">.</span><span class="s7">on</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">name</span><span class="s1">, (</span><span class="s3">ev</span><span class="s2">: </span><span class="s3">HammerInput</span><span class="s1">) </span><span class="s2">=&gt;</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s7">onGestureActivated</span><span class="s1">(</span><span class="s3">ev </span><span class="s2">as </span><span class="s3">unknown </span><span class="s2">as </span><span class="s3">HammerInputExt</span><span class="s1">)</span>
    <span class="s1">); </span><span class="s0">// TODO(TS) remove cast after https://github.com/DefinitelyTyped/DefinitelyTyped/pull/50438 is merged</span>
  <span class="s1">}</span>

  <span class="s1">onStart({ </span><span class="s3">deltaX</span><span class="s1">, </span><span class="s3">deltaY</span><span class="s1">, </span><span class="s3">rotation </span><span class="s1">}</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s0">// Reset the state for the next gesture</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">oldState </span><span class="s2">= </span><span class="s3">State</span><span class="s1">.</span><span class="s3">UNDETERMINED</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">previousState </span><span class="s2">= </span><span class="s3">State</span><span class="s1">.</span><span class="s3">UNDETERMINED</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">lastSentState </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>

    <span class="s3">this</span><span class="s1">.</span><span class="s3">isGestureRunning </span><span class="s2">= </span><span class="s5">true</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">__initialX </span><span class="s2">= </span><span class="s3">deltaX</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">__initialY </span><span class="s2">= </span><span class="s3">deltaY</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s3">initialRotation </span><span class="s2">= </span><span class="s3">rotation</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">onGestureActivated(</span><span class="s3">ev</span><span class="s2">: </span><span class="s3">HammerInputExt</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.</span><span class="s7">sendEvent</span><span class="s1">(</span><span class="s3">ev</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s1">onSuccess() {}</span>

  <span class="s1">_getPendingGestures() {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s7">isArray</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">) </span><span class="s2">&amp;&amp; </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">.length) {</span>
      <span class="s0">// Get the list of gestures that this gesture is still waiting for.</span>
      <span class="s0">// Use `=== false` in case a ref that isn't a gesture handler is used.</span>
      <span class="s2">const </span><span class="s1">stillWaiting </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">.</span><span class="s7">filter</span><span class="s1">(</span>
        <span class="s1">({ </span><span class="s3">hasGestureFailed </span><span class="s1">}) </span><span class="s2">=&gt; </span><span class="s3">hasGestureFailed </span><span class="s2">=== </span><span class="s5">false</span>
      <span class="s1">);</span>
      <span class="s2">return </span><span class="s3">stillWaiting</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">return </span><span class="s1">[];</span>
  <span class="s1">}</span>

  <span class="s1">getHammerConfig() {</span>
    <span class="s2">const </span><span class="s1">pointers </span><span class="s2">=</span>
      <span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">minPointers </span><span class="s2">=== </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">maxPointers</span>
        <span class="s2">? </span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">minPointers</span>
        <span class="s2">: </span><span class="s6">0</span><span class="s1">;</span>
    <span class="s2">return </span><span class="s1">{</span>
      <span class="s3">pointers</span><span class="s1">,</span>
    <span class="s1">};</span>
  <span class="s1">}</span>

  <span class="s1">sync </span><span class="s2">= </span><span class="s1">() </span><span class="s2">=&gt; </span><span class="s1">{</span>
    <span class="s2">const </span><span class="s1">gesture </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s3">hammer</span><span class="s2">!</span><span class="s1">.</span><span class="s7">get</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">name</span><span class="s1">);</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span><span class="s3">gesture</span><span class="s1">) </span><span class="s2">return</span><span class="s1">;</span>

    <span class="s2">const </span><span class="s1">enable </span><span class="s2">= </span><span class="s1">(</span><span class="s3">recognizer</span><span class="s2">: </span><span class="s3">any</span><span class="s1">, </span><span class="s3">inputData</span><span class="s2">: </span><span class="s3">any</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s1">{</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">.</span><span class="s3">enabled</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">isGestureRunning </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
        <span class="s2">return </span><span class="s5">false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s0">// Prevent events before the system is ready.</span>
      <span class="s2">if </span><span class="s1">(</span>
        <span class="s2">!</span><span class="s3">inputData </span><span class="s2">||</span>
        <span class="s2">!</span><span class="s3">recognizer</span><span class="s1">.</span><span class="s3">options </span><span class="s2">||</span>
        <span class="s2">typeof </span><span class="s3">inputData</span><span class="s1">.</span><span class="s3">maxPointers </span><span class="s2">=== </span><span class="s4">'undefined'</span>
      <span class="s1">) {</span>
        <span class="s2">return </span><span class="s3">this</span><span class="s1">.</span><span class="s3">shouldEnableGestureOnSetup</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed</span><span class="s1">) {</span>
        <span class="s2">return </span><span class="s5">false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span><span class="s3">this</span><span class="s1">.</span><span class="s3">isDiscrete</span><span class="s1">) {</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">isGestureRunning</span><span class="s1">) {</span>
          <span class="s2">return </span><span class="s5">true</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s0">// The built-in hammer.js &quot;waitFor&quot; doesn't work across multiple views.</span>
        <span class="s0">// Only process if there are views to wait for.</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">_stillWaiting </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">_getPendingGestures</span><span class="s1">();</span>
        <span class="s0">// This gesture should continue waiting.</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">_stillWaiting</span><span class="s1">.length) {</span>
          <span class="s0">// Check to see if one of the gestures you're waiting for has started.</span>
          <span class="s0">// If it has then the gesture should fail.</span>
          <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">gesture </span><span class="s2">of </span><span class="s3">this</span><span class="s1">.</span><span class="s3">_stillWaiting</span><span class="s1">) {</span>
            <span class="s0">// When the target gesture has started, this gesture must force fail.</span>
            <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span><span class="s3">gesture</span><span class="s1">.</span><span class="s3">isDiscrete </span><span class="s2">&amp;&amp; </span><span class="s3">gesture</span><span class="s1">.</span><span class="s3">isGestureRunning</span><span class="s1">) {</span>
              <span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">true</span><span class="s1">;</span>
              <span class="s3">this</span><span class="s1">.</span><span class="s3">isGestureRunning </span><span class="s2">= </span><span class="s5">false</span><span class="s1">;</span>
              <span class="s2">return </span><span class="s5">false</span><span class="s1">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
          <span class="s0">// This gesture shouldn't start until the others have finished.</span>
          <span class="s2">return </span><span class="s5">false</span><span class="s1">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s0">// Use default behaviour</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s2">!</span><span class="s3">this</span><span class="s1">.</span><span class="s3">hasCustomActivationCriteria</span><span class="s1">) {</span>
        <span class="s2">return </span><span class="s5">true</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s2">const </span><span class="s1">deltaRotation </span><span class="s2">=</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">initialRotation </span><span class="s2">== </span><span class="s5">null</span>
          <span class="s2">? </span><span class="s6">0</span>
          <span class="s2">: </span><span class="s3">inputData</span><span class="s1">.</span><span class="s3">rotation </span><span class="s2">- </span><span class="s3">this</span><span class="s1">.</span><span class="s3">initialRotation</span><span class="s1">;</span>
      <span class="s0">// @ts-ignore FIXME(TS)</span>
      <span class="s2">const </span><span class="s1">{ success, failed } </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">isGestureEnabledForEvent</span><span class="s1">(</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s7">getConfig</span><span class="s1">(),</span>
        <span class="s3">recognizer</span><span class="s1">,</span>
        <span class="s1">{</span>
          <span class="s2">...</span><span class="s3">inputData</span><span class="s1">,</span>
          <span class="s3">deltaRotation</span><span class="s1">,</span>
        <span class="s1">}</span>
      <span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">failed</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s7">simulateCancelEvent</span><span class="s1">(</span><span class="s3">inputData</span><span class="s1">);</span>
        <span class="s3">this</span><span class="s1">.</span><span class="s3">hasGestureFailed </span><span class="s2">= </span><span class="s5">true</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s2">return </span><span class="s3">success</span><span class="s1">;</span>
    <span class="s1">};</span>

    <span class="s2">const </span><span class="s1">params </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">getHammerConfig</span><span class="s1">();</span>
    <span class="s0">// @ts-ignore FIXME(TS)</span>
    <span class="s3">gesture</span><span class="s1">.</span><span class="s7">set</span><span class="s1">({ </span><span class="s2">...</span><span class="s3">params</span><span class="s1">, </span><span class="s3">enable </span><span class="s1">});</span>
  <span class="s1">};</span>

  <span class="s1">simulateCancelEvent(</span><span class="s3">_inputData</span><span class="s2">: </span><span class="s3">any</span><span class="s1">) {}</span>

  <span class="s0">// Validate the props</span>
  <span class="s1">ensureConfig(</span><span class="s3">config</span><span class="s2">: </span><span class="s3">Config</span><span class="s1">)</span><span class="s2">: </span><span class="s3">Required</span><span class="s1">&lt;</span><span class="s3">Config</span><span class="s1">&gt; {</span>
    <span class="s2">const </span><span class="s1">props </span><span class="s2">= </span><span class="s1">{ </span><span class="s2">...</span><span class="s3">config </span><span class="s1">};</span>

    <span class="s0">// TODO(TS) We use ! to assert that if property is present then value is not empty (null, undefined)</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s4">'minDist' </span><span class="s2">in </span><span class="s3">config</span><span class="s1">) {</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">minDist </span><span class="s2">= </span><span class="s3">config</span><span class="s1">.</span><span class="s3">minDist</span><span class="s1">;</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">minDistSq </span><span class="s2">= </span><span class="s3">props</span><span class="s1">.</span><span class="s3">minDist</span><span class="s2">! * </span><span class="s3">props</span><span class="s1">.</span><span class="s3">minDist</span><span class="s2">!</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s4">'minVelocity' </span><span class="s2">in </span><span class="s3">config</span><span class="s1">) {</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">minVelocity </span><span class="s2">= </span><span class="s3">config</span><span class="s1">.</span><span class="s3">minVelocity</span><span class="s1">;</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">minVelocitySq </span><span class="s2">= </span><span class="s3">props</span><span class="s1">.</span><span class="s3">minVelocity</span><span class="s2">! * </span><span class="s3">props</span><span class="s1">.</span><span class="s3">minVelocity</span><span class="s2">!</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s4">'maxDist' </span><span class="s2">in </span><span class="s3">config</span><span class="s1">) {</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">maxDist </span><span class="s2">= </span><span class="s3">config</span><span class="s1">.</span><span class="s3">maxDist</span><span class="s1">;</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">maxDistSq </span><span class="s2">= </span><span class="s3">config</span><span class="s1">.</span><span class="s3">maxDist</span><span class="s2">! * </span><span class="s3">config</span><span class="s1">.</span><span class="s3">maxDist</span><span class="s2">!</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s4">'waitFor' </span><span class="s2">in </span><span class="s3">config</span><span class="s1">) {</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">waitFor </span><span class="s2">= </span><span class="s7">asArray</span><span class="s1">(</span><span class="s3">config</span><span class="s1">.</span><span class="s3">waitFor</span><span class="s1">)</span>
        <span class="s1">.</span><span class="s7">map</span><span class="s1">(({ </span><span class="s3">handlerTag </span><span class="s1">}</span><span class="s2">: </span><span class="s1">{ handlerTag</span><span class="s2">: </span><span class="s3">number </span><span class="s1">}) </span><span class="s2">=&gt;</span>
          <span class="s3">NodeManager</span><span class="s1">.</span><span class="s7">getHandler</span><span class="s1">(</span><span class="s3">handlerTag</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">.</span><span class="s7">filter</span><span class="s1">((</span><span class="s3">v</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s3">v</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">waitFor </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s4">'simultaneousHandlers' </span><span class="s2">in </span><span class="s3">config</span><span class="s1">) {</span>
      <span class="s2">const </span><span class="s1">shouldUseTouchEvents </span><span class="s2">= </span><span class="s3">this</span><span class="s1">.</span><span class="s7">shouldUseTouchEvents</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">config</span><span class="s1">);</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">simultaneousHandlers </span><span class="s2">= </span><span class="s7">asArray</span><span class="s1">(</span><span class="s3">config</span><span class="s1">.</span><span class="s3">simultaneousHandlers</span><span class="s1">)</span>
        <span class="s1">.</span><span class="s7">map</span><span class="s1">((</span><span class="s3">handler</span><span class="s2">: </span><span class="s3">number </span><span class="s2">| </span><span class="s3">GestureHandler</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s1">{</span>
          <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">handler </span><span class="s2">=== </span><span class="s4">'number'</span><span class="s1">) {</span>
            <span class="s2">return </span><span class="s3">NodeManager</span><span class="s1">.</span><span class="s7">getHandler</span><span class="s1">(</span><span class="s3">handler</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
            <span class="s2">return </span><span class="s3">NodeManager</span><span class="s1">.</span><span class="s7">getHandler</span><span class="s1">(</span><span class="s3">handler</span><span class="s1">.</span><span class="s3">handlerTag</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">})</span>
        <span class="s1">.</span><span class="s7">filter</span><span class="s1">((</span><span class="s3">v</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s3">v</span><span class="s1">);</span>

      <span class="s2">if </span><span class="s1">(</span><span class="s3">shouldUseTouchEvents </span><span class="s2">!== </span><span class="s3">this</span><span class="s1">.</span><span class="s7">shouldUseTouchEvents</span><span class="s1">(</span><span class="s3">props</span><span class="s1">)) {</span>
        <span class="s7">queueMicrotask</span><span class="s1">(() </span><span class="s2">=&gt; </span><span class="s1">{</span>
          <span class="s0">// if the undelying event API needs to be changed, we need to unmount and mount</span>
          <span class="s0">// the hammer instance again.</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s7">destroy</span><span class="s1">();</span>
          <span class="s3">this</span><span class="s1">.</span><span class="s7">setView</span><span class="s1">(</span><span class="s3">this</span><span class="s1">.</span><span class="s3">ref</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.</span><span class="s3">propsRef</span><span class="s1">);</span>
        <span class="s1">});</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s3">props</span><span class="s1">.</span><span class="s3">simultaneousHandlers </span><span class="s2">= </span><span class="s5">null</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">const </span><span class="s1">configProps </span><span class="s2">= </span><span class="s1">[</span>
      <span class="s4">'minPointers'</span><span class="s1">,</span>
      <span class="s4">'maxPointers'</span><span class="s1">,</span>
      <span class="s4">'minDist'</span><span class="s1">,</span>
      <span class="s4">'maxDist'</span><span class="s1">,</span>
      <span class="s4">'maxDistSq'</span><span class="s1">,</span>
      <span class="s4">'minVelocitySq'</span><span class="s1">,</span>
      <span class="s4">'minDistSq'</span><span class="s1">,</span>
      <span class="s4">'minVelocity'</span><span class="s1">,</span>
      <span class="s4">'failOffsetXStart'</span><span class="s1">,</span>
      <span class="s4">'failOffsetYStart'</span><span class="s1">,</span>
      <span class="s4">'failOffsetXEnd'</span><span class="s1">,</span>
      <span class="s4">'failOffsetYEnd'</span><span class="s1">,</span>
      <span class="s4">'activeOffsetXStart'</span><span class="s1">,</span>
      <span class="s4">'activeOffsetXEnd'</span><span class="s1">,</span>
      <span class="s4">'activeOffsetYStart'</span><span class="s1">,</span>
      <span class="s4">'activeOffsetYEnd'</span><span class="s1">,</span>
    <span class="s1">] </span><span class="s2">as const</span><span class="s1">;</span>
    <span class="s3">configProps</span><span class="s1">.</span><span class="s7">forEach</span><span class="s1">((</span><span class="s3">prop</span><span class="s2">: typeof </span><span class="s3">configProps</span><span class="s1">[</span><span class="s3">number</span><span class="s1">]) </span><span class="s2">=&gt; </span><span class="s1">{</span>
      <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">props</span><span class="s1">[</span><span class="s3">prop</span><span class="s1">] </span><span class="s2">=== </span><span class="s4">'undefined'</span><span class="s1">) {</span>
        <span class="s3">props</span><span class="s1">[</span><span class="s3">prop</span><span class="s1">] </span><span class="s2">= </span><span class="s3">Number</span><span class="s1">.</span><span class="s3">NaN</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
    <span class="s2">return </span><span class="s3">props </span><span class="s2">as </span><span class="s3">Required</span><span class="s1">&lt;</span><span class="s3">Config</span><span class="s1">&gt;; </span><span class="s0">// TODO(TS) how to convince TS that props are filled?</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">// TODO(TS) investigate this method</span>
<span class="s0">// Used for sending data to a callback or AnimatedEvent</span>
<span class="s2">function </span><span class="s1">invokeNullableMethod(</span>
  <span class="s3">method</span><span class="s2">:</span>
    <span class="s2">| </span><span class="s1">((</span><span class="s3">event</span><span class="s2">: </span><span class="s3">NativeEvent</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s3">void</span><span class="s1">)</span>
    <span class="s2">| </span><span class="s1">{ __getHandler</span><span class="s2">: </span><span class="s1">() </span><span class="s2">=&gt; </span><span class="s1">(</span><span class="s3">event</span><span class="s2">: </span><span class="s3">NativeEvent</span><span class="s1">) </span><span class="s2">=&gt; </span><span class="s3">void </span><span class="s1">}</span>
    <span class="s2">| </span><span class="s1">{ __nodeConfig</span><span class="s2">: </span><span class="s1">{ argMapping</span><span class="s2">: </span><span class="s3">any </span><span class="s1">} },</span>
  <span class="s3">event</span><span class="s2">: </span><span class="s3">NativeEvent</span>
<span class="s1">) {</span>
  <span class="s2">if </span><span class="s1">(</span><span class="s3">method</span><span class="s1">) {</span>
    <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s3">method </span><span class="s2">=== </span><span class="s4">'function'</span><span class="s1">) {</span>
      <span class="s7">method</span><span class="s1">(</span><span class="s3">event</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s0">// For use with reanimated's AnimatedEvent</span>
      <span class="s2">if </span><span class="s1">(</span>
        <span class="s4">'__getHandler' </span><span class="s2">in </span><span class="s3">method </span><span class="s2">&amp;&amp;</span>
        <span class="s2">typeof </span><span class="s3">method</span><span class="s1">.</span><span class="s3">__getHandler </span><span class="s2">=== </span><span class="s4">'function'</span>
      <span class="s1">) {</span>
        <span class="s2">const </span><span class="s1">handler </span><span class="s2">= </span><span class="s3">method</span><span class="s1">.</span><span class="s7">__getHandler</span><span class="s1">();</span>
        <span class="s7">invokeNullableMethod</span><span class="s1">(</span><span class="s3">handler</span><span class="s1">, </span><span class="s3">event</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
        <span class="s2">if </span><span class="s1">(</span><span class="s4">'__nodeConfig' </span><span class="s2">in </span><span class="s3">method</span><span class="s1">) {</span>
          <span class="s2">const </span><span class="s1">{ argMapping } </span><span class="s2">= </span><span class="s3">method</span><span class="s1">.</span><span class="s3">__nodeConfig</span><span class="s1">;</span>
          <span class="s2">if </span><span class="s1">(</span><span class="s3">Array</span><span class="s1">.</span><span class="s7">isArray</span><span class="s1">(</span><span class="s3">argMapping</span><span class="s1">)) {</span>
            <span class="s2">for </span><span class="s1">(</span><span class="s2">const </span><span class="s1">[index, [key, value]] </span><span class="s2">of </span><span class="s3">argMapping</span><span class="s1">.</span><span class="s7">entries</span><span class="s1">()) {</span>
              <span class="s2">if </span><span class="s1">(</span><span class="s3">key </span><span class="s2">in </span><span class="s3">event</span><span class="s1">.</span><span class="s3">nativeEvent</span><span class="s1">) {</span>
                <span class="s0">// @ts-ignore fix method type</span>
                <span class="s2">const </span><span class="s1">nativeValue </span><span class="s2">= </span><span class="s3">event</span><span class="s1">.</span><span class="s3">nativeEvent</span><span class="s1">[</span><span class="s3">key</span><span class="s1">];</span>
                <span class="s2">if </span><span class="s1">(</span><span class="s3">value </span><span class="s2">&amp;&amp; </span><span class="s3">value</span><span class="s1">.</span><span class="s3">setValue</span><span class="s1">) {</span>
                  <span class="s0">// Reanimated API</span>
                  <span class="s3">value</span><span class="s1">.</span><span class="s7">setValue</span><span class="s1">(</span><span class="s3">nativeValue</span><span class="s1">);</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                  <span class="s0">// RN Animated API</span>
                  <span class="s3">method</span><span class="s1">.</span><span class="s3">__nodeConfig</span><span class="s1">.</span><span class="s3">argMapping</span><span class="s1">[</span><span class="s3">index</span><span class="s1">] </span><span class="s2">= </span><span class="s1">[</span><span class="s3">key</span><span class="s1">, </span><span class="s3">nativeValue</span><span class="s1">];</span>
                <span class="s1">}</span>
              <span class="s1">}</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">function </span><span class="s1">asArray&lt;</span><span class="s3">T</span><span class="s1">&gt;(</span><span class="s3">value</span><span class="s2">: </span><span class="s3">T </span><span class="s2">| </span><span class="s3">T</span><span class="s1">[]) {</span>
  <span class="s0">// TODO(TS) use config.waitFor type</span>
  <span class="s2">return </span><span class="s3">value </span><span class="s2">== </span><span class="s5">null </span><span class="s2">? </span><span class="s1">[] </span><span class="s2">: </span><span class="s3">Array</span><span class="s1">.</span><span class="s7">isArray</span><span class="s1">(</span><span class="s3">value</span><span class="s1">) </span><span class="s2">? </span><span class="s3">value </span><span class="s2">: </span><span class="s1">[</span><span class="s3">value</span><span class="s1">];</span>
<span class="s1">}</span>

<span class="s2">export default </span><span class="s3">GestureHandler</span><span class="s1">;</span>
</pre>
</body>
</html>