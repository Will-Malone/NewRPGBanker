<html>
<head>
<title>DevSupportManagerBase.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #629755; font-style: italic;}
.s6 { color: #629755; font-weight: bold; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DevSupportManagerBase.java</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">package </span><span class="s1">com.facebook.react.devsupport</span><span class="s2">;</span>

<span class="s2">import </span><span class="s1">android.app.Activity</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.app.ActivityManager</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.app.AlertDialog</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.content.BroadcastReceiver</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.content.Context</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.content.DialogInterface</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.content.Intent</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.content.IntentFilter</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.content.pm.PackageInfo</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.content.pm.PackageManager</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.graphics.Color</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.graphics.Typeface</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.hardware.SensorManager</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.util.Pair</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.view.Gravity</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.view.View</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.widget.EditText</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.widget.LinearLayout</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.widget.TextView</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.widget.Toast</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">androidx.annotation.Nullable</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">androidx.annotation.UiThread</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.common.logging.FLog</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.infer.annotation.Assertions</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.R</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.DefaultJSExceptionHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.JSBundleLoader</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.ReactContext</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.ReactMarker</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.ReactMarkerConstants</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.ReadableArray</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.UiThreadUtil</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.common.DebugServerException</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.common.ReactConstants</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.common.ShakeDetector</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.common.SurfaceDelegate</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.common.SurfaceDelegateFactory</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.DevServerHelper.PackagerCommandListener</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.BundleLoadCallback</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.DevBundleDownloadListener</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.DevLoadingViewManager</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.DevOptionHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.DevSupportManager</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.ErrorCustomizer</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.ErrorType</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.PackagerStatusCallback</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.RedBoxHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.StackFrame</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.modules.core.RCTNativeAppEventEmitter</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.RequestHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.Responder</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.io.File</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.net.MalformedURLException</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.net.URL</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.ArrayList</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.LinkedHashMap</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.List</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Locale</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Map</span><span class="s2">;</span>

<span class="s2">public abstract class </span><span class="s1">DevSupportManagerBase </span><span class="s2">implements </span><span class="s1">DevSupportManager {</span>

  <span class="s2">public interface </span><span class="s1">CallbackWithBundleLoader {</span>
    <span class="s2">void </span><span class="s1">onSuccess(JSBundleLoader bundleLoader)</span><span class="s2">;</span>

    <span class="s2">void </span><span class="s1">onError(String url</span><span class="s2">, </span><span class="s1">Throwable cause)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static final int </span><span class="s1">JAVA_ERROR_COOKIE = -</span><span class="s3">1</span><span class="s2">;</span>
  <span class="s2">private static final int </span><span class="s1">JSEXCEPTION_ERROR_COOKIE = -</span><span class="s3">1</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">String RELOAD_APP_ACTION_SUFFIX = </span><span class="s4">&quot;.RELOAD_APP_ACTION&quot;</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">String FLIPPER_DEBUGGER_URL =</span>
      <span class="s4">&quot;flipper://null/Hermesdebuggerrn?device=React%20Native&quot;</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">String FLIPPER_DEVTOOLS_URL = </span><span class="s4">&quot;flipper://null/React?device=React%20Native&quot;</span><span class="s2">;</span>
  <span class="s2">private static final </span><span class="s1">String EXOPACKAGE_LOCATION_FORMAT =</span>
      <span class="s4">&quot;/data/local/tmp/exopackage/%s//secondary-dex&quot;</span><span class="s2">;</span>

  <span class="s2">public static final </span><span class="s1">String EMOJI_HUNDRED_POINTS_SYMBOL = </span><span class="s4">&quot; </span><span class="s2">\uD83D\uDCAF</span><span class="s4">&quot;</span><span class="s2">;</span>
  <span class="s2">public static final </span><span class="s1">String EMOJI_FACE_WITH_NO_GOOD_GESTURE = </span><span class="s4">&quot; </span><span class="s2">\uD83D\uDE45</span><span class="s4">&quot;</span><span class="s2">;</span>

  <span class="s2">private final </span><span class="s1">Context mApplicationContext</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">ShakeDetector mShakeDetector</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">BroadcastReceiver mReloadAppBroadcastReceiver</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">DevServerHelper mDevServerHelper</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">LinkedHashMap&lt;String</span><span class="s2">, </span><span class="s1">DevOptionHandler&gt; mCustomDevOptions = </span><span class="s2">new </span><span class="s1">LinkedHashMap&lt;&gt;()</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">ReactInstanceDevHelper mReactInstanceDevHelper</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">@Nullable String mJSAppBundleName</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">File mJSBundleDownloadedFile</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">File mJSSplitBundlesDir</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">DefaultJSExceptionHandler mDefaultJSExceptionHandler</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">DevLoadingViewManager mDevLoadingViewManager</span><span class="s2">;</span>

  <span class="s2">private </span><span class="s1">@Nullable SurfaceDelegate mRedBoxSurfaceDelegate</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable AlertDialog mDevOptionsDialog</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable DebugOverlayController mDebugOverlayController</span><span class="s2">;</span>
  <span class="s2">private boolean </span><span class="s1">mDevLoadingViewVisible = </span><span class="s2">false;</span>
  <span class="s2">private int </span><span class="s1">mPendingJSSplitBundleRequests = </span><span class="s3">0</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable ReactContext mCurrentContext</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">DevInternalSettings mDevSettings</span><span class="s2">;</span>
  <span class="s2">private boolean </span><span class="s1">mIsReceiverRegistered = </span><span class="s2">false;</span>
  <span class="s2">private boolean </span><span class="s1">mIsShakeDetectorStarted = </span><span class="s2">false;</span>
  <span class="s2">private boolean </span><span class="s1">mIsDevSupportEnabled = </span><span class="s2">false;</span>
  <span class="s2">private </span><span class="s1">@Nullable RedBoxHandler mRedBoxHandler</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable String mLastErrorTitle</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable StackFrame[] mLastErrorStack</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable ErrorType mLastErrorType</span><span class="s2">;</span>
  <span class="s2">private int </span><span class="s1">mLastErrorCookie = </span><span class="s3">0</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable DevBundleDownloadListener mBundleDownloadListener</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable List&lt;ErrorCustomizer&gt; mErrorCustomizers</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable PackagerLocationCustomizer mPackagerLocationCustomizer</span><span class="s2">;</span>

  <span class="s2">private </span><span class="s1">InspectorPackagerConnection.BundleStatus mBundleStatus</span><span class="s2">;</span>

  <span class="s2">private </span><span class="s1">@Nullable Map&lt;String</span><span class="s2">, </span><span class="s1">RequestHandler&gt; mCustomPackagerCommandHandlers</span><span class="s2">;</span>

  <span class="s2">private </span><span class="s1">@Nullable Activity currentActivity</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable </span><span class="s2">final </span><span class="s1">SurfaceDelegateFactory mSurfaceDelegateFactory</span><span class="s2">;</span>

  <span class="s2">public </span><span class="s1">DevSupportManagerBase(</span>
      <span class="s1">Context applicationContext</span><span class="s2">,</span>
      <span class="s1">ReactInstanceDevHelper reactInstanceDevHelper</span><span class="s2">,</span>
      <span class="s1">@Nullable String packagerPathForJSBundleName</span><span class="s2">,</span>
      <span class="s2">boolean </span><span class="s1">enableOnCreate</span><span class="s2">,</span>
      <span class="s1">@Nullable RedBoxHandler redBoxHandler</span><span class="s2">,</span>
      <span class="s1">@Nullable DevBundleDownloadListener devBundleDownloadListener</span><span class="s2">,</span>
      <span class="s2">int </span><span class="s1">minNumShakes</span><span class="s2">,</span>
      <span class="s1">@Nullable Map&lt;String</span><span class="s2">, </span><span class="s1">RequestHandler&gt; customPackagerCommandHandlers</span><span class="s2">,</span>
      <span class="s1">@Nullable SurfaceDelegateFactory surfaceDelegateFactory</span><span class="s2">,</span>
      <span class="s1">@Nullable DevLoadingViewManager devLoadingViewManager) {</span>
    <span class="s1">mReactInstanceDevHelper = reactInstanceDevHelper</span><span class="s2">;</span>
    <span class="s1">mApplicationContext = applicationContext</span><span class="s2">;</span>
    <span class="s1">mJSAppBundleName = packagerPathForJSBundleName</span><span class="s2">;</span>
    <span class="s1">mDevSettings =</span>
        <span class="s2">new </span><span class="s1">DevInternalSettings(</span>
            <span class="s1">applicationContext</span><span class="s2">,</span>
            <span class="s2">new </span><span class="s1">DevInternalSettings.Listener() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onInternalSettingsChanged() {</span>
                <span class="s1">reloadSettings()</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">mBundleStatus = </span><span class="s2">new </span><span class="s1">InspectorPackagerConnection.BundleStatus()</span><span class="s2">;</span>
    <span class="s1">mDevServerHelper =</span>
        <span class="s2">new </span><span class="s1">DevServerHelper(</span>
            <span class="s1">mDevSettings</span><span class="s2">,</span>
            <span class="s1">mApplicationContext.getPackageName()</span><span class="s2">,</span>
            <span class="s2">new </span><span class="s1">InspectorPackagerConnection.BundleStatusProvider() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public </span><span class="s1">InspectorPackagerConnection.BundleStatus getBundleStatus() {</span>
                <span class="s2">return </span><span class="s1">mBundleStatus</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">mBundleDownloadListener = devBundleDownloadListener</span><span class="s2">;</span>

    <span class="s0">// Prepare shake gesture detector (will be started/stopped from #reload)</span>
    <span class="s1">mShakeDetector =</span>
        <span class="s2">new </span><span class="s1">ShakeDetector(</span>
            <span class="s2">new </span><span class="s1">ShakeDetector.ShakeListener() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onShake() {</span>
                <span class="s1">showDevOptionsDialog()</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">}</span><span class="s2">,</span>
            <span class="s1">minNumShakes)</span><span class="s2">;</span>

    <span class="s1">mCustomPackagerCommandHandlers = customPackagerCommandHandlers</span><span class="s2">;</span>

    <span class="s0">// Prepare reload APP broadcast receiver (will be registered/unregistered from #reload)</span>
    <span class="s1">mReloadAppBroadcastReceiver =</span>
        <span class="s2">new </span><span class="s1">BroadcastReceiver() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onReceive(Context context</span><span class="s2">, </span><span class="s1">Intent intent) {</span>
            <span class="s1">String action = intent.getAction()</span><span class="s2">;</span>
            <span class="s2">if </span><span class="s1">(getReloadAppAction(context).equals(action)) {</span>
              <span class="s2">if </span><span class="s1">(intent.getBooleanExtra(DevServerHelper.RELOAD_APP_EXTRA_JS_PROXY</span><span class="s2">, false</span><span class="s1">)) {</span>
                <span class="s1">mDevSettings.setRemoteJSDebugEnabled(</span><span class="s2">true</span><span class="s1">)</span><span class="s2">;</span>
                <span class="s1">mDevServerHelper.launchJSDevtools()</span><span class="s2">;</span>
              <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s1">mDevSettings.setRemoteJSDebugEnabled(</span><span class="s2">false</span><span class="s1">)</span><span class="s2">;</span>
              <span class="s1">}</span>
              <span class="s1">handleReloadJS()</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">}</span><span class="s2">;</span>

    <span class="s0">// We store JS bundle loaded from dev server in a single destination in app's data dir.</span>
    <span class="s0">// In case when someone schedule 2 subsequent reloads it may happen that JS thread will</span>
    <span class="s0">// start reading first reload output while the second reload starts writing to the same</span>
    <span class="s0">// file. As this should only be the case in dev mode we leave it as it is.</span>
    <span class="s0">// TODO(6418010): Fix readers-writers problem in debug reload from HTTP server</span>
    <span class="s2">final </span><span class="s1">String subclassTag = getUniqueTag()</span><span class="s2">;</span>
    <span class="s2">final </span><span class="s1">String bundleFile = subclassTag + </span><span class="s4">&quot;ReactNativeDevBundle.js&quot;</span><span class="s2">;</span>
    <span class="s1">mJSBundleDownloadedFile = </span><span class="s2">new </span><span class="s1">File(applicationContext.getFilesDir()</span><span class="s2">, </span><span class="s1">bundleFile)</span><span class="s2">;</span>

    <span class="s2">final </span><span class="s1">String splitBundlesDir = subclassTag.toLowerCase(Locale.ROOT) + </span><span class="s4">&quot;_dev_js_split_bundles&quot;</span><span class="s2">;</span>
    <span class="s1">mJSSplitBundlesDir = mApplicationContext.getDir(splitBundlesDir</span><span class="s2">, </span><span class="s1">Context.MODE_PRIVATE)</span><span class="s2">;</span>

    <span class="s1">mDefaultJSExceptionHandler = </span><span class="s2">new </span><span class="s1">DefaultJSExceptionHandler()</span><span class="s2">;</span>

    <span class="s1">setDevSupportEnabled(enableOnCreate)</span><span class="s2">;</span>

    <span class="s1">mRedBoxHandler = redBoxHandler</span><span class="s2">;</span>
    <span class="s1">mDevLoadingViewManager =</span>
        <span class="s1">devLoadingViewManager != </span><span class="s2">null</span>
            <span class="s1">? devLoadingViewManager</span>
            <span class="s1">: </span><span class="s2">new </span><span class="s1">DefaultDevLoadingViewImplementation(reactInstanceDevHelper)</span><span class="s2">;</span>
    <span class="s1">mSurfaceDelegateFactory = surfaceDelegateFactory</span><span class="s2">;</span>
  <span class="s1">}</span><span class="s2">;</span>

  <span class="s2">protected abstract </span><span class="s1">String getUniqueTag()</span><span class="s2">;</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">handleException(Exception e) {</span>
    <span class="s2">if </span><span class="s1">(mIsDevSupportEnabled) {</span>
      <span class="s1">logJSException(e)</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s1">mDefaultJSExceptionHandler.handleException(e)</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">logJSException(Exception e) {</span>
    <span class="s1">StringBuilder message =</span>
        <span class="s2">new </span><span class="s1">StringBuilder(</span>
            <span class="s1">e.getMessage() == </span><span class="s2">null </span><span class="s1">? </span><span class="s4">&quot;Exception in native call from JS&quot; </span><span class="s1">: e.getMessage())</span><span class="s2">;</span>
    <span class="s1">Throwable cause = e.getCause()</span><span class="s2">;</span>
    <span class="s2">while </span><span class="s1">(cause != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">message.append(</span><span class="s4">&quot;</span><span class="s2">\n\n</span><span class="s4">&quot;</span><span class="s1">).append(cause.getMessage())</span><span class="s2">;</span>
      <span class="s1">cause = cause.getCause()</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(e </span><span class="s2">instanceof </span><span class="s1">JSException) {</span>
      <span class="s1">FLog.e(ReactConstants.TAG</span><span class="s2">, </span><span class="s4">&quot;Exception in native call from JS&quot;</span><span class="s2">, </span><span class="s1">e)</span><span class="s2">;</span>
      <span class="s1">String stack = ((JSException) e).getStack()</span><span class="s2">;</span>
      <span class="s1">message.append(</span><span class="s4">&quot;</span><span class="s2">\n\n</span><span class="s4">&quot;</span><span class="s1">).append(stack)</span><span class="s2">;</span>

      <span class="s0">// TODO #11638796: convert the stack into something useful</span>
      <span class="s1">showNewError(message.toString()</span><span class="s2">, new </span><span class="s1">StackFrame[] {}</span><span class="s2">, </span><span class="s1">JSEXCEPTION_ERROR_COOKIE</span><span class="s2">, </span><span class="s1">ErrorType.JS)</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s1">showNewJavaError(message.toString()</span><span class="s2">, </span><span class="s1">e)</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">showNewJavaError(@Nullable String message</span><span class="s2">, </span><span class="s1">Throwable e) {</span>
    <span class="s1">FLog.e(ReactConstants.TAG</span><span class="s2">, </span><span class="s4">&quot;Exception in native call&quot;</span><span class="s2">, </span><span class="s1">e)</span><span class="s2">;</span>
    <span class="s1">showNewError(</span>
        <span class="s1">message</span><span class="s2">, </span><span class="s1">StackTraceHelper.convertJavaStackTrace(e)</span><span class="s2">, </span><span class="s1">JAVA_ERROR_COOKIE</span><span class="s2">, </span><span class="s1">ErrorType.NATIVE)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s5">/**</span>
   <span class="s5">* Add option item to dev settings dialog displayed by this manager. In the case user select given</span>
   <span class="s5">* option from that dialog, the appropriate handler passed as {</span><span class="s6">@param </span><span class="s5">optionHandler} will be</span>
   <span class="s5">* called.</span>
   <span class="s5">*/</span>
  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">addCustomDevOption(String optionName</span><span class="s2">, </span><span class="s1">DevOptionHandler optionHandler) {</span>
    <span class="s1">mCustomDevOptions.put(optionName</span><span class="s2">, </span><span class="s1">optionHandler)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">showNewJSError(String message</span><span class="s2">, </span><span class="s1">ReadableArray details</span><span class="s2">, int </span><span class="s1">errorCookie) {</span>
    <span class="s1">showNewError(message</span><span class="s2">, </span><span class="s1">StackTraceHelper.convertJsStackTrace(details)</span><span class="s2">, </span><span class="s1">errorCookie</span><span class="s2">, </span><span class="s1">ErrorType.JS)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">registerErrorCustomizer(ErrorCustomizer errorCustomizer) {</span>
    <span class="s2">if </span><span class="s1">(mErrorCustomizers == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">mErrorCustomizers = </span><span class="s2">new </span><span class="s1">ArrayList&lt;&gt;()</span><span class="s2">;</span>
    <span class="s1">}</span>
    <span class="s1">mErrorCustomizers.add(errorCustomizer)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">Pair&lt;String</span><span class="s2">, </span><span class="s1">StackFrame[]&gt; processErrorCustomizers(Pair&lt;String</span><span class="s2">, </span><span class="s1">StackFrame[]&gt; errorInfo) {</span>
    <span class="s2">if </span><span class="s1">(mErrorCustomizers == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s1">errorInfo</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">for </span><span class="s1">(ErrorCustomizer errorCustomizer : mErrorCustomizers) {</span>
        <span class="s1">Pair&lt;String</span><span class="s2">, </span><span class="s1">StackFrame[]&gt; result = errorCustomizer.customizeErrorInfo(errorInfo)</span><span class="s2">;</span>
        <span class="s2">if </span><span class="s1">(result != </span><span class="s2">null</span><span class="s1">) {</span>
          <span class="s1">errorInfo = result</span><span class="s2">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
      <span class="s2">return </span><span class="s1">errorInfo</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">updateJSError(</span>
      <span class="s2">final </span><span class="s1">String message</span><span class="s2">, final </span><span class="s1">ReadableArray details</span><span class="s2">, final int </span><span class="s1">errorCookie) {</span>
    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s0">// Since we only show the first JS error in a succession of JS errors, make sure we only</span>
            <span class="s0">// update the error message for that error message. This assumes that updateJSError</span>
            <span class="s0">// belongs to the most recent showNewJSError</span>
            <span class="s2">if </span><span class="s1">(!mRedBoxSurfaceDelegate.isShowing() || errorCookie != mLastErrorCookie) {</span>
              <span class="s2">return;</span>
            <span class="s1">}</span>

            <span class="s0">// The RedBox surface delegate will always show the latest error</span>
            <span class="s1">updateLastErrorInfo(</span>
                <span class="s1">message</span><span class="s2">, </span><span class="s1">StackTraceHelper.convertJsStackTrace(details)</span><span class="s2">, </span><span class="s1">errorCookie</span><span class="s2">, </span><span class="s1">ErrorType.JS)</span><span class="s2">;</span>
            <span class="s1">mRedBoxSurfaceDelegate.show()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">hideRedboxDialog() {</span>
    <span class="s2">if </span><span class="s1">(mRedBoxSurfaceDelegate == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">mRedBoxSurfaceDelegate.hide()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">@Nullable View createRootView(String appKey) {</span>
    <span class="s2">return </span><span class="s1">mReactInstanceDevHelper.createRootView(appKey)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">destroyRootView(View rootView) {</span>
    <span class="s1">mReactInstanceDevHelper.destroyRootView(rootView)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">hideDevOptionsDialog() {</span>
    <span class="s2">if </span><span class="s1">(mDevOptionsDialog != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">mDevOptionsDialog.dismiss()</span><span class="s2">;</span>
      <span class="s1">mDevOptionsDialog = </span><span class="s2">null;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">showNewError(</span>
      <span class="s1">@Nullable </span><span class="s2">final </span><span class="s1">String message</span><span class="s2">,</span>
      <span class="s2">final </span><span class="s1">StackFrame[] stack</span><span class="s2">,</span>
      <span class="s2">final int </span><span class="s1">errorCookie</span><span class="s2">,</span>
      <span class="s2">final </span><span class="s1">ErrorType errorType) {</span>
    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s0">// Keep a copy of the latest error to be shown by the RedBoxSurface</span>
            <span class="s1">updateLastErrorInfo(message</span><span class="s2">, </span><span class="s1">stack</span><span class="s2">, </span><span class="s1">errorCookie</span><span class="s2">, </span><span class="s1">errorType)</span><span class="s2">;</span>

            <span class="s2">if </span><span class="s1">(mRedBoxSurfaceDelegate == </span><span class="s2">null</span><span class="s1">) {</span>
              <span class="s1">@Nullable SurfaceDelegate redBoxSurfaceDelegate = createSurfaceDelegate(</span><span class="s4">&quot;RedBox&quot;</span><span class="s1">)</span><span class="s2">;</span>
              <span class="s2">if </span><span class="s1">(redBoxSurfaceDelegate != </span><span class="s2">null</span><span class="s1">) {</span>
                <span class="s1">mRedBoxSurfaceDelegate = redBoxSurfaceDelegate</span><span class="s2">;</span>
              <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s1">mRedBoxSurfaceDelegate =</span>
                    <span class="s2">new </span><span class="s1">RedBoxDialogSurfaceDelegate(DevSupportManagerBase.</span><span class="s2">this</span><span class="s1">)</span><span class="s2">;</span>
              <span class="s1">}</span>

              <span class="s1">mRedBoxSurfaceDelegate.createContentView(</span><span class="s4">&quot;RedBox&quot;</span><span class="s1">)</span><span class="s2">;</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(mRedBoxSurfaceDelegate.isShowing()) {</span>
              <span class="s0">// Sometimes errors cause multiple errors to be thrown in JS in quick succession. Only</span>
              <span class="s0">// show the first and most actionable one.</span>
              <span class="s2">return;</span>
            <span class="s1">}</span>

            <span class="s1">mRedBoxSurfaceDelegate.show()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">showDevOptionsDialog() {</span>
    <span class="s2">if </span><span class="s1">(mDevOptionsDialog != </span><span class="s2">null </span><span class="s1">|| !mIsDevSupportEnabled || ActivityManager.isUserAMonkey()) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>
    <span class="s1">LinkedHashMap&lt;String</span><span class="s2">, </span><span class="s1">DevOptionHandler&gt; options = </span><span class="s2">new </span><span class="s1">LinkedHashMap&lt;&gt;()</span><span class="s2">;</span>
    <span class="s0">/* register standard options */</span>
    <span class="s1">options.put(</span>
        <span class="s1">mApplicationContext.getString(R.string.catalyst_reload)</span><span class="s2">,</span>
        <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
            <span class="s2">if </span><span class="s1">(!mDevSettings.isJSDevModeEnabled()</span>
                <span class="s1">&amp;&amp; mDevSettings.isHotModuleReplacementEnabled()) {</span>
              <span class="s1">Toast.makeText(</span>
                      <span class="s1">mApplicationContext</span><span class="s2">,</span>
                      <span class="s1">mApplicationContext.getString(R.string.catalyst_hot_reloading_auto_disable)</span><span class="s2">,</span>
                      <span class="s1">Toast.LENGTH_LONG)</span>
                  <span class="s1">.show()</span><span class="s2">;</span>
              <span class="s1">mDevSettings.setHotModuleReplacementEnabled(</span><span class="s2">false</span><span class="s1">)</span><span class="s2">;</span>
            <span class="s1">}</span>
            <span class="s1">handleReloadJS()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>

    <span class="s2">if </span><span class="s1">(mDevSettings.isDeviceDebugEnabled()) {</span>
      <span class="s0">// For on-device debugging we link out to Flipper.</span>
      <span class="s0">// Since we're assuming Flipper is available, also include the DevTools.</span>

      <span class="s0">// Reset the old debugger setting so no one gets stuck.</span>
      <span class="s0">// TODO: Remove in a few weeks.</span>
      <span class="s2">if </span><span class="s1">(mDevSettings.isRemoteJSDebugEnabled()) {</span>
        <span class="s1">mDevSettings.setRemoteJSDebugEnabled(</span><span class="s2">false</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s1">handleReloadJS()</span><span class="s2">;</span>
      <span class="s1">}</span>
      <span class="s1">options.put(</span>
          <span class="s1">mApplicationContext.getString(R.string.catalyst_debug_open)</span><span class="s2">,</span>
          <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
              <span class="s1">mDevServerHelper.openUrl(</span>
                  <span class="s1">mCurrentContext</span><span class="s2">,</span>
                  <span class="s1">FLIPPER_DEBUGGER_URL</span><span class="s2">,</span>
                  <span class="s1">mApplicationContext.getString(R.string.catalyst_open_flipper_error))</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">})</span><span class="s2">;</span>
      <span class="s1">options.put(</span>
          <span class="s1">mApplicationContext.getString(R.string.catalyst_devtools_open)</span><span class="s2">,</span>
          <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
              <span class="s1">mDevServerHelper.openUrl(</span>
                  <span class="s1">mCurrentContext</span><span class="s2">,</span>
                  <span class="s1">FLIPPER_DEVTOOLS_URL</span><span class="s2">,</span>
                  <span class="s1">mApplicationContext.getString(R.string.catalyst_open_flipper_error))</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s1">options.put(</span>
        <span class="s1">mApplicationContext.getString(R.string.catalyst_change_bundle_location)</span><span class="s2">,</span>
        <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
            <span class="s1">Activity context = mReactInstanceDevHelper.getCurrentActivity()</span><span class="s2">;</span>
            <span class="s2">if </span><span class="s1">(context == </span><span class="s2">null </span><span class="s1">|| context.isFinishing()) {</span>
              <span class="s1">FLog.e(</span>
                  <span class="s1">ReactConstants.TAG</span><span class="s2">,</span>
                  <span class="s4">&quot;Unable to launch change bundle location because react activity is not available&quot;</span><span class="s1">)</span><span class="s2">;</span>
              <span class="s2">return;</span>
            <span class="s1">}</span>

            <span class="s2">final </span><span class="s1">EditText input = </span><span class="s2">new </span><span class="s1">EditText(context)</span><span class="s2">;</span>
            <span class="s1">input.setHint(</span><span class="s4">&quot;localhost:8081&quot;</span><span class="s1">)</span><span class="s2">;</span>

            <span class="s1">AlertDialog bundleLocationDialog =</span>
                <span class="s2">new </span><span class="s1">AlertDialog.Builder(context)</span>
                    <span class="s1">.setTitle(</span>
                        <span class="s1">mApplicationContext.getString(R.string.catalyst_change_bundle_location))</span>
                    <span class="s1">.setView(input)</span>
                    <span class="s1">.setPositiveButton(</span>
                        <span class="s1">android.R.string.ok</span><span class="s2">,</span>
                        <span class="s2">new </span><span class="s1">DialogInterface.OnClickListener() {</span>
                          <span class="s1">@Override</span>
                          <span class="s2">public void </span><span class="s1">onClick(DialogInterface dialog</span><span class="s2">, int </span><span class="s1">which) {</span>
                            <span class="s1">String host = input.getText().toString()</span><span class="s2">;</span>
                            <span class="s1">mDevSettings.getPackagerConnectionSettings().setDebugServerHost(host)</span><span class="s2">;</span>
                            <span class="s1">handleReloadJS()</span><span class="s2">;</span>
                          <span class="s1">}</span>
                        <span class="s1">})</span>
                    <span class="s1">.create()</span><span class="s2">;</span>
            <span class="s1">bundleLocationDialog.show()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>

    <span class="s1">options.put(</span>
        <span class="s1">mDevSettings.isElementInspectorEnabled()</span>
            <span class="s1">? mApplicationContext.getString(R.string.catalyst_inspector_stop)</span>
            <span class="s1">: mApplicationContext.getString(R.string.catalyst_inspector)</span><span class="s2">,</span>
        <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
            <span class="s1">mDevSettings.setElementInspectorEnabled(!mDevSettings.isElementInspectorEnabled())</span><span class="s2">;</span>
            <span class="s1">mReactInstanceDevHelper.toggleElementInspector()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>

    <span class="s1">options.put(</span>
        <span class="s1">mDevSettings.isHotModuleReplacementEnabled()</span>
            <span class="s1">? mApplicationContext.getString(R.string.catalyst_hot_reloading_stop)</span>
            <span class="s1">: mApplicationContext.getString(R.string.catalyst_hot_reloading)</span><span class="s2">,</span>
        <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
            <span class="s2">boolean </span><span class="s1">nextEnabled = !mDevSettings.isHotModuleReplacementEnabled()</span><span class="s2">;</span>
            <span class="s1">mDevSettings.setHotModuleReplacementEnabled(nextEnabled)</span><span class="s2">;</span>
            <span class="s2">if </span><span class="s1">(mCurrentContext != </span><span class="s2">null</span><span class="s1">) {</span>
              <span class="s2">if </span><span class="s1">(nextEnabled) {</span>
                <span class="s1">mCurrentContext.getJSModule(HMRClient.</span><span class="s2">class</span><span class="s1">).enable()</span><span class="s2">;</span>
              <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s1">mCurrentContext.getJSModule(HMRClient.</span><span class="s2">class</span><span class="s1">).disable()</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">if </span><span class="s1">(nextEnabled &amp;&amp; !mDevSettings.isJSDevModeEnabled()) {</span>
              <span class="s1">Toast.makeText(</span>
                      <span class="s1">mApplicationContext</span><span class="s2">,</span>
                      <span class="s1">mApplicationContext.getString(R.string.catalyst_hot_reloading_auto_enable)</span><span class="s2">,</span>
                      <span class="s1">Toast.LENGTH_LONG)</span>
                  <span class="s1">.show()</span><span class="s2">;</span>
              <span class="s1">mDevSettings.setJSDevModeEnabled(</span><span class="s2">true</span><span class="s1">)</span><span class="s2">;</span>
              <span class="s1">handleReloadJS()</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>

    <span class="s1">options.put(</span>
        <span class="s1">mDevSettings.isFpsDebugEnabled()</span>
            <span class="s1">? mApplicationContext.getString(R.string.catalyst_perf_monitor_stop)</span>
            <span class="s1">: mApplicationContext.getString(R.string.catalyst_perf_monitor)</span><span class="s2">,</span>
        <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
            <span class="s2">if </span><span class="s1">(!mDevSettings.isFpsDebugEnabled()) {</span>
              <span class="s0">// Request overlay permission if needed when &quot;Show Perf Monitor&quot; option is selected</span>
              <span class="s1">Context context = mReactInstanceDevHelper.getCurrentActivity()</span><span class="s2">;</span>
              <span class="s2">if </span><span class="s1">(context == </span><span class="s2">null</span><span class="s1">) {</span>
                <span class="s1">FLog.e(ReactConstants.TAG</span><span class="s2">, </span><span class="s4">&quot;Unable to get reference to react activity&quot;</span><span class="s1">)</span><span class="s2">;</span>
              <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s1">DebugOverlayController.requestPermission(context)</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s1">mDevSettings.setFpsDebugEnabled(!mDevSettings.isFpsDebugEnabled())</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">options.put(</span>
        <span class="s1">mApplicationContext.getString(R.string.catalyst_settings)</span><span class="s2">,</span>
        <span class="s2">new </span><span class="s1">DevOptionHandler() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onOptionSelected() {</span>
            <span class="s1">Intent intent = </span><span class="s2">new </span><span class="s1">Intent(mApplicationContext</span><span class="s2">, </span><span class="s1">DevSettingsActivity.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>
            <span class="s1">intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK)</span><span class="s2">;</span>
            <span class="s1">mApplicationContext.startActivity(intent)</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>

    <span class="s2">if </span><span class="s1">(mCustomDevOptions.size() &gt; </span><span class="s3">0</span><span class="s1">) {</span>
      <span class="s1">options.putAll(mCustomDevOptions)</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">final </span><span class="s1">DevOptionHandler[] optionHandlers = options.values().toArray(</span><span class="s2">new </span><span class="s1">DevOptionHandler[</span><span class="s3">0</span><span class="s1">])</span><span class="s2">;</span>

    <span class="s1">Activity context = mReactInstanceDevHelper.getCurrentActivity()</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(context == </span><span class="s2">null </span><span class="s1">|| context.isFinishing()) {</span>
      <span class="s1">FLog.e(</span>
          <span class="s1">ReactConstants.TAG</span><span class="s2">,</span>
          <span class="s4">&quot;Unable to launch dev options menu because react activity &quot; </span><span class="s1">+ </span><span class="s4">&quot;isn't available&quot;</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s2">final </span><span class="s1">LinearLayout header = </span><span class="s2">new </span><span class="s1">LinearLayout(getApplicationContext())</span><span class="s2">;</span>
    <span class="s1">header.setOrientation(LinearLayout.VERTICAL)</span><span class="s2">;</span>

    <span class="s2">final </span><span class="s1">TextView title = </span><span class="s2">new </span><span class="s1">TextView(getApplicationContext())</span><span class="s2">;</span>
    <span class="s1">title.setText(</span><span class="s4">&quot;React Native Dev Menu (&quot; </span><span class="s1">+ getUniqueTag() + </span><span class="s4">&quot;)&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">title.setPadding(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">50</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">title.setGravity(Gravity.CENTER)</span><span class="s2">;</span>
    <span class="s1">title.setTextColor(Color.DKGRAY)</span><span class="s2">;</span>
    <span class="s1">title.setTextSize(</span><span class="s3">16</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">title.setTypeface(title.getTypeface()</span><span class="s2">, </span><span class="s1">Typeface.BOLD)</span><span class="s2">;</span>

    <span class="s2">final </span><span class="s1">TextView jsExecutorLabel = </span><span class="s2">new </span><span class="s1">TextView(getApplicationContext())</span><span class="s2">;</span>
    <span class="s1">jsExecutorLabel.setText(getJSExecutorDescription())</span><span class="s2">;</span>
    <span class="s1">jsExecutorLabel.setPadding(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">jsExecutorLabel.setGravity(Gravity.CENTER)</span><span class="s2">;</span>
    <span class="s1">jsExecutorLabel.setTextColor(Color.GRAY)</span><span class="s2">;</span>
    <span class="s1">jsExecutorLabel.setTextSize(</span><span class="s3">14</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s1">header.addView(title)</span><span class="s2">;</span>
    <span class="s1">header.addView(jsExecutorLabel)</span><span class="s2">;</span>

    <span class="s1">mDevOptionsDialog =</span>
        <span class="s2">new </span><span class="s1">AlertDialog.Builder(context)</span>
            <span class="s1">.setCustomTitle(header)</span>
            <span class="s1">.setItems(</span>
                <span class="s1">options.keySet().toArray(</span><span class="s2">new </span><span class="s1">String[</span><span class="s3">0</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s2">new </span><span class="s1">DialogInterface.OnClickListener() {</span>
                  <span class="s1">@Override</span>
                  <span class="s2">public void </span><span class="s1">onClick(DialogInterface dialog</span><span class="s2">, int </span><span class="s1">which) {</span>
                    <span class="s1">optionHandlers[which].onOptionSelected()</span><span class="s2">;</span>
                    <span class="s1">mDevOptionsDialog = </span><span class="s2">null;</span>
                  <span class="s1">}</span>
                <span class="s1">})</span>
            <span class="s1">.setOnCancelListener(</span>
                <span class="s2">new </span><span class="s1">DialogInterface.OnCancelListener() {</span>
                  <span class="s1">@Override</span>
                  <span class="s2">public void </span><span class="s1">onCancel(DialogInterface dialog) {</span>
                    <span class="s1">mDevOptionsDialog = </span><span class="s2">null;</span>
                  <span class="s1">}</span>
                <span class="s1">})</span>
            <span class="s1">.create()</span><span class="s2">;</span>
    <span class="s1">mDevOptionsDialog.show()</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(mCurrentContext != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">mCurrentContext.getJSModule(RCTNativeAppEventEmitter.</span><span class="s2">class</span><span class="s1">).emit(</span><span class="s4">&quot;RCTDevMenuShown&quot;</span><span class="s2">, null</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String getJSExecutorDescription() {</span>
    <span class="s2">return </span><span class="s4">&quot;Running &quot; </span><span class="s1">+ getReactInstanceDevHelper().getJavaScriptExecutorFactory().toString()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s5">/**</span>
   <span class="s5">* {</span><span class="s6">@link </span><span class="s5">ReactInstanceDevCommandsHandler} is responsible for enabling/disabling dev support when</span>
   <span class="s5">* a React view is attached/detached or when application state changes (e.g. the application is</span>
   <span class="s5">* backgrounded).</span>
   <span class="s5">*/</span>
  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">setDevSupportEnabled(</span><span class="s2">boolean </span><span class="s1">isDevSupportEnabled) {</span>
    <span class="s1">mIsDevSupportEnabled = isDevSupportEnabled</span><span class="s2">;</span>
    <span class="s1">reloadSettings()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public boolean </span><span class="s1">getDevSupportEnabled() {</span>
    <span class="s2">return </span><span class="s1">mIsDevSupportEnabled</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">DevInternalSettings getDevSettings() {</span>
    <span class="s2">return </span><span class="s1">mDevSettings</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">RedBoxHandler getRedBoxHandler() {</span>
    <span class="s2">return </span><span class="s1">mRedBoxHandler</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">onNewReactContextCreated(ReactContext reactContext) {</span>
    <span class="s1">resetCurrentContext(reactContext)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">onReactInstanceDestroyed(ReactContext reactContext) {</span>
    <span class="s2">if </span><span class="s1">(reactContext == mCurrentContext) {</span>
      <span class="s0">// only call reset context when the destroyed context matches the one that is currently set</span>
      <span class="s0">// for this manager</span>
      <span class="s1">resetCurrentContext(</span><span class="s2">null</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">String getSourceMapUrl() {</span>
    <span class="s2">if </span><span class="s1">(mJSAppBundleName == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s4">&quot;&quot;</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s1">mDevServerHelper.getSourceMapUrl(Assertions.assertNotNull(mJSAppBundleName))</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">String getSourceUrl() {</span>
    <span class="s2">if </span><span class="s1">(mJSAppBundleName == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s4">&quot;&quot;</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s1">mDevServerHelper.getSourceUrl(Assertions.assertNotNull(mJSAppBundleName))</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">String getJSBundleURLForRemoteDebugging() {</span>
    <span class="s2">return </span><span class="s1">mDevServerHelper.getJSBundleURLForRemoteDebugging(</span>
        <span class="s1">Assertions.assertNotNull(mJSAppBundleName))</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">String getDownloadedJSBundleFile() {</span>
    <span class="s2">return </span><span class="s1">mJSBundleDownloadedFile.getAbsolutePath()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s5">/**</span>
   <span class="s5">* </span><span class="s6">@return </span><span class="s5">{</span><span class="s6">@code </span><span class="s5">true} if {</span><span class="s6">@link </span><span class="s5">com.facebook.react.ReactInstanceManager} should use downloaded</span>
   <span class="s5">*     JS bundle file instead of using JS file from assets. This may happen when app has not been</span>
   <span class="s5">*     updated since the last time we fetched the bundle.</span>
   <span class="s5">*/</span>
  <span class="s1">@Override</span>
  <span class="s2">public boolean </span><span class="s1">hasUpToDateJSBundleInCache() {</span>
    <span class="s2">if </span><span class="s1">(mIsDevSupportEnabled &amp;&amp; mJSBundleDownloadedFile.exists()) {</span>
      <span class="s2">try </span><span class="s1">{</span>
        <span class="s1">String packageName = mApplicationContext.getPackageName()</span><span class="s2">;</span>
        <span class="s1">PackageInfo thisPackage =</span>
            <span class="s1">mApplicationContext.getPackageManager().getPackageInfo(packageName</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span><span class="s2">;</span>
        <span class="s2">if </span><span class="s1">(mJSBundleDownloadedFile.lastModified() &gt; thisPackage.lastUpdateTime) {</span>
          <span class="s0">// Base APK has not been updated since we downloaded JS, but if app is using exopackage</span>
          <span class="s0">// it may only be a single dex that has been updated. We check for exopackage dir update</span>
          <span class="s0">// time in that case.</span>
          <span class="s1">File exopackageDir =</span>
              <span class="s2">new </span><span class="s1">File(String.format(Locale.US</span><span class="s2">, </span><span class="s1">EXOPACKAGE_LOCATION_FORMAT</span><span class="s2">, </span><span class="s1">packageName))</span><span class="s2">;</span>
          <span class="s2">if </span><span class="s1">(exopackageDir.exists()) {</span>
            <span class="s2">return </span><span class="s1">mJSBundleDownloadedFile.lastModified() &gt; exopackageDir.lastModified()</span><span class="s2">;</span>
          <span class="s1">}</span>
          <span class="s2">return true;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s2">catch </span><span class="s1">(PackageManager.NameNotFoundException e) {</span>
        <span class="s0">// Ignore this error and just fallback to loading JS from assets</span>
        <span class="s1">FLog.e(ReactConstants.TAG</span><span class="s2">, </span><span class="s4">&quot;DevSupport is unable to get current app info&quot;</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s2">return false;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">resetCurrentContext(@Nullable ReactContext reactContext) {</span>
    <span class="s2">if </span><span class="s1">(mCurrentContext == reactContext) {</span>
      <span class="s0">// new context is the same as the old one - do nothing</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">mCurrentContext = reactContext</span><span class="s2">;</span>

    <span class="s0">// Recreate debug overlay controller with new CatalystInstance object</span>
    <span class="s2">if </span><span class="s1">(mDebugOverlayController != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">mDebugOverlayController.setFpsDebugViewVisible(</span><span class="s2">false</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">}</span>
    <span class="s2">if </span><span class="s1">(reactContext != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">mDebugOverlayController = </span><span class="s2">new </span><span class="s1">DebugOverlayController(reactContext)</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">if </span><span class="s1">(mCurrentContext != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">try </span><span class="s1">{</span>
        <span class="s1">URL sourceUrl = </span><span class="s2">new </span><span class="s1">URL(getSourceUrl())</span><span class="s2">;</span>
        <span class="s1">String path = sourceUrl.getPath().substring(</span><span class="s3">1</span><span class="s1">)</span><span class="s2">; </span><span class="s0">// strip initial slash in path</span>
        <span class="s1">String host = sourceUrl.getHost()</span><span class="s2">;</span>
        <span class="s2">int </span><span class="s1">port = sourceUrl.getPort() != -</span><span class="s3">1 </span><span class="s1">? sourceUrl.getPort() : sourceUrl.getDefaultPort()</span><span class="s2">;</span>
        <span class="s1">mCurrentContext</span>
            <span class="s1">.getJSModule(HMRClient.</span><span class="s2">class</span><span class="s1">)</span>
            <span class="s1">.setup(</span><span class="s4">&quot;android&quot;</span><span class="s2">, </span><span class="s1">path</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">port</span><span class="s2">, </span><span class="s1">mDevSettings.isHotModuleReplacementEnabled())</span><span class="s2">;</span>
      <span class="s1">} </span><span class="s2">catch </span><span class="s1">(MalformedURLException e) {</span>
        <span class="s1">showNewJavaError(e.getMessage()</span><span class="s2">, </span><span class="s1">e)</span><span class="s2">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">reloadSettings()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">reloadSettings() {</span>
    <span class="s2">if </span><span class="s1">(UiThreadUtil.isOnUiThread()) {</span>
      <span class="s1">reload()</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s1">UiThreadUtil.runOnUiThread(</span>
          <span class="s2">new </span><span class="s1">Runnable() {</span>
            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">run() {</span>
              <span class="s1">reload()</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">protected </span><span class="s1">@Nullable ReactContext getCurrentContext() {</span>
    <span class="s2">return </span><span class="s1">mCurrentContext</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">protected </span><span class="s1">@Nullable String getJSAppBundleName() {</span>
    <span class="s2">return </span><span class="s1">mJSAppBundleName</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">protected </span><span class="s1">Context getApplicationContext() {</span>
    <span class="s2">return </span><span class="s1">mApplicationContext</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">protected </span><span class="s1">DevServerHelper getDevServerHelper() {</span>
    <span class="s2">return </span><span class="s1">mDevServerHelper</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">protected </span><span class="s1">ReactInstanceDevHelper getReactInstanceDevHelper() {</span>
    <span class="s2">return </span><span class="s1">mReactInstanceDevHelper</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@UiThread</span>
  <span class="s2">private void </span><span class="s1">showDevLoadingViewForUrl(String bundleUrl) {</span>
    <span class="s2">if </span><span class="s1">(mApplicationContext == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">URL parsedURL</span><span class="s2">;</span>

    <span class="s2">try </span><span class="s1">{</span>
      <span class="s1">parsedURL = </span><span class="s2">new </span><span class="s1">URL(bundleUrl)</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">catch </span><span class="s1">(MalformedURLException e) {</span>
      <span class="s1">FLog.e(ReactConstants.TAG</span><span class="s2">, </span><span class="s4">&quot;Bundle url format is invalid. </span><span class="s2">\n\n</span><span class="s4">&quot; </span><span class="s1">+ e.toString())</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s2">int </span><span class="s1">port = parsedURL.getPort() != -</span><span class="s3">1 </span><span class="s1">? parsedURL.getPort() : parsedURL.getDefaultPort()</span><span class="s2">;</span>
    <span class="s1">mDevLoadingViewManager.showMessage(</span>
        <span class="s1">mApplicationContext.getString(</span>
            <span class="s1">R.string.catalyst_loading_from_url</span><span class="s2">, </span><span class="s1">parsedURL.getHost() + </span><span class="s4">&quot;:&quot; </span><span class="s1">+ port))</span><span class="s2">;</span>
    <span class="s1">mDevLoadingViewVisible = </span><span class="s2">true;</span>
  <span class="s1">}</span>

  <span class="s1">@UiThread</span>
  <span class="s2">protected void </span><span class="s1">showDevLoadingViewForRemoteJSEnabled() {</span>
    <span class="s2">if </span><span class="s1">(mApplicationContext == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">mDevLoadingViewManager.showMessage(</span>
        <span class="s1">mApplicationContext.getString(R.string.catalyst_debug_connecting))</span><span class="s2">;</span>
    <span class="s1">mDevLoadingViewVisible = </span><span class="s2">true;</span>
  <span class="s1">}</span>

  <span class="s1">@UiThread</span>
  <span class="s2">protected void </span><span class="s1">hideDevLoadingView() {</span>
    <span class="s1">mDevLoadingViewManager.hide()</span><span class="s2">;</span>
    <span class="s1">mDevLoadingViewVisible = </span><span class="s2">false;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">fetchSplitBundleAndCreateBundleLoader(</span>
      <span class="s1">String bundlePath</span><span class="s2">, final </span><span class="s1">CallbackWithBundleLoader callback) {</span>
    <span class="s2">final </span><span class="s1">String bundleUrl = mDevServerHelper.getDevServerSplitBundleURL(bundlePath)</span><span class="s2">;</span>
    <span class="s0">// The bundle path may contain the '/' character, which is not allowed in file names.</span>
    <span class="s2">final </span><span class="s1">File bundleFile =</span>
        <span class="s2">new </span><span class="s1">File(mJSSplitBundlesDir</span><span class="s2">, </span><span class="s1">bundlePath.replaceAll(</span><span class="s4">&quot;/&quot;</span><span class="s2">, </span><span class="s4">&quot;_&quot;</span><span class="s1">) + </span><span class="s4">&quot;.jsbundle&quot;</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s1">showSplitBundleDevLoadingView(bundleUrl)</span><span class="s2">;</span>
            <span class="s1">mDevServerHelper.downloadBundleFromURL(</span>
                <span class="s2">new </span><span class="s1">DevBundleDownloadListener() {</span>
                  <span class="s1">@Override</span>
                  <span class="s2">public void </span><span class="s1">onSuccess() {</span>
                    <span class="s1">UiThreadUtil.runOnUiThread(</span>
                        <span class="s2">new </span><span class="s1">Runnable() {</span>
                          <span class="s1">@Override</span>
                          <span class="s2">public void </span><span class="s1">run() {</span>
                            <span class="s1">hideSplitBundleDevLoadingView()</span><span class="s2">;</span>
                          <span class="s1">}</span>
                        <span class="s1">})</span><span class="s2">;</span>

                    <span class="s1">@Nullable ReactContext context = mCurrentContext</span><span class="s2">;</span>
                    <span class="s2">if </span><span class="s1">(context == </span><span class="s2">null </span><span class="s1">|| !context.hasActiveReactInstance()) {</span>
                      <span class="s2">return;</span>
                    <span class="s1">}</span>

                    <span class="s1">JSBundleLoader bundleLoader =</span>
                        <span class="s1">JSBundleLoader.createCachedSplitBundleFromNetworkLoader(</span>
                            <span class="s1">bundleUrl</span><span class="s2">, </span><span class="s1">bundleFile.getAbsolutePath())</span><span class="s2">;</span>

                    <span class="s1">callback.onSuccess(bundleLoader)</span><span class="s2">;</span>
                  <span class="s1">}</span>

                  <span class="s1">@Override</span>
                  <span class="s2">public void </span><span class="s1">onProgress(</span>
                      <span class="s1">@Nullable String status</span><span class="s2">, </span><span class="s1">@Nullable Integer done</span><span class="s2">, </span><span class="s1">@Nullable Integer total) {</span>
                    <span class="s1">mDevLoadingViewManager.updateProgress(status</span><span class="s2">, </span><span class="s1">done</span><span class="s2">, </span><span class="s1">total)</span><span class="s2">;</span>
                  <span class="s1">}</span>

                  <span class="s1">@Override</span>
                  <span class="s2">public void </span><span class="s1">onFailure(Exception cause) {</span>
                    <span class="s1">UiThreadUtil.runOnUiThread(</span>
                        <span class="s2">new </span><span class="s1">Runnable() {</span>
                          <span class="s1">@Override</span>
                          <span class="s2">public void </span><span class="s1">run() {</span>
                            <span class="s1">hideSplitBundleDevLoadingView()</span><span class="s2">;</span>
                          <span class="s1">}</span>
                        <span class="s1">})</span><span class="s2">;</span>
                    <span class="s1">callback.onError(bundleUrl</span><span class="s2">, </span><span class="s1">cause)</span><span class="s2">;</span>
                  <span class="s1">}</span>
                <span class="s1">}</span><span class="s2">,</span>
                <span class="s1">bundleFile</span><span class="s2">,</span>
                <span class="s1">bundleUrl</span><span class="s2">,</span>
                <span class="s2">null</span><span class="s1">)</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@UiThread</span>
  <span class="s2">private void </span><span class="s1">showSplitBundleDevLoadingView(String bundleUrl) {</span>
    <span class="s1">showDevLoadingViewForUrl(bundleUrl)</span><span class="s2">;</span>
    <span class="s1">mPendingJSSplitBundleRequests++</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@UiThread</span>
  <span class="s2">private void </span><span class="s1">hideSplitBundleDevLoadingView() {</span>
    <span class="s2">if </span><span class="s1">(--mPendingJSSplitBundleRequests == </span><span class="s3">0</span><span class="s1">) {</span>
      <span class="s1">hideDevLoadingView()</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">isPackagerRunning(</span><span class="s2">final </span><span class="s1">PackagerStatusCallback callback) {</span>
    <span class="s1">Runnable checkPackagerRunning =</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s1">mDevServerHelper.isPackagerRunning(callback)</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(mPackagerLocationCustomizer != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">mPackagerLocationCustomizer.run(checkPackagerRunning)</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s1">checkPackagerRunning.run()</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">@Nullable File downloadBundleResourceFromUrlSync(</span>
      <span class="s2">final </span><span class="s1">String resourceURL</span><span class="s2">, final </span><span class="s1">File outputFile) {</span>
    <span class="s2">return </span><span class="s1">mDevServerHelper.downloadBundleResourceFromUrlSync(resourceURL</span><span class="s2">, </span><span class="s1">outputFile)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">@Nullable String getLastErrorTitle() {</span>
    <span class="s2">return </span><span class="s1">mLastErrorTitle</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">@Nullable StackFrame[] getLastErrorStack() {</span>
    <span class="s2">return </span><span class="s1">mLastErrorStack</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public int </span><span class="s1">getLastErrorCookie() {</span>
    <span class="s2">return </span><span class="s1">mLastErrorCookie</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">@Nullable ErrorType getLastErrorType() {</span>
    <span class="s2">return </span><span class="s1">mLastErrorType</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">handleCaptureHeap(</span><span class="s2">final </span><span class="s1">Responder responder) {</span>
    <span class="s2">if </span><span class="s1">(mCurrentContext == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>
    <span class="s1">JSCHeapCapture heapCapture = mCurrentContext.getNativeModule(JSCHeapCapture.</span><span class="s2">class</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s2">if </span><span class="s1">(heapCapture != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">heapCapture.captureHeap(</span>
          <span class="s1">mApplicationContext.getCacheDir().getPath()</span><span class="s2">,</span>
          <span class="s2">new </span><span class="s1">JSCHeapCapture.CaptureCallback() {</span>
            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onSuccess(File capture) {</span>
              <span class="s1">responder.respond(capture.toString())</span><span class="s2">;</span>
            <span class="s1">}</span>

            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onFailure(JSCHeapCapture.CaptureException error) {</span>
              <span class="s1">responder.error(error.toString())</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">updateLastErrorInfo(</span>
      <span class="s1">@Nullable </span><span class="s2">final </span><span class="s1">String message</span><span class="s2">,</span>
      <span class="s2">final </span><span class="s1">StackFrame[] stack</span><span class="s2">,</span>
      <span class="s2">final int </span><span class="s1">errorCookie</span><span class="s2">,</span>
      <span class="s2">final </span><span class="s1">ErrorType errorType) {</span>
    <span class="s1">mLastErrorTitle = message</span><span class="s2">;</span>
    <span class="s1">mLastErrorStack = stack</span><span class="s2">;</span>
    <span class="s1">mLastErrorCookie = errorCookie</span><span class="s2">;</span>
    <span class="s1">mLastErrorType = errorType</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">reloadJSFromServer(</span><span class="s2">final </span><span class="s1">String bundleURL) {</span>
    <span class="s1">reloadJSFromServer(</span>
        <span class="s1">bundleURL</span><span class="s2">,</span>
        <span class="s2">new </span><span class="s1">BundleLoadCallback() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onSuccess() {</span>
            <span class="s1">UiThreadUtil.runOnUiThread(</span>
                <span class="s2">new </span><span class="s1">Runnable() {</span>
                  <span class="s1">@Override</span>
                  <span class="s2">public void </span><span class="s1">run() {</span>
                    <span class="s1">mReactInstanceDevHelper.onJSBundleLoadedFromServer()</span><span class="s2">;</span>
                  <span class="s1">}</span>
                <span class="s1">})</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">reloadJSFromServer(</span><span class="s2">final </span><span class="s1">String bundleURL</span><span class="s2">, final </span><span class="s1">BundleLoadCallback callback) {</span>
    <span class="s1">ReactMarker.logMarker(ReactMarkerConstants.DOWNLOAD_START)</span><span class="s2">;</span>

    <span class="s1">showDevLoadingViewForUrl(bundleURL)</span><span class="s2">;</span>

    <span class="s2">final </span><span class="s1">BundleDownloader.BundleInfo bundleInfo = </span><span class="s2">new </span><span class="s1">BundleDownloader.BundleInfo()</span><span class="s2">;</span>

    <span class="s1">mDevServerHelper.downloadBundleFromURL(</span>
        <span class="s2">new </span><span class="s1">DevBundleDownloadListener() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onSuccess() {</span>
            <span class="s1">hideDevLoadingView()</span><span class="s2">;</span>
            <span class="s2">synchronized </span><span class="s1">(DevSupportManagerBase.</span><span class="s2">this</span><span class="s1">) {</span>
              <span class="s1">mBundleStatus.isLastDownloadSuccess = </span><span class="s2">true;</span>
              <span class="s1">mBundleStatus.updateTimestamp = System.currentTimeMillis()</span><span class="s2">;</span>
            <span class="s1">}</span>
            <span class="s2">if </span><span class="s1">(mBundleDownloadListener != </span><span class="s2">null</span><span class="s1">) {</span>
              <span class="s1">mBundleDownloadListener.onSuccess()</span><span class="s2">;</span>
            <span class="s1">}</span>
            <span class="s1">ReactMarker.logMarker(ReactMarkerConstants.DOWNLOAD_END</span><span class="s2">, </span><span class="s1">bundleInfo.toJSONString())</span><span class="s2">;</span>
            <span class="s1">callback.onSuccess()</span><span class="s2">;</span>
          <span class="s1">}</span>

          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onProgress(</span>
              <span class="s1">@Nullable </span><span class="s2">final </span><span class="s1">String status</span><span class="s2">,</span>
              <span class="s1">@Nullable </span><span class="s2">final </span><span class="s1">Integer done</span><span class="s2">,</span>
              <span class="s1">@Nullable </span><span class="s2">final </span><span class="s1">Integer total) {</span>
            <span class="s1">mDevLoadingViewManager.updateProgress(status</span><span class="s2">, </span><span class="s1">done</span><span class="s2">, </span><span class="s1">total)</span><span class="s2">;</span>
            <span class="s2">if </span><span class="s1">(mBundleDownloadListener != </span><span class="s2">null</span><span class="s1">) {</span>
              <span class="s1">mBundleDownloadListener.onProgress(status</span><span class="s2">, </span><span class="s1">done</span><span class="s2">, </span><span class="s1">total)</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>

          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onFailure(</span><span class="s2">final </span><span class="s1">Exception cause) {</span>
            <span class="s1">hideDevLoadingView()</span><span class="s2">;</span>
            <span class="s2">synchronized </span><span class="s1">(DevSupportManagerBase.</span><span class="s2">this</span><span class="s1">) {</span>
              <span class="s1">mBundleStatus.isLastDownloadSuccess = </span><span class="s2">false;</span>
            <span class="s1">}</span>
            <span class="s2">if </span><span class="s1">(mBundleDownloadListener != </span><span class="s2">null</span><span class="s1">) {</span>
              <span class="s1">mBundleDownloadListener.onFailure(cause)</span><span class="s2">;</span>
            <span class="s1">}</span>
            <span class="s1">FLog.e(ReactConstants.TAG</span><span class="s2">, </span><span class="s4">&quot;Unable to download JS bundle&quot;</span><span class="s2">, </span><span class="s1">cause)</span><span class="s2">;</span>
            <span class="s1">reportBundleLoadingFailure(cause)</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s1">mJSBundleDownloadedFile</span><span class="s2">,</span>
        <span class="s1">bundleURL</span><span class="s2">,</span>
        <span class="s1">bundleInfo)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">reportBundleLoadingFailure(</span><span class="s2">final </span><span class="s1">Exception cause) {</span>
    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s2">if </span><span class="s1">(cause </span><span class="s2">instanceof </span><span class="s1">DebugServerException) {</span>
              <span class="s1">DebugServerException debugServerException = (DebugServerException) cause</span><span class="s2">;</span>
              <span class="s1">showNewJavaError(debugServerException.getMessage()</span><span class="s2">, </span><span class="s1">cause)</span><span class="s2">;</span>
            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
              <span class="s1">showNewJavaError(</span>
                  <span class="s1">mApplicationContext.getString(R.string.catalyst_reload_error)</span><span class="s2">, </span><span class="s1">cause)</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">startInspector() {</span>
    <span class="s2">if </span><span class="s1">(mIsDevSupportEnabled) {</span>
      <span class="s1">mDevServerHelper.openInspectorConnection()</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">stopInspector() {</span>
    <span class="s1">mDevServerHelper.closeInspectorConnection()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">setHotModuleReplacementEnabled(</span><span class="s2">final boolean </span><span class="s1">isHotModuleReplacementEnabled) {</span>
    <span class="s2">if </span><span class="s1">(!mIsDevSupportEnabled) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s1">mDevSettings.setHotModuleReplacementEnabled(isHotModuleReplacementEnabled)</span><span class="s2">;</span>
            <span class="s1">handleReloadJS()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">setRemoteJSDebugEnabled(</span><span class="s2">final boolean </span><span class="s1">isRemoteJSDebugEnabled) {</span>
    <span class="s2">if </span><span class="s1">(!mIsDevSupportEnabled) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s1">mDevSettings.setRemoteJSDebugEnabled(isRemoteJSDebugEnabled)</span><span class="s2">;</span>
            <span class="s1">handleReloadJS()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">setFpsDebugEnabled(</span><span class="s2">final boolean </span><span class="s1">isFpsDebugEnabled) {</span>
    <span class="s2">if </span><span class="s1">(!mIsDevSupportEnabled) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s1">mDevSettings.setFpsDebugEnabled(isFpsDebugEnabled)</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">toggleElementInspector() {</span>
    <span class="s2">if </span><span class="s1">(!mIsDevSupportEnabled) {</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>

    <span class="s1">UiThreadUtil.runOnUiThread(</span>
        <span class="s2">new </span><span class="s1">Runnable() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">run() {</span>
            <span class="s1">mDevSettings.setElementInspectorEnabled(!mDevSettings.isElementInspectorEnabled())</span><span class="s2">;</span>
            <span class="s1">mReactInstanceDevHelper.toggleElementInspector()</span><span class="s2">;</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private void </span><span class="s1">reload() {</span>
    <span class="s1">UiThreadUtil.assertOnUiThread()</span><span class="s2">;</span>

    <span class="s0">// reload settings, show/hide debug overlay if required &amp; start/stop shake detector</span>
    <span class="s2">if </span><span class="s1">(mIsDevSupportEnabled) {</span>
      <span class="s0">// update visibility of FPS debug overlay depending on the settings</span>
      <span class="s2">if </span><span class="s1">(mDebugOverlayController != </span><span class="s2">null</span><span class="s1">) {</span>
        <span class="s1">mDebugOverlayController.setFpsDebugViewVisible(mDevSettings.isFpsDebugEnabled())</span><span class="s2">;</span>
      <span class="s1">}</span>

      <span class="s0">// start shake gesture detector</span>
      <span class="s2">if </span><span class="s1">(!mIsShakeDetectorStarted) {</span>
        <span class="s1">mShakeDetector.start(</span>
            <span class="s1">(SensorManager) mApplicationContext.getSystemService(Context.SENSOR_SERVICE))</span><span class="s2">;</span>
        <span class="s1">mIsShakeDetectorStarted = </span><span class="s2">true;</span>
      <span class="s1">}</span>

      <span class="s0">// register reload app broadcast receiver</span>
      <span class="s2">if </span><span class="s1">(!mIsReceiverRegistered) {</span>
        <span class="s1">IntentFilter filter = </span><span class="s2">new </span><span class="s1">IntentFilter()</span><span class="s2">;</span>
        <span class="s1">filter.addAction(getReloadAppAction(mApplicationContext))</span><span class="s2">;</span>
        <span class="s1">mApplicationContext.registerReceiver(mReloadAppBroadcastReceiver</span><span class="s2">, </span><span class="s1">filter)</span><span class="s2">;</span>
        <span class="s1">mIsReceiverRegistered = </span><span class="s2">true;</span>
      <span class="s1">}</span>

      <span class="s0">// show the dev loading if it should be</span>
      <span class="s2">if </span><span class="s1">(mDevLoadingViewVisible) {</span>
        <span class="s1">mDevLoadingViewManager.showMessage(</span><span class="s4">&quot;Reloading...&quot;</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s1">}</span>

      <span class="s1">mDevServerHelper.openPackagerConnection(</span>
          <span class="s2">this</span><span class="s1">.getClass().getSimpleName()</span><span class="s2">,</span>
          <span class="s2">new </span><span class="s1">PackagerCommandListener() {</span>
            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onPackagerConnected() {</span>
              <span class="s0">// No-op</span>
            <span class="s1">}</span>

            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onPackagerDisconnected() {</span>
              <span class="s0">// No-op</span>
            <span class="s1">}</span>

            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onPackagerReloadCommand() {</span>
              <span class="s0">// Disable debugger to resume the JsVM &amp; avoid thread locks while reloading</span>
              <span class="s1">mDevServerHelper.disableDebugger()</span><span class="s2">;</span>
              <span class="s1">UiThreadUtil.runOnUiThread(</span>
                  <span class="s2">new </span><span class="s1">Runnable() {</span>
                    <span class="s1">@Override</span>
                    <span class="s2">public void </span><span class="s1">run() {</span>
                      <span class="s1">handleReloadJS()</span><span class="s2">;</span>
                    <span class="s1">}</span>
                  <span class="s1">})</span><span class="s2">;</span>
            <span class="s1">}</span>

            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onPackagerDevMenuCommand() {</span>
              <span class="s1">UiThreadUtil.runOnUiThread(</span>
                  <span class="s2">new </span><span class="s1">Runnable() {</span>
                    <span class="s1">@Override</span>
                    <span class="s2">public void </span><span class="s1">run() {</span>
                      <span class="s1">showDevOptionsDialog()</span><span class="s2">;</span>
                    <span class="s1">}</span>
                  <span class="s1">})</span><span class="s2">;</span>
            <span class="s1">}</span>

            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onCaptureHeapCommand(</span><span class="s2">final </span><span class="s1">Responder responder) {</span>
              <span class="s1">UiThreadUtil.runOnUiThread(</span>
                  <span class="s2">new </span><span class="s1">Runnable() {</span>
                    <span class="s1">@Override</span>
                    <span class="s2">public void </span><span class="s1">run() {</span>
                      <span class="s1">handleCaptureHeap(responder)</span><span class="s2">;</span>
                    <span class="s1">}</span>
                  <span class="s1">})</span><span class="s2">;</span>
            <span class="s1">}</span>

            <span class="s1">@Override</span>
            <span class="s2">public </span><span class="s1">@Nullable Map&lt;String</span><span class="s2">, </span><span class="s1">RequestHandler&gt; customCommandHandlers() {</span>
              <span class="s2">return </span><span class="s1">mCustomPackagerCommandHandlers</span><span class="s2">;</span>
            <span class="s1">}</span>
          <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s0">// hide FPS debug overlay</span>
      <span class="s2">if </span><span class="s1">(mDebugOverlayController != </span><span class="s2">null</span><span class="s1">) {</span>
        <span class="s1">mDebugOverlayController.setFpsDebugViewVisible(</span><span class="s2">false</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s1">}</span>

      <span class="s0">// stop shake gesture detector</span>
      <span class="s2">if </span><span class="s1">(mIsShakeDetectorStarted) {</span>
        <span class="s1">mShakeDetector.stop()</span><span class="s2">;</span>
        <span class="s1">mIsShakeDetectorStarted = </span><span class="s2">false;</span>
      <span class="s1">}</span>

      <span class="s0">// unregister app reload broadcast receiver</span>
      <span class="s2">if </span><span class="s1">(mIsReceiverRegistered) {</span>
        <span class="s1">mApplicationContext.unregisterReceiver(mReloadAppBroadcastReceiver)</span><span class="s2">;</span>
        <span class="s1">mIsReceiverRegistered = </span><span class="s2">false;</span>
      <span class="s1">}</span>

      <span class="s0">// hide redbox dialog</span>
      <span class="s1">hideRedboxDialog()</span><span class="s2">;</span>

      <span class="s0">// hide dev options dialog</span>
      <span class="s1">hideDevOptionsDialog()</span><span class="s2">;</span>

      <span class="s0">// hide loading view</span>
      <span class="s1">mDevLoadingViewManager.hide()</span><span class="s2">;</span>
      <span class="s1">mDevServerHelper.closePackagerConnection()</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s5">/** Intent action for reloading the JS */</span>
  <span class="s2">private static </span><span class="s1">String getReloadAppAction(Context context) {</span>
    <span class="s2">return </span><span class="s1">context.getPackageName() + RELOAD_APP_ACTION_SUFFIX</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public void </span><span class="s1">setPackagerLocationCustomizer(</span>
      <span class="s1">DevSupportManager.PackagerLocationCustomizer packagerLocationCustomizer) {</span>
    <span class="s1">mPackagerLocationCustomizer = packagerLocationCustomizer</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">@Nullable Activity getCurrentActivity() {</span>
    <span class="s2">return </span><span class="s1">mReactInstanceDevHelper.getCurrentActivity()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s1">@Override</span>
  <span class="s2">public </span><span class="s1">@Nullable SurfaceDelegate createSurfaceDelegate(String moduleName) {</span>
    <span class="s2">if </span><span class="s1">(mSurfaceDelegateFactory == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s2">return null;</span>
    <span class="s1">}</span>

    <span class="s2">return </span><span class="s1">mSurfaceDelegateFactory.createSurfaceDelegate(moduleName)</span><span class="s2">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>