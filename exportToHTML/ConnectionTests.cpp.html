<html>
<head>
<title>ConnectionTests.cpp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
ConnectionTests.cpp</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#include </span><span class="s3">&quot;AsyncHermesRuntime.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;SyncConnection.h&quot;</span>

<span class="s2">#include </span><span class="s3">&lt;chrono&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;initializer_list&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;iostream&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;limits&gt;</span>

<span class="s2">#include </span><span class="s3">&lt;folly/Conv.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;folly/Unit.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;folly/dynamic.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;folly/futures/Future.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;folly/json.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;gtest/gtest.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;hermes/DebuggerAPI.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;hermes/hermes.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;hermes/inspector/chrome/MessageTypes.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;jsi/instrumentation.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;optional&gt;</span>

<span class="s4">namespace </span><span class="s1">facebook {</span>
<span class="s4">namespace </span><span class="s1">hermes {</span>
<span class="s4">namespace </span><span class="s1">inspector {</span>
<span class="s4">namespace </span><span class="s1">chrome {</span>

<span class="s4">namespace </span><span class="s1">m = ::facebook::hermes::inspector::chrome::message</span><span class="s4">;</span>

<span class="s4">using namespace </span><span class="s1">std::chrono_literals</span><span class="s4">;</span>

<span class="s4">namespace </span><span class="s1">{</span>

<span class="s0">// This class mostly exists to call AsyncHermesRuntime::wait() before we</span>
<span class="s0">// destruct either AsyncHermesRuntime or SyncConnection.</span>
<span class="s0">//</span>
<span class="s0">// The reason for this is that we need to make sure the runtime is finished</span>
<span class="s0">// executing scripts before we destruct the debugger connection. Otherwise, if</span>
<span class="s0">// we destruct the connection while scripts are still executing, the script</span>
<span class="s0">// could perform an action (like hitting a breakpoint) that sends a message to</span>
<span class="s0">// the already-deallocated connection.</span>
<span class="s4">class </span><span class="s1">TestContext {</span>
 <span class="s4">public</span><span class="s1">:</span>
  <span class="s1">TestContext(</span><span class="s4">bool </span><span class="s1">waitForDebugger = </span><span class="s4">false, bool </span><span class="s1">veryLazy = </span><span class="s4">false</span><span class="s1">)</span>
      <span class="s1">: runtime_(veryLazy)</span><span class="s4">, </span><span class="s1">conn_(runtime_.runtime()</span><span class="s4">, </span><span class="s1">waitForDebugger) {}</span>
  <span class="s1">~TestContext() {</span>
    <span class="s1">runtime_.wait()</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">AsyncHermesRuntime &amp;runtime() {</span>
    <span class="s4">return </span><span class="s1">runtime_</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">SyncConnection &amp;conn() {</span>
    <span class="s4">return </span><span class="s1">conn_</span><span class="s4">;</span>
  <span class="s1">}</span>

 <span class="s4">private</span><span class="s1">:</span>
  <span class="s1">AsyncHermesRuntime runtime_</span><span class="s4">;</span>
  <span class="s1">SyncConnection conn_</span><span class="s4">;</span>
<span class="s1">}</span><span class="s4">;</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">typename </span><span class="s1">ResponseType&gt;</span>
<span class="s1">ResponseType expectResponse(SyncConnection &amp;conn</span><span class="s4">, int </span><span class="s1">id) {</span>
  <span class="s1">ResponseType resp</span><span class="s4">;</span>

  <span class="s1">conn.waitForResponse([id</span><span class="s4">, </span><span class="s1">&amp;resp](</span><span class="s4">const </span><span class="s1">std::string &amp;str) {</span>
    <span class="s1">resp = ResponseType(folly::parseJson(str))</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
  <span class="s1">})</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">resp</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">typename </span><span class="s1">NotificationType&gt;</span>
<span class="s1">NotificationType expectNotification(SyncConnection &amp;conn) {</span>
  <span class="s1">NotificationType note</span><span class="s4">;</span>

  <span class="s1">conn.waitForNotification([&amp;note](</span><span class="s4">const </span><span class="s1">std::string &amp;str) {</span>
    <span class="s1">std::string parseError</span><span class="s4">;</span>

    <span class="s4">try </span><span class="s1">{</span>
      <span class="s1">note = NotificationType(folly::parseJson(str))</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">catch </span><span class="s1">(</span><span class="s4">const </span><span class="s1">std::exception &amp;e) {</span>
      <span class="s1">parseError = e.what()</span><span class="s4">;</span>
      <span class="s1">parseError += </span><span class="s3">&quot; (json: &quot; </span><span class="s1">+ str + </span><span class="s3">&quot;)&quot;</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">EXPECT_EQ(parseError</span><span class="s4">, </span><span class="s3">&quot;&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">})</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">note</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">class </span><span class="s1">UnexpectedNotificationException : </span><span class="s4">public </span><span class="s1">std::runtime_error {</span>
 <span class="s4">public</span><span class="s1">:</span>
  <span class="s1">UnexpectedNotificationException()</span>
      <span class="s1">: std::runtime_error(</span><span class="s3">&quot;unexpected notification&quot;</span><span class="s1">) {}</span>
<span class="s1">}</span><span class="s4">;</span>

<span class="s4">void </span><span class="s1">expectNothing(SyncConnection &amp;conn) {</span>
  <span class="s4">auto </span><span class="s1">promise = std::make_shared&lt;folly::Promise&lt;folly::Unit&gt;&gt;()</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">future = promise-&gt;getFuture()</span><span class="s4">;</span>
  <span class="s4">try </span><span class="s1">{</span>
    <span class="s1">conn.waitForNotification([promise](</span><span class="s4">const </span><span class="s1">std::string &amp;str) {</span>
      <span class="s0">// if we receive a value fail the promise</span>
      <span class="s1">promise-&gt;setException(UnexpectedNotificationException())</span><span class="s4">;</span>
    <span class="s1">})</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">catch </span><span class="s1">(...) {</span>
    <span class="s0">// if no values are received it times out with an exception</span>
    <span class="s0">// so we can say that we've succeeded at seeing nothing</span>
    <span class="s1">promise-&gt;setValue()</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s0">// timeout is 2500 milliseconds in SyncConnection::waitForNotification</span>
  <span class="s0">// so this value is mostly a redundant safety measure</span>
  <span class="s1">std::move(future).get(</span><span class="s5">3000</span><span class="s1">ms)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">struct </span><span class="s1">FrameInfo {</span>
  <span class="s1">FrameInfo(</span><span class="s4">const </span><span class="s1">std::string &amp;functionName</span><span class="s4">, int </span><span class="s1">lineNumber</span><span class="s4">, int </span><span class="s1">scopeCount)</span>
      <span class="s1">: functionName(functionName)</span><span class="s4">,</span>
        <span class="s1">lineNumberMin(lineNumber)</span><span class="s4">,</span>
        <span class="s1">lineNumberMax(lineNumber)</span><span class="s4">,</span>
        <span class="s1">scopeCount(scopeCount)</span><span class="s4">,</span>
        <span class="s1">columnNumber(debugger::kInvalidLocation) {}</span>

  <span class="s1">FrameInfo &amp;setLineNumberMax(</span><span class="s4">int </span><span class="s1">lineNumberMaxParam) {</span>
    <span class="s1">lineNumberMax = lineNumberMaxParam</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">*</span><span class="s4">this;</span>
  <span class="s1">}</span>

  <span class="s1">FrameInfo &amp;setScriptId(</span><span class="s4">const </span><span class="s1">std::string &amp;scriptIdParam) {</span>
    <span class="s1">scriptId = scriptIdParam</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">*</span><span class="s4">this;</span>
  <span class="s1">}</span>

  <span class="s1">FrameInfo &amp;setColumnNumber(</span><span class="s4">int </span><span class="s1">columnNumberParam) {</span>
    <span class="s1">columnNumber = columnNumberParam</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">*</span><span class="s4">this;</span>
  <span class="s1">}</span>

  <span class="s1">std::string functionName</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">lineNumberMin</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">lineNumberMax</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">scopeCount</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">columnNumber</span><span class="s4">;</span>
  <span class="s1">std::string scriptId</span><span class="s4">;</span>
<span class="s1">}</span><span class="s4">;</span>

<span class="s4">void </span><span class="s1">expectCallFrames(</span>
    <span class="s4">const </span><span class="s1">std::vector&lt;m::debugger::CallFrame&gt; &amp;frames</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::vector&lt;FrameInfo&gt; &amp;infos) {</span>
  <span class="s1">EXPECT_EQ(frames.size()</span><span class="s4">, </span><span class="s1">infos.size())</span><span class="s4">;</span>

  <span class="s4">int </span><span class="s1">i = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s1">FrameInfo &amp;info : infos) {</span>
    <span class="s1">m::debugger::CallFrame frame = frames[i]</span><span class="s4">;</span>

    <span class="s1">EXPECT_EQ(frame.callFrameId</span><span class="s4">, </span><span class="s1">folly::to&lt;std::string&gt;(i))</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(frame.functionName</span><span class="s4">, </span><span class="s1">info.functionName)</span><span class="s4">;</span>
    <span class="s1">EXPECT_GE(frame.location.lineNumber</span><span class="s4">, </span><span class="s1">info.lineNumberMin)</span><span class="s4">;</span>
    <span class="s1">EXPECT_LE(frame.location.lineNumber</span><span class="s4">, </span><span class="s1">info.lineNumberMax)</span><span class="s4">;</span>

    <span class="s4">if </span><span class="s1">(info.columnNumber != debugger::kInvalidLocation) {</span>
      <span class="s1">EXPECT_EQ(frame.location.columnNumber</span><span class="s4">, </span><span class="s1">info.columnNumber)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s4">if </span><span class="s1">(info.scriptId.size() &gt; </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s1">EXPECT_EQ(frame.location.scriptId</span><span class="s4">, </span><span class="s1">info.scriptId)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s0">// TODO: make expectation more specific once Hermes gives us something other</span>
    <span class="s0">// than kInvalidBreakpoint for the file id</span>
    <span class="s1">EXPECT_FALSE(frame.location.scriptId.empty())</span><span class="s4">;</span>

    <span class="s4">if </span><span class="s1">(info.scopeCount &gt; </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s1">EXPECT_EQ(frame.scopeChain.size()</span><span class="s4">, </span><span class="s1">info.scopeCount)</span><span class="s4">;</span>

      <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">j = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">j &lt; info.scopeCount</span><span class="s4">; </span><span class="s1">j++) {</span>
        <span class="s1">EXPECT_TRUE(frame.scopeChain[j].object.objectId.has_value())</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">i++</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">// Helper to send a request with no params and wait for a response (defaults</span>
<span class="s0">// to empty) containing the req id.</span>
<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">typename </span><span class="s1">RequestType</span><span class="s4">, typename </span><span class="s1">ResponseType = m::OkResponse&gt;</span>
<span class="s1">ResponseType send(SyncConnection &amp;conn</span><span class="s4">, int </span><span class="s1">id) {</span>
  <span class="s1">RequestType req</span><span class="s4">;</span>
  <span class="s1">req.id = id</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">expectResponse&lt;ResponseType&gt;(conn</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">typename </span><span class="s1">RequestType</span><span class="s4">, typename </span><span class="s1">ResponseType = m::OkResponse&gt;</span>
<span class="s1">ResponseType send(SyncConnection &amp;conn</span><span class="s4">, </span><span class="s1">RequestType req) {</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">expectResponse&lt;ResponseType&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">sendRuntimeEvalRequest(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">id</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::string &amp;expression) {</span>
  <span class="s1">m::runtime::EvaluateRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = id</span><span class="s4">;</span>
  <span class="s1">req.expression = expression</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">sendEvalRequest(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">id</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">callFrameId</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::string &amp;expression) {</span>
  <span class="s1">m::debugger::EvaluateOnCallFrameRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = id</span><span class="s4">;</span>
  <span class="s1">req.callFrameId = folly::to&lt;std::string&gt;(callFrameId)</span><span class="s4">;</span>
  <span class="s1">req.expression = expression</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">m::runtime::ExecutionContextCreatedNotification expectExecutionContextCreated(</span>
    <span class="s1">SyncConnection &amp;conn) {</span>
  <span class="s4">auto </span><span class="s1">note =</span>
      <span class="s1">expectNotification&lt;m::runtime::ExecutionContextCreatedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(note.context.id</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(note.context.origin</span><span class="s4">, </span><span class="s3">&quot;&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(note.context.name</span><span class="s4">, </span><span class="s3">&quot;hermes&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">note</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">m::debugger::ScriptParsedNotification expectScriptParsed(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::string &amp;url</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::string &amp;sourceMapURL) {</span>
  <span class="s4">auto </span><span class="s1">note = expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(note.url</span><span class="s4">, </span><span class="s1">url)</span><span class="s4">;</span>
  <span class="s1">EXPECT_GT(note.scriptId.size()</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(sourceMapURL.empty()) {</span>
    <span class="s1">EXPECT_FALSE(note.sourceMapURL.has_value())</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">EXPECT_EQ(note.sourceMapURL.value()</span><span class="s4">, </span><span class="s1">sourceMapURL)</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">return </span><span class="s1">note</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">m::debugger::PausedNotification expectPaused(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::string &amp;reason</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::vector&lt;FrameInfo&gt; &amp;infos) {</span>
  <span class="s4">auto </span><span class="s1">note = expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(note.reason</span><span class="s4">, </span><span class="s1">reason)</span><span class="s4">;</span>
  <span class="s1">expectCallFrames(note.callFrames</span><span class="s4">, </span><span class="s1">infos)</span><span class="s4">;</span>
  <span class="s0">// TODO: check breakpoint location for pause once hermes gives that to us</span>

  <span class="s4">return </span><span class="s1">note</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">m::debugger::BreakpointId expectBreakpointResponse(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">id</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">line</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">resolvedLine) {</span>
  <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::debugger::SetBreakpointByUrlResponse&gt;(conn</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(resp.breakpointId.empty())</span><span class="s4">;</span>
  <span class="s1">EXPECT_NE(</span>
      <span class="s1">resp.breakpointId</span><span class="s4">,</span>
      <span class="s1">folly::to&lt;std::string&gt;(facebook::hermes::debugger::kInvalidBreakpoint))</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(line == -</span><span class="s5">1</span><span class="s1">) {</span>
    <span class="s1">EXPECT_EQ(resp.locations.size()</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">EXPECT_EQ(resp.locations.size()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(resp.locations[</span><span class="s5">0</span><span class="s1">].lineNumber</span><span class="s4">, </span><span class="s1">resolvedLine)</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">return </span><span class="s1">resp.breakpointId</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">expectEvalResponse(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">id</span><span class="s4">,</span>
    <span class="s4">const char </span><span class="s1">*expectedValue) {</span>
  <span class="s4">auto </span><span class="s1">resp =</span>
      <span class="s1">expectResponse&lt;m::debugger::EvaluateOnCallFrameResponse&gt;(conn</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.type</span><span class="s4">, </span><span class="s3">&quot;string&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.value</span><span class="s4">, </span><span class="s1">expectedValue)</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(resp.exceptionDetails.has_value())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">expectEvalResponse(SyncConnection &amp;conn</span><span class="s4">, int </span><span class="s1">id</span><span class="s4">, bool </span><span class="s1">expectedValue) {</span>
  <span class="s4">auto </span><span class="s1">resp =</span>
      <span class="s1">expectResponse&lt;m::debugger::EvaluateOnCallFrameResponse&gt;(conn</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.type</span><span class="s4">, </span><span class="s3">&quot;boolean&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.value</span><span class="s4">, </span><span class="s1">expectedValue)</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(resp.exceptionDetails.has_value())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">expectEvalResponse(SyncConnection &amp;conn</span><span class="s4">, int </span><span class="s1">id</span><span class="s4">, int </span><span class="s1">expectedValue) {</span>
  <span class="s4">auto </span><span class="s1">resp =</span>
      <span class="s1">expectResponse&lt;m::debugger::EvaluateOnCallFrameResponse&gt;(conn</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.type</span><span class="s4">, </span><span class="s3">&quot;number&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.value</span><span class="s4">, </span><span class="s1">expectedValue)</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(resp.exceptionDetails.has_value())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">expectEvalException(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">id</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::string &amp;exceptionText</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::vector&lt;FrameInfo&gt; infos) {</span>
  <span class="s4">auto </span><span class="s1">resp =</span>
      <span class="s1">expectResponse&lt;m::debugger::EvaluateOnCallFrameResponse&gt;(conn</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(resp.exceptionDetails.has_value())</span><span class="s4">;</span>

  <span class="s1">m::runtime::ExceptionDetails &amp;details = resp.exceptionDetails.value()</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(details.text</span><span class="s4">, </span><span class="s1">exceptionText)</span><span class="s4">;</span>

  <span class="s0">// TODO: Hermes doesn't seem to populate the line number for the exception?</span>
  <span class="s1">EXPECT_EQ(details.lineNumber</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(details.stackTrace.has_value())</span><span class="s4">;</span>

  <span class="s1">m::runtime::StackTrace &amp;stackTrace = details.stackTrace.value()</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(stackTrace.callFrames.size()</span><span class="s4">, </span><span class="s1">infos.size())</span><span class="s4">;</span>

  <span class="s4">int </span><span class="s1">i = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s4">const </span><span class="s1">FrameInfo &amp;info : infos) {</span>
    <span class="s4">const </span><span class="s1">m::runtime::CallFrame &amp;callFrame = stackTrace.callFrames[i]</span><span class="s4">;</span>

    <span class="s1">EXPECT_GE(callFrame.lineNumber</span><span class="s4">, </span><span class="s1">info.lineNumberMin)</span><span class="s4">;</span>
    <span class="s1">EXPECT_LE(callFrame.lineNumber</span><span class="s4">, </span><span class="s1">info.lineNumberMax)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(callFrame.functionName</span><span class="s4">, </span><span class="s1">info.functionName)</span><span class="s4">;</span>

    <span class="s1">i++</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">struct </span><span class="s1">PropInfo {</span>
  <span class="s1">PropInfo(</span><span class="s4">const </span><span class="s1">std::string &amp;type) : type(type) {}</span>

  <span class="s1">PropInfo &amp;setSubtype(</span><span class="s4">const </span><span class="s1">std::string &amp;subtypeParam) {</span>
    <span class="s1">subtype = subtypeParam</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">*</span><span class="s4">this;</span>
  <span class="s1">}</span>

  <span class="s1">PropInfo &amp;setValue(</span><span class="s4">const </span><span class="s1">folly::dynamic &amp;valueParam) {</span>
    <span class="s1">value = valueParam</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">*</span><span class="s4">this;</span>
  <span class="s1">}</span>

  <span class="s1">PropInfo &amp;setUnserializableValue(</span>
      <span class="s4">const </span><span class="s1">std::string &amp;unserializableValueParam) {</span>
    <span class="s1">unserializableValue = unserializableValueParam</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">*</span><span class="s4">this;</span>
  <span class="s1">}</span>

  <span class="s1">std::string type</span><span class="s4">;</span>
  <span class="s1">std::optional&lt;std::string&gt; subtype</span><span class="s4">;</span>
  <span class="s1">std::optional&lt;folly::dynamic&gt; value</span><span class="s4">;</span>
  <span class="s1">std::optional&lt;std::string&gt; unserializableValue</span><span class="s4">;</span>
<span class="s1">}</span><span class="s4">;</span>

<span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">std::string&gt; expectProps(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">msgId</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::string &amp;objectId</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">PropInfo&gt; &amp;infos</span><span class="s4">,</span>
    <span class="s4">bool </span><span class="s1">ownProperties = </span><span class="s4">true</span><span class="s1">) {</span>
  <span class="s1">m::runtime::GetPropertiesRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId</span><span class="s4">;</span>
  <span class="s1">req.objectId = objectId</span><span class="s4">;</span>
  <span class="s1">req.ownProperties = ownProperties</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">std::string&gt; objectIds</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::runtime::GetPropertiesResponse&gt;(conn</span><span class="s4">, </span><span class="s1">msgId)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(resp.result.size()</span><span class="s4">, </span><span class="s1">infos.size())</span><span class="s4">;</span>

  <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; resp.result.size()</span><span class="s4">; </span><span class="s1">i++) {</span>
    <span class="s1">m::runtime::PropertyDescriptor &amp;desc = resp.result[i]</span><span class="s4">;</span>

    <span class="s4">auto </span><span class="s1">infoIt = infos.find(desc.name)</span><span class="s4">;</span>
    <span class="s1">EXPECT_FALSE(infoIt == infos.end()) &lt;&lt; desc.name</span><span class="s4">;</span>

    <span class="s4">if </span><span class="s1">(infoIt != infos.end()) {</span>
      <span class="s4">const </span><span class="s1">PropInfo &amp;info = infoIt-&gt;second</span><span class="s4">;</span>

      <span class="s1">EXPECT_TRUE(desc.value.has_value())</span><span class="s4">;</span>

      <span class="s1">m::runtime::RemoteObject &amp;remoteObj = desc.value.value()</span><span class="s4">;</span>
      <span class="s1">EXPECT_EQ(remoteObj.type</span><span class="s4">, </span><span class="s1">info.type)</span><span class="s4">;</span>

      <span class="s4">if </span><span class="s1">(info.subtype.has_value()) {</span>
        <span class="s1">EXPECT_TRUE(remoteObj.subtype.has_value())</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(remoteObj.subtype.value()</span><span class="s4">, </span><span class="s1">info.subtype.value())</span><span class="s4">;</span>
      <span class="s1">}</span>

      <span class="s4">if </span><span class="s1">(info.value.has_value()) {</span>
        <span class="s1">EXPECT_TRUE(remoteObj.value.has_value())</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(remoteObj.value.value()</span><span class="s4">, </span><span class="s1">info.value.value())</span><span class="s4">;</span>
      <span class="s1">}</span>

      <span class="s4">if </span><span class="s1">(info.unserializableValue.has_value()) {</span>
        <span class="s1">EXPECT_TRUE(remoteObj.unserializableValue.has_value())</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(</span>
            <span class="s1">remoteObj.unserializableValue.value()</span><span class="s4">,</span>
            <span class="s1">info.unserializableValue.value())</span><span class="s4">;</span>
      <span class="s1">}</span>

      <span class="s4">if </span><span class="s1">((info.type == </span><span class="s3">&quot;object&quot; </span><span class="s1">&amp;&amp; info.subtype != </span><span class="s3">&quot;null&quot;</span><span class="s1">) ||</span>
          <span class="s1">info.type == </span><span class="s3">&quot;function&quot;</span><span class="s1">) {</span>
        <span class="s1">EXPECT_TRUE(remoteObj.objectId.has_value())</span><span class="s4">;</span>
        <span class="s1">objectIds[desc.name] = remoteObj.objectId.value()</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">return </span><span class="s1">objectIds</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">void </span><span class="s1">expectEvalResponse(</span>
    <span class="s1">SyncConnection &amp;conn</span><span class="s4">,</span>
    <span class="s4">int </span><span class="s1">id</span><span class="s4">,</span>
    <span class="s4">const </span><span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">PropInfo&gt; &amp;infos) {</span>
  <span class="s4">auto </span><span class="s1">resp =</span>
      <span class="s1">expectResponse&lt;m::debugger::EvaluateOnCallFrameResponse&gt;(conn</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.type</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(resp.exceptionDetails.has_value())</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(resp.result.objectId.has_value())</span><span class="s4">;</span>
  <span class="s1">expectProps(conn</span><span class="s4">, </span><span class="s1">id + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">resp.result.objectId.value()</span><span class="s4">, </span><span class="s1">infos)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">m::runtime::CallArgument makeValueCallArgument(folly::dynamic val) {</span>
  <span class="s1">m::runtime::CallArgument ret</span><span class="s4">;</span>
  <span class="s1">ret.value = val</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">ret</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">m::runtime::CallArgument makeUnserializableCallArgument(std::string val) {</span>
  <span class="s1">m::runtime::CallArgument ret</span><span class="s4">;</span>
  <span class="s1">ret.unserializableValue = std::move(val)</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">ret</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">m::runtime::CallArgument makeObjectIdCallArgument(</span>
    <span class="s1">m::runtime::RemoteObjectId objectId) {</span>
  <span class="s1">m::runtime::CallArgument ret</span><span class="s4">;</span>
  <span class="s1">ret.objectId = std::move(objectId)</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">ret</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">} </span><span class="s0">// namespace</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testRespondsOkToUnknownRequests) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 1 + 2; 
    var b = a / 2; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">conn.send(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">{&quot;id&quot;: 2, &quot;method&quot;: &quot;Debugger.foo&quot;}</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">conn.send(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">{&quot;id&quot;: 3, &quot;method&quot;: &quot;Debugger.bar&quot;, &quot;params&quot;: {&quot;a&quot;: &quot;b&quot;}}</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testDebuggerStatement) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 1 + 2; 
    debugger;       // [1] (line 2) hit debugger statement, resume 
    var b = a / 2; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement, resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testDebuggerStatementFromPausedWaitEnable) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 1 + 2; 
    debugger;       // [1] (line 2) hit debugger statement, resume 
    var b = a / 2; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// TODO: hack that gives JS the chance to run so that we end up in the</span>
  <span class="s0">// PausedWaitEnable state. Will move the entire test to InspectorTests once</span>
  <span class="s0">// I get around to refactoring InspectorTests.</span>
  <span class="s1">std::this_thread::sleep_for(</span><span class="s5">250</span><span class="s1">ms)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement, resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testIsDebuggerAttached) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 1 + 2; 
    debugger;       // [1] (line 2) hit debugger statement 
                    // [2] evaluate DebuggerInternal.isDebuggerAttached to true 
    var b = a / 2; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// [2] evaluate DebuggerInternal.IsDebuggerAttached to true</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;-&gt; &quot; + DebuggerInternal.isDebuggerAttached</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;-&gt; true&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testStepOver) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 1 + 2; 
    debugger;       // [1] (line 2) hit debugger statement, step over 
    var b = a / 2;  // [2] (line 3) step over 
    var c = a + b;  // [3] (line 4) resume 
    var d = b - c; 
    var e = c * d; 
    var f = 10; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2): hit debugger statement, step over</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOverRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 3): step over</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOverRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] (line 4): resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testStepIn) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function addOne(val) { 
      return val + 1;   // [3]: resume 
    } 
 
    var a = 1 + 2; 
    debugger;           // [1] (line 6) hit debugger statement, step over 
    var b = addOne(a);  // [2] (line 7) step in 
    var c = a + b; 
    var d = b - c; 
    var e = c * d; 
    var f = 10; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 6): hit debugger statement, step over</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOverRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 7): step in</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepIntoRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] (line 2): resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;addOne&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testStepOut) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function addSquares(a, b) { 
      var a2 = a * a; 
      debugger;        // [1] (line 3) hit debugger statement, step over 
      var b2 = b * b;  // [2] (line 4) step out 
      return a2 + b2; 
    } 
 
    var c = addSquares(1, 2); // [3] (line 8) resume 
    var d = c * c; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 3) hit debugger statement, step over</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;addSquares&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOverRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 4) step out</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;addSquares&quot;</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOutRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] (line 8): resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetBreakpoint) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 1 + 2; 
    debugger;      // [1] (line 2) hit debugger statement, 
                   //     set breakpoint on line 5 
    var b = a / 2; 
    var c = a + b; // [2] (line 5) hit breakpoint, step over 
    var d = b - c; // [3] (line 6) resume 
    var e = c * d; 
    var f = 10; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement, set breakpoint on line 6</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointByUrlRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.lineNumber = </span><span class="s5">5</span><span class="s4">;</span>
  <span class="s1">req.columnNumber = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req.id</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 5) hit breakpoint, step over</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOverRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] (line 6) resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetBreakpointById) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger;      // line 1 
    Math.random(); //      2 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">script = expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = ++msgId</span><span class="s4">;</span>
  <span class="s1">req.location.scriptId = script.scriptId</span><span class="s4">;</span>
  <span class="s1">req.location.lineNumber = </span><span class="s5">2</span><span class="s4">;</span>

  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::debugger::SetBreakpointResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.actualLocation.scriptId</span><span class="s4">, </span><span class="s1">script.scriptId)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.actualLocation.lineNumber</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.actualLocation.columnNumber.value()</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testActivateBreakpoints) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger;      // line 1 
    x=100          //      2 
    debugger;      //      3 
    x=101;         //      4 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">script = expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Set breakpoint #1</span>
  <span class="s1">m::debugger::SetBreakpointRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = ++msgId</span><span class="s4">;</span>
  <span class="s1">req.location.scriptId = script.scriptId</span><span class="s4">;</span>
  <span class="s1">req.location.lineNumber = </span><span class="s5">2</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::debugger::SetBreakpointResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>

  <span class="s0">// Set breakpoint #2</span>
  <span class="s1">req.id = ++msgId</span><span class="s4">;</span>
  <span class="s1">req.location.scriptId = script.scriptId</span><span class="s4">;</span>
  <span class="s1">req.location.lineNumber = </span><span class="s5">4</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::debugger::SetBreakpointResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>

  <span class="s0">// Disable breakpoints</span>
  <span class="s1">m::debugger::SetBreakpointsActiveRequest activeReq</span><span class="s4">;</span>
  <span class="s1">activeReq.id = ++msgId</span><span class="s4">;</span>
  <span class="s1">activeReq.active = </span><span class="s4">false;</span>
  <span class="s1">conn.send(activeReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">activeReq.id)</span><span class="s4">;</span>

  <span class="s0">// Resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Expect first breakpoint to be skipped, now hitting line #3</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Re-enable breakpoints</span>
  <span class="s1">activeReq.id = ++msgId</span><span class="s4">;</span>
  <span class="s1">activeReq.active = </span><span class="s4">true;</span>
  <span class="s1">conn.send(activeReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">activeReq.id)</span><span class="s4">;</span>

  <span class="s0">// Resume and expect breakpoints to trigger again</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Continue and exit</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetBreakpointByIdWithColumnInIndenting) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger;      // line 1 
    Math.random(); //      2 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">script = expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = ++msgId</span><span class="s4">;</span>
  <span class="s1">req.location.scriptId = script.scriptId</span><span class="s4">;</span>
  <span class="s1">req.location.lineNumber = </span><span class="s5">2</span><span class="s4">;</span>
  <span class="s0">// Specify a column location *before* rather than *on* the actual location</span>
  <span class="s1">req.location.columnNumber = </span><span class="s5">0</span><span class="s4">;</span>

  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::debugger::SetBreakpointResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.actualLocation.scriptId</span><span class="s4">, </span><span class="s1">script.scriptId)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.actualLocation.lineNumber</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s0">// Check that we resolved the column to the first available location</span>
  <span class="s1">EXPECT_EQ(resp.actualLocation.columnNumber.value()</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetLazyBreakpoint) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 1 + 2; 
    debugger;      // [1] (line 2) hit debugger statement, 
                   //     set breakpoint on line 5 
 
    function foo() { 
      var b = a / 2; 
      var c = a + b; // [2] (line 7) hit breakpoint, step over 
      var d = b - c; // [3] (line 8) resume 
      var e = c * d; 
      var f = 10; 
    } 
 
    foo(); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s3">&quot;url&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement, set breakpoint on line 6</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointByUrlRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.lineNumber = </span><span class="s5">7</span><span class="s4">;</span>
  <span class="s1">req.columnNumber = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">breakpointId = expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req.id</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">7</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 7) hit breakpoint, step over</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">13</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOverRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] (line 8) resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">8</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">13</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetBreakpointWhileRunning) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">while (!shouldStop()) { 
      var a = 1; 
      var b = 2; 
      var c = a + b; // [1] (line 4) first time: step over 
                     // [3]          second time: set stop flag, resume 
      var d = 10;    // [2] (line 6) resume 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// set breakpoint on line 4: &quot;var c = ...&quot;</span>
  <span class="s1">m::debugger::SetBreakpointByUrlRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.lineNumber = </span><span class="s5">4</span><span class="s4">;</span>
  <span class="s1">req.columnNumber = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req.id</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 4) hit breakpoint, step over</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::StepOverRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 6) resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] (line 4) hit breakpoint again, set stop flag, resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.stop()</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetBreakpointConditional) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var a = 3; 
    debugger;      // [1] (line 2) hit debugger statement, 
                   //  set conditional breakpoint on lines 4, 5 and 6 
    var b = a + 5; // [2] (line 4) skip breakpoint, condition throws 
    var c = b - a; // [3] (line 5) skip breakpoint, condition false 
    var d = b - c; // [4] (line 6) hit breakpoint, condition true 
    var e = c * d; 
    var f = 10; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement,</span>
  <span class="s0">// set conditional breakpoint on lines 4, 5 and 6</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointByUrlRequest req0</span><span class="s4">;</span>
  <span class="s1">req0.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req0.lineNumber = </span><span class="s5">4</span><span class="s4">;</span>
  <span class="s1">req0.condition = std::optional&lt;std::string&gt;(</span><span class="s3">&quot;throw Error('Boom!')&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">conn.send(req0.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req0.id</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointByUrlRequest req1</span><span class="s4">;</span>
  <span class="s1">req1.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req1.lineNumber = </span><span class="s5">5</span><span class="s4">;</span>
  <span class="s1">req1.condition = std::optional&lt;std::string&gt;(</span><span class="s3">&quot;b === a&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">conn.send(req1.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req1.id</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointByUrlRequest req2</span><span class="s4">;</span>
  <span class="s1">req2.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req2.lineNumber = </span><span class="s5">6</span><span class="s4">;</span>
  <span class="s1">req2.condition = std::optional&lt;std::string&gt;(</span><span class="s3">&quot;c === 5&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">conn.send(req2.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req2.id</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 4) skip breakpoint, condition throws</span>

  <span class="s0">// [3] (line 5) skip breakpoint, condition false</span>

  <span class="s0">// [4] (line 6) hit breakpoint, condition true</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testRemoveBreakpoint) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">// [1] (line 2) hit debugger statement, set breakpoint on line 7 
    debugger; 
    var a = 1; 
 
    for (var i = 1; i &lt;= 2; i++) { 
      // [1] (line 7) hit breakpoint and then remove it 
      a += i; 
    } 
 
    storeValue(a); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement, set breakpoint on line 7</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointByUrlRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.lineNumber = </span><span class="s5">7</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">breakpointId = expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req.id</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">7</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 7) hit breakpoint and then remove it</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">m::debugger::RemoveBreakpointRequest removeReq</span><span class="s4">;</span>
  <span class="s1">removeReq.id = msgId++</span><span class="s4">;</span>
  <span class="s1">removeReq.breakpointId = breakpointId</span><span class="s4">;</span>
  <span class="s1">conn.send(removeReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">removeReq.id)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// check final value</span>
  <span class="s1">jsi::Value finalValue = asyncRuntime.awaitStoredValue()</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(finalValue.asNumber()</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testAsyncPauseWhileRunning) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var accum = 10; 
 
    while (!shouldStop()) { 
      var a = 1; 
      var b = 2; 
      var c = a + b; 
 
      accum += c; 
    }                        // (line 9) 
 
    var d = -accum; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// send some number of async pauses, make sure that we always stop before</span>
  <span class="s0">// the end of the loop on line 9</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">10</span><span class="s4">; </span><span class="s1">i++) {</span>
    <span class="s1">send&lt;m::debugger::PauseRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
    <span class="s1">expectPaused(</span>
        <span class="s1">conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">).setLineNumberMax(</span><span class="s5">9</span><span class="s1">)})</span><span class="s4">;</span>

    <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
    <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// break out of loop</span>
  <span class="s1">asyncRuntime.stop()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testEvalOnCallFrame) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var globalVar = &quot;omega&quot;; 
    var booleanVar = true; 
    var numberVar = 42; 
    var objectVar = {number: 1, bool: false, str: &quot;string&quot;}; 
 
    function func1(closure, f1param) { // frame 4 
        var f1v1 = &quot;alpha&quot;; 
        var f1v2 = &quot;beta&quot;; 
        function func1b() {            // frame 3 
            var f1bv1 = &quot;gamma&quot;; 
            function func1c() {        // frame 2 
                var f1cv1 = 19; 
                closure(); 
            } 
            func1c(); 
        } 
        func1b(); 
    } 
 
    function func2() {                 // frame 1 
        var f2v1 = &quot;baker&quot;; 
        var f2v2 = &quot;charlie&quot;; 
        function func2b() {            // frame 0 
            var f2bv1 = &quot;dog&quot;; 
            debugger;                  // [1] (line 25) hit debugger statement 
                                       // [2]           run evals 
                                       // [3]           resume 
            print(globalVar); 
            print(f2bv1); 
        } 
        func2b(); 
    } 
 
    func1(func2, &quot;tau&quot;); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 25) hit debugger statement</span>
  <span class="s1">expectPaused(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s3">&quot;other&quot;</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;func2b&quot;</span><span class="s4">, </span><span class="s5">25</span><span class="s4">, </span><span class="s5">3</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;func2&quot;</span><span class="s4">, </span><span class="s5">31</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;func1c&quot;</span><span class="s4">, </span><span class="s5">13</span><span class="s4">, </span><span class="s5">4</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;func1b&quot;</span><span class="s4">, </span><span class="s5">15</span><span class="s4">, </span><span class="s5">3</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;func1&quot;</span><span class="s4">, </span><span class="s5">17</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">34</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// [2] run eval statements</span>
  <span class="s4">int </span><span class="s1">frame = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;0: &quot; + globalVar</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;1: &quot; + f2bv1</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;2: &quot; + f2v2</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">3</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;3: &quot; + f2bv1 + &quot; &amp;&amp; &quot; + f2v2</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;0: omega&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s3">&quot;1: dog&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s3">&quot;2: charlie&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">3</span><span class="s4">, </span><span class="s3">&quot;3: dog &amp;&amp; charlie&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">msgId += </span><span class="s5">4</span><span class="s4">;</span>

  <span class="s1">frame = </span><span class="s5">1</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;4: &quot; + f2v1</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;5: &quot; + f2v2</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">globalVar = &quot;mod by debugger&quot;</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;4: baker&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s3">&quot;5: charlie&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s3">&quot;mod by debugger&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">msgId += </span><span class="s5">3</span><span class="s4">;</span>

  <span class="s1">frame = </span><span class="s5">2</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;6: &quot; + f1cv1 + f1bv1 + f1v1</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;7: &quot; + globalVar</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;6: 19gammaalpha&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s3">&quot;7: mod by debugger&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">msgId += </span><span class="s5">2</span><span class="s4">;</span>

  <span class="s0">// [2.1] run eval statements that return non-string primitive values</span>
  <span class="s1">frame = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, </span><span class="s3">&quot;booleanVar&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, </span><span class="s3">&quot;numberVar&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, true</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s5">42</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">msgId += </span><span class="s5">2</span><span class="s4">;</span>

  <span class="s0">// [2.2] run eval statement that returns object</span>
  <span class="s1">frame = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, </span><span class="s3">&quot;objectVar&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId + </span><span class="s5">0</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">1</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;bool&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;boolean&quot;</span><span class="s1">).setValue(</span><span class="s4">false</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;str&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;string&quot;</span><span class="s1">).setValue(</span><span class="s3">&quot;string&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>

  <span class="s0">// msgId is increased by 2 because expectEvalResponse will make additional</span>
  <span class="s0">// request with expectProps.</span>
  <span class="s1">msgId += </span><span class="s5">2</span><span class="s4">;</span>

  <span class="s0">// [3] resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testRuntimeEvaluate) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var globalVar = &quot;omega&quot;; 
    var booleanVar = true; 
    var numberVar = 42; 
    var objectVar = {number: 1, bool: false, str: &quot;string&quot;}; 
 
    while(!shouldStop()) {  // [1] (line 6) hit infinite loop 
      var a = 1;            // [2] run evals 
      a++;                  // [3] exit run loop 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 6) hit infinite loop</span>

  <span class="s0">// [2] run eval statements</span>
  <span class="s1">sendRuntimeEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;0: &quot; + globalVar</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;0: omega&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [2.1] run eval statements that return non-string primitive values</span>
  <span class="s1">sendRuntimeEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s3">&quot;booleanVar&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendRuntimeEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s3">&quot;numberVar&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, true</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s5">42</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [2.2] run eval statement that returns object</span>
  <span class="s1">sendRuntimeEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">3</span><span class="s4">, </span><span class="s3">&quot;objectVar&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId + </span><span class="s5">3</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">1</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;bool&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;boolean&quot;</span><span class="s1">).setValue(</span><span class="s4">false</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;str&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;string&quot;</span><span class="s1">).setValue(</span><span class="s3">&quot;string&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>

  <span class="s0">// [3] exit run loop</span>
  <span class="s1">asyncRuntime.stop()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testRuntimeEvaluateReturnByValue) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s3">&quot;while(!shouldStop());&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// We expect this JSON object to be evaluated and return by value, so</span>
  <span class="s0">// that JSON encoding the result will give the same string.</span>
  <span class="s4">auto </span><span class="s1">object = </span><span class="s3">&quot;{</span><span class="s4">\&quot;</span><span class="s3">key</span><span class="s4">\&quot;</span><span class="s3">:[1,</span><span class="s4">\&quot;</span><span class="s3">two</span><span class="s4">\&quot;</span><span class="s3">]}&quot;</span><span class="s4">;</span>

  <span class="s1">m::runtime::EvaluateRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId</span><span class="s4">;</span>
  <span class="s1">req.expression = std::string(</span><span class="s3">&quot;(&quot;</span><span class="s1">) + object + </span><span class="s3">&quot;)&quot;</span><span class="s4">;</span>
  <span class="s1">req.returnByValue = </span><span class="s4">true;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">resp =</span>
      <span class="s1">expectResponse&lt;m::debugger::EvaluateOnCallFrameResponse&gt;(conn</span><span class="s4">, </span><span class="s1">msgId)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.result.type</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">ASSERT_TRUE(resp.result.value.has_value())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(folly::toJson(resp.result.value.value())</span><span class="s4">, </span><span class="s1">object)</span><span class="s4">;</span>

  <span class="s0">// [3] exit run loop</span>
  <span class="s1">asyncRuntime.stop()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testEvalOnCallFrameException) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var count = 0; 
 
    function eventuallyThrows(x) { 
      if (x &lt;= 0) 
        throw new Error(&quot;I frew up.&quot;); 
      count++; 
      eventuallyThrows(x-1); 
    } 
 
    function callme() { 
      print(&quot;Hello&quot;); 
      debugger;          // [1] (line 12) hit debugger statement 
                         // [2]           run evals 
                         // [3]           resume 
      print(&quot;Goodbye&quot;); 
    } 
 
    callme(); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 12) hit debugger statement</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;callme&quot;</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">18</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// [2] run evals</span>
  <span class="s4">int </span><span class="s1">frame = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, </span><span class="s3">&quot;this is not valid javascript&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, </span><span class="s3">&quot;eventuallyThrows(5)&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s1">frame</span><span class="s4">, </span><span class="s3">&quot;count&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">expectEvalException(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">0</span><span class="s4">, </span><span class="s3">&quot;SyntaxError: 1:6:';' expected&quot;</span><span class="s4">, </span><span class="s1">{})</span><span class="s4">;</span>
  <span class="s1">expectEvalException(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId + </span><span class="s5">1</span><span class="s4">,</span>
      <span class="s3">&quot;Error: I frew up.&quot;</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;eventuallyThrows&quot;</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;eventuallyThrows&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;eventuallyThrows&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;eventuallyThrows&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;eventuallyThrows&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;eventuallyThrows&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">0</span><span class="s1">}</span><span class="s4">,</span>

       <span class="s0">// TODO: unsure why these frames are here, but they're in hdb tests</span>
       <span class="s0">// too. Ask Hermes about if they really should be there.</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;eval&quot;</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">).setLineNumberMax(</span><span class="s5">19</span><span class="s1">)</span><span class="s4">,</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;callme&quot;</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">,</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s5">0</span><span class="s1">).setLineNumberMax(</span><span class="s5">19</span><span class="s1">)})</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">2</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">msgId += </span><span class="s5">3</span><span class="s4">;</span>

  <span class="s0">// [3] resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testLoadMultipleScripts) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function foo(x) { 
      debugger; 
      print(x); 
    } 
 
    var a = 1 + 1; 
 
    //# sourceMappingURL=/foo/bar/url1.js.map 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s3">&quot;url1&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>

  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>

  <span class="s1">m::debugger::ScriptParsedNotification script1 =</span>
      <span class="s1">expectScriptParsed(conn</span><span class="s4">, </span><span class="s3">&quot;url1&quot;</span><span class="s4">, </span><span class="s3">&quot;/foo/bar/url1.js.map&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var b = a + 2; 
    var c = b - 1; 
    foo(c); 
 
    //# sourceMappingURL=/foo/bar/url2.js.map 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s3">&quot;url2&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">m::debugger::ScriptParsedNotification script2 =</span>
      <span class="s1">expectScriptParsed(conn</span><span class="s4">, </span><span class="s3">&quot;url2&quot;</span><span class="s4">, </span><span class="s3">&quot;/foo/bar/url2.js.map&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 2) hit debugger statement, resume</span>
  <span class="s1">expectPaused(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s3">&quot;other&quot;</span><span class="s4">,</span>
      <span class="s1">{FrameInfo(</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).setScriptId(script1.scriptId)</span><span class="s4">,</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s1">).setScriptId(script2.scriptId)})</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testGetProperties) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>
  <span class="s1">std::vector&lt;std::string&gt; objIds</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function foo() { 
      var num = 123; 
      var obj = { 
        &quot;depth&quot;: 0, 
        &quot;value&quot;: { 
          &quot;a&quot;: -1/0, 
          &quot;b&quot;: 1/0, 
          &quot;c&quot;: Math.sqrt(-2), 
          &quot;d&quot;: -0, 
          &quot;e&quot;: &quot;e_string&quot; 
        } 
      }; 
      var arr = [1, 2, 3]; 
      function bar() { 
        var num = 456; 
        var obj = {&quot;depth&quot;: 1, &quot;value&quot;: {&quot;c&quot;: 5, &quot;d&quot;: &quot;d_string&quot;}}; 
        debugger; 
      }; 
      bar(); 
      debugger; 
    } 
 
    foo(); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">pausedNote = expectPaused(</span>
      <span class="s1">conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;bar&quot;</span><span class="s4">, </span><span class="s5">17</span><span class="s4">, </span><span class="s5">3</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">19</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">23</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">&amp;scopeObj = pausedNote.callFrames.at(</span><span class="s5">1</span><span class="s1">).scopeChain.at(</span><span class="s5">0</span><span class="s1">).object</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(scopeObj.objectId.has_value())</span><span class="s4">;</span>
  <span class="s1">std::string scopeObjId = scopeObj.objectId.value()</span><span class="s4">;</span>
  <span class="s1">objIds.push_back(scopeObjId)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">scopeChildren = expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">scopeObjId</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;this&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;undefined&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;num&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">123</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;obj&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;arr&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">).setSubtype(</span><span class="s3">&quot;array&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;bar&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;function&quot;</span><span class="s1">)}})</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(scopeChildren.size()</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(scopeChildren.count(</span><span class="s3">&quot;obj&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::string objId = scopeChildren.at(</span><span class="s3">&quot;obj&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">objIds.push_back(objId)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">objChildren = expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">objId</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;depth&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">0</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;value&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(objChildren.size()</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(objChildren.count(</span><span class="s3">&quot;value&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::string valueId = objChildren.at(</span><span class="s3">&quot;value&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">objIds.push_back(valueId)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">valueChildren = expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">valueId</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;a&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setUnserializableValue(</span><span class="s3">&quot;-Infinity&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;b&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setUnserializableValue(</span><span class="s3">&quot;Infinity&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;c&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setUnserializableValue(</span><span class="s3">&quot;NaN&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;d&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setUnserializableValue(</span><span class="s3">&quot;-0&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;e&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;string&quot;</span><span class="s1">).setValue(</span><span class="s3">&quot;e_string&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(valueChildren.size()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">20</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">23</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// all old object ids should be invalid after resuming</span>
  <span class="s4">for </span><span class="s1">(std::string oldObjId : objIds) {</span>
    <span class="s1">expectProps(</span>
        <span class="s1">conn</span><span class="s4">, </span><span class="s1">msgId++</span><span class="s4">, </span><span class="s1">oldObjId</span><span class="s4">, </span><span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">PropInfo&gt;{})</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testGetPropertiesOnlyOwnProperties) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function foo() { 
      var protoObject = { 
        &quot;protoNum&quot;: 77 
      }; 
      var obj = Object.create(protoObject); 
      obj.num = 42; 
      debugger; 
    } 
    foo(); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// wait for a pause on debugger statement and get object ID from the local</span>
  <span class="s0">// scope.</span>
  <span class="s4">auto </span><span class="s1">pausedNote =</span>
      <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">9</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scopeObject = pausedNote.callFrames.at(</span><span class="s5">0</span><span class="s1">).scopeChain.at(</span><span class="s5">0</span><span class="s1">).object</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scopeChildren = expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">scopeObject.objectId.value()</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;this&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;undefined&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;obj&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;protoObject&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(scopeChildren.count(</span><span class="s3">&quot;obj&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">std::string objId = scopeChildren.at(</span><span class="s3">&quot;obj&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Check that GetProperties request for obj object only have own properties</span>
  <span class="s0">// when onlyOwnProperties = true.</span>
  <span class="s1">expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">objId</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;num&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">42</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}}</span><span class="s4">,</span>
      <span class="s4">true</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Check that GetProperties request for obj object only have all properties</span>
  <span class="s0">// when onlyOwnProperties = false.</span>
  <span class="s0">// __proto__ is not returned here because all properties from proto chain</span>
  <span class="s0">// are already included in the result.</span>
  <span class="s1">expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">objId</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;num&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">42</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;protoNum&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">77</span><span class="s1">)}}</span><span class="s4">,</span>
      <span class="s4">false</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testDisable) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">while (!shouldStop()) { 
      var a = 1; 
      var b = 2; 
      var c = a + b; // [1] (line 4) disable to remove breakpoints and resume 
                     // [2] (line 4) the breakpoint should not hit anymore 
      var d = 10; 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// set breakpoint on line 4: &quot;var c = ...&quot;</span>
  <span class="s1">m::debugger::SetBreakpointByUrlRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.lineNumber = </span><span class="s5">4</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req.id</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">4</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 4) disable to remove breakpoints and resume</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">4</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::DisableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] (line 4) the breakpoint should not hit anymore</span>
  <span class="s1">expectNothing(conn)</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.stop()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testDisableWhileRunning) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger; // [1] initial pause to set the breakpoint on line 6 
    while (!shouldStop()) { // [2] loop running until we receive a detach request 
      var a = 1; 
    } 
    while (shouldStop()) { 
      var c = a + 1; // [3] (line 6) the breakpoint should not hit after detach 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] initial pause to set the breakpoint on line 6</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// set breakpoint on line 6: &quot;var c = ...&quot;</span>
  <span class="s1">m::debugger::SetBreakpointByUrlRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.lineNumber = </span><span class="s5">6</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req.id</span><span class="s4">, </span><span class="s5">6</span><span class="s4">, </span><span class="s5">6</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [2] loop running until we receive a detach request</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::DisableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.stop()</span><span class="s4">;</span>

  <span class="s0">// [3] (line 6) the breakpoint should not hit after detach</span>
  <span class="s1">expectNothing(conn)</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.start()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetPauseOnExceptionsAll) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger; // [1] (line 1) initial pause, set throw on exceptions to 'All' 
 
    try { 
      var a = 123; 
      throw new Error('Caught error'); // [2] line 5, pause on exception 
    } catch (err) { 
      // Do nothing. 
    } 
 
    throw new Error('Uncaught exception'); // [3] line 10, pause on exception 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 1) initial pause, set throw on exceptions to 'All'</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">m::debugger::SetPauseOnExceptionsRequest allExceptionsReq</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.id = msgId++</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.state = </span><span class="s3">&quot;all&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(allExceptionsReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">allExceptionsReq.id)</span><span class="s4">;</span>

  <span class="s0">// Resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [2] line 5, pause on exception</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;exception&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">5</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] line 10, pause on exception</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;exception&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Send resume event and check that Hermes has thrown an exception.</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.wait()</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.getNumberOfExceptions()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.getLastThrownExceptionMessage()</span><span class="s4">, </span><span class="s3">&quot;Uncaught exception&quot;</span><span class="s1">)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetPauseOnExceptionsNone) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger; // [1] (line 1) initial pause, set throw on exceptions to 'None' 
 
    try { 
      var a = 123; 
      throw new Error('Caught error'); 
    } catch (err) { 
      // Do nothing. 
    } 
 
    throw new Error('Uncaught exception'); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 1) initial pause, set throw on exceptions to 'None'</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">m::debugger::SetPauseOnExceptionsRequest allExceptionsReq</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.id = msgId++</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.state = </span><span class="s3">&quot;none&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(allExceptionsReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">allExceptionsReq.id)</span><span class="s4">;</span>

  <span class="s0">// Resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Check that Hermes has thrown an exception (without reporting it).</span>
  <span class="s1">expectNothing(conn)</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.wait()</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.getNumberOfExceptions()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.getLastThrownExceptionMessage()</span><span class="s4">, </span><span class="s3">&quot;Uncaught exception&quot;</span><span class="s1">)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetPauseOnExceptionsUncaught) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger; // [1] (line 1) initial pause, set throw on exceptions to 'Uncaught' 
 
    try { 
      var a = 123; 
      throw new Error('Caught error'); 
    } catch (err) { 
      // Do nothing. 
    } 
 
    throw new Error('Uncaught exception'); // [3] line 10, pause on exception 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 1) initial pause, set throw on exceptions to 'Uncaught'</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">m::debugger::SetPauseOnExceptionsRequest allExceptionsReq</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.id = msgId++</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.state = </span><span class="s3">&quot;uncaught&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(allExceptionsReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">allExceptionsReq.id)</span><span class="s4">;</span>

  <span class="s0">// Resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [3] line 10, pause on exception</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;exception&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">10</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Send resume event and check that Hermes has thrown an exception.</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.wait()</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.getNumberOfExceptions()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.getLastThrownExceptionMessage()</span><span class="s4">, </span><span class="s3">&quot;Uncaught exception&quot;</span><span class="s1">)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">invalidPauseModeGivesError) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetPauseOnExceptionsRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = </span><span class="s5">1</span><span class="s4">;</span>
  <span class="s1">req.state = </span><span class="s3">&quot;badgers&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::ErrorResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testShouldPauseOnThrow) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger; // [1] (line 1) initial pause, check shouldPauseOnThrow is false 
              // [2] set throw to 'All', check shouldPauseOnThrow is true 
              // [3] set throw to 'None', check shouldPauseOnThrow is false 
              // [4] set throw to 'Uncaught', check shouldPauseOnThrow is true 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">shouldPauseOnThrowEvalMsg =</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">&quot;-&gt; &quot; + DebuggerInternal.shouldPauseOnThrow</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">responseTrue = </span><span class="s3">&quot;-&gt; true&quot;</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">responseFalse = </span><span class="s3">&quot;-&gt; false&quot;</span><span class="s4">;</span>

  <span class="s0">// [1] (line 1) initial pause, check shouldPauseOnThrow is false</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">shouldPauseOnThrowEvalMsg)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">responseFalse)</span><span class="s4">;</span>

  <span class="s0">// [2] set throw to 'All', check shouldPauseOnThrow is true</span>
  <span class="s1">m::debugger::SetPauseOnExceptionsRequest allExceptionsReq</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.id = msgId++</span><span class="s4">;</span>
  <span class="s1">allExceptionsReq.state = </span><span class="s3">&quot;all&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(allExceptionsReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">allExceptionsReq.id)</span><span class="s4">;</span>

  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">shouldPauseOnThrowEvalMsg)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">responseTrue)</span><span class="s4">;</span>

  <span class="s0">// [3] set throw to 'None', check shouldPauseOnThrow is false</span>
  <span class="s1">m::debugger::SetPauseOnExceptionsRequest noExceptionsReq</span><span class="s4">;</span>
  <span class="s1">noExceptionsReq.id = msgId++</span><span class="s4">;</span>
  <span class="s1">noExceptionsReq.state = </span><span class="s3">&quot;none&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(noExceptionsReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">noExceptionsReq.id)</span><span class="s4">;</span>

  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">shouldPauseOnThrowEvalMsg)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">responseFalse)</span><span class="s4">;</span>

  <span class="s0">// [4] set throw to 'Uncaught', check shouldPauseOnThrow is true</span>
  <span class="s1">m::debugger::SetPauseOnExceptionsRequest uncaughtExceptionsReq</span><span class="s4">;</span>
  <span class="s1">uncaughtExceptionsReq.id = msgId++</span><span class="s4">;</span>
  <span class="s1">uncaughtExceptionsReq.state = </span><span class="s3">&quot;uncaught&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(uncaughtExceptionsReq.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::OkResponse&gt;(conn</span><span class="s4">, </span><span class="s1">uncaughtExceptionsReq.id)</span><span class="s4">;</span>

  <span class="s1">sendEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">shouldPauseOnThrowEvalMsg)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId + </span><span class="s5">1</span><span class="s4">, </span><span class="s1">responseTrue)</span><span class="s4">;</span>

  <span class="s0">// Resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testScopeVariables) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var globalString = &quot;global-string&quot;; 
    var globalObject = {number: 1, bool: false}; 
 
    function func() { 
      var localString = &quot;local-string&quot;; 
      var localObject = {number: 2, bool: true}; 
      debugger; // [1] (line 7) hit debugger statement 
                // two local vars - localString and localObject 
                // two global vars - globalString and globalObject 
    } 
 
    func(); // line 12 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 7) hit debugger statement</span>
  <span class="s4">auto </span><span class="s1">pausedNote =</span>
      <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;func&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">12</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scopeChain = pausedNote.callFrames.at(</span><span class="s5">0</span><span class="s1">).scopeChain</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(scopeChain.size()</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [2] inspect local scope</span>
  <span class="s1">EXPECT_EQ(scopeChain.at(</span><span class="s5">0</span><span class="s1">).type</span><span class="s4">, </span><span class="s3">&quot;local&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">localScopeObject = scopeChain.at(</span><span class="s5">0</span><span class="s1">).object</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">localScopeObjectChildren = expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">localScopeObject.objectId.value()</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;this&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;undefined&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;localString&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;string&quot;</span><span class="s1">).setValue(</span><span class="s3">&quot;local-string&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;localObject&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">localObjectId = localScopeObjectChildren.at(</span><span class="s3">&quot;localObject&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">localObjectId</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">2</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;bool&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;boolean&quot;</span><span class="s1">).setValue(</span><span class="s4">true</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>

  <span class="s0">// [3] inspect global scope</span>
  <span class="s0">// Global scope can contain more properties than we have defined</span>
  <span class="s0">// in our test code and we can't use expectProps() method here.</span>
  <span class="s0">// As a workaround we create a Map of properties and check that</span>
  <span class="s0">// those global properties that we have defined are in the map.</span>
  <span class="s1">EXPECT_EQ(scopeChain.at(</span><span class="s5">1</span><span class="s1">).type</span><span class="s4">, </span><span class="s3">&quot;global&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">globalScopeObject = scopeChain.at(</span><span class="s5">1</span><span class="s1">).object</span><span class="s4">;</span>
  <span class="s1">m::runtime::GetPropertiesRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.objectId = globalScopeObject.objectId.value()</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::runtime::GetPropertiesResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
  <span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">std::optional&lt;m::runtime::RemoteObject&gt;&gt;</span>
      <span class="s1">globalProperties</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s4">auto </span><span class="s1">propertyDescriptor : resp.result) {</span>
    <span class="s1">globalProperties[propertyDescriptor.name] = propertyDescriptor.value</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">EXPECT_GE(globalProperties.size()</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// globalString should be of type &quot;string&quot; and have value &quot;global-string&quot;.</span>
  <span class="s1">EXPECT_EQ(globalProperties.count(</span><span class="s3">&quot;globalString&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(globalProperties[</span><span class="s3">&quot;globalString&quot;</span><span class="s1">].has_value())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(globalProperties[</span><span class="s3">&quot;globalString&quot;</span><span class="s1">].value().type</span><span class="s4">, </span><span class="s3">&quot;string&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s1">globalProperties[</span><span class="s3">&quot;globalString&quot;</span><span class="s1">].value().value.value()</span><span class="s4">, </span><span class="s3">&quot;global-string&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// func should be of type &quot;function&quot;.</span>
  <span class="s1">EXPECT_EQ(globalProperties.count(</span><span class="s3">&quot;func&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(globalProperties[</span><span class="s3">&quot;func&quot;</span><span class="s1">].has_value())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(globalProperties[</span><span class="s3">&quot;func&quot;</span><span class="s1">].value().type</span><span class="s4">, </span><span class="s3">&quot;function&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// globalObject should be of type &quot;object&quot; with &quot;number&quot; and &quot;bool&quot;</span>
  <span class="s0">// properties.</span>
  <span class="s1">EXPECT_EQ(globalProperties.count(</span><span class="s3">&quot;globalObject&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(globalProperties[</span><span class="s3">&quot;globalObject&quot;</span><span class="s1">].has_value())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(globalProperties[</span><span class="s3">&quot;globalObject&quot;</span><span class="s1">].value().type</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">globalProperties[</span><span class="s3">&quot;globalObject&quot;</span><span class="s1">].value().objectId.value()</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">1</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;bool&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;boolean&quot;</span><span class="s1">).setValue(</span><span class="s4">false</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>

  <span class="s0">// [4] resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testRuntimeCallFunctionOnObject) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
      <span class="s3">debugger; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// create a new Object() that will be used as &quot;this&quot; below.</span>
  <span class="s1">m::runtime::RemoteObjectId thisId</span><span class="s4">;</span>
  <span class="s1">{</span>
    <span class="s1">sendRuntimeEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId</span><span class="s4">, </span><span class="s3">&quot;new Object()&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::runtime::EvaluateResponse&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
    <span class="s1">ASSERT_TRUE(resp.result.objectId) &lt;&lt; resp.toDynamic()</span><span class="s4">;</span>
    <span class="s1">thisId = *resp.result.objectId</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// expectedPropInfos are properties that are expected to exist in thisId. It</span>
  <span class="s0">// is modified by addMember (below).</span>
  <span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">PropInfo&gt; expectedPropInfos</span><span class="s4">;</span>

  <span class="s0">// Add __proto__ as it always exists.</span>
  <span class="s1">expectedPropInfos.emplace(</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">))</span><span class="s4">;</span>

  <span class="s0">/// addMember sends Runtime.callFunctionOn() requests with a function</span>
  <span class="s0">/// declaration that simply adds a new property called \p propName with type</span>
  <span class="s0">/// \p type to the remote object \p id. \p ca is the property's value.</span>
  <span class="s0">/// The new property must not exist in \p id unless \p allowRedefinition is</span>
  <span class="s0">/// true.</span>
  <span class="s4">auto </span><span class="s1">addMember = [&amp;](</span><span class="s4">const </span><span class="s1">m::runtime::RemoteObjectId id</span><span class="s4">,</span>
                       <span class="s4">const char </span><span class="s1">*type</span><span class="s4">,</span>
                       <span class="s4">const char </span><span class="s1">*propName</span><span class="s4">,</span>
                       <span class="s4">const </span><span class="s1">m::runtime::CallArgument &amp;ca</span><span class="s4">,</span>
                       <span class="s4">bool </span><span class="s1">allowRedefinition = </span><span class="s4">false</span><span class="s1">) {</span>
    <span class="s1">m::runtime::CallFunctionOnRequest req</span><span class="s4">;</span>
    <span class="s1">req.id = msgId++</span><span class="s4">;</span>
    <span class="s1">req.functionDeclaration =</span>
        <span class="s1">std::string(</span><span class="s3">&quot;function(e){const r=</span><span class="s4">\&quot;</span><span class="s3">&quot;</span><span class="s1">) + propName + </span><span class="s3">&quot;</span><span class="s4">\&quot;</span><span class="s3">; this[r]=e,r}&quot;</span><span class="s4">;</span>
    <span class="s1">req.arguments = std::vector&lt;m::runtime::CallArgument&gt;{ca}</span><span class="s4">;</span>
    <span class="s1">req.objectId = thisId</span><span class="s4">;</span>
    <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
    <span class="s1">expectResponse&lt;m::runtime::CallFunctionOnResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>

    <span class="s4">auto </span><span class="s1">it = expectedPropInfos.emplace(propName</span><span class="s4">, </span><span class="s1">PropInfo(type))</span><span class="s4">;</span>

    <span class="s1">EXPECT_TRUE(allowRedefinition || it.second)</span>
        <span class="s1">&lt;&lt; </span><span class="s3">&quot;property </span><span class="s4">\&quot;</span><span class="s3">&quot; </span><span class="s1">&lt;&lt; propName &lt;&lt; </span><span class="s3">&quot;</span><span class="s4">\&quot; </span><span class="s3">redefined.&quot;</span><span class="s4">;</span>

    <span class="s4">if </span><span class="s1">(ca.value) {</span>
      <span class="s1">it.first-&gt;second.setValue(*ca.value)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s4">if </span><span class="s1">(ca.unserializableValue) {</span>
      <span class="s1">it.first-&gt;second.setUnserializableValue(*ca.unserializableValue)</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s1">addMember(thisId</span><span class="s4">, </span><span class="s3">&quot;boolean&quot;</span><span class="s4">, </span><span class="s3">&quot;b&quot;</span><span class="s4">, </span><span class="s1">makeValueCallArgument(</span><span class="s4">true</span><span class="s1">))</span><span class="s4">;</span>
  <span class="s1">addMember(thisId</span><span class="s4">, </span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s3">&quot;num&quot;</span><span class="s4">, </span><span class="s1">makeValueCallArgument(</span><span class="s5">12</span><span class="s1">))</span><span class="s4">;</span>
  <span class="s1">addMember(thisId</span><span class="s4">, </span><span class="s3">&quot;string&quot;</span><span class="s4">, </span><span class="s3">&quot;str&quot;</span><span class="s4">, </span><span class="s1">makeValueCallArgument(</span><span class="s3">&quot;string value&quot;</span><span class="s1">))</span><span class="s4">;</span>
  <span class="s1">addMember(thisId</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s4">, </span><span class="s3">&quot;self_ref&quot;</span><span class="s4">, </span><span class="s1">makeObjectIdCallArgument(thisId))</span><span class="s4">;</span>
  <span class="s1">addMember(</span>
      <span class="s1">thisId</span><span class="s4">, </span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s3">&quot;inf&quot;</span><span class="s4">, </span><span class="s1">makeUnserializableCallArgument(</span><span class="s3">&quot;Infinity&quot;</span><span class="s1">))</span><span class="s4">;</span>
  <span class="s1">addMember(</span>
      <span class="s1">thisId</span><span class="s4">, </span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s3">&quot;ni&quot;</span><span class="s4">, </span><span class="s1">makeUnserializableCallArgument(</span><span class="s3">&quot;-Infinity&quot;</span><span class="s1">))</span><span class="s4">;</span>
  <span class="s1">addMember(thisId</span><span class="s4">, </span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s3">&quot;nan&quot;</span><span class="s4">, </span><span class="s1">makeUnserializableCallArgument(</span><span class="s3">&quot;NaN&quot;</span><span class="s1">))</span><span class="s4">;</span>

  <span class="s0">/// ensures that \p objId has all of the expected properties; Returns the</span>
  <span class="s0">/// runtime::RemoteObjectId for the &quot;self_ref&quot; property (which must exist).</span>
  <span class="s4">auto </span><span class="s1">verifyObjShape = [&amp;](</span><span class="s4">const </span><span class="s1">m::runtime::RemoteObjectId &amp;objId)</span>
      <span class="s1">-&gt; std::optional&lt;std::string&gt; {</span>
    <span class="s4">auto </span><span class="s1">objProps = expectProps(conn</span><span class="s4">, </span><span class="s1">msgId++</span><span class="s4">, </span><span class="s1">objId</span><span class="s4">, </span><span class="s1">expectedPropInfos)</span><span class="s4">;</span>
    <span class="s1">EXPECT_TRUE(objProps.count(</span><span class="s3">&quot;__proto__&quot;</span><span class="s1">))</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">objPropIt = objProps.find(</span><span class="s3">&quot;self_ref&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(objPropIt == objProps.end()) {</span>
      <span class="s1">EXPECT_TRUE(</span><span class="s4">false</span><span class="s1">) &lt;&lt; </span><span class="s3">&quot;missing </span><span class="s4">\&quot;</span><span class="s3">self_ref</span><span class="s4">\&quot; </span><span class="s3">property.&quot;</span><span class="s4">;</span>
      <span class="s4">return </span><span class="s1">{}</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s4">return </span><span class="s1">objPropIt-&gt;second</span><span class="s4">;</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s0">// Verify that thisId has the correct shape.</span>
  <span class="s4">auto </span><span class="s1">selfRefId = verifyObjShape(thisId)</span><span class="s4">;</span>
  <span class="s1">ASSERT_TRUE(selfRefId)</span><span class="s4">;</span>
  <span class="s0">// Then verify that the self reference has the correct shape. If thisId does</span>
  <span class="s0">// not have the &quot;self_ref&quot; property the call to verifyObjShape will return an</span>
  <span class="s0">// empty Optional, as well as report an error.</span>
  <span class="s1">selfRefId = verifyObjShape(*selfRefId)</span><span class="s4">;</span>
  <span class="s1">ASSERT_TRUE(selfRefId)</span><span class="s4">;</span>

  <span class="s0">// Now we modify the self reference, which should cause thisId to change</span>
  <span class="s0">// as well.</span>
  <span class="s4">const bool </span><span class="s1">kAllowRedefinition = </span><span class="s4">true;</span>

  <span class="s1">addMember(</span>
      <span class="s1">*selfRefId</span><span class="s4">,</span>
      <span class="s3">&quot;number&quot;</span><span class="s4">,</span>
      <span class="s3">&quot;num&quot;</span><span class="s4">,</span>
      <span class="s1">makeValueCallArgument(</span><span class="s5">42</span><span class="s1">)</span><span class="s4">,</span>
      <span class="s1">kAllowRedefinition)</span><span class="s4">;</span>

  <span class="s1">addMember(</span>
      <span class="s1">*selfRefId</span><span class="s4">, </span><span class="s3">&quot;number&quot;</span><span class="s4">, </span><span class="s3">&quot;neg_zero&quot;</span><span class="s4">, </span><span class="s1">makeUnserializableCallArgument(</span><span class="s3">&quot;-0&quot;</span><span class="s1">))</span><span class="s4">;</span>

  <span class="s1">verifyObjShape(thisId)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testRuntimeCallFunctionOnExecutionContext) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
      <span class="s3">debugger; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">/// helper that returns a map with all of \p objId 's members.</span>
  <span class="s4">auto </span><span class="s1">getProps = [&amp;msgId</span><span class="s4">, </span><span class="s1">&amp;conn](</span><span class="s4">const </span><span class="s1">m::runtime::RemoteObjectId &amp;objId) {</span>
    <span class="s1">m::runtime::GetPropertiesRequest req</span><span class="s4">;</span>
    <span class="s1">req.id = msgId++</span><span class="s4">;</span>
    <span class="s1">req.objectId = objId</span><span class="s4">;</span>
    <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::runtime::GetPropertiesResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
    <span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">std::optional&lt;m::runtime::RemoteObject&gt;&gt;</span>
        <span class="s1">properties</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">auto </span><span class="s1">propertyDescriptor : resp.result) {</span>
      <span class="s1">properties[propertyDescriptor.name] = propertyDescriptor.value</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s4">return </span><span class="s1">properties</span><span class="s4">;</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// globalThisId is the inspector's object Id for globalThis.</span>
  <span class="s1">m::runtime::RemoteObjectId globalThisId</span><span class="s4">;</span>
  <span class="s1">{</span>
    <span class="s1">sendRuntimeEvalRequest(conn</span><span class="s4">, </span><span class="s1">msgId</span><span class="s4">, </span><span class="s3">&quot;globalThis&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::runtime::EvaluateResponse&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
    <span class="s1">ASSERT_TRUE(resp.result.objectId) &lt;&lt; resp.toDynamic()</span><span class="s4">;</span>
    <span class="s1">globalThisId = *resp.result.objectId</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// This test table has all of the new fields we want to add to globalThis,</span>
  <span class="s0">// plus the Runtime.CallArgument to be sent to the inspector.</span>
  <span class="s4">struct </span><span class="s1">{</span>
    <span class="s4">const char </span><span class="s1">*propName</span><span class="s4">;</span>
    <span class="s4">const </span><span class="s1">m::runtime::CallArgument callArg</span><span class="s4">;</span>
  <span class="s1">} tests[] = {</span>
      <span class="s1">{</span><span class="s3">&quot;callFunctionOnTestMember1&quot;</span><span class="s4">, </span><span class="s1">makeValueCallArgument(</span><span class="s5">10</span><span class="s1">)}</span><span class="s4">,</span>
      <span class="s1">{</span><span class="s3">&quot;callFunctionOnTestMember2&quot;</span><span class="s4">, </span><span class="s1">makeValueCallArgument(</span><span class="s3">&quot;string&quot;</span><span class="s1">)}</span><span class="s4">,</span>
      <span class="s1">{</span><span class="s3">&quot;callFunctionOnTestMember3&quot;</span><span class="s4">, </span><span class="s1">makeUnserializableCallArgument(</span><span class="s3">&quot;NaN&quot;</span><span class="s1">)}</span><span class="s4">,</span>
      <span class="s1">{</span><span class="s3">&quot;callFunctionOnTestMember4&quot;</span><span class="s4">, </span><span class="s1">makeUnserializableCallArgument(</span><span class="s3">&quot;-0&quot;</span><span class="s1">)}</span><span class="s4">,</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s0">// sanity-check that our test fields don't exist in global this.</span>
  <span class="s1">{</span>
    <span class="s4">auto </span><span class="s1">currProps = getProps(globalThisId)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">const auto </span><span class="s1">&amp;test : tests) {</span>
      <span class="s1">EXPECT_EQ(currProps.count(test.propName)</span><span class="s4">, </span><span class="s5">0</span><span class="s1">) &lt;&lt; test.propName</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">auto </span><span class="s1">addMember = [&amp;msgId</span><span class="s4">, </span><span class="s1">&amp;conn](</span>
                       <span class="s4">const char </span><span class="s1">*propName</span><span class="s4">,</span>
                       <span class="s4">const </span><span class="s1">m::runtime::CallArgument &amp;ca) {</span>
    <span class="s1">m::runtime::CallFunctionOnRequest req</span><span class="s4">;</span>
    <span class="s1">req.id = msgId++</span><span class="s4">;</span>
    <span class="s1">req.functionDeclaration =</span>
        <span class="s1">std::string(</span><span class="s3">&quot;function(e){const r=</span><span class="s4">\&quot;</span><span class="s3">&quot;</span><span class="s1">) + propName + </span><span class="s3">&quot;</span><span class="s4">\&quot;</span><span class="s3">; this[r]=e,r}&quot;</span><span class="s4">;</span>
    <span class="s1">req.arguments = std::vector&lt;m::runtime::CallArgument&gt;{ca}</span><span class="s4">;</span>
    <span class="s1">req.executionContextId = </span><span class="s5">1</span><span class="s4">;</span>
    <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
    <span class="s1">expectResponse&lt;m::runtime::CallFunctionOnResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s4">for </span><span class="s1">(</span><span class="s4">const auto </span><span class="s1">&amp;test : tests) {</span>
    <span class="s1">addMember(test.propName</span><span class="s4">, </span><span class="s1">test.callArg)</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">{</span>
    <span class="s4">auto </span><span class="s1">currProps = getProps(globalThisId)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">const auto </span><span class="s1">&amp;test : tests) {</span>
      <span class="s4">auto </span><span class="s1">it = currProps.find(test.propName)</span><span class="s4">;</span>

      <span class="s0">// there should be a property named test.propName in globalThis.</span>
      <span class="s1">ASSERT_TRUE(it != currProps.end()) &lt;&lt; test.propName</span><span class="s4">;</span>

      <span class="s0">// and it should have a value.</span>
      <span class="s1">ASSERT_TRUE(it-&gt;second) &lt;&lt; test.propName</span><span class="s4">;</span>

      <span class="s4">if </span><span class="s1">(it-&gt;second-&gt;value.has_value()) {</span>
        <span class="s0">// the property has a value, so make sure that's what's being expected.</span>
        <span class="s4">auto </span><span class="s1">actual = it-&gt;second-&gt;value</span><span class="s4">;</span>
        <span class="s4">auto </span><span class="s1">expected = test.callArg.value</span><span class="s4">;</span>
        <span class="s1">ASSERT_TRUE(expected.has_value()) &lt;&lt; test.propName</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(*actual</span><span class="s4">, </span><span class="s1">*expected) &lt;&lt; test.propName</span><span class="s4">;</span>
      <span class="s1">} </span><span class="s4">else if </span><span class="s1">(it-&gt;second-&gt;unserializableValue.has_value()) {</span>
        <span class="s0">// the property has an unserializable value, so make sure that's what's</span>
        <span class="s0">// being expected.</span>
        <span class="s4">auto </span><span class="s1">actual = it-&gt;second-&gt;unserializableValue</span><span class="s4">;</span>
        <span class="s4">auto </span><span class="s1">expected = test.callArg.unserializableValue</span><span class="s4">;</span>
        <span class="s1">ASSERT_TRUE(expected.has_value()) &lt;&lt; test.propName</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(*actual</span><span class="s4">, </span><span class="s1">*expected) &lt;&lt; test.propName</span><span class="s4">;</span>
      <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
        <span class="s1">FAIL() &lt;&lt; </span><span class="s3">&quot;No value or unserializable value in &quot; </span><span class="s1">&lt;&lt; test.propName</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testConsoleLog) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var object1 = {number1: 1, bool1: false}; 
    var object2 = {number2: 2, bool2: true}; 
    console.warn('string value', object1, object2); 
 
    debugger; // Hit debugger statement so that we receive console 
              // api notification before VM gets destroyed. 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Two notifications (hitting debugger and console API call) can appear</span>
  <span class="s0">// in any order. We wait for two notifications here and later check</span>
  <span class="s0">// that both of them were hit.</span>
  <span class="s4">bool </span><span class="s1">receivedConsoleNotification = </span><span class="s4">false;</span>
  <span class="s4">bool </span><span class="s1">receivedPausedNotification = </span><span class="s4">false;</span>
  <span class="s4">for </span><span class="s1">(size_t i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; </span><span class="s5">2</span><span class="s4">; </span><span class="s1">++i) {</span>
    <span class="s1">conn.waitForNotification([&amp;receivedConsoleNotification</span><span class="s4">,</span>
                              <span class="s1">&amp;receivedPausedNotification</span><span class="s4">,</span>
                              <span class="s1">&amp;conn</span><span class="s4">,</span>
                              <span class="s1">&amp;msgId](</span><span class="s4">const </span><span class="s1">std::string &amp;str) {</span>
      <span class="s4">auto </span><span class="s1">parsedNote = folly::parseJson(str)</span><span class="s4">;</span>
      <span class="s4">auto </span><span class="s1">method = parsedNote.at(</span><span class="s3">&quot;method&quot;</span><span class="s1">).asString()</span><span class="s4">;</span>
      <span class="s4">if </span><span class="s1">(method == </span><span class="s3">&quot;Runtime.consoleAPICalled&quot;</span><span class="s1">) {</span>
        <span class="s1">receivedConsoleNotification = </span><span class="s4">true;</span>
        <span class="s4">auto </span><span class="s1">note = m::runtime::ConsoleAPICalledNotification(parsedNote)</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(note.type</span><span class="s4">, </span><span class="s3">&quot;warning&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(note.args.size()</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>

        <span class="s1">EXPECT_EQ(note.args[</span><span class="s5">0</span><span class="s1">].type</span><span class="s4">, </span><span class="s3">&quot;string&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(note.args[</span><span class="s5">0</span><span class="s1">].value</span><span class="s4">, </span><span class="s3">&quot;string value&quot;</span><span class="s1">)</span><span class="s4">;</span>

        <span class="s1">EXPECT_EQ(note.args[</span><span class="s5">1</span><span class="s1">].type</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">expectProps(</span>
            <span class="s1">conn</span><span class="s4">,</span>
            <span class="s1">msgId++</span><span class="s4">,</span>
            <span class="s1">note.args[</span><span class="s5">1</span><span class="s1">].objectId.value()</span><span class="s4">,</span>
            <span class="s1">{{</span><span class="s3">&quot;number1&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">1</span><span class="s1">)}</span><span class="s4">,</span>
             <span class="s1">{</span><span class="s3">&quot;bool1&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;boolean&quot;</span><span class="s1">).setValue(</span><span class="s4">false</span><span class="s1">)}</span><span class="s4">,</span>
             <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>

        <span class="s1">EXPECT_EQ(note.args[</span><span class="s5">2</span><span class="s1">].type</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">expectProps(</span>
            <span class="s1">conn</span><span class="s4">,</span>
            <span class="s1">msgId++</span><span class="s4">,</span>
            <span class="s1">note.args[</span><span class="s5">2</span><span class="s1">].objectId.value()</span><span class="s4">,</span>
            <span class="s1">{{</span><span class="s3">&quot;number2&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;number&quot;</span><span class="s1">).setValue(</span><span class="s5">2</span><span class="s1">)}</span><span class="s4">,</span>
             <span class="s1">{</span><span class="s3">&quot;bool2&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;boolean&quot;</span><span class="s1">).setValue(</span><span class="s4">true</span><span class="s1">)}</span><span class="s4">,</span>
             <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>
      <span class="s1">} </span><span class="s4">else if </span><span class="s1">(method == </span><span class="s3">&quot;Debugger.paused&quot;</span><span class="s1">) {</span>
        <span class="s1">receivedPausedNotification = </span><span class="s4">true;</span>
        <span class="s4">auto </span><span class="s1">note = m::debugger::PausedNotification(parsedNote)</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(note.reason</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(note.callFrames.size()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(note.callFrames[</span><span class="s5">0</span><span class="s1">].functionName</span><span class="s4">, </span><span class="s3">&quot;global&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">EXPECT_EQ(note.callFrames[</span><span class="s5">0</span><span class="s1">].location.lineNumber</span><span class="s4">, </span><span class="s5">5</span><span class="s1">)</span><span class="s4">;</span>
      <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
        <span class="s4">throw </span><span class="s1">UnexpectedNotificationException()</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">})</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">EXPECT_TRUE(receivedConsoleNotification)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(receivedPausedNotification)</span><span class="s4">;</span>

  <span class="s0">// Resume and expect no further notifications</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">expectNothing(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testThisObject) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">var globalString = &quot;global-string&quot;; 
 
    var object = { 
      someVar: &quot;object var&quot;, 
      foo: function() { 
        var localString = &quot;local-string&quot;; 
        debugger; // [1] (line 7) hit debugger statement. 
      } 
    } 
 
    object.foo(); // (line 11) 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] (line 1) hit debugger statement</span>
  <span class="s4">auto </span><span class="s1">pausedNote =</span>
      <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">7</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">11</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// [2] inspect first call frame (foo)</span>
  <span class="s4">auto </span><span class="s1">localThisObj = pausedNote.callFrames.at(</span><span class="s5">0</span><span class="s1">).thisObj</span><span class="s4">;</span>
  <span class="s1">expectProps(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s1">msgId++</span><span class="s4">,</span>
      <span class="s1">localThisObj.objectId.value()</span><span class="s4">,</span>
      <span class="s1">{{</span><span class="s3">&quot;someVar&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;string&quot;</span><span class="s1">).setValue(</span><span class="s3">&quot;object var&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;function&quot;</span><span class="s1">)}</span><span class="s4">,</span>
       <span class="s1">{</span><span class="s3">&quot;__proto__&quot;</span><span class="s4">, </span><span class="s1">PropInfo(</span><span class="s3">&quot;object&quot;</span><span class="s1">)}})</span><span class="s4">;</span>

  <span class="s0">// [3] inspect second call frame (global)</span>
  <span class="s0">// Global scope can contain more properties than we have defined</span>
  <span class="s0">// in our test code and we can't use expectProps() method here.</span>
  <span class="s0">// As a workaround we create a Map of properties and check that</span>
  <span class="s0">// those global properties that we have defined are in the map.</span>
  <span class="s4">auto </span><span class="s1">globalThisObj = pausedNote.callFrames.at(</span><span class="s5">1</span><span class="s1">).thisObj</span><span class="s4">;</span>
  <span class="s1">m::runtime::GetPropertiesRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.objectId = globalThisObj.objectId.value()</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">resp = expectResponse&lt;m::runtime::GetPropertiesResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>
  <span class="s1">std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">std::optional&lt;m::runtime::RemoteObject&gt;&gt;</span>
      <span class="s1">properties</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s4">auto </span><span class="s1">propertyDescriptor : resp.result) {</span>
    <span class="s1">properties[propertyDescriptor.name] = propertyDescriptor.value</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// globalString should be of type &quot;string&quot; and have value &quot;global-string&quot;.</span>
  <span class="s1">EXPECT_EQ(properties.count(</span><span class="s3">&quot;globalString&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(properties[</span><span class="s3">&quot;globalString&quot;</span><span class="s1">].has_value())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(properties[</span><span class="s3">&quot;globalString&quot;</span><span class="s1">].value().type</span><span class="s4">, </span><span class="s3">&quot;string&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(properties[</span><span class="s3">&quot;globalString&quot;</span><span class="s1">].value().value.value()</span><span class="s4">, </span><span class="s3">&quot;global-string&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// [4] resume</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetBreakpointsMultipleScripts) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">std::string url1 = </span><span class="s3">&quot;first-url&quot;</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function foo1() { 
      var somevar1 = 111; // (line 2) hit breakpoint 
      var somevar2 = 222; 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s1">url1)</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scriptParsed1 =</span>
      <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">std::string url2 = </span><span class="s3">&quot;second-url&quot;</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function foo2() { 
      var somevar3 = 333; 
      var somevar4 = 444; // (line 3) hit breakpoint 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s1">url2)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scriptParsed2 =</span>
      <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// In the third script we will set breakpoint (on debugger statement)</span>
  <span class="s0">// and call both functions (script url doesn't matter).</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger; // [1] (line 1) set breakpoints in both files 
    foo1(); 
    foo2(); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scriptParsed3 =</span>
      <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] hit debugger statement</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Set breakpoint on line 2 in the first script and line 3 in the second</span>
  <span class="s0">// script.</span>
  <span class="s1">m::debugger::SetBreakpointByUrlRequest req1</span><span class="s4">;</span>
  <span class="s1">req1.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req1.lineNumber = </span><span class="s5">2</span><span class="s4">;</span>
  <span class="s1">req1.url = url1</span><span class="s4">;</span>
  <span class="s1">conn.send(req1.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req1.id</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetBreakpointByUrlRequest req2</span><span class="s4">;</span>
  <span class="s1">req2.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req2.lineNumber = </span><span class="s5">3</span><span class="s4">;</span>
  <span class="s1">req2.url = url2</span><span class="s4">;</span>
  <span class="s1">conn.send(req2.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req2.id</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Resume and check that we hit correct breakpoints.</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// First we should stop on line 2 of the first script.</span>
  <span class="s1">expectPaused(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s3">&quot;other&quot;</span><span class="s4">,</span>
      <span class="s1">{FrameInfo(</span><span class="s3">&quot;foo1&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).setScriptId(scriptParsed1.scriptId)</span><span class="s4">,</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">).setScriptId(scriptParsed3.scriptId)})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Next we should stop on line 3 of the second script.</span>
  <span class="s1">expectPaused(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s3">&quot;other&quot;</span><span class="s4">,</span>
      <span class="s1">{FrameInfo(</span><span class="s3">&quot;foo2&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).setScriptId(scriptParsed2.scriptId)</span><span class="s4">,</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s1">).setScriptId(scriptParsed3.scriptId)})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testSetBreakpointByUrlRegex) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">std::string url1 = </span><span class="s3">&quot;https://www.example.com/123456&quot;</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function foo1() { 
      var somevar1 = 111; // (line 2) hit breakpoint 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s1">url1)</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scriptParsed1 =</span>
      <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">std::string url2 = </span><span class="s3">&quot;https://www.example.com/abcdefg&quot;</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">function foo2() { 
      var aaa = 'bbb'; 
      var somevar2 = 222; // (line 3) hit breakpoint 
    } 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s1">url2)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scriptParsed2 =</span>
      <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// In the third script we will set breakpoint (on debugger statement)</span>
  <span class="s0">// and call both functions (script url doesn't matter).</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">debugger; // [1] (line 1) set breakpoints in both files 
    foo1(); 
    foo2(); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">scriptParsed3 =</span>
      <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// [1] hit debugger statement</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Set breakpoint on line 2 of URL matching &quot;www\.example\.com\/[\d]+&quot;</span>
  <span class="s0">// (should match url1).</span>
  <span class="s1">m::debugger::SetBreakpointByUrlRequest req1</span><span class="s4">;</span>
  <span class="s1">req1.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req1.lineNumber = </span><span class="s5">2</span><span class="s4">;</span>
  <span class="s1">req1.urlRegex = </span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">https://www\.example\.com\/[\d]+</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(req1.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req1.id</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Set breakpoint on line 3 of URL matching &quot;www\.example\.com\/[a-zA-z]+&quot;</span>
  <span class="s0">// (should match url2).</span>
  <span class="s1">m::debugger::SetBreakpointByUrlRequest req2</span><span class="s4">;</span>
  <span class="s1">req2.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req2.lineNumber = </span><span class="s5">3</span><span class="s4">;</span>
  <span class="s1">req2.urlRegex = </span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span><span class="s3">https://www\.example\.com\/[a-zA-z]+</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(req2.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req2.id</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">3</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Resume and check that we hit correct breakpoints.</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// First we should stop on line 2 of the first script.</span>
  <span class="s1">expectPaused(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s3">&quot;other&quot;</span><span class="s4">,</span>
      <span class="s1">{FrameInfo(</span><span class="s3">&quot;foo1&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).setScriptId(scriptParsed1.scriptId)</span><span class="s4">,</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s4">, </span><span class="s5">1</span><span class="s1">).setScriptId(scriptParsed3.scriptId)})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Next we should stop on line 3 of the second script.</span>
  <span class="s1">expectPaused(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s3">&quot;other&quot;</span><span class="s4">,</span>
      <span class="s1">{FrameInfo(</span><span class="s3">&quot;foo2&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).setScriptId(scriptParsed2.scriptId)</span><span class="s4">,</span>
       <span class="s1">FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">3</span><span class="s4">, </span><span class="s5">1</span><span class="s1">).setScriptId(scriptParsed3.scriptId)})</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testColumnBreakpoint) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span>
      <span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
<span class="s3">function foo(){x=1}debugger;foo(); 
</span><span class="s4">)</span><span class="s3">&quot;</span><span class="s4">,</span>
      <span class="s3">&quot;url&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Hit debugger statement.</span>
  <span class="s1">expectPaused(conn</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s4">, </span><span class="s1">{{</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">}})</span><span class="s4">;</span>

  <span class="s0">// Set breakpoint on position 1:16 (x=1).</span>
  <span class="s1">m::debugger::SetBreakpointByUrlRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.lineNumber = </span><span class="s5">1</span><span class="s4">;</span>
  <span class="s1">req.columnNumber = </span><span class="s5">16</span><span class="s4">;</span>
  <span class="s1">req.url = </span><span class="s3">&quot;url&quot;</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s1">expectBreakpointResponse(conn</span><span class="s4">, </span><span class="s1">req.id</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Resume and except to pause on a breakpoint.</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">expectPaused(</span>
      <span class="s1">conn</span><span class="s4">,</span>
      <span class="s3">&quot;other&quot;</span><span class="s4">,</span>
      <span class="s1">{FrameInfo(</span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">).setColumnNumber(</span><span class="s5">16</span><span class="s1">)</span><span class="s4">, </span><span class="s1">FrameInfo(</span><span class="s3">&quot;global&quot;</span><span class="s4">, </span><span class="s5">1</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)})</span><span class="s4">;</span>

  <span class="s0">// Resume execution</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">canBreakOnScriptsWithSourceMap) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetInstrumentationBreakpointRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.instrumentation = </span><span class="s3">&quot;beforeScriptWithSourceMapExecution&quot;</span><span class="s4">;</span>

  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">bpId = expectResponse&lt;m::debugger::SetInstrumentationBreakpointResponse&gt;(</span>
                  <span class="s1">conn</span><span class="s4">, </span><span class="s1">req.id)</span>
                  <span class="s1">.breakpointId</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
      <span class="s3">storeValue(42); debugger; 
      //# sourceURL=http://example.com/source.js 
      //# sourceMappingURL=http://example.com/source.map 
    </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// We should get a pause before the first statement</span>
  <span class="s4">auto </span><span class="s1">note = expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">ASSERT_FALSE(asyncRuntime.hasStoredValue())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(note.reason</span><span class="s4">, </span><span class="s3">&quot;other&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">ASSERT_TRUE(note.hitBreakpoints.has_value())</span><span class="s4">;</span>
  <span class="s1">ASSERT_EQ(note.hitBreakpoints-&gt;size()</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(note.hitBreakpoints-&gt;at(</span><span class="s5">0</span><span class="s1">)</span><span class="s4">, </span><span class="s1">bpId)</span><span class="s4">;</span>

  <span class="s0">// Continue and verify that the JS code has now executed</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.awaitStoredValue().asNumber()</span><span class="s4">, </span><span class="s5">42</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Resume and exit</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">wontStopOnFilesWithoutSourceMaps) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>

  <span class="s1">m::debugger::SetInstrumentationBreakpointRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId++</span><span class="s4">;</span>
  <span class="s1">req.instrumentation = </span><span class="s3">&quot;beforeScriptWithSourceMapExecution&quot;</span><span class="s4">;</span>

  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>
  <span class="s1">expectResponse&lt;m::debugger::SetInstrumentationBreakpointResponse&gt;(</span>
      <span class="s1">conn</span><span class="s4">, </span><span class="s1">req.id)</span><span class="s4">;</span>

  <span class="s0">// This script has no source map, so it should not trigger a break</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
      <span class="s3">storeValue(42); debugger; 
      //# sourceURL=http://example.com/source.js 
    </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Continue and verify that the JS code has now executed without first</span>
  <span class="s0">// pausing on the script load.</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(asyncRuntime.awaitStoredValue().asNumber()</span><span class="s4">, </span><span class="s5">42</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Resume and exit</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">runIfWaitingForDebugger) {</span>
  <span class="s1">TestContext context(</span><span class="s4">true</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">0</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
      <span class="s3">storeValue(1); debugger; 
    </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// We should now be paused on load. Verify that we didn't run code.</span>
  <span class="s1">ASSERT_FALSE(asyncRuntime.hasStoredValue())</span><span class="s4">;</span>

  <span class="s0">// RunIfWaitingForDebugger should cause us to resume</span>
  <span class="s1">send&lt;m::runtime::RunIfWaitingForDebuggerRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// We should immediately hit the 'debugger;' statement</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">asyncRuntime.awaitStoredValue().asNumber())</span><span class="s4">;</span>

  <span class="s0">// RunIfWaitingForDebuggerResponse should be accepted but have no effect</span>
  <span class="s1">send&lt;m::runtime::RunIfWaitingForDebuggerRequest&gt;(conn</span><span class="s4">, </span><span class="s1">++msgId)</span><span class="s4">;</span>

  <span class="s0">// Do a dummy call so we can expect something other than a ResumeRequest</span>
  <span class="s1">sendRuntimeEvalRequest(conn</span><span class="s4">, </span><span class="s1">++msgId</span><span class="s4">, </span><span class="s3">&quot;true&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectEvalResponse(conn</span><span class="s4">, </span><span class="s1">msgId</span><span class="s4">, true</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Finally explicitly continue and exit</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">heapProfilerSampling) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
      <span class="s3">debugger; 
      function allocator() { 
        // Do some allocation. 
        return new Object; 
      } 
      (function main() { 
        var a = []; 
        for (var i = 0; i &lt; 100; i++) { 
          a[i] = allocator(); 
        } 
      })(); 
      debugger; 
    </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// We should get a pause before the first statement.</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">{</span>
    <span class="s1">m::heapProfiler::StartSamplingRequest req</span><span class="s4">;</span>
    <span class="s1">req.id = msgId++</span><span class="s4">;</span>
    <span class="s0">// Sample every 256 bytes to ensure there are some samples. The default is</span>
    <span class="s0">// 32768, which is too high for a small example. Note that sampling is a</span>
    <span class="s0">// random process, so there's no guarantee there will be any samples in</span>
    <span class="s0">// any finite number of allocations. In practice the likelihood is so high</span>
    <span class="s0">// that there shouldn't be any issues.</span>
    <span class="s1">req.samplingInterval = </span><span class="s5">256</span><span class="s4">;</span>
    <span class="s1">send(conn</span><span class="s4">, </span><span class="s1">req)</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s0">// Resume, run the allocations, and once it's paused again, stop them.</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s0">// Send the stop sampling request, expect the value coming back to be JSON.</span>
  <span class="s4">auto </span><span class="s1">resp = send&lt;</span>
      <span class="s1">m::heapProfiler::StopSamplingRequest</span><span class="s4">,</span>
      <span class="s1">m::heapProfiler::StopSamplingResponse&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s0">// Make sure there were some samples.</span>
  <span class="s1">EXPECT_NE(resp.profile.samples.size()</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s0">// Don't test the content of the JSON, that is tested via the</span>
  <span class="s0">// SamplingHeapProfilerTest.</span>

  <span class="s0">// Resume and exit</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">heapSnapshotRemoteObject) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">std::shared_ptr&lt;HermesRuntime&gt; runtime = asyncRuntime.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">storeValue([1, 2, 3]); 
    debugger; 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// We should get a pause before the first statement.</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">{</span>
    <span class="s0">// Take a heap snapshot first to assign IDs.</span>
    <span class="s1">m::heapProfiler::TakeHeapSnapshotRequest req</span><span class="s4">;</span>
    <span class="s1">req.id = msgId++</span><span class="s4">;</span>
    <span class="s1">req.reportProgress = </span><span class="s4">false;</span>
    <span class="s0">// We don't need the response because we can directly query for object IDs</span>
    <span class="s0">// from the runtime.</span>
    <span class="s1">send(conn</span><span class="s4">, </span><span class="s1">req)</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">const </span><span class="s1">uint64_t globalObjID = runtime-&gt;getUniqueID(runtime-&gt;global())</span><span class="s4">;</span>
  <span class="s1">jsi::Value storedValue = asyncRuntime.awaitStoredValue()</span><span class="s4">;</span>
  <span class="s4">const </span><span class="s1">uint64_t storedObjID =</span>
      <span class="s1">runtime-&gt;getUniqueID(storedValue.asObject(*runtime))</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">testObject = [&amp;msgId</span><span class="s4">, </span><span class="s1">&amp;conn](</span>
                        <span class="s1">uint64_t objID</span><span class="s4">,</span>
                        <span class="s4">const char </span><span class="s1">*type</span><span class="s4">,</span>
                        <span class="s4">const char </span><span class="s1">*className</span><span class="s4">,</span>
                        <span class="s4">const char </span><span class="s1">*description</span><span class="s4">,</span>
                        <span class="s4">const char </span><span class="s1">*subtype) {</span>
    <span class="s0">// Get the object by its snapshot ID.</span>
    <span class="s1">m::heapProfiler::GetObjectByHeapObjectIdRequest req</span><span class="s4">;</span>
    <span class="s1">req.id = msgId++</span><span class="s4">;</span>
    <span class="s1">req.objectId = std::to_string(objID)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">resp = send&lt;</span>
        <span class="s1">m::heapProfiler::GetObjectByHeapObjectIdRequest</span><span class="s4">,</span>
        <span class="s1">m::heapProfiler::GetObjectByHeapObjectIdResponse&gt;(conn</span><span class="s4">, </span><span class="s1">req)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(resp.result.type</span><span class="s4">, </span><span class="s1">type)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(resp.result.className</span><span class="s4">, </span><span class="s1">className)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(resp.result.description</span><span class="s4">, </span><span class="s1">description)</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(subtype) {</span>
      <span class="s1">EXPECT_EQ(resp.result.subtype</span><span class="s4">, </span><span class="s1">subtype)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s0">// Check that fetching the object by heap snapshot ID works.</span>
    <span class="s1">m::heapProfiler::GetHeapObjectIdRequest idReq</span><span class="s4">;</span>
    <span class="s1">idReq.id = msgId++</span><span class="s4">;</span>
    <span class="s1">idReq.objectId = resp.result.objectId.value()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">idResp = send&lt;</span>
        <span class="s1">m::heapProfiler::GetHeapObjectIdRequest</span><span class="s4">,</span>
        <span class="s1">m::heapProfiler::GetHeapObjectIdResponse&gt;(conn</span><span class="s4">, </span><span class="s1">idReq)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(atoi(idResp.heapSnapshotObjectId.c_str())</span><span class="s4">, </span><span class="s1">objID)</span><span class="s4">;</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s0">// Test once before a collection.</span>
  <span class="s1">testObject(globalObjID</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s4">, </span><span class="s3">&quot;Object&quot;</span><span class="s4">, </span><span class="s3">&quot;Object&quot;</span><span class="s4">, nullptr</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">testObject(storedObjID</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s4">, </span><span class="s3">&quot;Array&quot;</span><span class="s4">, </span><span class="s3">&quot;Array(3)&quot;</span><span class="s4">, </span><span class="s3">&quot;array&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s0">// Force a collection to move the heap.</span>
  <span class="s1">runtime-&gt;instrumentation().collectGarbage(</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s0">// A collection should not disturb the unique ID lookup, and it should be</span>
  <span class="s0">// the same object as before. Note that it won't have the same remote ID,</span>
  <span class="s0">// because Hermes doesn't do uniquing.</span>
  <span class="s1">testObject(globalObjID</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s4">, </span><span class="s3">&quot;Object&quot;</span><span class="s4">, </span><span class="s3">&quot;Object&quot;</span><span class="s4">, nullptr</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">testObject(storedObjID</span><span class="s4">, </span><span class="s3">&quot;object&quot;</span><span class="s4">, </span><span class="s3">&quot;Array&quot;</span><span class="s4">, </span><span class="s3">&quot;Array(3)&quot;</span><span class="s4">, </span><span class="s3">&quot;array&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// Resume and exit.</span>
  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testBasicProfilerOperation) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SamplingProfilerRAII spRegistration(asyncRuntime)</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>

  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
      <span class="s3">while(!shouldStop()); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s0">// Start the sampling profiler. At this point it is not safe to manipulate the</span>
  <span class="s0">// VM, so...</span>
  <span class="s1">send&lt;m::profiler::StartRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>

  <span class="s0">// Disable the debugger.</span>
  <span class="s1">send&lt;m::debugger::DisableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>

  <span class="s0">// Keep the profiler running for a small amount of time to allow for some</span>
  <span class="s0">// samples to be collected.</span>
  <span class="s1">std::this_thread::sleep_for(</span><span class="s5">500</span><span class="s1">ms)</span><span class="s4">;</span>

  <span class="s0">// Finally, re-enable the debugger in order to stop profiling.</span>
  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>

  <span class="s0">// Being re-attached to the VM, send the stop sampling profile request.</span>
  <span class="s1">{</span>
    <span class="s4">auto </span><span class="s1">resp = send&lt;m::profiler::StopRequest</span><span class="s4">, </span><span class="s1">m::profiler::StopResponse&gt;(</span>
        <span class="s1">conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>

    <span class="s4">const </span><span class="s1">m::profiler::Profile &amp;profile = resp.profile</span><span class="s4">;</span>
    <span class="s1">EXPECT_GT(profile.nodes.size()</span><span class="s4">, </span><span class="s5">0</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_LT(profile.startTime</span><span class="s4">, </span><span class="s1">profile.endTime)</span><span class="s4">;</span>
    <span class="s1">ASSERT_TRUE(profile.samples)</span><span class="s4">;</span>
    <span class="s1">EXPECT_FALSE(profile.samples-&gt;empty())</span><span class="s4">;</span>
    <span class="s1">ASSERT_TRUE(profile.timeDeltas)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(profile.samples-&gt;size()</span><span class="s4">, </span><span class="s1">profile.timeDeltas-&gt;size())</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">asyncRuntime.stop()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST(ConnectionTests</span><span class="s4">, </span><span class="s1">testGlobalLexicalScopeNames) {</span>
  <span class="s1">TestContext context</span><span class="s4">;</span>
  <span class="s1">AsyncHermesRuntime &amp;asyncRuntime = context.runtime()</span><span class="s4">;</span>
  <span class="s1">SyncConnection &amp;conn = context.conn()</span><span class="s4">;</span>
  <span class="s4">int </span><span class="s1">msgId = </span><span class="s5">1</span><span class="s4">;</span>
  <span class="s1">asyncRuntime.executeScriptAsync(</span><span class="s4">R</span><span class="s3">&quot;</span><span class="s4">(</span>
    <span class="s3">let globalLet = &quot;let&quot;; 
    const globalConst = &quot;const&quot;; 
    var globalVar = &quot;var&quot;; 
 
    let func1 = () =&gt; { 
      let local1 = 111; 
      func2(); 
    } 
 
    function func2() { 
      let func3 = () =&gt; { 
        let local3 = 333; 
        debugger; 
      } 
 
      let local2 = 222; 
      func3(); 
    } 
 
    func1(); 
  </span><span class="s4">)</span><span class="s3">&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">send&lt;m::debugger::EnableRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectExecutionContextCreated(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ScriptParsedNotification&gt;(conn)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::PausedNotification&gt;(conn)</span><span class="s4">;</span>

  <span class="s1">m::runtime::GlobalLexicalScopeNamesRequest req</span><span class="s4">;</span>
  <span class="s1">req.id = msgId</span><span class="s4">;</span>
  <span class="s1">req.executionContextId = </span><span class="s5">1</span><span class="s4">;</span>
  <span class="s1">conn.send(req.toJson())</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">resp =</span>
      <span class="s1">expectResponse&lt;m::runtime::GlobalLexicalScopeNamesResponse&gt;(conn</span><span class="s4">, </span><span class="s1">msgId)</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.id</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">std::sort(resp.names.begin()</span><span class="s4">, </span><span class="s1">resp.names.end())</span><span class="s4">;</span>
  <span class="s1">std::vector&lt;std::string&gt; expectedNames{</span><span class="s3">&quot;func1&quot;</span><span class="s4">, </span><span class="s3">&quot;globalConst&quot;</span><span class="s4">, </span><span class="s3">&quot;globalLet&quot;</span><span class="s1">}</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(resp.names</span><span class="s4">, </span><span class="s1">expectedNames)</span><span class="s4">;</span>

  <span class="s1">send&lt;m::debugger::ResumeRequest&gt;(conn</span><span class="s4">, </span><span class="s1">msgId++)</span><span class="s4">;</span>
  <span class="s1">expectNotification&lt;m::debugger::ResumedNotification&gt;(conn)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">} </span><span class="s0">// namespace chrome</span>
<span class="s1">} </span><span class="s0">// namespace inspector</span>
<span class="s1">} </span><span class="s0">// namespace hermes</span>
<span class="s1">} </span><span class="s0">// namespace facebook</span>
</pre>
</body>
</html>