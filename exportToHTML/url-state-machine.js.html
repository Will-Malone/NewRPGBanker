<html>
<head>
<title>url-state-machine.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #6a8759;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #cc7832;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
url-state-machine.js</font>
</center></td></tr></table>
<pre><span class="s0">&quot;use strict&quot;</span><span class="s1">;</span>
<span class="s1">const punycode = require(</span><span class="s0">&quot;punycode&quot;</span><span class="s1">);</span>
<span class="s1">const tr46 = require(</span><span class="s0">&quot;tr46&quot;</span><span class="s1">);</span>

<span class="s1">const specialSchemes = {</span>
  <span class="s1">ftp: </span><span class="s2">21</span><span class="s1">,</span>
  <span class="s1">file: </span><span class="s3">null</span><span class="s1">,</span>
  <span class="s1">gopher: </span><span class="s2">70</span><span class="s1">,</span>
  <span class="s1">http: </span><span class="s2">80</span><span class="s1">,</span>
  <span class="s1">https: </span><span class="s2">443</span><span class="s1">,</span>
  <span class="s1">ws: </span><span class="s2">80</span><span class="s1">,</span>
  <span class="s1">wss: </span><span class="s2">443</span>
<span class="s1">};</span>

<span class="s1">const failure = Symbol(</span><span class="s0">&quot;failure&quot;</span><span class="s1">);</span>

<span class="s3">function </span><span class="s1">countSymbols(str) {</span>
  <span class="s3">return </span><span class="s1">punycode.ucs2.decode(str).length;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">at(input, idx) {</span>
  <span class="s1">const c = input[idx];</span>
  <span class="s3">return </span><span class="s1">isNaN(c) ? undefined : String.fromCodePoint(c);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isASCIIDigit(c) {</span>
  <span class="s3">return </span><span class="s1">c &gt;= </span><span class="s2">0</span><span class="s1">x30 &amp;&amp; c &lt;= </span><span class="s2">0</span><span class="s1">x39;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isASCIIAlpha(c) {</span>
  <span class="s3">return </span><span class="s1">(c &gt;= </span><span class="s2">0</span><span class="s1">x41 &amp;&amp; c &lt;= </span><span class="s2">0</span><span class="s1">x5A) || (c &gt;= </span><span class="s2">0</span><span class="s1">x61 &amp;&amp; c &lt;= </span><span class="s2">0</span><span class="s1">x7A);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isASCIIAlphanumeric(c) {</span>
  <span class="s3">return </span><span class="s1">isASCIIAlpha(c) || isASCIIDigit(c);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isASCIIHex(c) {</span>
  <span class="s3">return </span><span class="s1">isASCIIDigit(c) || (c &gt;= </span><span class="s2">0</span><span class="s1">x41 &amp;&amp; c &lt;= </span><span class="s2">0</span><span class="s1">x46) || (c &gt;= </span><span class="s2">0</span><span class="s1">x61 &amp;&amp; c &lt;= </span><span class="s2">0</span><span class="s1">x66);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isSingleDot(buffer) {</span>
  <span class="s3">return </span><span class="s1">buffer === </span><span class="s0">&quot;.&quot; </span><span class="s1">|| buffer.toLowerCase() === </span><span class="s0">&quot;%2e&quot;</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isDoubleDot(buffer) {</span>
  <span class="s1">buffer = buffer.toLowerCase();</span>
  <span class="s3">return </span><span class="s1">buffer === </span><span class="s0">&quot;..&quot; </span><span class="s1">|| buffer === </span><span class="s0">&quot;%2e.&quot; </span><span class="s1">|| buffer === </span><span class="s0">&quot;.%2e&quot; </span><span class="s1">|| buffer === </span><span class="s0">&quot;%2e%2e&quot;</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isWindowsDriveLetterCodePoints(cp1, cp2) {</span>
  <span class="s3">return </span><span class="s1">isASCIIAlpha(cp1) &amp;&amp; (cp2 === </span><span class="s2">58 </span><span class="s1">|| cp2 === </span><span class="s2">124</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isWindowsDriveLetterString(string) {</span>
  <span class="s3">return </span><span class="s1">string.length === </span><span class="s2">2 </span><span class="s1">&amp;&amp; isASCIIAlpha(string.codePointAt(</span><span class="s2">0</span><span class="s1">)) &amp;&amp; (string[</span><span class="s2">1</span><span class="s1">] === </span><span class="s0">&quot;:&quot; </span><span class="s1">|| string[</span><span class="s2">1</span><span class="s1">] === </span><span class="s0">&quot;|&quot;</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isNormalizedWindowsDriveLetterString(string) {</span>
  <span class="s3">return </span><span class="s1">string.length === </span><span class="s2">2 </span><span class="s1">&amp;&amp; isASCIIAlpha(string.codePointAt(</span><span class="s2">0</span><span class="s1">)) &amp;&amp; string[</span><span class="s2">1</span><span class="s1">] === </span><span class="s0">&quot;:&quot;</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">containsForbiddenHostCodePoint(string) {</span>
  <span class="s3">return </span><span class="s1">string.search(/\u0000|\u0009|\u000A|\u000D|\u0020|#|%|\/|:|\?|@|\[|\\|\]/) !== -</span><span class="s2">1</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">containsForbiddenHostCodePointExcludingPercent(string) {</span>
  <span class="s3">return </span><span class="s1">string.search(/\u0000|\u0009|\u000A|\u000D|\u0020|#|\/|:|\?|@|\[|\\|\]/) !== -</span><span class="s2">1</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isSpecialScheme(scheme) {</span>
  <span class="s3">return </span><span class="s1">specialSchemes[scheme] !== undefined;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isSpecial(url) {</span>
  <span class="s3">return </span><span class="s1">isSpecialScheme(url.scheme);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">defaultPort(scheme) {</span>
  <span class="s3">return </span><span class="s1">specialSchemes[scheme];</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">percentEncode(c) {</span>
  <span class="s1">let hex = c.toString(</span><span class="s2">16</span><span class="s1">).toUpperCase();</span>
  <span class="s3">if </span><span class="s1">(hex.length === </span><span class="s2">1</span><span class="s1">) {</span>
    <span class="s1">hex = </span><span class="s0">&quot;0&quot; </span><span class="s1">+ hex;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s0">&quot;%&quot; </span><span class="s1">+ hex;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">utf8PercentEncode(c) {</span>
  <span class="s1">const buf = </span><span class="s3">new </span><span class="s1">Buffer(c);</span>

  <span class="s1">let str = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; buf.length; ++i) {</span>
    <span class="s1">str += percentEncode(buf[i]);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">str;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">utf8PercentDecode(str) {</span>
  <span class="s1">const input = </span><span class="s3">new </span><span class="s1">Buffer(str);</span>
  <span class="s1">const output = [];</span>
  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; input.length; ++i) {</span>
    <span class="s3">if </span><span class="s1">(input[i] !== </span><span class="s2">37</span><span class="s1">) {</span>
      <span class="s1">output.push(input[i]);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(input[i] === </span><span class="s2">37 </span><span class="s1">&amp;&amp; isASCIIHex(input[i + </span><span class="s2">1</span><span class="s1">]) &amp;&amp; isASCIIHex(input[i + </span><span class="s2">2</span><span class="s1">])) {</span>
      <span class="s1">output.push(parseInt(input.slice(i + </span><span class="s2">1</span><span class="s1">, i + </span><span class="s2">3</span><span class="s1">).toString(), </span><span class="s2">16</span><span class="s1">));</span>
      <span class="s1">i += </span><span class="s2">2</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s1">output.push(input[i]);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s3">return new </span><span class="s1">Buffer(output).toString();</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isC0ControlPercentEncode(c) {</span>
  <span class="s3">return </span><span class="s1">c &lt;= </span><span class="s2">0</span><span class="s1">x1F || c &gt; </span><span class="s2">0</span><span class="s1">x7E;</span>
<span class="s1">}</span>

<span class="s1">const extraPathPercentEncodeSet = </span><span class="s3">new </span><span class="s1">Set([</span><span class="s2">32</span><span class="s1">, </span><span class="s2">34</span><span class="s1">, </span><span class="s2">35</span><span class="s1">, </span><span class="s2">60</span><span class="s1">, </span><span class="s2">62</span><span class="s1">, </span><span class="s2">63</span><span class="s1">, </span><span class="s2">96</span><span class="s1">, </span><span class="s2">123</span><span class="s1">, </span><span class="s2">125</span><span class="s1">]);</span>
<span class="s3">function </span><span class="s1">isPathPercentEncode(c) {</span>
  <span class="s3">return </span><span class="s1">isC0ControlPercentEncode(c) || extraPathPercentEncodeSet.has(c);</span>
<span class="s1">}</span>

<span class="s1">const extraUserinfoPercentEncodeSet =</span>
  <span class="s3">new </span><span class="s1">Set([</span><span class="s2">47</span><span class="s1">, </span><span class="s2">58</span><span class="s1">, </span><span class="s2">59</span><span class="s1">, </span><span class="s2">61</span><span class="s1">, </span><span class="s2">64</span><span class="s1">, </span><span class="s2">91</span><span class="s1">, </span><span class="s2">92</span><span class="s1">, </span><span class="s2">93</span><span class="s1">, </span><span class="s2">94</span><span class="s1">, </span><span class="s2">124</span><span class="s1">]);</span>
<span class="s3">function </span><span class="s1">isUserinfoPercentEncode(c) {</span>
  <span class="s3">return </span><span class="s1">isPathPercentEncode(c) || extraUserinfoPercentEncodeSet.has(c);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">percentEncodeChar(c, encodeSetPredicate) {</span>
  <span class="s1">const cStr = String.fromCodePoint(c);</span>

  <span class="s3">if </span><span class="s1">(encodeSetPredicate(c)) {</span>
    <span class="s3">return </span><span class="s1">utf8PercentEncode(cStr);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">cStr;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">parseIPv4Number(input) {</span>
  <span class="s1">let R = </span><span class="s2">10</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(input.length &gt;= </span><span class="s2">2 </span><span class="s1">&amp;&amp; input.charAt(</span><span class="s2">0</span><span class="s1">) === </span><span class="s0">&quot;0&quot; </span><span class="s1">&amp;&amp; input.charAt(</span><span class="s2">1</span><span class="s1">).toLowerCase() === </span><span class="s0">&quot;x&quot;</span><span class="s1">) {</span>
    <span class="s1">input = input.substring(</span><span class="s2">2</span><span class="s1">);</span>
    <span class="s1">R = </span><span class="s2">16</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(input.length &gt;= </span><span class="s2">2 </span><span class="s1">&amp;&amp; input.charAt(</span><span class="s2">0</span><span class="s1">) === </span><span class="s0">&quot;0&quot;</span><span class="s1">) {</span>
    <span class="s1">input = input.substring(</span><span class="s2">1</span><span class="s1">);</span>
    <span class="s1">R = </span><span class="s2">8</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(input === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s2">0</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">const regex = R === </span><span class="s2">10 </span><span class="s1">? /[^</span><span class="s2">0</span><span class="s1">-</span><span class="s2">9</span><span class="s1">]/ : (R === </span><span class="s2">16 </span><span class="s1">? /[^</span><span class="s2">0</span><span class="s1">-</span><span class="s2">9</span><span class="s1">A-Fa-f]/ : /[^</span><span class="s2">0</span><span class="s1">-</span><span class="s2">7</span><span class="s1">]/);</span>
  <span class="s3">if </span><span class="s1">(regex.test(input)) {</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">parseInt(input, R);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">parseIPv4(input) {</span>
  <span class="s1">const parts = input.split(</span><span class="s0">&quot;.&quot;</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(parts[parts.length - </span><span class="s2">1</span><span class="s1">] === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(parts.length &gt; </span><span class="s2">1</span><span class="s1">) {</span>
      <span class="s1">parts.pop();</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(parts.length &gt; </span><span class="s2">4</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">input;</span>
  <span class="s1">}</span>

  <span class="s1">const numbers = [];</span>
  <span class="s3">for </span><span class="s1">(const part of parts) {</span>
    <span class="s3">if </span><span class="s1">(part === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">input;</span>
    <span class="s1">}</span>
    <span class="s1">const n = parseIPv4Number(part);</span>
    <span class="s3">if </span><span class="s1">(n === failure) {</span>
      <span class="s3">return </span><span class="s1">input;</span>
    <span class="s1">}</span>

    <span class="s1">numbers.push(n);</span>
  <span class="s1">}</span>

  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; numbers.length - </span><span class="s2">1</span><span class="s1">; ++i) {</span>
    <span class="s3">if </span><span class="s1">(numbers[i] &gt; </span><span class="s2">255</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(numbers[numbers.length - </span><span class="s2">1</span><span class="s1">] &gt;= Math.pow(</span><span class="s2">256</span><span class="s1">, </span><span class="s2">5 </span><span class="s1">- numbers.length)) {</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s1">let ipv4 = numbers.pop();</span>
  <span class="s1">let counter = </span><span class="s2">0</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(const n of numbers) {</span>
    <span class="s1">ipv4 += n * Math.pow(</span><span class="s2">256</span><span class="s1">, </span><span class="s2">3 </span><span class="s1">- counter);</span>
    <span class="s1">++counter;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">ipv4;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">serializeIPv4(address) {</span>
  <span class="s1">let output = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">let n = address;</span>

  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">1</span><span class="s1">; i &lt;= </span><span class="s2">4</span><span class="s1">; ++i) {</span>
    <span class="s1">output = String(n % </span><span class="s2">256</span><span class="s1">) + output;</span>
    <span class="s3">if </span><span class="s1">(i !== </span><span class="s2">4</span><span class="s1">) {</span>
      <span class="s1">output = </span><span class="s0">&quot;.&quot; </span><span class="s1">+ output;</span>
    <span class="s1">}</span>
    <span class="s1">n = Math.floor(n / </span><span class="s2">256</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">output;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">parseIPv6(input) {</span>
  <span class="s1">const address = [</span><span class="s2">0</span><span class="s1">, </span><span class="s2">0</span><span class="s1">, </span><span class="s2">0</span><span class="s1">, </span><span class="s2">0</span><span class="s1">, </span><span class="s2">0</span><span class="s1">, </span><span class="s2">0</span><span class="s1">, </span><span class="s2">0</span><span class="s1">, </span><span class="s2">0</span><span class="s1">];</span>
  <span class="s1">let pieceIndex = </span><span class="s2">0</span><span class="s1">;</span>
  <span class="s1">let compress = </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">let pointer = </span><span class="s2">0</span><span class="s1">;</span>

  <span class="s1">input = punycode.ucs2.decode(input);</span>

  <span class="s3">if </span><span class="s1">(input[pointer] === </span><span class="s2">58</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(input[pointer + </span><span class="s2">1</span><span class="s1">] !== </span><span class="s2">58</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>

    <span class="s1">pointer += </span><span class="s2">2</span><span class="s1">;</span>
    <span class="s1">++pieceIndex;</span>
    <span class="s1">compress = pieceIndex;</span>
  <span class="s1">}</span>

  <span class="s3">while </span><span class="s1">(pointer &lt; input.length) {</span>
    <span class="s3">if </span><span class="s1">(pieceIndex === </span><span class="s2">8</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(input[pointer] === </span><span class="s2">58</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(compress !== </span><span class="s3">null</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s1">failure;</span>
      <span class="s1">}</span>
      <span class="s1">++pointer;</span>
      <span class="s1">++pieceIndex;</span>
      <span class="s1">compress = pieceIndex;</span>
      <span class="s3">continue</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s1">let value = </span><span class="s2">0</span><span class="s1">;</span>
    <span class="s1">let length = </span><span class="s2">0</span><span class="s1">;</span>

    <span class="s3">while </span><span class="s1">(length &lt; </span><span class="s2">4 </span><span class="s1">&amp;&amp; isASCIIHex(input[pointer])) {</span>
      <span class="s1">value = value * </span><span class="s2">0</span><span class="s1">x10 + parseInt(at(input, pointer), </span><span class="s2">16</span><span class="s1">);</span>
      <span class="s1">++pointer;</span>
      <span class="s1">++length;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(input[pointer] === </span><span class="s2">46</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(length === </span><span class="s2">0</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s1">failure;</span>
      <span class="s1">}</span>

      <span class="s1">pointer -= length;</span>

      <span class="s3">if </span><span class="s1">(pieceIndex &gt; </span><span class="s2">6</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s1">failure;</span>
      <span class="s1">}</span>

      <span class="s1">let numbersSeen = </span><span class="s2">0</span><span class="s1">;</span>

      <span class="s3">while </span><span class="s1">(input[pointer] !== undefined) {</span>
        <span class="s1">let ipv4Piece = </span><span class="s3">null</span><span class="s1">;</span>

        <span class="s3">if </span><span class="s1">(numbersSeen &gt; </span><span class="s2">0</span><span class="s1">) {</span>
          <span class="s3">if </span><span class="s1">(input[pointer] === </span><span class="s2">46 </span><span class="s1">&amp;&amp; numbersSeen &lt; </span><span class="s2">4</span><span class="s1">) {</span>
            <span class="s1">++pointer;</span>
          <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s3">return </span><span class="s1">failure;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s3">if </span><span class="s1">(!isASCIIDigit(input[pointer])) {</span>
          <span class="s3">return </span><span class="s1">failure;</span>
        <span class="s1">}</span>

        <span class="s3">while </span><span class="s1">(isASCIIDigit(input[pointer])) {</span>
          <span class="s1">const number = parseInt(at(input, pointer));</span>
          <span class="s3">if </span><span class="s1">(ipv4Piece === </span><span class="s3">null</span><span class="s1">) {</span>
            <span class="s1">ipv4Piece = number;</span>
          <span class="s1">} </span><span class="s3">else if </span><span class="s1">(ipv4Piece === </span><span class="s2">0</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">failure;</span>
          <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
            <span class="s1">ipv4Piece = ipv4Piece * </span><span class="s2">10 </span><span class="s1">+ number;</span>
          <span class="s1">}</span>
          <span class="s3">if </span><span class="s1">(ipv4Piece &gt; </span><span class="s2">255</span><span class="s1">) {</span>
            <span class="s3">return </span><span class="s1">failure;</span>
          <span class="s1">}</span>
          <span class="s1">++pointer;</span>
        <span class="s1">}</span>

        <span class="s1">address[pieceIndex] = address[pieceIndex] * </span><span class="s2">0</span><span class="s1">x100 + ipv4Piece;</span>

        <span class="s1">++numbersSeen;</span>

        <span class="s3">if </span><span class="s1">(numbersSeen === </span><span class="s2">2 </span><span class="s1">|| numbersSeen === </span><span class="s2">4</span><span class="s1">) {</span>
          <span class="s1">++pieceIndex;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(numbersSeen !== </span><span class="s2">4</span><span class="s1">) {</span>
        <span class="s3">return </span><span class="s1">failure;</span>
      <span class="s1">}</span>

      <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(input[pointer] === </span><span class="s2">58</span><span class="s1">) {</span>
      <span class="s1">++pointer;</span>
      <span class="s3">if </span><span class="s1">(input[pointer] === undefined) {</span>
        <span class="s3">return </span><span class="s1">failure;</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(input[pointer] !== undefined) {</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>

    <span class="s1">address[pieceIndex] = value;</span>
    <span class="s1">++pieceIndex;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(compress !== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s1">let swaps = pieceIndex - compress;</span>
    <span class="s1">pieceIndex = </span><span class="s2">7</span><span class="s1">;</span>
    <span class="s3">while </span><span class="s1">(pieceIndex !== </span><span class="s2">0 </span><span class="s1">&amp;&amp; swaps &gt; </span><span class="s2">0</span><span class="s1">) {</span>
      <span class="s1">const temp = address[compress + swaps - </span><span class="s2">1</span><span class="s1">];</span>
      <span class="s1">address[compress + swaps - </span><span class="s2">1</span><span class="s1">] = address[pieceIndex];</span>
      <span class="s1">address[pieceIndex] = temp;</span>
      <span class="s1">--pieceIndex;</span>
      <span class="s1">--swaps;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(compress === </span><span class="s3">null </span><span class="s1">&amp;&amp; pieceIndex !== </span><span class="s2">8</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">address;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">serializeIPv6(address) {</span>
  <span class="s1">let output = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">const seqResult = findLongestZeroSequence(address);</span>
  <span class="s1">const compress = seqResult.idx;</span>
  <span class="s1">let ignore0 = </span><span class="s3">false</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(let pieceIndex = </span><span class="s2">0</span><span class="s1">; pieceIndex &lt;= </span><span class="s2">7</span><span class="s1">; ++pieceIndex) {</span>
    <span class="s3">if </span><span class="s1">(ignore0 &amp;&amp; address[pieceIndex] === </span><span class="s2">0</span><span class="s1">) {</span>
      <span class="s3">continue</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(ignore0) {</span>
      <span class="s1">ignore0 = </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(compress === pieceIndex) {</span>
      <span class="s1">const separator = pieceIndex === </span><span class="s2">0 </span><span class="s1">? </span><span class="s0">&quot;::&quot; </span><span class="s1">: </span><span class="s0">&quot;:&quot;</span><span class="s1">;</span>
      <span class="s1">output += separator;</span>
      <span class="s1">ignore0 = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">continue</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s1">output += address[pieceIndex].toString(</span><span class="s2">16</span><span class="s1">);</span>

    <span class="s3">if </span><span class="s1">(pieceIndex !== </span><span class="s2">7</span><span class="s1">) {</span>
      <span class="s1">output += </span><span class="s0">&quot;:&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">output;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">parseHost(input, isSpecialArg) {</span>
  <span class="s3">if </span><span class="s1">(input[</span><span class="s2">0</span><span class="s1">] === </span><span class="s0">&quot;[&quot;</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(input[input.length - </span><span class="s2">1</span><span class="s1">] !== </span><span class="s0">&quot;]&quot;</span><span class="s1">) {</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>

    <span class="s3">return </span><span class="s1">parseIPv6(input.substring(</span><span class="s2">1</span><span class="s1">, input.length - </span><span class="s2">1</span><span class="s1">));</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!isSpecialArg) {</span>
    <span class="s3">return </span><span class="s1">parseOpaqueHost(input);</span>
  <span class="s1">}</span>

  <span class="s1">const domain = utf8PercentDecode(input);</span>
  <span class="s1">const asciiDomain = tr46.toASCII(domain, </span><span class="s3">false</span><span class="s1">, tr46.PROCESSING_OPTIONS.NONTRANSITIONAL, </span><span class="s3">false</span><span class="s1">);</span>
  <span class="s3">if </span><span class="s1">(asciiDomain === </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(containsForbiddenHostCodePoint(asciiDomain)) {</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s1">const ipv4Host = parseIPv4(asciiDomain);</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s1">ipv4Host === </span><span class="s0">&quot;number&quot; </span><span class="s1">|| ipv4Host === failure) {</span>
    <span class="s3">return </span><span class="s1">ipv4Host;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">asciiDomain;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">parseOpaqueHost(input) {</span>
  <span class="s3">if </span><span class="s1">(containsForbiddenHostCodePointExcludingPercent(input)) {</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s1">let output = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">const decoded = punycode.ucs2.decode(input);</span>
  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; decoded.length; ++i) {</span>
    <span class="s1">output += percentEncodeChar(decoded[i], isC0ControlPercentEncode);</span>
  <span class="s1">}</span>
  <span class="s3">return </span><span class="s1">output;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">findLongestZeroSequence(arr) {</span>
  <span class="s1">let maxIdx = </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">let maxLen = </span><span class="s2">1</span><span class="s1">; </span><span class="s4">// only find elements &gt; 1</span>
  <span class="s1">let currStart = </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s1">let currLen = </span><span class="s2">0</span><span class="s1">;</span>

  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; arr.length; ++i) {</span>
    <span class="s3">if </span><span class="s1">(arr[i] !== </span><span class="s2">0</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(currLen &gt; maxLen) {</span>
        <span class="s1">maxIdx = currStart;</span>
        <span class="s1">maxLen = currLen;</span>
      <span class="s1">}</span>

      <span class="s1">currStart = </span><span class="s3">null</span><span class="s1">;</span>
      <span class="s1">currLen = </span><span class="s2">0</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(currStart === </span><span class="s3">null</span><span class="s1">) {</span>
        <span class="s1">currStart = i;</span>
      <span class="s1">}</span>
      <span class="s1">++currLen;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s4">// if trailing zeros</span>
  <span class="s3">if </span><span class="s1">(currLen &gt; maxLen) {</span>
    <span class="s1">maxIdx = currStart;</span>
    <span class="s1">maxLen = currLen;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">{</span>
    <span class="s1">idx: maxIdx,</span>
    <span class="s1">len: maxLen</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">serializeHost(host) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">typeof </span><span class="s1">host === </span><span class="s0">&quot;number&quot;</span><span class="s1">) {</span>
    <span class="s3">return </span><span class="s1">serializeIPv4(host);</span>
  <span class="s1">}</span>

  <span class="s4">// IPv6 serializer</span>
  <span class="s3">if </span><span class="s1">(host </span><span class="s3">instanceof </span><span class="s1">Array) {</span>
    <span class="s3">return </span><span class="s0">&quot;[&quot; </span><span class="s1">+ serializeIPv6(host) + </span><span class="s0">&quot;]&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">host;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">trimControlChars(url) {</span>
  <span class="s3">return </span><span class="s1">url.replace(/^[\u0000-\u001F\u0020]+|[\u0000-\u001F\u0020]+$/g, </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">trimTabAndNewline(url) {</span>
  <span class="s3">return </span><span class="s1">url.replace(/\u0009|\u000A|\u000D/g, </span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">shortenPath(url) {</span>
  <span class="s1">const path = url.path;</span>
  <span class="s3">if </span><span class="s1">(path.length === </span><span class="s2">0</span><span class="s1">) {</span>
    <span class="s3">return</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">if </span><span class="s1">(url.scheme === </span><span class="s0">&quot;file&quot; </span><span class="s1">&amp;&amp; path.length === </span><span class="s2">1 </span><span class="s1">&amp;&amp; isNormalizedWindowsDriveLetter(path[</span><span class="s2">0</span><span class="s1">])) {</span>
    <span class="s3">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">path.pop();</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">includesCredentials(url) {</span>
  <span class="s3">return </span><span class="s1">url.username !== </span><span class="s0">&quot;&quot; </span><span class="s1">|| url.password !== </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">cannotHaveAUsernamePasswordPort(url) {</span>
  <span class="s3">return </span><span class="s1">url.host === </span><span class="s3">null </span><span class="s1">|| url.host === </span><span class="s0">&quot;&quot; </span><span class="s1">|| url.cannotBeABaseURL || url.scheme === </span><span class="s0">&quot;file&quot;</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">isNormalizedWindowsDriveLetter(string) {</span>
  <span class="s3">return </span><span class="s1">/^[A-Za-z]:$/.test(string);</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">URLStateMachine(input, base, encodingOverride, url, stateOverride) {</span>
  <span class="s3">this</span><span class="s1">.pointer = </span><span class="s2">0</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.input = input;</span>
  <span class="s3">this</span><span class="s1">.base = base || </span><span class="s3">null</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.encodingOverride = encodingOverride || </span><span class="s0">&quot;utf-8&quot;</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.stateOverride = stateOverride;</span>
  <span class="s3">this</span><span class="s1">.url = url;</span>
  <span class="s3">this</span><span class="s1">.failure = </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">false</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.url) {</span>
    <span class="s3">this</span><span class="s1">.url = {</span>
      <span class="s1">scheme: </span><span class="s0">&quot;&quot;</span><span class="s1">,</span>
      <span class="s1">username: </span><span class="s0">&quot;&quot;</span><span class="s1">,</span>
      <span class="s1">password: </span><span class="s0">&quot;&quot;</span><span class="s1">,</span>
      <span class="s1">host: </span><span class="s3">null</span><span class="s1">,</span>
      <span class="s1">port: </span><span class="s3">null</span><span class="s1">,</span>
      <span class="s1">path: [],</span>
      <span class="s1">query: </span><span class="s3">null</span><span class="s1">,</span>
      <span class="s1">fragment: </span><span class="s3">null</span><span class="s1">,</span>

      <span class="s1">cannotBeABaseURL: </span><span class="s3">false</span>
    <span class="s1">};</span>

    <span class="s1">const res = trimControlChars(</span><span class="s3">this</span><span class="s1">.input);</span>
    <span class="s3">if </span><span class="s1">(res !== </span><span class="s3">this</span><span class="s1">.input) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.input = res;</span>
  <span class="s1">}</span>

  <span class="s1">const res = trimTabAndNewline(</span><span class="s3">this</span><span class="s1">.input);</span>
  <span class="s3">if </span><span class="s1">(res !== </span><span class="s3">this</span><span class="s1">.input) {</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s3">this</span><span class="s1">.input = res;</span>

  <span class="s3">this</span><span class="s1">.state = stateOverride || </span><span class="s0">&quot;scheme start&quot;</span><span class="s1">;</span>

  <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.atFlag = </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.arrFlag = </span><span class="s3">false</span><span class="s1">;</span>
  <span class="s3">this</span><span class="s1">.passwordTokenSeenFlag = </span><span class="s3">false</span><span class="s1">;</span>

  <span class="s3">this</span><span class="s1">.input = punycode.ucs2.decode(</span><span class="s3">this</span><span class="s1">.input);</span>

  <span class="s3">for </span><span class="s1">(; </span><span class="s3">this</span><span class="s1">.pointer &lt;= </span><span class="s3">this</span><span class="s1">.input.length; ++</span><span class="s3">this</span><span class="s1">.pointer) {</span>
    <span class="s1">const c = </span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer];</span>
    <span class="s1">const cStr = isNaN(c) ? undefined : String.fromCodePoint(c);</span>

    <span class="s4">// exec state machine</span>
    <span class="s1">const ret = </span><span class="s3">this</span><span class="s1">[</span><span class="s0">&quot;parse &quot; </span><span class="s1">+ </span><span class="s3">this</span><span class="s1">.state](c, cStr);</span>
    <span class="s3">if </span><span class="s1">(!ret) {</span>
      <span class="s3">break</span><span class="s1">; </span><span class="s4">// terminate algorithm</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(ret === failure) {</span>
      <span class="s3">this</span><span class="s1">.failure = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">break</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse scheme start&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseSchemeStart(c, cStr) {</span>
  <span class="s3">if </span><span class="s1">(isASCIIAlpha(c)) {</span>
    <span class="s3">this</span><span class="s1">.buffer += cStr.toLowerCase();</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;scheme&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;no scheme&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse scheme&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseScheme(c, cStr) {</span>
  <span class="s3">if </span><span class="s1">(isASCIIAlphanumeric(c) || c === </span><span class="s2">43 </span><span class="s1">|| c === </span><span class="s2">45 </span><span class="s1">|| c === </span><span class="s2">46</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.buffer += cStr.toLowerCase();</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">58</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
      <span class="s3">if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; !isSpecialScheme(</span><span class="s3">this</span><span class="s1">.buffer)) {</span>
        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(!isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; isSpecialScheme(</span><span class="s3">this</span><span class="s1">.buffer)) {</span>
        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">((includesCredentials(</span><span class="s3">this</span><span class="s1">.url) || </span><span class="s3">this</span><span class="s1">.url.port !== </span><span class="s3">null</span><span class="s1">) &amp;&amp; </span><span class="s3">this</span><span class="s1">.buffer === </span><span class="s0">&quot;file&quot;</span><span class="s1">) {</span>
        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.url.scheme === </span><span class="s0">&quot;file&quot; </span><span class="s1">&amp;&amp; (</span><span class="s3">this</span><span class="s1">.url.host === </span><span class="s0">&quot;&quot; </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.url.host === </span><span class="s3">null</span><span class="s1">)) {</span>
        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.url.scheme = </span><span class="s3">this</span><span class="s1">.buffer;</span>
    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.url.scheme === </span><span class="s0">&quot;file&quot;</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">] !== </span><span class="s2">47 </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">2</span><span class="s1">] !== </span><span class="s2">47</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;file&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; </span><span class="s3">this</span><span class="s1">.base !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.base.scheme === </span><span class="s3">this</span><span class="s1">.url.scheme) {</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;special relative or authority&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url)) {</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;special authority slashes&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">] === </span><span class="s2">47</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path or authority&quot;</span><span class="s1">;</span>
      <span class="s1">++</span><span class="s3">this</span><span class="s1">.pointer;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">this</span><span class="s1">.url.cannotBeABaseURL = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.url.path.push(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;cannot-be-a-base-URL path&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;no scheme&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.pointer = -</span><span class="s2">1</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse no scheme&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseNoScheme(c) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.base === </span><span class="s3">null </span><span class="s1">|| (</span><span class="s3">this</span><span class="s1">.base.cannotBeABaseURL &amp;&amp; c !== </span><span class="s2">35</span><span class="s1">)) {</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.base.cannotBeABaseURL &amp;&amp; c === </span><span class="s2">35</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.url.scheme = </span><span class="s3">this</span><span class="s1">.base.scheme;</span>
    <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
    <span class="s3">this</span><span class="s1">.url.query = </span><span class="s3">this</span><span class="s1">.base.query;</span>
    <span class="s3">this</span><span class="s1">.url.fragment = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.url.cannotBeABaseURL = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;fragment&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.base.scheme === </span><span class="s0">&quot;file&quot;</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;file&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;relative&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse special relative or authority&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseSpecialRelativeOrAuthority(c) {</span>
  <span class="s3">if </span><span class="s1">(c === </span><span class="s2">47 </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">] === </span><span class="s2">47</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;special authority ignore slashes&quot;</span><span class="s1">;</span>
    <span class="s1">++</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;relative&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse path or authority&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parsePathOrAuthority(c) {</span>
  <span class="s3">if </span><span class="s1">(c === </span><span class="s2">47</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;authority&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse relative&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseRelative(c) {</span>
  <span class="s3">this</span><span class="s1">.url.scheme = </span><span class="s3">this</span><span class="s1">.base.scheme;</span>
  <span class="s3">if </span><span class="s1">(isNaN(c)) {</span>
    <span class="s3">this</span><span class="s1">.url.username = </span><span class="s3">this</span><span class="s1">.base.username;</span>
    <span class="s3">this</span><span class="s1">.url.password = </span><span class="s3">this</span><span class="s1">.base.password;</span>
    <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
    <span class="s3">this</span><span class="s1">.url.port = </span><span class="s3">this</span><span class="s1">.base.port;</span>
    <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
    <span class="s3">this</span><span class="s1">.url.query = </span><span class="s3">this</span><span class="s1">.base.query;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">47</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;relative slash&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">63</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.url.username = </span><span class="s3">this</span><span class="s1">.base.username;</span>
    <span class="s3">this</span><span class="s1">.url.password = </span><span class="s3">this</span><span class="s1">.base.password;</span>
    <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
    <span class="s3">this</span><span class="s1">.url.port = </span><span class="s3">this</span><span class="s1">.base.port;</span>
    <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
    <span class="s3">this</span><span class="s1">.url.query = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;query&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">35</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.url.username = </span><span class="s3">this</span><span class="s1">.base.username;</span>
    <span class="s3">this</span><span class="s1">.url.password = </span><span class="s3">this</span><span class="s1">.base.password;</span>
    <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
    <span class="s3">this</span><span class="s1">.url.port = </span><span class="s3">this</span><span class="s1">.base.port;</span>
    <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
    <span class="s3">this</span><span class="s1">.url.query = </span><span class="s3">this</span><span class="s1">.base.query;</span>
    <span class="s3">this</span><span class="s1">.url.fragment = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;fragment&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;relative slash&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.url.username = </span><span class="s3">this</span><span class="s1">.base.username;</span>
    <span class="s3">this</span><span class="s1">.url.password = </span><span class="s3">this</span><span class="s1">.base.password;</span>
    <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
    <span class="s3">this</span><span class="s1">.url.port = </span><span class="s3">this</span><span class="s1">.base.port;</span>
    <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice(</span><span class="s2">0</span><span class="s1">, </span><span class="s3">this</span><span class="s1">.base.path.length - </span><span class="s2">1</span><span class="s1">);</span>

    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse relative slash&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseRelativeSlash(c) {</span>
  <span class="s3">if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; (c === </span><span class="s2">47 </span><span class="s1">|| c === </span><span class="s2">92</span><span class="s1">)) {</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">92</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;special authority ignore slashes&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">47</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;authority&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.url.username = </span><span class="s3">this</span><span class="s1">.base.username;</span>
    <span class="s3">this</span><span class="s1">.url.password = </span><span class="s3">this</span><span class="s1">.base.password;</span>
    <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
    <span class="s3">this</span><span class="s1">.url.port = </span><span class="s3">this</span><span class="s1">.base.port;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse special authority slashes&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseSpecialAuthoritySlashes(c) {</span>
  <span class="s3">if </span><span class="s1">(c === </span><span class="s2">47 </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">] === </span><span class="s2">47</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;special authority ignore slashes&quot;</span><span class="s1">;</span>
    <span class="s1">++</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;special authority ignore slashes&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse special authority ignore slashes&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseSpecialAuthorityIgnoreSlashes(c) {</span>
  <span class="s3">if </span><span class="s1">(c !== </span><span class="s2">47 </span><span class="s1">&amp;&amp; c !== </span><span class="s2">92</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;authority&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse authority&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseAuthority(c, cStr) {</span>
  <span class="s3">if </span><span class="s1">(c === </span><span class="s2">64</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.atFlag) {</span>
      <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;%40&quot; </span><span class="s1">+ </span><span class="s3">this</span><span class="s1">.buffer;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.atFlag = </span><span class="s3">true</span><span class="s1">;</span>

    <span class="s4">// careful, this is based on buffer and has its own pointer (this.pointer != pointer) and inner chars</span>
    <span class="s1">const len = countSymbols(</span><span class="s3">this</span><span class="s1">.buffer);</span>
    <span class="s3">for </span><span class="s1">(let pointer = </span><span class="s2">0</span><span class="s1">; pointer &lt; len; ++pointer) {</span>
      <span class="s1">const codePoint = </span><span class="s3">this</span><span class="s1">.buffer.codePointAt(pointer);</span>

      <span class="s3">if </span><span class="s1">(codePoint === </span><span class="s2">58 </span><span class="s1">&amp;&amp; !</span><span class="s3">this</span><span class="s1">.passwordTokenSeenFlag) {</span>
        <span class="s3">this</span><span class="s1">.passwordTokenSeenFlag = </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">continue</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s1">const encodedCodePoints = percentEncodeChar(codePoint, isUserinfoPercentEncode);</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.passwordTokenSeenFlag) {</span>
        <span class="s3">this</span><span class="s1">.url.password += encodedCodePoints;</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">this</span><span class="s1">.url.username += encodedCodePoints;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(isNaN(c) || c === </span><span class="s2">47 </span><span class="s1">|| c === </span><span class="s2">63 </span><span class="s1">|| c === </span><span class="s2">35 </span><span class="s1">||</span>
             <span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">)) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.atFlag &amp;&amp; </span><span class="s3">this</span><span class="s1">.buffer === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.pointer -= countSymbols(</span><span class="s3">this</span><span class="s1">.buffer) + </span><span class="s2">1</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;host&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.buffer += cStr;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse hostname&quot;</span><span class="s1">] =</span>
<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse host&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseHostName(c, cStr) {</span>
  <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride &amp;&amp; </span><span class="s3">this</span><span class="s1">.url.scheme === </span><span class="s0">&quot;file&quot;</span><span class="s1">) {</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;file host&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">58 </span><span class="s1">&amp;&amp; !</span><span class="s3">this</span><span class="s1">.arrFlag) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.buffer === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>

    <span class="s1">const host = parseHost(</span><span class="s3">this</span><span class="s1">.buffer, isSpecial(</span><span class="s3">this</span><span class="s1">.url));</span>
    <span class="s3">if </span><span class="s1">(host === failure) {</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.url.host = host;</span>
    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;port&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride === </span><span class="s0">&quot;hostname&quot;</span><span class="s1">) {</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(isNaN(c) || c === </span><span class="s2">47 </span><span class="s1">|| c === </span><span class="s2">63 </span><span class="s1">|| c === </span><span class="s2">35 </span><span class="s1">||</span>
             <span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">)) {</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
    <span class="s3">if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; </span><span class="s3">this</span><span class="s1">.buffer === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride &amp;&amp; </span><span class="s3">this</span><span class="s1">.buffer === </span><span class="s0">&quot;&quot; </span><span class="s1">&amp;&amp;</span>
               <span class="s1">(includesCredentials(</span><span class="s3">this</span><span class="s1">.url) || </span><span class="s3">this</span><span class="s1">.url.port !== </span><span class="s3">null</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s1">const host = parseHost(</span><span class="s3">this</span><span class="s1">.buffer, isSpecial(</span><span class="s3">this</span><span class="s1">.url));</span>
    <span class="s3">if </span><span class="s1">(host === failure) {</span>
      <span class="s3">return </span><span class="s1">failure;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.url.host = host;</span>
    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path start&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">91</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.arrFlag = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">93</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.arrFlag = </span><span class="s3">false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.buffer += cStr;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse port&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parsePort(c, cStr) {</span>
  <span class="s3">if </span><span class="s1">(isASCIIDigit(c)) {</span>
    <span class="s3">this</span><span class="s1">.buffer += cStr;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(isNaN(c) || c === </span><span class="s2">47 </span><span class="s1">|| c === </span><span class="s2">63 </span><span class="s1">|| c === </span><span class="s2">35 </span><span class="s1">||</span>
             <span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">) ||</span>
             <span class="s3">this</span><span class="s1">.stateOverride) {</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.buffer !== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s1">const port = parseInt(</span><span class="s3">this</span><span class="s1">.buffer);</span>
      <span class="s3">if </span><span class="s1">(port &gt; Math.pow(</span><span class="s2">2</span><span class="s1">, </span><span class="s2">16</span><span class="s1">) - </span><span class="s2">1</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">return </span><span class="s1">failure;</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.url.port = port === defaultPort(</span><span class="s3">this</span><span class="s1">.url.scheme) ? </span><span class="s3">null </span><span class="s1">: port;</span>
      <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
      <span class="s3">return false</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path start&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s3">return </span><span class="s1">failure;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">const fileOtherwiseCodePoints = </span><span class="s3">new </span><span class="s1">Set([</span><span class="s2">47</span><span class="s1">, </span><span class="s2">92</span><span class="s1">, </span><span class="s2">63</span><span class="s1">, </span><span class="s2">35</span><span class="s1">]);</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse file&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseFile(c) {</span>
  <span class="s3">this</span><span class="s1">.url.scheme = </span><span class="s0">&quot;file&quot;</span><span class="s1">;</span>

  <span class="s3">if </span><span class="s1">(c === </span><span class="s2">47 </span><span class="s1">|| c === </span><span class="s2">92</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">92</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;file slash&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.base !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.base.scheme === </span><span class="s0">&quot;file&quot;</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(isNaN(c)) {</span>
      <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
      <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
      <span class="s3">this</span><span class="s1">.url.query = </span><span class="s3">this</span><span class="s1">.base.query;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">63</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
      <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
      <span class="s3">this</span><span class="s1">.url.query = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;query&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">35</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
      <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
      <span class="s3">this</span><span class="s1">.url.query = </span><span class="s3">this</span><span class="s1">.base.query;</span>
      <span class="s3">this</span><span class="s1">.url.fragment = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;fragment&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.input.length - </span><span class="s3">this</span><span class="s1">.pointer - </span><span class="s2">1 </span><span class="s1">=== </span><span class="s2">0 </span><span class="s1">|| </span><span class="s4">// remaining consists of 0 code points</span>
          <span class="s1">!isWindowsDriveLetterCodePoints(c, </span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">]) ||</span>
          <span class="s1">(</span><span class="s3">this</span><span class="s1">.input.length - </span><span class="s3">this</span><span class="s1">.pointer - </span><span class="s2">1 </span><span class="s1">&gt;= </span><span class="s2">2 </span><span class="s1">&amp;&amp; </span><span class="s4">// remaining has at least 2 code points</span>
           <span class="s1">!fileOtherwiseCodePoints.has(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">2</span><span class="s1">]))) {</span>
        <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
        <span class="s3">this</span><span class="s1">.url.path = </span><span class="s3">this</span><span class="s1">.base.path.slice();</span>
        <span class="s1">shortenPath(</span><span class="s3">this</span><span class="s1">.url);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
      <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse file slash&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseFileSlash(c) {</span>
  <span class="s3">if </span><span class="s1">(c === </span><span class="s2">47 </span><span class="s1">|| c === </span><span class="s2">92</span><span class="s1">) {</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">92</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;file host&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.base !== </span><span class="s3">null </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.base.scheme === </span><span class="s0">&quot;file&quot;</span><span class="s1">) {</span>
      <span class="s3">if </span><span class="s1">(isNormalizedWindowsDriveLetterString(</span><span class="s3">this</span><span class="s1">.base.path[</span><span class="s2">0</span><span class="s1">])) {</span>
        <span class="s3">this</span><span class="s1">.url.path.push(</span><span class="s3">this</span><span class="s1">.base.path[</span><span class="s2">0</span><span class="s1">]);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">this</span><span class="s1">.url.host = </span><span class="s3">this</span><span class="s1">.base.host;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse file host&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseFileHost(c, cStr) {</span>
  <span class="s3">if </span><span class="s1">(isNaN(c) || c === </span><span class="s2">47 </span><span class="s1">|| c === </span><span class="s2">92 </span><span class="s1">|| c === </span><span class="s2">63 </span><span class="s1">|| c === </span><span class="s2">35</span><span class="s1">) {</span>
    <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
    <span class="s3">if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.stateOverride &amp;&amp; isWindowsDriveLetterString(</span><span class="s3">this</span><span class="s1">.buffer)) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.buffer === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.url.host = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path start&quot;</span><span class="s1">;</span>
    <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
      <span class="s1">let host = parseHost(</span><span class="s3">this</span><span class="s1">.buffer, isSpecial(</span><span class="s3">this</span><span class="s1">.url));</span>
      <span class="s3">if </span><span class="s1">(host === failure) {</span>
        <span class="s3">return </span><span class="s1">failure;</span>
      <span class="s1">}</span>
      <span class="s3">if </span><span class="s1">(host === </span><span class="s0">&quot;localhost&quot;</span><span class="s1">) {</span>
        <span class="s1">host = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.url.host = host;</span>

      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.stateOverride) {</span>
        <span class="s3">return false</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path start&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">this</span><span class="s1">.buffer += cStr;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse path start&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parsePathStart(c) {</span>
  <span class="s3">if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url)) {</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">92</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(c !== </span><span class="s2">47 </span><span class="s1">&amp;&amp; c !== </span><span class="s2">92</span><span class="s1">) {</span>
      <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.stateOverride &amp;&amp; c === </span><span class="s2">63</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.url.query = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;query&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!</span><span class="s3">this</span><span class="s1">.stateOverride &amp;&amp; c === </span><span class="s2">35</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.url.fragment = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;fragment&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c !== undefined) {</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;path&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(c !== </span><span class="s2">47</span><span class="s1">) {</span>
      <span class="s1">--</span><span class="s3">this</span><span class="s1">.pointer;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse path&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parsePath(c) {</span>
  <span class="s3">if </span><span class="s1">(isNaN(c) || c === </span><span class="s2">47 </span><span class="s1">|| (isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">) ||</span>
      <span class="s1">(!</span><span class="s3">this</span><span class="s1">.stateOverride &amp;&amp; (c === </span><span class="s2">63 </span><span class="s1">|| c === </span><span class="s2">35</span><span class="s1">))) {</span>
    <span class="s3">if </span><span class="s1">(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(isDoubleDot(</span><span class="s3">this</span><span class="s1">.buffer)) {</span>
      <span class="s1">shortenPath(</span><span class="s3">this</span><span class="s1">.url);</span>
      <span class="s3">if </span><span class="s1">(c !== </span><span class="s2">47 </span><span class="s1">&amp;&amp; !(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">)) {</span>
        <span class="s3">this</span><span class="s1">.url.path.push(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(isSingleDot(</span><span class="s3">this</span><span class="s1">.buffer) &amp;&amp; c !== </span><span class="s2">47 </span><span class="s1">&amp;&amp;</span>
               <span class="s1">!(isSpecial(</span><span class="s3">this</span><span class="s1">.url) &amp;&amp; c === </span><span class="s2">92</span><span class="s1">)) {</span>
      <span class="s3">this</span><span class="s1">.url.path.push(</span><span class="s0">&quot;&quot;</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s3">else if </span><span class="s1">(!isSingleDot(</span><span class="s3">this</span><span class="s1">.buffer)) {</span>
      <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.url.scheme === </span><span class="s0">&quot;file&quot; </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.url.path.length === </span><span class="s2">0 </span><span class="s1">&amp;&amp; isWindowsDriveLetterString(</span><span class="s3">this</span><span class="s1">.buffer)) {</span>
        <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.url.host !== </span><span class="s0">&quot;&quot; </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.url.host !== </span><span class="s3">null</span><span class="s1">) {</span>
          <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
          <span class="s3">this</span><span class="s1">.url.host = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
        <span class="s1">}</span>
        <span class="s3">this</span><span class="s1">.buffer = </span><span class="s3">this</span><span class="s1">.buffer[</span><span class="s2">0</span><span class="s1">] + </span><span class="s0">&quot;:&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s3">this</span><span class="s1">.url.path.push(</span><span class="s3">this</span><span class="s1">.buffer);</span>
    <span class="s1">}</span>
    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.url.scheme === </span><span class="s0">&quot;file&quot; </span><span class="s1">&amp;&amp; (c === undefined || c === </span><span class="s2">63 </span><span class="s1">|| c === </span><span class="s2">35</span><span class="s1">)) {</span>
      <span class="s3">while </span><span class="s1">(</span><span class="s3">this</span><span class="s1">.url.path.length &gt; </span><span class="s2">1 </span><span class="s1">&amp;&amp; </span><span class="s3">this</span><span class="s1">.url.path[</span><span class="s2">0</span><span class="s1">] === </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
        <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
        <span class="s3">this</span><span class="s1">.url.path.shift();</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">63</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.url.query = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;query&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">35</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.url.fragment = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;fragment&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s4">// TODO: If c is not a URL code point and not &quot;%&quot;, parse error.</span>

    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">37 </span><span class="s1">&amp;&amp;</span>
      <span class="s1">(!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">]) ||</span>
        <span class="s1">!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">2</span><span class="s1">]))) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.buffer += percentEncodeChar(c, isPathPercentEncode);</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse cannot-be-a-base-URL path&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseCannotBeABaseURLPath(c) {</span>
  <span class="s3">if </span><span class="s1">(c === </span><span class="s2">63</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.url.query = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;query&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">35</span><span class="s1">) {</span>
    <span class="s3">this</span><span class="s1">.url.fragment = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;fragment&quot;</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s4">// TODO: Add: not a URL code point</span>
    <span class="s3">if </span><span class="s1">(!isNaN(c) &amp;&amp; c !== </span><span class="s2">37</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">37 </span><span class="s1">&amp;&amp;</span>
        <span class="s1">(!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">]) ||</span>
         <span class="s1">!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">2</span><span class="s1">]))) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">if </span><span class="s1">(!isNaN(c)) {</span>
      <span class="s3">this</span><span class="s1">.url.path[</span><span class="s2">0</span><span class="s1">] = </span><span class="s3">this</span><span class="s1">.url.path[</span><span class="s2">0</span><span class="s1">] + percentEncodeChar(c, isC0ControlPercentEncode);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse query&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseQuery(c, cStr) {</span>
  <span class="s3">if </span><span class="s1">(isNaN(c) || (!</span><span class="s3">this</span><span class="s1">.stateOverride &amp;&amp; c === </span><span class="s2">35</span><span class="s1">)) {</span>
    <span class="s3">if </span><span class="s1">(!isSpecial(</span><span class="s3">this</span><span class="s1">.url) || </span><span class="s3">this</span><span class="s1">.url.scheme === </span><span class="s0">&quot;ws&quot; </span><span class="s1">|| </span><span class="s3">this</span><span class="s1">.url.scheme === </span><span class="s0">&quot;wss&quot;</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.encodingOverride = </span><span class="s0">&quot;utf-8&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s1">const buffer = </span><span class="s3">new </span><span class="s1">Buffer(</span><span class="s3">this</span><span class="s1">.buffer); </span><span class="s4">// TODO: Use encoding override instead</span>
    <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; buffer.length; ++i) {</span>
      <span class="s3">if </span><span class="s1">(buffer[i] &lt; </span><span class="s2">0</span><span class="s1">x21 || buffer[i] &gt; </span><span class="s2">0</span><span class="s1">x7E || buffer[i] === </span><span class="s2">0</span><span class="s1">x22 || buffer[i] === </span><span class="s2">0</span><span class="s1">x23 ||</span>
          <span class="s1">buffer[i] === </span><span class="s2">0</span><span class="s1">x3C || buffer[i] === </span><span class="s2">0</span><span class="s1">x3E) {</span>
        <span class="s3">this</span><span class="s1">.url.query += percentEncode(buffer[i]);</span>
      <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
        <span class="s3">this</span><span class="s1">.url.query += String.fromCodePoint(buffer[i]);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.buffer = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">35</span><span class="s1">) {</span>
      <span class="s3">this</span><span class="s1">.url.fragment = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
      <span class="s3">this</span><span class="s1">.state = </span><span class="s0">&quot;fragment&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s4">// TODO: If c is not a URL code point and not &quot;%&quot;, parse error.</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">37 </span><span class="s1">&amp;&amp;</span>
      <span class="s1">(!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">]) ||</span>
        <span class="s1">!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">2</span><span class="s1">]))) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.buffer += cStr;</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s1">URLStateMachine.prototype[</span><span class="s0">&quot;parse fragment&quot;</span><span class="s1">] = </span><span class="s3">function </span><span class="s1">parseFragment(c) {</span>
  <span class="s3">if </span><span class="s1">(isNaN(c)) { </span><span class="s4">// do nothing</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(c === </span><span class="s2">0</span><span class="s1">x0) {</span>
    <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s4">// TODO: If c is not a URL code point and not &quot;%&quot;, parse error.</span>
    <span class="s3">if </span><span class="s1">(c === </span><span class="s2">37 </span><span class="s1">&amp;&amp;</span>
      <span class="s1">(!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">1</span><span class="s1">]) ||</span>
        <span class="s1">!isASCIIHex(</span><span class="s3">this</span><span class="s1">.input[</span><span class="s3">this</span><span class="s1">.pointer + </span><span class="s2">2</span><span class="s1">]))) {</span>
      <span class="s3">this</span><span class="s1">.parseError = </span><span class="s3">true</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s3">this</span><span class="s1">.url.fragment += percentEncodeChar(c, isC0ControlPercentEncode);</span>
  <span class="s1">}</span>

  <span class="s3">return true</span><span class="s1">;</span>
<span class="s1">};</span>

<span class="s3">function </span><span class="s1">serializeURL(url, excludeFragment) {</span>
  <span class="s1">let output = url.scheme + </span><span class="s0">&quot;:&quot;</span><span class="s1">;</span>
  <span class="s3">if </span><span class="s1">(url.host !== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s1">output += </span><span class="s0">&quot;//&quot;</span><span class="s1">;</span>

    <span class="s3">if </span><span class="s1">(url.username !== </span><span class="s0">&quot;&quot; </span><span class="s1">|| url.password !== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
      <span class="s1">output += url.username;</span>
      <span class="s3">if </span><span class="s1">(url.password !== </span><span class="s0">&quot;&quot;</span><span class="s1">) {</span>
        <span class="s1">output += </span><span class="s0">&quot;:&quot; </span><span class="s1">+ url.password;</span>
      <span class="s1">}</span>
      <span class="s1">output += </span><span class="s0">&quot;@&quot;</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s1">output += serializeHost(url.host);</span>

    <span class="s3">if </span><span class="s1">(url.port !== </span><span class="s3">null</span><span class="s1">) {</span>
      <span class="s1">output += </span><span class="s0">&quot;:&quot; </span><span class="s1">+ url.port;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">else if </span><span class="s1">(url.host === </span><span class="s3">null </span><span class="s1">&amp;&amp; url.scheme === </span><span class="s0">&quot;file&quot;</span><span class="s1">) {</span>
    <span class="s1">output += </span><span class="s0">&quot;//&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(url.cannotBeABaseURL) {</span>
    <span class="s1">output += url.path[</span><span class="s2">0</span><span class="s1">];</span>
  <span class="s1">} </span><span class="s3">else </span><span class="s1">{</span>
    <span class="s3">for </span><span class="s1">(const string of url.path) {</span>
      <span class="s1">output += </span><span class="s0">&quot;/&quot; </span><span class="s1">+ string;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(url.query !== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s1">output += </span><span class="s0">&quot;?&quot; </span><span class="s1">+ url.query;</span>
  <span class="s1">}</span>

  <span class="s3">if </span><span class="s1">(!excludeFragment &amp;&amp; url.fragment !== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s1">output += </span><span class="s0">&quot;#&quot; </span><span class="s1">+ url.fragment;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">output;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">serializeOrigin(tuple) {</span>
  <span class="s1">let result = tuple.scheme + </span><span class="s0">&quot;://&quot;</span><span class="s1">;</span>
  <span class="s1">result += serializeHost(tuple.host);</span>

  <span class="s3">if </span><span class="s1">(tuple.port !== </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s1">result += </span><span class="s0">&quot;:&quot; </span><span class="s1">+ tuple.port;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">result;</span>
<span class="s1">}</span>

<span class="s1">module.exports.serializeURL = serializeURL;</span>

<span class="s1">module.exports.serializeURLOrigin = </span><span class="s3">function </span><span class="s1">(url) {</span>
  <span class="s4">// https://url.spec.whatwg.org/#concept-url-origin</span>
  <span class="s3">switch </span><span class="s1">(url.scheme) {</span>
    <span class="s3">case </span><span class="s0">&quot;blob&quot;</span><span class="s1">:</span>
      <span class="s3">try </span><span class="s1">{</span>
        <span class="s3">return </span><span class="s1">module.exports.serializeURLOrigin(module.exports.parseURL(url.path[</span><span class="s2">0</span><span class="s1">]));</span>
      <span class="s1">} </span><span class="s3">catch </span><span class="s1">(e) {</span>
        <span class="s4">// serializing an opaque origin returns &quot;null&quot;</span>
        <span class="s3">return </span><span class="s0">&quot;null&quot;</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s3">case </span><span class="s0">&quot;ftp&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;gopher&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;http&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;https&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;ws&quot;</span><span class="s1">:</span>
    <span class="s3">case </span><span class="s0">&quot;wss&quot;</span><span class="s1">:</span>
      <span class="s3">return </span><span class="s1">serializeOrigin({</span>
        <span class="s1">scheme: url.scheme,</span>
        <span class="s1">host: url.host,</span>
        <span class="s1">port: url.port</span>
      <span class="s1">});</span>
    <span class="s3">case </span><span class="s0">&quot;file&quot;</span><span class="s1">:</span>
      <span class="s4">// spec says &quot;exercise to the reader&quot;, chrome says &quot;file://&quot;</span>
      <span class="s3">return </span><span class="s0">&quot;file://&quot;</span><span class="s1">;</span>
    <span class="s3">default</span><span class="s1">:</span>
      <span class="s4">// serializing an opaque origin returns &quot;null&quot;</span>
      <span class="s3">return </span><span class="s0">&quot;null&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s1">module.exports.basicURLParse = </span><span class="s3">function </span><span class="s1">(input, options) {</span>
  <span class="s3">if </span><span class="s1">(options === undefined) {</span>
    <span class="s1">options = {};</span>
  <span class="s1">}</span>

  <span class="s1">const usm = </span><span class="s3">new </span><span class="s1">URLStateMachine(input, options.baseURL, options.encodingOverride, options.url, options.stateOverride);</span>
  <span class="s3">if </span><span class="s1">(usm.failure) {</span>
    <span class="s3">return </span><span class="s0">&quot;failure&quot;</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s3">return </span><span class="s1">usm.url;</span>
<span class="s1">};</span>

<span class="s1">module.exports.setTheUsername = </span><span class="s3">function </span><span class="s1">(url, username) {</span>
  <span class="s1">url.username = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">const decoded = punycode.ucs2.decode(username);</span>
  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; decoded.length; ++i) {</span>
    <span class="s1">url.username += percentEncodeChar(decoded[i], isUserinfoPercentEncode);</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s1">module.exports.setThePassword = </span><span class="s3">function </span><span class="s1">(url, password) {</span>
  <span class="s1">url.password = </span><span class="s0">&quot;&quot;</span><span class="s1">;</span>
  <span class="s1">const decoded = punycode.ucs2.decode(password);</span>
  <span class="s3">for </span><span class="s1">(let i = </span><span class="s2">0</span><span class="s1">; i &lt; decoded.length; ++i) {</span>
    <span class="s1">url.password += percentEncodeChar(decoded[i], isUserinfoPercentEncode);</span>
  <span class="s1">}</span>
<span class="s1">};</span>

<span class="s1">module.exports.serializeHost = serializeHost;</span>

<span class="s1">module.exports.cannotHaveAUsernamePasswordPort = cannotHaveAUsernamePasswordPort;</span>

<span class="s1">module.exports.serializeInteger = </span><span class="s3">function </span><span class="s1">(integer) {</span>
  <span class="s3">return </span><span class="s1">String(integer);</span>
<span class="s1">};</span>

<span class="s1">module.exports.parseURL = </span><span class="s3">function </span><span class="s1">(input, options) {</span>
  <span class="s3">if </span><span class="s1">(options === undefined) {</span>
    <span class="s1">options = {};</span>
  <span class="s1">}</span>

  <span class="s4">// We don't handle blobs, so this just delegates:</span>
  <span class="s3">return </span><span class="s1">module.exports.basicURLParse(input, { baseURL: options.baseURL, encodingOverride: options.encodingOverride });</span>
<span class="s1">};</span>
</pre>
</body>
</html>