<html>
<head>
<title>RCTComponentData.m</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
RCTComponentData.m</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#import </span><span class="s3">&quot;RCTComponentData.h&quot;</span>

<span class="s2">#import </span><span class="s3">&lt;objc/message.h&gt;</span>

<span class="s2">#import </span><span class="s3">&quot;RCTBridge.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTBridgeModule.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTComponentEvent.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTConstants.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTConvert.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTEventDispatcherProtocol.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTParserUtils.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTShadowView.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;RCTUtils.h&quot;</span>
<span class="s2">#import </span><span class="s3">&quot;UIView+React.h&quot;</span>

<span class="s4">typedef void </span><span class="s1">(^RCTPropBlock)(id&lt;RCTComponent&gt; view</span><span class="s4">, </span><span class="s1">id json)</span><span class="s4">;</span>
<span class="s4">typedef </span><span class="s1">NSMutableDictionary&lt;NSString *</span><span class="s4">, </span><span class="s1">RCTPropBlock&gt; RCTPropBlockDictionary</span><span class="s4">;</span>
<span class="s4">typedef void </span><span class="s1">(^InterceptorBlock)(NSString *eventName</span><span class="s4">, </span><span class="s1">NSDictionary *event</span><span class="s4">, </span><span class="s1">id sender)</span><span class="s4">;</span>

<span class="s0">/** 
 * Get the converter function for the specified type 
 */</span>
<span class="s4">static </span><span class="s1">SEL selectorForType(NSString *type)</span>
<span class="s1">{</span>
  <span class="s4">const char </span><span class="s1">*input = type.UTF8String</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">NSSelectorFromString([RCTParseType(&amp;input) stringByAppendingString:</span><span class="s4">@</span><span class="s3">&quot;:&quot;</span><span class="s1">])</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@implementation </span><span class="s1">RCTComponentData {</span>
  <span class="s1">id&lt;RCTComponent&gt; _defaultView</span><span class="s4">; </span><span class="s0">// Only needed for RCT_CUSTOM_VIEW_PROPERTY</span>
  <span class="s1">RCTPropBlockDictionary *_viewPropBlocks</span><span class="s4">;</span>
  <span class="s1">RCTPropBlockDictionary *_shadowPropBlocks</span><span class="s4">;</span>
  <span class="s4">__weak </span><span class="s1">RCTBridge *_bridge</span><span class="s4">;</span>
  <span class="s4">__weak </span><span class="s1">id&lt;RCTEventDispatcherProtocol&gt; _eventDispatcher</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@synthesize </span><span class="s1">manager = _manager</span><span class="s4">;</span>
<span class="s4">@synthesize </span><span class="s1">bridgelessViewManager = _bridgelessViewManager</span><span class="s4">;</span>

<span class="s1">- (instancetype)initWithManagerClass:(Class)managerClass</span>
                              <span class="s1">bridge:(RCTBridge *)bridge</span>
                     <span class="s1">eventDispatcher:(id&lt;RCTEventDispatcherProtocol&gt;)eventDispatcher</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">((self = [super init])) {</span>
    <span class="s1">_bridge = bridge</span><span class="s4">;</span>
    <span class="s1">_eventDispatcher = eventDispatcher</span><span class="s4">;</span>
    <span class="s1">_managerClass = managerClass</span><span class="s4">;</span>
    <span class="s1">_viewPropBlocks = [NSMutableDictionary new]</span><span class="s4">;</span>
    <span class="s1">_shadowPropBlocks = [NSMutableDictionary new]</span><span class="s4">;</span>

    <span class="s1">_name = moduleNameForClass(managerClass)</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">self</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (RCTViewManager *)manager</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(!_manager &amp;&amp; _bridge) {</span>
    <span class="s1">_manager = [_bridge moduleForClass:_managerClass]</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else if </span><span class="s1">(!_manager &amp;&amp; !_bridgelessViewManager) {</span>
    <span class="s1">_bridgelessViewManager = [_managerClass new]</span><span class="s4">;</span>
    <span class="s1">[[NSNotificationCenter defaultCenter] postNotificationName:RCTDidInitializeModuleNotification</span>
                                                        <span class="s1">object:nil</span>
                                                      <span class="s1">userInfo:</span><span class="s4">@</span><span class="s1">{</span><span class="s4">@</span><span class="s3">&quot;module&quot; </span><span class="s1">: _bridgelessViewManager}]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">_manager ?: _bridgelessViewManager</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_NOT_IMPLEMENTED(-(instancetype)init)</span>

<span class="s1">- (UIView *)createViewWithTag:(nullable NSNumber *)tag rootTag:(nullable NSNumber *)rootTag</span>
<span class="s1">{</span>
  <span class="s1">RCTAssertMainQueue()</span><span class="s4">;</span>

  <span class="s1">UIView *view = [self.manager view]</span><span class="s4">;</span>
  <span class="s1">view.reactTag = tag</span><span class="s4">;</span>
  <span class="s1">view.rootTag = rootTag</span><span class="s4">;</span>
  <span class="s1">view.multipleTouchEnabled = YES</span><span class="s4">;</span>
  <span class="s1">view.userInteractionEnabled = YES</span><span class="s4">; </span><span class="s0">// required for touch handling</span>
  <span class="s1">view.layer.allowsGroupOpacity = YES</span><span class="s4">; </span><span class="s0">// required for touch handling</span>
  <span class="s4">return </span><span class="s1">view</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (RCTShadowView *)createShadowViewWithTag:(NSNumber *)tag</span>
<span class="s1">{</span>
  <span class="s1">RCTShadowView *shadowView = [self.manager shadowView]</span><span class="s4">;</span>
  <span class="s1">shadowView.reactTag = tag</span><span class="s4">;</span>
  <span class="s1">shadowView.viewName = _name</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">shadowView</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)callCustomSetter:(SEL)setter onView:(id&lt;RCTComponent&gt;)view withProp:(id)json isShadowView:(BOOL)isShadowView</span>
<span class="s1">{</span>
  <span class="s1">json = RCTNilIfNull(json)</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(!isShadowView) {</span>
    <span class="s4">if </span><span class="s1">(!json &amp;&amp; !_defaultView) {</span>
      <span class="s0">// Only create default view if json is null</span>
      <span class="s1">_defaultView = [self createViewWithTag:nil rootTag:nil]</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">((</span><span class="s4">void </span><span class="s1">(*)(id</span><span class="s4">, </span><span class="s1">SEL</span><span class="s4">, </span><span class="s1">id</span><span class="s4">, </span><span class="s1">id</span><span class="s4">, </span><span class="s1">id))objc_msgSend)(self.manager</span><span class="s4">, </span><span class="s1">setter</span><span class="s4">, </span><span class="s1">json</span><span class="s4">, </span><span class="s1">view</span><span class="s4">, </span><span class="s1">_defaultView)</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">((</span><span class="s4">void </span><span class="s1">(*)(id</span><span class="s4">, </span><span class="s1">SEL</span><span class="s4">, </span><span class="s1">id</span><span class="s4">, </span><span class="s1">id))objc_msgSend)(self.manager</span><span class="s4">, </span><span class="s1">setter</span><span class="s4">, </span><span class="s1">json</span><span class="s4">, </span><span class="s1">view)</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">static </span><span class="s1">RCTPropBlock createEventSetter(</span>
    <span class="s1">NSString *propName</span><span class="s4">,</span>
    <span class="s1">SEL setter</span><span class="s4">,</span>
    <span class="s1">InterceptorBlock eventInterceptor</span><span class="s4">,</span>
    <span class="s1">id&lt;RCTEventDispatcherProtocol&gt; eventDispatcher)</span>
<span class="s1">{</span>
  <span class="s4">__weak </span><span class="s1">id&lt;RCTEventDispatcherProtocol&gt; weakEventDispatcher = eventDispatcher</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">^(id target</span><span class="s4">, </span><span class="s1">id json) {</span>
    <span class="s4">void </span><span class="s1">(^eventHandler)(NSDictionary *event) = nil</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">([RCTConvert BOOL:json]) {</span>
      <span class="s4">__weak </span><span class="s1">id&lt;RCTComponent&gt; weakTarget = target</span><span class="s4">;</span>
      <span class="s1">eventHandler = ^(NSDictionary *event) {</span>
        <span class="s0">// The component no longer exists, we shouldn't send the event</span>
        <span class="s1">id&lt;RCTComponent&gt; strongTarget = weakTarget</span><span class="s4">;</span>
        <span class="s4">if </span><span class="s1">(!strongTarget) {</span>
          <span class="s4">return;</span>
        <span class="s1">}</span>

        <span class="s4">if </span><span class="s1">(eventInterceptor) {</span>
          <span class="s1">eventInterceptor(propName</span><span class="s4">, </span><span class="s1">event</span><span class="s4">, </span><span class="s1">strongTarget.reactTag)</span><span class="s4">;</span>
        <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
          <span class="s1">RCTComponentEvent *componentEvent = [[RCTComponentEvent alloc] initWithName:propName</span>
                                                                              <span class="s1">viewTag:strongTarget.reactTag</span>
                                                                                 <span class="s1">body:event]</span><span class="s4">;</span>
          <span class="s1">[weakEventDispatcher sendEvent:componentEvent]</span><span class="s4">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">((</span><span class="s4">void </span><span class="s1">(*)(id</span><span class="s4">, </span><span class="s1">SEL</span><span class="s4">, </span><span class="s1">id))objc_msgSend)(target</span><span class="s4">, </span><span class="s1">setter</span><span class="s4">, </span><span class="s1">eventHandler)</span><span class="s4">;</span>
  <span class="s1">}</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">static </span><span class="s1">RCTPropBlock createNSInvocationSetter(NSMethodSignature *typeSignature</span><span class="s4">, </span><span class="s1">SEL type</span><span class="s4">, </span><span class="s1">SEL getter</span><span class="s4">, </span><span class="s1">SEL setter)</span>
<span class="s1">{</span>
  <span class="s1">NSInvocation *typeInvocation = [NSInvocation invocationWithMethodSignature:typeSignature]</span><span class="s4">;</span>
  <span class="s1">typeInvocation.</span><span class="s4">selector </span><span class="s1">= type</span><span class="s4">;</span>
  <span class="s1">typeInvocation.target = [RCTConvert </span><span class="s4">class</span><span class="s1">]</span><span class="s4">;</span>

  <span class="s1">__block NSInvocation *targetInvocation = nil</span><span class="s4">;</span>
  <span class="s1">__block NSMutableData *defaultValue = nil</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">^(id target</span><span class="s4">, </span><span class="s1">id json) {</span>
    <span class="s4">if </span><span class="s1">(!target) {</span>
      <span class="s4">return;</span>
    <span class="s1">}</span>

    <span class="s0">// Get default value</span>
    <span class="s4">if </span><span class="s1">(!defaultValue) {</span>
      <span class="s4">if </span><span class="s1">(!json) {</span>
        <span class="s0">// We only set the defaultValue when we first pass a non-null</span>
        <span class="s0">// value, so if the first value sent for a prop is null, it's</span>
        <span class="s0">// a no-op (we'd be resetting it to its default when its</span>
        <span class="s0">// value is already the default).</span>
        <span class="s4">return;</span>
      <span class="s1">}</span>
      <span class="s0">// Use NSMutableData to store defaultValue instead of malloc, so</span>
      <span class="s0">// it will be freed automatically when setterBlock is released.</span>
      <span class="s1">defaultValue = [[NSMutableData alloc] initWithLength:typeSignature.methodReturnLength]</span><span class="s4">;</span>
      <span class="s4">if </span><span class="s1">([target respondsToSelector:getter]) {</span>
        <span class="s1">NSMethodSignature *signature = [target methodSignatureForSelector:getter]</span><span class="s4">;</span>
        <span class="s1">NSInvocation *sourceInvocation = [NSInvocation invocationWithMethodSignature:signature]</span><span class="s4">;</span>
        <span class="s1">sourceInvocation.</span><span class="s4">selector </span><span class="s1">= getter</span><span class="s4">;</span>
        <span class="s1">[sourceInvocation invokeWithTarget:target]</span><span class="s4">;</span>
        <span class="s1">[sourceInvocation getReturnValue:defaultValue.mutableBytes]</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">// Get value</span>
    <span class="s1">BOOL freeValueOnCompletion = NO</span><span class="s4">;</span>
    <span class="s4">void </span><span class="s1">*value = defaultValue.mutableBytes</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(json) {</span>
      <span class="s1">freeValueOnCompletion = YES</span><span class="s4">;</span>
      <span class="s1">value = malloc(typeSignature.methodReturnLength)</span><span class="s4">;</span>
      <span class="s4">if </span><span class="s1">(!value) {</span>
        <span class="s0">// CWE - 391 : Unchecked error condition</span>
        <span class="s0">// https://www.cvedetails.com/cwe-details/391/Unchecked-Error-Condition.html</span>
        <span class="s0">// https://eli.thegreenplace.net/2009/10/30/handling-out-of-memory-conditions-in-c</span>
        <span class="s1">abort()</span><span class="s4">;</span>
      <span class="s1">}</span>
      <span class="s1">[typeInvocation setArgument:&amp;json atIndex:</span><span class="s5">2</span><span class="s1">]</span><span class="s4">;</span>
      <span class="s1">[typeInvocation invoke]</span><span class="s4">;</span>
      <span class="s1">[typeInvocation getReturnValue:value]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s0">// Set value</span>
    <span class="s4">if </span><span class="s1">(!targetInvocation) {</span>
      <span class="s1">NSMethodSignature *signature = [target methodSignatureForSelector:setter]</span><span class="s4">;</span>
      <span class="s1">targetInvocation = [NSInvocation invocationWithMethodSignature:signature]</span><span class="s4">;</span>
      <span class="s1">targetInvocation.</span><span class="s4">selector </span><span class="s1">= setter</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">[targetInvocation setArgument:value atIndex:</span><span class="s5">2</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">[targetInvocation invokeWithTarget:target]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(freeValueOnCompletion) {</span>
      <span class="s0">// Only free the value if we `malloc`d it locally, otherwise it</span>
      <span class="s0">// points to `defaultValue.mutableBytes`, which is managed by ARC.</span>
      <span class="s1">free(value)</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (RCTPropBlock)createPropBlock:(NSString *)name isShadowView:(BOOL)isShadowView</span>
<span class="s1">{</span>
  <span class="s0">// Get type</span>
  <span class="s1">SEL type = NULL</span><span class="s4">;</span>
  <span class="s1">NSString *keyPath = nil</span><span class="s4">;</span>
  <span class="s1">SEL </span><span class="s4">selector </span><span class="s1">=</span>
      <span class="s1">NSSelectorFromString([NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;propConfig%@_%@&quot;</span><span class="s4">, </span><span class="s1">isShadowView ? </span><span class="s4">@</span><span class="s3">&quot;Shadow&quot; </span><span class="s1">: </span><span class="s4">@</span><span class="s3">&quot;&quot;</span><span class="s4">, </span><span class="s1">name])</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">([_managerClass respondsToSelector:</span><span class="s4">selector</span><span class="s1">]) {</span>
    <span class="s1">NSArray&lt;NSString *&gt; *typeAndKeyPath = ((NSArray&lt;NSString *&gt; * (*)(id</span><span class="s4">, </span><span class="s1">SEL)) objc_msgSend)(_managerClass</span><span class="s4">, selector</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">type = selectorForType(typeAndKeyPath[</span><span class="s5">0</span><span class="s1">])</span><span class="s4">;</span>
    <span class="s1">keyPath = typeAndKeyPath.count &gt; </span><span class="s5">1 </span><span class="s1">? typeAndKeyPath[</span><span class="s5">1</span><span class="s1">] : nil</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s4">return </span><span class="s1">^(__unused id view</span><span class="s4">, </span><span class="s1">__unused id json) {</span>
    <span class="s1">}</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// Check for custom setter</span>
  <span class="s4">if </span><span class="s1">([keyPath isEqualToString:</span><span class="s4">@</span><span class="s3">&quot;__custom__&quot;</span><span class="s1">]) {</span>
    <span class="s0">// Get custom setter. There is no default view in the shadow case, so the selector is different.</span>
    <span class="s1">NSString *selectorString</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(!isShadowView) {</span>
      <span class="s1">selectorString =</span>
          <span class="s1">[NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;set_%@:for%@View:withDefaultView:&quot;</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">isShadowView ? </span><span class="s4">@</span><span class="s3">&quot;Shadow&quot; </span><span class="s1">: </span><span class="s4">@</span><span class="s3">&quot;&quot;</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s1">selectorString = [NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;set_%@:forShadowView:&quot;</span><span class="s4">, </span><span class="s1">name]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">SEL customSetter = NSSelectorFromString(selectorString)</span><span class="s4">;</span>
    <span class="s4">__weak </span><span class="s1">RCTComponentData *weakSelf = self</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">^(id&lt;RCTComponent&gt; view</span><span class="s4">, </span><span class="s1">id json) {</span>
      <span class="s1">[weakSelf callCustomSetter:customSetter onView:view withProp:json isShadowView:isShadowView]</span><span class="s4">;</span>
    <span class="s1">}</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s0">// Disect keypath</span>
    <span class="s1">NSString *key = name</span><span class="s4">;</span>
    <span class="s1">NSArray&lt;NSString *&gt; *parts = [keyPath componentsSeparatedByString:</span><span class="s4">@</span><span class="s3">&quot;.&quot;</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(parts) {</span>
      <span class="s1">key = parts.lastObject</span><span class="s4">;</span>
      <span class="s1">parts = [parts subarrayWithRange:(NSRange){</span><span class="s5">0</span><span class="s4">, </span><span class="s1">parts.count - </span><span class="s5">1</span><span class="s1">}]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s0">// Get property getter</span>
    <span class="s1">SEL getter = NSSelectorFromString(key)</span><span class="s4">;</span>

    <span class="s0">// Get property setter</span>
    <span class="s1">SEL setter = NSSelectorFromString(</span>
        <span class="s1">[NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;set%@%@:&quot;</span><span class="s4">, </span><span class="s1">[key substringToIndex:</span><span class="s5">1</span><span class="s1">].uppercaseString</span><span class="s4">, </span><span class="s1">[key substringFromIndex:</span><span class="s5">1</span><span class="s1">]])</span><span class="s4">;</span>

    <span class="s0">// Build setter block</span>
    <span class="s4">void </span><span class="s1">(^setterBlock)(id target</span><span class="s4">, </span><span class="s1">id json) = nil</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(type == NSSelectorFromString(</span><span class="s4">@</span><span class="s3">&quot;RCTBubblingEventBlock:&quot;</span><span class="s1">) ||</span>
        <span class="s1">type == NSSelectorFromString(</span><span class="s4">@</span><span class="s3">&quot;RCTDirectEventBlock:&quot;</span><span class="s1">) ||</span>
        <span class="s1">type == NSSelectorFromString(</span><span class="s4">@</span><span class="s3">&quot;RCTCapturingEventBlock:&quot;</span><span class="s1">)) {</span>
      <span class="s0">// Special case for event handlers</span>
      <span class="s1">setterBlock =</span>
          <span class="s1">createEventSetter(name</span><span class="s4">, </span><span class="s1">setter</span><span class="s4">, </span><span class="s1">self.eventInterceptor</span><span class="s4">, </span><span class="s1">_bridge ? _bridge.eventDispatcher : _eventDispatcher)</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s0">// Ordinary property handlers</span>
      <span class="s1">NSMethodSignature *typeSignature = [[RCTConvert </span><span class="s4">class</span><span class="s1">] methodSignatureForSelector:type]</span><span class="s4">;</span>
      <span class="s4">if </span><span class="s1">(!typeSignature) {</span>
        <span class="s1">RCTLogError(</span><span class="s4">@</span><span class="s3">&quot;No +[RCTConvert %@] function found.&quot;</span><span class="s4">, </span><span class="s1">NSStringFromSelector(type))</span><span class="s4">;</span>
        <span class="s4">return </span><span class="s1">^(__unused id&lt;RCTComponent&gt; view</span><span class="s4">, </span><span class="s1">__unused id json) {</span>
        <span class="s1">}</span><span class="s4">;</span>
      <span class="s1">}</span>
      <span class="s4">switch </span><span class="s1">(typeSignature.methodReturnType[</span><span class="s5">0</span><span class="s1">]) {</span>
<span class="s2">#define </span><span class="s1">RCT_CASE(_value</span><span class="s4">, </span><span class="s1">_type)                                       \ 
  </span><span class="s4">case </span><span class="s1">_value: {                                                      \ 
    __block BOOL setDefaultValue = NO</span><span class="s4">;                                </span><span class="s1">\ 
    __block _type defaultValue</span><span class="s4">;                                       </span><span class="s1">\ 
    _type (*convert)(id</span><span class="s4">, </span><span class="s1">SEL</span><span class="s4">, </span><span class="s1">id) = (</span><span class="s4">typeof</span><span class="s1">(convert))objc_msgSend</span><span class="s4">;    </span><span class="s1">\ 
    _type (*get)(id</span><span class="s4">, </span><span class="s1">SEL) = (</span><span class="s4">typeof</span><span class="s1">(get))objc_msgSend</span><span class="s4">;                </span><span class="s1">\ 
    </span><span class="s4">void </span><span class="s1">(*set)(id</span><span class="s4">, </span><span class="s1">SEL</span><span class="s4">, </span><span class="s1">_type) = (</span><span class="s4">typeof</span><span class="s1">(set))objc_msgSend</span><span class="s4">;          </span><span class="s1">\ 
    setterBlock = ^(id target</span><span class="s4">, </span><span class="s1">id json) {                             \ 
      </span><span class="s4">if </span><span class="s1">(json) {                                                     \ 
        </span><span class="s4">if </span><span class="s1">(!setDefaultValue &amp;&amp; target) {                             \ 
          </span><span class="s4">if </span><span class="s1">([target respondsToSelector:getter]) {                   \ 
            defaultValue = get(target</span><span class="s4">, </span><span class="s1">getter)</span><span class="s4">;                       </span><span class="s1">\ 
          }                                                           \ 
          setDefaultValue = YES</span><span class="s4">;                                      </span><span class="s1">\ 
        }                                                             \ 
        set(target</span><span class="s4">, </span><span class="s1">setter</span><span class="s4">, </span><span class="s1">convert([RCTConvert </span><span class="s4">class</span><span class="s1">]</span><span class="s4">, </span><span class="s1">type</span><span class="s4">, </span><span class="s1">json))</span><span class="s4">; </span><span class="s1">\ 
      } </span><span class="s4">else if </span><span class="s1">(setDefaultValue) {                                   \ 
        set(target</span><span class="s4">, </span><span class="s1">setter</span><span class="s4">, </span><span class="s1">defaultValue)</span><span class="s4">;                            </span><span class="s1">\ 
      }                                                               \ 
    }</span><span class="s4">;                                                                </span><span class="s1">\ 
    </span><span class="s4">break;                                                            </span><span class="s1">\ 
  }</span>

        <span class="s1">RCT_CASE(_C_SEL</span><span class="s4">, </span><span class="s1">SEL)</span>
        <span class="s1">RCT_CASE(_C_CHARPTR</span><span class="s4">, const char </span><span class="s1">*)</span>
        <span class="s1">RCT_CASE(_C_CHR</span><span class="s4">, char</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_UCHR</span><span class="s4">, unsigned char</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_SHT</span><span class="s4">, short</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_USHT</span><span class="s4">, unsigned short</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_INT</span><span class="s4">, int</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_UINT</span><span class="s4">, unsigned int</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_LNG</span><span class="s4">, long</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_ULNG</span><span class="s4">, unsigned long</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_LNG_LNG</span><span class="s4">, long long</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_ULNG_LNG</span><span class="s4">, unsigned long long</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_FLT</span><span class="s4">, float</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_DBL</span><span class="s4">, double</span><span class="s1">)</span>
        <span class="s1">RCT_CASE(_C_BOOL</span><span class="s4">, </span><span class="s1">BOOL)</span>
        <span class="s1">RCT_CASE(_C_PTR</span><span class="s4">, void </span><span class="s1">*)</span>
        <span class="s1">RCT_CASE(_C_ID</span><span class="s4">, </span><span class="s1">id)</span>

        <span class="s4">case </span><span class="s1">_C_STRUCT_B:</span>
        <span class="s4">default</span><span class="s1">: {</span>
          <span class="s1">setterBlock = createNSInvocationSetter(typeSignature</span><span class="s4">, </span><span class="s1">type</span><span class="s4">, </span><span class="s1">getter</span><span class="s4">, </span><span class="s1">setter)</span><span class="s4">;</span>
          <span class="s4">break;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">^(__unused id view</span><span class="s4">, </span><span class="s1">__unused id json) {</span>
      <span class="s0">// Follow keypath</span>
      <span class="s1">id target = view</span><span class="s4">;</span>
      <span class="s4">for </span><span class="s1">(NSString *part in parts) {</span>
        <span class="s1">target = [target valueForKey:part]</span><span class="s4">;</span>
      <span class="s1">}</span>

      <span class="s0">// Set property with json</span>
      <span class="s1">setterBlock(target</span><span class="s4">, </span><span class="s1">RCTNilIfNull(json))</span><span class="s4">;</span>
    <span class="s1">}</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">- (RCTPropBlock)propBlockForKey:(NSString *)name isShadowView:(BOOL)isShadowView</span>
<span class="s1">{</span>
  <span class="s1">RCTPropBlockDictionary *propBlocks = isShadowView ? _shadowPropBlocks : _viewPropBlocks</span><span class="s4">;</span>
  <span class="s1">RCTPropBlock propBlock = propBlocks[name]</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(!propBlock) {</span>
    <span class="s1">propBlock = [self createPropBlock:name isShadowView:isShadowView]</span><span class="s4">;</span>

<span class="s2">#if </span><span class="s1">RCT_DEBUG</span>
    <span class="s0">// Provide more useful log feedback if there's an error</span>
    <span class="s1">RCTPropBlock unwrappedBlock = propBlock</span><span class="s4">;</span>
    <span class="s4">__weak __typeof</span><span class="s1">(self) weakSelf = self</span><span class="s4">;</span>
    <span class="s1">propBlock = ^(id&lt;RCTComponent&gt; view</span><span class="s4">, </span><span class="s1">id json) {</span>
      <span class="s1">NSString *logPrefix = [NSString</span>
          <span class="s1">stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;Error setting property '%@' of %@ with tag #%@: &quot;</span><span class="s4">, </span><span class="s1">name</span><span class="s4">, </span><span class="s1">weakSelf.name</span><span class="s4">, </span><span class="s1">view.reactTag]</span><span class="s4">;</span>
      <span class="s1">RCTPerformBlockWithLogPrefix(</span>
          <span class="s1">^{</span>
            <span class="s1">unwrappedBlock(view</span><span class="s4">, </span><span class="s1">json)</span><span class="s4">;</span>
          <span class="s1">}</span><span class="s4">,</span>
          <span class="s1">logPrefix)</span><span class="s4">;</span>
    <span class="s1">}</span><span class="s4">;</span>
<span class="s2">#endif</span>
    <span class="s1">propBlocks[name] = [propBlock copy]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">propBlock</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setProps:(NSDictionary&lt;NSString *</span><span class="s4">, </span><span class="s1">id&gt; *)props forView:(id&lt;RCTComponent&gt;)view</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(!view) {</span>
    <span class="s4">return;</span>
  <span class="s1">}</span>

  <span class="s1">[props enumerateKeysAndObjectsUsingBlock:^(NSString *key</span><span class="s4">, </span><span class="s1">id json</span><span class="s4">, </span><span class="s1">__unused BOOL *stop) {</span>
    <span class="s1">[self propBlockForKey:key isShadowView:NO](view</span><span class="s4">, </span><span class="s1">json)</span><span class="s4">;</span>
  <span class="s1">}]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setProps:(NSDictionary&lt;NSString *</span><span class="s4">, </span><span class="s1">id&gt; *)props forShadowView:(RCTShadowView *)shadowView</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(!shadowView) {</span>
    <span class="s4">return;</span>
  <span class="s1">}</span>

  <span class="s1">[props enumerateKeysAndObjectsUsingBlock:^(NSString *key</span><span class="s4">, </span><span class="s1">id json</span><span class="s4">, </span><span class="s1">__unused BOOL *stop) {</span>
    <span class="s1">[self propBlockForKey:key isShadowView:YES](shadowView</span><span class="s4">, </span><span class="s1">json)</span><span class="s4">;</span>
  <span class="s1">}]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (NSDictionary&lt;NSString *</span><span class="s4">, </span><span class="s1">id&gt; *)viewConfig</span>
<span class="s1">{</span>
  <span class="s1">NSMutableArray&lt;NSString *&gt; *bubblingEvents = [NSMutableArray new]</span><span class="s4">;</span>
  <span class="s1">NSMutableArray&lt;NSString *&gt; *capturingEvents = [NSMutableArray new]</span><span class="s4">;</span>
  <span class="s1">NSMutableArray&lt;NSString *&gt; *directEvents = [NSMutableArray new]</span><span class="s4">;</span>

<span class="s2">#pragma </span><span class="s1">clang diagnostic push</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic ignored </span><span class="s3">&quot;-Wdeprecated-declarations&quot;</span>
  <span class="s4">if </span><span class="s1">(RCTClassOverridesInstanceMethod(_managerClass</span><span class="s4">, @selector</span><span class="s1">(customBubblingEventTypes))) {</span>
    <span class="s1">NSArray&lt;NSString *&gt; *events = [self.manager customBubblingEventTypes]</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(NSString *event in events) {</span>
      <span class="s1">[bubblingEvents addObject:RCTNormalizeInputEventName(event)]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic pop</span>

  <span class="s4">unsigned int </span><span class="s1">count = </span><span class="s5">0</span><span class="s4">;</span>
  <span class="s1">NSMutableDictionary *propTypes = [NSMutableDictionary new]</span><span class="s4">;</span>
  <span class="s1">Method *methods = class_copyMethodList(object_getClass(_managerClass)</span><span class="s4">, </span><span class="s1">&amp;count)</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(</span><span class="s4">unsigned int </span><span class="s1">i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; count</span><span class="s4">; </span><span class="s1">i++) {</span>
    <span class="s1">SEL </span><span class="s4">selector </span><span class="s1">= method_getName(methods[i])</span><span class="s4">;</span>
    <span class="s4">const char </span><span class="s1">*selectorName = sel_getName(</span><span class="s4">selector</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(strncmp(selectorName</span><span class="s4">, </span><span class="s3">&quot;propConfig&quot;</span><span class="s4">, </span><span class="s1">strlen(</span><span class="s3">&quot;propConfig&quot;</span><span class="s1">)) != </span><span class="s5">0</span><span class="s1">) {</span>
      <span class="s4">continue;</span>
    <span class="s1">}</span>

    <span class="s0">// We need to handle both propConfig_* and propConfigShadow_* methods</span>
    <span class="s4">const char </span><span class="s1">*underscorePos = strchr(selectorName + strlen(</span><span class="s3">&quot;propConfig&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s3">'_'</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(!underscorePos) {</span>
      <span class="s4">continue;</span>
    <span class="s1">}</span>

    <span class="s1">NSString *name = </span><span class="s4">@</span><span class="s1">(underscorePos + </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">NSString *type = ((NSArray&lt;NSString *&gt; * (*)(id</span><span class="s4">, </span><span class="s1">SEL)) objc_msgSend)(_managerClass</span><span class="s4">, selector</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(RCT_DEBUG &amp;&amp; propTypes[name] &amp;&amp; ![propTypes[name] isEqualToString:type]) {</span>
      <span class="s1">RCTLogError(</span>
          <span class="s4">@</span><span class="s3">&quot;Property '%@' of component '%@' redefined from '%@' &quot;</span>
           <span class="s3">&quot;to '%@'&quot;</span><span class="s4">,</span>
          <span class="s1">name</span><span class="s4">,</span>
          <span class="s1">_name</span><span class="s4">,</span>
          <span class="s1">propTypes[name]</span><span class="s4">,</span>
          <span class="s1">type)</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s4">if </span><span class="s1">([type isEqualToString:</span><span class="s4">@</span><span class="s3">&quot;RCTBubblingEventBlock&quot;</span><span class="s1">]) {</span>
      <span class="s1">[bubblingEvents addObject:RCTNormalizeInputEventName(name)]</span><span class="s4">;</span>
      <span class="s1">propTypes[name] = </span><span class="s4">@</span><span class="s3">&quot;BOOL&quot;</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">([type isEqualToString:</span><span class="s4">@</span><span class="s3">&quot;RCTCapturingEventBlock&quot;</span><span class="s1">]) {</span>
      <span class="s1">[capturingEvents addObject:RCTNormalizeInputEventName(name)]</span><span class="s4">;</span>
      <span class="s1">propTypes[name] = </span><span class="s4">@</span><span class="s3">&quot;BOOL&quot;</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else if </span><span class="s1">([type isEqualToString:</span><span class="s4">@</span><span class="s3">&quot;RCTDirectEventBlock&quot;</span><span class="s1">]) {</span>
      <span class="s1">[directEvents addObject:RCTNormalizeInputEventName(name)]</span><span class="s4">;</span>
      <span class="s1">propTypes[name] = </span><span class="s4">@</span><span class="s3">&quot;BOOL&quot;</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s1">propTypes[name] = type</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s1">free(methods)</span><span class="s4">;</span>

<span class="s2">#if </span><span class="s1">RCT_DEBUG</span>
  <span class="s4">for </span><span class="s1">(NSString *event in bubblingEvents) {</span>
    <span class="s4">if </span><span class="s1">([directEvents containsObject:event]) {</span>
      <span class="s1">RCTLogError(</span>
          <span class="s4">@</span><span class="s3">&quot;Component '%@' registered '%@' as both a bubbling event &quot;</span>
           <span class="s3">&quot;and a direct event&quot;</span><span class="s4">,</span>
          <span class="s1">_name</span><span class="s4">,</span>
          <span class="s1">event)</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s2">#endif</span>

  <span class="s1">Class superClass = [_managerClass superclass]</span><span class="s4">;</span>

  <span class="s4">return @</span><span class="s1">{</span>
    <span class="s4">@</span><span class="s3">&quot;propTypes&quot; </span><span class="s1">: propTypes</span><span class="s4">,</span>
    <span class="s4">@</span><span class="s3">&quot;directEvents&quot; </span><span class="s1">: directEvents</span><span class="s4">,</span>
    <span class="s4">@</span><span class="s3">&quot;bubblingEvents&quot; </span><span class="s1">: bubblingEvents</span><span class="s4">,</span>
    <span class="s4">@</span><span class="s3">&quot;capturingEvents&quot; </span><span class="s1">: capturingEvents</span><span class="s4">,</span>
    <span class="s4">@</span><span class="s3">&quot;baseModuleName&quot; </span><span class="s1">: superClass == [NSObject </span><span class="s4">class</span><span class="s1">] ? (id)kCFNull : moduleNameForClass(superClass)</span><span class="s4">,</span>
  <span class="s1">}</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">static </span><span class="s1">NSString *moduleNameForClass(Class managerClass)</span>
<span class="s1">{</span>
  <span class="s0">// Hackety hack, this partially re-implements RCTBridgeModuleNameForClass</span>
  <span class="s0">// We want to get rid of RCT and RK prefixes, but a lot of JS code still references</span>
  <span class="s0">// view names by prefix. So, while RCTBridgeModuleNameForClass now drops these</span>
  <span class="s0">// prefixes by default, we'll still keep them around here.</span>
  <span class="s1">NSString *name = [managerClass moduleName]</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(name.length == </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s1">name = NSStringFromClass(managerClass)</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">if </span><span class="s1">([name hasPrefix:</span><span class="s4">@</span><span class="s3">&quot;RK&quot;</span><span class="s1">]) {</span>
    <span class="s1">name = [name stringByReplacingCharactersInRange:(NSRange){</span><span class="s5">0</span><span class="s4">, @</span><span class="s3">&quot;RK&quot;</span><span class="s1">.length} withString:</span><span class="s4">@</span><span class="s3">&quot;RCT&quot;</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">if </span><span class="s1">([name hasSuffix:</span><span class="s4">@</span><span class="s3">&quot;Manager&quot;</span><span class="s1">]) {</span>
    <span class="s1">name = [name substringToIndex:name.length - </span><span class="s4">@</span><span class="s3">&quot;Manager&quot;</span><span class="s1">.length]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">RCTAssert(name.length</span><span class="s4">, @</span><span class="s3">&quot;Invalid moduleName '%@'&quot;</span><span class="s4">, </span><span class="s1">name)</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">name</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>
</pre>
</body>
</html>