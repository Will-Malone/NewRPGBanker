<html>
<head>
<title>js-yaml.mjs</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
.s1 { color: #808080;}
.s2 { color: #cc7832;}
.s3 { color: #a9b7c6;}
.s4 { color: #6a8759;}
.s5 { color: #9876aa; font-style: italic;}
.s6 { color: #ffc66d;}
.s7 { color: #6897bb; font-style: italic;}
.s8 { color: #cc7832; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
js-yaml.mjs</font>
</center></td></tr></table>
<pre>
<span class="s1">/*! js-yaml 4.1.0 https://github.com/nodeca/js-yaml @license MIT */</span>
<span class="s2">function </span><span class="s0">isNothing(</span><span class="s3">subject</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">subject </span><span class="s2">=== </span><span class="s4">'undefined'</span><span class="s0">) </span><span class="s2">|| </span><span class="s0">(</span><span class="s3">subject </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">isObject(</span><span class="s3">subject</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">subject </span><span class="s2">=== </span><span class="s4">'object'</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">subject </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">toArray(</span><span class="s3">sequence</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">sequence</span><span class="s0">)) </span><span class="s2">return </span><span class="s3">sequence</span><span class="s0">;</span>
  <span class="s2">else if </span><span class="s0">(</span><span class="s6">isNothing</span><span class="s0">(</span><span class="s3">sequence</span><span class="s0">)) </span><span class="s2">return </span><span class="s0">[];</span>

  <span class="s2">return </span><span class="s0">[ </span><span class="s3">sequence </span><span class="s0">];</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">extend(</span><span class="s3">target</span><span class="s0">, </span><span class="s3">source</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">index, length, key, sourceKeys;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">source</span><span class="s0">) {</span>
    <span class="s3">sourceKeys </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">source</span><span class="s0">);</span>

    <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">sourceKeys</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s3">key </span><span class="s2">= </span><span class="s3">sourceKeys</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
      <span class="s3">target</span><span class="s0">[</span><span class="s3">key</span><span class="s0">] </span><span class="s2">= </span><span class="s3">source</span><span class="s0">[</span><span class="s3">key</span><span class="s0">];</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">target</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">repeat(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">count</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">, cycle;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">cycle </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">cycle </span><span class="s2">&lt; </span><span class="s3">count</span><span class="s0">; </span><span class="s3">cycle </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">string</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">isNegativeZero(</span><span class="s3">number</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s3">number </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">Number</span><span class="s0">.NEGATIVE_INFINITY </span><span class="s2">=== </span><span class="s7">1 </span><span class="s2">/ </span><span class="s3">number</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s2">var </span><span class="s0">isNothing_1      </span><span class="s2">= </span><span class="s3">isNothing</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">isObject_1       </span><span class="s2">= </span><span class="s3">isObject</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">toArray_1        </span><span class="s2">= </span><span class="s3">toArray</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">repeat_1         </span><span class="s2">= </span><span class="s3">repeat</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">isNegativeZero_1 </span><span class="s2">= </span><span class="s3">isNegativeZero</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">extend_1         </span><span class="s2">= </span><span class="s3">extend</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">common </span><span class="s2">= </span><span class="s0">{</span>
	<span class="s0">isNothing: </span><span class="s3">isNothing_1</span><span class="s0">,</span>
	<span class="s0">isObject: </span><span class="s3">isObject_1</span><span class="s0">,</span>
	<span class="s0">toArray: </span><span class="s3">toArray_1</span><span class="s0">,</span>
	<span class="s0">repeat: </span><span class="s3">repeat_1</span><span class="s0">,</span>
	<span class="s0">isNegativeZero: </span><span class="s3">isNegativeZero_1</span><span class="s0">,</span>
	<span class="s0">extend: </span><span class="s3">extend_1</span>
<span class="s0">};</span>

<span class="s1">// YAML error class. http://stackoverflow.com/questions/8458984</span>


<span class="s2">function </span><span class="s0">formatError(</span><span class="s3">exception</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">where </span><span class="s2">= </span><span class="s4">''</span><span class="s0">, message </span><span class="s2">= </span><span class="s3">exception</span><span class="s0">.</span><span class="s3">reason </span><span class="s2">|| </span><span class="s4">'(unknown reason)'</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">exception</span><span class="s0">.</span><span class="s3">mark</span><span class="s0">) </span><span class="s2">return </span><span class="s3">message</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">exception</span><span class="s0">.</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">name</span><span class="s0">) {</span>
    <span class="s3">where </span><span class="s2">+= </span><span class="s4">'in &quot;' </span><span class="s2">+ </span><span class="s3">exception</span><span class="s0">.</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">name </span><span class="s2">+ </span><span class="s4">'&quot; '</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">where </span><span class="s2">+= </span><span class="s4">'(' </span><span class="s2">+ </span><span class="s0">(</span><span class="s3">exception</span><span class="s0">.</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">line </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">) </span><span class="s2">+ </span><span class="s4">':' </span><span class="s2">+ </span><span class="s0">(</span><span class="s3">exception</span><span class="s0">.</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">column </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">) </span><span class="s2">+ </span><span class="s4">')'</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">compact </span><span class="s2">&amp;&amp; </span><span class="s3">exception</span><span class="s0">.</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">snippet</span><span class="s0">) {</span>
    <span class="s3">where </span><span class="s2">+= </span><span class="s4">'</span><span class="s8">\n\n</span><span class="s4">' </span><span class="s2">+ </span><span class="s3">exception</span><span class="s0">.</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">snippet</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">message </span><span class="s2">+ </span><span class="s4">' ' </span><span class="s2">+ </span><span class="s3">where</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">YAMLException$1(</span><span class="s3">reason</span><span class="s0">, </span><span class="s3">mark</span><span class="s0">) {</span>
  <span class="s1">// Super constructor</span>
  <span class="s3">Error</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">this</span><span class="s0">);</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">name </span><span class="s2">= </span><span class="s4">'YAMLException'</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">reason </span><span class="s2">= </span><span class="s3">reason</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">mark </span><span class="s2">= </span><span class="s3">mark</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">message </span><span class="s2">= </span><span class="s6">formatError</span><span class="s0">(</span><span class="s3">this</span><span class="s0">, </span><span class="s5">false</span><span class="s0">);</span>

  <span class="s1">// Include stack trace in error object</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">Error</span><span class="s0">.</span><span class="s3">captureStackTrace</span><span class="s0">) {</span>
    <span class="s1">// Chrome and NodeJS</span>
    <span class="s3">Error</span><span class="s0">.</span><span class="s6">captureStackTrace</span><span class="s0">(</span><span class="s3">this</span><span class="s0">, </span><span class="s3">this</span><span class="s0">.constructor);</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s1">// FF, IE 10+ and Safari 6+. Fallback for others</span>
    <span class="s3">this</span><span class="s0">.</span><span class="s3">stack </span><span class="s2">= </span><span class="s0">(</span><span class="s2">new </span><span class="s6">Error</span><span class="s0">()).</span><span class="s3">stack </span><span class="s2">|| </span><span class="s4">''</span><span class="s0">;</span>
  <span class="s0">}</span>
<span class="s0">}</span>


<span class="s1">// Inherit from Error</span>
<span class="s0">YAMLException$1.prototype </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">create</span><span class="s0">(Error.prototype);</span>
<span class="s0">YAMLException$1.prototype.constructor </span><span class="s2">= </span><span class="s3">YAMLException$1</span><span class="s0">;</span>


<span class="s0">YAMLException$1.prototype.</span><span class="s6">toString </span><span class="s2">= function </span><span class="s0">toString(</span><span class="s3">compact</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">this</span><span class="s0">.</span><span class="s3">name </span><span class="s2">+ </span><span class="s4">': ' </span><span class="s2">+ </span><span class="s6">formatError</span><span class="s0">(</span><span class="s3">this</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">);</span>
<span class="s0">};</span>


<span class="s2">var </span><span class="s0">exception </span><span class="s2">= </span><span class="s3">YAMLException$1</span><span class="s0">;</span>

<span class="s1">// get snippet for a single line, respecting maxLength</span>
<span class="s2">function </span><span class="s0">getLine(</span><span class="s3">buffer</span><span class="s0">, </span><span class="s3">lineStart</span><span class="s0">, </span><span class="s3">lineEnd</span><span class="s0">, </span><span class="s3">position</span><span class="s0">, </span><span class="s3">maxLineLength</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">head </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">tail </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">maxHalfLength </span><span class="s2">= </span><span class="s3">Math</span><span class="s0">.</span><span class="s6">floor</span><span class="s0">(</span><span class="s3">maxLineLength </span><span class="s2">/ </span><span class="s7">2</span><span class="s0">) </span><span class="s2">- </span><span class="s7">1</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">position </span><span class="s2">- </span><span class="s3">lineStart </span><span class="s2">&gt; </span><span class="s3">maxHalfLength</span><span class="s0">) {</span>
    <span class="s3">head </span><span class="s2">= </span><span class="s4">' ... '</span><span class="s0">;</span>
    <span class="s3">lineStart </span><span class="s2">= </span><span class="s3">position </span><span class="s2">- </span><span class="s3">maxHalfLength </span><span class="s2">+ </span><span class="s3">head</span><span class="s0">.length;</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">lineEnd </span><span class="s2">- </span><span class="s3">position </span><span class="s2">&gt; </span><span class="s3">maxHalfLength</span><span class="s0">) {</span>
    <span class="s3">tail </span><span class="s2">= </span><span class="s4">' ...'</span><span class="s0">;</span>
    <span class="s3">lineEnd </span><span class="s2">= </span><span class="s3">position </span><span class="s2">+ </span><span class="s3">maxHalfLength </span><span class="s2">- </span><span class="s3">tail</span><span class="s0">.length;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s0">{</span>
    <span class="s0">str: </span><span class="s3">head </span><span class="s2">+ </span><span class="s3">buffer</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">lineStart</span><span class="s0">, </span><span class="s3">lineEnd</span><span class="s0">).</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">/</span><span class="s5">\t</span><span class="s4">/</span><span class="s2">g</span><span class="s0">, </span><span class="s4">'→'</span><span class="s0">) </span><span class="s2">+ </span><span class="s3">tail</span><span class="s0">,</span>
    <span class="s0">pos: </span><span class="s3">position </span><span class="s2">- </span><span class="s3">lineStart </span><span class="s2">+ </span><span class="s3">head</span><span class="s0">.length </span><span class="s1">// relative position</span>
  <span class="s0">};</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">padStart(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">max</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">' '</span><span class="s0">, </span><span class="s3">max </span><span class="s2">- </span><span class="s3">string</span><span class="s0">.length) </span><span class="s2">+ </span><span class="s3">string</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">makeSnippet(</span><span class="s3">mark</span><span class="s0">, </span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s3">options </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">create</span><span class="s0">(</span><span class="s3">options </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">buffer</span><span class="s0">) </span><span class="s2">return </span><span class="s5">null</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">options</span><span class="s0">.</span><span class="s3">maxLength</span><span class="s0">) </span><span class="s3">options</span><span class="s0">.</span><span class="s3">maxLength </span><span class="s2">= </span><span class="s7">79</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">options</span><span class="s0">.</span><span class="s3">indent      </span><span class="s2">!== </span><span class="s4">'number'</span><span class="s0">) </span><span class="s3">options</span><span class="s0">.</span><span class="s3">indent      </span><span class="s2">= </span><span class="s7">1</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">options</span><span class="s0">.</span><span class="s3">linesBefore </span><span class="s2">!== </span><span class="s4">'number'</span><span class="s0">) </span><span class="s3">options</span><span class="s0">.</span><span class="s3">linesBefore </span><span class="s2">= </span><span class="s7">3</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">options</span><span class="s0">.</span><span class="s3">linesAfter  </span><span class="s2">!== </span><span class="s4">'number'</span><span class="s0">) </span><span class="s3">options</span><span class="s0">.</span><span class="s3">linesAfter  </span><span class="s2">= </span><span class="s7">2</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">re </span><span class="s2">= </span><span class="s4">/</span><span class="s5">\r</span><span class="s2">?</span><span class="s5">\n</span><span class="s2">|</span><span class="s5">\r</span><span class="s2">|</span><span class="s8">\0</span><span class="s4">/</span><span class="s2">g</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">lineStarts </span><span class="s2">= </span><span class="s0">[ </span><span class="s7">0 </span><span class="s0">];</span>
  <span class="s2">var </span><span class="s0">lineEnds </span><span class="s2">= </span><span class="s0">[];</span>
  <span class="s2">var </span><span class="s0">match;</span>
  <span class="s2">var </span><span class="s0">foundLineNo </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">((</span><span class="s3">match </span><span class="s2">= </span><span class="s3">re</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">buffer</span><span class="s0">))) {</span>
    <span class="s3">lineEnds</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">match</span><span class="s0">.</span><span class="s3">index</span><span class="s0">);</span>
    <span class="s3">lineStarts</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">match</span><span class="s0">.</span><span class="s3">index </span><span class="s2">+ </span><span class="s3">match</span><span class="s0">[</span><span class="s7">0</span><span class="s0">].length);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">position </span><span class="s2">&lt;= </span><span class="s3">match</span><span class="s0">.</span><span class="s3">index </span><span class="s2">&amp;&amp; </span><span class="s3">foundLineNo </span><span class="s2">&lt; </span><span class="s7">0</span><span class="s0">) {</span>
      <span class="s3">foundLineNo </span><span class="s2">= </span><span class="s3">lineStarts</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">2</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">foundLineNo </span><span class="s2">&lt; </span><span class="s7">0</span><span class="s0">) </span><span class="s3">foundLineNo </span><span class="s2">= </span><span class="s3">lineStarts</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">, i, line;</span>
  <span class="s2">var </span><span class="s0">lineNoLength </span><span class="s2">= </span><span class="s3">Math</span><span class="s0">.</span><span class="s6">min</span><span class="s0">(</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">line </span><span class="s2">+ </span><span class="s3">options</span><span class="s0">.</span><span class="s3">linesAfter</span><span class="s0">, </span><span class="s3">lineEnds</span><span class="s0">.length).</span><span class="s6">toString</span><span class="s0">().length;</span>
  <span class="s2">var </span><span class="s0">maxLineLength </span><span class="s2">= </span><span class="s3">options</span><span class="s0">.</span><span class="s3">maxLength </span><span class="s2">- </span><span class="s0">(</span><span class="s3">options</span><span class="s0">.</span><span class="s3">indent </span><span class="s2">+ </span><span class="s3">lineNoLength </span><span class="s2">+ </span><span class="s7">3</span><span class="s0">);</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">i </span><span class="s2">= </span><span class="s7">1</span><span class="s0">; </span><span class="s3">i </span><span class="s2">&lt;= </span><span class="s3">options</span><span class="s0">.</span><span class="s3">linesBefore</span><span class="s0">; </span><span class="s3">i</span><span class="s2">++</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">foundLineNo </span><span class="s2">- </span><span class="s3">i </span><span class="s2">&lt; </span><span class="s7">0</span><span class="s0">) </span><span class="s2">break</span><span class="s0">;</span>
    <span class="s3">line </span><span class="s2">= </span><span class="s6">getLine</span><span class="s0">(</span>
      <span class="s3">mark</span><span class="s0">.</span><span class="s3">buffer</span><span class="s0">,</span>
      <span class="s3">lineStarts</span><span class="s0">[</span><span class="s3">foundLineNo </span><span class="s2">- </span><span class="s3">i</span><span class="s0">],</span>
      <span class="s3">lineEnds</span><span class="s0">[</span><span class="s3">foundLineNo </span><span class="s2">- </span><span class="s3">i</span><span class="s0">],</span>
      <span class="s3">mark</span><span class="s0">.</span><span class="s3">position </span><span class="s2">- </span><span class="s0">(</span><span class="s3">lineStarts</span><span class="s0">[</span><span class="s3">foundLineNo</span><span class="s0">] </span><span class="s2">- </span><span class="s3">lineStarts</span><span class="s0">[</span><span class="s3">foundLineNo </span><span class="s2">- </span><span class="s3">i</span><span class="s0">]),</span>
      <span class="s3">maxLineLength</span>
    <span class="s0">);</span>
    <span class="s3">result </span><span class="s2">= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">' '</span><span class="s0">, </span><span class="s3">options</span><span class="s0">.</span><span class="s3">indent</span><span class="s0">) </span><span class="s2">+ </span><span class="s6">padStart</span><span class="s0">((</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">line </span><span class="s2">- </span><span class="s3">i </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">).</span><span class="s6">toString</span><span class="s0">(), </span><span class="s3">lineNoLength</span><span class="s0">) </span><span class="s2">+</span>
      <span class="s4">' | ' </span><span class="s2">+ </span><span class="s3">line</span><span class="s0">.</span><span class="s3">str </span><span class="s2">+ </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">+ </span><span class="s3">result</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">line </span><span class="s2">= </span><span class="s6">getLine</span><span class="s0">(</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">buffer</span><span class="s0">, </span><span class="s3">lineStarts</span><span class="s0">[</span><span class="s3">foundLineNo</span><span class="s0">], </span><span class="s3">lineEnds</span><span class="s0">[</span><span class="s3">foundLineNo</span><span class="s0">], </span><span class="s3">mark</span><span class="s0">.</span><span class="s3">position</span><span class="s0">, </span><span class="s3">maxLineLength</span><span class="s0">);</span>
  <span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">' '</span><span class="s0">, </span><span class="s3">options</span><span class="s0">.</span><span class="s3">indent</span><span class="s0">) </span><span class="s2">+ </span><span class="s6">padStart</span><span class="s0">((</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">line </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">).</span><span class="s6">toString</span><span class="s0">(), </span><span class="s3">lineNoLength</span><span class="s0">) </span><span class="s2">+</span>
    <span class="s4">' | ' </span><span class="s2">+ </span><span class="s3">line</span><span class="s0">.</span><span class="s3">str </span><span class="s2">+ </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>
  <span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'-'</span><span class="s0">, </span><span class="s3">options</span><span class="s0">.</span><span class="s3">indent </span><span class="s2">+ </span><span class="s3">lineNoLength </span><span class="s2">+ </span><span class="s7">3 </span><span class="s2">+ </span><span class="s3">line</span><span class="s0">.</span><span class="s3">pos</span><span class="s0">) </span><span class="s2">+ </span><span class="s4">'^' </span><span class="s2">+ </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">i </span><span class="s2">= </span><span class="s7">1</span><span class="s0">; </span><span class="s3">i </span><span class="s2">&lt;= </span><span class="s3">options</span><span class="s0">.</span><span class="s3">linesAfter</span><span class="s0">; </span><span class="s3">i</span><span class="s2">++</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">foundLineNo </span><span class="s2">+ </span><span class="s3">i </span><span class="s2">&gt;= </span><span class="s3">lineEnds</span><span class="s0">.length) </span><span class="s2">break</span><span class="s0">;</span>
    <span class="s3">line </span><span class="s2">= </span><span class="s6">getLine</span><span class="s0">(</span>
      <span class="s3">mark</span><span class="s0">.</span><span class="s3">buffer</span><span class="s0">,</span>
      <span class="s3">lineStarts</span><span class="s0">[</span><span class="s3">foundLineNo </span><span class="s2">+ </span><span class="s3">i</span><span class="s0">],</span>
      <span class="s3">lineEnds</span><span class="s0">[</span><span class="s3">foundLineNo </span><span class="s2">+ </span><span class="s3">i</span><span class="s0">],</span>
      <span class="s3">mark</span><span class="s0">.</span><span class="s3">position </span><span class="s2">- </span><span class="s0">(</span><span class="s3">lineStarts</span><span class="s0">[</span><span class="s3">foundLineNo</span><span class="s0">] </span><span class="s2">- </span><span class="s3">lineStarts</span><span class="s0">[</span><span class="s3">foundLineNo </span><span class="s2">+ </span><span class="s3">i</span><span class="s0">]),</span>
      <span class="s3">maxLineLength</span>
    <span class="s0">);</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">' '</span><span class="s0">, </span><span class="s3">options</span><span class="s0">.</span><span class="s3">indent</span><span class="s0">) </span><span class="s2">+ </span><span class="s6">padStart</span><span class="s0">((</span><span class="s3">mark</span><span class="s0">.</span><span class="s3">line </span><span class="s2">+ </span><span class="s3">i </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">).</span><span class="s6">toString</span><span class="s0">(), </span><span class="s3">lineNoLength</span><span class="s0">) </span><span class="s2">+</span>
      <span class="s4">' | ' </span><span class="s2">+ </span><span class="s3">line</span><span class="s0">.</span><span class="s3">str </span><span class="s2">+ </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">.</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">/</span><span class="s5">\n</span><span class="s2">$</span><span class="s4">/</span><span class="s0">, </span><span class="s4">''</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s2">var </span><span class="s0">snippet </span><span class="s2">= </span><span class="s3">makeSnippet</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">TYPE_CONSTRUCTOR_OPTIONS </span><span class="s2">= </span><span class="s0">[</span>
  <span class="s4">'kind'</span><span class="s0">,</span>
  <span class="s4">'multi'</span><span class="s0">,</span>
  <span class="s4">'resolve'</span><span class="s0">,</span>
  <span class="s4">'construct'</span><span class="s0">,</span>
  <span class="s4">'instanceOf'</span><span class="s0">,</span>
  <span class="s4">'predicate'</span><span class="s0">,</span>
  <span class="s4">'represent'</span><span class="s0">,</span>
  <span class="s4">'representName'</span><span class="s0">,</span>
  <span class="s4">'defaultStyle'</span><span class="s0">,</span>
  <span class="s4">'styleAliases'</span>
<span class="s0">];</span>

<span class="s2">var </span><span class="s0">YAML_NODE_KINDS </span><span class="s2">= </span><span class="s0">[</span>
  <span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s4">'sequence'</span><span class="s0">,</span>
  <span class="s4">'mapping'</span>
<span class="s0">];</span>

<span class="s2">function </span><span class="s0">compileStyleAliases(</span><span class="s3">map</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s0">{};</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">map </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">map</span><span class="s0">).</span><span class="s6">forEach</span><span class="s0">(</span><span class="s2">function </span><span class="s0">(</span><span class="s3">style</span><span class="s0">) {</span>
      <span class="s3">map</span><span class="s0">[</span><span class="s3">style</span><span class="s0">].</span><span class="s6">forEach</span><span class="s0">(</span><span class="s2">function </span><span class="s0">(</span><span class="s3">alias</span><span class="s0">) {</span>
        <span class="s3">result</span><span class="s0">[</span><span class="s6">String</span><span class="s0">(</span><span class="s3">alias</span><span class="s0">)] </span><span class="s2">= </span><span class="s3">style</span><span class="s0">;</span>
      <span class="s0">});</span>
    <span class="s0">});</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">Type$1(</span><span class="s3">tag</span><span class="s0">, </span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s3">options </span><span class="s2">= </span><span class="s3">options </span><span class="s2">|| </span><span class="s0">{};</span>

  <span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">options</span><span class="s0">).</span><span class="s6">forEach</span><span class="s0">(</span><span class="s2">function </span><span class="s0">(</span><span class="s3">name</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">TYPE_CONSTRUCTOR_OPTIONS</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">name</span><span class="s0">) </span><span class="s2">=== -</span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'Unknown option &quot;' </span><span class="s2">+ </span><span class="s3">name </span><span class="s2">+ </span><span class="s4">'&quot; is met in definition of &quot;' </span><span class="s2">+ </span><span class="s3">tag </span><span class="s2">+ </span><span class="s4">'&quot; YAML type.'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">});</span>

  <span class="s1">// TODO: Add tag format check.</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">options       </span><span class="s2">= </span><span class="s3">options</span><span class="s0">; </span><span class="s1">// keep original options in case user wants to extend this type later</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">tag           </span><span class="s2">= </span><span class="s3">tag</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">kind          </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'kind'</span><span class="s0">]          </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">resolve       </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'resolve'</span><span class="s0">]       </span><span class="s2">|| function </span><span class="s0">() { </span><span class="s2">return </span><span class="s5">true</span><span class="s0">; };</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">construct     </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'construct'</span><span class="s0">]     </span><span class="s2">|| function </span><span class="s0">(</span><span class="s3">data</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">data</span><span class="s0">; };</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">instanceOf    </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'instanceOf'</span><span class="s0">]    </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">predicate     </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'predicate'</span><span class="s0">]     </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">represent     </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'represent'</span><span class="s0">]     </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">representName </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'representName'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">defaultStyle  </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'defaultStyle'</span><span class="s0">]  </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">multi         </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'multi'</span><span class="s0">]         </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">styleAliases  </span><span class="s2">= </span><span class="s6">compileStyleAliases</span><span class="s0">(</span><span class="s3">options</span><span class="s0">[</span><span class="s4">'styleAliases'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">YAML_NODE_KINDS</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">this</span><span class="s0">.</span><span class="s3">kind</span><span class="s0">) </span><span class="s2">=== -</span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'Unknown kind &quot;' </span><span class="s2">+ </span><span class="s3">this</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">+ </span><span class="s4">'&quot; is specified for &quot;' </span><span class="s2">+ </span><span class="s3">tag </span><span class="s2">+ </span><span class="s4">'&quot; YAML type.'</span><span class="s0">);</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">type </span><span class="s2">= </span><span class="s3">Type$1</span><span class="s0">;</span>

<span class="s1">/*eslint-disable max-len*/</span>





<span class="s2">function </span><span class="s0">compileList(</span><span class="s3">schema</span><span class="s0">, </span><span class="s3">name</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s0">[];</span>

  <span class="s3">schema</span><span class="s0">[</span><span class="s3">name</span><span class="s0">].</span><span class="s6">forEach</span><span class="s0">(</span><span class="s2">function </span><span class="s0">(</span><span class="s3">currentType</span><span class="s0">) {</span>
    <span class="s2">var </span><span class="s0">newIndex </span><span class="s2">= </span><span class="s3">result</span><span class="s0">.length;</span>

    <span class="s3">result</span><span class="s0">.</span><span class="s6">forEach</span><span class="s0">(</span><span class="s2">function </span><span class="s0">(</span><span class="s3">previousType</span><span class="s0">, </span><span class="s3">previousIndex</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">previousType</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">=== </span><span class="s3">currentType</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">&amp;&amp;</span>
          <span class="s3">previousType</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">=== </span><span class="s3">currentType</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">&amp;&amp;</span>
          <span class="s3">previousType</span><span class="s0">.</span><span class="s3">multi </span><span class="s2">=== </span><span class="s3">currentType</span><span class="s0">.</span><span class="s3">multi</span><span class="s0">) {</span>

        <span class="s3">newIndex </span><span class="s2">= </span><span class="s3">previousIndex</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">});</span>

    <span class="s3">result</span><span class="s0">[</span><span class="s3">newIndex</span><span class="s0">] </span><span class="s2">= </span><span class="s3">currentType</span><span class="s0">;</span>
  <span class="s0">});</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">compileMap(</span><span class="s1">/* lists... */</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s0">{</span>
        <span class="s0">scalar: {},</span>
        <span class="s0">sequence: {},</span>
        <span class="s0">mapping: {},</span>
        <span class="s0">fallback: {},</span>
        <span class="s0">multi: {</span>
          <span class="s0">scalar: [],</span>
          <span class="s0">sequence: [],</span>
          <span class="s0">mapping: [],</span>
          <span class="s0">fallback: []</span>
        <span class="s0">}</span>
      <span class="s0">}, index, length;</span>

  <span class="s2">function </span><span class="s0">collectType(</span><span class="s3">type</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s3">multi</span><span class="s0">) {</span>
      <span class="s3">result</span><span class="s0">.</span><span class="s3">multi</span><span class="s0">[</span><span class="s3">type</span><span class="s0">.</span><span class="s3">kind</span><span class="s0">].</span><span class="s6">push</span><span class="s0">(</span><span class="s3">type</span><span class="s0">);</span>
      <span class="s3">result</span><span class="s0">.</span><span class="s3">multi</span><span class="s0">[</span><span class="s4">'fallback'</span><span class="s0">].</span><span class="s6">push</span><span class="s0">(</span><span class="s3">type</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">result</span><span class="s0">[</span><span class="s3">type</span><span class="s0">.</span><span class="s3">kind</span><span class="s0">][</span><span class="s3">type</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">] </span><span class="s2">= </span><span class="s3">result</span><span class="s0">[</span><span class="s4">'fallback'</span><span class="s0">][</span><span class="s3">type</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">] </span><span class="s2">= </span><span class="s3">type</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">arguments</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">arguments</span><span class="s0">[</span><span class="s3">index</span><span class="s0">].</span><span class="s6">forEach</span><span class="s0">(</span><span class="s3">collectType</span><span class="s0">);</span>
  <span class="s0">}</span>
  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">Schema$1(</span><span class="s3">definition</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">this</span><span class="s0">.</span><span class="s6">extend</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s0">Schema$1.prototype.</span><span class="s6">extend </span><span class="s2">= function </span><span class="s0">extend(</span><span class="s3">definition</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">implicit </span><span class="s2">= </span><span class="s0">[];</span>
  <span class="s2">var </span><span class="s0">explicit </span><span class="s2">= </span><span class="s0">[];</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">definition </span><span class="s2">instanceof </span><span class="s3">type</span><span class="s0">) {</span>
    <span class="s1">// Schema.extend(type)</span>
    <span class="s3">explicit</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">);</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">)) {</span>
    <span class="s1">// Schema.extend([ type1, type2, ... ])</span>
    <span class="s3">explicit </span><span class="s2">= </span><span class="s3">explicit</span><span class="s0">.</span><span class="s6">concat</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">);</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">definition </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">.</span><span class="s3">implicit</span><span class="s0">) </span><span class="s2">|| </span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">.</span><span class="s3">explicit</span><span class="s0">))) {</span>
    <span class="s1">// Schema.extend({ explicit: [ type1, type2, ... ], implicit: [ type1, type2, ... ] })</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">definition</span><span class="s0">.</span><span class="s3">implicit</span><span class="s0">) </span><span class="s3">implicit </span><span class="s2">= </span><span class="s3">implicit</span><span class="s0">.</span><span class="s6">concat</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">.</span><span class="s3">implicit</span><span class="s0">);</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">definition</span><span class="s0">.</span><span class="s3">explicit</span><span class="s0">) </span><span class="s3">explicit </span><span class="s2">= </span><span class="s3">explicit</span><span class="s0">.</span><span class="s6">concat</span><span class="s0">(</span><span class="s3">definition</span><span class="s0">.</span><span class="s3">explicit</span><span class="s0">);</span>

  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'Schema.extend argument should be a Type, [ Type ], ' </span><span class="s2">+</span>
      <span class="s4">'or a schema definition ({ implicit: [...], explicit: [...] })'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">implicit</span><span class="s0">.</span><span class="s6">forEach</span><span class="s0">(</span><span class="s2">function </span><span class="s0">(</span><span class="s3">type$1</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s0">(</span><span class="s3">type$1 </span><span class="s2">instanceof </span><span class="s3">type</span><span class="s0">)) {</span>
      <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'Specified list of YAML types (or a single Type object) contains a non-Type object.'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">type$1</span><span class="s0">.</span><span class="s3">loadKind </span><span class="s2">&amp;&amp; </span><span class="s3">type$1</span><span class="s0">.</span><span class="s3">loadKind </span><span class="s2">!== </span><span class="s4">'scalar'</span><span class="s0">) {</span>
      <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'There is a non-scalar type in the implicit list of a schema. Implicit resolving of such types is not supported.'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">type$1</span><span class="s0">.</span><span class="s3">multi</span><span class="s0">) {</span>
      <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'There is a multi type in the implicit list of a schema. Multi tags can only be listed as explicit.'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">});</span>

  <span class="s3">explicit</span><span class="s0">.</span><span class="s6">forEach</span><span class="s0">(</span><span class="s2">function </span><span class="s0">(</span><span class="s3">type$1</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s0">(</span><span class="s3">type$1 </span><span class="s2">instanceof </span><span class="s3">type</span><span class="s0">)) {</span>
      <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'Specified list of YAML types (or a single Type object) contains a non-Type object.'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">});</span>

  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">create</span><span class="s0">(Schema$1.prototype);</span>

  <span class="s3">result</span><span class="s0">.</span><span class="s3">implicit </span><span class="s2">= </span><span class="s0">(</span><span class="s3">this</span><span class="s0">.</span><span class="s3">implicit </span><span class="s2">|| </span><span class="s0">[]).</span><span class="s6">concat</span><span class="s0">(</span><span class="s3">implicit</span><span class="s0">);</span>
  <span class="s3">result</span><span class="s0">.</span><span class="s3">explicit </span><span class="s2">= </span><span class="s0">(</span><span class="s3">this</span><span class="s0">.</span><span class="s3">explicit </span><span class="s2">|| </span><span class="s0">[]).</span><span class="s6">concat</span><span class="s0">(</span><span class="s3">explicit</span><span class="s0">);</span>

  <span class="s3">result</span><span class="s0">.</span><span class="s3">compiledImplicit </span><span class="s2">= </span><span class="s6">compileList</span><span class="s0">(</span><span class="s3">result</span><span class="s0">, </span><span class="s4">'implicit'</span><span class="s0">);</span>
  <span class="s3">result</span><span class="s0">.</span><span class="s3">compiledExplicit </span><span class="s2">= </span><span class="s6">compileList</span><span class="s0">(</span><span class="s3">result</span><span class="s0">, </span><span class="s4">'explicit'</span><span class="s0">);</span>
  <span class="s3">result</span><span class="s0">.</span><span class="s3">compiledTypeMap  </span><span class="s2">= </span><span class="s6">compileMap</span><span class="s0">(</span><span class="s3">result</span><span class="s0">.</span><span class="s3">compiledImplicit</span><span class="s0">, </span><span class="s3">result</span><span class="s0">.</span><span class="s3">compiledExplicit</span><span class="s0">);</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">};</span>


<span class="s2">var </span><span class="s0">schema </span><span class="s2">= </span><span class="s3">Schema$1</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">str </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:str'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s6">construct</span><span class="s0">: </span><span class="s2">function </span><span class="s0">(</span><span class="s3">data</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">data </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">? </span><span class="s3">data </span><span class="s2">: </span><span class="s4">''</span><span class="s0">; }</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">seq </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:seq'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'sequence'</span><span class="s0">,</span>
  <span class="s6">construct</span><span class="s0">: </span><span class="s2">function </span><span class="s0">(</span><span class="s3">data</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">data </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">? </span><span class="s3">data </span><span class="s2">: </span><span class="s0">[]; }</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">map </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:map'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'mapping'</span><span class="s0">,</span>
  <span class="s6">construct</span><span class="s0">: </span><span class="s2">function </span><span class="s0">(</span><span class="s3">data</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">data </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">? </span><span class="s3">data </span><span class="s2">: </span><span class="s0">{}; }</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">failsafe </span><span class="s2">= new </span><span class="s6">schema</span><span class="s0">({</span>
  <span class="s0">explicit: [</span>
    <span class="s3">str</span><span class="s0">,</span>
    <span class="s3">seq</span><span class="s0">,</span>
    <span class="s3">map</span>
  <span class="s0">]</span>
<span class="s0">});</span>

<span class="s2">function </span><span class="s0">resolveYamlNull(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">max </span><span class="s2">= </span><span class="s3">data</span><span class="s0">.length;</span>

  <span class="s2">return </span><span class="s0">(</span><span class="s3">max </span><span class="s2">=== </span><span class="s7">1 </span><span class="s2">&amp;&amp; </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'~'</span><span class="s0">) </span><span class="s2">||</span>
         <span class="s0">(</span><span class="s3">max </span><span class="s2">=== </span><span class="s7">4 </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'null' </span><span class="s2">|| </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'Null' </span><span class="s2">|| </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'NULL'</span><span class="s0">));</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlNull() {</span>
  <span class="s2">return </span><span class="s5">null</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">isNull(</span><span class="s3">object</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">object </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">_null </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:null'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlNull</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlNull</span><span class="s0">,</span>
  <span class="s0">predicate: </span><span class="s3">isNull</span><span class="s0">,</span>
  <span class="s0">represent: {</span>
    <span class="s6">canonical</span><span class="s0">: </span><span class="s2">function </span><span class="s0">() { </span><span class="s2">return </span><span class="s4">'~'</span><span class="s0">;    },</span>
    <span class="s6">lowercase</span><span class="s0">: </span><span class="s2">function </span><span class="s0">() { </span><span class="s2">return </span><span class="s4">'null'</span><span class="s0">; },</span>
    <span class="s6">uppercase</span><span class="s0">: </span><span class="s2">function </span><span class="s0">() { </span><span class="s2">return </span><span class="s4">'NULL'</span><span class="s0">; },</span>
    <span class="s6">camelcase</span><span class="s0">: </span><span class="s2">function </span><span class="s0">() { </span><span class="s2">return </span><span class="s4">'Null'</span><span class="s0">; },</span>
    <span class="s6">empty</span><span class="s0">:     </span><span class="s2">function </span><span class="s0">() { </span><span class="s2">return </span><span class="s4">''</span><span class="s0">;     }</span>
  <span class="s0">},</span>
  <span class="s0">defaultStyle: </span><span class="s4">'lowercase'</span>
<span class="s0">});</span>

<span class="s2">function </span><span class="s0">resolveYamlBoolean(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">max </span><span class="s2">= </span><span class="s3">data</span><span class="s0">.length;</span>

  <span class="s2">return </span><span class="s0">(</span><span class="s3">max </span><span class="s2">=== </span><span class="s7">4 </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'true' </span><span class="s2">|| </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'True' </span><span class="s2">|| </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'TRUE'</span><span class="s0">)) </span><span class="s2">||</span>
         <span class="s0">(</span><span class="s3">max </span><span class="s2">=== </span><span class="s7">5 </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'false' </span><span class="s2">|| </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'False' </span><span class="s2">|| </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'FALSE'</span><span class="s0">));</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlBoolean(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'true' </span><span class="s2">||</span>
         <span class="s3">data </span><span class="s2">=== </span><span class="s4">'True' </span><span class="s2">||</span>
         <span class="s3">data </span><span class="s2">=== </span><span class="s4">'TRUE'</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">isBoolean(</span><span class="s3">object</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">Object.prototype.</span><span class="s3">toString</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">) </span><span class="s2">=== </span><span class="s4">'[object Boolean]'</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">bool </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:bool'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlBoolean</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlBoolean</span><span class="s0">,</span>
  <span class="s0">predicate: </span><span class="s3">isBoolean</span><span class="s0">,</span>
  <span class="s0">represent: {</span>
    <span class="s6">lowercase</span><span class="s0">: </span><span class="s2">function </span><span class="s0">(</span><span class="s3">object</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">object </span><span class="s2">? </span><span class="s4">'true' </span><span class="s2">: </span><span class="s4">'false'</span><span class="s0">; },</span>
    <span class="s6">uppercase</span><span class="s0">: </span><span class="s2">function </span><span class="s0">(</span><span class="s3">object</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">object </span><span class="s2">? </span><span class="s4">'TRUE' </span><span class="s2">: </span><span class="s4">'FALSE'</span><span class="s0">; },</span>
    <span class="s6">camelcase</span><span class="s0">: </span><span class="s2">function </span><span class="s0">(</span><span class="s3">object</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">object </span><span class="s2">? </span><span class="s4">'True' </span><span class="s2">: </span><span class="s4">'False'</span><span class="s0">; }</span>
  <span class="s0">},</span>
  <span class="s0">defaultStyle: </span><span class="s4">'lowercase'</span>
<span class="s0">});</span>

<span class="s2">function </span><span class="s0">isHexCode(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">((</span><span class="s7">0x30</span><span class="s1">/* 0 */ </span><span class="s2">&lt;= </span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x39</span><span class="s1">/* 9 */</span><span class="s0">)) </span><span class="s2">||</span>
         <span class="s0">((</span><span class="s7">0x41</span><span class="s1">/* A */ </span><span class="s2">&lt;= </span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x46</span><span class="s1">/* F */</span><span class="s0">)) </span><span class="s2">||</span>
         <span class="s0">((</span><span class="s7">0x61</span><span class="s1">/* a */ </span><span class="s2">&lt;= </span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x66</span><span class="s1">/* f */</span><span class="s0">));</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">isOctCode(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">((</span><span class="s7">0x30</span><span class="s1">/* 0 */ </span><span class="s2">&lt;= </span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x37</span><span class="s1">/* 7 */</span><span class="s0">));</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">isDecCode(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">((</span><span class="s7">0x30</span><span class="s1">/* 0 */ </span><span class="s2">&lt;= </span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x39</span><span class="s1">/* 9 */</span><span class="s0">));</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">resolveYamlInteger(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">max </span><span class="s2">= </span><span class="s3">data</span><span class="s0">.length,</span>
      <span class="s0">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">,</span>
      <span class="s0">hasDigits </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">ch;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">max</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">data</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

  <span class="s1">// sign</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'-' </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'+'</span><span class="s0">) {</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">data</span><span class="s0">[</span><span class="s2">++</span><span class="s3">index</span><span class="s0">];</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'0'</span><span class="s0">) {</span>
    <span class="s1">// 0</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">index </span><span class="s2">+ </span><span class="s7">1 </span><span class="s2">=== </span><span class="s3">max</span><span class="s0">) </span><span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">data</span><span class="s0">[</span><span class="s2">++</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s1">// base 2, base 8, base 16</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'b'</span><span class="s0">) {</span>
      <span class="s1">// base 2</span>
      <span class="s3">index</span><span class="s2">++</span><span class="s0">;</span>

      <span class="s2">for </span><span class="s0">(; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">max</span><span class="s0">; </span><span class="s3">index</span><span class="s2">++</span><span class="s0">) {</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">data</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'_'</span><span class="s0">) </span><span class="s2">continue</span><span class="s0">;</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s4">'0' </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">!== </span><span class="s4">'1'</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
        <span class="s3">hasDigits </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s0">}</span>
      <span class="s2">return </span><span class="s3">hasDigits </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">!== </span><span class="s4">'_'</span><span class="s0">;</span>
    <span class="s0">}</span>


    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'x'</span><span class="s0">) {</span>
      <span class="s1">// base 16</span>
      <span class="s3">index</span><span class="s2">++</span><span class="s0">;</span>

      <span class="s2">for </span><span class="s0">(; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">max</span><span class="s0">; </span><span class="s3">index</span><span class="s2">++</span><span class="s0">) {</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">data</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'_'</span><span class="s0">) </span><span class="s2">continue</span><span class="s0">;</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">isHexCode</span><span class="s0">(</span><span class="s3">data</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">index</span><span class="s0">))) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
        <span class="s3">hasDigits </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s0">}</span>
      <span class="s2">return </span><span class="s3">hasDigits </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">!== </span><span class="s4">'_'</span><span class="s0">;</span>
    <span class="s0">}</span>


    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'o'</span><span class="s0">) {</span>
      <span class="s1">// base 8</span>
      <span class="s3">index</span><span class="s2">++</span><span class="s0">;</span>

      <span class="s2">for </span><span class="s0">(; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">max</span><span class="s0">; </span><span class="s3">index</span><span class="s2">++</span><span class="s0">) {</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">data</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'_'</span><span class="s0">) </span><span class="s2">continue</span><span class="s0">;</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">isOctCode</span><span class="s0">(</span><span class="s3">data</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">index</span><span class="s0">))) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
        <span class="s3">hasDigits </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s0">}</span>
      <span class="s2">return </span><span class="s3">hasDigits </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">!== </span><span class="s4">'_'</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s1">// base 10 (except 0)</span>

  <span class="s1">// value should not start with `_`;</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'_'</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">for </span><span class="s0">(; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">max</span><span class="s0">; </span><span class="s3">index</span><span class="s2">++</span><span class="s0">) {</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">data</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'_'</span><span class="s0">) </span><span class="s2">continue</span><span class="s0">;</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">isDecCode</span><span class="s0">(</span><span class="s3">data</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">index</span><span class="s0">))) {</span>
      <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s3">hasDigits </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s1">// Should have digits and should not end with `_`</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">hasDigits </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'_'</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlInteger(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">value </span><span class="s2">= </span><span class="s3">data</span><span class="s0">, sign </span><span class="s2">= </span><span class="s7">1</span><span class="s0">, ch;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">value</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s4">'_'</span><span class="s0">) </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">value </span><span class="s2">= </span><span class="s3">value</span><span class="s0">.</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">/_/</span><span class="s2">g</span><span class="s0">, </span><span class="s4">''</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">value</span><span class="s0">[</span><span class="s7">0</span><span class="s0">];</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'-' </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'+'</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'-'</span><span class="s0">) </span><span class="s3">sign </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">;</span>
    <span class="s3">value </span><span class="s2">= </span><span class="s3">value</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">);</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">value</span><span class="s0">[</span><span class="s7">0</span><span class="s0">];</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">value </span><span class="s2">=== </span><span class="s4">'0'</span><span class="s0">) </span><span class="s2">return </span><span class="s7">0</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s4">'0'</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">value</span><span class="s0">[</span><span class="s7">1</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'b'</span><span class="s0">) </span><span class="s2">return </span><span class="s3">sign </span><span class="s2">* </span><span class="s6">parseInt</span><span class="s0">(</span><span class="s3">value</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">2</span><span class="s0">), </span><span class="s7">2</span><span class="s0">);</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">value</span><span class="s0">[</span><span class="s7">1</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'x'</span><span class="s0">) </span><span class="s2">return </span><span class="s3">sign </span><span class="s2">* </span><span class="s6">parseInt</span><span class="s0">(</span><span class="s3">value</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">2</span><span class="s0">), </span><span class="s7">16</span><span class="s0">);</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">value</span><span class="s0">[</span><span class="s7">1</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'o'</span><span class="s0">) </span><span class="s2">return </span><span class="s3">sign </span><span class="s2">* </span><span class="s6">parseInt</span><span class="s0">(</span><span class="s3">value</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">2</span><span class="s0">), </span><span class="s7">8</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">sign </span><span class="s2">* </span><span class="s6">parseInt</span><span class="s0">(</span><span class="s3">value</span><span class="s0">, </span><span class="s7">10</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">isInteger(</span><span class="s3">object</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(Object.prototype.</span><span class="s3">toString</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">)) </span><span class="s2">=== </span><span class="s4">'[object Number]' </span><span class="s2">&amp;&amp;</span>
         <span class="s0">(</span><span class="s3">object </span><span class="s2">% </span><span class="s7">1 </span><span class="s2">=== </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s3">common</span><span class="s0">.</span><span class="s6">isNegativeZero</span><span class="s0">(</span><span class="s3">object</span><span class="s0">));</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">int </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:int'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlInteger</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlInteger</span><span class="s0">,</span>
  <span class="s0">predicate: </span><span class="s3">isInteger</span><span class="s0">,</span>
  <span class="s0">represent: {</span>
    <span class="s6">binary</span><span class="s0">:      </span><span class="s2">function </span><span class="s0">(</span><span class="s3">obj</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">obj </span><span class="s2">&gt;= </span><span class="s7">0 </span><span class="s2">? </span><span class="s4">'0b' </span><span class="s2">+ </span><span class="s3">obj</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">2</span><span class="s0">) </span><span class="s2">: </span><span class="s4">'-0b' </span><span class="s2">+ </span><span class="s3">obj</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">2</span><span class="s0">).</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">); },</span>
    <span class="s6">octal</span><span class="s0">:       </span><span class="s2">function </span><span class="s0">(</span><span class="s3">obj</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">obj </span><span class="s2">&gt;= </span><span class="s7">0 </span><span class="s2">? </span><span class="s4">'0o'  </span><span class="s2">+ </span><span class="s3">obj</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">8</span><span class="s0">) </span><span class="s2">: </span><span class="s4">'-0o'  </span><span class="s2">+ </span><span class="s3">obj</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">8</span><span class="s0">).</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">); },</span>
    <span class="s6">decimal</span><span class="s0">:     </span><span class="s2">function </span><span class="s0">(</span><span class="s3">obj</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">obj</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">10</span><span class="s0">); },</span>
    <span class="s1">/* eslint-disable max-len */</span>
    <span class="s6">hexadecimal</span><span class="s0">: </span><span class="s2">function </span><span class="s0">(</span><span class="s3">obj</span><span class="s0">) { </span><span class="s2">return </span><span class="s3">obj </span><span class="s2">&gt;= </span><span class="s7">0 </span><span class="s2">? </span><span class="s4">'0x' </span><span class="s2">+ </span><span class="s3">obj</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">16</span><span class="s0">).</span><span class="s6">toUpperCase</span><span class="s0">() </span><span class="s2">:  </span><span class="s4">'-0x' </span><span class="s2">+ </span><span class="s3">obj</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">16</span><span class="s0">).</span><span class="s6">toUpperCase</span><span class="s0">().</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">); }</span>
  <span class="s0">},</span>
  <span class="s0">defaultStyle: </span><span class="s4">'decimal'</span><span class="s0">,</span>
  <span class="s0">styleAliases: {</span>
    <span class="s0">binary:      [ </span><span class="s7">2</span><span class="s0">,  </span><span class="s4">'bin' </span><span class="s0">],</span>
    <span class="s0">octal:       [ </span><span class="s7">8</span><span class="s0">,  </span><span class="s4">'oct' </span><span class="s0">],</span>
    <span class="s0">decimal:     [ </span><span class="s7">10</span><span class="s0">, </span><span class="s4">'dec' </span><span class="s0">],</span>
    <span class="s0">hexadecimal: [ </span><span class="s7">16</span><span class="s0">, </span><span class="s4">'hex' </span><span class="s0">]</span>
  <span class="s0">}</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">YAML_FLOAT_PATTERN </span><span class="s2">= new </span><span class="s6">RegExp</span><span class="s0">(</span>
  <span class="s1">// 2.5e4, 2.5 and integers</span>
  <span class="s4">'^(?:[-+]?(?:[0-9][0-9_]*)(?:</span><span class="s8">\\</span><span class="s4">.[0-9_]*)?(?:[eE][-+]?[0-9]+)?' </span><span class="s2">+</span>
  <span class="s1">// .2e4, .2</span>
  <span class="s1">// special case, seems not from spec</span>
  <span class="s4">'|</span><span class="s8">\\</span><span class="s4">.[0-9_]+(?:[eE][-+]?[0-9]+)?' </span><span class="s2">+</span>
  <span class="s1">// .inf</span>
  <span class="s4">'|[-+]?</span><span class="s8">\\</span><span class="s4">.(?:inf|Inf|INF)' </span><span class="s2">+</span>
  <span class="s1">// .nan</span>
  <span class="s4">'|</span><span class="s8">\\</span><span class="s4">.(?:nan|NaN|NAN))$'</span><span class="s0">);</span>

<span class="s2">function </span><span class="s0">resolveYamlFloat(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">YAML_FLOAT_PATTERN</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">data</span><span class="s0">) </span><span class="s2">||</span>
      <span class="s1">// Quick hack to not allow integers end with `_`</span>
      <span class="s1">// Probably should update regexp &amp; check speed</span>
      <span class="s3">data</span><span class="s0">[</span><span class="s3">data</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'_'</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlFloat(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">value, sign;</span>

  <span class="s3">value  </span><span class="s2">= </span><span class="s3">data</span><span class="s0">.</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">/_/</span><span class="s2">g</span><span class="s0">, </span><span class="s4">''</span><span class="s0">).</span><span class="s6">toLowerCase</span><span class="s0">();</span>
  <span class="s3">sign   </span><span class="s2">= </span><span class="s3">value</span><span class="s0">[</span><span class="s7">0</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'-' </span><span class="s2">? -</span><span class="s7">1 </span><span class="s2">: </span><span class="s7">1</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s4">'+-'</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">value</span><span class="s0">[</span><span class="s7">0</span><span class="s0">]) </span><span class="s2">&gt;= </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s3">value </span><span class="s2">= </span><span class="s3">value</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">value </span><span class="s2">=== </span><span class="s4">'.inf'</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s0">(</span><span class="s3">sign </span><span class="s2">=== </span><span class="s7">1</span><span class="s0">) </span><span class="s2">? </span><span class="s3">Number</span><span class="s0">.POSITIVE_INFINITY </span><span class="s2">: </span><span class="s3">Number</span><span class="s0">.NEGATIVE_INFINITY;</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">value </span><span class="s2">=== </span><span class="s4">'.nan'</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s5">NaN</span><span class="s0">;</span>
  <span class="s0">}</span>
  <span class="s2">return </span><span class="s3">sign </span><span class="s2">* </span><span class="s6">parseFloat</span><span class="s0">(</span><span class="s3">value</span><span class="s0">, </span><span class="s7">10</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s2">var </span><span class="s0">SCIENTIFIC_WITHOUT_DOT </span><span class="s2">= </span><span class="s4">/</span><span class="s2">^</span><span class="s5">[-+]</span><span class="s2">?</span><span class="s5">[0-9]</span><span class="s2">+</span><span class="s4">e/</span><span class="s0">;</span>

<span class="s2">function </span><span class="s0">representYamlFloat(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">style</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">res;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s6">isNaN</span><span class="s0">(</span><span class="s3">object</span><span class="s0">)) {</span>
    <span class="s2">switch </span><span class="s0">(</span><span class="s3">style</span><span class="s0">) {</span>
      <span class="s2">case </span><span class="s4">'lowercase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'.nan'</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s4">'uppercase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'.NAN'</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s4">'camelcase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'.NaN'</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">Number</span><span class="s0">.POSITIVE_INFINITY </span><span class="s2">=== </span><span class="s3">object</span><span class="s0">) {</span>
    <span class="s2">switch </span><span class="s0">(</span><span class="s3">style</span><span class="s0">) {</span>
      <span class="s2">case </span><span class="s4">'lowercase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'.inf'</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s4">'uppercase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'.INF'</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s4">'camelcase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'.Inf'</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">Number</span><span class="s0">.NEGATIVE_INFINITY </span><span class="s2">=== </span><span class="s3">object</span><span class="s0">) {</span>
    <span class="s2">switch </span><span class="s0">(</span><span class="s3">style</span><span class="s0">) {</span>
      <span class="s2">case </span><span class="s4">'lowercase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'-.inf'</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s4">'uppercase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'-.INF'</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s4">'camelcase'</span><span class="s0">: </span><span class="s2">return </span><span class="s4">'-.Inf'</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">common</span><span class="s0">.</span><span class="s6">isNegativeZero</span><span class="s0">(</span><span class="s3">object</span><span class="s0">)) {</span>
    <span class="s2">return </span><span class="s4">'-0.0'</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">res </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">10</span><span class="s0">);</span>

  <span class="s1">// JS stringifier can build scientific format without dots: 5e-100,</span>
  <span class="s1">// while YAML requres dot: 5.e-100. Fix it with simple hack</span>

  <span class="s2">return </span><span class="s3">SCIENTIFIC_WITHOUT_DOT</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">res</span><span class="s0">) </span><span class="s2">? </span><span class="s3">res</span><span class="s0">.</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">'e'</span><span class="s0">, </span><span class="s4">'.e'</span><span class="s0">) </span><span class="s2">: </span><span class="s3">res</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">isFloat(</span><span class="s3">object</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(Object.prototype.</span><span class="s3">toString</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">) </span><span class="s2">=== </span><span class="s4">'[object Number]'</span><span class="s0">) </span><span class="s2">&amp;&amp;</span>
         <span class="s0">(</span><span class="s3">object </span><span class="s2">% </span><span class="s7">1 </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">|| </span><span class="s3">common</span><span class="s0">.</span><span class="s6">isNegativeZero</span><span class="s0">(</span><span class="s3">object</span><span class="s0">));</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">float </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:float'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlFloat</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlFloat</span><span class="s0">,</span>
  <span class="s0">predicate: </span><span class="s3">isFloat</span><span class="s0">,</span>
  <span class="s0">represent: </span><span class="s3">representYamlFloat</span><span class="s0">,</span>
  <span class="s0">defaultStyle: </span><span class="s4">'lowercase'</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">json </span><span class="s2">= </span><span class="s3">failsafe</span><span class="s0">.</span><span class="s6">extend</span><span class="s0">({</span>
  <span class="s0">implicit: [</span>
    <span class="s3">_null</span><span class="s0">,</span>
    <span class="s3">bool</span><span class="s0">,</span>
    <span class="s3">int</span><span class="s0">,</span>
    <span class="s3">float</span>
  <span class="s0">]</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">core </span><span class="s2">= </span><span class="s3">json</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">YAML_DATE_REGEXP </span><span class="s2">= new </span><span class="s6">RegExp</span><span class="s0">(</span>
  <span class="s4">'^([0-9][0-9][0-9][0-9])'          </span><span class="s2">+ </span><span class="s1">// [1] year</span>
  <span class="s4">'-([0-9][0-9])'                    </span><span class="s2">+ </span><span class="s1">// [2] month</span>
  <span class="s4">'-([0-9][0-9])$'</span><span class="s0">);                   </span><span class="s1">// [3] day</span>

<span class="s2">var </span><span class="s0">YAML_TIMESTAMP_REGEXP </span><span class="s2">= new </span><span class="s6">RegExp</span><span class="s0">(</span>
  <span class="s4">'^([0-9][0-9][0-9][0-9])'          </span><span class="s2">+ </span><span class="s1">// [1] year</span>
  <span class="s4">'-([0-9][0-9]?)'                   </span><span class="s2">+ </span><span class="s1">// [2] month</span>
  <span class="s4">'-([0-9][0-9]?)'                   </span><span class="s2">+ </span><span class="s1">// [3] day</span>
  <span class="s4">'(?:[Tt]|[ </span><span class="s8">\\</span><span class="s4">t]+)'                 </span><span class="s2">+ </span><span class="s1">// ...</span>
  <span class="s4">'([0-9][0-9]?)'                    </span><span class="s2">+ </span><span class="s1">// [4] hour</span>
  <span class="s4">':([0-9][0-9])'                    </span><span class="s2">+ </span><span class="s1">// [5] minute</span>
  <span class="s4">':([0-9][0-9])'                    </span><span class="s2">+ </span><span class="s1">// [6] second</span>
  <span class="s4">'(?:</span><span class="s8">\\</span><span class="s4">.([0-9]*))?'                 </span><span class="s2">+ </span><span class="s1">// [7] fraction</span>
  <span class="s4">'(?:[ </span><span class="s8">\\</span><span class="s4">t]*(Z|([-+])([0-9][0-9]?)' </span><span class="s2">+ </span><span class="s1">// [8] tz [9] tz_sign [10] tz_hour</span>
  <span class="s4">'(?::([0-9][0-9]))?))?$'</span><span class="s0">);           // [11] tz_minute 
</span>
<span class="s2">function </span><span class="s0">resolveYamlTimestamp(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">YAML_DATE_REGEXP</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">data</span><span class="s0">) </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">YAML_TIMESTAMP_REGEXP</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">data</span><span class="s0">) </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
  <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlTimestamp(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">match, year, month, day, hour, minute, second, fraction </span><span class="s2">= </span><span class="s7">0</span><span class="s0">,</span>
      <span class="s0">delta </span><span class="s2">= </span><span class="s5">null</span><span class="s0">, tz_hour, tz_minute, date;</span>

  <span class="s3">match </span><span class="s2">= </span><span class="s3">YAML_DATE_REGEXP</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">data</span><span class="s0">);</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">match </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s3">match </span><span class="s2">= </span><span class="s3">YAML_TIMESTAMP_REGEXP</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">data</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">match </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">throw new </span><span class="s6">Error</span><span class="s0">(</span><span class="s4">'Date resolve error'</span><span class="s0">);</span>

  <span class="s1">// match: [1] year [2] month [3] day</span>

  <span class="s3">year </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">1</span><span class="s0">]);</span>
  <span class="s3">month </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">2</span><span class="s0">]) </span><span class="s2">- </span><span class="s7">1</span><span class="s0">; </span><span class="s1">// JS month starts with 0</span>
  <span class="s3">day </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">3</span><span class="s0">]);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">match</span><span class="s0">[</span><span class="s7">4</span><span class="s0">]) { </span><span class="s1">// no hour</span>
    <span class="s2">return new </span><span class="s6">Date</span><span class="s0">(</span><span class="s3">Date</span><span class="s0">.</span><span class="s6">UTC</span><span class="s0">(</span><span class="s3">year</span><span class="s0">, </span><span class="s3">month</span><span class="s0">, </span><span class="s3">day</span><span class="s0">));</span>
  <span class="s0">}</span>

  <span class="s1">// match: [4] hour [5] minute [6] second [7] fraction</span>

  <span class="s3">hour </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">4</span><span class="s0">]);</span>
  <span class="s3">minute </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">5</span><span class="s0">]);</span>
  <span class="s3">second </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">6</span><span class="s0">]);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">7</span><span class="s0">]) {</span>
    <span class="s3">fraction </span><span class="s2">= </span><span class="s3">match</span><span class="s0">[</span><span class="s7">7</span><span class="s0">].</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">0</span><span class="s0">, </span><span class="s7">3</span><span class="s0">);</span>
    <span class="s2">while </span><span class="s0">(</span><span class="s3">fraction</span><span class="s0">.length </span><span class="s2">&lt; </span><span class="s7">3</span><span class="s0">) { </span><span class="s1">// milli-seconds</span>
      <span class="s3">fraction </span><span class="s2">+= </span><span class="s4">'0'</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s3">fraction </span><span class="s2">= +</span><span class="s3">fraction</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s1">// match: [8] tz [9] tz_sign [10] tz_hour [11] tz_minute</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">9</span><span class="s0">]) {</span>
    <span class="s3">tz_hour </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">10</span><span class="s0">]);</span>
    <span class="s3">tz_minute </span><span class="s2">= +</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">11</span><span class="s0">] </span><span class="s2">|| </span><span class="s7">0</span><span class="s0">);</span>
    <span class="s3">delta </span><span class="s2">= </span><span class="s0">(</span><span class="s3">tz_hour </span><span class="s2">* </span><span class="s7">60 </span><span class="s2">+ </span><span class="s3">tz_minute</span><span class="s0">) </span><span class="s2">* </span><span class="s7">60000</span><span class="s0">; </span><span class="s1">// delta in mili-seconds</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">9</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'-'</span><span class="s0">) </span><span class="s3">delta </span><span class="s2">= -</span><span class="s3">delta</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">date </span><span class="s2">= new </span><span class="s6">Date</span><span class="s0">(</span><span class="s3">Date</span><span class="s0">.</span><span class="s6">UTC</span><span class="s0">(</span><span class="s3">year</span><span class="s0">, </span><span class="s3">month</span><span class="s0">, </span><span class="s3">day</span><span class="s0">, </span><span class="s3">hour</span><span class="s0">, </span><span class="s3">minute</span><span class="s0">, </span><span class="s3">second</span><span class="s0">, </span><span class="s3">fraction</span><span class="s0">));</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">delta</span><span class="s0">) </span><span class="s3">date</span><span class="s0">.</span><span class="s6">setTime</span><span class="s0">(</span><span class="s3">date</span><span class="s0">.</span><span class="s6">getTime</span><span class="s0">() </span><span class="s2">- </span><span class="s3">delta</span><span class="s0">);</span>

  <span class="s2">return </span><span class="s3">date</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">representYamlTimestamp(</span><span class="s3">object </span><span class="s1">/*, style*/</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">object</span><span class="s0">.</span><span class="s6">toISOString</span><span class="s0">();</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">timestamp </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:timestamp'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlTimestamp</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlTimestamp</span><span class="s0">,</span>
  <span class="s0">instanceOf: </span><span class="s3">Date</span><span class="s0">,</span>
  <span class="s0">represent: </span><span class="s3">representYamlTimestamp</span>
<span class="s0">});</span>

<span class="s2">function </span><span class="s0">resolveYamlMerge(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s2">=== </span><span class="s4">'&lt;&lt;' </span><span class="s2">|| </span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">merge </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:merge'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlMerge</span>
<span class="s0">});</span>

<span class="s1">/*eslint-disable no-bitwise*/</span>





<span class="s1">// [ 64, 65, 66 ] -&gt; [ padding, CR, LF ]</span>
<span class="s2">var </span><span class="s0">BASE64_MAP </span><span class="s2">= </span><span class="s4">'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=</span><span class="s8">\n\r</span><span class="s4">'</span><span class="s0">;</span>


<span class="s2">function </span><span class="s0">resolveYamlBinary(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">code, idx, bitlen </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, max </span><span class="s2">= </span><span class="s3">data</span><span class="s0">.length, map </span><span class="s2">= </span><span class="s3">BASE64_MAP</span><span class="s0">;</span>

  <span class="s1">// Convert one by one.</span>
  <span class="s2">for </span><span class="s0">(</span><span class="s3">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">idx </span><span class="s2">&lt; </span><span class="s3">max</span><span class="s0">; </span><span class="s3">idx</span><span class="s2">++</span><span class="s0">) {</span>
    <span class="s3">code </span><span class="s2">= </span><span class="s3">map</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">data</span><span class="s0">.</span><span class="s6">charAt</span><span class="s0">(</span><span class="s3">idx</span><span class="s0">));</span>

    <span class="s1">// Skip CR/LF</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">code </span><span class="s2">&gt; </span><span class="s7">64</span><span class="s0">) </span><span class="s2">continue</span><span class="s0">;</span>

    <span class="s1">// Fail on illegal characters</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">code </span><span class="s2">&lt; </span><span class="s7">0</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

    <span class="s3">bitlen </span><span class="s2">+= </span><span class="s7">6</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s1">// If there are any bits left, source was corrupted</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s3">bitlen </span><span class="s2">% </span><span class="s7">8</span><span class="s0">) </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlBinary(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">idx, tailbits,</span>
      <span class="s0">input </span><span class="s2">= </span><span class="s3">data</span><span class="s0">.</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">/</span><span class="s5">[\r\n=]</span><span class="s4">/</span><span class="s2">g</span><span class="s0">, </span><span class="s4">''</span><span class="s0">), </span><span class="s1">// remove CR/LF &amp; padding to simplify scan 
      </span><span class="s0">max </span><span class="s2">= </span><span class="s3">input</span><span class="s0">.length,</span>
      <span class="s0">map </span><span class="s2">= </span><span class="s3">BASE64_MAP</span><span class="s0">,</span>
      <span class="s0">bits </span><span class="s2">= </span><span class="s7">0</span><span class="s0">,</span>
      <span class="s0">result </span><span class="s2">= </span><span class="s0">[];</span>

  <span class="s1">// Collect by 6*4 bits (3 bytes)</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">idx </span><span class="s2">&lt; </span><span class="s3">max</span><span class="s0">; </span><span class="s3">idx</span><span class="s2">++</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">((</span><span class="s3">idx </span><span class="s2">% </span><span class="s7">4 </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">idx</span><span class="s0">) {</span>
      <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">((</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">16</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
      <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">((</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">8</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
      <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">bits </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">bits </span><span class="s2">= </span><span class="s0">(</span><span class="s3">bits </span><span class="s2">&lt;&lt; </span><span class="s7">6</span><span class="s0">) </span><span class="s2">| </span><span class="s3">map</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charAt</span><span class="s0">(</span><span class="s3">idx</span><span class="s0">));</span>
  <span class="s0">}</span>

  <span class="s1">// Dump tail</span>

  <span class="s3">tailbits </span><span class="s2">= </span><span class="s0">(</span><span class="s3">max </span><span class="s2">% </span><span class="s7">4</span><span class="s0">) </span><span class="s2">* </span><span class="s7">6</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">tailbits </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">((</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">16</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
    <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">((</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">8</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
    <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">bits </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">tailbits </span><span class="s2">=== </span><span class="s7">18</span><span class="s0">) {</span>
    <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">((</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">10</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
    <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">((</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">2</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">tailbits </span><span class="s2">=== </span><span class="s7">12</span><span class="s0">) {</span>
    <span class="s3">result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">((</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">4</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0xFF</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return new </span><span class="s6">Uint8Array</span><span class="s0">(</span><span class="s3">result</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">representYamlBinary(</span><span class="s3">object </span><span class="s1">/*, style*/</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">, bits </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, idx, tail,</span>
      <span class="s0">max </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.length,</span>
      <span class="s0">map </span><span class="s2">= </span><span class="s3">BASE64_MAP</span><span class="s0">;</span>

  <span class="s1">// Convert every three bytes to 4 ASCII characters.</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">idx </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">idx </span><span class="s2">&lt; </span><span class="s3">max</span><span class="s0">; </span><span class="s3">idx</span><span class="s2">++</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">((</span><span class="s3">idx </span><span class="s2">% </span><span class="s7">3 </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">idx</span><span class="s0">) {</span>
      <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">18</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
      <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">12</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
      <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">6</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
      <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[</span><span class="s3">bits </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s0">}</span>

    <span class="s3">bits </span><span class="s2">= </span><span class="s0">(</span><span class="s3">bits </span><span class="s2">&lt;&lt; </span><span class="s7">8</span><span class="s0">) </span><span class="s2">+ </span><span class="s3">object</span><span class="s0">[</span><span class="s3">idx</span><span class="s0">];</span>
  <span class="s0">}</span>

  <span class="s1">// Dump tail</span>

  <span class="s3">tail </span><span class="s2">= </span><span class="s3">max </span><span class="s2">% </span><span class="s7">3</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">tail </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">18</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">12</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">6</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[</span><span class="s3">bits </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">tail </span><span class="s2">=== </span><span class="s7">2</span><span class="s0">) {</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">10</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">4</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&lt;&lt; </span><span class="s7">2</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[</span><span class="s7">64</span><span class="s0">];</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">tail </span><span class="s2">=== </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&gt;&gt; </span><span class="s7">2</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[(</span><span class="s3">bits </span><span class="s2">&lt;&lt; </span><span class="s7">4</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x3F</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[</span><span class="s7">64</span><span class="s0">];</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">map</span><span class="s0">[</span><span class="s7">64</span><span class="s0">];</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">isBinary(</span><span class="s3">obj</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">Object.prototype.</span><span class="s3">toString</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">obj</span><span class="s0">) </span><span class="s2">===  </span><span class="s4">'[object Uint8Array]'</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">binary </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:binary'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'scalar'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlBinary</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlBinary</span><span class="s0">,</span>
  <span class="s0">predicate: </span><span class="s3">isBinary</span><span class="s0">,</span>
  <span class="s0">represent: </span><span class="s3">representYamlBinary</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">_hasOwnProperty$3 </span><span class="s2">= </span><span class="s0">Object.prototype.</span><span class="s3">hasOwnProperty</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">_toString$2       </span><span class="s2">= </span><span class="s0">Object.prototype.</span><span class="s3">toString</span><span class="s0">;</span>

<span class="s2">function </span><span class="s0">resolveYamlOmap(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">objectKeys </span><span class="s2">= </span><span class="s0">[], index, length, pair, pairKey, pairHasKey,</span>
      <span class="s0">object </span><span class="s2">= </span><span class="s3">data</span><span class="s0">;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">pair </span><span class="s2">= </span><span class="s3">object</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
    <span class="s3">pairHasKey </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">_toString$2</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">pair</span><span class="s0">) </span><span class="s2">!== </span><span class="s4">'[object Object]'</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

    <span class="s2">for </span><span class="s0">(</span><span class="s3">pairKey </span><span class="s2">in </span><span class="s3">pair</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">_hasOwnProperty$3</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">pair</span><span class="s0">, </span><span class="s3">pairKey</span><span class="s0">)) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">pairHasKey</span><span class="s0">) </span><span class="s3">pairHasKey </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s2">else return </span><span class="s5">false</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">pairHasKey</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">objectKeys</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">pairKey</span><span class="s0">) </span><span class="s2">=== -</span><span class="s7">1</span><span class="s0">) </span><span class="s3">objectKeys</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">pairKey</span><span class="s0">);</span>
    <span class="s2">else return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlOmap(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">? </span><span class="s3">data </span><span class="s2">: </span><span class="s0">[];</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">omap </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:omap'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'sequence'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlOmap</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlOmap</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">_toString$1 </span><span class="s2">= </span><span class="s0">Object.prototype.</span><span class="s3">toString</span><span class="s0">;</span>

<span class="s2">function </span><span class="s0">resolveYamlPairs(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">index, length, pair, keys, result,</span>
      <span class="s0">object </span><span class="s2">= </span><span class="s3">data</span><span class="s0">;</span>

  <span class="s3">result </span><span class="s2">= new </span><span class="s6">Array</span><span class="s0">(</span><span class="s3">object</span><span class="s0">.length);</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">pair </span><span class="s2">= </span><span class="s3">object</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">_toString$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">pair</span><span class="s0">) </span><span class="s2">!== </span><span class="s4">'[object Object]'</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

    <span class="s3">keys </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">pair</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">keys</span><span class="s0">.length </span><span class="s2">!== </span><span class="s7">1</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

    <span class="s3">result</span><span class="s0">[</span><span class="s3">index</span><span class="s0">] </span><span class="s2">= </span><span class="s0">[ </span><span class="s3">keys</span><span class="s0">[</span><span class="s7">0</span><span class="s0">], </span><span class="s3">pair</span><span class="s0">[</span><span class="s3">keys</span><span class="s0">[</span><span class="s7">0</span><span class="s0">]] ];</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlPairs(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s0">[];</span>

  <span class="s2">var </span><span class="s0">index, length, pair, keys, result,</span>
      <span class="s0">object </span><span class="s2">= </span><span class="s3">data</span><span class="s0">;</span>

  <span class="s3">result </span><span class="s2">= new </span><span class="s6">Array</span><span class="s0">(</span><span class="s3">object</span><span class="s0">.length);</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">pair </span><span class="s2">= </span><span class="s3">object</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s3">keys </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">pair</span><span class="s0">);</span>

    <span class="s3">result</span><span class="s0">[</span><span class="s3">index</span><span class="s0">] </span><span class="s2">= </span><span class="s0">[ </span><span class="s3">keys</span><span class="s0">[</span><span class="s7">0</span><span class="s0">], </span><span class="s3">pair</span><span class="s0">[</span><span class="s3">keys</span><span class="s0">[</span><span class="s7">0</span><span class="s0">]] ];</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">pairs </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:pairs'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'sequence'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlPairs</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlPairs</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">_hasOwnProperty$2 </span><span class="s2">= </span><span class="s0">Object.prototype.</span><span class="s3">hasOwnProperty</span><span class="s0">;</span>

<span class="s2">function </span><span class="s0">resolveYamlSet(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">data </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>

  <span class="s2">var </span><span class="s0">key, object </span><span class="s2">= </span><span class="s3">data</span><span class="s0">;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">key </span><span class="s2">in </span><span class="s3">object</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">_hasOwnProperty$2</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">key</span><span class="s0">)) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">object</span><span class="s0">[</span><span class="s3">key</span><span class="s0">] </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">constructYamlSet(</span><span class="s3">data</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">data </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">? </span><span class="s3">data </span><span class="s2">: </span><span class="s0">{};</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">set </span><span class="s2">= new </span><span class="s6">type</span><span class="s0">(</span><span class="s4">'tag:yaml.org,2002:set'</span><span class="s0">, {</span>
  <span class="s0">kind: </span><span class="s4">'mapping'</span><span class="s0">,</span>
  <span class="s0">resolve: </span><span class="s3">resolveYamlSet</span><span class="s0">,</span>
  <span class="s0">construct: </span><span class="s3">constructYamlSet</span>
<span class="s0">});</span>

<span class="s2">var </span><span class="s0">_default </span><span class="s2">= </span><span class="s3">core</span><span class="s0">.</span><span class="s6">extend</span><span class="s0">({</span>
  <span class="s0">implicit: [</span>
    <span class="s3">timestamp</span><span class="s0">,</span>
    <span class="s3">merge</span>
  <span class="s0">],</span>
  <span class="s0">explicit: [</span>
    <span class="s3">binary</span><span class="s0">,</span>
    <span class="s3">omap</span><span class="s0">,</span>
    <span class="s3">pairs</span><span class="s0">,</span>
    <span class="s3">set</span>
  <span class="s0">]</span>
<span class="s0">});</span>

<span class="s1">/*eslint-disable max-len,no-use-before-define*/</span>







<span class="s2">var </span><span class="s0">_hasOwnProperty$1 </span><span class="s2">= </span><span class="s0">Object.prototype.</span><span class="s3">hasOwnProperty</span><span class="s0">;</span>


<span class="s2">var </span><span class="s0">CONTEXT_FLOW_IN   </span><span class="s2">= </span><span class="s7">1</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">CONTEXT_FLOW_OUT  </span><span class="s2">= </span><span class="s7">2</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">CONTEXT_BLOCK_IN  </span><span class="s2">= </span><span class="s7">3</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">CONTEXT_BLOCK_OUT </span><span class="s2">= </span><span class="s7">4</span><span class="s0">;</span>


<span class="s2">var </span><span class="s0">CHOMPING_CLIP  </span><span class="s2">= </span><span class="s7">1</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">CHOMPING_STRIP </span><span class="s2">= </span><span class="s7">2</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">CHOMPING_KEEP  </span><span class="s2">= </span><span class="s7">3</span><span class="s0">;</span>


<span class="s2">var </span><span class="s0">PATTERN_NON_PRINTABLE         </span><span class="s2">= </span><span class="s4">/</span><span class="s5">[\x00-\x08\x0B\x0C\x0E-\x1F\x7F-\x84\x86-\x9F\uFFFE\uFFFF]</span><span class="s2">|</span><span class="s5">[\uD800-\uDBFF]</span><span class="s4">(?!</span><span class="s5">[\uDC00-\uDFFF]</span><span class="s4">)</span><span class="s2">|</span><span class="s4">(?:</span><span class="s5">[</span><span class="s8">^</span><span class="s5">\uD800-\uDBFF]</span><span class="s2">|^</span><span class="s4">)</span><span class="s5">[\uDC00-\uDFFF]</span><span class="s4">/</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">PATTERN_NON_ASCII_LINE_BREAKS </span><span class="s2">= </span><span class="s4">/</span><span class="s5">[\x85\u2028\u2029]</span><span class="s4">/</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">PATTERN_FLOW_INDICATORS       </span><span class="s2">= </span><span class="s4">/</span><span class="s5">[,</span><span class="s8">\[\]\{\}</span><span class="s5">]</span><span class="s4">/</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">PATTERN_TAG_HANDLE            </span><span class="s2">= </span><span class="s4">/</span><span class="s2">^</span><span class="s4">(?:!</span><span class="s2">|</span><span class="s4">!!</span><span class="s2">|</span><span class="s4">!</span><span class="s5">[a-z</span><span class="s8">\-</span><span class="s5">]</span><span class="s2">+</span><span class="s4">!)</span><span class="s2">$</span><span class="s4">/</span><span class="s2">i</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">PATTERN_TAG_URI               </span><span class="s2">= </span><span class="s4">/</span><span class="s2">^</span><span class="s4">(?:!</span><span class="s2">|</span><span class="s5">[</span><span class="s8">^</span><span class="s5">,</span><span class="s8">\[\]\{\}</span><span class="s5">]</span><span class="s4">)(?:%</span><span class="s5">[0-9a-f]</span><span class="s2">{2}|</span><span class="s5">[0-9a-z\-#;</span><span class="s8">\/\?</span><span class="s5">:@&amp;=</span><span class="s8">\+\$</span><span class="s5">,_</span><span class="s8">\.</span><span class="s5">!~</span><span class="s8">\*</span><span class="s5">'</span><span class="s8">\(\)\[\]</span><span class="s5">]</span><span class="s4">)</span><span class="s2">*$</span><span class="s4">/</span><span class="s2">i</span><span class="s0">;</span>


<span class="s2">function </span><span class="s0">_class(</span><span class="s3">obj</span><span class="s0">) { </span><span class="s2">return </span><span class="s0">Object.prototype.</span><span class="s3">toString</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">obj</span><span class="s0">); }</span>

<span class="s2">function </span><span class="s0">is_EOL(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x0A</span><span class="s1">/* LF */</span><span class="s0">) </span><span class="s2">|| </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x0D</span><span class="s1">/* CR */</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">is_WHITE_SPACE(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x09</span><span class="s1">/* Tab */</span><span class="s0">) </span><span class="s2">|| </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x20</span><span class="s1">/* Space */</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">is_WS_OR_EOL(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x09</span><span class="s1">/* Tab */</span><span class="s0">) </span><span class="s2">||</span>
         <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x20</span><span class="s1">/* Space */</span><span class="s0">) </span><span class="s2">||</span>
         <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x0A</span><span class="s1">/* LF */</span><span class="s0">) </span><span class="s2">||</span>
         <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x0D</span><span class="s1">/* CR */</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">is_FLOW_INDICATOR(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x2C</span><span class="s1">/* , */ </span><span class="s2">||</span>
         <span class="s3">c </span><span class="s2">=== </span><span class="s7">0x5B</span><span class="s1">/* [ */ </span><span class="s2">||</span>
         <span class="s3">c </span><span class="s2">=== </span><span class="s7">0x5D</span><span class="s1">/* ] */ </span><span class="s2">||</span>
         <span class="s3">c </span><span class="s2">=== </span><span class="s7">0x7B</span><span class="s1">/* { */ </span><span class="s2">||</span>
         <span class="s3">c </span><span class="s2">=== </span><span class="s7">0x7D</span><span class="s1">/* } */</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">fromHexCode(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">lc;</span>

  <span class="s2">if </span><span class="s0">((</span><span class="s7">0x30</span><span class="s1">/* 0 */ </span><span class="s2">&lt;= </span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x39</span><span class="s1">/* 9 */</span><span class="s0">)) {</span>
    <span class="s2">return </span><span class="s3">c </span><span class="s2">- </span><span class="s7">0x30</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s1">/*eslint-disable no-bitwise*/</span>
  <span class="s3">lc </span><span class="s2">= </span><span class="s3">c </span><span class="s2">| </span><span class="s7">0x20</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">((</span><span class="s7">0x61</span><span class="s1">/* a */ </span><span class="s2">&lt;= </span><span class="s3">lc</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">lc </span><span class="s2">&lt;= </span><span class="s7">0x66</span><span class="s1">/* f */</span><span class="s0">)) {</span>
    <span class="s2">return </span><span class="s3">lc </span><span class="s2">- </span><span class="s7">0x61 </span><span class="s2">+ </span><span class="s7">10</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return -</span><span class="s7">1</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">escapedHexLen(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x78</span><span class="s1">/* x */</span><span class="s0">) { </span><span class="s2">return </span><span class="s7">2</span><span class="s0">; }</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x75</span><span class="s1">/* u */</span><span class="s0">) { </span><span class="s2">return </span><span class="s7">4</span><span class="s0">; }</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x55</span><span class="s1">/* U */</span><span class="s0">) { </span><span class="s2">return </span><span class="s7">8</span><span class="s0">; }</span>
  <span class="s2">return </span><span class="s7">0</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">fromDecimalCode(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">((</span><span class="s7">0x30</span><span class="s1">/* 0 */ </span><span class="s2">&lt;= </span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x39</span><span class="s1">/* 9 */</span><span class="s0">)) {</span>
    <span class="s2">return </span><span class="s3">c </span><span class="s2">- </span><span class="s7">0x30</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return -</span><span class="s7">1</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">simpleEscapeSequence(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s1">/* eslint-disable indent */</span>
  <span class="s2">return </span><span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x30</span><span class="s1">/* 0 */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x00</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x61</span><span class="s1">/* a */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x07</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x62</span><span class="s1">/* b */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x08</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x74</span><span class="s1">/* t */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x09</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x09</span><span class="s1">/* Tab */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x09</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x6E</span><span class="s1">/* n */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x0A</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x76</span><span class="s1">/* v */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x0B</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x66</span><span class="s1">/* f */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x0C</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x72</span><span class="s1">/* r */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x0D</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x65</span><span class="s1">/* e */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x1B</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x20</span><span class="s1">/* Space */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">' ' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x22</span><span class="s1">/* &quot; */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x22</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x2F</span><span class="s1">/* / */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'/' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x5C</span><span class="s1">/* \ */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x5C</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x4E</span><span class="s1">/* N */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\x85</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x5F</span><span class="s1">/* _ */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\xA0</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x4C</span><span class="s1">/* L */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\u2028</span><span class="s4">' </span><span class="s2">:</span>
        <span class="s0">(</span><span class="s3">c </span><span class="s2">=== </span><span class="s7">0x50</span><span class="s1">/* P */</span><span class="s0">) </span><span class="s2">? </span><span class="s4">'</span><span class="s8">\u2029</span><span class="s4">' </span><span class="s2">: </span><span class="s4">''</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">charFromCodepoint(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0xFFFF</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s3">String</span><span class="s0">.</span><span class="s6">fromCharCode</span><span class="s0">(</span><span class="s3">c</span><span class="s0">);</span>
  <span class="s0">}</span>
  <span class="s1">// Encode UTF-16 surrogate pair</span>
  <span class="s1">// https://en.wikipedia.org/wiki/UTF-16#Code_points_U.2B010000_to_U.2B10FFFF</span>
  <span class="s2">return </span><span class="s3">String</span><span class="s0">.</span><span class="s6">fromCharCode</span><span class="s0">(</span>
    <span class="s0">((</span><span class="s3">c </span><span class="s2">- </span><span class="s7">0x010000</span><span class="s0">) </span><span class="s2">&gt;&gt; </span><span class="s7">10</span><span class="s0">) </span><span class="s2">+ </span><span class="s7">0xD800</span><span class="s0">,</span>
    <span class="s0">((</span><span class="s3">c </span><span class="s2">- </span><span class="s7">0x010000</span><span class="s0">) </span><span class="s2">&amp; </span><span class="s7">0x03FF</span><span class="s0">) </span><span class="s2">+ </span><span class="s7">0xDC00</span>
  <span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">simpleEscapeCheck </span><span class="s2">= new </span><span class="s6">Array</span><span class="s0">(</span><span class="s7">256</span><span class="s0">); </span><span class="s1">// integer, for fast access</span>
<span class="s2">var </span><span class="s0">simpleEscapeMap </span><span class="s2">= new </span><span class="s6">Array</span><span class="s0">(</span><span class="s7">256</span><span class="s0">);</span>
<span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">i </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">i </span><span class="s2">&lt; </span><span class="s7">256</span><span class="s0">; </span><span class="s3">i</span><span class="s2">++</span><span class="s0">) {</span>
  <span class="s3">simpleEscapeCheck</span><span class="s0">[</span><span class="s3">i</span><span class="s0">] </span><span class="s2">= </span><span class="s6">simpleEscapeSequence</span><span class="s0">(</span><span class="s3">i</span><span class="s0">) </span><span class="s2">? </span><span class="s7">1 </span><span class="s2">: </span><span class="s7">0</span><span class="s0">;</span>
  <span class="s3">simpleEscapeMap</span><span class="s0">[</span><span class="s3">i</span><span class="s0">] </span><span class="s2">= </span><span class="s6">simpleEscapeSequence</span><span class="s0">(</span><span class="s3">i</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">State$1(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">input </span><span class="s2">= </span><span class="s3">input</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">filename  </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'filename'</span><span class="s0">]  </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">schema    </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'schema'</span><span class="s0">]    </span><span class="s2">|| </span><span class="s3">_default</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">onWarning </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'onWarning'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s1">// (Hidden) Remove? makes the loader to expect YAML 1.1 documents</span>
  <span class="s1">// if such documents have no explicit %YAML directive</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">legacy    </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'legacy'</span><span class="s0">]    </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">json      </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'json'</span><span class="s0">]      </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">listener  </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'listener'</span><span class="s0">]  </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">implicitTypes </span><span class="s2">= </span><span class="s3">this</span><span class="s0">.</span><span class="s3">schema</span><span class="s0">.</span><span class="s3">compiledImplicit</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">typeMap       </span><span class="s2">= </span><span class="s3">this</span><span class="s0">.</span><span class="s3">schema</span><span class="s0">.</span><span class="s3">compiledTypeMap</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.length     </span><span class="s2">= </span><span class="s3">input</span><span class="s0">.length;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">position   </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">line       </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">lineStart  </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>

  <span class="s1">// position of first leading tab in the current line,</span>
  <span class="s1">// used to make sure there are no tabs in the indentation</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">documents </span><span class="s2">= </span><span class="s0">[];</span>

  <span class="s1">/*</span>
  <span class="s1">this.version; 
  this.checkLineBreaks; 
  this.tagMap; 
  this.anchorMap; 
  this.tag; 
  this.anchor; 
  this.kind; 
  this.result;*/</span>

<span class="s0">}</span>


<span class="s2">function </span><span class="s0">generateError(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">message</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">mark </span><span class="s2">= </span><span class="s0">{</span>
    <span class="s0">name:     </span><span class="s3">state</span><span class="s0">.</span><span class="s3">filename</span><span class="s0">,</span>
    <span class="s0">buffer:   </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">0</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">), </span><span class="s1">// omit trailing \0</span>
    <span class="s0">position: </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">,</span>
    <span class="s0">line:     </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">,</span>
    <span class="s0">column:   </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">- </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart</span>
  <span class="s0">};</span>

  <span class="s3">mark</span><span class="s0">.</span><span class="s3">snippet </span><span class="s2">= </span><span class="s6">snippet</span><span class="s0">(</span><span class="s3">mark</span><span class="s0">);</span>

  <span class="s2">return new </span><span class="s6">exception</span><span class="s0">(</span><span class="s3">message</span><span class="s0">, </span><span class="s3">mark</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">throwError(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">message</span><span class="s0">) {</span>
  <span class="s2">throw </span><span class="s6">generateError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">message</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">throwWarning(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">message</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">onWarning</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">onWarning</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s5">null</span><span class="s0">, </span><span class="s6">generateError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">message</span><span class="s0">));</span>
  <span class="s0">}</span>
<span class="s0">}</span>


<span class="s2">var </span><span class="s0">directiveHandlers </span><span class="s2">= </span><span class="s0">{</span>

  <span class="s6">YAML</span><span class="s0">: </span><span class="s2">function </span><span class="s0">handleYamlDirective(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">name</span><span class="s0">, </span><span class="s3">args</span><span class="s0">) {</span>

    <span class="s2">var </span><span class="s0">match, major, minor;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">version </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'duplication of %YAML directive'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">args</span><span class="s0">.length </span><span class="s2">!== </span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'YAML directive accepts exactly one argument'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">match </span><span class="s2">= </span><span class="s4">/</span><span class="s2">^</span><span class="s4">(</span><span class="s5">[0-9]</span><span class="s2">+</span><span class="s4">)</span><span class="s8">\.</span><span class="s4">(</span><span class="s5">[0-9]</span><span class="s2">+</span><span class="s4">)</span><span class="s2">$</span><span class="s4">/</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">args</span><span class="s0">[</span><span class="s7">0</span><span class="s0">]);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">match </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'ill-formed argument of the YAML directive'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">major </span><span class="s2">= </span><span class="s6">parseInt</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">1</span><span class="s0">], </span><span class="s7">10</span><span class="s0">);</span>
    <span class="s3">minor </span><span class="s2">= </span><span class="s6">parseInt</span><span class="s0">(</span><span class="s3">match</span><span class="s0">[</span><span class="s7">2</span><span class="s0">], </span><span class="s7">10</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">major </span><span class="s2">!== </span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unacceptable YAML version of the document'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">state</span><span class="s0">.</span><span class="s3">version </span><span class="s2">= </span><span class="s3">args</span><span class="s0">[</span><span class="s7">0</span><span class="s0">];</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">checkLineBreaks </span><span class="s2">= </span><span class="s0">(</span><span class="s3">minor </span><span class="s2">&lt; </span><span class="s7">2</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">minor </span><span class="s2">!== </span><span class="s7">1 </span><span class="s2">&amp;&amp; </span><span class="s3">minor </span><span class="s2">!== </span><span class="s7">2</span><span class="s0">) {</span>
      <span class="s6">throwWarning</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unsupported YAML version of the document'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">},</span>

  <span class="s6">TAG</span><span class="s0">: </span><span class="s2">function </span><span class="s0">handleTagDirective(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">name</span><span class="s0">, </span><span class="s3">args</span><span class="s0">) {</span>

    <span class="s2">var </span><span class="s0">handle, prefix;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">args</span><span class="s0">.length </span><span class="s2">!== </span><span class="s7">2</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'TAG directive accepts exactly two arguments'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">handle </span><span class="s2">= </span><span class="s3">args</span><span class="s0">[</span><span class="s7">0</span><span class="s0">];</span>
    <span class="s3">prefix </span><span class="s2">= </span><span class="s3">args</span><span class="s0">[</span><span class="s7">1</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">PATTERN_TAG_HANDLE</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">handle</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'ill-formed tag handle (first argument) of the TAG directive'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tagMap</span><span class="s0">, </span><span class="s3">handle</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'there is a previously declared suffix for &quot;' </span><span class="s2">+ </span><span class="s3">handle </span><span class="s2">+ </span><span class="s4">'&quot; tag handle'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">PATTERN_TAG_URI</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">prefix</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'ill-formed tag prefix (second argument) of the TAG directive'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">try </span><span class="s0">{</span>
      <span class="s3">prefix </span><span class="s2">= </span><span class="s6">decodeURIComponent</span><span class="s0">(</span><span class="s3">prefix</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">catch </span><span class="s0">(</span><span class="s3">err</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'tag prefix is malformed: ' </span><span class="s2">+ </span><span class="s3">prefix</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">state</span><span class="s0">.</span><span class="s3">tagMap</span><span class="s0">[</span><span class="s3">handle</span><span class="s0">] </span><span class="s2">= </span><span class="s3">prefix</span><span class="s0">;</span>
  <span class="s0">}</span>
<span class="s0">};</span>


<span class="s2">function </span><span class="s0">captureSegment(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">start</span><span class="s0">, </span><span class="s3">end</span><span class="s0">, </span><span class="s3">checkJson</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_position, _length, _character, _result;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">start </span><span class="s2">&lt; </span><span class="s3">end</span><span class="s0">) {</span>
    <span class="s3">_result </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">start</span><span class="s0">, </span><span class="s3">end</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">checkJson</span><span class="s0">) {</span>
      <span class="s2">for </span><span class="s0">(</span><span class="s3">_position </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">_length </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">.length; </span><span class="s3">_position </span><span class="s2">&lt; </span><span class="s3">_length</span><span class="s0">; </span><span class="s3">_position </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
        <span class="s3">_character </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">);</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s0">(</span><span class="s3">_character </span><span class="s2">=== </span><span class="s7">0x09 </span><span class="s2">||</span>
              <span class="s0">(</span><span class="s7">0x20 </span><span class="s2">&lt;= </span><span class="s3">_character </span><span class="s2">&amp;&amp; </span><span class="s3">_character </span><span class="s2">&lt;= </span><span class="s7">0x10FFFF</span><span class="s0">))) {</span>
          <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'expected valid JSON character'</span><span class="s0">);</span>
        <span class="s0">}</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">PATTERN_NON_PRINTABLE</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">_result</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'the stream contains non-printable characters'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">_result</span><span class="s0">;</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">mergeMappings(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">destination</span><span class="s0">, </span><span class="s3">source</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">sourceKeys, key, index, quantity;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">common</span><span class="s0">.</span><span class="s6">isObject</span><span class="s0">(</span><span class="s3">source</span><span class="s0">)) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'cannot merge mappings; the provided source object is unacceptable'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">sourceKeys </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">source</span><span class="s0">);</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">quantity </span><span class="s2">= </span><span class="s3">sourceKeys</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">quantity</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">key </span><span class="s2">= </span><span class="s3">sourceKeys</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">destination</span><span class="s0">, </span><span class="s3">key</span><span class="s0">)) {</span>
      <span class="s3">destination</span><span class="s0">[</span><span class="s3">key</span><span class="s0">] </span><span class="s2">= </span><span class="s3">source</span><span class="s0">[</span><span class="s3">key</span><span class="s0">];</span>
      <span class="s3">overridableKeys</span><span class="s0">[</span><span class="s3">key</span><span class="s0">] </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">storeMappingPair(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyTag</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, </span><span class="s3">valueNode</span><span class="s0">,</span>
  <span class="s3">startLine</span><span class="s0">, </span><span class="s3">startLineStart</span><span class="s0">, </span><span class="s3">startPos</span><span class="s0">) {</span>

  <span class="s2">var </span><span class="s0">index, quantity;</span>

  <span class="s1">// The output is a plain object here, so keys can only be strings.</span>
  <span class="s1">// We need to convert keyNode to a string, but doing so can hang the process</span>
  <span class="s1">// (deeply nested arrays that explode exponentially using aliases).</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">keyNode</span><span class="s0">)) {</span>
    <span class="s3">keyNode </span><span class="s2">= </span><span class="s0">Array.prototype.</span><span class="s3">slice</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">keyNode</span><span class="s0">);</span>

    <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">quantity </span><span class="s2">= </span><span class="s3">keyNode</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">quantity</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">keyNode</span><span class="s0">[</span><span class="s3">index</span><span class="s0">])) {</span>
        <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'nested arrays are not supported inside keys'</span><span class="s0">);</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">keyNode </span><span class="s2">=== </span><span class="s4">'object' </span><span class="s2">&amp;&amp; </span><span class="s6">_class</span><span class="s0">(</span><span class="s3">keyNode</span><span class="s0">[</span><span class="s3">index</span><span class="s0">]) </span><span class="s2">=== </span><span class="s4">'[object Object]'</span><span class="s0">) {</span>
        <span class="s3">keyNode</span><span class="s0">[</span><span class="s3">index</span><span class="s0">] </span><span class="s2">= </span><span class="s4">'[object Object]'</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s1">// Avoid code execution in load() via toString property</span>
  <span class="s1">// (still use its own toString for arrays, timestamps,</span>
  <span class="s1">// and whatever user schema extensions happen to have @@toStringTag)</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">keyNode </span><span class="s2">=== </span><span class="s4">'object' </span><span class="s2">&amp;&amp; </span><span class="s6">_class</span><span class="s0">(</span><span class="s3">keyNode</span><span class="s0">) </span><span class="s2">=== </span><span class="s4">'[object Object]'</span><span class="s0">) {</span>
    <span class="s3">keyNode </span><span class="s2">= </span><span class="s4">'[object Object]'</span><span class="s0">;</span>
  <span class="s0">}</span>


  <span class="s3">keyNode </span><span class="s2">= </span><span class="s6">String</span><span class="s0">(</span><span class="s3">keyNode</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">_result </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s3">_result </span><span class="s2">= </span><span class="s0">{};</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">keyTag </span><span class="s2">=== </span><span class="s4">'tag:yaml.org,2002:merge'</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">valueNode</span><span class="s0">)) {</span>
      <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">quantity </span><span class="s2">= </span><span class="s3">valueNode</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">quantity</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
        <span class="s6">mergeMappings</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">valueNode</span><span class="s0">[</span><span class="s3">index</span><span class="s0">], </span><span class="s3">overridableKeys</span><span class="s0">);</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s6">mergeMappings</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">valueNode</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">state</span><span class="s0">.</span><span class="s3">json </span><span class="s2">&amp;&amp;</span>
        <span class="s2">!</span><span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">) </span><span class="s2">&amp;&amp;</span>
        <span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">_result</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">)) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">= </span><span class="s3">startLine </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart </span><span class="s2">= </span><span class="s3">startLineStart </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart</span><span class="s0">;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">= </span><span class="s3">startPos </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'duplicated mapping key'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s1">// used for this specific key only because Object.defineProperty is slow</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">keyNode </span><span class="s2">=== </span><span class="s4">'__proto__'</span><span class="s0">) {</span>
      <span class="s3">Object</span><span class="s0">.</span><span class="s6">defineProperty</span><span class="s0">(</span><span class="s3">_result</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, {</span>
        <span class="s0">configurable: </span><span class="s5">true</span><span class="s0">,</span>
        <span class="s0">enumerable: </span><span class="s5">true</span><span class="s0">,</span>
        <span class="s0">writable: </span><span class="s5">true</span><span class="s0">,</span>
        <span class="s0">value: </span><span class="s3">valueNode</span>
      <span class="s0">});</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">_result</span><span class="s0">[</span><span class="s3">keyNode</span><span class="s0">] </span><span class="s2">= </span><span class="s3">valueNode</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s2">delete </span><span class="s3">overridableKeys</span><span class="s0">[</span><span class="s3">keyNode</span><span class="s0">];</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">_result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readLineBreak(</span><span class="s3">state</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x0A</span><span class="s1">/* LF */</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x0D</span><span class="s1">/* CR */</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">) </span><span class="s2">=== </span><span class="s7">0x0A</span><span class="s1">/* LF */</span><span class="s0">) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'a line break is expected'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">skipSeparationSpace(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">allowComments</span><span class="s0">, </span><span class="s3">checkIndent</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">lineBreaks </span><span class="s2">= </span><span class="s7">0</span><span class="s0">,</span>
      <span class="s0">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s2">while </span><span class="s0">(</span><span class="s6">is_WHITE_SPACE</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x09</span><span class="s1">/* Tab */ </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">=== -</span><span class="s7">1</span><span class="s0">) {</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
      <span class="s0">}</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">allowComments </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x23</span><span class="s1">/* # */</span><span class="s0">) {</span>
      <span class="s2">do </span><span class="s0">{</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s0">} </span><span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x0A</span><span class="s1">/* LF */ </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x0D</span><span class="s1">/* CR */ </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s6">readLineBreak</span><span class="s0">(</span><span class="s3">state</span><span class="s0">);</span>

      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s3">lineBreaks</span><span class="s2">++</span><span class="s0">;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>

      <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x20</span><span class="s1">/* Space */</span><span class="s0">) {</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent</span><span class="s2">++</span><span class="s0">;</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">checkIndent </span><span class="s2">!== -</span><span class="s7">1 </span><span class="s2">&amp;&amp; </span><span class="s3">lineBreaks </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt; </span><span class="s3">checkIndent</span><span class="s0">) {</span>
    <span class="s6">throwWarning</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'deficient indentation'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">lineBreaks</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">testDocumentSeparator(</span><span class="s3">state</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">);</span>

  <span class="s1">// Condition state.position === state.lineStart is tested</span>
  <span class="s1">// in parent on each call, for efficiency. No needs to test here again.</span>
  <span class="s2">if </span><span class="s0">((</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2D</span><span class="s1">/* - */ </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2E</span><span class="s1">/* . */</span><span class="s0">) </span><span class="s2">&amp;&amp;</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">_position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">) </span><span class="s2">&amp;&amp;</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">_position </span><span class="s2">+ </span><span class="s7">2</span><span class="s0">)) {</span>

    <span class="s3">_position </span><span class="s2">+= </span><span class="s7">3</span><span class="s0">;</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0 </span><span class="s2">|| </span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">writeFoldedLines(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">count</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">count </span><span class="s2">=== </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s4">' '</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">count </span><span class="s2">&gt; </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">, </span><span class="s3">count </span><span class="s2">- </span><span class="s7">1</span><span class="s0">);</span>
  <span class="s0">}</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">readPlainScalar(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">, </span><span class="s3">withinFlowCollection</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">preceding,</span>
      <span class="s0">following,</span>
      <span class="s0">captureStart,</span>
      <span class="s0">captureEnd,</span>
      <span class="s0">hasPendingContent,</span>
      <span class="s0">_line,</span>
      <span class="s0">_lineStart,</span>
      <span class="s0">_lineIndent,</span>
      <span class="s0">_kind </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind</span><span class="s0">,</span>
      <span class="s0">_result </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)      </span><span class="s2">||</span>
      <span class="s6">is_FLOW_INDICATOR</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">) </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x23</span><span class="s1">/* # */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x26</span><span class="s1">/* &amp; */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2A</span><span class="s1">/* * */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x21</span><span class="s1">/* ! */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x7C</span><span class="s1">/* | */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3E</span><span class="s1">/* &gt; */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x27</span><span class="s1">/* ' */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x22</span><span class="s1">/* &quot; */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x25</span><span class="s1">/* % */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x40</span><span class="s1">/* @ */    </span><span class="s2">||</span>
      <span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x60</span><span class="s1">/* ` */</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3F</span><span class="s1">/* ? */ </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2D</span><span class="s1">/* - */</span><span class="s0">) {</span>
    <span class="s3">following </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">following</span><span class="s0">) </span><span class="s2">||</span>
        <span class="s3">withinFlowCollection </span><span class="s2">&amp;&amp; </span><span class="s6">is_FLOW_INDICATOR</span><span class="s0">(</span><span class="s3">following</span><span class="s0">)) {</span>
      <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s4">'scalar'</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>
  <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
  <span class="s3">hasPendingContent </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3A</span><span class="s1">/* : */</span><span class="s0">) {</span>
      <span class="s3">following </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">following</span><span class="s0">) </span><span class="s2">||</span>
          <span class="s3">withinFlowCollection </span><span class="s2">&amp;&amp; </span><span class="s6">is_FLOW_INDICATOR</span><span class="s0">(</span><span class="s3">following</span><span class="s0">)) {</span>
        <span class="s2">break</span><span class="s0">;</span>
      <span class="s0">}</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x23</span><span class="s1">/* # */</span><span class="s0">) {</span>
      <span class="s3">preceding </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">- </span><span class="s7">1</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">preceding</span><span class="s0">)) {</span>
        <span class="s2">break</span><span class="s0">;</span>
      <span class="s0">}</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">((</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart </span><span class="s2">&amp;&amp; </span><span class="s6">testDocumentSeparator</span><span class="s0">(</span><span class="s3">state</span><span class="s0">)) </span><span class="s2">||</span>
               <span class="s3">withinFlowCollection </span><span class="s2">&amp;&amp; </span><span class="s6">is_FLOW_INDICATOR</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s2">break</span><span class="s0">;</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s3">_line </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">;</span>
      <span class="s3">_lineStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart</span><span class="s0">;</span>
      <span class="s3">_lineIndent </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent</span><span class="s0">;</span>
      <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt;= </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
        <span class="s3">hasPendingContent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
        <span class="s2">continue</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">= </span><span class="s3">captureEnd</span><span class="s0">;</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">= </span><span class="s3">_line</span><span class="s0">;</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart </span><span class="s2">= </span><span class="s3">_lineStart</span><span class="s0">;</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">= </span><span class="s3">_lineIndent</span><span class="s0">;</span>
        <span class="s2">break</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">hasPendingContent</span><span class="s0">) {</span>
      <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">captureEnd</span><span class="s0">, </span><span class="s5">false</span><span class="s0">);</span>
      <span class="s6">writeFoldedLines</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">- </span><span class="s3">_line</span><span class="s0">);</span>
      <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
      <span class="s3">hasPendingContent </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">is_WHITE_SPACE</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">captureEnd</span><span class="s0">, </span><span class="s5">false</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s3">_kind</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
  <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readSingleQuotedScalar(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">ch,</span>
      <span class="s0">captureStart, captureEnd;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x27</span><span class="s1">/* ' */</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s4">'scalar'</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
  <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">((</span><span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">)) </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x27</span><span class="s1">/* ' */</span><span class="s0">) {</span>
      <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x27</span><span class="s1">/* ' */</span><span class="s0">) {</span>
        <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
        <span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s0">}</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">captureEnd</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
      <span class="s6">writeFoldedLines</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">));</span>
      <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart </span><span class="s2">&amp;&amp; </span><span class="s6">testDocumentSeparator</span><span class="s0">(</span><span class="s3">state</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unexpected end of the document within a single quoted scalar'</span><span class="s0">);</span>

    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
      <span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unexpected end of the stream within a single quoted scalar'</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readDoubleQuotedScalar(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">captureStart,</span>
      <span class="s0">captureEnd,</span>
      <span class="s0">hexLength,</span>
      <span class="s0">hexResult,</span>
      <span class="s0">tmp,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x22</span><span class="s1">/* &quot; */</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s4">'scalar'</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
  <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">((</span><span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">)) </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x22</span><span class="s1">/* &quot; */</span><span class="s0">) {</span>
      <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
      <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x5C</span><span class="s1">/* \ */</span><span class="s0">) {</span>
      <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
        <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">);</span>

        <span class="s1">// TODO: rework to inline fn with no type cast?</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">&lt; </span><span class="s7">256 </span><span class="s2">&amp;&amp; </span><span class="s3">simpleEscapeCheck</span><span class="s0">[</span><span class="s3">ch</span><span class="s0">]) {</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">simpleEscapeMap</span><span class="s0">[</span><span class="s3">ch</span><span class="s0">];</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>

      <span class="s0">} </span><span class="s2">else if </span><span class="s0">((</span><span class="s3">tmp </span><span class="s2">= </span><span class="s6">escapedHexLen</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) </span><span class="s2">&gt; </span><span class="s7">0</span><span class="s0">) {</span>
        <span class="s3">hexLength </span><span class="s2">= </span><span class="s3">tmp</span><span class="s0">;</span>
        <span class="s3">hexResult </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>

        <span class="s2">for </span><span class="s0">(; </span><span class="s3">hexLength </span><span class="s2">&gt; </span><span class="s7">0</span><span class="s0">; </span><span class="s3">hexLength</span><span class="s2">--</span><span class="s0">) {</span>
          <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

          <span class="s2">if </span><span class="s0">((</span><span class="s3">tmp </span><span class="s2">= </span><span class="s6">fromHexCode</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) </span><span class="s2">&gt;= </span><span class="s7">0</span><span class="s0">) {</span>
            <span class="s3">hexResult </span><span class="s2">= </span><span class="s0">(</span><span class="s3">hexResult </span><span class="s2">&lt;&lt; </span><span class="s7">4</span><span class="s0">) </span><span class="s2">+ </span><span class="s3">tmp</span><span class="s0">;</span>

          <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
            <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'expected hexadecimal character'</span><span class="s0">);</span>
          <span class="s0">}</span>
        <span class="s0">}</span>

        <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s6">charFromCodepoint</span><span class="s0">(</span><span class="s3">hexResult</span><span class="s0">);</span>

        <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>

      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unknown escape sequence'</span><span class="s0">);</span>
      <span class="s0">}</span>

      <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">captureEnd</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
      <span class="s6">writeFoldedLines</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">));</span>
      <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart </span><span class="s2">&amp;&amp; </span><span class="s6">testDocumentSeparator</span><span class="s0">(</span><span class="s3">state</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unexpected end of the document within a double quoted scalar'</span><span class="s0">);</span>

    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
      <span class="s3">captureEnd </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unexpected end of the stream within a double quoted scalar'</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readFlowCollection(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">readNext </span><span class="s2">= </span><span class="s5">true</span><span class="s0">,</span>
      <span class="s0">_line,</span>
      <span class="s0">_lineStart,</span>
      <span class="s0">_pos,</span>
      <span class="s0">_tag     </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">,</span>
      <span class="s0">_result,</span>
      <span class="s0">_anchor  </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">,</span>
      <span class="s0">following,</span>
      <span class="s0">terminator,</span>
      <span class="s0">isPair,</span>
      <span class="s0">isExplicitPair,</span>
      <span class="s0">isMapping,</span>
      <span class="s0">overridableKeys </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">create</span><span class="s0">(</span><span class="s5">null</span><span class="s0">),</span>
      <span class="s0">keyNode,</span>
      <span class="s0">keyTag,</span>
      <span class="s0">valueNode,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x5B</span><span class="s1">/* [ */</span><span class="s0">) {</span>
    <span class="s3">terminator </span><span class="s2">= </span><span class="s7">0x5D</span><span class="s0">;</span><span class="s1">/* ] */</span>
    <span class="s3">isMapping </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
    <span class="s3">_result </span><span class="s2">= </span><span class="s0">[];</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x7B</span><span class="s1">/* { */</span><span class="s0">) {</span>
    <span class="s3">terminator </span><span class="s2">= </span><span class="s7">0x7D</span><span class="s0">;</span><span class="s1">/* } */</span>
    <span class="s3">isMapping </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">_result </span><span class="s2">= </span><span class="s0">{};</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">] </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">);</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s3">terminator</span><span class="s0">) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">= </span><span class="s3">_anchor</span><span class="s0">;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s3">isMapping </span><span class="s2">? </span><span class="s4">'mapping' </span><span class="s2">: </span><span class="s4">'sequence'</span><span class="s0">;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
      <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">readNext</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'missed comma between flow collection entries'</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2C</span><span class="s1">/* , */</span><span class="s0">) {</span>
      <span class="s1">// &quot;flow collection entries can never be completely empty&quot;, as per YAML 1.2, section 7.4</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">&quot;expected the node content, but found ','&quot;</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">keyTag </span><span class="s2">= </span><span class="s3">keyNode </span><span class="s2">= </span><span class="s3">valueNode </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
    <span class="s3">isPair </span><span class="s2">= </span><span class="s3">isExplicitPair </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3F</span><span class="s1">/* ? */</span><span class="s0">) {</span>
      <span class="s3">following </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">following</span><span class="s0">)) {</span>
        <span class="s3">isPair </span><span class="s2">= </span><span class="s3">isExplicitPair </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>
        <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">);</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s3">_line </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">; </span><span class="s1">// Save the current line.</span>
    <span class="s3">_lineStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart</span><span class="s0">;</span>
    <span class="s3">_pos </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
    <span class="s6">composeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">, </span><span class="s3">CONTEXT_FLOW_IN</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
    <span class="s3">keyTag </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">;</span>
    <span class="s3">keyNode </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
    <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">);</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">((</span><span class="s3">isExplicitPair </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">=== </span><span class="s3">_line</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3A</span><span class="s1">/* : */</span><span class="s0">) {</span>
      <span class="s3">isPair </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">);</span>
      <span class="s6">composeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">, </span><span class="s3">CONTEXT_FLOW_IN</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
      <span class="s3">valueNode </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">isMapping</span><span class="s0">) {</span>
      <span class="s6">storeMappingPair</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyTag</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, </span><span class="s3">valueNode</span><span class="s0">, </span><span class="s3">_line</span><span class="s0">, </span><span class="s3">_lineStart</span><span class="s0">, </span><span class="s3">_pos</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">isPair</span><span class="s0">) {</span>
      <span class="s3">_result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s6">storeMappingPair</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">null</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyTag</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, </span><span class="s3">valueNode</span><span class="s0">, </span><span class="s3">_line</span><span class="s0">, </span><span class="s3">_lineStart</span><span class="s0">, </span><span class="s3">_pos</span><span class="s0">));</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">_result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">keyNode</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">);</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2C</span><span class="s1">/* , */</span><span class="s0">) {</span>
      <span class="s3">readNext </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">readNext </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unexpected end of the stream within a flow collection'</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readBlockScalar(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">captureStart,</span>
      <span class="s0">folding,</span>
      <span class="s0">chomping       </span><span class="s2">= </span><span class="s3">CHOMPING_CLIP</span><span class="s0">,</span>
      <span class="s0">didReadContent </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">detectedIndent </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">textIndent     </span><span class="s2">= </span><span class="s3">nodeIndent</span><span class="s0">,</span>
      <span class="s0">emptyLines     </span><span class="s2">= </span><span class="s7">0</span><span class="s0">,</span>
      <span class="s0">atMoreIndented </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">tmp,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x7C</span><span class="s1">/* | */</span><span class="s0">) {</span>
    <span class="s3">folding </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3E</span><span class="s1">/* &gt; */</span><span class="s0">) {</span>
    <span class="s3">folding </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s4">'scalar'</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2B</span><span class="s1">/* + */ </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2D</span><span class="s1">/* - */</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">CHOMPING_CLIP </span><span class="s2">=== </span><span class="s3">chomping</span><span class="s0">) {</span>
        <span class="s3">chomping </span><span class="s2">= </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x2B</span><span class="s1">/* + */</span><span class="s0">) </span><span class="s2">? </span><span class="s3">CHOMPING_KEEP </span><span class="s2">: </span><span class="s3">CHOMPING_STRIP</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'repeat of a chomping mode identifier'</span><span class="s0">);</span>
      <span class="s0">}</span>

    <span class="s0">} </span><span class="s2">else if </span><span class="s0">((</span><span class="s3">tmp </span><span class="s2">= </span><span class="s6">fromDecimalCode</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) </span><span class="s2">&gt;= </span><span class="s7">0</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">tmp </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) {</span>
        <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'bad explicit indentation width of a block scalar; it cannot be less than one'</span><span class="s0">);</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">detectedIndent</span><span class="s0">) {</span>
        <span class="s3">textIndent </span><span class="s2">= </span><span class="s3">nodeIndent </span><span class="s2">+ </span><span class="s3">tmp </span><span class="s2">- </span><span class="s7">1</span><span class="s0">;</span>
        <span class="s3">detectedIndent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'repeat of an indentation width identifier'</span><span class="s0">);</span>
      <span class="s0">}</span>

    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s6">is_WHITE_SPACE</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
    <span class="s2">do </span><span class="s0">{ </span><span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">); }</span>
    <span class="s2">while </span><span class="s0">(</span><span class="s6">is_WHITE_SPACE</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">));</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x23</span><span class="s1">/* # */</span><span class="s0">) {</span>
      <span class="s2">do </span><span class="s0">{ </span><span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">); }</span>
      <span class="s2">while </span><span class="s0">(</span><span class="s2">!</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">));</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s6">readLineBreak</span><span class="s0">(</span><span class="s3">state</span><span class="s0">);</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">while </span><span class="s0">((</span><span class="s2">!</span><span class="s3">detectedIndent </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt; </span><span class="s3">textIndent</span><span class="s0">) </span><span class="s2">&amp;&amp;</span>
           <span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x20</span><span class="s1">/* Space */</span><span class="s0">)) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent</span><span class="s2">++</span><span class="s0">;</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">detectedIndent </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt; </span><span class="s3">textIndent</span><span class="s0">) {</span>
      <span class="s3">textIndent </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s3">emptyLines</span><span class="s2">++</span><span class="s0">;</span>
      <span class="s2">continue</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s1">// End of the scalar.</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt; </span><span class="s3">textIndent</span><span class="s0">) {</span>

      <span class="s1">// Perform the chomping.</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">chomping </span><span class="s2">=== </span><span class="s3">CHOMPING_KEEP</span><span class="s0">) {</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">, </span><span class="s3">didReadContent </span><span class="s2">? </span><span class="s7">1 </span><span class="s2">+ </span><span class="s3">emptyLines </span><span class="s2">: </span><span class="s3">emptyLines</span><span class="s0">);</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">chomping </span><span class="s2">=== </span><span class="s3">CHOMPING_CLIP</span><span class="s0">) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">didReadContent</span><span class="s0">) { </span><span class="s1">// i.e. only if the scalar is not empty.</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">}</span>

      <span class="s1">// Break this `while` cycle and go to the funciton's epilogue.</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s1">// Folded style: use fancy rules to handle line breaks.</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">folding</span><span class="s0">) {</span>

      <span class="s1">// Lines starting with white space characters (more-indented lines) are not folded.</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s6">is_WHITE_SPACE</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
        <span class="s3">atMoreIndented </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s1">// except for the first content line (cf. Example 8.1)</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">, </span><span class="s3">didReadContent </span><span class="s2">? </span><span class="s7">1 </span><span class="s2">+ </span><span class="s3">emptyLines </span><span class="s2">: </span><span class="s3">emptyLines</span><span class="s0">);</span>

      <span class="s1">// End of more-indented block.</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">atMoreIndented</span><span class="s0">) {</span>
        <span class="s3">atMoreIndented </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">, </span><span class="s3">emptyLines </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>

      <span class="s1">// Just one line break - perceive as the same line.</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">emptyLines </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">didReadContent</span><span class="s0">) { </span><span class="s1">// i.e. only if we have already read some scalar content.</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s4">' '</span><span class="s0">;</span>
        <span class="s0">}</span>

      <span class="s1">// Several line breaks - perceive as different lines.</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">, </span><span class="s3">emptyLines</span><span class="s0">);</span>
      <span class="s0">}</span>

    <span class="s1">// Literal style: just add exact number of line breaks between content lines.</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s1">// Keep all line breaks except the header line break.</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">+= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">, </span><span class="s3">didReadContent </span><span class="s2">? </span><span class="s7">1 </span><span class="s2">+ </span><span class="s3">emptyLines </span><span class="s2">: </span><span class="s3">emptyLines</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">didReadContent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">detectedIndent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">emptyLines </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
    <span class="s3">captureStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

    <span class="s2">while </span><span class="s0">(</span><span class="s2">!</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">)) {</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s6">captureSegment</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">captureStart</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">, </span><span class="s5">false</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readBlockSequence(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_line,</span>
      <span class="s0">_tag      </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">,</span>
      <span class="s0">_anchor   </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">,</span>
      <span class="s0">_result   </span><span class="s2">= </span><span class="s0">[],</span>
      <span class="s0">following,</span>
      <span class="s0">detected  </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">ch;</span>

  <span class="s1">// there is a leading tab before this token, so it can't be a block sequence/mapping;</span>
  <span class="s1">// it can still be flow sequence/mapping or a scalar</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">] </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine</span><span class="s0">;</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'tab characters must not be used in indentation'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x2D</span><span class="s1">/* - */</span><span class="s0">) {</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s3">following </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">following</span><span class="s0">)) {</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s3">detected </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s2">++</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">)) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt;= </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
        <span class="s3">_result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s5">null</span><span class="s0">);</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
        <span class="s2">continue</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s3">_line </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">;</span>
    <span class="s6">composeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">, </span><span class="s3">CONTEXT_BLOCK_IN</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
    <span class="s3">_result</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">);</span>
    <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">((</span><span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">=== </span><span class="s3">_line </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt; </span><span class="s3">nodeIndent</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'bad indentation of a sequence entry'</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt; </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">detected</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">= </span><span class="s3">_anchor</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s4">'sequence'</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
    <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
  <span class="s0">}</span>
  <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readBlockMapping(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">following,</span>
      <span class="s0">allowCompact,</span>
      <span class="s0">_line,</span>
      <span class="s0">_keyLine,</span>
      <span class="s0">_keyLineStart,</span>
      <span class="s0">_keyPos,</span>
      <span class="s0">_tag          </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">,</span>
      <span class="s0">_anchor       </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">,</span>
      <span class="s0">_result       </span><span class="s2">= </span><span class="s0">{},</span>
      <span class="s0">overridableKeys </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">create</span><span class="s0">(</span><span class="s5">null</span><span class="s0">),</span>
      <span class="s0">keyTag        </span><span class="s2">= </span><span class="s5">null</span><span class="s0">,</span>
      <span class="s0">keyNode       </span><span class="s2">= </span><span class="s5">null</span><span class="s0">,</span>
      <span class="s0">valueNode     </span><span class="s2">= </span><span class="s5">null</span><span class="s0">,</span>
      <span class="s0">atExplicitKey </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">detected      </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">ch;</span>

  <span class="s1">// there is a leading tab before this token, so it can't be a block sequence/mapping;</span>
  <span class="s1">// it can still be flow sequence/mapping or a scalar</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">] </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">atExplicitKey </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">firstTabInLine</span><span class="s0">;</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'tab characters must not be used in indentation'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">following </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>
    <span class="s3">_line </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">; </span><span class="s1">// Save the current line.</span>

    <span class="s1">//</span>
    <span class="s1">// Explicit notation case. There are two separate blocks:</span>
    <span class="s1">// first for the key (denoted by &quot;?&quot;) and second for the value (denoted by &quot;:&quot;)</span>
    <span class="s1">//</span>
    <span class="s2">if </span><span class="s0">((</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3F</span><span class="s1">/* ? */ </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3A</span><span class="s1">/* : */</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">following</span><span class="s0">)) {</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3F</span><span class="s1">/* ? */</span><span class="s0">) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">atExplicitKey</span><span class="s0">) {</span>
          <span class="s6">storeMappingPair</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyTag</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, </span><span class="s5">null</span><span class="s0">, </span><span class="s3">_keyLine</span><span class="s0">, </span><span class="s3">_keyLineStart</span><span class="s0">, </span><span class="s3">_keyPos</span><span class="s0">);</span>
          <span class="s3">keyTag </span><span class="s2">= </span><span class="s3">keyNode </span><span class="s2">= </span><span class="s3">valueNode </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
        <span class="s0">}</span>

        <span class="s3">detected </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s3">atExplicitKey </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s3">allowCompact </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>

      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">atExplicitKey</span><span class="s0">) {</span>
        <span class="s1">// i.e. 0x3A/* : */ === character after the explicit key.</span>
        <span class="s3">atExplicitKey </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
        <span class="s3">allowCompact </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>

      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'incomplete explicit mapping pair; a key node is missed; or followed by a non-tabulated empty line'</span><span class="s0">);</span>
      <span class="s0">}</span>

      <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">;</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">following</span><span class="s0">;</span>

    <span class="s1">//</span>
    <span class="s1">// Implicit notation case. Flow-style node as the key first, then &quot;:&quot;, and the value.</span>
    <span class="s1">//</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">_keyLine </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">;</span>
      <span class="s3">_keyLineStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart</span><span class="s0">;</span>
      <span class="s3">_keyPos </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">composeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">, </span><span class="s3">CONTEXT_FLOW_OUT</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">true</span><span class="s0">)) {</span>
        <span class="s1">// Neither implicit nor explicit notation.</span>
        <span class="s1">// Reading is done. Go to the epilogue.</span>
        <span class="s2">break</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">=== </span><span class="s3">_line</span><span class="s0">) {</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

        <span class="s2">while </span><span class="s0">(</span><span class="s6">is_WHITE_SPACE</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
          <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
        <span class="s0">}</span>

        <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3A</span><span class="s1">/* : */</span><span class="s0">) {</span>
          <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

          <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
            <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'a whitespace character is expected after the key-value separator within a block mapping'</span><span class="s0">);</span>
          <span class="s0">}</span>

          <span class="s2">if </span><span class="s0">(</span><span class="s3">atExplicitKey</span><span class="s0">) {</span>
            <span class="s6">storeMappingPair</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyTag</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, </span><span class="s5">null</span><span class="s0">, </span><span class="s3">_keyLine</span><span class="s0">, </span><span class="s3">_keyLineStart</span><span class="s0">, </span><span class="s3">_keyPos</span><span class="s0">);</span>
            <span class="s3">keyTag </span><span class="s2">= </span><span class="s3">keyNode </span><span class="s2">= </span><span class="s3">valueNode </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
          <span class="s0">}</span>

          <span class="s3">detected </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
          <span class="s3">atExplicitKey </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
          <span class="s3">allowCompact </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
          <span class="s3">keyTag </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">;</span>
          <span class="s3">keyNode </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>

        <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">detected</span><span class="s0">) {</span>
          <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'can not read an implicit mapping pair; a colon is missed'</span><span class="s0">);</span>

        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">= </span><span class="s3">_anchor</span><span class="s0">;</span>
          <span class="s2">return </span><span class="s5">true</span><span class="s0">; </span><span class="s1">// Keep the result of `composeNode`.</span>
        <span class="s0">}</span>

      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">detected</span><span class="s0">) {</span>
        <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'can not read a block mapping entry; a multiline key may not be an implicit key'</span><span class="s0">);</span>

      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">= </span><span class="s3">_anchor</span><span class="s0">;</span>
        <span class="s2">return </span><span class="s5">true</span><span class="s0">; </span><span class="s1">// Keep the result of `composeNode`.</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s1">//</span>
    <span class="s1">// Common reading code for both explicit and implicit notations.</span>
    <span class="s1">//</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">=== </span><span class="s3">_line </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt; </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">atExplicitKey</span><span class="s0">) {</span>
        <span class="s3">_keyLine </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">line</span><span class="s0">;</span>
        <span class="s3">_keyLineStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart</span><span class="s0">;</span>
        <span class="s3">_keyPos </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s6">composeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">nodeIndent</span><span class="s0">, </span><span class="s3">CONTEXT_BLOCK_OUT</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s3">allowCompact</span><span class="s0">)) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">atExplicitKey</span><span class="s0">) {</span>
          <span class="s3">keyNode </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
          <span class="s3">valueNode </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">atExplicitKey</span><span class="s0">) {</span>
        <span class="s6">storeMappingPair</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyTag</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, </span><span class="s3">valueNode</span><span class="s0">, </span><span class="s3">_keyLine</span><span class="s0">, </span><span class="s3">_keyLineStart</span><span class="s0">, </span><span class="s3">_keyPos</span><span class="s0">);</span>
        <span class="s3">keyTag </span><span class="s2">= </span><span class="s3">keyNode </span><span class="s2">= </span><span class="s3">valueNode </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">((</span><span class="s3">state</span><span class="s0">.</span><span class="s3">line </span><span class="s2">=== </span><span class="s3">_line </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt; </span><span class="s3">nodeIndent</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'bad indentation of a mapping entry'</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt; </span><span class="s3">nodeIndent</span><span class="s0">) {</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s1">//</span>
  <span class="s1">// Epilogue.</span>
  <span class="s1">//</span>

  <span class="s1">// Special case: last mapping's node contains only the key in explicit notation.</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">atExplicitKey</span><span class="s0">) {</span>
    <span class="s6">storeMappingPair</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">_result</span><span class="s0">, </span><span class="s3">overridableKeys</span><span class="s0">, </span><span class="s3">keyTag</span><span class="s0">, </span><span class="s3">keyNode</span><span class="s0">, </span><span class="s5">null</span><span class="s0">, </span><span class="s3">_keyLine</span><span class="s0">, </span><span class="s3">_keyLineStart</span><span class="s0">, </span><span class="s3">_keyPos</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s1">// Expose the resulting mapping.</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">detected</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">= </span><span class="s3">_anchor</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">= </span><span class="s4">'mapping'</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">detected</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readTagProperty(</span><span class="s3">state</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_position,</span>
      <span class="s0">isVerbatim </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">isNamed    </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">tagHandle,</span>
      <span class="s0">tagName,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x21</span><span class="s1">/* ! */</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'duplication of a tag property'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x3C</span><span class="s1">/* &lt; */</span><span class="s0">) {</span>
    <span class="s3">isVerbatim </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x21</span><span class="s1">/* ! */</span><span class="s0">) {</span>
    <span class="s3">isNamed </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">tagHandle </span><span class="s2">= </span><span class="s4">'!!'</span><span class="s0">;</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s3">tagHandle </span><span class="s2">= </span><span class="s4">'!'</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">_position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">isVerbatim</span><span class="s0">) {</span>
    <span class="s2">do </span><span class="s0">{ </span><span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">); }</span>
    <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; </span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x3E</span><span class="s1">/* &gt; */</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">&lt; </span><span class="s3">state</span><span class="s0">.length) {</span>
      <span class="s3">tagName </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unexpected end of the stream within a verbatim tag'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x21</span><span class="s1">/* ! */</span><span class="s0">) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">isNamed</span><span class="s0">) {</span>
          <span class="s3">tagHandle </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">_position </span><span class="s2">- </span><span class="s7">1</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>

          <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">PATTERN_TAG_HANDLE</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">tagHandle</span><span class="s0">)) {</span>
            <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'named tag handle cannot contain such characters'</span><span class="s0">);</span>
          <span class="s0">}</span>

          <span class="s3">isNamed </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
          <span class="s3">_position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">;</span>
        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
          <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'tag suffix cannot contain exclamation marks'</span><span class="s0">);</span>
        <span class="s0">}</span>
      <span class="s0">}</span>

      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">tagName </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">PATTERN_FLOW_INDICATORS</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">tagName</span><span class="s0">)) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'tag suffix cannot contain flow indicator characters'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">tagName </span><span class="s2">&amp;&amp; !</span><span class="s3">PATTERN_TAG_URI</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">tagName</span><span class="s0">)) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'tag name cannot contain such characters: ' </span><span class="s2">+ </span><span class="s3">tagName</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">try </span><span class="s0">{</span>
    <span class="s3">tagName </span><span class="s2">= </span><span class="s6">decodeURIComponent</span><span class="s0">(</span><span class="s3">tagName</span><span class="s0">);</span>
  <span class="s0">} </span><span class="s2">catch </span><span class="s0">(</span><span class="s3">err</span><span class="s0">) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'tag name is malformed: ' </span><span class="s2">+ </span><span class="s3">tagName</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">isVerbatim</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">tagName</span><span class="s0">;</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tagMap</span><span class="s0">, </span><span class="s3">tagHandle</span><span class="s0">)) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tagMap</span><span class="s0">[</span><span class="s3">tagHandle</span><span class="s0">] </span><span class="s2">+ </span><span class="s3">tagName</span><span class="s0">;</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">tagHandle </span><span class="s2">=== </span><span class="s4">'!'</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s4">'!' </span><span class="s2">+ </span><span class="s3">tagName</span><span class="s0">;</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">tagHandle </span><span class="s2">=== </span><span class="s4">'!!'</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s4">'tag:yaml.org,2002:' </span><span class="s2">+ </span><span class="s3">tagName</span><span class="s0">;</span>

  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'undeclared tag handle &quot;' </span><span class="s2">+ </span><span class="s3">tagHandle </span><span class="s2">+ </span><span class="s4">'&quot;'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readAnchorProperty(</span><span class="s3">state</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_position,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x26</span><span class="s1">/* &amp; */</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'duplication of an anchor property'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
  <span class="s3">_position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">) </span><span class="s2">&amp;&amp; !</span><span class="s6">is_FLOW_INDICATOR</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">=== </span><span class="s3">_position</span><span class="s0">) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'name of an anchor node must contain at least one character'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readAlias(</span><span class="s3">state</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_position, alias,</span>
      <span class="s0">ch;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x2A</span><span class="s1">/* * */</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>

  <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
  <span class="s3">_position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">) </span><span class="s2">&amp;&amp; !</span><span class="s6">is_FLOW_INDICATOR</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">=== </span><span class="s3">_position</span><span class="s0">) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'name of an alias node must contain at least one character'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">alias </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">, </span><span class="s3">alias</span><span class="s0">)) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unidentified alias &quot;' </span><span class="s2">+ </span><span class="s3">alias </span><span class="s2">+ </span><span class="s4">'&quot;'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">alias</span><span class="s0">];</span>
  <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>
  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">composeNode(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">parentIndent</span><span class="s0">, </span><span class="s3">nodeContext</span><span class="s0">, </span><span class="s3">allowToSeek</span><span class="s0">, </span><span class="s3">allowCompact</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">allowBlockStyles,</span>
      <span class="s0">allowBlockScalars,</span>
      <span class="s0">allowBlockCollections,</span>
      <span class="s0">indentStatus </span><span class="s2">= </span><span class="s7">1</span><span class="s0">, </span><span class="s1">// 1: this&gt;parent, 0: this=parent, -1: this&lt;parent 
      </span><span class="s0">atNewLine  </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">hasContent </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">typeIndex,</span>
      <span class="s0">typeQuantity,</span>
      <span class="s0">typeList,</span>
      <span class="s0">type,</span>
      <span class="s0">flowIndent,</span>
      <span class="s0">blockIndent;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">listener </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s6">listener</span><span class="s0">(</span><span class="s4">'open'</span><span class="s0">, </span><span class="s3">state</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">tag    </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">kind   </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>

  <span class="s3">allowBlockStyles </span><span class="s2">= </span><span class="s3">allowBlockScalars </span><span class="s2">= </span><span class="s3">allowBlockCollections </span><span class="s2">=</span>
    <span class="s3">CONTEXT_BLOCK_OUT </span><span class="s2">=== </span><span class="s3">nodeContext </span><span class="s2">||</span>
    <span class="s3">CONTEXT_BLOCK_IN  </span><span class="s2">=== </span><span class="s3">nodeContext</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">allowToSeek</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">)) {</span>
      <span class="s3">atNewLine </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt; </span><span class="s3">parentIndent</span><span class="s0">) {</span>
        <span class="s3">indentStatus </span><span class="s2">= </span><span class="s7">1</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">=== </span><span class="s3">parentIndent</span><span class="s0">) {</span>
        <span class="s3">indentStatus </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt; </span><span class="s3">parentIndent</span><span class="s0">) {</span>
        <span class="s3">indentStatus </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">indentStatus </span><span class="s2">=== </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s2">while </span><span class="s0">(</span><span class="s6">readTagProperty</span><span class="s0">(</span><span class="s3">state</span><span class="s0">) </span><span class="s2">|| </span><span class="s6">readAnchorProperty</span><span class="s0">(</span><span class="s3">state</span><span class="s0">)) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">)) {</span>
        <span class="s3">atNewLine </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s3">allowBlockCollections </span><span class="s2">= </span><span class="s3">allowBlockStyles</span><span class="s0">;</span>

        <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt; </span><span class="s3">parentIndent</span><span class="s0">) {</span>
          <span class="s3">indentStatus </span><span class="s2">= </span><span class="s7">1</span><span class="s0">;</span>
        <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">=== </span><span class="s3">parentIndent</span><span class="s0">) {</span>
          <span class="s3">indentStatus </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
        <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&lt; </span><span class="s3">parentIndent</span><span class="s0">) {</span>
          <span class="s3">indentStatus </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">allowBlockCollections </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">allowBlockCollections</span><span class="s0">) {</span>
    <span class="s3">allowBlockCollections </span><span class="s2">= </span><span class="s3">atNewLine </span><span class="s2">|| </span><span class="s3">allowCompact</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">indentStatus </span><span class="s2">=== </span><span class="s7">1 </span><span class="s2">|| </span><span class="s3">CONTEXT_BLOCK_OUT </span><span class="s2">=== </span><span class="s3">nodeContext</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">CONTEXT_FLOW_IN </span><span class="s2">=== </span><span class="s3">nodeContext </span><span class="s2">|| </span><span class="s3">CONTEXT_FLOW_OUT </span><span class="s2">=== </span><span class="s3">nodeContext</span><span class="s0">) {</span>
      <span class="s3">flowIndent </span><span class="s2">= </span><span class="s3">parentIndent</span><span class="s0">;</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">flowIndent </span><span class="s2">= </span><span class="s3">parentIndent </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s3">blockIndent </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">- </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">indentStatus </span><span class="s2">=== </span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">allowBlockCollections </span><span class="s2">&amp;&amp;</span>
          <span class="s0">(</span><span class="s6">readBlockSequence</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">blockIndent</span><span class="s0">) </span><span class="s2">||</span>
           <span class="s6">readBlockMapping</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">blockIndent</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">)) </span><span class="s2">||</span>
          <span class="s6">readFlowCollection</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">)) {</span>
        <span class="s3">hasContent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s2">if </span><span class="s0">((</span><span class="s3">allowBlockScalars </span><span class="s2">&amp;&amp; </span><span class="s6">readBlockScalar</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">)) </span><span class="s2">||</span>
            <span class="s6">readSingleQuotedScalar</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">) </span><span class="s2">||</span>
            <span class="s6">readDoubleQuotedScalar</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">)) {</span>
          <span class="s3">hasContent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>

        <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s6">readAlias</span><span class="s0">(</span><span class="s3">state</span><span class="s0">)) {</span>
          <span class="s3">hasContent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>

          <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
            <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'alias node should not have any properties'</span><span class="s0">);</span>
          <span class="s0">}</span>

        <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s6">readPlainScalar</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">flowIndent</span><span class="s0">, </span><span class="s3">CONTEXT_FLOW_IN </span><span class="s2">=== </span><span class="s3">nodeContext</span><span class="s0">)) {</span>
          <span class="s3">hasContent </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>

          <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) {</span>
            <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s4">'?'</span><span class="s0">;</span>
          <span class="s0">}</span>
        <span class="s0">}</span>

        <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">] </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">indentStatus </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) {</span>
      <span class="s1">// Special case: block sequences are allowed to have same indentation level as the parent.</span>
      <span class="s1">// http://www.yaml.org/spec/1.2/spec.html#id2799784</span>
      <span class="s3">hasContent </span><span class="s2">= </span><span class="s3">allowBlockCollections </span><span class="s2">&amp;&amp; </span><span class="s6">readBlockSequence</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">blockIndent</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">] </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
    <span class="s0">}</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">=== </span><span class="s4">'?'</span><span class="s0">) {</span>
    <span class="s1">// Implicit resolving is not allowed for non-scalar types, and '?'</span>
    <span class="s1">// non-specific tag is only automatically assigned to plain scalars.</span>
    <span class="s1">//</span>
    <span class="s1">// We only need to check kind conformity in case user explicitly assigns '?'</span>
    <span class="s1">// tag, for example like this: &quot;!&lt;?&gt; [0]&quot;</span>
    <span class="s1">//</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">!== </span><span class="s4">'scalar'</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unacceptable node kind for !&lt;?&gt; tag; it should be &quot;scalar&quot;, not &quot;' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">+ </span><span class="s4">'&quot;'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">for </span><span class="s0">(</span><span class="s3">typeIndex </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">typeQuantity </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">implicitTypes</span><span class="s0">.length; </span><span class="s3">typeIndex </span><span class="s2">&lt; </span><span class="s3">typeQuantity</span><span class="s0">; </span><span class="s3">typeIndex </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s3">type </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">implicitTypes</span><span class="s0">[</span><span class="s3">typeIndex</span><span class="s0">];</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s6">resolve</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">)) { </span><span class="s1">// `state.result` updated in resolver if matched</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s6">construct</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">);</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">;</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">] </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
        <span class="s0">}</span>
        <span class="s2">break</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s4">'!'</span><span class="s0">) {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">typeMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">|| </span><span class="s4">'fallback'</span><span class="s0">], </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">)) {</span>
      <span class="s3">type </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">typeMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">|| </span><span class="s4">'fallback'</span><span class="s0">][</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">];</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s1">// looking for multi type</span>
      <span class="s3">type </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
      <span class="s3">typeList </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">typeMap</span><span class="s0">.</span><span class="s3">multi</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">|| </span><span class="s4">'fallback'</span><span class="s0">];</span>

      <span class="s2">for </span><span class="s0">(</span><span class="s3">typeIndex </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">typeQuantity </span><span class="s2">= </span><span class="s3">typeList</span><span class="s0">.length; </span><span class="s3">typeIndex </span><span class="s2">&lt; </span><span class="s3">typeQuantity</span><span class="s0">; </span><span class="s3">typeIndex </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">0</span><span class="s0">, </span><span class="s3">typeList</span><span class="s0">[</span><span class="s3">typeIndex</span><span class="s0">].</span><span class="s3">tag</span><span class="s0">.length) </span><span class="s2">=== </span><span class="s3">typeList</span><span class="s0">[</span><span class="s3">typeIndex</span><span class="s0">].</span><span class="s3">tag</span><span class="s0">) {</span>
          <span class="s3">type </span><span class="s2">= </span><span class="s3">typeList</span><span class="s0">[</span><span class="s3">typeIndex</span><span class="s0">];</span>
          <span class="s2">break</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">type</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unknown tag !&lt;' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">+ </span><span class="s4">'&gt;'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">&amp;&amp; </span><span class="s3">type</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">!== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unacceptable node kind for !&lt;' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">+ </span><span class="s4">'&gt; tag; it should be &quot;' </span><span class="s2">+ </span><span class="s3">type</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">+ </span><span class="s4">'&quot;, not &quot;' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">kind </span><span class="s2">+ </span><span class="s4">'&quot;'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">type</span><span class="s0">.</span><span class="s6">resolve</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">)) { </span><span class="s1">// `state.result` updated in resolver if matched</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'cannot resolve a node with !&lt;' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">+ </span><span class="s4">'&gt; explicit tag'</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s6">construct</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">);</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap</span><span class="s0">[</span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor</span><span class="s0">] </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">listener </span><span class="s2">!== </span><span class="s5">null</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s6">listener</span><span class="s0">(</span><span class="s4">'close'</span><span class="s0">, </span><span class="s3">state</span><span class="s0">);</span>
  <span class="s0">}</span>
  <span class="s2">return </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">||  </span><span class="s3">state</span><span class="s0">.</span><span class="s3">anchor </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">|| </span><span class="s3">hasContent</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">readDocument(</span><span class="s3">state</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">documentStart </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">,</span>
      <span class="s0">_position,</span>
      <span class="s0">directiveName,</span>
      <span class="s0">directiveArgs,</span>
      <span class="s0">hasDirectives </span><span class="s2">= </span><span class="s5">false</span><span class="s0">,</span>
      <span class="s0">ch;</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">version </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">checkLineBreaks </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">legacy</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">tagMap </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">create</span><span class="s0">(</span><span class="s5">null</span><span class="s0">);</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">anchorMap </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">create</span><span class="s0">(</span><span class="s5">null</span><span class="s0">);</span>

  <span class="s2">while </span><span class="s0">((</span><span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">)) </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>

    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">&gt; </span><span class="s7">0 </span><span class="s2">|| </span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0x25</span><span class="s1">/* % */</span><span class="s0">) {</span>
      <span class="s2">break</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s3">hasDirectives </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s3">_position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

    <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
      <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">directiveName </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
    <span class="s3">directiveArgs </span><span class="s2">= </span><span class="s0">[];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">directiveName</span><span class="s0">.length </span><span class="s2">&lt; </span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'directive name must not be less than one character in length'</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>
      <span class="s2">while </span><span class="s0">(</span><span class="s6">is_WHITE_SPACE</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">=== </span><span class="s7">0x23</span><span class="s1">/* # */</span><span class="s0">) {</span>
        <span class="s2">do </span><span class="s0">{ </span><span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">); }</span>
        <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">));</span>
        <span class="s2">break</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s6">is_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) </span><span class="s2">break</span><span class="s0">;</span>

      <span class="s3">_position </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">;</span>

      <span class="s2">while </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0 </span><span class="s2">&amp;&amp; !</span><span class="s6">is_WS_OR_EOL</span><span class="s0">(</span><span class="s3">ch</span><span class="s0">)) {</span>
        <span class="s3">ch </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s2">++</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s0">}</span>

      <span class="s3">directiveArgs</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">_position</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">));</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">ch </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) </span><span class="s6">readLineBreak</span><span class="s0">(</span><span class="s3">state</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">_hasOwnProperty$1</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">directiveHandlers</span><span class="s0">, </span><span class="s3">directiveName</span><span class="s0">)) {</span>
      <span class="s3">directiveHandlers</span><span class="s0">[</span><span class="s3">directiveName</span><span class="s0">](</span><span class="s3">state</span><span class="s0">, </span><span class="s3">directiveName</span><span class="s0">, </span><span class="s3">directiveArgs</span><span class="s0">);</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s6">throwWarning</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'unknown document directive &quot;' </span><span class="s2">+ </span><span class="s3">directiveName </span><span class="s2">+ </span><span class="s4">'&quot;'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">=== </span><span class="s7">0 </span><span class="s2">&amp;&amp;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">)     </span><span class="s2">=== </span><span class="s7">0x2D</span><span class="s1">/* - */ </span><span class="s2">&amp;&amp;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">) </span><span class="s2">=== </span><span class="s7">0x2D</span><span class="s1">/* - */ </span><span class="s2">&amp;&amp;</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+ </span><span class="s7">2</span><span class="s0">) </span><span class="s2">=== </span><span class="s7">0x2D</span><span class="s1">/* - */</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+= </span><span class="s7">3</span><span class="s0">;</span>
    <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>

  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">hasDirectives</span><span class="s0">) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'directives end mark is expected'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s6">composeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">- </span><span class="s7">1</span><span class="s0">, </span><span class="s3">CONTEXT_BLOCK_OUT</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
  <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">checkLineBreaks </span><span class="s2">&amp;&amp;</span>
      <span class="s3">PATTERN_NON_ASCII_LINE_BREAKS</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">documentStart</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">))) {</span>
    <span class="s6">throwWarning</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'non-ASCII line breaks are interpreted as content'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">documents</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">result</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineStart </span><span class="s2">&amp;&amp; </span><span class="s6">testDocumentSeparator</span><span class="s0">(</span><span class="s3">state</span><span class="s0">)) {</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">) </span><span class="s2">=== </span><span class="s7">0x2E</span><span class="s1">/* . */</span><span class="s0">) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+= </span><span class="s7">3</span><span class="s0">;</span>
      <span class="s6">skipSeparationSpace</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">);</span>
    <span class="s0">}</span>
    <span class="s2">return</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">&lt; </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">)) {</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'end of the stream or a document separator is expected'</span><span class="s0">);</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">return</span><span class="s0">;</span>
  <span class="s0">}</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">loadDocuments(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s3">input </span><span class="s2">= </span><span class="s6">String</span><span class="s0">(</span><span class="s3">input</span><span class="s0">);</span>
  <span class="s3">options </span><span class="s2">= </span><span class="s3">options </span><span class="s2">|| </span><span class="s0">{};</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">input</span><span class="s0">.length </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">) {</span>

    <span class="s1">// Add tailing `\n` if not exists</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">input</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">) </span><span class="s2">!== </span><span class="s7">0x0A</span><span class="s1">/* LF */ </span><span class="s2">&amp;&amp;</span>
        <span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">input</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">) </span><span class="s2">!== </span><span class="s7">0x0D</span><span class="s1">/* CR */</span><span class="s0">) {</span>
      <span class="s3">input </span><span class="s2">+= </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s1">// Strip BOM</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s7">0</span><span class="s0">) </span><span class="s2">=== </span><span class="s7">0xFEFF</span><span class="s0">) {</span>
      <span class="s3">input </span><span class="s2">= </span><span class="s3">input</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">var </span><span class="s0">state </span><span class="s2">= new </span><span class="s6">State$1</span><span class="s0">(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">options</span><span class="s0">);</span>

  <span class="s2">var </span><span class="s0">nullpos </span><span class="s2">= </span><span class="s3">input</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\0</span><span class="s4">'</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">nullpos </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">= </span><span class="s3">nullpos</span><span class="s0">;</span>
    <span class="s6">throwError</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s4">'null byte is not allowed in input'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s1">// Use 0 as string terminator. That significantly simplifies bounds check.</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">input </span><span class="s2">+= </span><span class="s4">'</span><span class="s8">\0</span><span class="s4">'</span><span class="s0">;</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">input</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position</span><span class="s0">) </span><span class="s2">=== </span><span class="s7">0x20</span><span class="s1">/* Space */</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">lineIndent </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">;</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">position </span><span class="s2">&lt; </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">)) {</span>
    <span class="s6">readDocument</span><span class="s0">(</span><span class="s3">state</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">state</span><span class="s0">.</span><span class="s3">documents</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">loadAll$1(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">iterator</span><span class="s0">, </span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">iterator </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">&amp;&amp; typeof </span><span class="s3">iterator </span><span class="s2">=== </span><span class="s4">'object' </span><span class="s2">&amp;&amp; typeof </span><span class="s3">options </span><span class="s2">=== </span><span class="s4">'undefined'</span><span class="s0">) {</span>
    <span class="s3">options </span><span class="s2">= </span><span class="s3">iterator</span><span class="s0">;</span>
    <span class="s3">iterator </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">var </span><span class="s0">documents </span><span class="s2">= </span><span class="s6">loadDocuments</span><span class="s0">(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">options</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">iterator </span><span class="s2">!== </span><span class="s4">'function'</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s3">documents</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, length </span><span class="s2">= </span><span class="s3">documents</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s6">iterator</span><span class="s0">(</span><span class="s3">documents</span><span class="s0">[</span><span class="s3">index</span><span class="s0">]);</span>
  <span class="s0">}</span>
<span class="s0">}</span>


<span class="s2">function </span><span class="s0">load$1(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">documents </span><span class="s2">= </span><span class="s6">loadDocuments</span><span class="s0">(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">options</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">documents</span><span class="s0">.length </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) {</span>
    <span class="s1">/*eslint-disable no-undefined*/</span>
    <span class="s2">return </span><span class="s5">undefined</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">documents</span><span class="s0">.length </span><span class="s2">=== </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s3">documents</span><span class="s0">[</span><span class="s7">0</span><span class="s0">];</span>
  <span class="s0">}</span>
  <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'expected a single document in the stream, but found more'</span><span class="s0">);</span>
<span class="s0">}</span>


<span class="s2">var </span><span class="s0">loadAll_1 </span><span class="s2">= </span><span class="s3">loadAll$1</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">load_1    </span><span class="s2">= </span><span class="s3">load$1</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">loader </span><span class="s2">= </span><span class="s0">{</span>
	<span class="s0">loadAll: </span><span class="s3">loadAll_1</span><span class="s0">,</span>
	<span class="s0">load: </span><span class="s3">load_1</span>
<span class="s0">};</span>

<span class="s1">/*eslint-disable no-use-before-define*/</span>





<span class="s2">var </span><span class="s0">_toString       </span><span class="s2">= </span><span class="s0">Object.prototype.</span><span class="s3">toString</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">_hasOwnProperty </span><span class="s2">= </span><span class="s0">Object.prototype.</span><span class="s3">hasOwnProperty</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">CHAR_BOM                  </span><span class="s2">= </span><span class="s7">0xFEFF</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">CHAR_TAB                  </span><span class="s2">= </span><span class="s7">0x09</span><span class="s0">; </span><span class="s1">/* Tab */</span>
<span class="s2">var </span><span class="s0">CHAR_LINE_FEED            </span><span class="s2">= </span><span class="s7">0x0A</span><span class="s0">; </span><span class="s1">/* LF */</span>
<span class="s2">var </span><span class="s0">CHAR_CARRIAGE_RETURN      </span><span class="s2">= </span><span class="s7">0x0D</span><span class="s0">; </span><span class="s1">/* CR */</span>
<span class="s2">var </span><span class="s0">CHAR_SPACE                </span><span class="s2">= </span><span class="s7">0x20</span><span class="s0">; </span><span class="s1">/* Space */</span>
<span class="s2">var </span><span class="s0">CHAR_EXCLAMATION          </span><span class="s2">= </span><span class="s7">0x21</span><span class="s0">; </span><span class="s1">/* ! */</span>
<span class="s2">var </span><span class="s0">CHAR_DOUBLE_QUOTE         </span><span class="s2">= </span><span class="s7">0x22</span><span class="s0">; </span><span class="s1">/* &quot; */</span>
<span class="s2">var </span><span class="s0">CHAR_SHARP                </span><span class="s2">= </span><span class="s7">0x23</span><span class="s0">; </span><span class="s1">/* # */</span>
<span class="s2">var </span><span class="s0">CHAR_PERCENT              </span><span class="s2">= </span><span class="s7">0x25</span><span class="s0">; </span><span class="s1">/* % */</span>
<span class="s2">var </span><span class="s0">CHAR_AMPERSAND            </span><span class="s2">= </span><span class="s7">0x26</span><span class="s0">; </span><span class="s1">/* &amp; */</span>
<span class="s2">var </span><span class="s0">CHAR_SINGLE_QUOTE         </span><span class="s2">= </span><span class="s7">0x27</span><span class="s0">; </span><span class="s1">/* ' */</span>
<span class="s2">var </span><span class="s0">CHAR_ASTERISK             </span><span class="s2">= </span><span class="s7">0x2A</span><span class="s0">; </span><span class="s1">/* * */</span>
<span class="s2">var </span><span class="s0">CHAR_COMMA                </span><span class="s2">= </span><span class="s7">0x2C</span><span class="s0">; </span><span class="s1">/* , */</span>
<span class="s2">var </span><span class="s0">CHAR_MINUS                </span><span class="s2">= </span><span class="s7">0x2D</span><span class="s0">; </span><span class="s1">/* - */</span>
<span class="s2">var </span><span class="s0">CHAR_COLON                </span><span class="s2">= </span><span class="s7">0x3A</span><span class="s0">; </span><span class="s1">/* : */</span>
<span class="s2">var </span><span class="s0">CHAR_EQUALS               </span><span class="s2">= </span><span class="s7">0x3D</span><span class="s0">; </span><span class="s1">/* = */</span>
<span class="s2">var </span><span class="s0">CHAR_GREATER_THAN         </span><span class="s2">= </span><span class="s7">0x3E</span><span class="s0">; </span><span class="s1">/* &gt; */</span>
<span class="s2">var </span><span class="s0">CHAR_QUESTION             </span><span class="s2">= </span><span class="s7">0x3F</span><span class="s0">; </span><span class="s1">/* ? */</span>
<span class="s2">var </span><span class="s0">CHAR_COMMERCIAL_AT        </span><span class="s2">= </span><span class="s7">0x40</span><span class="s0">; </span><span class="s1">/* @ */</span>
<span class="s2">var </span><span class="s0">CHAR_LEFT_SQUARE_BRACKET  </span><span class="s2">= </span><span class="s7">0x5B</span><span class="s0">; </span><span class="s1">/* [ */</span>
<span class="s2">var </span><span class="s0">CHAR_RIGHT_SQUARE_BRACKET </span><span class="s2">= </span><span class="s7">0x5D</span><span class="s0">; </span><span class="s1">/* ] */</span>
<span class="s2">var </span><span class="s0">CHAR_GRAVE_ACCENT         </span><span class="s2">= </span><span class="s7">0x60</span><span class="s0">; </span><span class="s1">/* ` */</span>
<span class="s2">var </span><span class="s0">CHAR_LEFT_CURLY_BRACKET   </span><span class="s2">= </span><span class="s7">0x7B</span><span class="s0">; </span><span class="s1">/* { */</span>
<span class="s2">var </span><span class="s0">CHAR_VERTICAL_LINE        </span><span class="s2">= </span><span class="s7">0x7C</span><span class="s0">; </span><span class="s1">/* | */</span>
<span class="s2">var </span><span class="s0">CHAR_RIGHT_CURLY_BRACKET  </span><span class="s2">= </span><span class="s7">0x7D</span><span class="s0">; </span><span class="s1">/* } */</span>

<span class="s2">var </span><span class="s0">ESCAPE_SEQUENCES </span><span class="s2">= </span><span class="s0">{};</span>

<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x00</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">0'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x07</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">a'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x08</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">b'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x09</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">t'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x0A</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">n'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x0B</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">v'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x0C</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">f'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x0D</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">r'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x1B</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">e'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x22</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">&quot;'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x5C</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\\\</span><span class="s4">'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x85</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">N'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0xA0</span><span class="s0">]   </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">_'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x2028</span><span class="s0">] </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">L'</span><span class="s0">;</span>
<span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s7">0x2029</span><span class="s0">] </span><span class="s2">= </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">P'</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">DEPRECATED_BOOLEANS_SYNTAX </span><span class="s2">= </span><span class="s0">[</span>
  <span class="s4">'y'</span><span class="s0">, </span><span class="s4">'Y'</span><span class="s0">, </span><span class="s4">'yes'</span><span class="s0">, </span><span class="s4">'Yes'</span><span class="s0">, </span><span class="s4">'YES'</span><span class="s0">, </span><span class="s4">'on'</span><span class="s0">, </span><span class="s4">'On'</span><span class="s0">, </span><span class="s4">'ON'</span><span class="s0">,</span>
  <span class="s4">'n'</span><span class="s0">, </span><span class="s4">'N'</span><span class="s0">, </span><span class="s4">'no'</span><span class="s0">, </span><span class="s4">'No'</span><span class="s0">, </span><span class="s4">'NO'</span><span class="s0">, </span><span class="s4">'off'</span><span class="s0">, </span><span class="s4">'Off'</span><span class="s0">, </span><span class="s4">'OFF'</span>
<span class="s0">];</span>

<span class="s2">var </span><span class="s0">DEPRECATED_BASE60_SYNTAX </span><span class="s2">= </span><span class="s4">/</span><span class="s2">^</span><span class="s5">[-+]</span><span class="s2">?</span><span class="s5">[0-9_]</span><span class="s2">+</span><span class="s4">(?::</span><span class="s5">[0-9_]</span><span class="s2">+</span><span class="s4">)</span><span class="s2">+</span><span class="s4">(?:</span><span class="s8">\.</span><span class="s5">[0-9_]</span><span class="s2">*</span><span class="s4">)</span><span class="s2">?$</span><span class="s4">/</span><span class="s0">;</span>

<span class="s2">function </span><span class="s0">compileStyleMap(</span><span class="s3">schema</span><span class="s0">, </span><span class="s3">map</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">result, keys, index, length, tag, style, type;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">map </span><span class="s2">=== </span><span class="s5">null</span><span class="s0">) </span><span class="s2">return </span><span class="s0">{};</span>

  <span class="s3">result </span><span class="s2">= </span><span class="s0">{};</span>
  <span class="s3">keys </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">map</span><span class="s0">);</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">keys</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">tag </span><span class="s2">= </span><span class="s3">keys</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
    <span class="s3">style </span><span class="s2">= </span><span class="s6">String</span><span class="s0">(</span><span class="s3">map</span><span class="s0">[</span><span class="s3">tag</span><span class="s0">]);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">tag</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">0</span><span class="s0">, </span><span class="s7">2</span><span class="s0">) </span><span class="s2">=== </span><span class="s4">'!!'</span><span class="s0">) {</span>
      <span class="s3">tag </span><span class="s2">= </span><span class="s4">'tag:yaml.org,2002:' </span><span class="s2">+ </span><span class="s3">tag</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">2</span><span class="s0">);</span>
    <span class="s0">}</span>
    <span class="s3">type </span><span class="s2">= </span><span class="s3">schema</span><span class="s0">.</span><span class="s3">compiledTypeMap</span><span class="s0">[</span><span class="s4">'fallback'</span><span class="s0">][</span><span class="s3">tag</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">type </span><span class="s2">&amp;&amp; </span><span class="s3">_hasOwnProperty</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s3">styleAliases</span><span class="s0">, </span><span class="s3">style</span><span class="s0">)) {</span>
      <span class="s3">style </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s3">styleAliases</span><span class="s0">[</span><span class="s3">style</span><span class="s0">];</span>
    <span class="s0">}</span>

    <span class="s3">result</span><span class="s0">[</span><span class="s3">tag</span><span class="s0">] </span><span class="s2">= </span><span class="s3">style</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">encodeHex(</span><span class="s3">character</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">string, handle, length;</span>

  <span class="s3">string </span><span class="s2">= </span><span class="s3">character</span><span class="s0">.</span><span class="s6">toString</span><span class="s0">(</span><span class="s7">16</span><span class="s0">).</span><span class="s6">toUpperCase</span><span class="s0">();</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">character </span><span class="s2">&lt;= </span><span class="s7">0xFF</span><span class="s0">) {</span>
    <span class="s3">handle </span><span class="s2">= </span><span class="s4">'x'</span><span class="s0">;</span>
    <span class="s3">length </span><span class="s2">= </span><span class="s7">2</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">character </span><span class="s2">&lt;= </span><span class="s7">0xFFFF</span><span class="s0">) {</span>
    <span class="s3">handle </span><span class="s2">= </span><span class="s4">'u'</span><span class="s0">;</span>
    <span class="s3">length </span><span class="s2">= </span><span class="s7">4</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">character </span><span class="s2">&lt;= </span><span class="s7">0xFFFFFFFF</span><span class="s0">) {</span>
    <span class="s3">handle </span><span class="s2">= </span><span class="s4">'U'</span><span class="s0">;</span>
    <span class="s3">length </span><span class="s2">= </span><span class="s7">8</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'code point within a string may not be greater than 0xFFFFFFFF'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s4">'</span><span class="s8">\\</span><span class="s4">' </span><span class="s2">+ </span><span class="s3">handle </span><span class="s2">+ </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">'0'</span><span class="s0">, </span><span class="s3">length </span><span class="s2">- </span><span class="s3">string</span><span class="s0">.length) </span><span class="s2">+ </span><span class="s3">string</span><span class="s0">;</span>
<span class="s0">}</span>


<span class="s2">var </span><span class="s0">QUOTING_TYPE_SINGLE </span><span class="s2">= </span><span class="s7">1</span><span class="s0">,</span>
    <span class="s0">QUOTING_TYPE_DOUBLE </span><span class="s2">= </span><span class="s7">2</span><span class="s0">;</span>

<span class="s2">function </span><span class="s0">State(</span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">schema        </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'schema'</span><span class="s0">] </span><span class="s2">|| </span><span class="s3">_default</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">indent        </span><span class="s2">= </span><span class="s3">Math</span><span class="s0">.</span><span class="s6">max</span><span class="s0">(</span><span class="s7">1</span><span class="s0">, (</span><span class="s3">options</span><span class="s0">[</span><span class="s4">'indent'</span><span class="s0">] </span><span class="s2">|| </span><span class="s7">2</span><span class="s0">));</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">noArrayIndent </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'noArrayIndent'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">skipInvalid   </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'skipInvalid'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">flowLevel     </span><span class="s2">= </span><span class="s0">(</span><span class="s3">common</span><span class="s0">.</span><span class="s6">isNothing</span><span class="s0">(</span><span class="s3">options</span><span class="s0">[</span><span class="s4">'flowLevel'</span><span class="s0">]) </span><span class="s2">? -</span><span class="s7">1 </span><span class="s2">: </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'flowLevel'</span><span class="s0">]);</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">styleMap      </span><span class="s2">= </span><span class="s6">compileStyleMap</span><span class="s0">(</span><span class="s3">this</span><span class="s0">.</span><span class="s3">schema</span><span class="s0">, </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'styles'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">null</span><span class="s0">);</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">sortKeys      </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'sortKeys'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">lineWidth     </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'lineWidth'</span><span class="s0">] </span><span class="s2">|| </span><span class="s7">80</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">noRefs        </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'noRefs'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">noCompatMode  </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'noCompatMode'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">condenseFlow  </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'condenseFlow'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">quotingType   </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'quotingType'</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'&quot;' </span><span class="s2">? </span><span class="s3">QUOTING_TYPE_DOUBLE </span><span class="s2">: </span><span class="s3">QUOTING_TYPE_SINGLE</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">forceQuotes   </span><span class="s2">= </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'forceQuotes'</span><span class="s0">] </span><span class="s2">|| </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">replacer      </span><span class="s2">= typeof </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'replacer'</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'function' </span><span class="s2">? </span><span class="s3">options</span><span class="s0">[</span><span class="s4">'replacer'</span><span class="s0">] </span><span class="s2">: </span><span class="s5">null</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">implicitTypes </span><span class="s2">= </span><span class="s3">this</span><span class="s0">.</span><span class="s3">schema</span><span class="s0">.</span><span class="s3">compiledImplicit</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">explicitTypes </span><span class="s2">= </span><span class="s3">this</span><span class="s0">.</span><span class="s3">schema</span><span class="s0">.</span><span class="s3">compiledExplicit</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>

  <span class="s3">this</span><span class="s0">.</span><span class="s3">duplicates </span><span class="s2">= </span><span class="s0">[];</span>
  <span class="s3">this</span><span class="s0">.</span><span class="s3">usedDuplicates </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Indents every line in a string. Empty lines (\n only) are not indented.</span>
<span class="s2">function </span><span class="s0">indentString(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">spaces</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">ind </span><span class="s2">= </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">' '</span><span class="s0">, </span><span class="s3">spaces</span><span class="s0">),</span>
      <span class="s0">position </span><span class="s2">= </span><span class="s7">0</span><span class="s0">,</span>
      <span class="s0">next </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">,</span>
      <span class="s0">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">,</span>
      <span class="s0">line,</span>
      <span class="s0">length </span><span class="s2">= </span><span class="s3">string</span><span class="s0">.length;</span>

  <span class="s2">while </span><span class="s0">(</span><span class="s3">position </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">) {</span>
    <span class="s3">next </span><span class="s2">= </span><span class="s3">string</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">, </span><span class="s3">position</span><span class="s0">);</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">next </span><span class="s2">=== -</span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s3">line </span><span class="s2">= </span><span class="s3">string</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">position</span><span class="s0">);</span>
      <span class="s3">position </span><span class="s2">= </span><span class="s3">length</span><span class="s0">;</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">line </span><span class="s2">= </span><span class="s3">string</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">position</span><span class="s0">, </span><span class="s3">next </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>
      <span class="s3">position </span><span class="s2">= </span><span class="s3">next </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">line</span><span class="s0">.length </span><span class="s2">&amp;&amp; </span><span class="s3">line </span><span class="s2">!== </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">) </span><span class="s3">result </span><span class="s2">+= </span><span class="s3">ind</span><span class="s0">;</span>

    <span class="s3">result </span><span class="s2">+= </span><span class="s3">line</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">generateNextLine(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">+ </span><span class="s3">common</span><span class="s0">.</span><span class="s6">repeat</span><span class="s0">(</span><span class="s4">' '</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">indent </span><span class="s2">* </span><span class="s3">level</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">testImplicitResolving(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">str</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">index, length, type;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">implicitTypes</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">type </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">implicitTypes</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s6">resolve</span><span class="s0">(</span><span class="s3">str</span><span class="s0">)) {</span>
      <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// [33] s-white ::= s-space | s-tab</span>
<span class="s2">function </span><span class="s0">isWhitespace(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">c </span><span class="s2">=== </span><span class="s3">CHAR_SPACE </span><span class="s2">|| </span><span class="s3">c </span><span class="s2">=== </span><span class="s3">CHAR_TAB</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Returns true if the character can be printed without escaping.</span>
<span class="s1">// From YAML 1.2: &quot;any allowed characters known to be non-printable</span>
<span class="s1">// should also be escaped. [However,] This isn’t mandatory&quot;</span>
<span class="s1">// Derived from nb-char - \t - #x85 - #xA0 - #x2028 - #x2029.</span>
<span class="s2">function </span><span class="s0">isPrintable(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return  </span><span class="s0">(</span><span class="s7">0x00020 </span><span class="s2">&lt;= </span><span class="s3">c </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x00007E</span><span class="s0">)</span>
      <span class="s2">|| </span><span class="s0">((</span><span class="s7">0x000A1 </span><span class="s2">&lt;= </span><span class="s3">c </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x00D7FF</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s7">0x2028 </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s7">0x2029</span><span class="s0">)</span>
      <span class="s2">|| </span><span class="s0">((</span><span class="s7">0x0E000 </span><span class="s2">&lt;= </span><span class="s3">c </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x00FFFD</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_BOM</span><span class="s0">)</span>
      <span class="s2">||  </span><span class="s0">(</span><span class="s7">0x10000 </span><span class="s2">&lt;= </span><span class="s3">c </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">&lt;= </span><span class="s7">0x10FFFF</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s1">// [34] ns-char ::= nb-char - s-white</span>
<span class="s1">// [27] nb-char ::= c-printable - b-char - c-byte-order-mark</span>
<span class="s1">// [26] b-char  ::= b-line-feed | b-carriage-return</span>
<span class="s1">// Including s-white (for some reason, examples doesn't match specs in this aspect)</span>
<span class="s1">// ns-char ::= c-printable - b-line-feed - b-carriage-return - c-byte-order-mark</span>
<span class="s2">function </span><span class="s0">isNsCharOrWhitespace(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s6">isPrintable</span><span class="s0">(</span><span class="s3">c</span><span class="s0">)</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_BOM</span>
    <span class="s1">// - b-char</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_CARRIAGE_RETURN</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_LINE_FEED</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// [127]  ns-plain-safe(c) ::= c = flow-out  ⇒ ns-plain-safe-out</span>
<span class="s1">//                             c = flow-in   ⇒ ns-plain-safe-in</span>
<span class="s1">//                             c = block-key ⇒ ns-plain-safe-out</span>
<span class="s1">//                             c = flow-key  ⇒ ns-plain-safe-in</span>
<span class="s1">// [128] ns-plain-safe-out ::= ns-char</span>
<span class="s1">// [129]  ns-plain-safe-in ::= ns-char - c-flow-indicator</span>
<span class="s1">// [130]  ns-plain-char(c) ::=  ( ns-plain-safe(c) - “:” - “#” )</span>
<span class="s1">//                            | ( /* An ns-char preceding */ “#” )</span>
<span class="s1">//                            | ( “:” /* Followed by an ns-plain-safe(c) */ )</span>
<span class="s2">function </span><span class="s0">isPlainSafe(</span><span class="s3">c</span><span class="s0">, </span><span class="s3">prev</span><span class="s0">, </span><span class="s3">inblock</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">cIsNsCharOrWhitespace </span><span class="s2">= </span><span class="s6">isNsCharOrWhitespace</span><span class="s0">(</span><span class="s3">c</span><span class="s0">);</span>
  <span class="s2">var </span><span class="s0">cIsNsChar </span><span class="s2">= </span><span class="s3">cIsNsCharOrWhitespace </span><span class="s2">&amp;&amp; !</span><span class="s6">isWhitespace</span><span class="s0">(</span><span class="s3">c</span><span class="s0">);</span>
  <span class="s2">return </span><span class="s0">(</span>
    <span class="s1">// ns-plain-safe</span>
    <span class="s3">inblock </span><span class="s2">? </span><span class="s1">// c = flow-in</span>
      <span class="s3">cIsNsCharOrWhitespace</span>
      <span class="s2">: </span><span class="s3">cIsNsCharOrWhitespace</span>
        <span class="s1">// - c-flow-indicator</span>
        <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_COMMA</span>
        <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_LEFT_SQUARE_BRACKET</span>
        <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_RIGHT_SQUARE_BRACKET</span>
        <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_LEFT_CURLY_BRACKET</span>
        <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_RIGHT_CURLY_BRACKET</span>
  <span class="s0">)</span>
    <span class="s1">// ns-plain-char</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_SHARP </span><span class="s1">// false on '#'</span>
    <span class="s2">&amp;&amp; !</span><span class="s0">(</span><span class="s3">prev </span><span class="s2">=== </span><span class="s3">CHAR_COLON </span><span class="s2">&amp;&amp; !</span><span class="s3">cIsNsChar</span><span class="s0">) </span><span class="s1">// false on ': '</span>
    <span class="s2">|| </span><span class="s0">(</span><span class="s6">isNsCharOrWhitespace</span><span class="s0">(</span><span class="s3">prev</span><span class="s0">) </span><span class="s2">&amp;&amp; !</span><span class="s6">isWhitespace</span><span class="s0">(</span><span class="s3">prev</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">=== </span><span class="s3">CHAR_SHARP</span><span class="s0">) </span><span class="s1">// change to true on '[^ ]#'</span>
    <span class="s2">|| </span><span class="s0">(</span><span class="s3">prev </span><span class="s2">=== </span><span class="s3">CHAR_COLON </span><span class="s2">&amp;&amp; </span><span class="s3">cIsNsChar</span><span class="s0">); </span><span class="s1">// change to true on ':[^ ]'</span>
<span class="s0">}</span>

<span class="s1">// Simplified test for values allowed as the first character in plain style.</span>
<span class="s2">function </span><span class="s0">isPlainSafeFirst(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s1">// Uses a subset of ns-char - c-indicator</span>
  <span class="s1">// where ns-char = nb-char - s-white.</span>
  <span class="s1">// No support of ( ( “?” | “:” | “-” ) /* Followed by an ns-plain-safe(c)) */ ) part</span>
  <span class="s2">return </span><span class="s6">isPrintable</span><span class="s0">(</span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_BOM</span>
    <span class="s2">&amp;&amp; !</span><span class="s6">isWhitespace</span><span class="s0">(</span><span class="s3">c</span><span class="s0">) </span><span class="s1">// - s-white</span>
    <span class="s1">// - (c-indicator ::=</span>
    <span class="s1">// “-” | “?” | “:” | “,” | “[” | “]” | “{” | “}”</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_MINUS</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_QUESTION</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_COLON</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_COMMA</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_LEFT_SQUARE_BRACKET</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_RIGHT_SQUARE_BRACKET</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_LEFT_CURLY_BRACKET</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_RIGHT_CURLY_BRACKET</span>
    <span class="s1">// | “#” | “&amp;” | “*” | “!” | “|” | “=” | “&gt;” | “'” | “&quot;”</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_SHARP</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_AMPERSAND</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_ASTERISK</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_EXCLAMATION</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_VERTICAL_LINE</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_EQUALS</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_GREATER_THAN</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_SINGLE_QUOTE</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_DOUBLE_QUOTE</span>
    <span class="s1">// | “%” | “@” | “`”)</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_PERCENT</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_COMMERCIAL_AT</span>
    <span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_GRAVE_ACCENT</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Simplified test for values allowed as the last character in plain style.</span>
<span class="s2">function </span><span class="s0">isPlainSafeLast(</span><span class="s3">c</span><span class="s0">) {</span>
  <span class="s1">// just not whitespace or colon, it will be checked to be plain character later</span>
  <span class="s2">return !</span><span class="s6">isWhitespace</span><span class="s0">(</span><span class="s3">c</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s3">c </span><span class="s2">!== </span><span class="s3">CHAR_COLON</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Same as 'string'.codePointAt(pos), but works in older browsers.</span>
<span class="s2">function </span><span class="s0">codePointAt(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">pos</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">first </span><span class="s2">= </span><span class="s3">string</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">pos</span><span class="s0">), second;</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">first </span><span class="s2">&gt;= </span><span class="s7">0xD800 </span><span class="s2">&amp;&amp; </span><span class="s3">first </span><span class="s2">&lt;= </span><span class="s7">0xDBFF </span><span class="s2">&amp;&amp; </span><span class="s3">pos </span><span class="s2">+ </span><span class="s7">1 </span><span class="s2">&lt; </span><span class="s3">string</span><span class="s0">.length) {</span>
    <span class="s3">second </span><span class="s2">= </span><span class="s3">string</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s3">pos </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">second </span><span class="s2">&gt;= </span><span class="s7">0xDC00 </span><span class="s2">&amp;&amp; </span><span class="s3">second </span><span class="s2">&lt;= </span><span class="s7">0xDFFF</span><span class="s0">) {</span>
      <span class="s1">// https://mathiasbynens.be/notes/javascript-encoding#surrogate-formulae</span>
      <span class="s2">return </span><span class="s0">(</span><span class="s3">first </span><span class="s2">- </span><span class="s7">0xD800</span><span class="s0">) </span><span class="s2">* </span><span class="s7">0x400 </span><span class="s2">+ </span><span class="s3">second </span><span class="s2">- </span><span class="s7">0xDC00 </span><span class="s2">+ </span><span class="s7">0x10000</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>
  <span class="s2">return </span><span class="s3">first</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Determines whether block indentation indicator is required.</span>
<span class="s2">function </span><span class="s0">needIndentIndicator(</span><span class="s3">string</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">leadingSpaceRe </span><span class="s2">= </span><span class="s4">/</span><span class="s2">^</span><span class="s5">\n</span><span class="s2">* </span><span class="s4">/</span><span class="s0">;</span>
  <span class="s2">return </span><span class="s3">leadingSpaceRe</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">string</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">STYLE_PLAIN   </span><span class="s2">= </span><span class="s7">1</span><span class="s0">,</span>
    <span class="s0">STYLE_SINGLE  </span><span class="s2">= </span><span class="s7">2</span><span class="s0">,</span>
    <span class="s0">STYLE_LITERAL </span><span class="s2">= </span><span class="s7">3</span><span class="s0">,</span>
    <span class="s0">STYLE_FOLDED  </span><span class="s2">= </span><span class="s7">4</span><span class="s0">,</span>
    <span class="s0">STYLE_DOUBLE  </span><span class="s2">= </span><span class="s7">5</span><span class="s0">;</span>

<span class="s1">// Determines which scalar styles are possible and returns the preferred style.</span>
<span class="s1">// lineWidth = -1 =&gt; no limit.</span>
<span class="s1">// Pre-conditions: str.length &gt; 0.</span>
<span class="s1">// Post-conditions:</span>
<span class="s1">//    STYLE_PLAIN or STYLE_SINGLE =&gt; no \n are in the string.</span>
<span class="s1">//    STYLE_LITERAL =&gt; no lines are suitable for folding (or lineWidth is -1).</span>
<span class="s1">//    STYLE_FOLDED =&gt; a line &gt; lineWidth and can be folded (and lineWidth != -1).</span>
<span class="s2">function </span><span class="s0">chooseScalarStyle(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">singleLineOnly</span><span class="s0">, </span><span class="s3">indentPerLevel</span><span class="s0">, </span><span class="s3">lineWidth</span><span class="s0">,</span>
  <span class="s3">testAmbiguousType</span><span class="s0">, </span><span class="s3">quotingType</span><span class="s0">, </span><span class="s3">forceQuotes</span><span class="s0">, </span><span class="s3">inblock</span><span class="s0">) {</span>

  <span class="s2">var </span><span class="s0">i;</span>
  <span class="s2">var </span><span class="s0">char </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">prevChar </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">hasLineBreak </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">hasFoldableLine </span><span class="s2">= </span><span class="s5">false</span><span class="s0">; </span><span class="s1">// only checked if shouldTrackWidth</span>
  <span class="s2">var </span><span class="s0">shouldTrackWidth </span><span class="s2">= </span><span class="s3">lineWidth </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">previousLineBreak </span><span class="s2">= -</span><span class="s7">1</span><span class="s0">; </span><span class="s1">// count the first line correctly</span>
  <span class="s2">var </span><span class="s0">plain </span><span class="s2">= </span><span class="s6">isPlainSafeFirst</span><span class="s0">(</span><span class="s6">codePointAt</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s7">0</span><span class="s0">))</span>
          <span class="s2">&amp;&amp; </span><span class="s6">isPlainSafeLast</span><span class="s0">(</span><span class="s6">codePointAt</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">string</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">));</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">singleLineOnly </span><span class="s2">|| </span><span class="s3">forceQuotes</span><span class="s0">) {</span>
    <span class="s1">// Case: no block styles.</span>
    <span class="s1">// Check for disallowed characters to rule out plain and single.</span>
    <span class="s2">for </span><span class="s0">(</span><span class="s3">i </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">i </span><span class="s2">&lt; </span><span class="s3">string</span><span class="s0">.length; </span><span class="s3">char </span><span class="s2">&gt;= </span><span class="s7">0x10000 </span><span class="s2">? </span><span class="s3">i </span><span class="s2">+= </span><span class="s7">2 </span><span class="s2">: </span><span class="s3">i</span><span class="s2">++</span><span class="s0">) {</span>
      <span class="s3">char </span><span class="s2">= </span><span class="s6">codePointAt</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">i</span><span class="s0">);</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">isPrintable</span><span class="s0">(</span><span class="s3">char</span><span class="s0">)) {</span>
        <span class="s2">return </span><span class="s3">STYLE_DOUBLE</span><span class="s0">;</span>
      <span class="s0">}</span>
      <span class="s3">plain </span><span class="s2">= </span><span class="s3">plain </span><span class="s2">&amp;&amp; </span><span class="s6">isPlainSafe</span><span class="s0">(</span><span class="s3">char</span><span class="s0">, </span><span class="s3">prevChar</span><span class="s0">, </span><span class="s3">inblock</span><span class="s0">);</span>
      <span class="s3">prevChar </span><span class="s2">= </span><span class="s3">char</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s1">// Case: block styles permitted.</span>
    <span class="s2">for </span><span class="s0">(</span><span class="s3">i </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">i </span><span class="s2">&lt; </span><span class="s3">string</span><span class="s0">.length; </span><span class="s3">char </span><span class="s2">&gt;= </span><span class="s7">0x10000 </span><span class="s2">? </span><span class="s3">i </span><span class="s2">+= </span><span class="s7">2 </span><span class="s2">: </span><span class="s3">i</span><span class="s2">++</span><span class="s0">) {</span>
      <span class="s3">char </span><span class="s2">= </span><span class="s6">codePointAt</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">i</span><span class="s0">);</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">char </span><span class="s2">=== </span><span class="s3">CHAR_LINE_FEED</span><span class="s0">) {</span>
        <span class="s3">hasLineBreak </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
        <span class="s1">// Check if any line can be folded.</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">shouldTrackWidth</span><span class="s0">) {</span>
          <span class="s3">hasFoldableLine </span><span class="s2">= </span><span class="s3">hasFoldableLine </span><span class="s2">||</span>
            <span class="s1">// Foldable line = too long, and not more-indented.</span>
            <span class="s0">(</span><span class="s3">i </span><span class="s2">- </span><span class="s3">previousLineBreak </span><span class="s2">- </span><span class="s7">1 </span><span class="s2">&gt; </span><span class="s3">lineWidth </span><span class="s2">&amp;&amp;</span>
             <span class="s3">string</span><span class="s0">[</span><span class="s3">previousLineBreak </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">] </span><span class="s2">!== </span><span class="s4">' '</span><span class="s0">);</span>
          <span class="s3">previousLineBreak </span><span class="s2">= </span><span class="s3">i</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">isPrintable</span><span class="s0">(</span><span class="s3">char</span><span class="s0">)) {</span>
        <span class="s2">return </span><span class="s3">STYLE_DOUBLE</span><span class="s0">;</span>
      <span class="s0">}</span>
      <span class="s3">plain </span><span class="s2">= </span><span class="s3">plain </span><span class="s2">&amp;&amp; </span><span class="s6">isPlainSafe</span><span class="s0">(</span><span class="s3">char</span><span class="s0">, </span><span class="s3">prevChar</span><span class="s0">, </span><span class="s3">inblock</span><span class="s0">);</span>
      <span class="s3">prevChar </span><span class="s2">= </span><span class="s3">char</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s1">// in case the end is missing a \n</span>
    <span class="s3">hasFoldableLine </span><span class="s2">= </span><span class="s3">hasFoldableLine </span><span class="s2">|| </span><span class="s0">(</span><span class="s3">shouldTrackWidth </span><span class="s2">&amp;&amp;</span>
      <span class="s0">(</span><span class="s3">i </span><span class="s2">- </span><span class="s3">previousLineBreak </span><span class="s2">- </span><span class="s7">1 </span><span class="s2">&gt; </span><span class="s3">lineWidth </span><span class="s2">&amp;&amp;</span>
       <span class="s3">string</span><span class="s0">[</span><span class="s3">previousLineBreak </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">] </span><span class="s2">!== </span><span class="s4">' '</span><span class="s0">));</span>
  <span class="s0">}</span>
  <span class="s1">// Although every style can represent \n without escaping, prefer block styles</span>
  <span class="s1">// for multiline, since they're more readable and they don't add empty lines.</span>
  <span class="s1">// Also prefer folding a super-long line.</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">hasLineBreak </span><span class="s2">&amp;&amp; !</span><span class="s3">hasFoldableLine</span><span class="s0">) {</span>
    <span class="s1">// Strings interpretable as another type have to be quoted;</span>
    <span class="s1">// e.g. the string 'true' vs. the boolean true.</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">plain </span><span class="s2">&amp;&amp; !</span><span class="s3">forceQuotes </span><span class="s2">&amp;&amp; !</span><span class="s6">testAmbiguousType</span><span class="s0">(</span><span class="s3">string</span><span class="s0">)) {</span>
      <span class="s2">return </span><span class="s3">STYLE_PLAIN</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s2">return </span><span class="s3">quotingType </span><span class="s2">=== </span><span class="s3">QUOTING_TYPE_DOUBLE </span><span class="s2">? </span><span class="s3">STYLE_DOUBLE </span><span class="s2">: </span><span class="s3">STYLE_SINGLE</span><span class="s0">;</span>
  <span class="s0">}</span>
  <span class="s1">// Edge case: block indentation indicator can only have one digit.</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">indentPerLevel </span><span class="s2">&gt; </span><span class="s7">9 </span><span class="s2">&amp;&amp; </span><span class="s6">needIndentIndicator</span><span class="s0">(</span><span class="s3">string</span><span class="s0">)) {</span>
    <span class="s2">return </span><span class="s3">STYLE_DOUBLE</span><span class="s0">;</span>
  <span class="s0">}</span>
  <span class="s1">// At this point we know block styles are valid.</span>
  <span class="s1">// Prefer literal style unless we want to fold.</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">forceQuotes</span><span class="s0">) {</span>
    <span class="s2">return </span><span class="s3">hasFoldableLine </span><span class="s2">? </span><span class="s3">STYLE_FOLDED </span><span class="s2">: </span><span class="s3">STYLE_LITERAL</span><span class="s0">;</span>
  <span class="s0">}</span>
  <span class="s2">return </span><span class="s3">quotingType </span><span class="s2">=== </span><span class="s3">QUOTING_TYPE_DOUBLE </span><span class="s2">? </span><span class="s3">STYLE_DOUBLE </span><span class="s2">: </span><span class="s3">STYLE_SINGLE</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Note: line breaking/folding is implemented for only the folded style.</span>
<span class="s1">// NB. We drop the last trailing newline (if any) of a returned block scalar</span>
<span class="s1">//  since the dumper adds its own newline. This always works:</span>
<span class="s1">//    • No ending newline =&gt; unaffected; already using strip &quot;-&quot; chomping.</span>
<span class="s1">//    • Ending newline    =&gt; removed then restored.</span>
<span class="s1">//  Importantly, this keeps the &quot;+&quot; chomp indicator from gaining an extra line.</span>
<span class="s2">function </span><span class="s0">writeScalar(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">string</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">iskey</span><span class="s0">, </span><span class="s3">inblock</span><span class="s0">) {</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s0">(</span><span class="s2">function </span><span class="s0">() {</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">string</span><span class="s0">.length </span><span class="s2">=== </span><span class="s7">0</span><span class="s0">) {</span>
      <span class="s2">return </span><span class="s3">state</span><span class="s0">.</span><span class="s3">quotingType </span><span class="s2">=== </span><span class="s3">QUOTING_TYPE_DOUBLE </span><span class="s2">? </span><span class="s4">'&quot;&quot;' </span><span class="s2">: </span><span class="s4">&quot;''&quot;</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">state</span><span class="s0">.</span><span class="s3">noCompatMode</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">DEPRECATED_BOOLEANS_SYNTAX</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">string</span><span class="s0">) </span><span class="s2">!== -</span><span class="s7">1 </span><span class="s2">|| </span><span class="s3">DEPRECATED_BASE60_SYNTAX</span><span class="s0">.</span><span class="s6">test</span><span class="s0">(</span><span class="s3">string</span><span class="s0">)) {</span>
        <span class="s2">return </span><span class="s3">state</span><span class="s0">.</span><span class="s3">quotingType </span><span class="s2">=== </span><span class="s3">QUOTING_TYPE_DOUBLE </span><span class="s2">? </span><span class="s0">(</span><span class="s4">'&quot;' </span><span class="s2">+ </span><span class="s3">string </span><span class="s2">+ </span><span class="s4">'&quot;'</span><span class="s0">) </span><span class="s2">: </span><span class="s0">(</span><span class="s4">&quot;'&quot; </span><span class="s2">+ </span><span class="s3">string </span><span class="s2">+ </span><span class="s4">&quot;'&quot;</span><span class="s0">);</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s2">var </span><span class="s0">indent </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">indent </span><span class="s2">* </span><span class="s3">Math</span><span class="s0">.</span><span class="s6">max</span><span class="s0">(</span><span class="s7">1</span><span class="s0">, </span><span class="s3">level</span><span class="s0">); </span><span class="s1">// no 0-indent scalars</span>
    <span class="s1">// As indentation gets deeper, let the width decrease monotonically</span>
    <span class="s1">// to the lower bound min(state.lineWidth, 40).</span>
    <span class="s1">// Note that this implies</span>
    <span class="s1">//  state.lineWidth ≤ 40 + state.indent: width is fixed at the lower bound.</span>
    <span class="s1">//  state.lineWidth &gt; 40 + state.indent: width decreases until the lower bound.</span>
    <span class="s1">// This behaves better than a constant minimum width which disallows narrower options,</span>
    <span class="s1">// or an indent threshold which causes the width to suddenly increase.</span>
    <span class="s2">var </span><span class="s0">lineWidth </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineWidth </span><span class="s2">=== -</span><span class="s7">1</span>
      <span class="s2">? -</span><span class="s7">1 </span><span class="s2">: </span><span class="s3">Math</span><span class="s0">.</span><span class="s6">max</span><span class="s0">(</span><span class="s3">Math</span><span class="s0">.</span><span class="s6">min</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineWidth</span><span class="s0">, </span><span class="s7">40</span><span class="s0">), </span><span class="s3">state</span><span class="s0">.</span><span class="s3">lineWidth </span><span class="s2">- </span><span class="s3">indent</span><span class="s0">);</span>

    <span class="s1">// Without knowing if keys are implicit/explicit, assume implicit for safety.</span>
    <span class="s2">var </span><span class="s0">singleLineOnly </span><span class="s2">= </span><span class="s3">iskey</span>
      <span class="s1">// No block styles in flow mode.</span>
      <span class="s2">|| </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">flowLevel </span><span class="s2">&gt; -</span><span class="s7">1 </span><span class="s2">&amp;&amp; </span><span class="s3">level </span><span class="s2">&gt;= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">flowLevel</span><span class="s0">);</span>
    <span class="s2">function </span><span class="s0">testAmbiguity(</span><span class="s3">string</span><span class="s0">) {</span>
      <span class="s2">return </span><span class="s6">testImplicitResolving</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">string</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">switch </span><span class="s0">(</span><span class="s6">chooseScalarStyle</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">singleLineOnly</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">indent</span><span class="s0">, </span><span class="s3">lineWidth</span><span class="s0">,</span>
      <span class="s3">testAmbiguity</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">quotingType</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">forceQuotes </span><span class="s2">&amp;&amp; !</span><span class="s3">iskey</span><span class="s0">, </span><span class="s3">inblock</span><span class="s0">)) {</span>

      <span class="s2">case </span><span class="s3">STYLE_PLAIN</span><span class="s0">:</span>
        <span class="s2">return </span><span class="s3">string</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s3">STYLE_SINGLE</span><span class="s0">:</span>
        <span class="s2">return </span><span class="s4">&quot;'&quot; </span><span class="s2">+ </span><span class="s3">string</span><span class="s0">.</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">/'/</span><span class="s2">g</span><span class="s0">, </span><span class="s4">&quot;''&quot;</span><span class="s0">) </span><span class="s2">+ </span><span class="s4">&quot;'&quot;</span><span class="s0">;</span>
      <span class="s2">case </span><span class="s3">STYLE_LITERAL</span><span class="s0">:</span>
        <span class="s2">return </span><span class="s4">'|' </span><span class="s2">+ </span><span class="s6">blockHeader</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">indent</span><span class="s0">)</span>
          <span class="s2">+ </span><span class="s6">dropEndingNewline</span><span class="s0">(</span><span class="s6">indentString</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">indent</span><span class="s0">));</span>
      <span class="s2">case </span><span class="s3">STYLE_FOLDED</span><span class="s0">:</span>
        <span class="s2">return </span><span class="s4">'&gt;' </span><span class="s2">+ </span><span class="s6">blockHeader</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">indent</span><span class="s0">)</span>
          <span class="s2">+ </span><span class="s6">dropEndingNewline</span><span class="s0">(</span><span class="s6">indentString</span><span class="s0">(</span><span class="s6">foldString</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">lineWidth</span><span class="s0">), </span><span class="s3">indent</span><span class="s0">));</span>
      <span class="s2">case </span><span class="s3">STYLE_DOUBLE</span><span class="s0">:</span>
        <span class="s2">return </span><span class="s4">'&quot;' </span><span class="s2">+ </span><span class="s6">escapeString</span><span class="s0">(</span><span class="s3">string</span><span class="s0">) </span><span class="s2">+ </span><span class="s4">'&quot;'</span><span class="s0">;</span>
      <span class="s2">default</span><span class="s0">:</span>
        <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'impossible error: invalid scalar style'</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">}());</span>
<span class="s0">}</span>

<span class="s1">// Pre-conditions: string is valid for a block scalar, 1 &lt;= indentPerLevel &lt;= 9.</span>
<span class="s2">function </span><span class="s0">blockHeader(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">indentPerLevel</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">indentIndicator </span><span class="s2">= </span><span class="s6">needIndentIndicator</span><span class="s0">(</span><span class="s3">string</span><span class="s0">) </span><span class="s2">? </span><span class="s6">String</span><span class="s0">(</span><span class="s3">indentPerLevel</span><span class="s0">) </span><span class="s2">: </span><span class="s4">''</span><span class="s0">;</span>

  <span class="s1">// note the special case: the string '\n' counts as a &quot;trailing&quot; empty line.</span>
  <span class="s2">var </span><span class="s0">clip </span><span class="s2">=          </span><span class="s3">string</span><span class="s0">[</span><span class="s3">string</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">keep </span><span class="s2">= </span><span class="s3">clip </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">string</span><span class="s0">[</span><span class="s3">string</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">2</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">|| </span><span class="s3">string </span><span class="s2">=== </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">);</span>
  <span class="s2">var </span><span class="s0">chomp </span><span class="s2">= </span><span class="s3">keep </span><span class="s2">? </span><span class="s4">'+' </span><span class="s2">: </span><span class="s0">(</span><span class="s3">clip </span><span class="s2">? </span><span class="s4">'' </span><span class="s2">: </span><span class="s4">'-'</span><span class="s0">);</span>

  <span class="s2">return </span><span class="s3">indentIndicator </span><span class="s2">+ </span><span class="s3">chomp </span><span class="s2">+ </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// (See the note for writeScalar.)</span>
<span class="s2">function </span><span class="s0">dropEndingNewline(</span><span class="s3">string</span><span class="s0">) {</span>
  <span class="s2">return </span><span class="s3">string</span><span class="s0">[</span><span class="s3">string</span><span class="s0">.length </span><span class="s2">- </span><span class="s7">1</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">? </span><span class="s3">string</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">0</span><span class="s0">, </span><span class="s2">-</span><span class="s7">1</span><span class="s0">) </span><span class="s2">: </span><span class="s3">string</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Note: a long line without a suitable break point will exceed the width limit.</span>
<span class="s1">// Pre-conditions: every char in str isPrintable, str.length &gt; 0, width &gt; 0.</span>
<span class="s2">function </span><span class="s0">foldString(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">width</span><span class="s0">) {</span>
  <span class="s1">// In folded style, $k$ consecutive newlines output as $k+1$ newlines—</span>
  <span class="s1">// unless they're before or after a more-indented line, or at the very</span>
  <span class="s1">// beginning or end, in which case $k$ maps to $k$.</span>
  <span class="s1">// Therefore, parse each chunk as newline(s) followed by a content line.</span>
  <span class="s2">var </span><span class="s0">lineRe </span><span class="s2">= </span><span class="s4">/(</span><span class="s5">\n</span><span class="s2">+</span><span class="s4">)(</span><span class="s5">[</span><span class="s8">^</span><span class="s5">\n]</span><span class="s2">*</span><span class="s4">)/</span><span class="s2">g</span><span class="s0">;</span>

  <span class="s1">// first line (possibly an empty line)</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s0">(</span><span class="s2">function </span><span class="s0">() {</span>
    <span class="s2">var </span><span class="s0">nextLF </span><span class="s2">= </span><span class="s3">string</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">);</span>
    <span class="s3">nextLF </span><span class="s2">= </span><span class="s3">nextLF </span><span class="s2">!== -</span><span class="s7">1 </span><span class="s2">? </span><span class="s3">nextLF </span><span class="s2">: </span><span class="s3">string</span><span class="s0">.length;</span>
    <span class="s3">lineRe</span><span class="s0">.</span><span class="s3">lastIndex </span><span class="s2">= </span><span class="s3">nextLF</span><span class="s0">;</span>
    <span class="s2">return </span><span class="s6">foldLine</span><span class="s0">(</span><span class="s3">string</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">0</span><span class="s0">, </span><span class="s3">nextLF</span><span class="s0">), </span><span class="s3">width</span><span class="s0">);</span>
  <span class="s0">}());</span>
  <span class="s1">// If we haven't reached the first content line yet, don't add an extra \n.</span>
  <span class="s2">var </span><span class="s0">prevMoreIndented </span><span class="s2">= </span><span class="s3">string</span><span class="s0">[</span><span class="s7">0</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">|| </span><span class="s3">string</span><span class="s0">[</span><span class="s7">0</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">' '</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">moreIndented;</span>

  <span class="s1">// rest of the lines</span>
  <span class="s2">var </span><span class="s0">match;</span>
  <span class="s2">while </span><span class="s0">((</span><span class="s3">match </span><span class="s2">= </span><span class="s3">lineRe</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">string</span><span class="s0">))) {</span>
    <span class="s2">var </span><span class="s0">prefix </span><span class="s2">= </span><span class="s3">match</span><span class="s0">[</span><span class="s7">1</span><span class="s0">], line </span><span class="s2">= </span><span class="s3">match</span><span class="s0">[</span><span class="s7">2</span><span class="s0">];</span>
    <span class="s3">moreIndented </span><span class="s2">= </span><span class="s0">(</span><span class="s3">line</span><span class="s0">[</span><span class="s7">0</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">' '</span><span class="s0">);</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">prefix</span>
      <span class="s2">+ </span><span class="s0">(</span><span class="s2">!</span><span class="s3">prevMoreIndented </span><span class="s2">&amp;&amp; !</span><span class="s3">moreIndented </span><span class="s2">&amp;&amp; </span><span class="s3">line </span><span class="s2">!== </span><span class="s4">''</span>
        <span class="s2">? </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">: </span><span class="s4">''</span><span class="s0">)</span>
      <span class="s2">+ </span><span class="s6">foldLine</span><span class="s0">(</span><span class="s3">line</span><span class="s0">, </span><span class="s3">width</span><span class="s0">);</span>
    <span class="s3">prevMoreIndented </span><span class="s2">= </span><span class="s3">moreIndented</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Greedy line breaking.</span>
<span class="s1">// Picks the longest line under the limit each time,</span>
<span class="s1">// otherwise settles for the shortest line over the limit.</span>
<span class="s1">// NB. More-indented lines *cannot* be folded, as that would add an extra \n.</span>
<span class="s2">function </span><span class="s0">foldLine(</span><span class="s3">line</span><span class="s0">, </span><span class="s3">width</span><span class="s0">) {</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">line </span><span class="s2">=== </span><span class="s4">'' </span><span class="s2">|| </span><span class="s3">line</span><span class="s0">[</span><span class="s7">0</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">' '</span><span class="s0">) </span><span class="s2">return </span><span class="s3">line</span><span class="s0">;</span>

  <span class="s1">// Since a more-indented line adds a \n, breaks can't be followed by a space.</span>
  <span class="s2">var </span><span class="s0">breakRe </span><span class="s2">= </span><span class="s4">/ </span><span class="s5">[</span><span class="s8">^ </span><span class="s5">]</span><span class="s4">/</span><span class="s2">g</span><span class="s0">; </span><span class="s1">// note: the match index will always be &lt;= length-2.</span>
  <span class="s2">var </span><span class="s0">match;</span>
  <span class="s1">// start is an inclusive index. end, curr, and next are exclusive.</span>
  <span class="s2">var </span><span class="s0">start </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, end, curr </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, next </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>

  <span class="s1">// Invariants: 0 &lt;= start &lt;= length-1.</span>
  <span class="s1">//   0 &lt;= curr &lt;= next &lt;= max(0, length-2). curr - start &lt;= width.</span>
  <span class="s1">// Inside the loop:</span>
  <span class="s1">//   A match implies length &gt;= 2, so curr and next are &lt;= length-2.</span>
  <span class="s2">while </span><span class="s0">((</span><span class="s3">match </span><span class="s2">= </span><span class="s3">breakRe</span><span class="s0">.</span><span class="s6">exec</span><span class="s0">(</span><span class="s3">line</span><span class="s0">))) {</span>
    <span class="s3">next </span><span class="s2">= </span><span class="s3">match</span><span class="s0">.</span><span class="s3">index</span><span class="s0">;</span>
    <span class="s1">// maintain invariant: curr - start &lt;= width</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">next </span><span class="s2">- </span><span class="s3">start </span><span class="s2">&gt; </span><span class="s3">width</span><span class="s0">) {</span>
      <span class="s3">end </span><span class="s2">= </span><span class="s0">(</span><span class="s3">curr </span><span class="s2">&gt; </span><span class="s3">start</span><span class="s0">) </span><span class="s2">? </span><span class="s3">curr </span><span class="s2">: </span><span class="s3">next</span><span class="s0">; </span><span class="s1">// derive end &lt;= length-2</span>
      <span class="s3">result </span><span class="s2">+= </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">+ </span><span class="s3">line</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">start</span><span class="s0">, </span><span class="s3">end</span><span class="s0">);</span>
      <span class="s1">// skip the space that was output as \n</span>
      <span class="s3">start </span><span class="s2">= </span><span class="s3">end </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">;                    </span><span class="s1">// derive start &lt;= length-1</span>
    <span class="s0">}</span>
    <span class="s3">curr </span><span class="s2">= </span><span class="s3">next</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s1">// By the invariants, start &lt;= length-1, so there is something left over.</span>
  <span class="s1">// It is either the whole string or a part starting from non-whitespace.</span>
  <span class="s3">result </span><span class="s2">+= </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>
  <span class="s1">// Insert a break if the remainder is too long and there is a break available.</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">line</span><span class="s0">.length </span><span class="s2">- </span><span class="s3">start </span><span class="s2">&gt; </span><span class="s3">width </span><span class="s2">&amp;&amp; </span><span class="s3">curr </span><span class="s2">&gt; </span><span class="s3">start</span><span class="s0">) {</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">line</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">start</span><span class="s0">, </span><span class="s3">curr</span><span class="s0">) </span><span class="s2">+ </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">' </span><span class="s2">+ </span><span class="s3">line</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">curr </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">);</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s3">result </span><span class="s2">+= </span><span class="s3">line</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s3">start</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">); </span><span class="s1">// drop extra \n joiner</span>
<span class="s0">}</span>

<span class="s1">// Escapes a double-quoted string.</span>
<span class="s2">function </span><span class="s0">escapeString(</span><span class="s3">string</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">char </span><span class="s2">= </span><span class="s7">0</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">escapeSeq;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s2">var </span><span class="s0">i </span><span class="s2">= </span><span class="s7">0</span><span class="s0">; </span><span class="s3">i </span><span class="s2">&lt; </span><span class="s3">string</span><span class="s0">.length; </span><span class="s3">char </span><span class="s2">&gt;= </span><span class="s7">0x10000 </span><span class="s2">? </span><span class="s3">i </span><span class="s2">+= </span><span class="s7">2 </span><span class="s2">: </span><span class="s3">i</span><span class="s2">++</span><span class="s0">) {</span>
    <span class="s3">char </span><span class="s2">= </span><span class="s6">codePointAt</span><span class="s0">(</span><span class="s3">string</span><span class="s0">, </span><span class="s3">i</span><span class="s0">);</span>
    <span class="s3">escapeSeq </span><span class="s2">= </span><span class="s3">ESCAPE_SEQUENCES</span><span class="s0">[</span><span class="s3">char</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">escapeSeq </span><span class="s2">&amp;&amp; </span><span class="s6">isPrintable</span><span class="s0">(</span><span class="s3">char</span><span class="s0">)) {</span>
      <span class="s3">result </span><span class="s2">+= </span><span class="s3">string</span><span class="s0">[</span><span class="s3">i</span><span class="s0">];</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">char </span><span class="s2">&gt;= </span><span class="s7">0x10000</span><span class="s0">) </span><span class="s3">result </span><span class="s2">+= </span><span class="s3">string</span><span class="s0">[</span><span class="s3">i </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">];</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">result </span><span class="s2">+= </span><span class="s3">escapeSeq </span><span class="s2">|| </span><span class="s6">encodeHex</span><span class="s0">(</span><span class="s3">char</span><span class="s0">);</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s3">result</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">writeFlowSequence(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">object</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">,</span>
      <span class="s0">_tag    </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">,</span>
      <span class="s0">index,</span>
      <span class="s0">length,</span>
      <span class="s0">value;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">value </span><span class="s2">= </span><span class="s3">object</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">) {</span>
      <span class="s3">value </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">, </span><span class="s6">String</span><span class="s0">(</span><span class="s3">index</span><span class="s0">), </span><span class="s3">value</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s1">// Write only valid elements, put null instead of invalid elements.</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">value</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">false</span><span class="s0">) </span><span class="s2">||</span>
        <span class="s0">(</span><span class="s2">typeof </span><span class="s3">value </span><span class="s2">=== </span><span class="s4">'undefined' </span><span class="s2">&amp;&amp;</span>
         <span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s5">null</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">false</span><span class="s0">))) {</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">_result </span><span class="s2">!== </span><span class="s4">''</span><span class="s0">) </span><span class="s3">_result </span><span class="s2">+= </span><span class="s4">',' </span><span class="s2">+ </span><span class="s0">(</span><span class="s2">!</span><span class="s3">state</span><span class="s0">.</span><span class="s3">condenseFlow </span><span class="s2">? </span><span class="s4">' ' </span><span class="s2">: </span><span class="s4">''</span><span class="s0">);</span>
      <span class="s3">_result </span><span class="s2">+= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s4">'[' </span><span class="s2">+ </span><span class="s3">_result </span><span class="s2">+ </span><span class="s4">']'</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">writeBlockSequence(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">object</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_result </span><span class="s2">= </span><span class="s4">''</span><span class="s0">,</span>
      <span class="s0">_tag    </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">,</span>
      <span class="s0">index,</span>
      <span class="s0">length,</span>
      <span class="s0">value;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">value </span><span class="s2">= </span><span class="s3">object</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">) {</span>
      <span class="s3">value </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">, </span><span class="s6">String</span><span class="s0">(</span><span class="s3">index</span><span class="s0">), </span><span class="s3">value</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s1">// Write only valid elements, put null instead of invalid elements.</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">, </span><span class="s3">value</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">true</span><span class="s0">) </span><span class="s2">||</span>
        <span class="s0">(</span><span class="s2">typeof </span><span class="s3">value </span><span class="s2">=== </span><span class="s4">'undefined' </span><span class="s2">&amp;&amp;</span>
         <span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">, </span><span class="s5">null</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">true</span><span class="s0">))) {</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">compact </span><span class="s2">|| </span><span class="s3">_result </span><span class="s2">!== </span><span class="s4">''</span><span class="s0">) {</span>
        <span class="s3">_result </span><span class="s2">+= </span><span class="s6">generateNextLine</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">);</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">&amp;&amp; </span><span class="s3">CHAR_LINE_FEED </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s7">0</span><span class="s0">)) {</span>
        <span class="s3">_result </span><span class="s2">+= </span><span class="s4">'-'</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">_result </span><span class="s2">+= </span><span class="s4">'- '</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s3">_result </span><span class="s2">+= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s3">_result </span><span class="s2">|| </span><span class="s4">'[]'</span><span class="s0">; </span><span class="s1">// Empty sequence if no valid values.</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">writeFlowMapping(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">object</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_result       </span><span class="s2">= </span><span class="s4">''</span><span class="s0">,</span>
      <span class="s0">_tag          </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">,</span>
      <span class="s0">objectKeyList </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">object</span><span class="s0">),</span>
      <span class="s0">index,</span>
      <span class="s0">length,</span>
      <span class="s0">objectKey,</span>
      <span class="s0">objectValue,</span>
      <span class="s0">pairBuffer;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">objectKeyList</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>

    <span class="s3">pairBuffer </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">_result </span><span class="s2">!== </span><span class="s4">''</span><span class="s0">) </span><span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s4">', '</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">condenseFlow</span><span class="s0">) </span><span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s4">'&quot;'</span><span class="s0">;</span>

    <span class="s3">objectKey </span><span class="s2">= </span><span class="s3">objectKeyList</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
    <span class="s3">objectValue </span><span class="s2">= </span><span class="s3">object</span><span class="s0">[</span><span class="s3">objectKey</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">) {</span>
      <span class="s3">objectValue </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">objectKey</span><span class="s0">, </span><span class="s3">objectValue</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">objectKey</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">false</span><span class="s0">)) {</span>
      <span class="s2">continue</span><span class="s0">; </span><span class="s1">// Skip this pair because of invalid key;</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">.length </span><span class="s2">&gt; </span><span class="s7">1024</span><span class="s0">) </span><span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s4">'? '</span><span class="s0">;</span>

    <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">+ </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">condenseFlow </span><span class="s2">? </span><span class="s4">'&quot;' </span><span class="s2">: </span><span class="s4">''</span><span class="s0">) </span><span class="s2">+ </span><span class="s4">':' </span><span class="s2">+ </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">condenseFlow </span><span class="s2">? </span><span class="s4">'' </span><span class="s2">: </span><span class="s4">' '</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">objectValue</span><span class="s0">, </span><span class="s5">false</span><span class="s0">, </span><span class="s5">false</span><span class="s0">)) {</span>
      <span class="s2">continue</span><span class="s0">; </span><span class="s1">// Skip this pair because of invalid value.</span>
    <span class="s0">}</span>

    <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>

    <span class="s1">// Both key and value are valid.</span>
    <span class="s3">_result </span><span class="s2">+= </span><span class="s3">pairBuffer</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s4">'{' </span><span class="s2">+ </span><span class="s3">_result </span><span class="s2">+ </span><span class="s4">'}'</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">writeBlockMapping(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">object</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_result       </span><span class="s2">= </span><span class="s4">''</span><span class="s0">,</span>
      <span class="s0">_tag          </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">,</span>
      <span class="s0">objectKeyList </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">object</span><span class="s0">),</span>
      <span class="s0">index,</span>
      <span class="s0">length,</span>
      <span class="s0">objectKey,</span>
      <span class="s0">objectValue,</span>
      <span class="s0">explicitPair,</span>
      <span class="s0">pairBuffer;</span>

  <span class="s1">// Allow sorting keys so that the output file is deterministic</span>
  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">sortKeys </span><span class="s2">=== </span><span class="s5">true</span><span class="s0">) {</span>
    <span class="s1">// Default sorting</span>
    <span class="s3">objectKeyList</span><span class="s0">.</span><span class="s6">sort</span><span class="s0">();</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s2">typeof </span><span class="s3">state</span><span class="s0">.</span><span class="s3">sortKeys </span><span class="s2">=== </span><span class="s4">'function'</span><span class="s0">) {</span>
    <span class="s1">// Custom sort function</span>
    <span class="s3">objectKeyList</span><span class="s0">.</span><span class="s6">sort</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">sortKeys</span><span class="s0">);</span>
  <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">sortKeys</span><span class="s0">) {</span>
    <span class="s1">// Something is wrong</span>
    <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'sortKeys must be a boolean or a function'</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">objectKeyList</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">pairBuffer </span><span class="s2">= </span><span class="s4">''</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">compact </span><span class="s2">|| </span><span class="s3">_result </span><span class="s2">!== </span><span class="s4">''</span><span class="s0">) {</span>
      <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s6">generateNextLine</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s3">objectKey </span><span class="s2">= </span><span class="s3">objectKeyList</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>
    <span class="s3">objectValue </span><span class="s2">= </span><span class="s3">object</span><span class="s0">[</span><span class="s3">objectKey</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">) {</span>
      <span class="s3">objectValue </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">objectKey</span><span class="s0">, </span><span class="s3">objectValue</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">, </span><span class="s3">objectKey</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s5">true</span><span class="s0">)) {</span>
      <span class="s2">continue</span><span class="s0">; </span><span class="s1">// Skip this pair because of invalid key.</span>
    <span class="s0">}</span>

    <span class="s3">explicitPair </span><span class="s2">= </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s4">'?'</span><span class="s0">) </span><span class="s2">||</span>
                   <span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">.length </span><span class="s2">&gt; </span><span class="s7">1024</span><span class="s0">);</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">explicitPair</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">&amp;&amp; </span><span class="s3">CHAR_LINE_FEED </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s7">0</span><span class="s0">)) {</span>
        <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s4">'?'</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s4">'? '</span><span class="s0">;</span>
      <span class="s0">}</span>
    <span class="s0">}</span>

    <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">explicitPair</span><span class="s0">) {</span>
      <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s6">generateNextLine</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level </span><span class="s2">+ </span><span class="s7">1</span><span class="s0">, </span><span class="s3">objectValue</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s3">explicitPair</span><span class="s0">)) {</span>
      <span class="s2">continue</span><span class="s0">; </span><span class="s1">// Skip this pair because of invalid value.</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">&amp;&amp; </span><span class="s3">CHAR_LINE_FEED </span><span class="s2">=== </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">.</span><span class="s6">charCodeAt</span><span class="s0">(</span><span class="s7">0</span><span class="s0">)) {</span>
      <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s4">':'</span><span class="s0">;</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s4">': '</span><span class="s0">;</span>
    <span class="s0">}</span>

    <span class="s3">pairBuffer </span><span class="s2">+= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>

    <span class="s1">// Both key and value are valid.</span>
    <span class="s3">_result </span><span class="s2">+= </span><span class="s3">pairBuffer</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">_tag</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s3">_result </span><span class="s2">|| </span><span class="s4">'{}'</span><span class="s0">; </span><span class="s1">// Empty mapping if no valid pairs.</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">detectType(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">object</span><span class="s0">, </span><span class="s3">explicit</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">_result, typeList, index, length, type, style;</span>

  <span class="s3">typeList </span><span class="s2">= </span><span class="s3">explicit </span><span class="s2">? </span><span class="s3">state</span><span class="s0">.</span><span class="s3">explicitTypes </span><span class="s2">: </span><span class="s3">state</span><span class="s0">.</span><span class="s3">implicitTypes</span><span class="s0">;</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">typeList</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">type </span><span class="s2">= </span><span class="s3">typeList</span><span class="s0">[</span><span class="s3">index</span><span class="s0">];</span>

    <span class="s2">if </span><span class="s0">((</span><span class="s3">type</span><span class="s0">.</span><span class="s3">instanceOf  </span><span class="s2">|| </span><span class="s3">type</span><span class="s0">.</span><span class="s3">predicate</span><span class="s0">) </span><span class="s2">&amp;&amp;</span>
        <span class="s0">(</span><span class="s2">!</span><span class="s3">type</span><span class="s0">.</span><span class="s3">instanceOf </span><span class="s2">|| </span><span class="s0">((</span><span class="s2">typeof </span><span class="s3">object </span><span class="s2">=== </span><span class="s4">'object'</span><span class="s0">) </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">object </span><span class="s2">instanceof </span><span class="s3">type</span><span class="s0">.</span><span class="s3">instanceOf</span><span class="s0">))) </span><span class="s2">&amp;&amp;</span>
        <span class="s0">(</span><span class="s2">!</span><span class="s3">type</span><span class="s0">.</span><span class="s3">predicate  </span><span class="s2">|| </span><span class="s3">type</span><span class="s0">.</span><span class="s6">predicate</span><span class="s0">(</span><span class="s3">object</span><span class="s0">))) {</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">explicit</span><span class="s0">) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s3">multi </span><span class="s2">&amp;&amp; </span><span class="s3">type</span><span class="s0">.</span><span class="s3">representName</span><span class="s0">) {</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s6">representName</span><span class="s0">(</span><span class="s3">object</span><span class="s0">);</span>
        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s4">'?'</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s3">represent</span><span class="s0">) {</span>
        <span class="s3">style </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">styleMap</span><span class="s0">[</span><span class="s3">type</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">] </span><span class="s2">|| </span><span class="s3">type</span><span class="s0">.</span><span class="s3">defaultStyle</span><span class="s0">;</span>

        <span class="s2">if </span><span class="s0">(</span><span class="s3">_toString</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s3">represent</span><span class="s0">) </span><span class="s2">=== </span><span class="s4">'[object Function]'</span><span class="s0">) {</span>
          <span class="s3">_result </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s6">represent</span><span class="s0">(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">style</span><span class="s0">);</span>
        <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">_hasOwnProperty</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">type</span><span class="s0">.</span><span class="s3">represent</span><span class="s0">, </span><span class="s3">style</span><span class="s0">)) {</span>
          <span class="s3">_result </span><span class="s2">= </span><span class="s3">type</span><span class="s0">.</span><span class="s3">represent</span><span class="s0">[</span><span class="s3">style</span><span class="s0">](</span><span class="s3">object</span><span class="s0">, </span><span class="s3">style</span><span class="s0">);</span>
        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
          <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'!&lt;' </span><span class="s2">+ </span><span class="s3">type</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">+ </span><span class="s4">'&gt; tag resolver accepts not &quot;' </span><span class="s2">+ </span><span class="s3">style </span><span class="s2">+ </span><span class="s4">'&quot; style'</span><span class="s0">);</span>
        <span class="s0">}</span>

        <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s3">_result</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s1">// Serializes `object` and writes it to global `result`.</span>
<span class="s1">// Returns true on success, or false on invalid object.</span>
<span class="s1">//</span>
<span class="s2">function </span><span class="s0">writeNode(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">object</span><span class="s0">, </span><span class="s3">block</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">, </span><span class="s3">iskey</span><span class="s0">, </span><span class="s3">isblockseq</span><span class="s0">) {</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">= </span><span class="s5">null</span><span class="s0">;</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s3">object</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s6">detectType</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">object</span><span class="s0">, </span><span class="s5">false</span><span class="s0">)) {</span>
    <span class="s6">detectType</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">object</span><span class="s0">, </span><span class="s5">true</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">var </span><span class="s0">type </span><span class="s2">= </span><span class="s3">_toString</span><span class="s0">.</span><span class="s6">call</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">);</span>
  <span class="s2">var </span><span class="s0">inblock </span><span class="s2">= </span><span class="s3">block</span><span class="s0">;</span>
  <span class="s2">var </span><span class="s0">tagStr;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">block</span><span class="s0">) {</span>
    <span class="s3">block </span><span class="s2">= </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">flowLevel </span><span class="s2">&lt; </span><span class="s7">0 </span><span class="s2">|| </span><span class="s3">state</span><span class="s0">.</span><span class="s3">flowLevel </span><span class="s2">&gt; </span><span class="s3">level</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">var </span><span class="s0">objectOrArray </span><span class="s2">= </span><span class="s3">type </span><span class="s2">=== </span><span class="s4">'[object Object]' </span><span class="s2">|| </span><span class="s3">type </span><span class="s2">=== </span><span class="s4">'[object Array]'</span><span class="s0">,</span>
      <span class="s0">duplicateIndex,</span>
      <span class="s0">duplicate;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">objectOrArray</span><span class="s0">) {</span>
    <span class="s3">duplicateIndex </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">duplicates</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">object</span><span class="s0">);</span>
    <span class="s3">duplicate </span><span class="s2">= </span><span class="s3">duplicateIndex </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">((</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s4">'?'</span><span class="s0">) </span><span class="s2">|| </span><span class="s3">duplicate </span><span class="s2">|| </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">indent </span><span class="s2">!== </span><span class="s7">2 </span><span class="s2">&amp;&amp; </span><span class="s3">level </span><span class="s2">&gt; </span><span class="s7">0</span><span class="s0">)) {</span>
    <span class="s3">compact </span><span class="s2">= </span><span class="s5">false</span><span class="s0">;</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">duplicate </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">usedDuplicates</span><span class="s0">[</span><span class="s3">duplicateIndex</span><span class="s0">]) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s4">'*ref_' </span><span class="s2">+ </span><span class="s3">duplicateIndex</span><span class="s0">;</span>
  <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">objectOrArray </span><span class="s2">&amp;&amp; </span><span class="s3">duplicate </span><span class="s2">&amp;&amp; !</span><span class="s3">state</span><span class="s0">.</span><span class="s3">usedDuplicates</span><span class="s0">[</span><span class="s3">duplicateIndex</span><span class="s0">]) {</span>
      <span class="s3">state</span><span class="s0">.</span><span class="s3">usedDuplicates</span><span class="s0">[</span><span class="s3">duplicateIndex</span><span class="s0">] </span><span class="s2">= </span><span class="s5">true</span><span class="s0">;</span>
    <span class="s0">}</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">type </span><span class="s2">=== </span><span class="s4">'[object Object]'</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">block </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">).length </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">)) {</span>
        <span class="s6">writeBlockMapping</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">);</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">duplicate</span><span class="s0">) {</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s4">'&amp;ref_' </span><span class="s2">+ </span><span class="s3">duplicateIndex </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s6">writeFlowMapping</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">);</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">duplicate</span><span class="s0">) {</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s4">'&amp;ref_' </span><span class="s2">+ </span><span class="s3">duplicateIndex </span><span class="s2">+ </span><span class="s4">' ' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">type </span><span class="s2">=== </span><span class="s4">'[object Array]'</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">block </span><span class="s2">&amp;&amp; </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">.length </span><span class="s2">!== </span><span class="s7">0</span><span class="s0">)) {</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">noArrayIndent </span><span class="s2">&amp;&amp; !</span><span class="s3">isblockseq </span><span class="s2">&amp;&amp; </span><span class="s3">level </span><span class="s2">&gt; </span><span class="s7">0</span><span class="s0">) {</span>
          <span class="s6">writeBlockSequence</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level </span><span class="s2">- </span><span class="s7">1</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">);</span>
        <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
          <span class="s6">writeBlockSequence</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">, </span><span class="s3">compact</span><span class="s0">);</span>
        <span class="s0">}</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">duplicate</span><span class="s0">) {</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s4">'&amp;ref_' </span><span class="s2">+ </span><span class="s3">duplicateIndex </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s6">writeFlowSequence</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">);</span>
        <span class="s2">if </span><span class="s0">(</span><span class="s3">duplicate</span><span class="s0">) {</span>
          <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s4">'&amp;ref_' </span><span class="s2">+ </span><span class="s3">duplicateIndex </span><span class="s2">+ </span><span class="s4">' ' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
        <span class="s0">}</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">type </span><span class="s2">=== </span><span class="s4">'[object String]'</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s4">'?'</span><span class="s0">) {</span>
        <span class="s6">writeScalar</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">, </span><span class="s3">level</span><span class="s0">, </span><span class="s3">iskey</span><span class="s0">, </span><span class="s3">inblock</span><span class="s0">);</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">type </span><span class="s2">=== </span><span class="s4">'[object Undefined]'</span><span class="s0">) {</span>
      <span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">skipInvalid</span><span class="s0">) </span><span class="s2">return </span><span class="s5">false</span><span class="s0">;</span>
      <span class="s2">throw new </span><span class="s6">exception</span><span class="s0">(</span><span class="s4">'unacceptable kind of an object to dump ' </span><span class="s2">+ </span><span class="s3">type</span><span class="s0">);</span>
    <span class="s0">}</span>

    <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">&amp;&amp; </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag </span><span class="s2">!== </span><span class="s4">'?'</span><span class="s0">) {</span>
      <span class="s1">// Need to encode all characters except those allowed by the spec:</span>
      <span class="s1">//</span>
      <span class="s1">// [35] ns-dec-digit    ::=  [#x30-#x39] /* 0-9 */</span>
      <span class="s1">// [36] ns-hex-digit    ::=  ns-dec-digit</span>
      <span class="s1">//                         | [#x41-#x46] /* A-F */ | [#x61-#x66] /* a-f */</span>
      <span class="s1">// [37] ns-ascii-letter ::=  [#x41-#x5A] /* A-Z */ | [#x61-#x7A] /* a-z */</span>
      <span class="s1">// [38] ns-word-char    ::=  ns-dec-digit | ns-ascii-letter | “-”</span>
      <span class="s1">// [39] ns-uri-char     ::=  “%” ns-hex-digit ns-hex-digit | ns-word-char | “#”</span>
      <span class="s1">//                         | “;” | “/” | “?” | “:” | “@” | “&amp;” | “=” | “+” | “$” | “,”</span>
      <span class="s1">//                         | “_” | “.” | “!” | “~” | “*” | “'” | “(” | “)” | “[” | “]”</span>
      <span class="s1">//</span>
      <span class="s1">// Also need to encode '!' because it has special meaning (end of tag prefix).</span>
      <span class="s1">//</span>
      <span class="s3">tagStr </span><span class="s2">= </span><span class="s6">encodeURI</span><span class="s0">(</span>
        <span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">[</span><span class="s7">0</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'!' </span><span class="s2">? </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">1</span><span class="s0">) </span><span class="s2">: </span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span>
      <span class="s0">).</span><span class="s6">replace</span><span class="s0">(</span><span class="s4">/!/</span><span class="s2">g</span><span class="s0">, </span><span class="s4">'%21'</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">tag</span><span class="s0">[</span><span class="s7">0</span><span class="s0">] </span><span class="s2">=== </span><span class="s4">'!'</span><span class="s0">) {</span>
        <span class="s3">tagStr </span><span class="s2">= </span><span class="s4">'!' </span><span class="s2">+ </span><span class="s3">tagStr</span><span class="s0">;</span>
      <span class="s0">} </span><span class="s2">else if </span><span class="s0">(</span><span class="s3">tagStr</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">0</span><span class="s0">, </span><span class="s7">18</span><span class="s0">) </span><span class="s2">=== </span><span class="s4">'tag:yaml.org,2002:'</span><span class="s0">) {</span>
        <span class="s3">tagStr </span><span class="s2">= </span><span class="s4">'!!' </span><span class="s2">+ </span><span class="s3">tagStr</span><span class="s0">.</span><span class="s6">slice</span><span class="s0">(</span><span class="s7">18</span><span class="s0">);</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">tagStr </span><span class="s2">= </span><span class="s4">'!&lt;' </span><span class="s2">+ </span><span class="s3">tagStr </span><span class="s2">+ </span><span class="s4">'&gt;'</span><span class="s0">;</span>
      <span class="s0">}</span>

      <span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">= </span><span class="s3">tagStr </span><span class="s2">+ </span><span class="s4">' ' </span><span class="s2">+ </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
    <span class="s0">}</span>
  <span class="s0">}</span>

  <span class="s2">return </span><span class="s5">true</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">getDuplicateReferences(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">state</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">objects </span><span class="s2">= </span><span class="s0">[],</span>
      <span class="s0">duplicatesIndexes </span><span class="s2">= </span><span class="s0">[],</span>
      <span class="s0">index,</span>
      <span class="s0">length;</span>

  <span class="s6">inspectNode</span><span class="s0">(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">objects</span><span class="s0">, </span><span class="s3">duplicatesIndexes</span><span class="s0">);</span>

  <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">duplicatesIndexes</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
    <span class="s3">state</span><span class="s0">.</span><span class="s3">duplicates</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">objects</span><span class="s0">[</span><span class="s3">duplicatesIndexes</span><span class="s0">[</span><span class="s3">index</span><span class="s0">]]);</span>
  <span class="s0">}</span>
  <span class="s3">state</span><span class="s0">.</span><span class="s3">usedDuplicates </span><span class="s2">= new </span><span class="s6">Array</span><span class="s0">(</span><span class="s3">length</span><span class="s0">);</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">inspectNode(</span><span class="s3">object</span><span class="s0">, </span><span class="s3">objects</span><span class="s0">, </span><span class="s3">duplicatesIndexes</span><span class="s0">) {</span>
  <span class="s2">var </span><span class="s0">objectKeyList,</span>
      <span class="s0">index,</span>
      <span class="s0">length;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">object </span><span class="s2">!== </span><span class="s5">null </span><span class="s2">&amp;&amp; typeof </span><span class="s3">object </span><span class="s2">=== </span><span class="s4">'object'</span><span class="s0">) {</span>
    <span class="s3">index </span><span class="s2">= </span><span class="s3">objects</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">object</span><span class="s0">);</span>
    <span class="s2">if </span><span class="s0">(</span><span class="s3">index </span><span class="s2">!== -</span><span class="s7">1</span><span class="s0">) {</span>
      <span class="s2">if </span><span class="s0">(</span><span class="s3">duplicatesIndexes</span><span class="s0">.</span><span class="s6">indexOf</span><span class="s0">(</span><span class="s3">index</span><span class="s0">) </span><span class="s2">=== -</span><span class="s7">1</span><span class="s0">) {</span>
        <span class="s3">duplicatesIndexes</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">index</span><span class="s0">);</span>
      <span class="s0">}</span>
    <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
      <span class="s3">objects</span><span class="s0">.</span><span class="s6">push</span><span class="s0">(</span><span class="s3">object</span><span class="s0">);</span>

      <span class="s2">if </span><span class="s0">(</span><span class="s3">Array</span><span class="s0">.</span><span class="s6">isArray</span><span class="s0">(</span><span class="s3">object</span><span class="s0">)) {</span>
        <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">object</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
          <span class="s6">inspectNode</span><span class="s0">(</span><span class="s3">object</span><span class="s0">[</span><span class="s3">index</span><span class="s0">], </span><span class="s3">objects</span><span class="s0">, </span><span class="s3">duplicatesIndexes</span><span class="s0">);</span>
        <span class="s0">}</span>
      <span class="s0">} </span><span class="s2">else </span><span class="s0">{</span>
        <span class="s3">objectKeyList </span><span class="s2">= </span><span class="s3">Object</span><span class="s0">.</span><span class="s6">keys</span><span class="s0">(</span><span class="s3">object</span><span class="s0">);</span>

        <span class="s2">for </span><span class="s0">(</span><span class="s3">index </span><span class="s2">= </span><span class="s7">0</span><span class="s0">, </span><span class="s3">length </span><span class="s2">= </span><span class="s3">objectKeyList</span><span class="s0">.length; </span><span class="s3">index </span><span class="s2">&lt; </span><span class="s3">length</span><span class="s0">; </span><span class="s3">index </span><span class="s2">+= </span><span class="s7">1</span><span class="s0">) {</span>
          <span class="s6">inspectNode</span><span class="s0">(</span><span class="s3">object</span><span class="s0">[</span><span class="s3">objectKeyList</span><span class="s0">[</span><span class="s3">index</span><span class="s0">]], </span><span class="s3">objects</span><span class="s0">, </span><span class="s3">duplicatesIndexes</span><span class="s0">);</span>
        <span class="s0">}</span>
      <span class="s0">}</span>
    <span class="s0">}</span>
  <span class="s0">}</span>
<span class="s0">}</span>

<span class="s2">function </span><span class="s0">dump$1(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">options</span><span class="s0">) {</span>
  <span class="s3">options </span><span class="s2">= </span><span class="s3">options </span><span class="s2">|| </span><span class="s0">{};</span>

  <span class="s2">var </span><span class="s0">state </span><span class="s2">= new </span><span class="s6">State</span><span class="s0">(</span><span class="s3">options</span><span class="s0">);</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s2">!</span><span class="s3">state</span><span class="s0">.</span><span class="s3">noRefs</span><span class="s0">) </span><span class="s6">getDuplicateReferences</span><span class="s0">(</span><span class="s3">input</span><span class="s0">, </span><span class="s3">state</span><span class="s0">);</span>

  <span class="s2">var </span><span class="s0">value </span><span class="s2">= </span><span class="s3">input</span><span class="s0">;</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">) {</span>
    <span class="s3">value </span><span class="s2">= </span><span class="s3">state</span><span class="s0">.</span><span class="s3">replacer</span><span class="s0">.</span><span class="s6">call</span><span class="s0">({ </span><span class="s4">''</span><span class="s0">: </span><span class="s3">value </span><span class="s0">}, </span><span class="s4">''</span><span class="s0">, </span><span class="s3">value</span><span class="s0">);</span>
  <span class="s0">}</span>

  <span class="s2">if </span><span class="s0">(</span><span class="s6">writeNode</span><span class="s0">(</span><span class="s3">state</span><span class="s0">, </span><span class="s7">0</span><span class="s0">, </span><span class="s3">value</span><span class="s0">, </span><span class="s5">true</span><span class="s0">, </span><span class="s5">true</span><span class="s0">)) </span><span class="s2">return </span><span class="s3">state</span><span class="s0">.</span><span class="s3">dump </span><span class="s2">+ </span><span class="s4">'</span><span class="s8">\n</span><span class="s4">'</span><span class="s0">;</span>

  <span class="s2">return </span><span class="s4">''</span><span class="s0">;</span>
<span class="s0">}</span>

<span class="s2">var </span><span class="s0">dump_1 </span><span class="s2">= </span><span class="s3">dump$1</span><span class="s0">;</span>

<span class="s2">var </span><span class="s0">dumper </span><span class="s2">= </span><span class="s0">{</span>
	<span class="s0">dump: </span><span class="s3">dump_1</span>
<span class="s0">};</span>

<span class="s2">function </span><span class="s0">renamed(</span><span class="s3">from</span><span class="s0">, </span><span class="s3">to</span><span class="s0">) {</span>
  <span class="s2">return function </span><span class="s0">() {</span>
    <span class="s2">throw new </span><span class="s6">Error</span><span class="s0">(</span><span class="s4">'Function yaml.' </span><span class="s2">+ </span><span class="s3">from </span><span class="s2">+ </span><span class="s4">' is removed in js-yaml 4. ' </span><span class="s2">+</span>
      <span class="s4">'Use yaml.' </span><span class="s2">+ </span><span class="s3">to </span><span class="s2">+ </span><span class="s4">' instead, which is now safe by default.'</span><span class="s0">);</span>
  <span class="s0">};</span>
<span class="s0">}</span>


<span class="s2">var </span><span class="s0">Type                </span><span class="s2">= </span><span class="s3">type</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">Schema              </span><span class="s2">= </span><span class="s3">schema</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">FAILSAFE_SCHEMA     </span><span class="s2">= </span><span class="s3">failsafe</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">JSON_SCHEMA         </span><span class="s2">= </span><span class="s3">json</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">CORE_SCHEMA         </span><span class="s2">= </span><span class="s3">core</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">DEFAULT_SCHEMA      </span><span class="s2">= </span><span class="s3">_default</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">load                </span><span class="s2">= </span><span class="s3">loader</span><span class="s0">.</span><span class="s3">load</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">loadAll             </span><span class="s2">= </span><span class="s3">loader</span><span class="s0">.</span><span class="s3">loadAll</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">dump                </span><span class="s2">= </span><span class="s3">dumper</span><span class="s0">.</span><span class="s3">dump</span><span class="s0">;</span>
<span class="s2">var </span><span class="s0">YAMLException       </span><span class="s2">= </span><span class="s3">exception</span><span class="s0">;</span>

<span class="s1">// Re-export all types in case user wants to create custom schema</span>
<span class="s2">var </span><span class="s0">types </span><span class="s2">= </span><span class="s0">{</span>
  <span class="s0">binary:    </span><span class="s3">binary</span><span class="s0">,</span>
  <span class="s0">float:     </span><span class="s3">float</span><span class="s0">,</span>
  <span class="s0">map:       </span><span class="s3">map</span><span class="s0">,</span>
  <span class="s0">null:      </span><span class="s3">_null</span><span class="s0">,</span>
  <span class="s0">pairs:     </span><span class="s3">pairs</span><span class="s0">,</span>
  <span class="s0">set:       </span><span class="s3">set</span><span class="s0">,</span>
  <span class="s0">timestamp: </span><span class="s3">timestamp</span><span class="s0">,</span>
  <span class="s0">bool:      </span><span class="s3">bool</span><span class="s0">,</span>
  <span class="s0">int:       </span><span class="s3">int</span><span class="s0">,</span>
  <span class="s0">merge:     </span><span class="s3">merge</span><span class="s0">,</span>
  <span class="s0">omap:      </span><span class="s3">omap</span><span class="s0">,</span>
  <span class="s0">seq:       </span><span class="s3">seq</span><span class="s0">,</span>
  <span class="s0">str:       </span><span class="s3">str</span>
<span class="s0">};</span>

<span class="s1">// Removed functions from JS-YAML 3.0.x</span>
<span class="s2">var </span><span class="s0">safeLoad            </span><span class="s2">= </span><span class="s6">renamed</span><span class="s0">(</span><span class="s4">'safeLoad'</span><span class="s0">, </span><span class="s4">'load'</span><span class="s0">);</span>
<span class="s2">var </span><span class="s0">safeLoadAll         </span><span class="s2">= </span><span class="s6">renamed</span><span class="s0">(</span><span class="s4">'safeLoadAll'</span><span class="s0">, </span><span class="s4">'loadAll'</span><span class="s0">);</span>
<span class="s2">var </span><span class="s0">safeDump            </span><span class="s2">= </span><span class="s6">renamed</span><span class="s0">(</span><span class="s4">'safeDump'</span><span class="s0">, </span><span class="s4">'dump'</span><span class="s0">);</span>

<span class="s2">var </span><span class="s0">jsYaml </span><span class="s2">= </span><span class="s0">{</span>
	<span class="s0">Type: </span><span class="s3">Type</span><span class="s0">,</span>
	<span class="s0">Schema: </span><span class="s3">Schema</span><span class="s0">,</span>
	<span class="s0">FAILSAFE_SCHEMA: </span><span class="s3">FAILSAFE_SCHEMA</span><span class="s0">,</span>
	<span class="s0">JSON_SCHEMA: </span><span class="s3">JSON_SCHEMA</span><span class="s0">,</span>
	<span class="s0">CORE_SCHEMA: </span><span class="s3">CORE_SCHEMA</span><span class="s0">,</span>
	<span class="s0">DEFAULT_SCHEMA: </span><span class="s3">DEFAULT_SCHEMA</span><span class="s0">,</span>
	<span class="s0">load: </span><span class="s3">load</span><span class="s0">,</span>
	<span class="s0">loadAll: </span><span class="s3">loadAll</span><span class="s0">,</span>
	<span class="s0">dump: </span><span class="s3">dump</span><span class="s0">,</span>
	<span class="s0">YAMLException: </span><span class="s3">YAMLException</span><span class="s0">,</span>
	<span class="s0">types: </span><span class="s3">types</span><span class="s0">,</span>
	<span class="s0">safeLoad: </span><span class="s3">safeLoad</span><span class="s0">,</span>
	<span class="s0">safeLoadAll: </span><span class="s3">safeLoadAll</span><span class="s0">,</span>
	<span class="s0">safeDump: </span><span class="s3">safeDump</span>
<span class="s0">};</span>

<span class="s2">export default </span><span class="s3">jsYaml</span><span class="s0">;</span>
<span class="s2">export </span><span class="s0">{ </span><span class="s3">CORE_SCHEMA</span><span class="s0">, </span><span class="s3">DEFAULT_SCHEMA</span><span class="s0">, </span><span class="s3">FAILSAFE_SCHEMA</span><span class="s0">, </span><span class="s3">JSON_SCHEMA</span><span class="s0">, </span><span class="s3">Schema</span><span class="s0">, </span><span class="s3">Type</span><span class="s0">, </span><span class="s3">YAMLException</span><span class="s0">, </span><span class="s3">dump</span><span class="s0">, </span><span class="s3">load</span><span class="s0">, </span><span class="s3">loadAll</span><span class="s0">, </span><span class="s3">safeDump</span><span class="s0">, </span><span class="s3">safeLoad</span><span class="s0">, </span><span class="s3">safeLoadAll</span><span class="s0">, </span><span class="s3">types </span><span class="s0">};</span>
</pre>
</body>
</html>