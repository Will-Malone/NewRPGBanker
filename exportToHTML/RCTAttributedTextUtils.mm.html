<html>
<head>
<title>RCTAttributedTextUtils.mm</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
RCTAttributedTextUtils.mm</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#import </span><span class="s3">&quot;RCTAttributedTextUtils.h&quot;</span>

<span class="s2">#include </span><span class="s3">&lt;react/renderer/core/LayoutableShadowNode.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/renderer/textlayoutmanager/RCTFontProperties.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/renderer/textlayoutmanager/RCTFontUtils.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/renderer/textlayoutmanager/RCTTextPrimitivesConversions.h&gt;</span>
<span class="s2">#include </span><span class="s3">&lt;react/utils/ManagedObjectWrapper.h&gt;</span>

<span class="s4">using namespace </span><span class="s1">facebook::react</span><span class="s4">;</span>

<span class="s4">@implementation </span><span class="s1">RCTWeakEventEmitterWrapper {</span>
  <span class="s1">std::weak_ptr&lt;</span><span class="s4">const </span><span class="s1">EventEmitter&gt; _weakEventEmitter</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setEventEmitter:(SharedEventEmitter)eventEmitter</span>
<span class="s1">{</span>
  <span class="s1">_weakEventEmitter = eventEmitter</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (SharedEventEmitter)eventEmitter</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">_weakEventEmitter.lock()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)dealloc</span>
<span class="s1">{</span>
  <span class="s1">_weakEventEmitter.reset()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s4">inline static </span><span class="s1">UIFontWeight RCTUIFontWeightFromInteger(NSInteger fontWeight)</span>
<span class="s1">{</span>
  <span class="s1">assert(fontWeight &gt; </span><span class="s5">50</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">assert(fontWeight &lt; </span><span class="s5">950</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">static </span><span class="s1">UIFontWeight weights[] = {</span>
      <span class="s0">/* ~100 */ </span><span class="s1">UIFontWeightUltraLight</span><span class="s4">,</span>
      <span class="s0">/* ~200 */ </span><span class="s1">UIFontWeightThin</span><span class="s4">,</span>
      <span class="s0">/* ~300 */ </span><span class="s1">UIFontWeightLight</span><span class="s4">,</span>
      <span class="s0">/* ~400 */ </span><span class="s1">UIFontWeightRegular</span><span class="s4">,</span>
      <span class="s0">/* ~500 */ </span><span class="s1">UIFontWeightMedium</span><span class="s4">,</span>
      <span class="s0">/* ~600 */ </span><span class="s1">UIFontWeightSemibold</span><span class="s4">,</span>
      <span class="s0">/* ~700 */ </span><span class="s1">UIFontWeightBold</span><span class="s4">,</span>
      <span class="s0">/* ~800 */ </span><span class="s1">UIFontWeightHeavy</span><span class="s4">,</span>
      <span class="s0">/* ~900 */ </span><span class="s1">UIFontWeightBlack}</span><span class="s4">;</span>
  <span class="s0">// The expression is designed to convert something like 760 or 830 to 7.</span>
  <span class="s4">return </span><span class="s1">weights[(fontWeight + </span><span class="s5">50</span><span class="s1">) / </span><span class="s5">100 </span><span class="s1">- </span><span class="s5">1</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">inline static </span><span class="s1">UIFontTextStyle RCTUIFontTextStyleForDynamicTypeRamp(</span><span class="s4">const </span><span class="s1">DynamicTypeRamp &amp;dynamicTypeRamp)</span>
<span class="s1">{</span>
  <span class="s4">switch </span><span class="s1">(dynamicTypeRamp) {</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Caption2:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleCaption2</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Caption1:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleCaption1</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Footnote:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleFootnote</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Subheadline:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleSubheadline</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Callout:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleCallout</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Body:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleBody</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Headline:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleHeadline</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Title3:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleTitle3</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Title2:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleTitle2</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Title1:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleTitle1</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::LargeTitle:</span>
      <span class="s4">return </span><span class="s1">UIFontTextStyleLargeTitle</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">inline static </span><span class="s1">CGFloat RCTBaseSizeForDynamicTypeRamp(</span><span class="s4">const </span><span class="s1">DynamicTypeRamp &amp;dynamicTypeRamp)</span>
<span class="s1">{</span>
  <span class="s0">// Values taken from</span>
  <span class="s0">// https://developer.apple.com/design/human-interface-guidelines/foundations/typography/#specifications</span>
  <span class="s4">switch </span><span class="s1">(dynamicTypeRamp) {</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Caption2:</span>
      <span class="s4">return </span><span class="s5">11.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">DynamicTypeRamp::Caption1:</span>
      <span class="s4">return </span><span class="s5">12.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Footnote:</span>
      <span class="s4">return </span><span class="s5">13.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Subheadline:</span>
      <span class="s4">return </span><span class="s5">15.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Callout:</span>
      <span class="s4">return </span><span class="s5">16.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Body:</span>
      <span class="s4">return </span><span class="s5">17.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Headline:</span>
      <span class="s4">return </span><span class="s5">17.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Title3:</span>
      <span class="s4">return </span><span class="s5">20.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Title2:</span>
      <span class="s4">return </span><span class="s5">22.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::Title1:</span>
      <span class="s4">return </span><span class="s5">28.0</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">facebook::react::DynamicTypeRamp::LargeTitle:</span>
      <span class="s4">return </span><span class="s5">34.0</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">inline static </span><span class="s1">CGFloat RCTEffectiveFontSizeMultiplierFromTextAttributes(</span><span class="s4">const </span><span class="s1">TextAttributes &amp;textAttributes)</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(textAttributes.allowFontScaling.value_or(</span><span class="s4">true</span><span class="s1">)) {</span>
    <span class="s4">if </span><span class="s1">(textAttributes.dynamicTypeRamp.has_value()) {</span>
      <span class="s1">DynamicTypeRamp dynamicTypeRamp = textAttributes.dynamicTypeRamp.value()</span><span class="s4">;</span>
      <span class="s1">UIFontMetrics *fontMetrics =</span>
          <span class="s1">[UIFontMetrics metricsForTextStyle:RCTUIFontTextStyleForDynamicTypeRamp(dynamicTypeRamp)]</span><span class="s4">;</span>
      <span class="s0">// Using a specific font size reduces rounding errors from -scaledValueForValue:</span>
      <span class="s1">CGFloat requestedSize =</span>
          <span class="s1">isnan(textAttributes.fontSize) ? RCTBaseSizeForDynamicTypeRamp(dynamicTypeRamp) : textAttributes.fontSize</span><span class="s4">;</span>
      <span class="s4">return </span><span class="s1">[fontMetrics scaledValueForValue:requestedSize] / requestedSize</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s4">return </span><span class="s1">textAttributes.fontSizeMultiplier</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s4">return </span><span class="s5">1.0</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s4">inline static </span><span class="s1">UIFont *RCTEffectiveFontFromTextAttributes(</span><span class="s4">const </span><span class="s1">TextAttributes &amp;textAttributes)</span>
<span class="s1">{</span>
  <span class="s1">NSString *fontFamily = [NSString stringWithCString:textAttributes.fontFamily.c_str() encoding:NSUTF8StringEncoding]</span><span class="s4">;</span>

  <span class="s1">RCTFontProperties fontProperties</span><span class="s4">;</span>
  <span class="s1">fontProperties.family = fontFamily</span><span class="s4">;</span>
  <span class="s1">fontProperties.size = textAttributes.fontSize</span><span class="s4">;</span>
  <span class="s1">fontProperties.style = textAttributes.fontStyle.has_value()</span>
      <span class="s1">? RCTFontStyleFromFontStyle(textAttributes.fontStyle.value())</span>
      <span class="s1">: RCTFontStyleUndefined</span><span class="s4">;</span>
  <span class="s1">fontProperties.variant = textAttributes.fontVariant.has_value()</span>
      <span class="s1">? RCTFontVariantFromFontVariant(textAttributes.fontVariant.value())</span>
      <span class="s1">: RCTFontVariantUndefined</span><span class="s4">;</span>
  <span class="s1">fontProperties.weight = textAttributes.fontWeight.has_value()</span>
      <span class="s1">? RCTUIFontWeightFromInteger((NSInteger)textAttributes.fontWeight.value())</span>
      <span class="s1">: NAN</span><span class="s4">;</span>
  <span class="s1">fontProperties.sizeMultiplier = RCTEffectiveFontSizeMultiplierFromTextAttributes(textAttributes)</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">RCTFontWithFontProperties(fontProperties)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">inline static </span><span class="s1">UIColor *RCTEffectiveForegroundColorFromTextAttributes(</span><span class="s4">const </span><span class="s1">TextAttributes &amp;textAttributes)</span>
<span class="s1">{</span>
  <span class="s1">UIColor *effectiveForegroundColor = RCTUIColorFromSharedColor(textAttributes.foregroundColor) ?: [UIColor blackColor]</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(!isnan(textAttributes.opacity)) {</span>
    <span class="s1">effectiveForegroundColor = [effectiveForegroundColor</span>
        <span class="s1">colorWithAlphaComponent:CGColorGetAlpha(effectiveForegroundColor.CGColor) * textAttributes.opacity]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">return </span><span class="s1">effectiveForegroundColor</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">inline static </span><span class="s1">UIColor *RCTEffectiveBackgroundColorFromTextAttributes(</span><span class="s4">const </span><span class="s1">TextAttributes &amp;textAttributes)</span>
<span class="s1">{</span>
  <span class="s1">UIColor *effectiveBackgroundColor = RCTUIColorFromSharedColor(textAttributes.backgroundColor)</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(effectiveBackgroundColor &amp;&amp; !isnan(textAttributes.opacity)) {</span>
    <span class="s1">effectiveBackgroundColor = [effectiveBackgroundColor</span>
        <span class="s1">colorWithAlphaComponent:CGColorGetAlpha(effectiveBackgroundColor.CGColor) * textAttributes.opacity]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">return </span><span class="s1">effectiveBackgroundColor ?: [UIColor clearColor]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">NSDictionary&lt;NSAttributedStringKey</span><span class="s4">, </span><span class="s1">id&gt; *RCTNSTextAttributesFromTextAttributes(TextAttributes </span><span class="s4">const </span><span class="s1">&amp;textAttributes)</span>
<span class="s1">{</span>
  <span class="s1">NSMutableDictionary&lt;NSAttributedStringKey</span><span class="s4">, </span><span class="s1">id&gt; *attributes = [NSMutableDictionary dictionaryWithCapacity:</span><span class="s5">10</span><span class="s1">]</span><span class="s4">;</span>

  <span class="s0">// Font</span>
  <span class="s1">UIFont *font = RCTEffectiveFontFromTextAttributes(textAttributes)</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(font) {</span>
    <span class="s1">attributes[NSFontAttributeName] = font</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// Colors</span>
  <span class="s1">UIColor *effectiveForegroundColor = RCTEffectiveForegroundColorFromTextAttributes(textAttributes)</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(textAttributes.foregroundColor || !isnan(textAttributes.opacity)) {</span>
    <span class="s1">attributes[NSForegroundColorAttributeName] = effectiveForegroundColor</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(textAttributes.backgroundColor || !isnan(textAttributes.opacity)) {</span>
    <span class="s1">attributes[NSBackgroundColorAttributeName] = RCTEffectiveBackgroundColorFromTextAttributes(textAttributes)</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// Kerning</span>
  <span class="s4">if </span><span class="s1">(!isnan(textAttributes.letterSpacing)) {</span>
    <span class="s1">attributes[NSKernAttributeName] = </span><span class="s4">@</span><span class="s1">(textAttributes.letterSpacing)</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// Paragraph Style</span>
  <span class="s1">NSMutableParagraphStyle *paragraphStyle = [NSMutableParagraphStyle </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">BOOL isParagraphStyleUsed = NO</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(textAttributes.alignment.has_value()) {</span>
    <span class="s1">TextAlignment textAlignment = textAttributes.alignment.value_or(TextAlignment::Natural)</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(textAttributes.layoutDirection.value_or(LayoutDirection::LeftToRight) == LayoutDirection::RightToLeft) {</span>
      <span class="s4">if </span><span class="s1">(textAlignment == TextAlignment::Right) {</span>
        <span class="s1">textAlignment = TextAlignment::Left</span><span class="s4">;</span>
      <span class="s1">} </span><span class="s4">else if </span><span class="s1">(textAlignment == TextAlignment::Left) {</span>
        <span class="s1">textAlignment = TextAlignment::Right</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s1">paragraphStyle.alignment = RCTNSTextAlignmentFromTextAlignment(textAlignment)</span><span class="s4">;</span>
    <span class="s1">isParagraphStyleUsed = YES</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(textAttributes.baseWritingDirection.has_value()) {</span>
    <span class="s1">paragraphStyle.baseWritingDirection =</span>
        <span class="s1">RCTNSWritingDirectionFromWritingDirection(textAttributes.baseWritingDirection.value())</span><span class="s4">;</span>
    <span class="s1">isParagraphStyleUsed = YES</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(textAttributes.lineBreakStrategy.has_value()) {</span>
    <span class="s1">paragraphStyle.lineBreakStrategy =</span>
        <span class="s1">RCTNSLineBreakStrategyFromLineBreakStrategy(textAttributes.lineBreakStrategy.value())</span><span class="s4">;</span>
    <span class="s1">isParagraphStyleUsed = YES</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(!isnan(textAttributes.lineHeight)) {</span>
    <span class="s1">CGFloat lineHeight = textAttributes.lineHeight * RCTEffectiveFontSizeMultiplierFromTextAttributes(textAttributes)</span><span class="s4">;</span>
    <span class="s1">paragraphStyle.minimumLineHeight = lineHeight</span><span class="s4">;</span>
    <span class="s1">paragraphStyle.maximumLineHeight = lineHeight</span><span class="s4">;</span>
    <span class="s1">isParagraphStyleUsed = YES</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(isParagraphStyleUsed) {</span>
    <span class="s1">attributes[NSParagraphStyleAttributeName] = paragraphStyle</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// Decoration</span>
  <span class="s4">if </span><span class="s1">(textAttributes.textDecorationLineType.value_or(TextDecorationLineType::None) != TextDecorationLineType::None) {</span>
    <span class="s4">auto </span><span class="s1">textDecorationLineType = textAttributes.textDecorationLineType.value()</span><span class="s4">;</span>

    <span class="s1">NSUnderlineStyle style = RCTNSUnderlineStyleFromTextDecorationStyle(</span>
        <span class="s1">textAttributes.textDecorationStyle.value_or(TextDecorationStyle::Solid))</span><span class="s4">;</span>

    <span class="s1">UIColor *textDecorationColor = RCTUIColorFromSharedColor(textAttributes.textDecorationColor)</span><span class="s4">;</span>

    <span class="s0">// Underline</span>
    <span class="s4">if </span><span class="s1">(textDecorationLineType == TextDecorationLineType::Underline ||</span>
        <span class="s1">textDecorationLineType == TextDecorationLineType::UnderlineStrikethrough) {</span>
      <span class="s1">attributes[NSUnderlineStyleAttributeName] = </span><span class="s4">@</span><span class="s1">(style)</span><span class="s4">;</span>

      <span class="s4">if </span><span class="s1">(textDecorationColor) {</span>
        <span class="s1">attributes[NSUnderlineColorAttributeName] = textDecorationColor</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">// Strikethrough</span>
    <span class="s4">if </span><span class="s1">(textDecorationLineType == TextDecorationLineType::Strikethrough ||</span>
        <span class="s1">textDecorationLineType == TextDecorationLineType::UnderlineStrikethrough) {</span>
      <span class="s1">attributes[NSStrikethroughStyleAttributeName] = </span><span class="s4">@</span><span class="s1">(style)</span><span class="s4">;</span>

      <span class="s4">if </span><span class="s1">(textDecorationColor) {</span>
        <span class="s1">attributes[NSStrikethroughColorAttributeName] = textDecorationColor</span><span class="s4">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">// Shadow</span>
  <span class="s4">if </span><span class="s1">(textAttributes.textShadowOffset.has_value()) {</span>
    <span class="s4">auto </span><span class="s1">textShadowOffset = textAttributes.textShadowOffset.value()</span><span class="s4">;</span>
    <span class="s1">NSShadow *shadow = [NSShadow </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
    <span class="s1">shadow.shadowOffset = CGSize{textShadowOffset.width</span><span class="s4">, </span><span class="s1">textShadowOffset.height}</span><span class="s4">;</span>
    <span class="s1">shadow.shadowBlurRadius = textAttributes.textShadowRadius</span><span class="s4">;</span>
    <span class="s1">shadow.shadowColor = RCTUIColorFromSharedColor(textAttributes.textShadowColor)</span><span class="s4">;</span>
    <span class="s1">attributes[NSShadowAttributeName] = shadow</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s0">// Special</span>
  <span class="s4">if </span><span class="s1">(textAttributes.isHighlighted) {</span>
    <span class="s1">attributes[RCTAttributedStringIsHighlightedAttributeName] = </span><span class="s4">@</span><span class="s1">YES</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(textAttributes.accessibilityRole.has_value()) {</span>
    <span class="s4">auto </span><span class="s1">accessibilityRole = textAttributes.accessibilityRole.value()</span><span class="s4">;</span>
    <span class="s4">switch </span><span class="s1">(accessibilityRole) {</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::None:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;none&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Button:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;button&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Link:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;link&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Search:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;search&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Image:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;image&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Imagebutton:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;imagebutton&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Keyboardkey:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;keyboardkey&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Text:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;text&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Adjustable:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;adjustable&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Summary:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;summary&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Header:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;header&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Alert:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;alert&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Checkbox:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;checkbox&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Combobox:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;combobox&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Menu:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;menu&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Menubar:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;menubar&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Menuitem:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;menuitem&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Progressbar:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;progressbar&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Radio:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;radio&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Radiogroup:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;radiogroup&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Scrollbar:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;scrollbar&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Spinbutton:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;spinbutton&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Switch:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;switch&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Tab:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;tab&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::TabBar:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;tabbar&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Tablist:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;tablist&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Timer:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;timer&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
      <span class="s4">case </span><span class="s1">AccessibilityRole::Toolbar:</span>
        <span class="s1">attributes[RCTTextAttributesAccessibilityRoleAttributeName] = </span><span class="s4">@</span><span class="s1">(</span><span class="s3">&quot;toolbar&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s4">break;</span>
    <span class="s1">}</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">return </span><span class="s1">[attributes copy]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">static void </span><span class="s1">RCTApplyBaselineOffset(NSMutableAttributedString *attributedText)</span>
<span class="s1">{</span>
  <span class="s1">__block CGFloat maximumLineHeight = </span><span class="s5">0</span><span class="s4">;</span>

  <span class="s1">[attributedText enumerateAttribute:NSParagraphStyleAttributeName</span>
                             <span class="s1">inRange:NSMakeRange(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">attributedText.length)</span>
                             <span class="s1">options:NSAttributedStringEnumerationLongestEffectiveRangeNotRequired</span>
                          <span class="s1">usingBlock:^(NSParagraphStyle *paragraphStyle</span><span class="s4">, </span><span class="s1">__unused NSRange range</span><span class="s4">, </span><span class="s1">__unused BOOL *stop) {</span>
                            <span class="s4">if </span><span class="s1">(!paragraphStyle) {</span>
                              <span class="s4">return;</span>
                            <span class="s1">}</span>

                            <span class="s1">maximumLineHeight = MAX(paragraphStyle.maximumLineHeight</span><span class="s4">, </span><span class="s1">maximumLineHeight)</span><span class="s4">;</span>
                          <span class="s1">}]</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(maximumLineHeight == </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s0">// `lineHeight` was not specified, nothing to do.</span>
    <span class="s4">return;</span>
  <span class="s1">}</span>

  <span class="s1">__block CGFloat maximumFontLineHeight = </span><span class="s5">0</span><span class="s4">;</span>

  <span class="s1">[attributedText enumerateAttribute:NSFontAttributeName</span>
                             <span class="s1">inRange:NSMakeRange(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">attributedText.length)</span>
                             <span class="s1">options:NSAttributedStringEnumerationLongestEffectiveRangeNotRequired</span>
                          <span class="s1">usingBlock:^(UIFont *font</span><span class="s4">, </span><span class="s1">NSRange range</span><span class="s4">, </span><span class="s1">__unused BOOL *stop) {</span>
                            <span class="s4">if </span><span class="s1">(!font) {</span>
                              <span class="s4">return;</span>
                            <span class="s1">}</span>

                            <span class="s1">maximumFontLineHeight = MAX(font.lineHeight</span><span class="s4">, </span><span class="s1">maximumFontLineHeight)</span><span class="s4">;</span>
                          <span class="s1">}]</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(maximumLineHeight &lt; maximumFontLineHeight) {</span>
    <span class="s4">return;</span>
  <span class="s1">}</span>

  <span class="s1">CGFloat baseLineOffset = (maximumLineHeight - maximumFontLineHeight) / </span><span class="s5">2.0</span><span class="s4">;</span>

  <span class="s1">[attributedText addAttribute:NSBaselineOffsetAttributeName</span>
                         <span class="s1">value:</span><span class="s4">@</span><span class="s1">(baseLineOffset)</span>
                         <span class="s1">range:NSMakeRange(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">attributedText.length)]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">NSAttributedString *RCTNSAttributedStringFromAttributedString(</span><span class="s4">const </span><span class="s1">AttributedString &amp;attributedString)</span>
<span class="s1">{</span>
  <span class="s4">static </span><span class="s1">UIImage *placeholderImage</span><span class="s4">;</span>
  <span class="s4">static </span><span class="s1">dispatch_once_t onceToken</span><span class="s4">;</span>
  <span class="s1">dispatch_once(&amp;onceToken</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s1">placeholderImage = [UIImage </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">})</span><span class="s4">;</span>

  <span class="s1">NSMutableAttributedString *nsAttributedString = [NSMutableAttributedString </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>

  <span class="s1">[nsAttributedString beginEditing]</span><span class="s4">;</span>

  <span class="s4">for </span><span class="s1">(</span><span class="s4">auto </span><span class="s1">fragment : attributedString.getFragments()) {</span>
    <span class="s1">NSMutableAttributedString *nsAttributedStringFragment</span><span class="s4">;</span>

    <span class="s4">if </span><span class="s1">(fragment.isAttachment()) {</span>
      <span class="s4">auto </span><span class="s1">layoutMetrics = fragment.parentShadowView.layoutMetrics</span><span class="s4">;</span>
      <span class="s1">CGRect bounds = {</span>
          <span class="s1">.origin = {.x = layoutMetrics.frame.origin.x</span><span class="s4">, </span><span class="s1">.y = layoutMetrics.frame.origin.y}</span><span class="s4">,</span>
          <span class="s1">.size = {.width = layoutMetrics.frame.size.width</span><span class="s4">, </span><span class="s1">.height = layoutMetrics.frame.size.height}}</span><span class="s4">;</span>

      <span class="s1">NSTextAttachment *attachment = [NSTextAttachment </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
      <span class="s1">attachment.image = placeholderImage</span><span class="s4">;</span>
      <span class="s1">attachment.bounds = bounds</span><span class="s4">;</span>

      <span class="s1">nsAttributedStringFragment = [[NSMutableAttributedString attributedStringWithAttachment:attachment] mutableCopy]</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s1">NSString *string = [NSString stringWithCString:fragment.string.c_str() encoding:NSUTF8StringEncoding]</span><span class="s4">;</span>

      <span class="s4">if </span><span class="s1">(fragment.textAttributes.textTransform.has_value()) {</span>
        <span class="s4">auto </span><span class="s1">textTransform = fragment.textAttributes.textTransform.value()</span><span class="s4">;</span>
        <span class="s1">string = RCTNSStringFromStringApplyingTextTransform(string</span><span class="s4">, </span><span class="s1">textTransform)</span><span class="s4">;</span>
      <span class="s1">}</span>

      <span class="s1">nsAttributedStringFragment = [[NSMutableAttributedString alloc]</span>
          <span class="s1">initWithString:string</span>
              <span class="s1">attributes:RCTNSTextAttributesFromTextAttributes(fragment.textAttributes)]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s4">if </span><span class="s1">(fragment.parentShadowView.componentHandle) {</span>
      <span class="s1">RCTWeakEventEmitterWrapper *eventEmitterWrapper = [RCTWeakEventEmitterWrapper </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
      <span class="s1">eventEmitterWrapper.eventEmitter = fragment.parentShadowView.eventEmitter</span><span class="s4">;</span>

      <span class="s1">NSDictionary&lt;NSAttributedStringKey</span><span class="s4">, </span><span class="s1">id&gt; *additionalTextAttributes =</span>
          <span class="s4">@</span><span class="s1">{RCTAttributedStringEventEmitterKey : eventEmitterWrapper}</span><span class="s4">;</span>

      <span class="s1">[nsAttributedStringFragment addAttributes:additionalTextAttributes</span>
                                          <span class="s1">range:NSMakeRange(</span><span class="s5">0</span><span class="s4">, </span><span class="s1">nsAttributedStringFragment.length)]</span><span class="s4">;</span>
    <span class="s1">}</span>

    <span class="s1">[nsAttributedString appendAttributedString:nsAttributedStringFragment]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">RCTApplyBaselineOffset(nsAttributedString)</span><span class="s4">;</span>
  <span class="s1">[nsAttributedString endEditing]</span><span class="s4">;</span>

  <span class="s4">return </span><span class="s1">nsAttributedString</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">NSAttributedString *RCTNSAttributedStringFromAttributedStringBox(AttributedStringBox </span><span class="s4">const </span><span class="s1">&amp;attributedStringBox)</span>
<span class="s1">{</span>
  <span class="s4">switch </span><span class="s1">(attributedStringBox.getMode()) {</span>
    <span class="s4">case </span><span class="s1">AttributedStringBox::Mode::Value:</span>
      <span class="s4">return </span><span class="s1">RCTNSAttributedStringFromAttributedString(attributedStringBox.getValue())</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">AttributedStringBox::Mode::OpaquePointer:</span>
      <span class="s4">return </span><span class="s1">(NSAttributedString *)unwrapManagedObject(attributedStringBox.getOpaquePointer())</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">AttributedStringBox RCTAttributedStringBoxFromNSAttributedString(NSAttributedString *nsAttributedString)</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">nsAttributedString.length ? AttributedStringBox{wrapManagedObject(nsAttributedString)} : AttributedStringBox{}</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">static </span><span class="s1">NSString *capitalizeText(NSString *text)</span>
<span class="s1">{</span>
  <span class="s1">NSArray *words = [text componentsSeparatedByString:</span><span class="s4">@</span><span class="s3">&quot; &quot;</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">NSMutableArray *newWords = [NSMutableArray </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">NSNumberFormatter *num = [NSNumberFormatter </span><span class="s4">new</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(NSString *item in words) {</span>
    <span class="s1">NSString *word</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">([item length] &gt; </span><span class="s5">0 </span><span class="s1">&amp;&amp; [num numberFromString:[item substringWithRange:NSMakeRange(</span><span class="s5">0</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)]] == nil) {</span>
      <span class="s1">word = [item capitalizedString]</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s1">word = [item lowercaseString]</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">[newWords addObject:word]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">[newWords componentsJoinedByString:</span><span class="s4">@</span><span class="s3">&quot; &quot;</span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">NSString *RCTNSStringFromStringApplyingTextTransform(NSString *string</span><span class="s4">, </span><span class="s1">TextTransform textTransform)</span>
<span class="s1">{</span>
  <span class="s4">switch </span><span class="s1">(textTransform) {</span>
    <span class="s4">case </span><span class="s1">TextTransform::Uppercase:</span>
      <span class="s4">return </span><span class="s1">[string uppercaseString]</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">TextTransform::Lowercase:</span>
      <span class="s4">return </span><span class="s1">[string lowercaseString]</span><span class="s4">;</span>
    <span class="s4">case </span><span class="s1">TextTransform::Capitalize:</span>
      <span class="s4">return </span><span class="s1">capitalizeText(string)</span><span class="s4">;</span>
    <span class="s4">default</span><span class="s1">:</span>
      <span class="s4">return </span><span class="s1">string</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>