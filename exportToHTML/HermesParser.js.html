<html>
<head>
<title>HermesParser.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
HermesParser.js</font>
</center></td></tr></table>
<pre><span class="s0">/** 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 * 
 *  
 * @format 
 */</span>
<span class="s2">'use strict'</span><span class="s1">;</span>

<span class="s1">Object.defineProperty(exports, </span><span class="s2">&quot;__esModule&quot;</span><span class="s1">, {</span>
  <span class="s1">value: </span><span class="s3">true</span>
<span class="s1">});</span>
<span class="s1">exports.parse = parse;</span>

<span class="s3">var </span><span class="s1">_HermesParserDeserializer = _interopRequireDefault(require(</span><span class="s2">&quot;./HermesParserDeserializer&quot;</span><span class="s1">));</span>

<span class="s3">var </span><span class="s1">_HermesParserWASM = _interopRequireDefault(require(</span><span class="s2">&quot;./HermesParserWASM&quot;</span><span class="s1">));</span>

<span class="s3">function </span><span class="s1">_interopRequireDefault(obj) { </span><span class="s3">return </span><span class="s1">obj &amp;&amp; obj.__esModule ? obj : { </span><span class="s3">default</span><span class="s1">: obj }; }</span>

<span class="s1">let HermesParserWASM;</span>
<span class="s1">let hermesParse;</span>
<span class="s1">let hermesParseResult_free;</span>
<span class="s1">let hermesParseResult_getError;</span>
<span class="s1">let hermesParseResult_getErrorLine;</span>
<span class="s1">let hermesParseResult_getErrorColumn;</span>
<span class="s1">let hermesParseResult_getProgramBuffer;</span>
<span class="s1">let hermesParseResult_getPositionBuffer;</span>
<span class="s1">let hermesParseResult_getPositionBufferSize;</span>
<span class="s0">/** 
 * Init the WASM wrapper code generated by `emscripten` to preparse the 
 * HermesParser WASM code. 
 */</span>

<span class="s3">function </span><span class="s1">initHermesParserWASM() {</span>
  <span class="s3">if </span><span class="s1">(HermesParserWASM != </span><span class="s3">null</span><span class="s1">) {</span>
    <span class="s3">return</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s1">HermesParserWASM = (</span><span class="s4">0</span><span class="s1">, _HermesParserWASM.</span><span class="s3">default</span><span class="s1">)({</span>
    <span class="s0">/** 
     * The emscripten version of `quit` unconditionally assigns the `status` to 
     * `process.exitCode` which overrides any pre-existing code that has been 
     * set, even if it is non zero. For our use case we never want an 
     * `exitCode` to be set so this override removes that functionality. 
     */</span>
    <span class="s1">quit(_status, toThrow) {</span>
      <span class="s3">throw </span><span class="s1">toThrow;</span>
    <span class="s1">}</span>

  <span class="s1">});</span>
  <span class="s1">hermesParse = HermesParserWASM.cwrap(</span><span class="s2">'hermesParse'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">]);</span>
  <span class="s1">hermesParseResult_free = HermesParserWASM.cwrap(</span><span class="s2">'hermesParseResult_free'</span><span class="s1">, </span><span class="s2">'void'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">]);</span>
  <span class="s1">hermesParseResult_getError = HermesParserWASM.cwrap(</span><span class="s2">'hermesParseResult_getError'</span><span class="s1">, </span><span class="s2">'string'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">]);</span>
  <span class="s1">hermesParseResult_getErrorLine = HermesParserWASM.cwrap(</span><span class="s2">'hermesParseResult_getErrorLine'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">]);</span>
  <span class="s1">hermesParseResult_getErrorColumn = HermesParserWASM.cwrap(</span><span class="s2">'hermesParseResult_getErrorColumn'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">]);</span>
  <span class="s1">hermesParseResult_getProgramBuffer = HermesParserWASM.cwrap(</span><span class="s2">'hermesParseResult_getProgramBuffer'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">]);</span>
  <span class="s1">hermesParseResult_getPositionBuffer = HermesParserWASM.cwrap(</span><span class="s2">'hermesParseResult_getPositionBuffer'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">]);</span>
  <span class="s1">hermesParseResult_getPositionBufferSize = HermesParserWASM.cwrap(</span><span class="s2">'hermesParseResult_getPositionBufferSize'</span><span class="s1">, </span><span class="s2">'number'</span><span class="s1">, [</span><span class="s2">'number'</span><span class="s1">]);</span>
<span class="s1">} </span><span class="s0">// Copy a string into the WASM heap and null-terminate</span>


<span class="s3">function </span><span class="s1">copyToHeap(buffer, addr) {</span>
  <span class="s1">HermesParserWASM.HEAP8.set(buffer, addr);</span>
  <span class="s1">HermesParserWASM.HEAP8[addr + buffer.length] = </span><span class="s4">0</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s3">function </span><span class="s1">parse(source, options) {</span>
  <span class="s1">initHermesParserWASM(); </span><span class="s0">// Allocate space on heap for source text</span>

  <span class="s1">const sourceBuffer = Buffer.from(source, </span><span class="s2">'utf8'</span><span class="s1">);</span>

  <span class="s1">const sourceAddr = HermesParserWASM._malloc(sourceBuffer.length + </span><span class="s4">1</span><span class="s1">);</span>

  <span class="s3">if </span><span class="s1">(!sourceAddr) {</span>
    <span class="s3">throw new </span><span class="s1">Error(</span><span class="s2">'Parser out of memory'</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s3">try </span><span class="s1">{</span>
    <span class="s0">// Copy source text onto WASM heap</span>
    <span class="s1">copyToHeap(sourceBuffer, sourceAddr);</span>
    <span class="s1">const parseResult = hermesParse(sourceAddr, sourceBuffer.length + </span><span class="s4">1</span><span class="s1">, options.flow === </span><span class="s2">'detect'</span><span class="s1">, options.enableExperimentalComponentSyntax, options.tokens, options.allowReturnOutsideFunction);</span>

    <span class="s3">try </span><span class="s1">{</span>
      <span class="s0">// Extract and throw error from parse result if parsing failed</span>
      <span class="s1">const err = hermesParseResult_getError(parseResult);</span>

      <span class="s3">if </span><span class="s1">(err) {</span>
        <span class="s1">const syntaxError = </span><span class="s3">new </span><span class="s1">SyntaxError(err); </span><span class="s0">// $FlowExpectedError[prop-missing]</span>

        <span class="s1">syntaxError.loc = {</span>
          <span class="s1">line: hermesParseResult_getErrorLine(parseResult),</span>
          <span class="s1">column: hermesParseResult_getErrorColumn(parseResult)</span>
        <span class="s1">};</span>
        <span class="s3">throw </span><span class="s1">syntaxError;</span>
      <span class="s1">}</span>

      <span class="s1">const deserializer = </span><span class="s3">new </span><span class="s1">_HermesParserDeserializer.</span><span class="s3">default</span><span class="s1">(hermesParseResult_getProgramBuffer(parseResult), hermesParseResult_getPositionBuffer(parseResult), hermesParseResult_getPositionBufferSize(parseResult), HermesParserWASM, options);</span>
      <span class="s3">return </span><span class="s1">deserializer.deserialize();</span>
    <span class="s1">} </span><span class="s3">finally </span><span class="s1">{</span>
      <span class="s1">hermesParseResult_free(parseResult);</span>
    <span class="s1">}</span>
  <span class="s1">} </span><span class="s3">finally </span><span class="s1">{</span>
    <span class="s1">HermesParserWASM._free(sourceAddr);</span>
  <span class="s1">}</span>
<span class="s1">}</span></pre>
</body>
</html>