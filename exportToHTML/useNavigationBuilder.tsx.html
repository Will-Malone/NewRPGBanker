<html>
<head>
<title>useNavigationBuilder.tsx</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #a9b7c6;}
.s3 { color: #6a8759;}
.s4 { color: #9876aa; font-style: italic;}
.s5 { color: #808080;}
.s6 { color: #ffc66d;}
.s7 { color: #6897bb; font-style: italic;}
.s8 { color: #a9b7c6;}
.s9 { color: #e8bf6a;}
.s10 { color: #bbb529;}
.s11 { color: #d0d0ff;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
useNavigationBuilder.tsx</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">{</span>
  <span class="s2">CommonActions</span><span class="s1">,</span>
  <span class="s2">DefaultRouterOptions</span><span class="s1">,</span>
  <span class="s2">NavigationAction</span><span class="s1">,</span>
  <span class="s2">NavigationState</span><span class="s1">,</span>
  <span class="s2">ParamListBase</span><span class="s1">,</span>
  <span class="s2">PartialState</span><span class="s1">,</span>
  <span class="s2">Route</span><span class="s1">,</span>
  <span class="s2">Router</span><span class="s1">,</span>
  <span class="s2">RouterConfigOptions</span><span class="s1">,</span>
  <span class="s2">RouterFactory</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'@react-navigation/routers'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s4">* </span><span class="s0">as </span><span class="s2">React </span><span class="s0">from </span><span class="s3">'react'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">isValidElementType </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'react-is'</span><span class="s1">;</span>

<span class="s0">import </span><span class="s2">Group </span><span class="s0">from </span><span class="s3">'./Group'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">isArrayEqual </span><span class="s0">from </span><span class="s3">'./isArrayEqual'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">isRecordEqual </span><span class="s0">from </span><span class="s3">'./isRecordEqual'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">NavigationHelpersContext </span><span class="s0">from </span><span class="s3">'./NavigationHelpersContext'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">NavigationRouteContext </span><span class="s0">from </span><span class="s3">'./NavigationRouteContext'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">NavigationStateContext </span><span class="s0">from </span><span class="s3">'./NavigationStateContext'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">PreventRemoveProvider </span><span class="s0">from </span><span class="s3">'./PreventRemoveProvider'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">Screen </span><span class="s0">from </span><span class="s3">'./Screen'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">DefaultNavigatorOptions</span><span class="s1">,</span>
  <span class="s2">EventMapBase</span><span class="s1">,</span>
  <span class="s2">EventMapCore</span><span class="s1">,</span>
  <span class="s2">NavigatorScreenParams</span><span class="s1">,</span>
  <span class="s2">PrivateValueStore</span><span class="s1">,</span>
  <span class="s2">RouteConfig</span><span class="s1">,</span>
  <span class="s2">RouteProp</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'./types'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useChildListeners </span><span class="s0">from </span><span class="s3">'./useChildListeners'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useComponent </span><span class="s0">from </span><span class="s3">'./useComponent'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useCurrentRender </span><span class="s0">from </span><span class="s3">'./useCurrentRender'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useDescriptors</span><span class="s1">, { </span><span class="s2">ScreenConfigWithParent </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'./useDescriptors'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useEventEmitter </span><span class="s0">from </span><span class="s3">'./useEventEmitter'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useFocusedListenersChildrenAdapter </span><span class="s0">from </span><span class="s3">'./useFocusedListenersChildrenAdapter'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useFocusEvents </span><span class="s0">from </span><span class="s3">'./useFocusEvents'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useKeyedChildListeners </span><span class="s0">from </span><span class="s3">'./useKeyedChildListeners'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useNavigationHelpers </span><span class="s0">from </span><span class="s3">'./useNavigationHelpers'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useOnAction </span><span class="s0">from </span><span class="s3">'./useOnAction'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useOnGetState </span><span class="s0">from </span><span class="s3">'./useOnGetState'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useOnRouteFocus </span><span class="s0">from </span><span class="s3">'./useOnRouteFocus'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useRegisterNavigator </span><span class="s0">from </span><span class="s3">'./useRegisterNavigator'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">useScheduleUpdate </span><span class="s0">from </span><span class="s3">'./useScheduleUpdate'</span><span class="s1">;</span>

<span class="s5">// This is to make TypeScript compiler happy</span>
<span class="s5">// eslint-disable-next-line babel/no-unused-expressions</span>
<span class="s2">PrivateValueStore</span><span class="s1">;</span>

<span class="s0">type </span><span class="s2">NavigationBuilderOptions</span><span class="s1">&lt;</span><span class="s2">ScreenOptions </span><span class="s0">extends </span><span class="s1">{}&gt; </span><span class="s0">= </span><span class="s1">{</span>
  <span class="s5">/**</span>
   <span class="s5">* Default options specified by the navigator. 
   * It receives the custom options in the arguments if a function is specified. 
   */</span>
  <span class="s1">defaultScreenOptions</span><span class="s0">?:</span>
    <span class="s0">| </span><span class="s2">ScreenOptions</span>
    <span class="s0">| </span><span class="s1">((</span><span class="s2">props</span><span class="s0">: </span><span class="s1">{</span>
        <span class="s1">route</span><span class="s0">: </span><span class="s2">RouteProp</span><span class="s1">&lt;</span><span class="s2">ParamListBase</span><span class="s1">&gt;;</span>
        <span class="s1">navigation</span><span class="s0">: </span><span class="s2">any</span><span class="s1">;</span>
        <span class="s1">options</span><span class="s0">: </span><span class="s2">ScreenOptions</span><span class="s1">;</span>
      <span class="s1">}) </span><span class="s0">=&gt; </span><span class="s2">ScreenOptions</span><span class="s1">);</span>
<span class="s1">};</span>

<span class="s0">type </span><span class="s2">NavigatorRoute</span><span class="s1">&lt;</span><span class="s2">State </span><span class="s0">extends </span><span class="s2">NavigationState</span><span class="s1">&gt; </span><span class="s0">= </span><span class="s1">{</span>
  <span class="s1">key</span><span class="s0">: </span><span class="s2">string</span><span class="s1">;</span>
  <span class="s1">params</span><span class="s0">?: </span><span class="s2">NavigatorScreenParams</span><span class="s1">&lt;</span><span class="s2">ParamListBase</span><span class="s1">, </span><span class="s2">State</span><span class="s1">&gt;;</span>
<span class="s1">};</span>

<span class="s0">const </span><span class="s1">isValidKey </span><span class="s0">= </span><span class="s1">(</span><span class="s2">key</span><span class="s0">: </span><span class="s2">unknown</span><span class="s1">) </span><span class="s0">=&gt;</span>
  <span class="s2">key </span><span class="s0">=== </span><span class="s4">undefined </span><span class="s0">|| </span><span class="s1">(</span><span class="s0">typeof </span><span class="s2">key </span><span class="s0">=== </span><span class="s3">'string' </span><span class="s0">&amp;&amp; </span><span class="s2">key </span><span class="s0">!== </span><span class="s3">''</span><span class="s1">);</span>

<span class="s5">/**</span>
 <span class="s5">* Extract route config object from React children elements. 
 * 
 * </span><span class="s0">@param </span><span class="s2">children </span><span class="s5">React Elements to extract the config from. 
 */</span>
<span class="s0">const </span><span class="s1">getRouteConfigsFromChildren </span><span class="s0">= </span><span class="s1">&lt;</span>
  <span class="s2">State </span><span class="s0">extends </span><span class="s2">NavigationState</span><span class="s1">,</span>
  <span class="s2">ScreenOptions </span><span class="s0">extends </span><span class="s1">{},</span>
  <span class="s2">EventMap </span><span class="s0">extends </span><span class="s2">EventMapBase</span>
<span class="s1">&gt;(</span>
  <span class="s2">children</span><span class="s0">: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">ReactNode</span><span class="s1">,</span>
  <span class="s2">groupKey</span><span class="s0">?: </span><span class="s2">string</span><span class="s1">,</span>
  <span class="s2">groupOptions</span><span class="s0">?: </span><span class="s2">ScreenConfigWithParent</span><span class="s1">&lt;</span>
    <span class="s2">State</span><span class="s1">,</span>
    <span class="s2">ScreenOptions</span><span class="s1">,</span>
    <span class="s2">EventMap</span>
  <span class="s1">&gt;[</span><span class="s3">'options'</span><span class="s1">]</span>
<span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
  <span class="s0">const </span><span class="s1">configs </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s2">Children</span><span class="s1">.</span><span class="s6">toArray</span><span class="s1">(</span><span class="s2">children</span><span class="s1">).</span><span class="s2">reduce</span><span class="s0">&lt;</span>
    <span class="s2">ScreenConfigWithParent</span><span class="s0">&lt;</span><span class="s2">State</span><span class="s1">, </span><span class="s2">ScreenOptions</span><span class="s1">, </span><span class="s2">EventMap</span><span class="s0">&gt;</span><span class="s1">[]</span>
  <span class="s0">&gt;</span><span class="s1">((</span><span class="s2">acc</span><span class="s1">, </span><span class="s2">child</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">React</span><span class="s1">.</span><span class="s6">isValidElement</span><span class="s1">(</span><span class="s2">child</span><span class="s1">)) {</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">child</span><span class="s1">.</span><span class="s2">type </span><span class="s0">=== </span><span class="s2">Screen</span><span class="s1">) {</span>
        <span class="s5">// We can only extract the config from `Screen` elements</span>
        <span class="s5">// If something else was rendered, it's probably a bug</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s6">isValidKey</span><span class="s1">(</span><span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">navigationKey</span><span class="s1">)) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got an invalid 'navigationKey' prop (${</span><span class="s2">JSON</span><span class="s3">.</span><span class="s6">stringify</span><span class="s3">(</span>
              <span class="s2">child</span><span class="s3">.</span><span class="s2">props</span><span class="s3">.</span><span class="s2">navigationKey</span>
            <span class="s3">)}) for the screen '${</span>
              <span class="s2">child</span><span class="s3">.</span><span class="s2">props</span><span class="s3">.</span><span class="s2">name</span>
            <span class="s3">}'. It must be a non-empty string or 'undefined'.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s2">acc</span><span class="s1">.</span><span class="s6">push</span><span class="s1">({</span>
          <span class="s1">keys: [</span><span class="s2">groupKey</span><span class="s1">, </span><span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">navigationKey</span><span class="s1">],</span>
          <span class="s1">options: </span><span class="s2">groupOptions</span><span class="s1">,</span>
          <span class="s1">props: </span><span class="s2">child</span><span class="s1">.</span><span class="s2">props </span><span class="s0">as </span><span class="s2">RouteConfig</span><span class="s1">&lt;</span>
            <span class="s2">ParamListBase</span><span class="s1">,</span>
            <span class="s2">string</span><span class="s1">,</span>
            <span class="s2">State</span><span class="s1">,</span>
            <span class="s2">ScreenOptions</span><span class="s1">,</span>
            <span class="s2">EventMap</span>
          <span class="s1">&gt;,</span>
        <span class="s1">});</span>
        <span class="s0">return </span><span class="s2">acc</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s2">child</span><span class="s1">.</span><span class="s2">type </span><span class="s0">=== </span><span class="s2">React</span><span class="s1">.</span><span class="s2">Fragment </span><span class="s0">|| </span><span class="s2">child</span><span class="s1">.</span><span class="s2">type </span><span class="s0">=== </span><span class="s2">Group</span><span class="s1">) {</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s6">isValidKey</span><span class="s1">(</span><span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">navigationKey</span><span class="s1">)) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got an invalid 'navigationKey' prop (${</span><span class="s2">JSON</span><span class="s3">.</span><span class="s6">stringify</span><span class="s3">(</span>
              <span class="s2">child</span><span class="s3">.</span><span class="s2">props</span><span class="s3">.</span><span class="s2">navigationKey</span>
            <span class="s3">)}) for the group. It must be a non-empty string or 'undefined'.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s5">// When we encounter a fragment or group, we need to dive into its children to extract the configs</span>
        <span class="s5">// This is handy to conditionally define a group of screens</span>
        <span class="s2">acc</span><span class="s1">.</span><span class="s6">push</span><span class="s1">(</span>
          <span class="s0">...</span><span class="s6">getRouteConfigsFromChildren</span><span class="s1">&lt;</span><span class="s2">State</span><span class="s1">, </span><span class="s2">ScreenOptions</span><span class="s1">, </span><span class="s2">EventMap</span><span class="s1">&gt;(</span>
            <span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">children</span><span class="s1">,</span>
            <span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">navigationKey</span><span class="s1">,</span>
            <span class="s2">child</span><span class="s1">.</span><span class="s2">type </span><span class="s0">!== </span><span class="s2">Group</span>
              <span class="s0">? </span><span class="s2">groupOptions</span>
              <span class="s0">: </span><span class="s2">groupOptions </span><span class="s0">!= </span><span class="s4">null</span>
              <span class="s0">? </span><span class="s1">[</span><span class="s0">...</span><span class="s2">groupOptions</span><span class="s1">, </span><span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">screenOptions</span><span class="s1">]</span>
              <span class="s0">: </span><span class="s1">[</span><span class="s2">child</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">screenOptions</span><span class="s1">]</span>
          <span class="s1">)</span>
        <span class="s1">);</span>
        <span class="s0">return </span><span class="s2">acc</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
      <span class="s3">`A navigator can only contain 'Screen', 'Group' or 'React.Fragment' as its direct children (found ${</span>
        <span class="s2">React</span><span class="s3">.</span><span class="s6">isValidElement</span><span class="s3">(</span><span class="s2">child</span><span class="s3">)</span>
          <span class="s0">? </span><span class="s3">`'${</span>
              <span class="s0">typeof </span><span class="s2">child</span><span class="s3">.</span><span class="s2">type </span><span class="s0">=== </span><span class="s3">'string' </span><span class="s0">? </span><span class="s2">child</span><span class="s3">.</span><span class="s2">type </span><span class="s0">: </span><span class="s2">child</span><span class="s3">.</span><span class="s2">type</span><span class="s3">?.</span><span class="s2">name</span>
            <span class="s3">}'${</span>
              <span class="s2">child</span><span class="s3">.</span><span class="s2">props </span><span class="s0">!= </span><span class="s4">null </span><span class="s0">&amp;&amp;</span>
              <span class="s0">typeof </span><span class="s2">child</span><span class="s3">.</span><span class="s2">props </span><span class="s0">=== </span><span class="s3">'object' </span><span class="s0">&amp;&amp;</span>
              <span class="s3">'name' </span><span class="s0">in </span><span class="s2">child</span><span class="s3">.</span><span class="s2">props </span><span class="s0">&amp;&amp;</span>
              <span class="s2">child</span><span class="s3">.</span><span class="s2">props</span><span class="s3">?.</span><span class="s2">name</span>
                <span class="s0">? </span><span class="s3">` for the screen '${</span><span class="s2">child</span><span class="s3">.</span><span class="s2">props</span><span class="s3">.</span><span class="s2">name</span><span class="s3">}'`</span>
                <span class="s0">: </span><span class="s3">''</span>
            <span class="s3">}`</span>
          <span class="s0">: typeof </span><span class="s2">child </span><span class="s0">=== </span><span class="s3">'object'</span>
          <span class="s0">? </span><span class="s2">JSON</span><span class="s3">.</span><span class="s6">stringify</span><span class="s3">(</span><span class="s2">child</span><span class="s3">)</span>
          <span class="s0">: </span><span class="s3">`'${</span><span class="s6">String</span><span class="s3">(</span><span class="s2">child</span><span class="s3">)}'`</span>
      <span class="s3">}). To render this component in the navigator, pass it in the 'component' prop to 'Screen'.`</span>
    <span class="s1">);</span>
  <span class="s1">}, []);</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">process</span><span class="s1">.</span><span class="s2">env</span><span class="s1">.</span><span class="s2">NODE_ENV </span><span class="s0">!== </span><span class="s3">'production'</span><span class="s1">) {</span>
    <span class="s2">configs</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">config</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">const </span><span class="s1">{ name, children, component, getComponent } </span><span class="s0">= </span><span class="s2">config</span><span class="s1">.</span><span class="s2">props</span><span class="s1">;</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s0">typeof </span><span class="s2">name </span><span class="s0">!== </span><span class="s3">'string' </span><span class="s0">|| !</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
          <span class="s3">`Got an invalid name (${</span><span class="s2">JSON</span><span class="s3">.</span><span class="s6">stringify</span><span class="s3">(</span>
            <span class="s2">name</span>
          <span class="s3">)}) for the screen. It must be a non-empty string.`</span>
        <span class="s1">);</span>
      <span class="s1">}</span>

      <span class="s0">if </span><span class="s1">(</span>
        <span class="s2">children </span><span class="s0">!= </span><span class="s4">null </span><span class="s0">||</span>
        <span class="s2">component </span><span class="s0">!== </span><span class="s4">undefined </span><span class="s0">||</span>
        <span class="s2">getComponent </span><span class="s0">!== </span><span class="s4">undefined</span>
      <span class="s1">) {</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s2">children </span><span class="s0">!= </span><span class="s4">null </span><span class="s0">&amp;&amp; </span><span class="s2">component </span><span class="s0">!== </span><span class="s4">undefined</span><span class="s1">) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got both 'component' and 'children' props for the screen '${</span><span class="s2">name</span><span class="s3">}'. You must pass only one of them.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s2">children </span><span class="s0">!= </span><span class="s4">null </span><span class="s0">&amp;&amp; </span><span class="s2">getComponent </span><span class="s0">!== </span><span class="s4">undefined</span><span class="s1">) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got both 'getComponent' and 'children' props for the screen '${</span><span class="s2">name</span><span class="s3">}'. You must pass only one of them.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s2">component </span><span class="s0">!== </span><span class="s4">undefined </span><span class="s0">&amp;&amp; </span><span class="s2">getComponent </span><span class="s0">!== </span><span class="s4">undefined</span><span class="s1">) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got both 'component' and 'getComponent' props for the screen '${</span><span class="s2">name</span><span class="s3">}'. You must pass only one of them.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s2">children </span><span class="s0">!= </span><span class="s4">null </span><span class="s0">&amp;&amp; typeof </span><span class="s2">children </span><span class="s0">!== </span><span class="s3">'function'</span><span class="s1">) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got an invalid value for 'children' prop for the screen '${</span><span class="s2">name</span><span class="s3">}'. It must be a function returning a React Element.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s2">component </span><span class="s0">!== </span><span class="s4">undefined </span><span class="s0">&amp;&amp; !</span><span class="s6">isValidElementType</span><span class="s1">(</span><span class="s2">component</span><span class="s1">)) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got an invalid value for 'component' prop for the screen '${</span><span class="s2">name</span><span class="s3">}'. It must be a valid React Component.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s2">getComponent </span><span class="s0">!== </span><span class="s4">undefined </span><span class="s0">&amp;&amp; typeof </span><span class="s2">getComponent </span><span class="s0">!== </span><span class="s3">'function'</span><span class="s1">) {</span>
          <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
            <span class="s3">`Got an invalid value for 'getComponent' prop for the screen '${</span><span class="s2">name</span><span class="s3">}'. It must be a function returning a React Component.`</span>
          <span class="s1">);</span>
        <span class="s1">}</span>

        <span class="s0">if </span><span class="s1">(</span><span class="s0">typeof </span><span class="s2">component </span><span class="s0">=== </span><span class="s3">'function'</span><span class="s1">) {</span>
          <span class="s0">if </span><span class="s1">(</span><span class="s2">component</span><span class="s1">.</span><span class="s2">name </span><span class="s0">=== </span><span class="s3">'component'</span><span class="s1">) {</span>
            <span class="s5">// Inline anonymous functions passed in the `component` prop will have the name of the prop</span>
            <span class="s5">// It's relatively safe to assume that it's not a component since it should also have PascalCase name</span>
            <span class="s5">// We won't catch all scenarios here, but this should catch a good chunk of incorrect use.</span>
            <span class="s2">console</span><span class="s1">.</span><span class="s6">warn</span><span class="s1">(</span>
              <span class="s3">`Looks like you're passing an inline function for 'component' prop for the screen '${</span><span class="s2">name</span><span class="s3">}' (e.g. component={() =&gt; &lt;SomeComponent /&gt;}). Passing an inline function will cause the component state to be lost on re-render and cause perf issues since it's re-created every render. You can pass the function as children to 'Screen' instead to achieve the desired behaviour.`</span>
            <span class="s1">);</span>
          <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s3">/</span><span class="s0">^</span><span class="s4">[a-z]</span><span class="s3">/</span><span class="s1">.</span><span class="s6">test</span><span class="s1">(</span><span class="s2">component</span><span class="s1">.</span><span class="s2">name</span><span class="s1">)) {</span>
            <span class="s2">console</span><span class="s1">.</span><span class="s6">warn</span><span class="s1">(</span>
              <span class="s3">`Got a component with the name '${</span><span class="s2">component</span><span class="s3">.</span><span class="s2">name</span><span class="s3">}' for the screen '${</span><span class="s2">name</span><span class="s3">}'. React Components must start with an uppercase letter. If you're passing a regular function and not a component, pass it as children to 'Screen' instead. Otherwise capitalize your component's name.`</span>
            <span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
          <span class="s3">`Couldn't find a 'component', 'getComponent' or 'children' prop for the screen '${</span><span class="s2">name</span><span class="s3">}'. This can happen if you passed 'undefined'. You likely forgot to export your component from the file it's defined in, or mixed up default import and named import when importing.`</span>
        <span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s0">return </span><span class="s2">configs</span><span class="s1">;</span>
<span class="s1">}; 
</span>
<span class="s5">/**</span>
 <span class="s5">* Hook for building navigators. 
 * 
 * </span><span class="s0">@param </span><span class="s2">createRouter </span><span class="s5">Factory method which returns router object. 
 * </span><span class="s0">@param </span><span class="s2">options </span><span class="s5">Options object containing `children` and additional options for the router. 
 * </span><span class="s0">@returns </span><span class="s5">An object containing `state`, `navigation`, `descriptors` objects. 
 */</span>
<span class="s0">export default function </span><span class="s1">useNavigationBuilder&lt;</span>
  <span class="s2">State </span><span class="s0">extends </span><span class="s2">NavigationState</span><span class="s1">,</span>
  <span class="s2">RouterOptions </span><span class="s0">extends </span><span class="s2">DefaultRouterOptions</span><span class="s1">,</span>
  <span class="s2">ActionHelpers </span><span class="s0">extends </span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, () </span><span class="s0">=&gt; </span><span class="s2">void</span><span class="s1">&gt;,</span>
  <span class="s2">ScreenOptions </span><span class="s0">extends </span><span class="s1">{},</span>
  <span class="s2">EventMap </span><span class="s0">extends </span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">any</span><span class="s1">&gt;</span>
<span class="s1">&gt;(</span>
  <span class="s2">createRouter</span><span class="s0">: </span><span class="s2">RouterFactory</span><span class="s1">&lt;</span><span class="s2">State</span><span class="s1">, </span><span class="s2">any</span><span class="s1">, </span><span class="s2">RouterOptions</span><span class="s1">&gt;,</span>
  <span class="s2">options</span><span class="s0">: </span><span class="s2">DefaultNavigatorOptions</span><span class="s1">&lt;</span>
    <span class="s2">ParamListBase</span><span class="s1">,</span>
    <span class="s2">State</span><span class="s1">,</span>
    <span class="s2">ScreenOptions</span><span class="s1">,</span>
    <span class="s2">EventMap</span>
  <span class="s1">&gt; </span><span class="s0">&amp;</span>
    <span class="s2">NavigationBuilderOptions</span><span class="s1">&lt;</span><span class="s2">ScreenOptions</span><span class="s1">&gt; </span><span class="s0">&amp;</span>
    <span class="s2">RouterOptions</span>
<span class="s1">) {</span>
  <span class="s0">const </span><span class="s1">navigatorKey </span><span class="s0">= </span><span class="s6">useRegisterNavigator</span><span class="s1">();</span>

  <span class="s0">const </span><span class="s1">route </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useContext</span><span class="s1">(</span><span class="s2">NavigationRouteContext</span><span class="s1">) </span><span class="s0">as</span>
    <span class="s0">| </span><span class="s2">NavigatorRoute</span><span class="s0">&lt;</span><span class="s2">State</span><span class="s0">&gt;</span>
    <span class="s0">| </span><span class="s4">undefined</span><span class="s1">;</span>

  <span class="s0">const </span><span class="s1">{ children, screenListeners, </span><span class="s0">...</span><span class="s1">rest } </span><span class="s0">= </span><span class="s2">options</span><span class="s1">;</span>
  <span class="s0">const </span><span class="s1">{ </span><span class="s2">current</span><span class="s1">: router } </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useRef</span><span class="s1">&lt;</span><span class="s2">Router</span><span class="s1">&lt;</span><span class="s2">State</span><span class="s1">, </span><span class="s2">any</span><span class="s1">&gt;&gt;(</span>
    <span class="s6">createRouter</span><span class="s1">({</span>
      <span class="s0">...</span><span class="s1">(</span><span class="s2">rest </span><span class="s0">as </span><span class="s2">unknown </span><span class="s0">as </span><span class="s2">RouterOptions</span><span class="s1">),</span>
      <span class="s0">...</span><span class="s1">(</span><span class="s2">route</span><span class="s1">?.</span><span class="s2">params </span><span class="s0">&amp;&amp;</span>
      <span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">state </span><span class="s0">== </span><span class="s4">null </span><span class="s0">&amp;&amp;</span>
      <span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">initial </span><span class="s0">!== </span><span class="s4">false </span><span class="s0">&amp;&amp;</span>
      <span class="s0">typeof </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">screen </span><span class="s0">=== </span><span class="s3">'string'</span>
        <span class="s0">? </span><span class="s1">{ initialRouteName: </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">screen </span><span class="s1">}</span>
        <span class="s0">: </span><span class="s4">null</span><span class="s1">),</span>
    <span class="s1">})</span>
  <span class="s1">);</span>

  <span class="s0">const </span><span class="s1">routeConfigs </span><span class="s0">= </span><span class="s2">getRouteConfigsFromChildren</span><span class="s0">&lt;</span>
    <span class="s2">State</span><span class="s1">,</span>
    <span class="s2">ScreenOptions</span><span class="s1">,</span>
    <span class="s2">EventMap</span>
  <span class="s0">&gt;</span><span class="s1">(</span><span class="s2">children</span><span class="s1">);</span>

  <span class="s0">const </span><span class="s1">screens </span><span class="s0">= </span><span class="s2">routeConfigs</span><span class="s1">.</span><span class="s2">reduce</span><span class="s0">&lt;</span>
    <span class="s2">Record</span><span class="s0">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">ScreenConfigWithParent</span><span class="s0">&lt;</span><span class="s2">State</span><span class="s1">, </span><span class="s2">ScreenOptions</span><span class="s1">, </span><span class="s2">EventMap</span><span class="s0">&gt;&gt;</span>
  <span class="s0">&gt;</span><span class="s1">((</span><span class="s2">acc</span><span class="s1">, </span><span class="s2">config</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">config</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">name </span><span class="s0">in </span><span class="s2">acc</span><span class="s1">) {</span>
      <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
        <span class="s3">`A navigator cannot contain multiple 'Screen' components with the same name (found duplicate screen named '${</span><span class="s2">config</span><span class="s3">.</span><span class="s2">props</span><span class="s3">.</span><span class="s2">name</span><span class="s3">}')`</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">acc</span><span class="s1">[</span><span class="s2">config</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">name</span><span class="s1">] </span><span class="s0">= </span><span class="s2">config</span><span class="s1">;</span>
    <span class="s0">return </span><span class="s2">acc</span><span class="s1">;</span>
  <span class="s1">}, {});</span>

  <span class="s0">const </span><span class="s1">routeNames </span><span class="s0">= </span><span class="s2">routeConfigs</span><span class="s1">.</span><span class="s6">map</span><span class="s1">((</span><span class="s2">config</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">config</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">name</span><span class="s1">);</span>
  <span class="s0">const </span><span class="s1">routeKeyList </span><span class="s0">= </span><span class="s2">routeNames</span><span class="s1">.</span><span class="s6">reduce</span><span class="s1">&lt;</span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">React</span><span class="s1">.</span><span class="s2">Key </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">&gt;&gt;(</span>
    <span class="s1">(</span><span class="s2">acc</span><span class="s1">, </span><span class="s2">curr</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s2">acc</span><span class="s1">[</span><span class="s2">curr</span><span class="s1">] </span><span class="s0">= </span><span class="s2">screens</span><span class="s1">[</span><span class="s2">curr</span><span class="s1">].</span><span class="s2">keys</span><span class="s1">.</span><span class="s6">map</span><span class="s1">((</span><span class="s2">key</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">key </span><span class="s0">?? </span><span class="s3">''</span><span class="s1">).</span><span class="s6">join</span><span class="s1">(</span><span class="s3">':'</span><span class="s1">);</span>
      <span class="s0">return </span><span class="s2">acc</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s1">{}</span>
  <span class="s1">);</span>
  <span class="s0">const </span><span class="s1">routeParamList </span><span class="s0">= </span><span class="s2">routeNames</span><span class="s1">.</span><span class="s6">reduce</span><span class="s1">&lt;</span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">object </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">&gt;&gt;(</span>
    <span class="s1">(</span><span class="s2">acc</span><span class="s1">, </span><span class="s2">curr</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">const </span><span class="s1">{ initialParams } </span><span class="s0">= </span><span class="s2">screens</span><span class="s1">[</span><span class="s2">curr</span><span class="s1">].</span><span class="s2">props</span><span class="s1">;</span>
      <span class="s2">acc</span><span class="s1">[</span><span class="s2">curr</span><span class="s1">] </span><span class="s0">= </span><span class="s2">initialParams</span><span class="s1">;</span>
      <span class="s0">return </span><span class="s2">acc</span><span class="s1">;</span>
    <span class="s1">},</span>
    <span class="s1">{}</span>
  <span class="s1">);</span>
  <span class="s0">const </span><span class="s1">routeGetIdList </span><span class="s0">= </span><span class="s2">routeNames</span><span class="s1">.</span><span class="s2">reduce</span><span class="s0">&lt;</span>
    <span class="s2">RouterConfigOptions</span><span class="s1">[</span><span class="s3">'routeGetIdList'</span><span class="s1">]</span>
  <span class="s0">&gt;</span><span class="s1">(</span>
    <span class="s1">(</span><span class="s2">acc</span><span class="s1">, </span><span class="s2">curr</span><span class="s1">) </span><span class="s0">=&gt;</span>
      <span class="s2">Object</span><span class="s1">.</span><span class="s6">assign</span><span class="s1">(</span><span class="s2">acc</span><span class="s1">, {</span>
        <span class="s1">[</span><span class="s2">curr</span><span class="s1">]: </span><span class="s2">screens</span><span class="s1">[</span><span class="s2">curr</span><span class="s1">].</span><span class="s2">props</span><span class="s1">.</span><span class="s2">getId</span><span class="s1">,</span>
      <span class="s1">}),</span>
    <span class="s1">{}</span>
  <span class="s1">);</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">routeNames</span><span class="s1">.length) {</span>
    <span class="s0">throw new </span><span class="s6">Error</span><span class="s1">(</span>
      <span class="s3">&quot;Couldn't find any screens for the navigator. Have you defined any screens as its children?&quot;</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">isStateValid </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useCallback</span><span class="s1">(</span>
    <span class="s1">(</span><span class="s2">state</span><span class="s0">: </span><span class="s2">NavigationState </span><span class="s0">| </span><span class="s2">PartialState</span><span class="s1">&lt;</span><span class="s2">NavigationState</span><span class="s1">&gt;) </span><span class="s0">=&gt;</span>
      <span class="s2">state</span><span class="s1">.</span><span class="s2">type </span><span class="s0">=== </span><span class="s4">undefined </span><span class="s0">|| </span><span class="s2">state</span><span class="s1">.</span><span class="s2">type </span><span class="s0">=== </span><span class="s2">router</span><span class="s1">.</span><span class="s2">type</span><span class="s1">,</span>
    <span class="s1">[</span><span class="s2">router</span><span class="s1">.</span><span class="s2">type</span><span class="s1">]</span>
  <span class="s1">);</span>

  <span class="s0">const </span><span class="s1">isStateInitialized </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useCallback</span><span class="s1">(</span>
    <span class="s1">(</span><span class="s2">state</span><span class="s0">: </span><span class="s2">NavigationState </span><span class="s0">| </span><span class="s2">PartialState</span><span class="s1">&lt;</span><span class="s2">NavigationState</span><span class="s1">&gt; </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">) </span><span class="s0">=&gt;</span>
      <span class="s2">state </span><span class="s0">!== </span><span class="s4">undefined </span><span class="s0">&amp;&amp; </span><span class="s2">state</span><span class="s1">.</span><span class="s2">stale </span><span class="s0">=== </span><span class="s4">false </span><span class="s0">&amp;&amp; </span><span class="s6">isStateValid</span><span class="s1">(</span><span class="s2">state</span><span class="s1">),</span>
    <span class="s1">[</span><span class="s2">isStateValid</span><span class="s1">]</span>
  <span class="s1">);</span>

  <span class="s0">const </span><span class="s1">{</span>
    <span class="s2">state</span><span class="s1">: currentState,</span>
    <span class="s2">getState</span><span class="s1">: getCurrentState,</span>
    <span class="s2">setState</span><span class="s1">: setCurrentState,</span>
    <span class="s1">setKey,</span>
    <span class="s1">getKey,</span>
    <span class="s1">getIsInitial,</span>
  <span class="s1">} </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useContext</span><span class="s1">(</span><span class="s2">NavigationStateContext</span><span class="s1">);</span>

  <span class="s0">const </span><span class="s1">stateCleanedUp </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useRef</span><span class="s1">(</span><span class="s4">false</span><span class="s1">);</span>

  <span class="s0">const </span><span class="s1">cleanUpState </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useCallback</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s6">setCurrentState</span><span class="s1">(</span><span class="s4">undefined</span><span class="s1">);</span>
    <span class="s2">stateCleanedUp</span><span class="s1">.</span><span class="s2">current </span><span class="s0">= </span><span class="s4">true</span><span class="s1">;</span>
  <span class="s1">}, [</span><span class="s2">setCurrentState</span><span class="s1">]);</span>

  <span class="s0">const </span><span class="s1">setState </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useCallback</span><span class="s1">(</span>
    <span class="s1">(</span><span class="s2">state</span><span class="s0">: </span><span class="s2">NavigationState </span><span class="s0">| </span><span class="s2">PartialState</span><span class="s1">&lt;</span><span class="s2">NavigationState</span><span class="s1">&gt; </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">stateCleanedUp</span><span class="s1">.</span><span class="s2">current</span><span class="s1">) {</span>
        <span class="s5">// State might have been already cleaned up due to unmount</span>
        <span class="s5">// We do not want to expose API allowing to override this</span>
        <span class="s5">// This would lead to old data preservation on main navigator unmount</span>
        <span class="s0">return</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s6">setCurrentState</span><span class="s1">(</span><span class="s2">state</span><span class="s1">);</span>
    <span class="s1">},</span>
    <span class="s1">[</span><span class="s2">setCurrentState</span><span class="s1">]</span>
  <span class="s1">);</span>

  <span class="s0">const </span><span class="s1">[initializedState, isFirstStateInitialization] </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useMemo</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">const </span><span class="s1">initialRouteParamList </span><span class="s0">= </span><span class="s2">routeNames</span><span class="s1">.</span><span class="s2">reduce</span><span class="s0">&lt;</span>
      <span class="s2">Record</span><span class="s0">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">object </span><span class="s0">| </span><span class="s4">undefined</span><span class="s0">&gt;</span>
    <span class="s0">&gt;</span><span class="s1">((</span><span class="s2">acc</span><span class="s1">, </span><span class="s2">curr</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">const </span><span class="s1">{ initialParams } </span><span class="s0">= </span><span class="s2">screens</span><span class="s1">[</span><span class="s2">curr</span><span class="s1">].</span><span class="s2">props</span><span class="s1">;</span>
      <span class="s0">const </span><span class="s1">initialParamsFromParams </span><span class="s0">=</span>
        <span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">?.</span><span class="s2">state </span><span class="s0">== </span><span class="s4">null </span><span class="s0">&amp;&amp;</span>
        <span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">?.</span><span class="s2">initial </span><span class="s0">!== </span><span class="s4">false </span><span class="s0">&amp;&amp;</span>
        <span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">?.</span><span class="s2">screen </span><span class="s0">=== </span><span class="s2">curr</span>
          <span class="s0">? </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">params</span>
          <span class="s0">: </span><span class="s4">undefined</span><span class="s1">;</span>

      <span class="s2">acc</span><span class="s1">[</span><span class="s2">curr</span><span class="s1">] </span><span class="s0">=</span>
        <span class="s2">initialParams </span><span class="s0">!== </span><span class="s4">undefined </span><span class="s0">|| </span><span class="s2">initialParamsFromParams </span><span class="s0">!== </span><span class="s4">undefined</span>
          <span class="s0">? </span><span class="s1">{</span>
              <span class="s0">...</span><span class="s2">initialParams</span><span class="s1">,</span>
              <span class="s0">...</span><span class="s2">initialParamsFromParams</span><span class="s1">,</span>
            <span class="s1">}</span>
          <span class="s0">: </span><span class="s4">undefined</span><span class="s1">;</span>

      <span class="s0">return </span><span class="s2">acc</span><span class="s1">;</span>
    <span class="s1">}, {});</span>

    <span class="s5">// If the current state isn't initialized on first render, we initialize it</span>
    <span class="s5">// We also need to re-initialize it if the state passed from parent was changed (maybe due to reset)</span>
    <span class="s5">// Otherwise assume that the state was provided as initial state</span>
    <span class="s5">// So we need to rehydrate it to make it usable</span>
    <span class="s0">if </span><span class="s1">(</span>
      <span class="s1">(</span><span class="s2">currentState </span><span class="s0">=== </span><span class="s4">undefined </span><span class="s0">|| !</span><span class="s6">isStateValid</span><span class="s1">(</span><span class="s2">currentState</span><span class="s1">)) </span><span class="s0">&amp;&amp;</span>
      <span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">?.</span><span class="s2">state </span><span class="s0">== </span><span class="s4">null</span>
    <span class="s1">) {</span>
      <span class="s0">return </span><span class="s1">[</span>
        <span class="s2">router</span><span class="s1">.</span><span class="s6">getInitialState</span><span class="s1">({</span>
          <span class="s2">routeNames</span><span class="s1">,</span>
          <span class="s1">routeParamList: </span><span class="s2">initialRouteParamList</span><span class="s1">,</span>
          <span class="s2">routeGetIdList</span><span class="s1">,</span>
        <span class="s1">}),</span>
        <span class="s4">true</span><span class="s1">,</span>
      <span class="s1">];</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s0">return </span><span class="s1">[</span>
        <span class="s2">router</span><span class="s1">.</span><span class="s6">getRehydratedState</span><span class="s1">(</span>
          <span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">?.</span><span class="s2">state </span><span class="s0">?? </span><span class="s1">(</span><span class="s2">currentState </span><span class="s0">as </span><span class="s2">PartialState</span><span class="s1">&lt;</span><span class="s2">State</span><span class="s1">&gt;),</span>
          <span class="s1">{</span>
            <span class="s2">routeNames</span><span class="s1">,</span>
            <span class="s1">routeParamList: </span><span class="s2">initialRouteParamList</span><span class="s1">,</span>
            <span class="s2">routeGetIdList</span><span class="s1">,</span>
          <span class="s1">}</span>
        <span class="s1">),</span>
        <span class="s4">false</span><span class="s1">,</span>
      <span class="s1">];</span>
    <span class="s1">}</span>
    <span class="s5">// We explicitly don't include routeNames, route.params etc. in the dep list</span>
    <span class="s5">// below. We want to avoid forcing a new state to be calculated in those cases</span>
    <span class="s5">// Instead, we handle changes to these in the nextState code below. Note</span>
    <span class="s5">// that some changes to routeConfigs are explicitly ignored, such as changes</span>
    <span class="s5">// to initialParams</span>
    <span class="s5">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  <span class="s1">}, [</span><span class="s2">currentState</span><span class="s1">, </span><span class="s2">router</span><span class="s1">, </span><span class="s2">isStateValid</span><span class="s1">]);</span>

  <span class="s0">const </span><span class="s1">previousRouteKeyListRef </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useRef</span><span class="s1">(</span><span class="s2">routeKeyList</span><span class="s1">);</span>

  <span class="s2">React</span><span class="s1">.</span><span class="s6">useEffect</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s2">previousRouteKeyListRef</span><span class="s1">.</span><span class="s2">current </span><span class="s0">= </span><span class="s2">routeKeyList</span><span class="s1">;</span>
  <span class="s1">});</span>

  <span class="s0">const </span><span class="s1">previousRouteKeyList </span><span class="s0">= </span><span class="s2">previousRouteKeyListRef</span><span class="s1">.</span><span class="s2">current</span><span class="s1">;</span>

  <span class="s0">let </span><span class="s1">state </span><span class="s0">=</span>
    <span class="s5">// If the state isn't initialized, or stale, use the state we initialized instead</span>
    <span class="s5">// The state won't update until there's a change needed in the state we have initalized locally</span>
    <span class="s5">// So it'll be `undefined` or stale until the first navigation event happens</span>
    <span class="s6">isStateInitialized</span><span class="s1">(</span><span class="s2">currentState</span><span class="s1">)</span>
      <span class="s0">? </span><span class="s1">(</span><span class="s2">currentState </span><span class="s0">as </span><span class="s2">State</span><span class="s1">)</span>
      <span class="s0">: </span><span class="s1">(</span><span class="s2">initializedState </span><span class="s0">as </span><span class="s2">State</span><span class="s1">);</span>

  <span class="s0">let </span><span class="s1">nextState</span><span class="s0">: </span><span class="s2">State </span><span class="s0">= </span><span class="s2">state</span><span class="s1">;</span>

  <span class="s0">if </span><span class="s1">(</span>
    <span class="s0">!</span><span class="s6">isArrayEqual</span><span class="s1">(</span><span class="s2">state</span><span class="s1">.</span><span class="s2">routeNames</span><span class="s1">, </span><span class="s2">routeNames</span><span class="s1">) </span><span class="s0">||</span>
    <span class="s0">!</span><span class="s6">isRecordEqual</span><span class="s1">(</span><span class="s2">routeKeyList</span><span class="s1">, </span><span class="s2">previousRouteKeyList</span><span class="s1">)</span>
  <span class="s1">) {</span>
    <span class="s5">// When the list of route names change, the router should handle it to remove invalid routes</span>
    <span class="s2">nextState </span><span class="s0">= </span><span class="s2">router</span><span class="s1">.</span><span class="s6">getStateForRouteNamesChange</span><span class="s1">(</span><span class="s2">state</span><span class="s1">, {</span>
      <span class="s2">routeNames</span><span class="s1">,</span>
      <span class="s2">routeParamList</span><span class="s1">,</span>
      <span class="s2">routeGetIdList</span><span class="s1">,</span>
      <span class="s1">routeKeyChanges: </span><span class="s2">Object</span><span class="s1">.</span><span class="s6">keys</span><span class="s1">(</span><span class="s2">routeKeyList</span><span class="s1">).</span><span class="s6">filter</span><span class="s1">(</span>
        <span class="s1">(</span><span class="s2">name</span><span class="s1">) </span><span class="s0">=&gt;</span>
          <span class="s2">previousRouteKeyList</span><span class="s1">.</span><span class="s6">hasOwnProperty</span><span class="s1">(</span><span class="s2">name</span><span class="s1">) </span><span class="s0">&amp;&amp;</span>
          <span class="s2">routeKeyList</span><span class="s1">[</span><span class="s2">name</span><span class="s1">] </span><span class="s0">!== </span><span class="s2">previousRouteKeyList</span><span class="s1">[</span><span class="s2">name</span><span class="s1">]</span>
      <span class="s1">),</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">previousNestedParamsRef </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useRef</span><span class="s1">(</span><span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">);</span>

  <span class="s2">React</span><span class="s1">.</span><span class="s6">useEffect</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s2">previousNestedParamsRef</span><span class="s1">.</span><span class="s2">current </span><span class="s0">= </span><span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">;</span>
  <span class="s1">}, [</span><span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">]);</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">route</span><span class="s1">?.</span><span class="s2">params</span><span class="s1">) {</span>
    <span class="s0">const </span><span class="s1">previousParams </span><span class="s0">= </span><span class="s2">previousNestedParamsRef</span><span class="s1">.</span><span class="s2">current</span><span class="s1">;</span>

    <span class="s0">let </span><span class="s1">action</span><span class="s0">: </span><span class="s2">CommonActions</span><span class="s1">.</span><span class="s2">Action </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">;</span>

    <span class="s0">if </span><span class="s1">(</span>
      <span class="s0">typeof </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s3">'object' </span><span class="s0">&amp;&amp;</span>
      <span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">state </span><span class="s0">!= </span><span class="s4">null </span><span class="s0">&amp;&amp;</span>
      <span class="s2">route</span><span class="s1">.</span><span class="s2">params </span><span class="s0">!== </span><span class="s2">previousParams</span>
    <span class="s1">) {</span>
      <span class="s5">// If the route was updated with new state, we should reset to it</span>
      <span class="s2">action </span><span class="s0">= </span><span class="s2">CommonActions</span><span class="s1">.</span><span class="s6">reset</span><span class="s1">(</span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">state</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
      <span class="s0">typeof </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">screen </span><span class="s0">=== </span><span class="s3">'string' </span><span class="s0">&amp;&amp;</span>
      <span class="s1">((</span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">initial </span><span class="s0">=== </span><span class="s4">false </span><span class="s0">&amp;&amp; </span><span class="s2">isFirstStateInitialization</span><span class="s1">) </span><span class="s0">||</span>
        <span class="s2">route</span><span class="s1">.</span><span class="s2">params </span><span class="s0">!== </span><span class="s2">previousParams</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s5">// If the route was updated with new screen name and/or params, we should navigate there</span>
      <span class="s2">action </span><span class="s0">= </span><span class="s2">CommonActions</span><span class="s1">.</span><span class="s6">navigate</span><span class="s1">({</span>
        <span class="s1">name: </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">screen</span><span class="s1">,</span>
        <span class="s1">params: </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">params</span><span class="s1">,</span>
        <span class="s1">path: </span><span class="s2">route</span><span class="s1">.</span><span class="s2">params</span><span class="s1">.</span><span class="s2">path</span><span class="s1">,</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s5">// The update should be limited to current navigator only, so we call the router manually</span>
    <span class="s0">const </span><span class="s1">updatedState </span><span class="s0">= </span><span class="s2">action</span>
      <span class="s0">? </span><span class="s2">router</span><span class="s1">.</span><span class="s6">getStateForAction</span><span class="s1">(</span><span class="s2">nextState</span><span class="s1">, </span><span class="s2">action</span><span class="s1">, {</span>
          <span class="s2">routeNames</span><span class="s1">,</span>
          <span class="s2">routeParamList</span><span class="s1">,</span>
          <span class="s2">routeGetIdList</span><span class="s1">,</span>
        <span class="s1">})</span>
      <span class="s0">: </span><span class="s4">null</span><span class="s1">;</span>

    <span class="s2">nextState </span><span class="s0">=</span>
      <span class="s2">updatedState </span><span class="s0">!== </span><span class="s4">null</span>
        <span class="s0">? </span><span class="s2">router</span><span class="s1">.</span><span class="s6">getRehydratedState</span><span class="s1">(</span><span class="s2">updatedState</span><span class="s1">, {</span>
            <span class="s2">routeNames</span><span class="s1">,</span>
            <span class="s2">routeParamList</span><span class="s1">,</span>
            <span class="s2">routeGetIdList</span><span class="s1">,</span>
          <span class="s1">})</span>
        <span class="s0">: </span><span class="s2">nextState</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">shouldUpdate </span><span class="s0">= </span><span class="s2">state </span><span class="s0">!== </span><span class="s2">nextState</span><span class="s1">;</span>

  <span class="s6">useScheduleUpdate</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">shouldUpdate</span><span class="s1">) {</span>
      <span class="s5">// If the state needs to be updated, we'll schedule an update</span>
      <span class="s6">setState</span><span class="s1">(</span><span class="s2">nextState</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">});</span>

  <span class="s5">// The up-to-date state will come in next render, but we don't need to wait for it</span>
  <span class="s5">// We can't use the outdated state since the screens have changed, which will cause error due to mismatched config</span>
  <span class="s5">// So we override the state object we return to use the latest state as soon as possible</span>
  <span class="s2">state </span><span class="s0">= </span><span class="s2">nextState</span><span class="s1">;</span>

  <span class="s2">React</span><span class="s1">.</span><span class="s6">useEffect</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s6">setKey</span><span class="s1">(</span><span class="s2">navigatorKey</span><span class="s1">);</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s6">getIsInitial</span><span class="s1">()) {</span>
      <span class="s5">// If it's not initial render, we need to update the state</span>
      <span class="s5">// This will make sure that our container gets notifier of state changes due to new mounts</span>
      <span class="s5">// This is necessary for proper screen tracking, URL updates etc.</span>
      <span class="s6">setState</span><span class="s1">(</span><span class="s2">nextState</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s1">() </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s5">// We need to clean up state for this navigator on unmount</span>
      <span class="s5">// We do it in a timeout because we need to detect if another navigator mounted in the meantime</span>
      <span class="s5">// For example, if another navigator has started rendering, we should skip cleanup</span>
      <span class="s5">// Otherwise, our cleanup step will cleanup state for the other navigator and re-initialize it</span>
      <span class="s6">setTimeout</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s6">getCurrentState</span><span class="s1">() </span><span class="s0">!== </span><span class="s4">undefined </span><span class="s0">&amp;&amp; </span><span class="s6">getKey</span><span class="s1">() </span><span class="s0">=== </span><span class="s2">navigatorKey</span><span class="s1">) {</span>
          <span class="s6">cleanUpState</span><span class="s1">();</span>
        <span class="s1">}</span>
      <span class="s1">}, </span><span class="s7">0</span><span class="s1">);</span>
    <span class="s1">};</span>
    <span class="s5">// eslint-disable-next-line react-hooks/exhaustive-deps</span>
  <span class="s1">}, []);</span>

  <span class="s5">// We initialize this ref here to avoid a new getState getting initialized</span>
  <span class="s5">// whenever initializedState changes. We want getState to have access to the</span>
  <span class="s5">// latest initializedState, but don't need it to change when that happens</span>
  <span class="s0">const </span><span class="s1">initializedStateRef </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useRef</span><span class="s1">&lt;</span><span class="s2">State</span><span class="s1">&gt;();</span>
  <span class="s2">initializedStateRef</span><span class="s1">.</span><span class="s2">current </span><span class="s0">= </span><span class="s2">initializedState</span><span class="s1">;</span>

  <span class="s0">const </span><span class="s1">getState </span><span class="s0">= </span><span class="s2">React</span><span class="s1">.</span><span class="s6">useCallback</span><span class="s1">(()</span><span class="s0">: </span><span class="s2">State </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">const </span><span class="s1">currentState </span><span class="s0">= </span><span class="s6">getCurrentState</span><span class="s1">();</span>

    <span class="s0">return </span><span class="s6">isStateInitialized</span><span class="s1">(</span><span class="s2">currentState</span><span class="s1">)</span>
      <span class="s0">? </span><span class="s1">(</span><span class="s2">currentState </span><span class="s0">as </span><span class="s2">State</span><span class="s1">)</span>
      <span class="s0">: </span><span class="s1">(</span><span class="s2">initializedStateRef</span><span class="s1">.</span><span class="s2">current </span><span class="s0">as </span><span class="s2">State</span><span class="s1">);</span>
  <span class="s1">}, [</span><span class="s2">getCurrentState</span><span class="s1">, </span><span class="s2">isStateInitialized</span><span class="s1">]);</span>

  <span class="s0">const </span><span class="s1">emitter </span><span class="s0">= </span><span class="s6">useEventEmitter</span><span class="s1">&lt;</span><span class="s2">EventMapCore</span><span class="s1">&lt;</span><span class="s2">State</span><span class="s1">&gt;&gt;((</span><span class="s2">e</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">let </span><span class="s1">routeNames </span><span class="s0">= </span><span class="s1">[];</span>

    <span class="s0">let </span><span class="s1">route</span><span class="s0">: </span><span class="s2">Route</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">&gt; </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">;</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">e</span><span class="s1">.</span><span class="s2">target</span><span class="s1">) {</span>
      <span class="s2">route </span><span class="s0">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">routes</span><span class="s1">.</span><span class="s6">find</span><span class="s1">((</span><span class="s2">route</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">route</span><span class="s1">.</span><span class="s2">key </span><span class="s0">=== </span><span class="s2">e</span><span class="s1">.</span><span class="s2">target</span><span class="s1">);</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s2">route</span><span class="s1">?.</span><span class="s2">name</span><span class="s1">) {</span>
        <span class="s2">routeNames</span><span class="s1">.</span><span class="s6">push</span><span class="s1">(</span><span class="s2">route</span><span class="s1">.</span><span class="s2">name</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s2">route </span><span class="s0">= </span><span class="s2">state</span><span class="s1">.</span><span class="s2">routes</span><span class="s1">[</span><span class="s2">state</span><span class="s1">.</span><span class="s2">index</span><span class="s1">];</span>
      <span class="s2">routeNames</span><span class="s1">.</span><span class="s6">push</span><span class="s1">(</span>
        <span class="s0">...</span><span class="s2">Object</span><span class="s1">.</span><span class="s6">keys</span><span class="s1">(</span><span class="s2">screens</span><span class="s1">).</span><span class="s6">filter</span><span class="s1">((</span><span class="s2">name</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">route</span><span class="s1">?.</span><span class="s2">name </span><span class="s0">=== </span><span class="s2">name</span><span class="s1">)</span>
      <span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">route </span><span class="s0">== </span><span class="s4">null</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">const </span><span class="s1">navigation </span><span class="s0">= </span><span class="s2">descriptors</span><span class="s1">[</span><span class="s2">route</span><span class="s1">.</span><span class="s2">key</span><span class="s1">].</span><span class="s2">navigation</span><span class="s1">;</span>

    <span class="s0">const </span><span class="s1">listeners </span><span class="s0">= </span><span class="s1">([] </span><span class="s0">as </span><span class="s1">(((</span><span class="s2">e</span><span class="s0">: </span><span class="s2">any</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">void</span><span class="s1">) </span><span class="s0">| </span><span class="s2">undefined</span><span class="s1">)[])</span>
      <span class="s1">.</span><span class="s6">concat</span><span class="s1">(</span>
        <span class="s5">// Get an array of listeners for all screens + common listeners on navigator</span>
        <span class="s0">...</span><span class="s1">[</span>
          <span class="s2">screenListeners</span><span class="s1">,</span>
          <span class="s0">...</span><span class="s2">routeNames</span><span class="s1">.</span><span class="s6">map</span><span class="s1">((</span><span class="s2">name</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
            <span class="s0">const </span><span class="s1">{ listeners } </span><span class="s0">= </span><span class="s2">screens</span><span class="s1">[</span><span class="s2">name</span><span class="s1">].</span><span class="s2">props</span><span class="s1">;</span>
            <span class="s0">return </span><span class="s2">listeners</span><span class="s1">;</span>
          <span class="s1">}),</span>
        <span class="s1">].</span><span class="s6">map</span><span class="s1">((</span><span class="s2">listeners</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
          <span class="s0">const </span><span class="s1">map </span><span class="s0">=</span>
            <span class="s0">typeof </span><span class="s2">listeners </span><span class="s0">=== </span><span class="s3">'function'</span>
              <span class="s0">? </span><span class="s6">listeners</span><span class="s1">({ route: </span><span class="s2">route </span><span class="s0">as </span><span class="s2">any</span><span class="s1">, </span><span class="s2">navigation </span><span class="s1">})</span>
              <span class="s0">: </span><span class="s2">listeners</span><span class="s1">;</span>

          <span class="s0">return </span><span class="s2">map</span>
            <span class="s0">? </span><span class="s2">Object</span><span class="s1">.</span><span class="s6">keys</span><span class="s1">(</span><span class="s2">map</span><span class="s1">)</span>
                <span class="s1">.</span><span class="s6">filter</span><span class="s1">((</span><span class="s2">type</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">type </span><span class="s0">=== </span><span class="s2">e</span><span class="s1">.</span><span class="s2">type</span><span class="s1">)</span>
                <span class="s1">.</span><span class="s6">map</span><span class="s1">((</span><span class="s2">type</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">map</span><span class="s1">?.[</span><span class="s2">type</span><span class="s1">])</span>
            <span class="s0">: </span><span class="s4">undefined</span><span class="s1">;</span>
        <span class="s1">})</span>
      <span class="s1">)</span>
      <span class="s5">// We don't want same listener to be called multiple times for same event</span>
      <span class="s5">// So we remove any duplicate functions from the array</span>
      <span class="s1">.</span><span class="s6">filter</span><span class="s1">((</span><span class="s2">cb</span><span class="s1">, </span><span class="s2">i</span><span class="s1">, </span><span class="s2">self</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">cb </span><span class="s0">&amp;&amp; </span><span class="s2">self</span><span class="s1">.</span><span class="s6">lastIndexOf</span><span class="s1">(</span><span class="s2">cb</span><span class="s1">) </span><span class="s0">=== </span><span class="s2">i</span><span class="s1">);</span>

    <span class="s2">listeners</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">listener</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s6">listener</span><span class="s1">?.(</span><span class="s2">e</span><span class="s1">));</span>
  <span class="s1">});</span>

  <span class="s6">useFocusEvents</span><span class="s1">({ </span><span class="s2">state</span><span class="s1">, </span><span class="s2">emitter </span><span class="s1">});</span>

  <span class="s2">React</span><span class="s1">.</span><span class="s6">useEffect</span><span class="s1">(() </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s2">emitter</span><span class="s1">.</span><span class="s6">emit</span><span class="s1">({ type: </span><span class="s3">'state'</span><span class="s1">, data: { </span><span class="s2">state </span><span class="s1">} });</span>
  <span class="s1">}, [</span><span class="s2">emitter</span><span class="s1">, </span><span class="s2">state</span><span class="s1">]);</span>

  <span class="s0">const </span><span class="s1">{ </span><span class="s2">listeners</span><span class="s1">: childListeners, addListener } </span><span class="s0">= </span><span class="s6">useChildListeners</span><span class="s1">();</span>

  <span class="s0">const </span><span class="s1">{ keyedListeners, addKeyedListener } </span><span class="s0">= </span><span class="s6">useKeyedChildListeners</span><span class="s1">();</span>

  <span class="s0">const </span><span class="s1">onAction </span><span class="s0">= </span><span class="s6">useOnAction</span><span class="s1">({</span>
    <span class="s2">router</span><span class="s1">,</span>
    <span class="s2">getState</span><span class="s1">,</span>
    <span class="s2">setState</span><span class="s1">,</span>
    <span class="s1">key: </span><span class="s2">route</span><span class="s1">?.</span><span class="s2">key</span><span class="s1">,</span>
    <span class="s1">actionListeners: </span><span class="s2">childListeners</span><span class="s1">.</span><span class="s2">action</span><span class="s1">,</span>
    <span class="s1">beforeRemoveListeners: </span><span class="s2">keyedListeners</span><span class="s1">.</span><span class="s2">beforeRemove</span><span class="s1">,</span>
    <span class="s1">routerConfigOptions: {</span>
      <span class="s2">routeNames</span><span class="s1">,</span>
      <span class="s2">routeParamList</span><span class="s1">,</span>
      <span class="s2">routeGetIdList</span><span class="s1">,</span>
    <span class="s1">},</span>
    <span class="s2">emitter</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s0">const </span><span class="s1">onRouteFocus </span><span class="s0">= </span><span class="s6">useOnRouteFocus</span><span class="s1">({</span>
    <span class="s2">router</span><span class="s1">,</span>
    <span class="s1">key: </span><span class="s2">route</span><span class="s1">?.</span><span class="s2">key</span><span class="s1">,</span>
    <span class="s2">getState</span><span class="s1">,</span>
    <span class="s2">setState</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s0">const </span><span class="s1">navigation </span><span class="s0">= </span><span class="s2">useNavigationHelpers</span><span class="s0">&lt;</span>
    <span class="s2">State</span><span class="s1">,</span>
    <span class="s2">ActionHelpers</span><span class="s1">,</span>
    <span class="s2">NavigationAction</span><span class="s1">,</span>
    <span class="s2">EventMap</span>
  <span class="s0">&gt;</span><span class="s1">({</span>
    <span class="s1">id: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">id</span><span class="s1">,</span>
    <span class="s2">onAction</span><span class="s1">,</span>
    <span class="s2">getState</span><span class="s1">,</span>
    <span class="s2">emitter</span><span class="s1">,</span>
    <span class="s2">router</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s6">useFocusedListenersChildrenAdapter</span><span class="s1">({</span>
    <span class="s2">navigation</span><span class="s1">,</span>
    <span class="s1">focusedListeners: </span><span class="s2">childListeners</span><span class="s1">.</span><span class="s2">focus</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s6">useOnGetState</span><span class="s1">({</span>
    <span class="s2">getState</span><span class="s1">,</span>
    <span class="s1">getStateListeners: </span><span class="s2">keyedListeners</span><span class="s1">.</span><span class="s2">getState</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s0">const </span><span class="s1">descriptors </span><span class="s0">= </span><span class="s2">useDescriptors</span><span class="s0">&lt;</span>
    <span class="s2">State</span><span class="s1">,</span>
    <span class="s2">ActionHelpers</span><span class="s1">,</span>
    <span class="s2">ScreenOptions</span><span class="s1">,</span>
    <span class="s2">EventMap</span>
  <span class="s0">&gt;</span><span class="s1">({</span>
    <span class="s2">state</span><span class="s1">,</span>
    <span class="s2">screens</span><span class="s1">,</span>
    <span class="s2">navigation</span><span class="s1">,</span>
    <span class="s1">screenOptions: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">screenOptions</span><span class="s1">,</span>
    <span class="s1">defaultScreenOptions: </span><span class="s2">options</span><span class="s1">.</span><span class="s2">defaultScreenOptions</span><span class="s1">,</span>
    <span class="s2">onAction</span><span class="s1">,</span>
    <span class="s2">getState</span><span class="s1">,</span>
    <span class="s2">setState</span><span class="s1">,</span>
    <span class="s2">onRouteFocus</span><span class="s1">,</span>
    <span class="s2">addListener</span><span class="s1">,</span>
    <span class="s2">addKeyedListener</span><span class="s1">,</span>
    <span class="s2">router</span><span class="s1">,</span>
    <span class="s5">// @ts-expect-error: this should have both core and custom events, but too much work right now</span>
    <span class="s2">emitter</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s6">useCurrentRender</span><span class="s1">({</span>
    <span class="s2">state</span><span class="s1">,</span>
    <span class="s2">navigation</span><span class="s1">,</span>
    <span class="s2">descriptors</span><span class="s1">,</span>
  <span class="s1">});</span>

  <span class="s0">const </span><span class="s1">NavigationContent </span><span class="s0">= </span><span class="s6">useComponent</span><span class="s1">((</span><span class="s2">children</span><span class="s0">: </span><span class="s2">React</span><span class="s1">.</span><span class="s2">ReactNode</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">(</span>
    <span class="s8">&lt;</span><span class="s9">NavigationHelpersContext.Provider </span><span class="s11">value</span><span class="s0">=</span><span class="s10">{</span><span class="s2">navigation</span><span class="s10">}</span><span class="s8">&gt;</span>
      <span class="s8">&lt;</span><span class="s9">PreventRemoveProvider</span><span class="s8">&gt;</span><span class="s10">{</span><span class="s2">children</span><span class="s10">}</span><span class="s8">&lt;/</span><span class="s9">PreventRemoveProvider</span><span class="s8">&gt;</span>
    <span class="s8">&lt;/</span><span class="s9">NavigationHelpersContext.Provider</span><span class="s8">&gt;</span>
  <span class="s1">));</span>

  <span class="s0">return </span><span class="s1">{</span>
    <span class="s2">state</span><span class="s1">,</span>
    <span class="s2">navigation</span><span class="s1">,</span>
    <span class="s2">descriptors</span><span class="s1">,</span>
    <span class="s2">NavigationContent</span><span class="s1">,</span>
  <span class="s1">};</span>
<span class="s1">}</span>
</pre>
</body>
</html>