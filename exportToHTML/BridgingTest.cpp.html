<html>
<head>
<title>BridgingTest.cpp</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
BridgingTest.cpp</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#include </span><span class="s3">&quot;BridgingTest.h&quot;</span>

<span class="s4">namespace </span><span class="s1">facebook::react {</span>

<span class="s4">using namespace </span><span class="s1">std::literals</span><span class="s4">;</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">jsiTest) {</span>
  <span class="s1">jsi::Value value = </span><span class="s4">true;</span>
  <span class="s1">jsi::Value string = jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;hello&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">jsi::Value object = jsi::Object(rt)</span><span class="s4">;</span>
  <span class="s1">jsi::Value array = jsi::Array::createWithElements(rt</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">object)</span><span class="s4">;</span>
  <span class="s1">jsi::Value func = function(</span><span class="s3">&quot;() =&gt; {}&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s0">// The bridging mechanism needs to know how to copy and downcast values.</span>
  <span class="s1">EXPECT_NO_THROW(bridging::fromJs&lt;jsi::Value&gt;(rt</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(bridging::fromJs&lt;jsi::String&gt;(rt</span><span class="s4">, </span><span class="s1">string</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(bridging::fromJs&lt;jsi::Object&gt;(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(bridging::fromJs&lt;jsi::Array&gt;(rt</span><span class="s4">, </span><span class="s1">array</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(bridging::fromJs&lt;jsi::Function&gt;(rt</span><span class="s4">, </span><span class="s1">func</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>

  <span class="s0">// Should throw when attempting an invalid cast.</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;jsi::Object&gt;(rt</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;jsi::String&gt;(rt</span><span class="s4">, </span><span class="s1">array</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;jsi::Array&gt;(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;jsi::Array&gt;(rt</span><span class="s4">, </span><span class="s1">string</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;jsi::Array&gt;(rt</span><span class="s4">, </span><span class="s1">func</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>

  <span class="s0">// Should be able to generically no-op convert JSI.</span>
  <span class="s1">EXPECT_NO_THROW(bridging::toJs(rt</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(bridging::toJs(rt</span><span class="s4">, </span><span class="s1">string.asString(rt)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(bridging::toJs(rt</span><span class="s4">, </span><span class="s1">object.asObject(rt)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(bridging::toJs(rt</span><span class="s4">, </span><span class="s1">array.asObject(rt).asArray(rt)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(</span>
      <span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">func.asObject(rt).asFunction(rt)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">boolTest) {</span>
  <span class="s1">EXPECT_TRUE(bridging::fromJs&lt;</span><span class="s4">bool</span><span class="s1">&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s4">true</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(bridging::fromJs&lt;</span><span class="s4">bool</span><span class="s1">&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s4">false</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;</span><span class="s4">bool</span><span class="s1">&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(bridging::toJs(rt</span><span class="s4">, true</span><span class="s1">).asBool())</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(bridging::toJs(rt</span><span class="s4">, false</span><span class="s1">).asBool())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">numberTest) {</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">bridging::fromJs&lt;</span><span class="s4">int</span><span class="s1">&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FLOAT_EQ(</span><span class="s5">1.2f</span><span class="s4">, </span><span class="s1">bridging::fromJs&lt;</span><span class="s4">float</span><span class="s1">&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s5">1.2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_DOUBLE_EQ(</span><span class="s5">1.2</span><span class="s4">, </span><span class="s1">bridging::fromJs&lt;</span><span class="s4">double</span><span class="s1">&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s5">1.2</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;</span><span class="s4">double</span><span class="s1">&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s4">true</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, static_cast</span><span class="s1">&lt;</span><span class="s4">int</span><span class="s1">&gt;(bridging::toJs(rt</span><span class="s4">, </span><span class="s5">1</span><span class="s1">).asNumber()))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FLOAT_EQ(</span>
      <span class="s5">1.2f</span><span class="s4">, static_cast</span><span class="s1">&lt;</span><span class="s4">float</span><span class="s1">&gt;(bridging::toJs(rt</span><span class="s4">, </span><span class="s5">1.2f</span><span class="s1">).asNumber()))</span><span class="s4">;</span>
  <span class="s1">EXPECT_DOUBLE_EQ(</span><span class="s5">1.2</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s5">1.2</span><span class="s1">).asNumber())</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span>
      <span class="s5">42</span><span class="s4">,</span>
      <span class="s4">static_cast</span><span class="s1">&lt;uint32_t&gt;(</span>
          <span class="s1">bridging::toJs(rt</span><span class="s4">, static_cast</span><span class="s1">&lt;uint32_t&gt;(</span><span class="s5">42</span><span class="s1">)).asNumber()))</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span>
      <span class="s1">-</span><span class="s5">42</span><span class="s4">,</span>
      <span class="s4">static_cast</span><span class="s1">&lt;uint32_t&gt;(</span>
          <span class="s1">bridging::toJs(rt</span><span class="s4">, static_cast</span><span class="s1">&lt;uint32_t&gt;(-</span><span class="s5">42</span><span class="s1">)).asNumber()))</span><span class="s4">;</span>

  <span class="s1">EXPECT_FALSE(</span>
      <span class="s1">-</span><span class="s5">42 </span><span class="s1">==</span>
      <span class="s4">static_cast</span><span class="s1">&lt;int32_t&gt;(</span>
          <span class="s1">bridging::toJs(rt</span><span class="s4">, static_cast</span><span class="s1">&lt;uint32_t&gt;(-</span><span class="s5">42</span><span class="s1">)).asNumber()))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">stringTest) {</span>
  <span class="s4">auto </span><span class="s1">string = jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;hello&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span><span class="s3">&quot;hello&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s1">bridging::fromJs&lt;std::string&gt;(rt</span><span class="s4">, </span><span class="s1">string</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(bridging::fromJs&lt;std::string&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(</span>
      <span class="s1">jsi::String::strictEquals(rt</span><span class="s4">, </span><span class="s1">string</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s3">&quot;hello&quot;</span><span class="s1">)))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(</span>
      <span class="s1">jsi::String::strictEquals(rt</span><span class="s4">, </span><span class="s1">string</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s3">&quot;hello&quot;</span><span class="s1">s)))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(</span>
      <span class="s1">jsi::String::strictEquals(rt</span><span class="s4">, </span><span class="s1">string</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s3">&quot;hello&quot;</span><span class="s1">sv)))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">objectTest) {</span>
  <span class="s4">auto </span><span class="s1">object = jsi::Object(rt)</span><span class="s4">;</span>
  <span class="s1">object.setProperty(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">omap =</span>
      <span class="s1">bridging::fromJs&lt;std::map&lt;std::string</span><span class="s4">, </span><span class="s1">std::string&gt;&gt;(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">umap = bridging::fromJs&lt;std::unordered_map&lt;std::string</span><span class="s4">, </span><span class="s1">std::string&gt;&gt;(</span>
      <span class="s1">rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">bmap = bridging::fromJs&lt;butter::map&lt;std::string</span><span class="s4">, </span><span class="s1">std::string&gt;&gt;(</span>
      <span class="s1">rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">omap.size())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">umap.size())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">bmap.size())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s1">omap[</span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s1">umap[</span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s1">bmap[</span><span class="s3">&quot;foo&quot;</span><span class="s1">])</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span>
      <span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">,</span>
      <span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">omap</span><span class="s4">, </span><span class="s1">invoker)</span>
          <span class="s1">.getProperty(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>
          <span class="s1">.asString(rt)</span>
          <span class="s1">.utf8(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">,</span>
      <span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">umap</span><span class="s4">, </span><span class="s1">invoker)</span>
          <span class="s1">.getProperty(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>
          <span class="s1">.asString(rt)</span>
          <span class="s1">.utf8(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">,</span>
      <span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">bmap</span><span class="s4">, </span><span class="s1">invoker)</span>
          <span class="s1">.getProperty(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span>
          <span class="s1">.asString(rt)</span>
          <span class="s1">.utf8(rt))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">hostObjectTest) {</span>
  <span class="s4">struct </span><span class="s1">TestHostObject : </span><span class="s4">public </span><span class="s1">jsi::HostObject {</span>
    <span class="s1">jsi::Value get(jsi::Runtime &amp;rt</span><span class="s4">, const </span><span class="s1">jsi::PropNameID &amp;name) override {</span>
      <span class="s4">if </span><span class="s1">(name.utf8(rt) == </span><span class="s3">&quot;test&quot;</span><span class="s1">) {</span>
        <span class="s4">return </span><span class="s1">jsi::Value(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
      <span class="s1">}</span>
      <span class="s4">return </span><span class="s1">jsi::Value::undefined()</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">hostobject = std::make_shared&lt;TestHostObject&gt;()</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">object = bridging::toJs(rt</span><span class="s4">, </span><span class="s1">hostobject)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">object.getProperty(rt</span><span class="s4">, </span><span class="s3">&quot;test&quot;</span><span class="s1">).asNumber())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s1">hostobject</span><span class="s4">, </span><span class="s1">bridging::fromJs&lt;</span><span class="s4">decltype</span><span class="s1">(hostobject)&gt;(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">weakbjectTest) {</span>
  <span class="s4">auto </span><span class="s1">object = jsi::Object(rt)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">weakobject = jsi::WeakObject(rt</span><span class="s4">, </span><span class="s1">object)</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(jsi::Object::strictEquals(</span>
      <span class="s1">rt</span><span class="s4">,</span>
      <span class="s1">object</span><span class="s4">,</span>
      <span class="s1">bridging::fromJs&lt;jsi::WeakObject&gt;(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">invoker)</span>
          <span class="s1">.lock(rt)</span>
          <span class="s1">.asObject(rt)))</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(jsi::Object::strictEquals(</span>
      <span class="s1">rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">weakobject).asObject(rt)))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">arrayTest) {</span>
  <span class="s4">auto </span><span class="s1">vec = std::vector({</span><span class="s3">&quot;foo&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">s})</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">array = jsi::Array::createWithElements(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span>
      <span class="s1">vec</span><span class="s4">, </span><span class="s1">bridging::fromJs&lt;std::vector&lt;std::string&gt;&gt;(rt</span><span class="s4">, </span><span class="s1">array</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(vec.size()</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">vec</span><span class="s4">, </span><span class="s1">invoker).size(rt))</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(size_t i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; vec.size()</span><span class="s4">; </span><span class="s1">i++) {</span>
    <span class="s1">EXPECT_EQ(</span>
        <span class="s1">vec[i]</span><span class="s4">,</span>
        <span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">vec</span><span class="s4">, </span><span class="s1">invoker)</span>
            <span class="s1">.getValueAtIndex(rt</span><span class="s4">, </span><span class="s1">i)</span>
            <span class="s1">.asString(rt)</span>
            <span class="s1">.utf8(rt))</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s1">EXPECT_EQ(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::make_pair(</span><span class="s5">1</span><span class="s4">, </span><span class="s3">&quot;2&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::make_tuple(</span><span class="s5">1</span><span class="s4">, </span><span class="s3">&quot;2&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::array&lt;</span><span class="s4">int, </span><span class="s5">2</span><span class="s1">&gt;{</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">invoker).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::deque&lt;</span><span class="s4">int</span><span class="s1">&gt;{</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">invoker).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::list&lt;</span><span class="s4">int</span><span class="s1">&gt;{</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">invoker).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s5">2</span><span class="s4">,</span>
      <span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::initializer_list&lt;</span><span class="s4">int</span><span class="s1">&gt;{</span><span class="s5">1</span><span class="s4">, </span><span class="s5">2</span><span class="s1">}</span><span class="s4">, </span><span class="s1">invoker).size(rt))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">functionTest) {</span>
  <span class="s4">auto </span><span class="s1">object = jsi::Object(rt)</span><span class="s4">;</span>
  <span class="s1">object.setProperty(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">lambda = [](std::map&lt;std::string</span><span class="s4">, </span><span class="s1">std::string&gt; map</span><span class="s4">, </span><span class="s1">std::string key) {</span>
    <span class="s4">return </span><span class="s1">map[key]</span><span class="s4">;</span>
  <span class="s1">}</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">func = bridging::toJs(rt</span><span class="s4">, </span><span class="s1">lambda</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span>
      <span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">,</span>
      <span class="s1">func.call(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span>
          <span class="s1">.asString(rt)</span>
          <span class="s1">.utf8(rt))</span><span class="s4">;</span>

  <span class="s0">// Should throw if not enough arguments are passed or are the wrong types.</span>
  <span class="s1">EXPECT_JSI_THROW(func.call(rt</span><span class="s4">, </span><span class="s1">object))</span><span class="s4">;</span>
  <span class="s1">EXPECT_JSI_THROW(func.call(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s5">1</span><span class="s1">)))</span><span class="s4">;</span>

  <span class="s0">// Test with non-capturing lambda converted to function pointer.</span>
  <span class="s1">func = bridging::toJs(rt</span><span class="s4">, </span><span class="s1">+lambda</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span>
      <span class="s3">&quot;bar&quot;</span><span class="s1">s</span><span class="s4">,</span>
      <span class="s1">func.call(rt</span><span class="s4">, </span><span class="s1">object</span><span class="s4">, </span><span class="s1">jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span>
          <span class="s1">.asString(rt)</span>
          <span class="s1">.utf8(rt))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">syncCallbackTest) {</span>
  <span class="s4">auto </span><span class="s1">fn = function(</span><span class="s3">&quot;(a, b) =&gt; a + b&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;SyncCallback&lt;std::string(std::string</span><span class="s4">, int</span><span class="s1">)&gt;&gt;(</span>
      <span class="s1">rt</span><span class="s4">, </span><span class="s1">fn</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">foo = </span><span class="s3">&quot;foo&quot;</span><span class="s1">s</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span><span class="s3">&quot;foo1&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s1">cb(foo</span><span class="s4">, </span><span class="s5">1</span><span class="s1">))</span><span class="s4">; </span><span class="s0">// Tests lvalue string</span>
  <span class="s1">EXPECT_EQ(</span><span class="s3">&quot;bar2&quot;</span><span class="s4">, </span><span class="s1">cb(</span><span class="s3">&quot;bar&quot;</span><span class="s4">, </span><span class="s5">2</span><span class="s1">))</span><span class="s4">; </span><span class="s0">// Tests rvalue C string</span>
  <span class="s1">EXPECT_TRUE(fn.isFunction(rt))</span><span class="s4">; </span><span class="s0">// Ensure the function wasn't invalidated.</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">syncCallbackImplicitBridgingTest) {</span>
  <span class="s1">{ </span><span class="s0">// Value</span>
    <span class="s4">auto </span><span class="s1">fn = function(</span><span class="s3">&quot;(a, b) =&gt; a + b&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;SyncCallback&lt;std::string(jsi::Value</span><span class="s4">, int</span><span class="s1">)&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">fn</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
    <span class="s1">jsi::Value foo(jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span><span class="s4">;</span>

    <span class="s1">EXPECT_EQ(cb(std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(cb(jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s3">&quot;bar2&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_TRUE(fn.isFunction(rt))</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">{ </span><span class="s0">// Object</span>
    <span class="s4">auto </span><span class="s1">fn = function(</span><span class="s3">&quot;(a, b) =&gt; a.obj + b&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;SyncCallback&lt;std::string(jsi::Object</span><span class="s4">, int</span><span class="s1">)&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">fn</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

    <span class="s1">jsi::Object foo(rt)</span><span class="s4">;</span>
    <span class="s1">foo.setProperty(rt</span><span class="s4">, </span><span class="s3">&quot;obj&quot;</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">EXPECT_EQ(cb(std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_TRUE(fn.isFunction(rt))</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">{ </span><span class="s0">// String</span>
    <span class="s4">auto </span><span class="s1">fn = function(</span><span class="s3">&quot;(a, b) =&gt; a + b&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;SyncCallback&lt;std::string(jsi::String</span><span class="s4">, int</span><span class="s1">)&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">fn</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
    <span class="s1">jsi::String foo(jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span><span class="s4">;</span>

    <span class="s1">EXPECT_EQ(cb(std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(cb(jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">, </span><span class="s3">&quot;bar2&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_TRUE(fn.isFunction(rt))</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">{ </span><span class="s0">// Array</span>
    <span class="s4">auto </span><span class="s1">fn = function(</span><span class="s3">&quot;(a, b) =&gt; a[0] + b&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;SyncCallback&lt;std::string(jsi::Array</span><span class="s4">, int</span><span class="s1">)&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">fn</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

    <span class="s1">jsi::Array foo(rt</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">foo.setValueAtIndex(rt</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span><span class="s4">;</span>

    <span class="s1">EXPECT_EQ(cb(std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">EXPECT_TRUE(fn.isFunction(rt))</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">asyncCallbackTest) {</span>
  <span class="s1">std::string output</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">func = std::function&lt;</span><span class="s4">void</span><span class="s1">(std::string)&gt;([&amp;](</span><span class="s4">auto </span><span class="s1">str) { output = str</span><span class="s4">; </span><span class="s1">})</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;AsyncCallback&lt;</span><span class="s4">decltype</span><span class="s1">(func)</span><span class="s4">, </span><span class="s1">std::string&gt;&gt;(</span>
      <span class="s1">rt</span><span class="s4">, </span><span class="s1">function(</span><span class="s3">&quot;(func, str) =&gt; func(str)&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

  <span class="s1">cb(func</span><span class="s4">, </span><span class="s3">&quot;hello&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s1">flushQueue()</span><span class="s4">; </span><span class="s0">// Run scheduled async work</span>

  <span class="s1">EXPECT_EQ(</span><span class="s3">&quot;hello&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s1">output)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">asyncCallbackImplicitBridgingTest) {</span>
  <span class="s1">std::string output</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">func = std::function&lt;</span><span class="s4">void</span><span class="s1">(std::string)&gt;([&amp;](</span><span class="s4">auto </span><span class="s1">str) { output = str</span><span class="s4">; </span><span class="s1">})</span><span class="s4">;</span>
  <span class="s1">{ </span><span class="s0">// Value</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;AsyncCallback&lt;</span><span class="s4">decltype</span><span class="s1">(func)</span><span class="s4">, </span><span class="s1">jsi::Value</span><span class="s4">, int</span><span class="s1">&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">function(</span><span class="s3">&quot;(func, a, b) =&gt; func(a + b)&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
    <span class="s1">jsi::Value foo(jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span><span class="s4">;</span>

    <span class="s1">cb(func</span><span class="s4">, </span><span class="s1">std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">flushQueue()</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(output</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">cb(func</span><span class="s4">, </span><span class="s1">jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">flushQueue()</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(output</span><span class="s4">, </span><span class="s3">&quot;bar2&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">output.clear()</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">{ </span><span class="s0">// Object</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;AsyncCallback&lt;</span><span class="s4">decltype</span><span class="s1">(func)</span><span class="s4">, </span><span class="s1">jsi::Object</span><span class="s4">, int</span><span class="s1">&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">function(</span><span class="s3">&quot;(func, a, b) =&gt; func(a.obj + b)&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

    <span class="s1">jsi::Object foo(rt)</span><span class="s4">;</span>
    <span class="s1">foo.setProperty(rt</span><span class="s4">, </span><span class="s3">&quot;obj&quot;</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">cb(func</span><span class="s4">, </span><span class="s1">std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">flushQueue()</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(output</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">output.clear()</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">{ </span><span class="s0">// String</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;AsyncCallback&lt;</span><span class="s4">decltype</span><span class="s1">(func)</span><span class="s4">, </span><span class="s1">jsi::String</span><span class="s4">, int</span><span class="s1">&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">function(</span><span class="s3">&quot;(func, a, b) =&gt; func(a + b)&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
    <span class="s1">jsi::String foo(jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span><span class="s4">;</span>

    <span class="s1">cb(func</span><span class="s4">, </span><span class="s1">std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">flushQueue()</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(output</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">cb(func</span><span class="s4">, </span><span class="s1">jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">)</span><span class="s4">, </span><span class="s5">2</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">flushQueue()</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(output</span><span class="s4">, </span><span class="s3">&quot;bar2&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">output.clear()</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">{ </span><span class="s0">// Array</span>
    <span class="s4">auto </span><span class="s1">fn = function(</span><span class="s3">&quot;(func, a, b) =&gt; func(a[0] + b)&quot;</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">cb = bridging::fromJs&lt;AsyncCallback&lt;</span><span class="s4">decltype</span><span class="s1">(func)</span><span class="s4">, </span><span class="s1">jsi::Array</span><span class="s4">, int</span><span class="s1">&gt;&gt;(</span>
        <span class="s1">rt</span><span class="s4">, </span><span class="s1">fn</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>

    <span class="s1">jsi::Array foo(rt</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">foo.setValueAtIndex(rt</span><span class="s4">, </span><span class="s5">0</span><span class="s4">, </span><span class="s1">jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;foo&quot;</span><span class="s1">))</span><span class="s4">;</span>

    <span class="s1">cb(func</span><span class="s4">, </span><span class="s1">std::move(foo)</span><span class="s4">, </span><span class="s5">1</span><span class="s1">)</span><span class="s4">;</span>
    <span class="s1">flushQueue()</span><span class="s4">;</span>
    <span class="s1">EXPECT_EQ(output</span><span class="s4">, </span><span class="s3">&quot;foo1&quot;</span><span class="s1">)</span><span class="s4">;</span>

    <span class="s1">output.clear()</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">promiseTest) {</span>
  <span class="s4">auto </span><span class="s1">func = function(</span>
      <span class="s3">&quot;(promise, obj) =&gt; {&quot;</span>
      <span class="s3">&quot;  promise.then(&quot;</span>
      <span class="s3">&quot;    (res) =&gt; { obj.res = res; },&quot;</span>
      <span class="s3">&quot;    (err) =&gt; { obj.err = err; }&quot;</span>
      <span class="s3">&quot;  )&quot;</span>
      <span class="s3">&quot;}&quot;</span><span class="s1">)</span><span class="s4">;</span>

  <span class="s4">auto </span><span class="s1">promise = AsyncPromise&lt;std::vector&lt;std::string&gt;&gt;(rt</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">output = jsi::Object(rt)</span><span class="s4">;</span>

  <span class="s1">func.call(rt</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">promise</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">, </span><span class="s1">output)</span><span class="s4">;</span>
  <span class="s1">promise.resolve({</span><span class="s3">&quot;foo&quot;</span><span class="s1">s</span><span class="s4">, </span><span class="s3">&quot;bar&quot;</span><span class="s1">s})</span><span class="s4">;</span>
  <span class="s1">flushQueue()</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">output.getPropertyNames(rt).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">2</span><span class="s4">, </span><span class="s1">output.getProperty(rt</span><span class="s4">, </span><span class="s3">&quot;res&quot;</span><span class="s1">).asObject(rt).asArray(rt).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(promise.resolve({</span><span class="s3">&quot;ignored&quot;</span><span class="s1">}))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(promise.reject(</span><span class="s3">&quot;ignored&quot;</span><span class="s1">))</span><span class="s4">;</span>

  <span class="s1">promise = AsyncPromise&lt;std::vector&lt;std::string&gt;&gt;(rt</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">;</span>
  <span class="s1">output = jsi::Object(rt)</span><span class="s4">;</span>

  <span class="s1">func.call(rt</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">promise</span><span class="s4">, </span><span class="s1">invoker)</span><span class="s4">, </span><span class="s1">output)</span><span class="s4">;</span>
  <span class="s1">promise.reject(</span><span class="s3">&quot;fail&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">flushQueue()</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">output.getPropertyNames(rt).size(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s3">&quot;fail&quot;</span><span class="s1">s</span><span class="s4">,</span>
      <span class="s1">output.getProperty(rt</span><span class="s4">, </span><span class="s3">&quot;err&quot;</span><span class="s1">)</span>
          <span class="s1">.asObject(rt)</span>
          <span class="s1">.getProperty(rt</span><span class="s4">, </span><span class="s3">&quot;message&quot;</span><span class="s1">)</span>
          <span class="s1">.asString(rt)</span>
          <span class="s1">.utf8(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(promise.resolve({</span><span class="s3">&quot;ignored&quot;</span><span class="s1">}))</span><span class="s4">;</span>
  <span class="s1">EXPECT_NO_THROW(promise.reject(</span><span class="s3">&quot;ignored&quot;</span><span class="s1">))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">optionalTest) {</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s5">1</span><span class="s4">, </span><span class="s1">bridging::fromJs&lt;std::optional&lt;</span><span class="s4">int</span><span class="s1">&gt;&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s5">1</span><span class="s4">,</span>
      <span class="s1">bridging::fromJs&lt;std::optional&lt;</span><span class="s4">int</span><span class="s1">&gt;&gt;(</span>
          <span class="s1">rt</span><span class="s4">, </span><span class="s1">std::make_optional(jsi::Value(</span><span class="s5">1</span><span class="s1">))</span><span class="s4">, </span><span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span>
      <span class="s3">&quot;hi&quot;</span><span class="s1">s</span><span class="s4">,</span>
      <span class="s1">bridging::fromJs&lt;std::optional&lt;std::string&gt;&gt;(</span>
          <span class="s1">rt</span><span class="s4">,</span>
          <span class="s1">std::make_optional(jsi::String::createFromAscii(rt</span><span class="s4">, </span><span class="s3">&quot;hi&quot;</span><span class="s1">))</span><span class="s4">,</span>
          <span class="s1">invoker))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(</span>
      <span class="s1">bridging::fromJs&lt;std::optional&lt;</span><span class="s4">int</span><span class="s1">&gt;&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value::undefined()</span><span class="s4">, </span><span class="s1">invoker)</span>
          <span class="s1">.has_value())</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE(</span>
      <span class="s1">bridging::fromJs&lt;std::optional&lt;</span><span class="s4">int</span><span class="s1">&gt;&gt;(rt</span><span class="s4">, </span><span class="s1">jsi::Value::null()</span><span class="s4">, </span><span class="s1">invoker)</span>
          <span class="s1">.has_value())</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::optional&lt;</span><span class="s4">int</span><span class="s1">&gt;()</span><span class="s4">, </span><span class="s1">invoker).isNull())</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(</span><span class="s5">1</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">std::optional&lt;</span><span class="s4">int</span><span class="s1">&gt;(</span><span class="s5">1</span><span class="s1">)</span><span class="s4">, </span><span class="s1">invoker).asNumber())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">pointerTest) {</span>
  <span class="s4">auto </span><span class="s1">str = </span><span class="s3">&quot;hi&quot;</span><span class="s1">s</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">unique = std::make_unique&lt;std::string&gt;(str)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">shared = std::make_shared&lt;std::string&gt;(str)</span><span class="s4">;</span>
  <span class="s4">auto </span><span class="s1">weak = std::weak_ptr&lt;std::string&gt;(shared)</span><span class="s4">;</span>

  <span class="s1">EXPECT_EQ(str</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">unique</span><span class="s4">, </span><span class="s1">invoker).asString(rt).utf8(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(str</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">shared</span><span class="s4">, </span><span class="s1">invoker).asString(rt).utf8(rt))</span><span class="s4">;</span>
  <span class="s1">EXPECT_EQ(str</span><span class="s4">, </span><span class="s1">bridging::toJs(rt</span><span class="s4">, </span><span class="s1">weak</span><span class="s4">, </span><span class="s1">invoker).asString(rt).utf8(rt))</span><span class="s4">;</span>

  <span class="s1">shared.reset()</span><span class="s4">;</span>

  <span class="s1">EXPECT_TRUE(bridging::toJs(rt</span><span class="s4">, </span><span class="s1">weak</span><span class="s4">, </span><span class="s1">invoker).isNull())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">TEST_F(BridgingTest</span><span class="s4">, </span><span class="s1">supportTest) {</span>
  <span class="s0">// Ensure sure can convert some basic types, including primitives that can be</span>
  <span class="s0">// trivially converted to JSI values.</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">bool</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">bool, bool</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">bool, </span><span class="s1">jsi::Value &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">int</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">int, int</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">int, </span><span class="s1">jsi::Value &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">double</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">double, double</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;</span><span class="s4">double, </span><span class="s1">jsi::Value &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;std::string&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;std::string</span><span class="s4">, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;std::string</span><span class="s4">, </span><span class="s1">jsi::String &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;std::set&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;std::set&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Array &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;std::vector&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;std::vector&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Array &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(</span>
      <span class="s1">(bridging::supportsFromJs&lt;std::map&lt;std::string</span><span class="s4">, int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(</span>
      <span class="s1">(bridging::supportsFromJs&lt;std::map&lt;std::string</span><span class="s4">, int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>

  <span class="s0">// Ensure incompatible conversions will fail.</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">bool, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">bool, </span><span class="s1">jsi::String &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">int, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">int, </span><span class="s1">jsi::String &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">double, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">double, </span><span class="s1">jsi::String &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">bool, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">bool, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">int, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">int, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">double, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;</span><span class="s4">double, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;std::string</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;std::string</span><span class="s4">, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;std::set&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;std::set&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::String &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;std::vector&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;std::vector&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::String &amp;&gt;))</span><span class="s4">;</span>

  <span class="s0">// Ensure copying and up/down casting JSI values is also supported.</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Value&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Value</span><span class="s4">, </span><span class="s1">jsi::Value &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Value</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Value</span><span class="s4">, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::String</span><span class="s4">, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::String</span><span class="s4">, </span><span class="s1">jsi::String &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Object</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Object</span><span class="s4">, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Object</span><span class="s4">, </span><span class="s1">jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Object</span><span class="s4">, </span><span class="s1">jsi::Array &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Object</span><span class="s4">, </span><span class="s1">jsi::Function&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Object</span><span class="s4">, </span><span class="s1">jsi::Function &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Array</span><span class="s4">, </span><span class="s1">jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Array</span><span class="s4">, </span><span class="s1">jsi::Array &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Array</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Array</span><span class="s4">, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Function&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Function</span><span class="s4">, </span><span class="s1">jsi::Function&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Function</span><span class="s4">, </span><span class="s1">jsi::Function &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Function</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsFromJs&lt;jsi::Function</span><span class="s4">, </span><span class="s1">jsi::Object &amp;&gt;))</span><span class="s4">;</span>

  <span class="s0">// Ensure incorrect casts will fail.</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;jsi::Array</span><span class="s4">, </span><span class="s1">jsi::Function&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;jsi::Array</span><span class="s4">, </span><span class="s1">jsi::Function &amp;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;jsi::Function</span><span class="s4">, </span><span class="s1">jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsFromJs&lt;jsi::Function</span><span class="s4">, </span><span class="s1">jsi::Array &amp;&gt;))</span><span class="s4">;</span>

  <span class="s0">// Ensure we can convert some basic types to JSI values.</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;</span><span class="s4">bool</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;</span><span class="s4">int</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;</span><span class="s4">double</span><span class="s1">&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;std::string&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;std::string</span><span class="s4">, </span><span class="s1">jsi::String&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;std::set&lt;</span><span class="s4">int</span><span class="s1">&gt;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;std::set&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;std::vector&lt;</span><span class="s4">int</span><span class="s1">&gt;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;std::vector&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Array&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;std::map&lt;std::string</span><span class="s4">, int</span><span class="s1">&gt;&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE(</span>
      <span class="s1">(bridging::supportsToJs&lt;std::map&lt;std::string</span><span class="s4">, int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;</span><span class="s4">void </span><span class="s1">(*)()&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_TRUE((bridging::supportsToJs&lt;</span><span class="s4">void </span><span class="s1">(*)()</span><span class="s4">, </span><span class="s1">jsi::Function&gt;))</span><span class="s4">;</span>

  <span class="s0">// Ensure invalid conversions to JSI values are not supported.</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsToJs&lt;</span><span class="s4">void </span><span class="s1">*&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsToJs&lt;</span><span class="s4">bool, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsToJs&lt;</span><span class="s4">int, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsToJs&lt;</span><span class="s4">double, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsToJs&lt;std::string</span><span class="s4">, </span><span class="s1">jsi::Object&gt;))</span><span class="s4">;</span>
  <span class="s1">EXPECT_FALSE((bridging::supportsToJs&lt;std::vector&lt;</span><span class="s4">int</span><span class="s1">&gt;</span><span class="s4">, </span><span class="s1">jsi::Function&gt;))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">} </span><span class="s0">// namespace facebook::react</span>
</pre>
</body>
</html>