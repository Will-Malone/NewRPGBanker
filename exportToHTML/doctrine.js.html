<html>
<head>
<title>doctrine.js</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #4646f1;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
doctrine.js</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * @fileoverview Main Doctrine object 
 * @author Yusuke Suzuki &lt;utatane.tea@gmail.com&gt; 
 * @author Dan Tao &lt;daniel.tao@gmail.com&gt; 
 * @author Andrew Eisenberg &lt;andrew@eisenberg.as&gt; 
 */</span>

<span class="s1">(</span><span class="s2">function </span><span class="s1">() {</span>
    <span class="s3">'use strict'</span><span class="s1">;</span>

    <span class="s2">var </span><span class="s1">typed,</span>
        <span class="s1">utility,</span>
        <span class="s1">jsdoc,</span>
        <span class="s1">esutils,</span>
        <span class="s1">hasOwnProperty;</span>

    <span class="s1">esutils = require(</span><span class="s3">'esutils'</span><span class="s1">);</span>
    <span class="s1">typed = require(</span><span class="s3">'./typed'</span><span class="s1">);</span>
    <span class="s1">utility = require(</span><span class="s3">'./utility'</span><span class="s1">);</span>

    <span class="s2">function </span><span class="s1">sliceSource(source, index, last) {</span>
        <span class="s2">return </span><span class="s1">source.slice(index, last);</span>
    <span class="s1">}</span>

    <span class="s1">hasOwnProperty = (</span><span class="s2">function </span><span class="s1">() {</span>
        <span class="s2">var </span><span class="s1">func = Object.prototype.hasOwnProperty;</span>
        <span class="s2">return function </span><span class="s1">hasOwnProperty(obj, name) {</span>
            <span class="s2">return </span><span class="s1">func.call(obj, name);</span>
        <span class="s1">};</span>
    <span class="s1">}());</span>

    <span class="s2">function </span><span class="s1">shallowCopy(obj) {</span>
        <span class="s2">var </span><span class="s1">ret = {}, key;</span>
        <span class="s2">for </span><span class="s1">(key </span><span class="s2">in </span><span class="s1">obj) {</span>
            <span class="s2">if </span><span class="s1">(obj.hasOwnProperty(key)) {</span>
                <span class="s1">ret[key] = obj[key];</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        <span class="s2">return </span><span class="s1">ret;</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isASCIIAlphanumeric(ch) {</span>
        <span class="s2">return </span><span class="s1">(ch &gt;= </span><span class="s4">0</span><span class="s1">x61  </span><span class="s0">/* 'a' */ </span><span class="s1">&amp;&amp; ch &lt;= </span><span class="s4">0</span><span class="s1">x7A  </span><span class="s0">/* 'z' */</span><span class="s1">) ||</span>
            <span class="s1">(ch &gt;= </span><span class="s4">0</span><span class="s1">x41  </span><span class="s0">/* 'A' */ </span><span class="s1">&amp;&amp; ch &lt;= </span><span class="s4">0</span><span class="s1">x5A  </span><span class="s0">/* 'Z' */</span><span class="s1">) ||</span>
            <span class="s1">(ch &gt;= </span><span class="s4">0</span><span class="s1">x30  </span><span class="s0">/* '0' */ </span><span class="s1">&amp;&amp; ch &lt;= </span><span class="s4">0</span><span class="s1">x39  </span><span class="s0">/* '9' */</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isParamTitle(title) {</span>
        <span class="s2">return </span><span class="s1">title === </span><span class="s3">'param' </span><span class="s1">|| title === </span><span class="s3">'argument' </span><span class="s1">|| title === </span><span class="s3">'arg'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isReturnTitle(title) {</span>
        <span class="s2">return </span><span class="s1">title === </span><span class="s3">'return' </span><span class="s1">|| title === </span><span class="s3">'returns'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isProperty(title) {</span>
        <span class="s2">return </span><span class="s1">title === </span><span class="s3">'property' </span><span class="s1">|| title === </span><span class="s3">'prop'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isNameParameterRequired(title) {</span>
        <span class="s2">return </span><span class="s1">isParamTitle(title) || isProperty(title) ||</span>
            <span class="s1">title === </span><span class="s3">'alias' </span><span class="s1">|| title === </span><span class="s3">'this' </span><span class="s1">|| title === </span><span class="s3">'mixes' </span><span class="s1">|| title === </span><span class="s3">'requires'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isAllowedName(title) {</span>
        <span class="s2">return </span><span class="s1">isNameParameterRequired(title) || title === </span><span class="s3">'const' </span><span class="s1">|| title === </span><span class="s3">'constant'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isAllowedNested(title) {</span>
        <span class="s2">return </span><span class="s1">isProperty(title) || isParamTitle(title);</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isAllowedOptional(title) {</span>
        <span class="s2">return </span><span class="s1">isProperty(title) || isParamTitle(title);</span>
    <span class="s1">}</span>

    <span class="s2">function </span><span class="s1">isTypeParameterRequired(title) {</span>
        <span class="s2">return </span><span class="s1">isParamTitle(title) || isReturnTitle(title) ||</span>
            <span class="s1">title === </span><span class="s3">'define' </span><span class="s1">|| title === </span><span class="s3">'enum' </span><span class="s1">||</span>
            <span class="s1">title === </span><span class="s3">'implements' </span><span class="s1">|| title === </span><span class="s3">'this' </span><span class="s1">||</span>
            <span class="s1">title === </span><span class="s3">'type' </span><span class="s1">|| title === </span><span class="s3">'typedef' </span><span class="s1">|| isProperty(title);</span>
    <span class="s1">}</span>

    <span class="s0">// Consider deprecation instead using 'isTypeParameterRequired' and 'Rules' declaration to pick when a type is optional/required</span>
    <span class="s0">// This would require changes to 'parseType'</span>
    <span class="s2">function </span><span class="s1">isAllowedType(title) {</span>
        <span class="s2">return </span><span class="s1">isTypeParameterRequired(title) || title === </span><span class="s3">'throws' </span><span class="s1">|| title === </span><span class="s3">'const' </span><span class="s1">|| title === </span><span class="s3">'constant' </span><span class="s1">||</span>
            <span class="s1">title === </span><span class="s3">'namespace' </span><span class="s1">|| title === </span><span class="s3">'member' </span><span class="s1">|| title === </span><span class="s3">'var' </span><span class="s1">|| title === </span><span class="s3">'module' </span><span class="s1">||</span>
            <span class="s1">title === </span><span class="s3">'constructor' </span><span class="s1">|| title === </span><span class="s3">'class' </span><span class="s1">|| title === </span><span class="s3">'extends' </span><span class="s1">|| title === </span><span class="s3">'augments' </span><span class="s1">||</span>
            <span class="s1">title === </span><span class="s3">'public' </span><span class="s1">|| title === </span><span class="s3">'private' </span><span class="s1">|| title === </span><span class="s3">'protected'</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">// A regex character class that contains all whitespace except linebreak characters (\r, \n, \u2028, \u2029)</span>
    <span class="s2">var </span><span class="s1">WHITESPACE = </span><span class="s3">'[ </span><span class="s5">\\</span><span class="s3">f</span><span class="s5">\\</span><span class="s3">t</span><span class="s5">\\</span><span class="s3">v</span><span class="s5">\\</span><span class="s3">u00a0</span><span class="s5">\\</span><span class="s3">u1680</span><span class="s5">\\</span><span class="s3">u180e</span><span class="s5">\\</span><span class="s3">u2000-</span><span class="s5">\\</span><span class="s3">u200a</span><span class="s5">\\</span><span class="s3">u202f</span><span class="s5">\\</span><span class="s3">u205f</span><span class="s5">\\</span><span class="s3">u3000</span><span class="s5">\\</span><span class="s3">ufeff]'</span><span class="s1">;</span>

    <span class="s2">var </span><span class="s1">STAR_MATCHER = </span><span class="s3">'(' </span><span class="s1">+ WHITESPACE + </span><span class="s3">'*(?:</span><span class="s5">\\</span><span class="s3">*' </span><span class="s1">+ WHITESPACE + </span><span class="s3">'?)?)(.+|[</span><span class="s5">\r\n\u2028\u2029</span><span class="s3">])'</span><span class="s1">;</span>

    <span class="s2">function </span><span class="s1">unwrapComment(doc) {</span>
        <span class="s0">// JSDoc comment is following form</span>
        <span class="s0">//   /**</span>
        <span class="s0">//    * .......</span>
        <span class="s0">//    */</span>

        <span class="s2">return </span><span class="s1">doc.</span>
            <span class="s0">// remove /**</span>
            <span class="s1">replace(/^\/\*\*?/, </span><span class="s3">''</span><span class="s1">).</span>
            <span class="s0">// remove */</span>
            <span class="s1">replace(/\*\/$/, </span><span class="s3">''</span><span class="s1">).</span>
            <span class="s0">// remove ' * ' at the beginning of a line</span>
            <span class="s1">replace(</span><span class="s2">new </span><span class="s1">RegExp(STAR_MATCHER, </span><span class="s3">'g'</span><span class="s1">), </span><span class="s3">'$2'</span><span class="s1">).</span>
            <span class="s0">// remove trailing whitespace</span>
            <span class="s1">replace(/\s*$/, </span><span class="s3">''</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s0">/** 
     * Converts an index in an &quot;unwrapped&quot; JSDoc comment to the corresponding index in the original &quot;wrapped&quot; version 
     * @param {string} originalSource The original wrapped comment 
     * @param {number} unwrappedIndex The index of a character in the unwrapped string 
     * @returns {number} The index of the corresponding character in the original wrapped string 
     */</span>
    <span class="s2">function </span><span class="s1">convertUnwrappedCommentIndex(originalSource, unwrappedIndex) {</span>
        <span class="s2">var </span><span class="s1">replacedSource = originalSource.replace(/^\/\*\*?/, </span><span class="s3">''</span><span class="s1">);</span>
        <span class="s2">var </span><span class="s1">numSkippedChars = </span><span class="s4">0</span><span class="s1">;</span>
        <span class="s2">var </span><span class="s1">matcher = </span><span class="s2">new </span><span class="s1">RegExp(STAR_MATCHER, </span><span class="s3">'g'</span><span class="s1">);</span>
        <span class="s2">var </span><span class="s1">match;</span>

        <span class="s2">while </span><span class="s1">((match = matcher.exec(replacedSource))) {</span>
            <span class="s1">numSkippedChars += match[</span><span class="s4">1</span><span class="s1">].length;</span>

            <span class="s2">if </span><span class="s1">(match.index + match[</span><span class="s4">0</span><span class="s1">].length &gt; unwrappedIndex + numSkippedChars) {</span>
                <span class="s2">return </span><span class="s1">unwrappedIndex + numSkippedChars + originalSource.length - replacedSource.length;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">return </span><span class="s1">originalSource.replace(/\*\/$/, </span><span class="s3">''</span><span class="s1">).replace(/\s*$/, </span><span class="s3">''</span><span class="s1">).length;</span>
    <span class="s1">}</span>

    <span class="s0">// JSDoc Tag Parser</span>

    <span class="s1">(</span><span class="s2">function </span><span class="s1">(exports) {</span>
        <span class="s2">var </span><span class="s1">Rules,</span>
            <span class="s1">index,</span>
            <span class="s1">lineNumber,</span>
            <span class="s1">length,</span>
            <span class="s1">source,</span>
            <span class="s1">originalSource,</span>
            <span class="s1">recoverable,</span>
            <span class="s1">sloppy,</span>
            <span class="s1">strict;</span>

        <span class="s2">function </span><span class="s1">advance() {</span>
            <span class="s2">var </span><span class="s1">ch = source.charCodeAt(index);</span>
            <span class="s1">index += </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s2">if </span><span class="s1">(esutils.code.isLineTerminator(ch) &amp;&amp; !(ch === </span><span class="s4">0</span><span class="s1">x0D  </span><span class="s0">/* '\r' */ </span><span class="s1">&amp;&amp; source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x0A  </span><span class="s0">/* '\n' */</span><span class="s1">)) {</span>
                <span class="s1">lineNumber += </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">return </span><span class="s1">String.fromCharCode(ch);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">scanTitle() {</span>
            <span class="s2">var </span><span class="s1">title = </span><span class="s3">''</span><span class="s1">;</span>
            <span class="s0">// waste '@'</span>
            <span class="s1">advance();</span>

            <span class="s2">while </span><span class="s1">(index &lt; length &amp;&amp; isASCIIAlphanumeric(source.charCodeAt(index))) {</span>
                <span class="s1">title += advance();</span>
            <span class="s1">}</span>

            <span class="s2">return </span><span class="s1">title;</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">seekContent() {</span>
            <span class="s2">var </span><span class="s1">ch, waiting, last = index;</span>

            <span class="s1">waiting = </span><span class="s2">false</span><span class="s1">;</span>
            <span class="s2">while </span><span class="s1">(last &lt; length) {</span>
                <span class="s1">ch = source.charCodeAt(last);</span>
                <span class="s2">if </span><span class="s1">(esutils.code.isLineTerminator(ch) &amp;&amp; !(ch === </span><span class="s4">0</span><span class="s1">x0D  </span><span class="s0">/* '\r' */ </span><span class="s1">&amp;&amp; source.charCodeAt(last + </span><span class="s4">1</span><span class="s1">) === </span><span class="s4">0</span><span class="s1">x0A  </span><span class="s0">/* '\n' */</span><span class="s1">)) {</span>
                    <span class="s1">waiting = </span><span class="s2">true</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s2">else if </span><span class="s1">(waiting) {</span>
                    <span class="s2">if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x40  </span><span class="s0">/* '@' */</span><span class="s1">) {</span>
                        <span class="s2">break</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s2">if </span><span class="s1">(!esutils.code.isWhiteSpace(ch)) {</span>
                        <span class="s1">waiting = </span><span class="s2">false</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
                <span class="s1">last += </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s2">return </span><span class="s1">last;</span>
        <span class="s1">}</span>

        <span class="s0">// type expression may have nest brace, such as,</span>
        <span class="s0">// { { ok: string } }</span>
        <span class="s0">//</span>
        <span class="s0">// therefore, scanning type expression with balancing braces.</span>
        <span class="s2">function </span><span class="s1">parseType(title, last, addRange) {</span>
            <span class="s2">var </span><span class="s1">ch, brace, type, startIndex, direct = </span><span class="s2">false</span><span class="s1">;</span>


            <span class="s0">// search '{'</span>
            <span class="s2">while </span><span class="s1">(index &lt; last) {</span>
                <span class="s1">ch = source.charCodeAt(index);</span>
                <span class="s2">if </span><span class="s1">(esutils.code.isWhiteSpace(ch)) {</span>
                    <span class="s1">advance();</span>
                <span class="s1">} </span><span class="s2">else if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x7B  </span><span class="s0">/* '{' */</span><span class="s1">) {</span>
                    <span class="s1">advance();</span>
                    <span class="s2">break</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s0">// this is direct pattern</span>
                    <span class="s1">direct = </span><span class="s2">true</span><span class="s1">;</span>
                    <span class="s2">break</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>


            <span class="s2">if </span><span class="s1">(direct) {</span>
                <span class="s2">return null</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s0">// type expression { is found</span>
            <span class="s1">brace = </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s1">type = </span><span class="s3">''</span><span class="s1">;</span>
            <span class="s2">while </span><span class="s1">(index &lt; last) {</span>
                <span class="s1">ch = source.charCodeAt(index);</span>
                <span class="s2">if </span><span class="s1">(esutils.code.isLineTerminator(ch)) {</span>
                    <span class="s1">advance();</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s2">if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x7D  </span><span class="s0">/* '}' */</span><span class="s1">) {</span>
                        <span class="s1">brace -= </span><span class="s4">1</span><span class="s1">;</span>
                        <span class="s2">if </span><span class="s1">(brace === </span><span class="s4">0</span><span class="s1">) {</span>
                            <span class="s1">advance();</span>
                            <span class="s2">break</span><span class="s1">;</span>
                        <span class="s1">}</span>
                    <span class="s1">} </span><span class="s2">else if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x7B  </span><span class="s0">/* '{' */</span><span class="s1">) {</span>
                        <span class="s1">brace += </span><span class="s4">1</span><span class="s1">;</span>
                    <span class="s1">}</span>
                    <span class="s2">if </span><span class="s1">(type === </span><span class="s3">''</span><span class="s1">) {</span>
                        <span class="s1">startIndex = index;</span>
                    <span class="s1">}</span>
                    <span class="s1">type += advance();</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(brace !== </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s0">// braces is not balanced</span>
                <span class="s2">return </span><span class="s1">utility.throwError(</span><span class="s3">'Braces are not balanced'</span><span class="s1">);</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(isAllowedOptional(title)) {</span>
                <span class="s2">return </span><span class="s1">typed.parseParamType(type, {startIndex: convertIndex(startIndex), range: addRange});</span>
            <span class="s1">}</span>

            <span class="s2">return </span><span class="s1">typed.parseType(type, {startIndex: convertIndex(startIndex), range: addRange});</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">scanIdentifier(last) {</span>
            <span class="s2">var </span><span class="s1">identifier;</span>
            <span class="s2">if </span><span class="s1">(!esutils.code.isIdentifierStartES5(source.charCodeAt(index)) &amp;&amp; !source[index].match(/[</span><span class="s4">0</span><span class="s1">-</span><span class="s4">9</span><span class="s1">]/)) {</span>
                <span class="s2">return null</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s1">identifier = advance();</span>
            <span class="s2">while </span><span class="s1">(index &lt; last &amp;&amp; esutils.code.isIdentifierPartES5(source.charCodeAt(index))) {</span>
                <span class="s1">identifier += advance();</span>
            <span class="s1">}</span>
            <span class="s2">return </span><span class="s1">identifier;</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">skipWhiteSpace(last) {</span>
            <span class="s2">while </span><span class="s1">(index &lt; last &amp;&amp; (esutils.code.isWhiteSpace(source.charCodeAt(index)) || esutils.code.isLineTerminator(source.charCodeAt(index)))) {</span>
                <span class="s1">advance();</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">parseName(last, allowBrackets, allowNestedParams) {</span>
            <span class="s2">var </span><span class="s1">name = </span><span class="s3">''</span><span class="s1">,</span>
                <span class="s1">useBrackets,</span>
                <span class="s1">insideString;</span>


            <span class="s1">skipWhiteSpace(last);</span>

            <span class="s2">if </span><span class="s1">(index &gt;= last) {</span>
                <span class="s2">return null</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x5B  </span><span class="s0">/* '[' */</span><span class="s1">) {</span>
                <span class="s2">if </span><span class="s1">(allowBrackets) {</span>
                    <span class="s1">useBrackets = </span><span class="s2">true</span><span class="s1">;</span>
                    <span class="s1">name = advance();</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s2">return null</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s1">name += scanIdentifier(last);</span>

            <span class="s2">if </span><span class="s1">(allowNestedParams) {</span>
                <span class="s2">if </span><span class="s1">(source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x3A </span><span class="s0">/* ':' */ </span><span class="s1">&amp;&amp; (</span>
                        <span class="s1">name === </span><span class="s3">'module' </span><span class="s1">||</span>
                        <span class="s1">name === </span><span class="s3">'external' </span><span class="s1">||</span>
                        <span class="s1">name === </span><span class="s3">'event'</span><span class="s1">)) {</span>
                    <span class="s1">name += advance();</span>
                    <span class="s1">name += scanIdentifier(last);</span>

                <span class="s1">}</span>
                <span class="s2">if</span><span class="s1">(source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x5B  </span><span class="s0">/* '[' */ </span><span class="s1">&amp;&amp; source.charCodeAt(index + </span><span class="s4">1</span><span class="s1">) === </span><span class="s4">0</span><span class="s1">x5D  </span><span class="s0">/* ']' */</span><span class="s1">){</span>
                    <span class="s1">name += advance();</span>
                    <span class="s1">name += advance();</span>
                <span class="s1">}</span>
                <span class="s2">while </span><span class="s1">(source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x2E  </span><span class="s0">/* '.' */ </span><span class="s1">||</span>
                        <span class="s1">source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x2F  </span><span class="s0">/* '/' */ </span><span class="s1">||</span>
                        <span class="s1">source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x23  </span><span class="s0">/* '#' */ </span><span class="s1">||</span>
                        <span class="s1">source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x2D  </span><span class="s0">/* '-' */ </span><span class="s1">||</span>
                        <span class="s1">source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x7E  </span><span class="s0">/* '~' */</span><span class="s1">) {</span>
                    <span class="s1">name += advance();</span>
                    <span class="s1">name += scanIdentifier(last);</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(useBrackets) {</span>
                <span class="s1">skipWhiteSpace(last);</span>
                <span class="s0">// do we have a default value for this?</span>
                <span class="s2">if </span><span class="s1">(source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x3D  </span><span class="s0">/* '=' */</span><span class="s1">) {</span>
                    <span class="s0">// consume the '='' symbol</span>
                    <span class="s1">name += advance();</span>
                    <span class="s1">skipWhiteSpace(last);</span>

                    <span class="s2">var </span><span class="s1">ch;</span>
                    <span class="s2">var </span><span class="s1">bracketDepth = </span><span class="s4">1</span><span class="s1">;</span>

                    <span class="s0">// scan in the default value</span>
                    <span class="s2">while </span><span class="s1">(index &lt; last) {</span>
                        <span class="s1">ch = source.charCodeAt(index);</span>

                        <span class="s2">if </span><span class="s1">(esutils.code.isWhiteSpace(ch)) {</span>
                            <span class="s2">if </span><span class="s1">(!insideString) {</span>
                                <span class="s1">skipWhiteSpace(last);</span>
                                <span class="s1">ch = source.charCodeAt(index);</span>
                            <span class="s1">}</span>
                        <span class="s1">}</span>

                        <span class="s2">if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x27 </span><span class="s0">/* ''' */</span><span class="s1">) {</span>
                            <span class="s2">if </span><span class="s1">(!insideString) {</span>
                                <span class="s1">insideString = </span><span class="s3">'</span><span class="s5">\'</span><span class="s3">'</span><span class="s1">;</span>
                            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                                <span class="s2">if </span><span class="s1">(insideString === </span><span class="s3">'</span><span class="s5">\'</span><span class="s3">'</span><span class="s1">) {</span>
                                    <span class="s1">insideString = </span><span class="s3">''</span><span class="s1">;</span>
                                <span class="s1">}</span>
                            <span class="s1">}</span>
                        <span class="s1">}</span>

                        <span class="s2">if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x22 </span><span class="s0">/* '&quot;' */</span><span class="s1">) {</span>
                            <span class="s2">if </span><span class="s1">(!insideString) {</span>
                                <span class="s1">insideString = </span><span class="s3">'&quot;'</span><span class="s1">;</span>
                            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                                <span class="s2">if </span><span class="s1">(insideString === </span><span class="s3">'&quot;'</span><span class="s1">) {</span>
                                    <span class="s1">insideString = </span><span class="s3">''</span><span class="s1">;</span>
                                <span class="s1">}</span>
                            <span class="s1">}</span>
                        <span class="s1">}</span>

                        <span class="s2">if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x5B </span><span class="s0">/* '[' */</span><span class="s1">) {</span>
                            <span class="s1">bracketDepth++;</span>
                        <span class="s1">} </span><span class="s2">else if </span><span class="s1">(ch === </span><span class="s4">0</span><span class="s1">x5D  </span><span class="s0">/* ']' */ </span><span class="s1">&amp;&amp;</span>
                            <span class="s1">--bracketDepth === </span><span class="s4">0</span><span class="s1">) {</span>
                            <span class="s2">break</span><span class="s1">;</span>
                        <span class="s1">}</span>

                        <span class="s1">name += advance();</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>

                <span class="s1">skipWhiteSpace(last);</span>

                <span class="s2">if </span><span class="s1">(index &gt;= last || source.charCodeAt(index) !== </span><span class="s4">0</span><span class="s1">x5D  </span><span class="s0">/* ']' */</span><span class="s1">) {</span>
                    <span class="s0">// we never found a closing ']'</span>
                    <span class="s2">return null</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s0">// collect the last ']'</span>
                <span class="s1">name += advance();</span>
            <span class="s1">}</span>

            <span class="s2">return </span><span class="s1">name;</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">skipToTag() {</span>
            <span class="s2">while </span><span class="s1">(index &lt; length &amp;&amp; source.charCodeAt(index) !== </span><span class="s4">0</span><span class="s1">x40  </span><span class="s0">/* '@' */</span><span class="s1">) {</span>
                <span class="s1">advance();</span>
            <span class="s1">}</span>
            <span class="s2">if </span><span class="s1">(index &gt;= length) {</span>
                <span class="s2">return false</span><span class="s1">;</span>
            <span class="s1">}</span>
            <span class="s1">utility.assert(source.charCodeAt(index) === </span><span class="s4">0</span><span class="s1">x40  </span><span class="s0">/* '@' */</span><span class="s1">);</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">convertIndex(rangeIndex) {</span>
            <span class="s2">if </span><span class="s1">(source === originalSource) {</span>
                <span class="s2">return </span><span class="s1">rangeIndex;</span>
            <span class="s1">}</span>
            <span class="s2">return </span><span class="s1">convertUnwrappedCommentIndex(originalSource, rangeIndex);</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">TagParser(options, title) {</span>
            <span class="s2">this</span><span class="s1">._options = options;</span>
            <span class="s2">this</span><span class="s1">._title = title.toLowerCase();</span>
            <span class="s2">this</span><span class="s1">._tag = {</span>
                <span class="s1">title: title,</span>
                <span class="s1">description: </span><span class="s2">null</span>
            <span class="s1">};</span>
            <span class="s2">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">._options.lineNumbers) {</span>
                <span class="s2">this</span><span class="s1">._tag.lineNumber = lineNumber;</span>
            <span class="s1">}</span>
            <span class="s2">this</span><span class="s1">._first = index - title.length - </span><span class="s4">1</span><span class="s1">;</span>
            <span class="s2">this</span><span class="s1">._last = </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s0">// space to save special information for title parsers.</span>
            <span class="s2">this</span><span class="s1">._extra = { };</span>
        <span class="s1">}</span>

        <span class="s0">// addError(err, ...)</span>
        <span class="s1">TagParser.prototype.addError = </span><span class="s2">function </span><span class="s1">addError(errorText) {</span>
            <span class="s2">var </span><span class="s1">args = Array.prototype.slice.call(arguments, </span><span class="s4">1</span><span class="s1">),</span>
                <span class="s1">msg = errorText.replace(</span>
                    <span class="s1">/%(\d)/g,</span>
                    <span class="s2">function </span><span class="s1">(whole, index) {</span>
                        <span class="s1">utility.assert(index &lt; args.length, </span><span class="s3">'Message reference must be in range'</span><span class="s1">);</span>
                        <span class="s2">return </span><span class="s1">args[index];</span>
                    <span class="s1">}</span>
                <span class="s1">);</span>

            <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">._tag.errors) {</span>
                <span class="s2">this</span><span class="s1">._tag.errors = [];</span>
            <span class="s1">}</span>
            <span class="s2">if </span><span class="s1">(strict) {</span>
                <span class="s1">utility.throwError(msg);</span>
            <span class="s1">}</span>
            <span class="s2">this</span><span class="s1">._tag.errors.push(msg);</span>
            <span class="s2">return </span><span class="s1">recoverable;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseType = </span><span class="s2">function </span><span class="s1">() {</span>
            <span class="s0">// type required titles</span>
            <span class="s2">if </span><span class="s1">(isTypeParameterRequired(</span><span class="s2">this</span><span class="s1">._title)) {</span>
                <span class="s2">try </span><span class="s1">{</span>
                    <span class="s2">this</span><span class="s1">._tag.type = parseType(</span><span class="s2">this</span><span class="s1">._title, </span><span class="s2">this</span><span class="s1">._last, </span><span class="s2">this</span><span class="s1">._options.range);</span>
                    <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">._tag.type) {</span>
                        <span class="s2">if </span><span class="s1">(!isParamTitle(</span><span class="s2">this</span><span class="s1">._title) &amp;&amp; !isReturnTitle(</span><span class="s2">this</span><span class="s1">._title)) {</span>
                            <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Missing or invalid tag type'</span><span class="s1">)) {</span>
                                <span class="s2">return false</span><span class="s1">;</span>
                            <span class="s1">}</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">} </span><span class="s2">catch </span><span class="s1">(error) {</span>
                    <span class="s2">this</span><span class="s1">._tag.type = </span><span class="s2">null</span><span class="s1">;</span>
                    <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(error.message)) {</span>
                        <span class="s2">return false</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s2">else if </span><span class="s1">(isAllowedType(</span><span class="s2">this</span><span class="s1">._title)) {</span>
                <span class="s0">// optional types</span>
                <span class="s2">try </span><span class="s1">{</span>
                    <span class="s2">this</span><span class="s1">._tag.type = parseType(</span><span class="s2">this</span><span class="s1">._title, </span><span class="s2">this</span><span class="s1">._last, </span><span class="s2">this</span><span class="s1">._options.range);</span>
                <span class="s1">} </span><span class="s2">catch </span><span class="s1">(e) {</span>
                    <span class="s0">//For optional types, lets drop the thrown error when we hit the end of the file</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype._parseNamePath = </span><span class="s2">function </span><span class="s1">(optional) {</span>
            <span class="s2">var </span><span class="s1">name;</span>
            <span class="s1">name = parseName(</span><span class="s2">this</span><span class="s1">._last, sloppy &amp;&amp; isAllowedOptional(</span><span class="s2">this</span><span class="s1">._title), </span><span class="s2">true</span><span class="s1">);</span>
            <span class="s2">if </span><span class="s1">(!name) {</span>
                <span class="s2">if </span><span class="s1">(!optional) {</span>
                    <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Missing or invalid tag name'</span><span class="s1">)) {</span>
                        <span class="s2">return false</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">this</span><span class="s1">._tag.name = name;</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseNamePath = </span><span class="s2">function </span><span class="s1">() {</span>
            <span class="s2">return this</span><span class="s1">._parseNamePath(</span><span class="s2">false</span><span class="s1">);</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseNamePathOptional = </span><span class="s2">function </span><span class="s1">() {</span>
            <span class="s2">return this</span><span class="s1">._parseNamePath(</span><span class="s2">true</span><span class="s1">);</span>
        <span class="s1">};</span>


        <span class="s1">TagParser.prototype.parseName = </span><span class="s2">function </span><span class="s1">() {</span>
            <span class="s2">var </span><span class="s1">assign, name;</span>

            <span class="s0">// param, property requires name</span>
            <span class="s2">if </span><span class="s1">(isAllowedName(</span><span class="s2">this</span><span class="s1">._title)) {</span>
                <span class="s2">this</span><span class="s1">._tag.name = parseName(</span><span class="s2">this</span><span class="s1">._last, sloppy &amp;&amp; isAllowedOptional(</span><span class="s2">this</span><span class="s1">._title), isAllowedNested(</span><span class="s2">this</span><span class="s1">._title));</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">._tag.name) {</span>
                    <span class="s2">if </span><span class="s1">(!isNameParameterRequired(</span><span class="s2">this</span><span class="s1">._title)) {</span>
                        <span class="s2">return true</span><span class="s1">;</span>
                    <span class="s1">}</span>

                    <span class="s0">// it's possible the name has already been parsed but interpreted as a type</span>
                    <span class="s0">// it's also possible this is a sloppy declaration, in which case it will be</span>
                    <span class="s0">// fixed at the end</span>
                    <span class="s2">if </span><span class="s1">(isParamTitle(</span><span class="s2">this</span><span class="s1">._title) &amp;&amp; </span><span class="s2">this</span><span class="s1">._tag.type &amp;&amp; </span><span class="s2">this</span><span class="s1">._tag.type.name) {</span>
                        <span class="s2">this</span><span class="s1">._extra.name = </span><span class="s2">this</span><span class="s1">._tag.type;</span>
                        <span class="s2">this</span><span class="s1">._tag.name = </span><span class="s2">this</span><span class="s1">._tag.type.name;</span>
                        <span class="s2">this</span><span class="s1">._tag.type = </span><span class="s2">null</span><span class="s1">;</span>
                    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                        <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Missing or invalid tag name'</span><span class="s1">)) {</span>
                            <span class="s2">return false</span><span class="s1">;</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s1">name = </span><span class="s2">this</span><span class="s1">._tag.name;</span>
                    <span class="s2">if </span><span class="s1">(name.charAt(</span><span class="s4">0</span><span class="s1">) === </span><span class="s3">'[' </span><span class="s1">&amp;&amp; name.charAt(name.length - </span><span class="s4">1</span><span class="s1">) === </span><span class="s3">']'</span><span class="s1">) {</span>
                        <span class="s0">// extract the default value if there is one</span>
                        <span class="s0">// example: @param {string} [somebody=John Doe] description</span>
                        <span class="s1">assign = name.substring(</span><span class="s4">1</span><span class="s1">, name.length - </span><span class="s4">1</span><span class="s1">).split(</span><span class="s3">'='</span><span class="s1">);</span>
                        <span class="s2">if </span><span class="s1">(assign.length &gt; </span><span class="s4">1</span><span class="s1">) {</span>
                            <span class="s2">this</span><span class="s1">._tag[</span><span class="s3">'default'</span><span class="s1">] = assign.slice(</span><span class="s4">1</span><span class="s1">).join(</span><span class="s3">'='</span><span class="s1">);</span>
                        <span class="s1">}</span>
                        <span class="s2">this</span><span class="s1">._tag.name = assign[</span><span class="s4">0</span><span class="s1">];</span>

                        <span class="s0">// convert to an optional type</span>
                        <span class="s2">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">._tag.type &amp;&amp; </span><span class="s2">this</span><span class="s1">._tag.type.type !== </span><span class="s3">'OptionalType'</span><span class="s1">) {</span>
                            <span class="s2">this</span><span class="s1">._tag.type = {</span>
                                <span class="s1">type: </span><span class="s3">'OptionalType'</span><span class="s1">,</span>
                                <span class="s1">expression: </span><span class="s2">this</span><span class="s1">._tag.type</span>
                            <span class="s1">};</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>


            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseDescription = </span><span class="s2">function </span><span class="s1">parseDescription() {</span>
            <span class="s2">var </span><span class="s1">description = sliceSource(source, index, </span><span class="s2">this</span><span class="s1">._last).trim();</span>
            <span class="s2">if </span><span class="s1">(description) {</span>
                <span class="s2">if </span><span class="s1">((/^-\s+/).test(description)) {</span>
                    <span class="s1">description = description.substring(</span><span class="s4">2</span><span class="s1">);</span>
                <span class="s1">}</span>
                <span class="s2">this</span><span class="s1">._tag.description = description;</span>
            <span class="s1">}</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseCaption = </span><span class="s2">function </span><span class="s1">parseDescription() {</span>
            <span class="s2">var </span><span class="s1">description = sliceSource(source, index, </span><span class="s2">this</span><span class="s1">._last).trim();</span>
            <span class="s2">var </span><span class="s1">captionStartTag = </span><span class="s3">'&lt;caption&gt;'</span><span class="s1">;</span>
            <span class="s2">var </span><span class="s1">captionEndTag = </span><span class="s3">'&lt;/caption&gt;'</span><span class="s1">;</span>
            <span class="s2">var </span><span class="s1">captionStart = description.indexOf(captionStartTag);</span>
            <span class="s2">var </span><span class="s1">captionEnd = description.indexOf(captionEndTag);</span>
            <span class="s2">if </span><span class="s1">(captionStart &gt;= </span><span class="s4">0 </span><span class="s1">&amp;&amp; captionEnd &gt;= </span><span class="s4">0</span><span class="s1">) {</span>
                <span class="s2">this</span><span class="s1">._tag.caption = description.substring(</span>
                    <span class="s1">captionStart + captionStartTag.length, captionEnd).trim();</span>
                <span class="s2">this</span><span class="s1">._tag.description = description.substring(captionEnd + captionEndTag.length).trim();</span>
            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s2">this</span><span class="s1">._tag.description = description;</span>
            <span class="s1">}</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseKind = </span><span class="s2">function </span><span class="s1">parseKind() {</span>
            <span class="s2">var </span><span class="s1">kind, kinds;</span>
            <span class="s1">kinds = {</span>
                <span class="s3">'class'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'constant'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'event'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'external'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'file'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'function'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'member'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'mixin'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'module'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'namespace'</span><span class="s1">: </span><span class="s2">true</span><span class="s1">,</span>
                <span class="s3">'typedef'</span><span class="s1">: </span><span class="s2">true</span>
            <span class="s1">};</span>
            <span class="s1">kind = sliceSource(source, index, </span><span class="s2">this</span><span class="s1">._last).trim();</span>
            <span class="s2">this</span><span class="s1">._tag.kind = kind;</span>
            <span class="s2">if </span><span class="s1">(!hasOwnProperty(kinds, kind)) {</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Invalid kind name </span><span class="s5">\'</span><span class="s3">%0</span><span class="s5">\'</span><span class="s3">'</span><span class="s1">, kind)) {</span>
                    <span class="s2">return false</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseAccess = </span><span class="s2">function </span><span class="s1">parseAccess() {</span>
            <span class="s2">var </span><span class="s1">access;</span>
            <span class="s1">access = sliceSource(source, index, </span><span class="s2">this</span><span class="s1">._last).trim();</span>
            <span class="s2">this</span><span class="s1">._tag.access = access;</span>
            <span class="s2">if </span><span class="s1">(access !== </span><span class="s3">'private' </span><span class="s1">&amp;&amp; access !== </span><span class="s3">'protected' </span><span class="s1">&amp;&amp; access !== </span><span class="s3">'public'</span><span class="s1">) {</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Invalid access name </span><span class="s5">\'</span><span class="s3">%0</span><span class="s5">\'</span><span class="s3">'</span><span class="s1">, access)) {</span>
                    <span class="s2">return false</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseThis = </span><span class="s2">function </span><span class="s1">parseThis() {</span>
            <span class="s0">// this name may be a name expression (e.g. {foo.bar}),</span>
            <span class="s0">// an union (e.g. {foo.bar|foo.baz}) or a name path (e.g. foo.bar)</span>
            <span class="s2">var </span><span class="s1">value = sliceSource(source, index, </span><span class="s2">this</span><span class="s1">._last).trim();</span>
            <span class="s2">if </span><span class="s1">(value &amp;&amp; value.charAt(</span><span class="s4">0</span><span class="s1">) === </span><span class="s3">'{'</span><span class="s1">) {</span>
                <span class="s2">var </span><span class="s1">gotType = </span><span class="s2">this</span><span class="s1">.parseType();</span>
                <span class="s2">if </span><span class="s1">(gotType &amp;&amp; </span><span class="s2">this</span><span class="s1">._tag.type.type === </span><span class="s3">'NameExpression' </span><span class="s1">|| </span><span class="s2">this</span><span class="s1">._tag.type.type === </span><span class="s3">'UnionType'</span><span class="s1">) {</span>
                    <span class="s2">this</span><span class="s1">._tag.name = </span><span class="s2">this</span><span class="s1">._tag.type.name;</span>
                    <span class="s2">return true</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s2">return this</span><span class="s1">.addError(</span><span class="s3">'Invalid name for this'</span><span class="s1">);</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s2">return this</span><span class="s1">.parseNamePath();</span>
            <span class="s1">}</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parseVariation = </span><span class="s2">function </span><span class="s1">parseVariation() {</span>
            <span class="s2">var </span><span class="s1">variation, text;</span>
            <span class="s1">text = sliceSource(source, index, </span><span class="s2">this</span><span class="s1">._last).trim();</span>
            <span class="s1">variation = parseFloat(text, </span><span class="s4">10</span><span class="s1">);</span>
            <span class="s2">this</span><span class="s1">._tag.variation = variation;</span>
            <span class="s2">if </span><span class="s1">(isNaN(variation)) {</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Invalid variation </span><span class="s5">\'</span><span class="s3">%0</span><span class="s5">\'</span><span class="s3">'</span><span class="s1">, text)) {</span>
                    <span class="s2">return false</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.ensureEnd = </span><span class="s2">function </span><span class="s1">() {</span>
            <span class="s2">var </span><span class="s1">shouldBeEmpty = sliceSource(source, index, </span><span class="s2">this</span><span class="s1">._last).trim();</span>
            <span class="s2">if </span><span class="s1">(shouldBeEmpty) {</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Unknown content </span><span class="s5">\'</span><span class="s3">%0</span><span class="s5">\'</span><span class="s3">'</span><span class="s1">, shouldBeEmpty)) {</span>
                    <span class="s2">return false</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.epilogue = </span><span class="s2">function </span><span class="s1">epilogue() {</span>
            <span class="s2">var </span><span class="s1">description;</span>

            <span class="s1">description = </span><span class="s2">this</span><span class="s1">._tag.description;</span>
            <span class="s0">// un-fix potentially sloppy declaration</span>
            <span class="s2">if </span><span class="s1">(isAllowedOptional(</span><span class="s2">this</span><span class="s1">._title) &amp;&amp; !</span><span class="s2">this</span><span class="s1">._tag.type &amp;&amp; description &amp;&amp; description.charAt(</span><span class="s4">0</span><span class="s1">) === </span><span class="s3">'['</span><span class="s1">) {</span>
                <span class="s2">this</span><span class="s1">._tag.type = </span><span class="s2">this</span><span class="s1">._extra.name;</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">._tag.name) {</span>
                    <span class="s2">this</span><span class="s1">._tag.name = undefined;</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(!sloppy) {</span>
                    <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Missing or invalid tag name'</span><span class="s1">)) {</span>
                        <span class="s2">return false</span><span class="s1">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">return true</span><span class="s1">;</span>
        <span class="s1">};</span>

        <span class="s1">Rules = {</span>
            <span class="s0">// http://usejsdoc.org/tags-access.html</span>
            <span class="s3">'access'</span><span class="s1">: [</span><span class="s3">'parseAccess'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-alias.html</span>
            <span class="s3">'alias'</span><span class="s1">: [</span><span class="s3">'parseNamePath'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-augments.html</span>
            <span class="s3">'augments'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-constructor.html</span>
            <span class="s3">'constructor'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// Synonym: http://usejsdoc.org/tags-constructor.html</span>
            <span class="s3">'class'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// Synonym: http://usejsdoc.org/tags-extends.html</span>
            <span class="s3">'extends'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-example.html</span>
            <span class="s3">'example'</span><span class="s1">: [</span><span class="s3">'parseCaption'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-deprecated.html</span>
            <span class="s3">'deprecated'</span><span class="s1">: [</span><span class="s3">'parseDescription'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-global.html</span>
            <span class="s3">'global'</span><span class="s1">: [</span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-inner.html</span>
            <span class="s3">'inner'</span><span class="s1">: [</span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-instance.html</span>
            <span class="s3">'instance'</span><span class="s1">: [</span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-kind.html</span>
            <span class="s3">'kind'</span><span class="s1">: [</span><span class="s3">'parseKind'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-mixes.html</span>
            <span class="s3">'mixes'</span><span class="s1">: [</span><span class="s3">'parseNamePath'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-mixin.html</span>
            <span class="s3">'mixin'</span><span class="s1">: [</span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-member.html</span>
            <span class="s3">'member'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-method.html</span>
            <span class="s3">'method'</span><span class="s1">: [</span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-module.html</span>
            <span class="s3">'module'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// Synonym: http://usejsdoc.org/tags-method.html</span>
            <span class="s3">'func'</span><span class="s1">: [</span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// Synonym: http://usejsdoc.org/tags-method.html</span>
            <span class="s3">'function'</span><span class="s1">: [</span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// Synonym: http://usejsdoc.org/tags-member.html</span>
            <span class="s3">'var'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-name.html</span>
            <span class="s3">'name'</span><span class="s1">: [</span><span class="s3">'parseNamePath'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-namespace.html</span>
            <span class="s3">'namespace'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-private.html</span>
            <span class="s3">'private'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseDescription'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-protected.html</span>
            <span class="s3">'protected'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseDescription'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-public.html</span>
            <span class="s3">'public'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseDescription'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-readonly.html</span>
            <span class="s3">'readonly'</span><span class="s1">: [</span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-requires.html</span>
            <span class="s3">'requires'</span><span class="s1">: [</span><span class="s3">'parseNamePath'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-since.html</span>
            <span class="s3">'since'</span><span class="s1">: [</span><span class="s3">'parseDescription'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-static.html</span>
            <span class="s3">'static'</span><span class="s1">: [</span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-summary.html</span>
            <span class="s3">'summary'</span><span class="s1">: [</span><span class="s3">'parseDescription'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-this.html</span>
            <span class="s3">'this'</span><span class="s1">: [</span><span class="s3">'parseThis'</span><span class="s1">, </span><span class="s3">'ensureEnd'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-todo.html</span>
            <span class="s3">'todo'</span><span class="s1">: [</span><span class="s3">'parseDescription'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-typedef.html</span>
            <span class="s3">'typedef'</span><span class="s1">: [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseNamePathOptional'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-variation.html</span>
            <span class="s3">'variation'</span><span class="s1">: [</span><span class="s3">'parseVariation'</span><span class="s1">],</span>
            <span class="s0">// http://usejsdoc.org/tags-version.html</span>
            <span class="s3">'version'</span><span class="s1">: [</span><span class="s3">'parseDescription'</span><span class="s1">]</span>
        <span class="s1">};</span>

        <span class="s1">TagParser.prototype.parse = </span><span class="s2">function </span><span class="s1">parse() {</span>
            <span class="s2">var </span><span class="s1">i, iz, sequences, method;</span>


            <span class="s0">// empty title</span>
            <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">._title) {</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">.addError(</span><span class="s3">'Missing or invalid title'</span><span class="s1">)) {</span>
                    <span class="s2">return null</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s0">// Seek to content last index.</span>
            <span class="s2">this</span><span class="s1">._last = seekContent(</span><span class="s2">this</span><span class="s1">._title);</span>

            <span class="s2">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">._options.range) {</span>
                <span class="s2">this</span><span class="s1">._tag.range = [</span><span class="s2">this</span><span class="s1">._first, source.slice(</span><span class="s4">0</span><span class="s1">, </span><span class="s2">this</span><span class="s1">._last).replace(/\s*$/, </span><span class="s3">''</span><span class="s1">).length].map(convertIndex);</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(hasOwnProperty(Rules, </span><span class="s2">this</span><span class="s1">._title)) {</span>
                <span class="s1">sequences = Rules[</span><span class="s2">this</span><span class="s1">._title];</span>
            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s0">// default sequences</span>
                <span class="s1">sequences = [</span><span class="s3">'parseType'</span><span class="s1">, </span><span class="s3">'parseName'</span><span class="s1">, </span><span class="s3">'parseDescription'</span><span class="s1">, </span><span class="s3">'epilogue'</span><span class="s1">];</span>
            <span class="s1">}</span>

            <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">, iz = sequences.length; i &lt; iz; ++i) {</span>
                <span class="s1">method = sequences[i];</span>
                <span class="s2">if </span><span class="s1">(!</span><span class="s2">this</span><span class="s1">[method]()) {</span>
                    <span class="s2">return null</span><span class="s1">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">return this</span><span class="s1">._tag;</span>
        <span class="s1">};</span>

        <span class="s2">function </span><span class="s1">parseTag(options) {</span>
            <span class="s2">var </span><span class="s1">title, parser, tag;</span>

            <span class="s0">// skip to tag</span>
            <span class="s2">if </span><span class="s1">(!skipToTag()) {</span>
                <span class="s2">return null</span><span class="s1">;</span>
            <span class="s1">}</span>

            <span class="s0">// scan title</span>
            <span class="s1">title = scanTitle();</span>

            <span class="s0">// construct tag parser</span>
            <span class="s1">parser = </span><span class="s2">new </span><span class="s1">TagParser(options, title);</span>
            <span class="s1">tag = parser.parse();</span>

            <span class="s0">// Seek global index to end of this tag.</span>
            <span class="s2">while </span><span class="s1">(index &lt; parser._last) {</span>
                <span class="s1">advance();</span>
            <span class="s1">}</span>

            <span class="s2">return </span><span class="s1">tag;</span>
        <span class="s1">}</span>

        <span class="s0">//</span>
        <span class="s0">// Parse JSDoc</span>
        <span class="s0">//</span>

        <span class="s2">function </span><span class="s1">scanJSDocDescription(preserveWhitespace) {</span>
            <span class="s2">var </span><span class="s1">description = </span><span class="s3">''</span><span class="s1">, ch, atAllowed;</span>

            <span class="s1">atAllowed = </span><span class="s2">true</span><span class="s1">;</span>
            <span class="s2">while </span><span class="s1">(index &lt; length) {</span>
                <span class="s1">ch = source.charCodeAt(index);</span>

                <span class="s2">if </span><span class="s1">(atAllowed &amp;&amp; ch === </span><span class="s4">0</span><span class="s1">x40  </span><span class="s0">/* '@' */</span><span class="s1">) {</span>
                    <span class="s2">break</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s2">if </span><span class="s1">(esutils.code.isLineTerminator(ch)) {</span>
                    <span class="s1">atAllowed = </span><span class="s2">true</span><span class="s1">;</span>
                <span class="s1">} </span><span class="s2">else if </span><span class="s1">(atAllowed &amp;&amp; !esutils.code.isWhiteSpace(ch)) {</span>
                    <span class="s1">atAllowed = </span><span class="s2">false</span><span class="s1">;</span>
                <span class="s1">}</span>

                <span class="s1">description += advance();</span>
            <span class="s1">}</span>

            <span class="s2">return </span><span class="s1">preserveWhitespace ? description : description.trim();</span>
        <span class="s1">}</span>

        <span class="s2">function </span><span class="s1">parse(comment, options) {</span>
            <span class="s2">var </span><span class="s1">tags = [], tag, description, interestingTags, i, iz;</span>

            <span class="s2">if </span><span class="s1">(options === undefined) {</span>
                <span class="s1">options = {};</span>
            <span class="s1">}</span>

            <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">options.unwrap === </span><span class="s3">'boolean' </span><span class="s1">&amp;&amp; options.unwrap) {</span>
                <span class="s1">source = unwrapComment(comment);</span>
            <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                <span class="s1">source = comment;</span>
            <span class="s1">}</span>

            <span class="s1">originalSource = comment;</span>

            <span class="s0">// array of relevant tags</span>
            <span class="s2">if </span><span class="s1">(options.tags) {</span>
                <span class="s2">if </span><span class="s1">(Array.isArray(options.tags)) {</span>
                    <span class="s1">interestingTags = { };</span>
                    <span class="s2">for </span><span class="s1">(i = </span><span class="s4">0</span><span class="s1">, iz = options.tags.length; i &lt; iz; i++) {</span>
                        <span class="s2">if </span><span class="s1">(</span><span class="s2">typeof </span><span class="s1">options.tags[i] === </span><span class="s3">'string'</span><span class="s1">) {</span>
                            <span class="s1">interestingTags[options.tags[i]] = </span><span class="s2">true</span><span class="s1">;</span>
                        <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                            <span class="s1">utility.throwError(</span><span class="s3">'Invalid &quot;tags&quot; parameter: ' </span><span class="s1">+ options.tags);</span>
                        <span class="s1">}</span>
                    <span class="s1">}</span>
                <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
                    <span class="s1">utility.throwError(</span><span class="s3">'Invalid &quot;tags&quot; parameter: ' </span><span class="s1">+ options.tags);</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s1">length = source.length;</span>
            <span class="s1">index = </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s1">lineNumber = </span><span class="s4">0</span><span class="s1">;</span>
            <span class="s1">recoverable = options.recoverable;</span>
            <span class="s1">sloppy = options.sloppy;</span>
            <span class="s1">strict = options.strict;</span>

            <span class="s1">description = scanJSDocDescription(options.preserveWhitespace);</span>

            <span class="s2">while </span><span class="s1">(</span><span class="s2">true</span><span class="s1">) {</span>
                <span class="s1">tag = parseTag(options);</span>
                <span class="s2">if </span><span class="s1">(!tag) {</span>
                    <span class="s2">break</span><span class="s1">;</span>
                <span class="s1">}</span>
                <span class="s2">if </span><span class="s1">(!interestingTags || interestingTags.hasOwnProperty(tag.title)) {</span>
                    <span class="s1">tags.push(tag);</span>
                <span class="s1">}</span>
            <span class="s1">}</span>

            <span class="s2">return </span><span class="s1">{</span>
                <span class="s1">description: description,</span>
                <span class="s1">tags: tags</span>
            <span class="s1">};</span>
        <span class="s1">}</span>
        <span class="s1">exports.parse = parse;</span>
    <span class="s1">}(jsdoc = {}));</span>

    <span class="s1">exports.version = utility.VERSION;</span>
    <span class="s1">exports.parse = jsdoc.parse;</span>
    <span class="s1">exports.parseType = typed.parseType;</span>
    <span class="s1">exports.parseParamType = typed.parseParamType;</span>
    <span class="s1">exports.unwrapComment = unwrapComment;</span>
    <span class="s1">exports.Syntax = shallowCopy(typed.Syntax);</span>
    <span class="s1">exports.Error = utility.DoctrineError;</span>
    <span class="s1">exports.type = {</span>
        <span class="s1">Syntax: exports.Syntax,</span>
        <span class="s1">parseType: typed.parseType,</span>
        <span class="s1">parseParamType: typed.parseParamType,</span>
        <span class="s1">stringify: typed.stringify</span>
    <span class="s1">};</span>
<span class="s1">}());</span>
<span class="s0">/* vim: set sw=4 ts=4 et tw=80 : */</span>
</pre>
</body>
</html>