<html>
<head>
<title>JSCallbackObjectFunctions.h</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
JSCallbackObjectFunctions.h</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (C) 2006-2019 Apple Inc. All rights reserved. 
 * Copyright (C) 2007 Eric Seidel &lt;eric@webkit.org&gt; 
 * 
 * Redistribution and use in source and binary forms, with or without 
 * modification, are permitted provided that the following conditions 
 * are met: 
 * 1. Redistributions of source code must retain the above copyright 
 *    notice, this list of conditions and the following disclaimer. 
 * 2. Redistributions in binary form must reproduce the above copyright 
 *    notice, this list of conditions and the following disclaimer in the 
 *    documentation and/or other materials provided with the distribution. 
 * 
 * THIS SOFTWARE IS PROVIDED BY APPLE INC. ``AS IS'' AND ANY 
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR 
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR 
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, 
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, 
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR 
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY 
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT 
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  
 */</span>

<span class="s2">#include </span><span class="s3">&quot;APICast.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;Error.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;ExceptionHelpers.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;JSCallbackFunction.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;JSClassRef.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;JSFunction.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;JSGlobalObject.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;JSLock.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;JSObjectRef.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;JSString.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;OpaqueJSString.h&quot;</span>
<span class="s2">#include </span><span class="s3">&quot;PropertyNameArray.h&quot;</span>
<span class="s2">#include </span><span class="s3">&lt;wtf/Vector.h&gt;</span>

<span class="s4">namespace </span><span class="s1">JSC {</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">inline </span><span class="s1">JSCallbackObject&lt;Parent&gt;* JSCallbackObject&lt;Parent&gt;::asCallbackObject(JSValue value)</span>
<span class="s1">{</span>
    <span class="s1">ASSERT(asObject(value)-&gt;inherits(value.getObject()-&gt;vm()</span><span class="s4">, </span><span class="s1">info()))</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">jsCast&lt;JSCallbackObject*&gt;(asObject(value))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">inline </span><span class="s1">JSCallbackObject&lt;Parent&gt;* JSCallbackObject&lt;Parent&gt;::asCallbackObject(EncodedJSValue encodedValue)</span>
<span class="s1">{</span>
    <span class="s1">JSValue value = JSValue::decode(encodedValue)</span><span class="s4">;</span>
    <span class="s1">ASSERT(asObject(value)-&gt;inherits(value.getObject()-&gt;vm()</span><span class="s4">, </span><span class="s1">info()))</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">jsCast&lt;JSCallbackObject*&gt;(asObject(value))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">JSCallbackObject&lt;Parent&gt;::JSCallbackObject(ExecState* exec</span><span class="s4">, </span><span class="s1">Structure* structure</span><span class="s4">, </span><span class="s1">JSClassRef jsClass</span><span class="s4">, void</span><span class="s1">* data)</span>
    <span class="s1">: Parent(exec-&gt;vm()</span><span class="s4">, </span><span class="s1">structure)</span>
    <span class="s4">, </span><span class="s1">m_callbackObjectData(makeUnique&lt;JSCallbackObjectData&gt;(data</span><span class="s4">, </span><span class="s1">jsClass))</span>
<span class="s1">{</span>
<span class="s1">}</span>

<span class="s0">// Global object constructor.</span>
<span class="s0">// FIXME: Move this into a separate JSGlobalCallbackObject class derived from this one.</span>
<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">JSCallbackObject&lt;Parent&gt;::JSCallbackObject(VM&amp; vm</span><span class="s4">, </span><span class="s1">JSClassRef jsClass</span><span class="s4">, </span><span class="s1">Structure* structure)</span>
    <span class="s1">: Parent(vm</span><span class="s4">, </span><span class="s1">structure)</span>
    <span class="s4">, </span><span class="s1">m_callbackObjectData(makeUnique&lt;JSCallbackObjectData&gt;(</span><span class="s4">nullptr, </span><span class="s1">jsClass))</span>
<span class="s1">{</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">JSCallbackObject&lt;Parent&gt;::~JSCallbackObject()</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = </span><span class="s4">this</span><span class="s1">-&gt;HeapCell::vm()</span><span class="s4">;</span>
    <span class="s1">vm.currentlyDestructingCallbackObject = </span><span class="s4">this;</span>
    <span class="s1">ASSERT(m_classInfo)</span><span class="s4">;</span>
    <span class="s1">vm.currentlyDestructingCallbackObjectClassInfo = m_classInfo</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(</span><span class="s4">static_cast</span><span class="s1">&lt;JSObject*&gt;(</span><span class="s4">this</span><span class="s1">))</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(JSObjectFinalizeCallback finalize = jsClass-&gt;finalize)</span>
            <span class="s1">finalize(thisRef)</span><span class="s4">;</span>
    <span class="s1">}</span>
    <span class="s1">vm.currentlyDestructingCallbackObject = </span><span class="s4">nullptr;</span>
    <span class="s1">vm.currentlyDestructingCallbackObjectClassInfo = </span><span class="s4">nullptr;</span>
<span class="s1">}</span>
    
<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">void </span><span class="s1">JSCallbackObject&lt;Parent&gt;::finishCreation(ExecState* exec)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s1">Base::finishCreation(vm)</span><span class="s4">;</span>
    <span class="s1">ASSERT(Parent::inherits(vm</span><span class="s4">, </span><span class="s1">info()))</span><span class="s4">;</span>
    <span class="s1">init(exec)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s0">// This is just for Global object, so we can assume that Base::finishCreation is JSGlobalObject::finishCreation.</span>
<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">void </span><span class="s1">JSCallbackObject&lt;Parent&gt;::finishCreation(VM&amp; vm)</span>
<span class="s1">{</span>
    <span class="s1">ASSERT(Parent::inherits(vm</span><span class="s4">, </span><span class="s1">info()))</span><span class="s4">;</span>
    <span class="s1">ASSERT(Parent::isGlobalObject())</span><span class="s4">;</span>
    <span class="s1">Base::finishCreation(vm)</span><span class="s4">;</span>
    <span class="s1">init(jsCast&lt;JSGlobalObject*&gt;(</span><span class="s4">this</span><span class="s1">)-&gt;globalExec())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">void </span><span class="s1">JSCallbackObject&lt;Parent&gt;::init(ExecState* exec)</span>
<span class="s1">{</span>
    <span class="s1">ASSERT(exec)</span><span class="s4">;</span>
    
    <span class="s1">Vector&lt;JSObjectInitializeCallback</span><span class="s4">, </span><span class="s5">16</span><span class="s1">&gt; initRoutines</span><span class="s4">;</span>
    <span class="s1">JSClassRef jsClass = classRef()</span><span class="s4">;</span>
    <span class="s4">do </span><span class="s1">{</span>
        <span class="s4">if </span><span class="s1">(JSObjectInitializeCallback initialize = jsClass-&gt;initialize)</span>
            <span class="s1">initRoutines.append(initialize)</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">while </span><span class="s1">((jsClass = jsClass-&gt;parentClass))</span><span class="s4">;</span>
    
    <span class="s0">// initialize from base to derived</span>
    <span class="s4">for </span><span class="s1">(</span><span class="s4">int </span><span class="s1">i = </span><span class="s4">static_cast</span><span class="s1">&lt;</span><span class="s4">int</span><span class="s1">&gt;(initRoutines.size()) - </span><span class="s5">1</span><span class="s4">; </span><span class="s1">i &gt;= </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i--) {</span>
        <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
        <span class="s1">JSObjectInitializeCallback initialize = initRoutines[i]</span><span class="s4">;</span>
        <span class="s1">initialize(toRef(exec)</span><span class="s4">, </span><span class="s1">toRef(</span><span class="s4">this</span><span class="s1">))</span><span class="s4">;</span>
    <span class="s1">}</span>
    
    <span class="s1">m_classInfo = </span><span class="s4">this</span><span class="s1">-&gt;classInfo()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">String JSCallbackObject&lt;Parent&gt;::className(</span><span class="s4">const </span><span class="s1">JSObject* object</span><span class="s4">, </span><span class="s1">VM&amp; vm)</span>
<span class="s1">{</span>
    <span class="s4">const </span><span class="s1">JSCallbackObject* thisObject = jsCast&lt;</span><span class="s4">const </span><span class="s1">JSCallbackObject*&gt;(object)</span><span class="s4">;</span>
    <span class="s1">String thisClassName = thisObject-&gt;classRef()-&gt;className()</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(!thisClassName.isEmpty())</span>
        <span class="s4">return </span><span class="s1">thisClassName</span><span class="s4">;</span>
    
    <span class="s4">return </span><span class="s1">Parent::className(object</span><span class="s4">, </span><span class="s1">vm)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">String JSCallbackObject&lt;Parent&gt;::toStringName(</span><span class="s4">const </span><span class="s1">JSObject* object</span><span class="s4">, </span><span class="s1">ExecState* exec)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">const </span><span class="s1">ClassInfo* info = object-&gt;classInfo(vm)</span><span class="s4">;</span>
    <span class="s1">ASSERT(info)</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">info-&gt;methodTable.className(object</span><span class="s4">, </span><span class="s1">vm)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::getOwnPropertySlot(JSObject* object</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, </span><span class="s1">PropertyName propertyName</span><span class="s4">, </span><span class="s1">PropertySlot&amp; slot)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(object)</span><span class="s4">;</span>
    <span class="s1">JSContextRef ctx = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(thisObject)</span><span class="s4">;</span>
    <span class="s1">RefPtr&lt;OpaqueJSString&gt; propertyNameRef</span><span class="s4">;</span>
    
    <span class="s4">if </span><span class="s1">(StringImpl* name = propertyName.uid()) {</span>
        <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
            <span class="s0">// optional optimization to bypass getProperty in cases when we only need to know if the property exists</span>
            <span class="s4">if </span><span class="s1">(JSObjectHasPropertyCallback hasProperty = jsClass-&gt;hasProperty) {</span>
                <span class="s4">if </span><span class="s1">(!propertyNameRef)</span>
                    <span class="s1">propertyNameRef = OpaqueJSString::tryCreate(name)</span><span class="s4">;</span>
                <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                <span class="s4">if </span><span class="s1">(hasProperty(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">propertyNameRef.get())) {</span>
                    <span class="s1">slot.setCustom(thisObject</span><span class="s4">, </span><span class="s1">PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum</span><span class="s4">, </span><span class="s1">callbackGetter)</span><span class="s4">;</span>
                    <span class="s4">return true;</span>
                <span class="s1">}</span>
            <span class="s1">} </span><span class="s4">else if </span><span class="s1">(JSObjectGetPropertyCallback getProperty = jsClass-&gt;getProperty) {</span>
                <span class="s4">if </span><span class="s1">(!propertyNameRef)</span>
                    <span class="s1">propertyNameRef = OpaqueJSString::tryCreate(name)</span><span class="s4">;</span>
                <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
                <span class="s1">JSValueRef value</span><span class="s4">;</span>
                <span class="s1">{</span>
                    <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                    <span class="s1">value = getProperty(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">propertyNameRef.get()</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
                <span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(exception) {</span>
                    <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                    <span class="s1">slot.setValue(thisObject</span><span class="s4">, </span><span class="s1">PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum</span><span class="s4">, </span><span class="s1">jsUndefined())</span><span class="s4">;</span>
                    <span class="s4">return true;</span>
                <span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(value) {</span>
                    <span class="s1">slot.setValue(thisObject</span><span class="s4">, </span><span class="s1">PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">value))</span><span class="s4">;</span>
                    <span class="s4">return true;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticValuesTable* staticValues = jsClass-&gt;staticValues(exec)) {</span>
                <span class="s4">if </span><span class="s1">(staticValues-&gt;contains(name)) {</span>
                    <span class="s1">JSValue value = thisObject-&gt;getStaticValue(exec</span><span class="s4">, </span><span class="s1">propertyName)</span><span class="s4">;</span>
                    <span class="s4">if </span><span class="s1">(value) {</span>
                        <span class="s1">slot.setValue(thisObject</span><span class="s4">, </span><span class="s1">PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum</span><span class="s4">, </span><span class="s1">value)</span><span class="s4">;</span>
                        <span class="s4">return true;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticFunctionsTable* staticFunctions = jsClass-&gt;staticFunctions(exec)) {</span>
                <span class="s4">if </span><span class="s1">(staticFunctions-&gt;contains(name)) {</span>
                    <span class="s1">slot.setCustom(thisObject</span><span class="s4">, </span><span class="s1">PropertyAttribute::ReadOnly | PropertyAttribute::DontEnum</span><span class="s4">, </span><span class="s1">staticFunctionGetter)</span><span class="s4">;</span>
                    <span class="s4">return true;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">Parent::getOwnPropertySlot(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">slot)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::getOwnPropertySlotByIndex(JSObject* object</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, unsigned </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">PropertySlot&amp; slot)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">object-&gt;methodTable(vm)-&gt;getOwnPropertySlot(object</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">Identifier::from(vm</span><span class="s4">, </span><span class="s1">propertyName)</span><span class="s4">, </span><span class="s1">slot)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">JSValue JSCallbackObject&lt;Parent&gt;::defaultValue(</span><span class="s4">const </span><span class="s1">JSObject* object</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, </span><span class="s1">PreferredPrimitiveType hint)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s4">const </span><span class="s1">JSCallbackObject* thisObject = jsCast&lt;</span><span class="s4">const </span><span class="s1">JSCallbackObject*&gt;(object)</span><span class="s4">;</span>
    <span class="s1">JSContextRef ctx = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(thisObject)</span><span class="s4">;</span>
    <span class="s1">::JSType jsHint = hint == PreferString ? kJSTypeString : kJSTypeNumber</span><span class="s4">;</span>

    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(JSObjectConvertToTypeCallback convertToType = jsClass-&gt;convertToType) {</span>
            <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
            <span class="s1">JSValueRef result = convertToType(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">jsHint</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
            <span class="s4">if </span><span class="s1">(exception) {</span>
                <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                <span class="s4">return </span><span class="s1">jsUndefined()</span><span class="s4">;</span>
            <span class="s1">}</span>
            <span class="s4">if </span><span class="s1">(result)</span>
                <span class="s4">return </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">result)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    
    <span class="s4">return </span><span class="s1">Parent::defaultValue(object</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">hint)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::put(JSCell* cell</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, </span><span class="s1">PropertyName propertyName</span><span class="s4">, </span><span class="s1">JSValue value</span><span class="s4">, </span><span class="s1">PutPropertySlot&amp; slot)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(cell)</span><span class="s4">;</span>
    <span class="s1">JSContextRef ctx = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(thisObject)</span><span class="s4">;</span>
    <span class="s1">RefPtr&lt;OpaqueJSString&gt; propertyNameRef</span><span class="s4">;</span>
    <span class="s1">JSValueRef valueRef = toRef(exec</span><span class="s4">, </span><span class="s1">value)</span><span class="s4">;</span>
    
    <span class="s4">if </span><span class="s1">(StringImpl* name = propertyName.uid()) {</span>
        <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
            <span class="s4">if </span><span class="s1">(JSObjectSetPropertyCallback setProperty = jsClass-&gt;setProperty) {</span>
                <span class="s4">if </span><span class="s1">(!propertyNameRef)</span>
                    <span class="s1">propertyNameRef = OpaqueJSString::tryCreate(name)</span><span class="s4">;</span>
                <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
                <span class="s4">bool </span><span class="s1">result</span><span class="s4">;</span>
                <span class="s1">{</span>
                    <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                    <span class="s1">result = setProperty(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">propertyNameRef.get()</span><span class="s4">, </span><span class="s1">valueRef</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
                <span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(exception)</span>
                    <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                <span class="s4">if </span><span class="s1">(result || exception)</span>
                    <span class="s4">return </span><span class="s1">result</span><span class="s4">;</span>
            <span class="s1">}</span>
            
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticValuesTable* staticValues = jsClass-&gt;staticValues(exec)) {</span>
                <span class="s4">if </span><span class="s1">(StaticValueEntry* entry = staticValues-&gt;get(name)) {</span>
                    <span class="s4">if </span><span class="s1">(entry-&gt;attributes &amp; kJSPropertyAttributeReadOnly)</span>
                        <span class="s4">return false;</span>
                    <span class="s4">if </span><span class="s1">(JSObjectSetPropertyCallback setProperty = entry-&gt;setProperty) {</span>
                        <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
                        <span class="s4">bool </span><span class="s1">result</span><span class="s4">;</span>
                        <span class="s1">{</span>
                            <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                            <span class="s1">result = setProperty(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">entry-&gt;propertyNameRef.get()</span><span class="s4">, </span><span class="s1">valueRef</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
                        <span class="s1">}</span>
                        <span class="s4">if </span><span class="s1">(exception)</span>
                            <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                        <span class="s4">if </span><span class="s1">(result || exception)</span>
                            <span class="s4">return </span><span class="s1">result</span><span class="s4">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticFunctionsTable* staticFunctions = jsClass-&gt;staticFunctions(exec)) {</span>
                <span class="s4">if </span><span class="s1">(StaticFunctionEntry* entry = staticFunctions-&gt;get(name)) {</span>
                    <span class="s1">PropertySlot getSlot(thisObject</span><span class="s4">, </span><span class="s1">PropertySlot::InternalMethodType::VMInquiry)</span><span class="s4">;</span>
                    <span class="s4">if </span><span class="s1">(Parent::getOwnPropertySlot(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">getSlot))</span>
                        <span class="s4">return </span><span class="s1">Parent::put(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">slot)</span><span class="s4">;</span>
                    <span class="s4">if </span><span class="s1">(entry-&gt;attributes &amp; kJSPropertyAttributeReadOnly)</span>
                        <span class="s4">return false;</span>
                    <span class="s4">return </span><span class="s1">thisObject-&gt;JSCallbackObject&lt;Parent&gt;::putDirect(vm</span><span class="s4">, </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">value)</span><span class="s4">; </span><span class="s0">// put as override property</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">Parent::put(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">slot)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::putByIndex(JSCell* cell</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, unsigned </span><span class="s1">propertyIndex</span><span class="s4">, </span><span class="s1">JSValue value</span><span class="s4">, bool </span><span class="s1">shouldThrow)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(cell)</span><span class="s4">;</span>
    <span class="s1">JSContextRef ctx = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(thisObject)</span><span class="s4">;</span>
    <span class="s1">RefPtr&lt;OpaqueJSString&gt; propertyNameRef</span><span class="s4">;</span>
    <span class="s1">JSValueRef valueRef = toRef(exec</span><span class="s4">, </span><span class="s1">value)</span><span class="s4">;</span>
    <span class="s1">Identifier propertyName = Identifier::from(vm</span><span class="s4">, </span><span class="s1">propertyIndex)</span><span class="s4">;</span>

    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(JSObjectSetPropertyCallback setProperty = jsClass-&gt;setProperty) {</span>
            <span class="s4">if </span><span class="s1">(!propertyNameRef)</span>
                <span class="s1">propertyNameRef = OpaqueJSString::tryCreate(propertyName.impl())</span><span class="s4">;</span>
            <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
            <span class="s4">bool </span><span class="s1">result</span><span class="s4">;</span>
            <span class="s1">{</span>
                <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                <span class="s1">result = setProperty(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">propertyNameRef.get()</span><span class="s4">, </span><span class="s1">valueRef</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
            <span class="s1">}</span>
            <span class="s4">if </span><span class="s1">(exception)</span>
                <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
            <span class="s4">if </span><span class="s1">(result || exception)</span>
                <span class="s4">return </span><span class="s1">result</span><span class="s4">;</span>
        <span class="s1">}</span>

        <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticValuesTable* staticValues = jsClass-&gt;staticValues(exec)) {</span>
            <span class="s4">if </span><span class="s1">(StaticValueEntry* entry = staticValues-&gt;get(propertyName.impl())) {</span>
                <span class="s4">if </span><span class="s1">(entry-&gt;attributes &amp; kJSPropertyAttributeReadOnly)</span>
                    <span class="s4">return false;</span>
                <span class="s4">if </span><span class="s1">(JSObjectSetPropertyCallback setProperty = entry-&gt;setProperty) {</span>
                    <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
                    <span class="s4">bool </span><span class="s1">result</span><span class="s4">;</span>
                    <span class="s1">{</span>
                        <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                        <span class="s1">result = setProperty(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">entry-&gt;propertyNameRef.get()</span><span class="s4">, </span><span class="s1">valueRef</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
                    <span class="s1">}</span>
                    <span class="s4">if </span><span class="s1">(exception)</span>
                        <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                    <span class="s4">if </span><span class="s1">(result || exception)</span>
                        <span class="s4">return </span><span class="s1">result</span><span class="s4">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>

        <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticFunctionsTable* staticFunctions = jsClass-&gt;staticFunctions(exec)) {</span>
            <span class="s4">if </span><span class="s1">(StaticFunctionEntry* entry = staticFunctions-&gt;get(propertyName.impl())) {</span>
                <span class="s4">if </span><span class="s1">(entry-&gt;attributes &amp; kJSPropertyAttributeReadOnly)</span>
                    <span class="s4">return false;</span>
                <span class="s4">break;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">Parent::putByIndex(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyIndex</span><span class="s4">, </span><span class="s1">value</span><span class="s4">, </span><span class="s1">shouldThrow)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::deleteProperty(JSCell* cell</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, </span><span class="s1">PropertyName propertyName)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(cell)</span><span class="s4">;</span>
    <span class="s1">JSContextRef ctx = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(thisObject)</span><span class="s4">;</span>
    <span class="s1">RefPtr&lt;OpaqueJSString&gt; propertyNameRef</span><span class="s4">;</span>
    
    <span class="s4">if </span><span class="s1">(StringImpl* name = propertyName.uid()) {</span>
        <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
            <span class="s4">if </span><span class="s1">(JSObjectDeletePropertyCallback deleteProperty = jsClass-&gt;deleteProperty) {</span>
                <span class="s4">if </span><span class="s1">(!propertyNameRef)</span>
                    <span class="s1">propertyNameRef = OpaqueJSString::tryCreate(name)</span><span class="s4">;</span>
                <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
                <span class="s4">bool </span><span class="s1">result</span><span class="s4">;</span>
                <span class="s1">{</span>
                    <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                    <span class="s1">result = deleteProperty(ctx</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">propertyNameRef.get()</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
                <span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(exception)</span>
                    <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                <span class="s4">if </span><span class="s1">(result || exception)</span>
                    <span class="s4">return true;</span>
            <span class="s1">}</span>
            
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticValuesTable* staticValues = jsClass-&gt;staticValues(exec)) {</span>
                <span class="s4">if </span><span class="s1">(StaticValueEntry* entry = staticValues-&gt;get(name)) {</span>
                    <span class="s4">if </span><span class="s1">(entry-&gt;attributes &amp; kJSPropertyAttributeDontDelete)</span>
                        <span class="s4">return false;</span>
                    <span class="s4">return true;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
            
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticFunctionsTable* staticFunctions = jsClass-&gt;staticFunctions(exec)) {</span>
                <span class="s4">if </span><span class="s1">(StaticFunctionEntry* entry = staticFunctions-&gt;get(name)) {</span>
                    <span class="s4">if </span><span class="s1">(entry-&gt;attributes &amp; kJSPropertyAttributeDontDelete)</span>
                        <span class="s4">return false;</span>
                    <span class="s4">return true;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">Parent::deleteProperty(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyName)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::deletePropertyByIndex(JSCell* cell</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, unsigned </span><span class="s1">propertyName)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(cell)</span><span class="s4">;</span>
    <span class="s4">return </span><span class="s1">thisObject-&gt;methodTable(vm)-&gt;deleteProperty(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">Identifier::from(vm</span><span class="s4">, </span><span class="s1">propertyName))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">ConstructType JSCallbackObject&lt;Parent&gt;::getConstructData(JSCell* cell</span><span class="s4">, </span><span class="s1">ConstructData&amp; constructData)</span>
<span class="s1">{</span>
    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(cell)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(jsClass-&gt;callAsConstructor) {</span>
            <span class="s1">constructData.native.function = construct</span><span class="s4">;</span>
            <span class="s4">return </span><span class="s1">ConstructType::Host</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">return </span><span class="s1">ConstructType::None</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">EncodedJSValue JSCallbackObject&lt;Parent&gt;::construct(ExecState* exec)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSObject* constructor = exec-&gt;jsCallee()</span><span class="s4">;</span>
    <span class="s1">JSContextRef execRef = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef constructorRef = toRef(constructor)</span><span class="s4">;</span>
    
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = jsCast&lt;JSCallbackObject&lt;Parent&gt;*&gt;(constructor)-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(JSObjectCallAsConstructorCallback callAsConstructor = jsClass-&gt;callAsConstructor) {</span>
            <span class="s1">size_t argumentCount = exec-&gt;argumentCount()</span><span class="s4">;</span>
            <span class="s1">Vector&lt;JSValueRef</span><span class="s4">, </span><span class="s5">16</span><span class="s1">&gt; arguments</span><span class="s4">;</span>
            <span class="s1">arguments.reserveInitialCapacity(argumentCount)</span><span class="s4">;</span>
            <span class="s4">for </span><span class="s1">(size_t i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; argumentCount</span><span class="s4">; </span><span class="s1">++i)</span>
                <span class="s1">arguments.uncheckedAppend(toRef(exec</span><span class="s4">, </span><span class="s1">exec-&gt;uncheckedArgument(i)))</span><span class="s4">;</span>
            <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
            <span class="s1">JSObject* result</span><span class="s4">;</span>
            <span class="s1">{</span>
                <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                <span class="s1">result = toJS(callAsConstructor(execRef</span><span class="s4">, </span><span class="s1">constructorRef</span><span class="s4">, </span><span class="s1">argumentCount</span><span class="s4">, </span><span class="s1">arguments.data()</span><span class="s4">, </span><span class="s1">&amp;exception))</span><span class="s4">;</span>
            <span class="s1">}</span>
            <span class="s4">if </span><span class="s1">(exception)</span>
                <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
            <span class="s4">return </span><span class="s1">JSValue::encode(result)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    
    <span class="s1">RELEASE_ASSERT_NOT_REACHED()</span><span class="s4">; </span><span class="s0">// getConstructData should prevent us from reaching here</span>
    <span class="s4">return </span><span class="s1">JSValue::encode(JSValue())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::customHasInstance(JSObject* object</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, </span><span class="s1">JSValue value)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(object)</span><span class="s4">;</span>
    <span class="s1">JSContextRef execRef = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(thisObject)</span><span class="s4">;</span>
    
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(JSObjectHasInstanceCallback hasInstance = jsClass-&gt;hasInstance) {</span>
            <span class="s1">JSValueRef valueRef = toRef(exec</span><span class="s4">, </span><span class="s1">value)</span><span class="s4">;</span>
            <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
            <span class="s4">bool </span><span class="s1">result</span><span class="s4">;</span>
            <span class="s1">{</span>
                <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                <span class="s1">result = hasInstance(execRef</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">valueRef</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
            <span class="s1">}</span>
            <span class="s4">if </span><span class="s1">(exception)</span>
                <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
            <span class="s4">return </span><span class="s1">result</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">return false;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">CallType JSCallbackObject&lt;Parent&gt;::getCallData(JSCell* cell</span><span class="s4">, </span><span class="s1">CallData&amp; callData)</span>
<span class="s1">{</span>
    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(cell)</span><span class="s4">;</span>
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(jsClass-&gt;callAsFunction) {</span>
            <span class="s1">callData.native.function = call</span><span class="s4">;</span>
            <span class="s4">return </span><span class="s1">CallType::Host</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    <span class="s4">return </span><span class="s1">CallType::None</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">EncodedJSValue JSCallbackObject&lt;Parent&gt;::call(ExecState* exec)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSContextRef execRef = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef functionRef = toRef(exec-&gt;jsCallee())</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisObjRef = toRef(jsCast&lt;JSObject*&gt;(exec-&gt;thisValue().toThis(exec</span><span class="s4">, </span><span class="s1">NotStrictMode)))</span><span class="s4">;</span>
    
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = jsCast&lt;JSCallbackObject&lt;Parent&gt;*&gt;(toJS(functionRef))-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(JSObjectCallAsFunctionCallback callAsFunction = jsClass-&gt;callAsFunction) {</span>
            <span class="s1">size_t argumentCount = exec-&gt;argumentCount()</span><span class="s4">;</span>
            <span class="s1">Vector&lt;JSValueRef</span><span class="s4">, </span><span class="s5">16</span><span class="s1">&gt; arguments</span><span class="s4">;</span>
            <span class="s1">arguments.reserveInitialCapacity(argumentCount)</span><span class="s4">;</span>
            <span class="s4">for </span><span class="s1">(size_t i = </span><span class="s5">0</span><span class="s4">; </span><span class="s1">i &lt; argumentCount</span><span class="s4">; </span><span class="s1">++i)</span>
                <span class="s1">arguments.uncheckedAppend(toRef(exec</span><span class="s4">, </span><span class="s1">exec-&gt;uncheckedArgument(i)))</span><span class="s4">;</span>
            <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
            <span class="s1">JSValue result</span><span class="s4">;</span>
            <span class="s1">{</span>
                <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                <span class="s1">result = toJS(exec</span><span class="s4">, </span><span class="s1">callAsFunction(execRef</span><span class="s4">, </span><span class="s1">functionRef</span><span class="s4">, </span><span class="s1">thisObjRef</span><span class="s4">, </span><span class="s1">argumentCount</span><span class="s4">, </span><span class="s1">arguments.data()</span><span class="s4">, </span><span class="s1">&amp;exception))</span><span class="s4">;</span>
            <span class="s1">}</span>
            <span class="s4">if </span><span class="s1">(exception)</span>
                <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
            <span class="s4">return </span><span class="s1">JSValue::encode(result)</span><span class="s4">;</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    
    <span class="s1">RELEASE_ASSERT_NOT_REACHED()</span><span class="s4">; </span><span class="s0">// getCallData should prevent us from reaching here</span>
    <span class="s4">return </span><span class="s1">JSValue::encode(JSValue())</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">void </span><span class="s1">JSCallbackObject&lt;Parent&gt;::getOwnNonIndexPropertyNames(JSObject* object</span><span class="s4">, </span><span class="s1">ExecState* exec</span><span class="s4">, </span><span class="s1">PropertyNameArray&amp; propertyNames</span><span class="s4">, </span><span class="s1">EnumerationMode mode)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s1">JSCallbackObject* thisObject = jsCast&lt;JSCallbackObject*&gt;(object)</span><span class="s4">;</span>
    <span class="s1">JSContextRef execRef = toRef(exec)</span><span class="s4">;</span>
    <span class="s1">JSObjectRef thisRef = toRef(thisObject)</span><span class="s4">;</span>
    
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObject-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(JSObjectGetPropertyNamesCallback getPropertyNames = jsClass-&gt;getPropertyNames) {</span>
            <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
            <span class="s1">getPropertyNames(execRef</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">toRef(&amp;propertyNames))</span><span class="s4">;</span>
        <span class="s1">}</span>
        
        <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticValuesTable* staticValues = jsClass-&gt;staticValues(exec)) {</span>
            <span class="s4">typedef </span><span class="s1">OpaqueJSClassStaticValuesTable::const_iterator iterator</span><span class="s4">;</span>
            <span class="s1">iterator end = staticValues-&gt;end()</span><span class="s4">;</span>
            <span class="s4">for </span><span class="s1">(iterator it = staticValues-&gt;begin()</span><span class="s4">; </span><span class="s1">it != end</span><span class="s4">; </span><span class="s1">++it) {</span>
                <span class="s1">StringImpl* name = it-&gt;key.get()</span><span class="s4">;</span>
                <span class="s1">StaticValueEntry* entry = it-&gt;value.get()</span><span class="s4">;</span>
                <span class="s4">if </span><span class="s1">(entry-&gt;getProperty &amp;&amp; (!(entry-&gt;attributes &amp; kJSPropertyAttributeDontEnum) || mode.includeDontEnumProperties())) {</span>
                    <span class="s1">ASSERT(!name-&gt;isSymbol())</span><span class="s4">;</span>
                    <span class="s1">propertyNames.add(Identifier::fromString(vm</span><span class="s4">, </span><span class="s1">String(name)))</span><span class="s4">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
        
        <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticFunctionsTable* staticFunctions = jsClass-&gt;staticFunctions(exec)) {</span>
            <span class="s4">typedef </span><span class="s1">OpaqueJSClassStaticFunctionsTable::const_iterator iterator</span><span class="s4">;</span>
            <span class="s1">iterator end = staticFunctions-&gt;end()</span><span class="s4">;</span>
            <span class="s4">for </span><span class="s1">(iterator it = staticFunctions-&gt;begin()</span><span class="s4">; </span><span class="s1">it != end</span><span class="s4">; </span><span class="s1">++it) {</span>
                <span class="s1">StringImpl* name = it-&gt;key.get()</span><span class="s4">;</span>
                <span class="s1">StaticFunctionEntry* entry = it-&gt;value.get()</span><span class="s4">;</span>
                <span class="s4">if </span><span class="s1">(!(entry-&gt;attributes &amp; kJSPropertyAttributeDontEnum) || mode.includeDontEnumProperties()) {</span>
                    <span class="s1">ASSERT(!name-&gt;isSymbol())</span><span class="s4">;</span>
                    <span class="s1">propertyNames.add(Identifier::fromString(vm</span><span class="s4">, </span><span class="s1">String(name)))</span><span class="s4">;</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>
    
    <span class="s1">Parent::getOwnNonIndexPropertyNames(thisObject</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyNames</span><span class="s4">, </span><span class="s1">mode)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">void </span><span class="s1">JSCallbackObject&lt;Parent&gt;::setPrivate(</span><span class="s4">void</span><span class="s1">* data)</span>
<span class="s1">{</span>
    <span class="s1">m_callbackObjectData-&gt;privateData = data</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">void</span><span class="s1">* JSCallbackObject&lt;Parent&gt;::getPrivate()</span>
<span class="s1">{</span>
    <span class="s4">return </span><span class="s1">m_callbackObjectData-&gt;privateData</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s4">bool </span><span class="s1">JSCallbackObject&lt;Parent&gt;::inherits(JSClassRef c) </span><span class="s4">const</span>
<span class="s1">{</span>
    <span class="s4">for </span><span class="s1">(JSClassRef jsClass = classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
        <span class="s4">if </span><span class="s1">(jsClass == c)</span>
            <span class="s4">return true;</span>
    <span class="s1">}</span>
    <span class="s4">return false;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">JSValue JSCallbackObject&lt;Parent&gt;::getStaticValue(ExecState* exec</span><span class="s4">, </span><span class="s1">PropertyName propertyName)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSObjectRef thisRef = toRef(</span><span class="s4">this</span><span class="s1">)</span><span class="s4">;</span>
    
    <span class="s4">if </span><span class="s1">(StringImpl* name = propertyName.uid()) {</span>
        <span class="s4">for </span><span class="s1">(JSClassRef jsClass = classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticValuesTable* staticValues = jsClass-&gt;staticValues(exec)) {</span>
                <span class="s4">if </span><span class="s1">(StaticValueEntry* entry = staticValues-&gt;get(name)) {</span>
                    <span class="s4">if </span><span class="s1">(JSObjectGetPropertyCallback getProperty = entry-&gt;getProperty) {</span>
                        <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
                        <span class="s1">JSValueRef value</span><span class="s4">;</span>
                        <span class="s1">{</span>
                            <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                            <span class="s1">value = getProperty(toRef(exec)</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">entry-&gt;propertyNameRef.get()</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
                        <span class="s1">}</span>
                        <span class="s4">if </span><span class="s1">(exception) {</span>
                            <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                            <span class="s4">return </span><span class="s1">jsUndefined()</span><span class="s4">;</span>
                        <span class="s1">}</span>
                        <span class="s4">if </span><span class="s1">(value)</span>
                            <span class="s4">return </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">value)</span><span class="s4">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">JSValue()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">EncodedJSValue JSCallbackObject&lt;Parent&gt;::staticFunctionGetter(ExecState* exec</span><span class="s4">, </span><span class="s1">EncodedJSValue thisValue</span><span class="s4">, </span><span class="s1">PropertyName propertyName)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSCallbackObject* thisObj = asCallbackObject(thisValue)</span><span class="s4">;</span>
    
    <span class="s0">// Check for cached or override property.</span>
    <span class="s1">PropertySlot slot2(thisObj</span><span class="s4">, </span><span class="s1">PropertySlot::InternalMethodType::VMInquiry)</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(Parent::getOwnPropertySlot(thisObj</span><span class="s4">, </span><span class="s1">exec</span><span class="s4">, </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">slot2))</span>
        <span class="s4">return </span><span class="s1">JSValue::encode(slot2.getValue(exec</span><span class="s4">, </span><span class="s1">propertyName))</span><span class="s4">;</span>

    <span class="s4">if </span><span class="s1">(StringImpl* name = propertyName.uid()) {</span>
        <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObj-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
            <span class="s4">if </span><span class="s1">(OpaqueJSClassStaticFunctionsTable* staticFunctions = jsClass-&gt;staticFunctions(exec)) {</span>
                <span class="s4">if </span><span class="s1">(StaticFunctionEntry* entry = staticFunctions-&gt;get(name)) {</span>
                    <span class="s4">if </span><span class="s1">(JSObjectCallAsFunctionCallback callAsFunction = entry-&gt;callAsFunction) {</span>
                        <span class="s1">JSObject* o = JSCallbackFunction::create(vm</span><span class="s4">, </span><span class="s1">thisObj-&gt;globalObject(vm)</span><span class="s4">, </span><span class="s1">callAsFunction</span><span class="s4">, </span><span class="s1">name)</span><span class="s4">;</span>
                        <span class="s1">thisObj-&gt;putDirect(vm</span><span class="s4">, </span><span class="s1">propertyName</span><span class="s4">, </span><span class="s1">o</span><span class="s4">, </span><span class="s1">entry-&gt;attributes)</span><span class="s4">;</span>
                        <span class="s4">return </span><span class="s1">JSValue::encode(o)</span><span class="s4">;</span>
                    <span class="s1">}</span>
                <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">JSValue::encode(throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">createReferenceError(exec</span><span class="s4">, </span><span class="s3">&quot;Static function property defined with NULL callAsFunction callback.&quot;</span><span class="s1">_s)))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">template </span><span class="s1">&lt;</span><span class="s4">class </span><span class="s1">Parent&gt;</span>
<span class="s1">EncodedJSValue JSCallbackObject&lt;Parent&gt;::callbackGetter(ExecState* exec</span><span class="s4">, </span><span class="s1">EncodedJSValue thisValue</span><span class="s4">, </span><span class="s1">PropertyName propertyName)</span>
<span class="s1">{</span>
    <span class="s1">VM&amp; vm = exec-&gt;vm()</span><span class="s4">;</span>
    <span class="s4">auto </span><span class="s1">scope = DECLARE_THROW_SCOPE(vm)</span><span class="s4">;</span>

    <span class="s1">JSCallbackObject* thisObj = asCallbackObject(thisValue)</span><span class="s4">;</span>
    
    <span class="s1">JSObjectRef thisRef = toRef(thisObj)</span><span class="s4">;</span>
    <span class="s1">RefPtr&lt;OpaqueJSString&gt; propertyNameRef</span><span class="s4">;</span>
    
    <span class="s4">if </span><span class="s1">(StringImpl* name = propertyName.uid()) {</span>
        <span class="s4">for </span><span class="s1">(JSClassRef jsClass = thisObj-&gt;classRef()</span><span class="s4">; </span><span class="s1">jsClass</span><span class="s4">; </span><span class="s1">jsClass = jsClass-&gt;parentClass) {</span>
            <span class="s4">if </span><span class="s1">(JSObjectGetPropertyCallback getProperty = jsClass-&gt;getProperty) {</span>
                <span class="s4">if </span><span class="s1">(!propertyNameRef)</span>
                    <span class="s1">propertyNameRef = OpaqueJSString::tryCreate(name)</span><span class="s4">;</span>
                <span class="s1">JSValueRef exception = </span><span class="s5">0</span><span class="s4">;</span>
                <span class="s1">JSValueRef value</span><span class="s4">;</span>
                <span class="s1">{</span>
                    <span class="s1">JSLock::DropAllLocks dropAllLocks(exec)</span><span class="s4">;</span>
                    <span class="s1">value = getProperty(toRef(exec)</span><span class="s4">, </span><span class="s1">thisRef</span><span class="s4">, </span><span class="s1">propertyNameRef.get()</span><span class="s4">, </span><span class="s1">&amp;exception)</span><span class="s4">;</span>
                <span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(exception) {</span>
                    <span class="s1">throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">toJS(exec</span><span class="s4">, </span><span class="s1">exception))</span><span class="s4">;</span>
                    <span class="s4">return </span><span class="s1">JSValue::encode(jsUndefined())</span><span class="s4">;</span>
                <span class="s1">}</span>
                <span class="s4">if </span><span class="s1">(value)</span>
                    <span class="s4">return </span><span class="s1">JSValue::encode(toJS(exec</span><span class="s4">, </span><span class="s1">value))</span><span class="s4">;</span>
            <span class="s1">}</span>
        <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s4">return </span><span class="s1">JSValue::encode(throwException(exec</span><span class="s4">, </span><span class="s1">scope</span><span class="s4">, </span><span class="s1">createReferenceError(exec</span><span class="s4">, </span><span class="s3">&quot;hasProperty callback returned true for a property that doesn't exist.&quot;</span><span class="s1">_s)))</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">} </span><span class="s0">// namespace JSC</span>
</pre>
</body>
</html>