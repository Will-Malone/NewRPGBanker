<html>
<head>
<title>jestUtils.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #a9b7c6;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #ffc66d;}
.s6 { color: #6897bb; font-style: italic;}
.s7 { color: #9876aa; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
jestUtils.ts</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s2">invariant </span><span class="s0">from </span><span class="s3">'invariant'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">DeviceEventEmitter </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'react-native'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">ReactTestInstance </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'react-test-renderer'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">FlingGestureHandler</span><span class="s1">,</span>
  <span class="s2">FlingGestureHandlerEventPayload</span><span class="s1">,</span>
  <span class="s2">flingHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/FlingGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">ForceTouchGestureHandler</span><span class="s1">,</span>
  <span class="s2">ForceTouchGestureHandlerEventPayload</span><span class="s1">,</span>
  <span class="s2">forceTouchHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/ForceTouchGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">BaseGestureHandlerProps</span><span class="s1">,</span>
  <span class="s2">GestureEvent</span><span class="s1">,</span>
  <span class="s2">HandlerStateChangeEvent</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestureHandlerCommon'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">FlingGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/flingGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">ForceTouchGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/forceTouchGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">BaseGesture</span><span class="s1">, </span><span class="s2">GestureType </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/gesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">LongPressGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/longPressGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">NativeGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/nativeGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">PanGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/panGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">PinchGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/pinchGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">RotationGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/rotationGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">TapGesture </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/gestures/tapGesture'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">findHandlerByTestID </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/handlersRegistry'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">LongPressGestureHandler</span><span class="s1">,</span>
  <span class="s2">LongPressGestureHandlerEventPayload</span><span class="s1">,</span>
  <span class="s2">longPressHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/LongPressGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">NativeViewGestureHandler</span><span class="s1">,</span>
  <span class="s2">NativeViewGestureHandlerPayload</span><span class="s1">,</span>
  <span class="s2">nativeViewHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/NativeViewGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">PanGestureHandler</span><span class="s1">,</span>
  <span class="s2">PanGestureHandlerEventPayload</span><span class="s1">,</span>
  <span class="s2">panHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/PanGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">PinchGestureHandler</span><span class="s1">,</span>
  <span class="s2">PinchGestureHandlerEventPayload</span><span class="s1">,</span>
  <span class="s2">pinchHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/PinchGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">RotationGestureHandler</span><span class="s1">,</span>
  <span class="s2">RotationGestureHandlerEventPayload</span><span class="s1">,</span>
  <span class="s2">rotationHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/RotationGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{</span>
  <span class="s2">TapGestureHandler</span><span class="s1">,</span>
  <span class="s2">TapGestureHandlerEventPayload</span><span class="s1">,</span>
  <span class="s2">tapHandlerName</span><span class="s1">,</span>
<span class="s1">} </span><span class="s0">from </span><span class="s3">'../handlers/TapGestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">State </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../State'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">hasProperty</span><span class="s1">, </span><span class="s2">withPrevAndCurrent </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../utils'</span><span class="s1">;</span>

<span class="s4">// load fireEvent conditionally, so RNGH may be used in setups without testing-library</span>
<span class="s0">let </span><span class="s1">fireEvent </span><span class="s0">= </span><span class="s1">(</span>
  <span class="s2">_element</span><span class="s0">: </span><span class="s2">ReactTestInstance</span><span class="s1">,</span>
  <span class="s2">_name</span><span class="s0">: </span><span class="s2">string</span><span class="s1">,</span>
  <span class="s0">...</span><span class="s2">_data</span><span class="s0">: </span><span class="s2">any</span><span class="s1">[]</span>
<span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
  <span class="s4">// NOOP</span>
<span class="s1">}; 
</span>
<span class="s0">try </span><span class="s1">{</span>
  <span class="s4">// eslint-disable-next-line @typescript-eslint/no-var-requires</span>
  <span class="s2">fireEvent </span><span class="s0">= </span><span class="s5">require</span><span class="s1">(</span><span class="s3">'@testing-library/react-native'</span><span class="s1">).</span><span class="s2">fireEvent</span><span class="s1">;</span>
<span class="s1">} </span><span class="s0">catch </span><span class="s1">(</span><span class="s2">_e</span><span class="s1">) {</span>
  <span class="s4">// do nothing if not available</span>
<span class="s1">}</span>

<span class="s0">type </span><span class="s2">GestureHandlerTestEvent</span><span class="s1">&lt;</span>
  <span class="s2">TEventPayload </span><span class="s0">extends </span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt; </span><span class="s0">= </span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt;</span>
<span class="s1">&gt; </span><span class="s0">= </span><span class="s1">(</span>
  <span class="s0">| </span><span class="s2">GestureEvent</span><span class="s1">&lt;</span><span class="s2">TEventPayload</span><span class="s1">&gt;</span>
  <span class="s0">| </span><span class="s2">HandlerStateChangeEvent</span><span class="s1">&lt;</span><span class="s2">TEventPayload</span><span class="s1">&gt;</span>
<span class="s1">)[</span><span class="s3">'nativeEvent'</span><span class="s1">];</span>

<span class="s0">type </span><span class="s2">HandlerNames </span><span class="s0">= keyof </span><span class="s2">DefaultEventsMapping</span><span class="s1">;</span>

<span class="s0">type </span><span class="s2">WithNumberOfPointers</span><span class="s1">&lt;</span><span class="s2">T</span><span class="s1">&gt; </span><span class="s0">= </span><span class="s1">{</span>
  <span class="s1">[</span><span class="s2">P </span><span class="s0">in keyof </span><span class="s2">T</span><span class="s1">]</span><span class="s0">: </span><span class="s2">T</span><span class="s1">[</span><span class="s2">P</span><span class="s1">] </span><span class="s0">&amp; </span><span class="s1">{ numberOfPointers</span><span class="s0">: </span><span class="s2">number </span><span class="s1">};</span>
<span class="s1">};</span>
<span class="s0">type </span><span class="s2">DefaultEventsMapping </span><span class="s0">= </span><span class="s2">WithNumberOfPointers</span><span class="s1">&lt;{</span>
  <span class="s1">[</span><span class="s2">flingHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">FlingGestureHandlerEventPayload</span><span class="s1">;</span>
  <span class="s1">[</span><span class="s2">forceTouchHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">ForceTouchGestureHandlerEventPayload</span><span class="s1">;</span>
  <span class="s1">[</span><span class="s2">longPressHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">LongPressGestureHandlerEventPayload</span><span class="s1">;</span>
  <span class="s1">[</span><span class="s2">nativeViewHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">NativeViewGestureHandlerPayload</span><span class="s1">;</span>
  <span class="s1">[</span><span class="s2">panHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">PanGestureHandlerEventPayload</span><span class="s1">;</span>
  <span class="s1">[</span><span class="s2">pinchHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">PinchGestureHandlerEventPayload</span><span class="s1">;</span>
  <span class="s1">[</span><span class="s2">rotationHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">RotationGestureHandlerEventPayload</span><span class="s1">;</span>
  <span class="s1">[</span><span class="s2">tapHandlerName</span><span class="s1">]</span><span class="s0">: </span><span class="s2">TapGestureHandlerEventPayload</span><span class="s1">;</span>
<span class="s1">}&gt;;</span>

<span class="s0">const </span><span class="s1">handlersDefaultEvents</span><span class="s0">: </span><span class="s2">DefaultEventsMapping </span><span class="s0">= </span><span class="s1">{</span>
  <span class="s1">[</span><span class="s2">flingHandlerName</span><span class="s1">]: {</span>
    <span class="s1">x: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">y: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteX: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">1</span><span class="s1">,</span>
  <span class="s1">},</span>
  <span class="s1">[</span><span class="s2">forceTouchHandlerName</span><span class="s1">]: {</span>
    <span class="s1">x: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">y: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteX: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">force: </span><span class="s6">1</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">1</span><span class="s1">,</span>
  <span class="s1">},</span>
  <span class="s1">[</span><span class="s2">longPressHandlerName</span><span class="s1">]: {</span>
    <span class="s1">x: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">y: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteX: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">duration: </span><span class="s6">100</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">1</span><span class="s1">,</span>
  <span class="s1">},</span>
  <span class="s1">[</span><span class="s2">nativeViewHandlerName</span><span class="s1">]: {</span>
    <span class="s1">pointerInside: </span><span class="s7">true</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">1</span><span class="s1">,</span>
  <span class="s1">},</span>
  <span class="s1">[</span><span class="s2">panHandlerName</span><span class="s1">]: {</span>
    <span class="s1">x: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">y: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteX: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">translationX: </span><span class="s6">100</span><span class="s1">,</span>
    <span class="s1">translationY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">velocityX: </span><span class="s6">3</span><span class="s1">,</span>
    <span class="s1">velocityY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">1</span><span class="s1">,</span>
  <span class="s1">},</span>
  <span class="s1">[</span><span class="s2">pinchHandlerName</span><span class="s1">]: {</span>
    <span class="s1">focalX: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">focalY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">scale: </span><span class="s6">2</span><span class="s1">,</span>
    <span class="s1">velocity: </span><span class="s6">1</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">2</span><span class="s1">,</span>
  <span class="s1">},</span>
  <span class="s1">[</span><span class="s2">rotationHandlerName</span><span class="s1">]: {</span>
    <span class="s1">anchorX: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">anchorY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">rotation: </span><span class="s6">3.14</span><span class="s1">,</span>
    <span class="s1">velocity: </span><span class="s6">2</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">2</span><span class="s1">,</span>
  <span class="s1">},</span>
  <span class="s1">[</span><span class="s2">tapHandlerName</span><span class="s1">]: {</span>
    <span class="s1">x: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">y: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteX: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">absoluteY: </span><span class="s6">0</span><span class="s1">,</span>
    <span class="s1">numberOfPointers: </span><span class="s6">1</span><span class="s1">,</span>
  <span class="s1">},</span>
<span class="s1">};</span>

<span class="s0">function </span><span class="s1">isGesture(</span>
  <span class="s2">componentOrGesture</span><span class="s0">: </span><span class="s2">ReactTestInstance </span><span class="s0">| </span><span class="s2">GestureType</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">componentOrGesture </span><span class="s0">is </span><span class="s2">GestureType </span><span class="s1">{</span>
  <span class="s0">return </span><span class="s2">componentOrGesture </span><span class="s0">instanceof </span><span class="s2">BaseGesture</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">interface </span><span class="s2">WrappedGestureHandlerTestEvent </span><span class="s1">{</span>
  <span class="s1">nativeEvent</span><span class="s0">: </span><span class="s2">GestureHandlerTestEvent</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">wrapWithNativeEvent(</span>
  <span class="s2">event</span><span class="s0">: </span><span class="s2">GestureHandlerTestEvent</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">WrappedGestureHandlerTestEvent </span><span class="s1">{</span>
  <span class="s0">return </span><span class="s1">{ nativeEvent: </span><span class="s2">event </span><span class="s1">};</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">fillOldStateChanges(</span>
  <span class="s2">previousEvent</span><span class="s0">: </span><span class="s2">GestureHandlerTestEvent </span><span class="s0">| </span><span class="s2">null</span><span class="s1">,</span>
  <span class="s2">currentEvent</span><span class="s0">: </span><span class="s2">Omit</span><span class="s1">&lt;</span><span class="s2">GestureHandlerTestEvent</span><span class="s1">, </span><span class="s3">'oldState'</span><span class="s1">&gt;</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">GestureHandlerTestEvent </span><span class="s1">{</span>
  <span class="s0">const </span><span class="s1">isFirstEvent </span><span class="s0">= </span><span class="s2">previousEvent </span><span class="s0">=== </span><span class="s7">null</span><span class="s1">;</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">isFirstEvent</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s1">{</span>
      <span class="s1">oldState: </span><span class="s2">State</span><span class="s1">.</span><span class="s2">UNDETERMINED</span><span class="s1">,</span>
      <span class="s0">...</span><span class="s2">currentEvent</span><span class="s1">,</span>
    <span class="s1">} </span><span class="s0">as </span><span class="s2">GestureHandlerTestEvent</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">isGestureStateEvent </span><span class="s0">= </span><span class="s2">previousEvent</span><span class="s1">.</span><span class="s2">state </span><span class="s0">!== </span><span class="s2">currentEvent</span><span class="s1">.</span><span class="s2">state</span><span class="s1">;</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">isGestureStateEvent</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s1">{</span>
      <span class="s1">oldState: </span><span class="s2">previousEvent</span><span class="s1">?.</span><span class="s2">state</span><span class="s1">,</span>
      <span class="s0">...</span><span class="s2">currentEvent</span><span class="s1">,</span>
    <span class="s1">} </span><span class="s0">as </span><span class="s2">GestureHandlerTestEvent</span><span class="s1">;</span>
  <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
    <span class="s0">return </span><span class="s2">currentEvent </span><span class="s0">as </span><span class="s2">GestureHandlerTestEvent</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">type </span><span class="s2">EventWithStates </span><span class="s0">= </span><span class="s2">Partial</span><span class="s1">&lt;</span>
  <span class="s2">Pick</span><span class="s1">&lt;</span><span class="s2">GestureHandlerTestEvent</span><span class="s1">, </span><span class="s3">'oldState' </span><span class="s0">| </span><span class="s3">'state'</span><span class="s1">&gt;</span>
<span class="s1">&gt;;</span>
<span class="s0">function </span><span class="s1">validateStateTransitions(</span>
  <span class="s2">previousEvent</span><span class="s0">: </span><span class="s2">EventWithStates </span><span class="s0">| </span><span class="s2">null</span><span class="s1">,</span>
  <span class="s2">currentEvent</span><span class="s0">: </span><span class="s2">EventWithStates</span>
<span class="s1">) {</span>
  <span class="s0">function </span><span class="s1">stringify(</span><span class="s2">event</span><span class="s0">: </span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt; </span><span class="s0">| </span><span class="s2">null</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s2">JSON</span><span class="s1">.</span><span class="s5">stringify</span><span class="s1">(</span><span class="s2">event</span><span class="s1">, </span><span class="s7">null</span><span class="s1">, </span><span class="s6">2</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s0">function </span><span class="s1">errorMsgWithBothEvents(</span><span class="s2">description</span><span class="s0">: </span><span class="s2">string</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s3">`${</span><span class="s2">description</span><span class="s3">}, invalid event: ${</span><span class="s5">stringify</span><span class="s3">(</span>
      <span class="s2">currentEvent</span>
    <span class="s3">)}, previous event: ${</span><span class="s5">stringify</span><span class="s3">(</span><span class="s2">previousEvent</span><span class="s3">)}`</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">function </span><span class="s1">errorMsgWithCurrentEvent(</span><span class="s2">description</span><span class="s0">: </span><span class="s2">string</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s3">`${</span><span class="s2">description</span><span class="s3">}, invalid event: ${</span><span class="s5">stringify</span><span class="s3">(</span><span class="s2">currentEvent</span><span class="s3">)}`</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s5">invariant</span><span class="s1">(</span>
    <span class="s5">hasProperty</span><span class="s1">(</span><span class="s2">currentEvent</span><span class="s1">, </span><span class="s3">'state'</span><span class="s1">),</span>
    <span class="s5">errorMsgWithCurrentEvent</span><span class="s1">(</span><span class="s3">'every event must have state'</span><span class="s1">)</span>
  <span class="s1">);</span>

  <span class="s0">const </span><span class="s1">isFirstEvent </span><span class="s0">= </span><span class="s2">previousEvent </span><span class="s0">=== </span><span class="s7">null</span><span class="s1">;</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">isFirstEvent</span><span class="s1">) {</span>
    <span class="s5">invariant</span><span class="s1">(</span>
      <span class="s2">currentEvent</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">,</span>
      <span class="s5">errorMsgWithCurrentEvent</span><span class="s1">(</span><span class="s3">'first event must have BEGAN state'</span><span class="s1">)</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">previousEvent </span><span class="s0">!== </span><span class="s7">null</span><span class="s1">) {</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">previousEvent</span><span class="s1">.</span><span class="s2">state </span><span class="s0">!== </span><span class="s2">currentEvent</span><span class="s1">.</span><span class="s2">state</span><span class="s1">) {</span>
      <span class="s5">invariant</span><span class="s1">(</span>
        <span class="s5">hasProperty</span><span class="s1">(</span><span class="s2">currentEvent</span><span class="s1">, </span><span class="s3">'oldState'</span><span class="s1">),</span>
        <span class="s5">errorMsgWithCurrentEvent</span><span class="s1">(</span>
          <span class="s3">'when state changes, oldState field should be present'</span>
        <span class="s1">)</span>
      <span class="s1">);</span>
      <span class="s5">invariant</span><span class="s1">(</span>
        <span class="s2">currentEvent</span><span class="s1">.</span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">previousEvent</span><span class="s1">.</span><span class="s2">state</span><span class="s1">,</span>
        <span class="s5">errorMsgWithBothEvents</span><span class="s1">(</span>
          <span class="s3">&quot;when state changes, oldState should be the same as previous event' state&quot;</span>
        <span class="s1">)</span>
      <span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">return </span><span class="s2">currentEvent</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">type </span><span class="s2">EventWithoutStates </span><span class="s0">= </span><span class="s2">Omit</span><span class="s1">&lt;</span><span class="s2">GestureHandlerTestEvent</span><span class="s1">, </span><span class="s3">'oldState' </span><span class="s0">| </span><span class="s3">'state'</span><span class="s1">&gt;;</span>
<span class="s0">interface </span><span class="s2">HandlerInfo </span><span class="s1">{</span>
  <span class="s1">handlerType</span><span class="s0">: </span><span class="s2">HandlerNames</span><span class="s1">;</span>
  <span class="s1">handlerTag</span><span class="s0">: </span><span class="s2">number</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">fillMissingDefaultsFor({</span>
  <span class="s2">handlerType</span><span class="s1">,</span>
  <span class="s2">handlerTag</span><span class="s1">,</span>
<span class="s1">}</span><span class="s0">: </span><span class="s2">HandlerInfo</span><span class="s1">)</span><span class="s0">: </span><span class="s1">(</span>
  <span class="s2">event</span><span class="s0">: </span><span class="s2">Partial</span><span class="s1">&lt;</span><span class="s2">GestureHandlerTestEvent</span><span class="s1">&gt;</span>
<span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">EventWithoutStates </span><span class="s1">{</span>
  <span class="s0">return </span><span class="s1">(</span><span class="s2">event</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
    <span class="s0">return </span><span class="s1">{</span>
      <span class="s0">...</span><span class="s2">handlersDefaultEvents</span><span class="s1">[</span><span class="s2">handlerType</span><span class="s1">],</span>
      <span class="s0">...</span><span class="s2">event</span><span class="s1">,</span>
      <span class="s2">handlerTag</span><span class="s1">,</span>
    <span class="s1">};</span>
  <span class="s1">};</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">isDiscreteHandler(</span><span class="s2">handlerType</span><span class="s0">: </span><span class="s2">HandlerNames</span><span class="s1">) {</span>
  <span class="s0">return </span><span class="s1">(</span>
    <span class="s2">handlerType </span><span class="s0">=== </span><span class="s3">'TapGestureHandler' </span><span class="s0">||</span>
    <span class="s2">handlerType </span><span class="s0">=== </span><span class="s3">'LongPressGestureHandler'</span>
  <span class="s1">);</span>
<span class="s1">}</span>

<span class="s0">function </span><span class="s1">fillMissingStatesTransitions(</span>
  <span class="s2">events</span><span class="s0">: </span><span class="s2">EventWithoutStates</span><span class="s1">[],</span>
  <span class="s2">isDiscreteHandler</span><span class="s0">: </span><span class="s2">boolean</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">EventWithoutStates</span><span class="s1">[] {</span>
  <span class="s0">type </span><span class="s2">Event </span><span class="s0">= </span><span class="s2">EventWithoutStates </span><span class="s0">| </span><span class="s2">null</span><span class="s1">;</span>
  <span class="s0">const </span><span class="s1">_events </span><span class="s0">= </span><span class="s1">[</span><span class="s0">...</span><span class="s2">events</span><span class="s1">];</span>
  <span class="s0">const </span><span class="s1">lastEvent </span><span class="s0">= </span><span class="s2">_events</span><span class="s1">[</span><span class="s2">_events</span><span class="s1">.length </span><span class="s0">- </span><span class="s6">1</span><span class="s1">] </span><span class="s0">?? </span><span class="s7">null</span><span class="s1">;</span>
  <span class="s0">const </span><span class="s1">firstEvent </span><span class="s0">= </span><span class="s2">_events</span><span class="s1">[</span><span class="s6">0</span><span class="s1">] </span><span class="s0">?? </span><span class="s7">null</span><span class="s1">;</span>

  <span class="s0">const </span><span class="s1">shouldDuplicateFirstEvent </span><span class="s0">=</span>
    <span class="s0">!</span><span class="s2">isDiscreteHandler </span><span class="s0">&amp;&amp; !</span><span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">)(</span><span class="s2">firstEvent</span><span class="s1">);</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">shouldDuplicateFirstEvent</span><span class="s1">) {</span>
    <span class="s0">const </span><span class="s1">duplicated </span><span class="s0">= </span><span class="s1">{ </span><span class="s0">...</span><span class="s2">firstEvent</span><span class="s1">, state: </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN </span><span class="s1">};</span>
    <span class="s4">// @ts-ignore badly typed, property may exist and we don't want to copy it</span>
    <span class="s0">delete </span><span class="s2">duplicated</span><span class="s1">.</span><span class="s2">oldState</span><span class="s1">;</span>
    <span class="s2">_events</span><span class="s1">.</span><span class="s5">unshift</span><span class="s1">(</span><span class="s2">duplicated</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">shouldDuplicateLastEvent </span><span class="s0">=</span>
    <span class="s0">!</span><span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">)(</span><span class="s2">lastEvent</span><span class="s1">) </span><span class="s0">||</span>
    <span class="s0">!</span><span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">FAILED</span><span class="s1">)(</span><span class="s2">lastEvent</span><span class="s1">) </span><span class="s0">||</span>
    <span class="s0">!</span><span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED</span><span class="s1">)(</span><span class="s2">lastEvent</span><span class="s1">);</span>

  <span class="s0">if </span><span class="s1">(</span><span class="s2">shouldDuplicateLastEvent</span><span class="s1">) {</span>
    <span class="s0">const </span><span class="s1">duplicated </span><span class="s0">= </span><span class="s1">{ </span><span class="s0">...</span><span class="s2">lastEvent</span><span class="s1">, state: </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END </span><span class="s1">};</span>
    <span class="s4">// @ts-ignore badly typed, property may exist and we don't want to copy it</span>
    <span class="s0">delete </span><span class="s2">duplicated</span><span class="s1">.</span><span class="s2">oldState</span><span class="s1">;</span>
    <span class="s2">_events</span><span class="s1">.</span><span class="s5">push</span><span class="s1">(</span><span class="s2">duplicated</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">function </span><span class="s1">isWithoutState(</span><span class="s2">event</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s2">event </span><span class="s0">!== </span><span class="s7">null </span><span class="s0">&amp;&amp; !</span><span class="s5">hasProperty</span><span class="s1">(</span><span class="s2">event</span><span class="s1">, </span><span class="s3">'state'</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s0">function </span><span class="s1">hasState(</span><span class="s2">state</span><span class="s0">: </span><span class="s2">State</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s1">(</span><span class="s2">event</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">event </span><span class="s0">!== </span><span class="s7">null </span><span class="s0">&amp;&amp; </span><span class="s2">event</span><span class="s1">.</span><span class="s2">state </span><span class="s0">=== </span><span class="s2">state</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">function </span><span class="s1">noEventsLeft(</span><span class="s2">event</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) {</span>
    <span class="s0">return </span><span class="s2">event </span><span class="s0">=== </span><span class="s7">null</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">function </span><span class="s1">trueFn() {</span>
    <span class="s0">return </span><span class="s7">true</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">interface </span><span class="s2">Args </span><span class="s1">{</span>
    <span class="s1">shouldConsumeEvent</span><span class="s0">?: </span><span class="s1">(</span><span class="s2">event</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">boolean</span><span class="s1">;</span>
    <span class="s1">shouldTransitionToNextState</span><span class="s0">?: </span><span class="s1">(</span><span class="s2">nextEvent</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">boolean</span><span class="s1">;</span>
  <span class="s1">}</span>
  <span class="s0">function </span><span class="s1">fillEventsForCurrentState({</span>
    <span class="s2">shouldConsumeEvent </span><span class="s0">= </span><span class="s2">trueFn</span><span class="s1">,</span>
    <span class="s2">shouldTransitionToNextState </span><span class="s0">= </span><span class="s2">trueFn</span><span class="s1">,</span>
  <span class="s1">}</span><span class="s0">: </span><span class="s2">Args</span><span class="s1">) {</span>
    <span class="s0">function </span><span class="s1">peekCurrentEvent()</span><span class="s0">: </span><span class="s2">Event </span><span class="s1">{</span>
      <span class="s0">return </span><span class="s2">_events</span><span class="s1">[</span><span class="s6">0</span><span class="s1">] </span><span class="s0">?? </span><span class="s7">null</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s0">function </span><span class="s1">peekNextEvent()</span><span class="s0">: </span><span class="s2">Event </span><span class="s1">{</span>
      <span class="s0">return </span><span class="s2">_events</span><span class="s1">[</span><span class="s6">1</span><span class="s1">] </span><span class="s0">?? </span><span class="s7">null</span><span class="s1">;</span>
    <span class="s1">}</span>
    <span class="s0">function </span><span class="s1">consumeCurrentEvent() {</span>
      <span class="s2">_events</span><span class="s1">.</span><span class="s5">shift</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s0">const </span><span class="s1">currentEvent </span><span class="s0">= </span><span class="s5">peekCurrentEvent</span><span class="s1">();</span>
    <span class="s0">const </span><span class="s1">nextEvent </span><span class="s0">= </span><span class="s5">peekNextEvent</span><span class="s1">();</span>
    <span class="s0">const </span><span class="s1">currentRequiredState </span><span class="s0">= </span><span class="s2">REQUIRED_EVENTS</span><span class="s1">[</span><span class="s2">currentStateIdx</span><span class="s1">];</span>

    <span class="s0">let </span><span class="s1">eventData </span><span class="s0">= </span><span class="s1">{};</span>
    <span class="s0">const </span><span class="s1">shouldUseEvent </span><span class="s0">= </span><span class="s5">shouldConsumeEvent</span><span class="s1">(</span><span class="s2">currentEvent</span><span class="s1">);</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">shouldUseEvent</span><span class="s1">) {</span>
      <span class="s2">eventData </span><span class="s0">= </span><span class="s2">currentEvent</span><span class="s0">!</span><span class="s1">;</span>
      <span class="s5">consumeCurrentEvent</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s2">transformedEvents</span><span class="s1">.</span><span class="s5">push</span><span class="s1">({ state: </span><span class="s2">currentRequiredState</span><span class="s1">, </span><span class="s0">...</span><span class="s2">eventData </span><span class="s1">});</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s5">shouldTransitionToNextState</span><span class="s1">(</span><span class="s2">nextEvent</span><span class="s1">)) {</span>
      <span class="s2">currentStateIdx</span><span class="s0">++</span><span class="s1">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">const </span><span class="s1">REQUIRED_EVENTS </span><span class="s0">= </span><span class="s1">[</span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">, </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">, </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">];</span>

  <span class="s0">let </span><span class="s1">currentStateIdx </span><span class="s0">= </span><span class="s6">0</span><span class="s1">;</span>
  <span class="s0">const </span><span class="s1">transformedEvents</span><span class="s0">: </span><span class="s2">EventWithoutStates</span><span class="s1">[] </span><span class="s0">= </span><span class="s1">[];</span>
  <span class="s0">let </span><span class="s1">hasAllStates;</span>
  <span class="s0">let </span><span class="s1">iterations </span><span class="s0">= </span><span class="s6">0</span><span class="s1">;</span>
  <span class="s0">do </span><span class="s1">{</span>
    <span class="s0">const </span><span class="s1">nextRequiredState </span><span class="s0">= </span><span class="s2">REQUIRED_EVENTS</span><span class="s1">[</span><span class="s2">currentStateIdx</span><span class="s1">];</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">nextRequiredState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">) {</span>
      <span class="s5">fillEventsForCurrentState</span><span class="s1">({</span>
        <span class="s5">shouldConsumeEvent</span><span class="s1">: (</span><span class="s2">e</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) </span><span class="s0">=&gt;</span>
          <span class="s5">isWithoutState</span><span class="s1">(</span><span class="s2">e</span><span class="s1">) </span><span class="s0">|| </span><span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">)(</span><span class="s2">e</span><span class="s1">),</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s2">nextRequiredState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">) {</span>
      <span class="s0">const </span><span class="s1">shouldConsumeEvent </span><span class="s0">= </span><span class="s1">(</span><span class="s2">e</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) </span><span class="s0">=&gt;</span>
        <span class="s5">isWithoutState</span><span class="s1">(</span><span class="s2">e</span><span class="s1">) </span><span class="s0">|| </span><span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">)(</span><span class="s2">e</span><span class="s1">);</span>
      <span class="s0">const </span><span class="s1">shouldTransitionToNextState </span><span class="s0">= </span><span class="s1">(</span><span class="s2">nextEvent</span><span class="s0">: </span><span class="s2">Event</span><span class="s1">) </span><span class="s0">=&gt;</span>
        <span class="s5">noEventsLeft</span><span class="s1">(</span><span class="s2">nextEvent</span><span class="s1">) </span><span class="s0">||</span>
        <span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">)(</span><span class="s2">nextEvent</span><span class="s1">) </span><span class="s0">||</span>
        <span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">FAILED</span><span class="s1">)(</span><span class="s2">nextEvent</span><span class="s1">) </span><span class="s0">||</span>
        <span class="s5">hasState</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED</span><span class="s1">)(</span><span class="s2">nextEvent</span><span class="s1">);</span>

      <span class="s5">fillEventsForCurrentState</span><span class="s1">({</span>
        <span class="s2">shouldConsumeEvent</span><span class="s1">,</span>
        <span class="s2">shouldTransitionToNextState</span><span class="s1">,</span>
      <span class="s1">});</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s2">nextRequiredState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">) {</span>
      <span class="s5">fillEventsForCurrentState</span><span class="s1">({});</span>
    <span class="s1">}</span>
    <span class="s2">hasAllStates </span><span class="s0">= </span><span class="s2">currentStateIdx </span><span class="s0">=== </span><span class="s2">REQUIRED_EVENTS</span><span class="s1">.length;</span>

    <span class="s5">invariant</span><span class="s1">(</span>
      <span class="s2">iterations</span><span class="s0">++ &lt;= </span><span class="s6">500</span><span class="s1">,</span>
      <span class="s3">'exceeded max number of iterations, please report a bug in RNGH repository with your test case'</span>
    <span class="s1">);</span>
  <span class="s1">} </span><span class="s0">while </span><span class="s1">(</span><span class="s0">!</span><span class="s2">hasAllStates</span><span class="s1">);</span>

  <span class="s0">return </span><span class="s2">transformedEvents</span><span class="s1">;</span>
<span class="s1">}</span>

<span class="s0">type </span><span class="s2">EventEmitter </span><span class="s0">= </span><span class="s1">(</span>
  <span class="s2">eventName</span><span class="s0">: </span><span class="s2">string</span><span class="s1">,</span>
  <span class="s2">args</span><span class="s0">: </span><span class="s1">{ nativeEvent</span><span class="s0">: </span><span class="s2">GestureHandlerTestEvent </span><span class="s1">}</span>
<span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">void</span><span class="s1">;</span>
<span class="s0">interface </span><span class="s2">HandlerData </span><span class="s1">{</span>
  <span class="s1">emitEvent</span><span class="s0">: </span><span class="s2">EventEmitter</span><span class="s1">;</span>
  <span class="s1">handlerType</span><span class="s0">: </span><span class="s2">HandlerNames</span><span class="s1">;</span>
  <span class="s1">handlerTag</span><span class="s0">: </span><span class="s2">number</span><span class="s1">;</span>
<span class="s1">}</span>
<span class="s0">function </span><span class="s1">getHandlerData(</span>
  <span class="s2">componentOrGesture</span><span class="s0">: </span><span class="s2">ReactTestInstance </span><span class="s0">| </span><span class="s2">GestureType</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">HandlerData </span><span class="s1">{</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s5">isGesture</span><span class="s1">(</span><span class="s2">componentOrGesture</span><span class="s1">)) {</span>
    <span class="s0">const </span><span class="s1">gesture </span><span class="s0">= </span><span class="s2">componentOrGesture</span><span class="s1">;</span>
    <span class="s0">return </span><span class="s1">{</span>
      <span class="s5">emitEvent</span><span class="s1">: (</span><span class="s2">eventName</span><span class="s1">, </span><span class="s2">args</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
        <span class="s2">DeviceEventEmitter</span><span class="s1">.</span><span class="s5">emit</span><span class="s1">(</span><span class="s2">eventName</span><span class="s1">, </span><span class="s2">args</span><span class="s1">.</span><span class="s2">nativeEvent</span><span class="s1">);</span>
      <span class="s1">},</span>
      <span class="s1">handlerType: </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerName </span><span class="s0">as </span><span class="s2">HandlerNames</span><span class="s1">,</span>
      <span class="s1">handlerTag: </span><span class="s2">gesture</span><span class="s1">.</span><span class="s2">handlerTag</span><span class="s1">,</span>
    <span class="s1">};</span>
  <span class="s1">}</span>
  <span class="s0">const </span><span class="s1">gestureHandlerComponent </span><span class="s0">= </span><span class="s2">componentOrGesture</span><span class="s1">;</span>
  <span class="s0">return </span><span class="s1">{</span>
    <span class="s5">emitEvent</span><span class="s1">: (</span><span class="s2">eventName</span><span class="s1">, </span><span class="s2">args</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s5">fireEvent</span><span class="s1">(</span><span class="s2">gestureHandlerComponent</span><span class="s1">, </span><span class="s2">eventName</span><span class="s1">, </span><span class="s2">args</span><span class="s1">);</span>
    <span class="s1">},</span>
    <span class="s1">handlerType: </span><span class="s2">gestureHandlerComponent</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">handlerType </span><span class="s0">as </span><span class="s2">HandlerNames</span><span class="s1">,</span>
    <span class="s1">handlerTag: </span><span class="s2">gestureHandlerComponent</span><span class="s1">.</span><span class="s2">props</span><span class="s1">.</span><span class="s2">handlerTag </span><span class="s0">as </span><span class="s2">number</span><span class="s1">,</span>
  <span class="s1">};</span>
<span class="s1">}</span>
<span class="s0">type </span><span class="s2">AllGestures </span><span class="s0">=</span>
  <span class="s0">| </span><span class="s2">TapGesture</span>
  <span class="s0">| </span><span class="s2">PanGesture</span>
  <span class="s0">| </span><span class="s2">LongPressGesture</span>
  <span class="s0">| </span><span class="s2">RotationGesture</span>
  <span class="s0">| </span><span class="s2">PinchGesture</span>
  <span class="s0">| </span><span class="s2">FlingGesture</span>
  <span class="s0">| </span><span class="s2">ForceTouchGesture</span>
  <span class="s0">| </span><span class="s2">NativeGesture</span><span class="s1">; 
</span>
<span class="s0">type </span><span class="s2">AllHandlers </span><span class="s0">=</span>
  <span class="s0">| </span><span class="s2">TapGestureHandler</span>
  <span class="s0">| </span><span class="s2">PanGestureHandler</span>
  <span class="s0">| </span><span class="s2">LongPressGestureHandler</span>
  <span class="s0">| </span><span class="s2">RotationGestureHandler</span>
  <span class="s0">| </span><span class="s2">PinchGestureHandler</span>
  <span class="s0">| </span><span class="s2">FlingGestureHandler</span>
  <span class="s0">| </span><span class="s2">ForceTouchGestureHandler</span>
  <span class="s0">| </span><span class="s2">NativeViewGestureHandler</span><span class="s1">;</span>

<span class="s4">// prettier-ignore</span>
<span class="s0">type </span><span class="s2">ClassComponentConstructor</span><span class="s1">&lt;</span><span class="s2">P</span><span class="s1">&gt; </span><span class="s0">= new </span><span class="s1">(</span><span class="s2">props</span><span class="s0">: </span><span class="s2">P</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s2">React</span><span class="s1">.</span><span class="s2">Component</span><span class="s1">&lt;</span><span class="s2">P</span><span class="s1">, </span><span class="s2">any</span><span class="s1">, </span><span class="s2">any</span><span class="s1">&gt;;</span>

<span class="s0">type </span><span class="s2">ExtractPayloadFromProps</span><span class="s1">&lt;</span><span class="s2">T</span><span class="s1">&gt; </span><span class="s0">= </span><span class="s2">T </span><span class="s0">extends </span><span class="s2">BaseGestureHandlerProps</span><span class="s1">&lt;</span>
  <span class="s0">infer </span><span class="s2">TPayload</span>
<span class="s1">&gt;</span>
  <span class="s0">? </span><span class="s2">TPayload</span>
  <span class="s0">: </span><span class="s2">never</span><span class="s1">;</span>

<span class="s0">type </span><span class="s2">ExtractConfig</span><span class="s1">&lt;</span><span class="s2">T</span><span class="s1">&gt; </span><span class="s0">= </span><span class="s2">T </span><span class="s0">extends </span><span class="s2">BaseGesture</span><span class="s1">&lt;</span><span class="s0">infer </span><span class="s2">TGesturePayload</span><span class="s1">&gt;</span>
  <span class="s0">? </span><span class="s2">TGesturePayload</span>
  <span class="s0">: </span><span class="s2">T </span><span class="s0">extends </span><span class="s2">ClassComponentConstructor</span><span class="s1">&lt;</span><span class="s0">infer </span><span class="s2">THandlerProps</span><span class="s1">&gt;</span>
  <span class="s0">? </span><span class="s2">ExtractPayloadFromProps</span><span class="s1">&lt;</span><span class="s2">THandlerProps</span><span class="s1">&gt;</span>
  <span class="s0">: </span><span class="s2">Record</span><span class="s1">&lt;</span><span class="s2">string</span><span class="s1">, </span><span class="s2">unknown</span><span class="s1">&gt;;</span>

<span class="s0">export function </span><span class="s1">fireGestureHandler&lt;</span><span class="s2">THandler </span><span class="s0">extends </span><span class="s2">AllGestures </span><span class="s0">| </span><span class="s2">AllHandlers</span><span class="s1">&gt;(</span>
  <span class="s2">componentOrGesture</span><span class="s0">: </span><span class="s2">ReactTestInstance </span><span class="s0">| </span><span class="s2">GestureType</span><span class="s1">,</span>
  <span class="s2">eventList</span><span class="s0">: </span><span class="s2">Partial</span><span class="s1">&lt;</span><span class="s2">GestureHandlerTestEvent</span><span class="s1">&lt;</span><span class="s2">ExtractConfig</span><span class="s1">&lt;</span><span class="s2">THandler</span><span class="s1">&gt;&gt;&gt;[] </span><span class="s0">= </span><span class="s1">[]</span>
<span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
  <span class="s0">const </span><span class="s1">{ emitEvent, handlerType, handlerTag } </span><span class="s0">=</span>
    <span class="s5">getHandlerData</span><span class="s1">(</span><span class="s2">componentOrGesture</span><span class="s1">);</span>

  <span class="s0">let </span><span class="s1">_ </span><span class="s0">= </span><span class="s5">fillMissingStatesTransitions</span><span class="s1">(</span>
    <span class="s2">eventList</span><span class="s1">,</span>
    <span class="s5">isDiscreteHandler</span><span class="s1">(</span><span class="s2">handlerType</span><span class="s1">)</span>
  <span class="s1">);</span>
  <span class="s2">_ </span><span class="s0">= </span><span class="s2">_</span><span class="s1">.</span><span class="s5">map</span><span class="s1">(</span><span class="s5">fillMissingDefaultsFor</span><span class="s1">({ </span><span class="s2">handlerTag</span><span class="s1">, </span><span class="s2">handlerType </span><span class="s1">}));</span>
  <span class="s2">_ </span><span class="s0">= </span><span class="s5">withPrevAndCurrent</span><span class="s1">(</span><span class="s2">_</span><span class="s1">, </span><span class="s2">fillOldStateChanges</span><span class="s1">);</span>
  <span class="s2">_ </span><span class="s0">= </span><span class="s5">withPrevAndCurrent</span><span class="s1">(</span><span class="s2">_</span><span class="s1">, </span><span class="s2">validateStateTransitions</span><span class="s1">);</span>
  <span class="s4">// @ts-ignore TODO</span>
  <span class="s2">_ </span><span class="s0">= </span><span class="s2">_</span><span class="s1">.</span><span class="s5">map</span><span class="s1">(</span><span class="s2">wrapWithNativeEvent</span><span class="s1">);</span>

  <span class="s0">const </span><span class="s1">events </span><span class="s0">= </span><span class="s2">_ </span><span class="s0">as </span><span class="s2">unknown </span><span class="s0">as </span><span class="s2">WrappedGestureHandlerTestEvent</span><span class="s1">[];</span>

  <span class="s0">const </span><span class="s1">firstEvent </span><span class="s0">= </span><span class="s2">events</span><span class="s1">.</span><span class="s5">shift</span><span class="s1">()</span><span class="s0">!</span><span class="s1">;</span>

  <span class="s5">emitEvent</span><span class="s1">(</span><span class="s3">'onGestureHandlerStateChange'</span><span class="s1">, </span><span class="s2">firstEvent</span><span class="s1">);</span>
  <span class="s0">let </span><span class="s1">lastSentEvent </span><span class="s0">= </span><span class="s2">firstEvent</span><span class="s1">;</span>
  <span class="s0">for </span><span class="s1">(</span><span class="s0">const </span><span class="s1">event </span><span class="s0">of </span><span class="s2">events</span><span class="s1">) {</span>
    <span class="s0">const </span><span class="s1">hasChangedState </span><span class="s0">=</span>
      <span class="s2">lastSentEvent</span><span class="s1">.</span><span class="s2">nativeEvent</span><span class="s1">.</span><span class="s2">state </span><span class="s0">!== </span><span class="s2">event</span><span class="s1">.</span><span class="s2">nativeEvent</span><span class="s1">.</span><span class="s2">state</span><span class="s1">;</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">hasChangedState</span><span class="s1">) {</span>
      <span class="s5">emitEvent</span><span class="s1">(</span><span class="s3">'onGestureHandlerStateChange'</span><span class="s1">, </span><span class="s2">event</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
      <span class="s5">emitEvent</span><span class="s1">(</span><span class="s3">'onGestureHandlerEvent'</span><span class="s1">, </span><span class="s2">event</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s2">lastSentEvent </span><span class="s0">= </span><span class="s2">event</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s0">export function </span><span class="s1">getByGestureTestId(</span><span class="s2">testID</span><span class="s0">: </span><span class="s2">string</span><span class="s1">) {</span>
  <span class="s0">const </span><span class="s1">handler </span><span class="s0">= </span><span class="s5">findHandlerByTestID</span><span class="s1">(</span><span class="s2">testID</span><span class="s1">);</span>
  <span class="s0">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s0">=== </span><span class="s7">null</span><span class="s1">) {</span>
    <span class="s0">throw new </span><span class="s5">Error</span><span class="s1">(</span><span class="s3">`Handler with id: '${</span><span class="s2">testID</span><span class="s3">}' cannot be found`</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s0">return </span><span class="s2">handler</span><span class="s1">;</span>
<span class="s1">}</span>
</pre>
</body>
</html>