<html>
<head>
<title>DevServerHelper.java</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #77b767; font-style: italic;}
.s5 { color: #6a8759;}
.s6 { color: #6897bb;}
.s7 { color: #629755; font-weight: bold; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
DevServerHelper.java</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">package </span><span class="s1">com.facebook.react.devsupport</span><span class="s2">;</span>

<span class="s2">import </span><span class="s1">android.content.Context</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">android.os.AsyncTask</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">androidx.annotation.Nullable</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.common.logging.FLog</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.infer.annotation.Assertions</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.bridge.ReactContext</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.common.ReactConstants</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.common.build.ReactBuildConfig</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.DevBundleDownloadListener</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.PackagerStatusCallback</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.devsupport.interfaces.StackFrame</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.modules.systeminfo.AndroidInfoHelpers</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.FileIoHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.JSPackagerClient</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.NotificationOnlyHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.ReconnectingWebSocket.ConnectionCallback</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.RequestHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.RequestOnlyHandler</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.packagerconnection.Responder</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">com.facebook.react.util.RNLog</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.io.File</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.io.IOException</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Arrays</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.HashMap</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Locale</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.Map</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">java.util.concurrent.TimeUnit</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okhttp3.Call</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okhttp3.Callback</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okhttp3.MediaType</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okhttp3.OkHttpClient</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okhttp3.Request</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okhttp3.RequestBody</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okhttp3.Response</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okio.Okio</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">okio.Sink</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">org.json.JSONArray</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">org.json.JSONException</span><span class="s2">;</span>
<span class="s2">import </span><span class="s1">org.json.JSONObject</span><span class="s2">;</span>

<span class="s3">/**</span>
 <span class="s3">* Helper class for all things about the debug server running in the engineer's host machine.</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">&lt;p&gt;</span><span class="s3">One can use 'debug_http_host' shared preferences key to provide a host name for the debug</span>
 <span class="s3">* server. If the setting is empty we support and detect two basic configuration that works well for</span>
 <span class="s3">* android emulators connection to debug server running on emulator's host:</span>
 <span class="s3">*</span>
 <span class="s3">* </span><span class="s4">&lt;ul&gt;</span>
 <span class="s3">*   </span><span class="s4">&lt;li&gt;</span><span class="s3">Android stock emulator with standard non-configurable local loopback alias: 10.0.2.2</span>
 <span class="s3">*   </span><span class="s4">&lt;li&gt;</span><span class="s3">Genymotion emulator with default settings: 10.0.3.2</span>
 <span class="s3">* </span><span class="s4">&lt;/ul&gt;</span>
 <span class="s3">*/</span>
<span class="s2">public class </span><span class="s1">DevServerHelper {</span>
  <span class="s2">public static final </span><span class="s1">String RELOAD_APP_EXTRA_JS_PROXY = </span><span class="s5">&quot;jsproxy&quot;</span><span class="s2">;</span>

  <span class="s2">private static final int </span><span class="s1">HTTP_CONNECT_TIMEOUT_MS = </span><span class="s6">5000</span><span class="s2">;</span>

  <span class="s2">private static final </span><span class="s1">String DEBUGGER_MSG_DISABLE = </span><span class="s5">&quot;{ </span><span class="s2">\&quot;</span><span class="s5">id</span><span class="s2">\&quot;</span><span class="s5">:1,</span><span class="s2">\&quot;</span><span class="s5">method</span><span class="s2">\&quot;</span><span class="s5">:</span><span class="s2">\&quot;</span><span class="s5">Debugger.disable</span><span class="s2">\&quot; </span><span class="s5">}&quot;</span><span class="s2">;</span>

  <span class="s2">public interface </span><span class="s1">OnServerContentChangeListener {</span>
    <span class="s2">void </span><span class="s1">onServerContentChanged()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public interface </span><span class="s1">PackagerCommandListener {</span>
    <span class="s2">void </span><span class="s1">onPackagerConnected()</span><span class="s2">;</span>

    <span class="s2">void </span><span class="s1">onPackagerDisconnected()</span><span class="s2">;</span>

    <span class="s2">void </span><span class="s1">onPackagerReloadCommand()</span><span class="s2">;</span>

    <span class="s2">void </span><span class="s1">onPackagerDevMenuCommand()</span><span class="s2">;</span>

    <span class="s2">void </span><span class="s1">onCaptureHeapCommand(</span><span class="s2">final </span><span class="s1">Responder responder)</span><span class="s2">;</span>

    <span class="s0">// Allow apps to provide listeners for custom packager commands.</span>
    <span class="s1">@Nullable</span>
    <span class="s1">Map&lt;String</span><span class="s2">, </span><span class="s1">RequestHandler&gt; customCommandHandlers()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public interface </span><span class="s1">PackagerCustomCommandProvider {}</span>

  <span class="s2">public interface </span><span class="s1">SymbolicationListener {</span>
    <span class="s2">void </span><span class="s1">onSymbolicationComplete(@Nullable Iterable&lt;StackFrame&gt; stackFrames)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private enum </span><span class="s1">BundleType {</span>
    <span class="s1">BUNDLE(</span><span class="s5">&quot;bundle&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">MAP(</span><span class="s5">&quot;map&quot;</span><span class="s1">)</span><span class="s2">;</span>

    <span class="s2">private final </span><span class="s1">String mTypeID</span><span class="s2">;</span>

    <span class="s1">BundleType(String typeID) {</span>
      <span class="s1">mTypeID = typeID</span><span class="s2">;</span>
    <span class="s1">}</span>

    <span class="s2">public </span><span class="s1">String typeID() {</span>
      <span class="s2">return </span><span class="s1">mTypeID</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private final </span><span class="s1">DevInternalSettings mSettings</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">OkHttpClient mClient</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">BundleDownloader mBundleDownloader</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">PackagerStatusCheck mPackagerStatusCheck</span><span class="s2">;</span>
  <span class="s2">private final </span><span class="s1">String mPackageName</span><span class="s2">;</span>

  <span class="s2">private </span><span class="s1">@Nullable JSPackagerClient mPackagerClient</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">@Nullable InspectorPackagerConnection mInspectorPackagerConnection</span><span class="s2">;</span>
  <span class="s2">private </span><span class="s1">InspectorPackagerConnection.BundleStatusProvider mBundlerStatusProvider</span><span class="s2">;</span>

  <span class="s2">public </span><span class="s1">DevServerHelper(</span>
      <span class="s1">DevInternalSettings settings</span><span class="s2">,</span>
      <span class="s1">String packageName</span><span class="s2">,</span>
      <span class="s1">InspectorPackagerConnection.BundleStatusProvider bundleStatusProvider) {</span>
    <span class="s1">mSettings = settings</span><span class="s2">;</span>
    <span class="s1">mBundlerStatusProvider = bundleStatusProvider</span><span class="s2">;</span>
    <span class="s1">mClient =</span>
        <span class="s2">new </span><span class="s1">OkHttpClient.Builder()</span>
            <span class="s1">.connectTimeout(HTTP_CONNECT_TIMEOUT_MS</span><span class="s2">, </span><span class="s1">TimeUnit.MILLISECONDS)</span>
            <span class="s1">.readTimeout(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">TimeUnit.MILLISECONDS)</span>
            <span class="s1">.writeTimeout(</span><span class="s6">0</span><span class="s2">, </span><span class="s1">TimeUnit.MILLISECONDS)</span>
            <span class="s1">.build()</span><span class="s2">;</span>
    <span class="s1">mBundleDownloader = </span><span class="s2">new </span><span class="s1">BundleDownloader(mClient)</span><span class="s2">;</span>
    <span class="s1">mPackagerStatusCheck = </span><span class="s2">new </span><span class="s1">PackagerStatusCheck(mClient)</span><span class="s2">;</span>
    <span class="s1">mPackageName = packageName</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">openPackagerConnection(</span>
      <span class="s2">final </span><span class="s1">String clientId</span><span class="s2">, final </span><span class="s1">PackagerCommandListener commandListener) {</span>
    <span class="s2">if </span><span class="s1">(mPackagerClient != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">FLog.w(ReactConstants.TAG</span><span class="s2">, </span><span class="s5">&quot;Packager connection already open, nooping.&quot;</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>
    <span class="s2">new </span><span class="s1">AsyncTask&lt;Void</span><span class="s2">, </span><span class="s1">Void</span><span class="s2">, </span><span class="s1">Void&gt;() {</span>
      <span class="s1">@Override</span>
      <span class="s2">protected </span><span class="s1">Void doInBackground(Void... backgroundParams) {</span>
        <span class="s1">Map&lt;String</span><span class="s2">, </span><span class="s1">RequestHandler&gt; handlers = </span><span class="s2">new </span><span class="s1">HashMap&lt;&gt;()</span><span class="s2">;</span>
        <span class="s1">handlers.put(</span>
            <span class="s5">&quot;reload&quot;</span><span class="s2">,</span>
            <span class="s2">new </span><span class="s1">NotificationOnlyHandler() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onNotification(@Nullable Object params) {</span>
                <span class="s1">commandListener.onPackagerReloadCommand()</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">})</span><span class="s2">;</span>
        <span class="s1">handlers.put(</span>
            <span class="s5">&quot;devMenu&quot;</span><span class="s2">,</span>
            <span class="s2">new </span><span class="s1">NotificationOnlyHandler() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onNotification(@Nullable Object params) {</span>
                <span class="s1">commandListener.onPackagerDevMenuCommand()</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">})</span><span class="s2">;</span>
        <span class="s1">handlers.put(</span>
            <span class="s5">&quot;captureHeap&quot;</span><span class="s2">,</span>
            <span class="s2">new </span><span class="s1">RequestOnlyHandler() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onRequest(@Nullable Object params</span><span class="s2">, </span><span class="s1">Responder responder) {</span>
                <span class="s1">commandListener.onCaptureHeapCommand(responder)</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">})</span><span class="s2">;</span>
        <span class="s1">Map&lt;String</span><span class="s2">, </span><span class="s1">RequestHandler&gt; customHandlers = commandListener.customCommandHandlers()</span><span class="s2">;</span>
        <span class="s2">if </span><span class="s1">(customHandlers != </span><span class="s2">null</span><span class="s1">) {</span>
          <span class="s1">handlers.putAll(customHandlers)</span><span class="s2">;</span>
        <span class="s1">}</span>
        <span class="s1">handlers.putAll(</span><span class="s2">new </span><span class="s1">FileIoHandler().handlers())</span><span class="s2">;</span>

        <span class="s1">ConnectionCallback onPackagerConnectedCallback =</span>
            <span class="s2">new </span><span class="s1">ConnectionCallback() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onConnected() {</span>
                <span class="s1">commandListener.onPackagerConnected()</span><span class="s2">;</span>
              <span class="s1">}</span>

              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onDisconnected() {</span>
                <span class="s1">commandListener.onPackagerDisconnected()</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">}</span><span class="s2">;</span>

        <span class="s1">mPackagerClient =</span>
            <span class="s2">new </span><span class="s1">JSPackagerClient(</span>
                <span class="s1">clientId</span><span class="s2">,</span>
                <span class="s1">mSettings.getPackagerConnectionSettings()</span><span class="s2">,</span>
                <span class="s1">handlers</span><span class="s2">,</span>
                <span class="s1">onPackagerConnectedCallback)</span><span class="s2">;</span>
        <span class="s1">mPackagerClient.init()</span><span class="s2">;</span>

        <span class="s2">return null;</span>
      <span class="s1">}</span>
    <span class="s1">}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">closePackagerConnection() {</span>
    <span class="s2">new </span><span class="s1">AsyncTask&lt;Void</span><span class="s2">, </span><span class="s1">Void</span><span class="s2">, </span><span class="s1">Void&gt;() {</span>
      <span class="s1">@Override</span>
      <span class="s2">protected </span><span class="s1">Void doInBackground(Void... params) {</span>
        <span class="s2">if </span><span class="s1">(mPackagerClient != </span><span class="s2">null</span><span class="s1">) {</span>
          <span class="s1">mPackagerClient.close()</span><span class="s2">;</span>
          <span class="s1">mPackagerClient = </span><span class="s2">null;</span>
        <span class="s1">}</span>
        <span class="s2">return null;</span>
      <span class="s1">}</span>
    <span class="s1">}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">openInspectorConnection() {</span>
    <span class="s2">if </span><span class="s1">(mInspectorPackagerConnection != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">FLog.w(ReactConstants.TAG</span><span class="s2">, </span><span class="s5">&quot;Inspector connection already open, nooping.&quot;</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s2">return;</span>
    <span class="s1">}</span>
    <span class="s2">new </span><span class="s1">AsyncTask&lt;Void</span><span class="s2">, </span><span class="s1">Void</span><span class="s2">, </span><span class="s1">Void&gt;() {</span>
      <span class="s1">@Override</span>
      <span class="s2">protected </span><span class="s1">Void doInBackground(Void... params) {</span>
        <span class="s1">mInspectorPackagerConnection =</span>
            <span class="s2">new </span><span class="s1">InspectorPackagerConnection(</span>
                <span class="s1">getInspectorDeviceUrl()</span><span class="s2">, </span><span class="s1">mPackageName</span><span class="s2">, </span><span class="s1">mBundlerStatusProvider)</span><span class="s2">;</span>
        <span class="s1">mInspectorPackagerConnection.connect()</span><span class="s2">;</span>
        <span class="s2">return null;</span>
      <span class="s1">}</span>
    <span class="s1">}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">disableDebugger() {</span>
    <span class="s2">if </span><span class="s1">(mInspectorPackagerConnection != </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">mInspectorPackagerConnection.sendEventToAllConnections(DEBUGGER_MSG_DISABLE)</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">closeInspectorConnection() {</span>
    <span class="s2">new </span><span class="s1">AsyncTask&lt;Void</span><span class="s2">, </span><span class="s1">Void</span><span class="s2">, </span><span class="s1">Void&gt;() {</span>
      <span class="s1">@Override</span>
      <span class="s2">protected </span><span class="s1">Void doInBackground(Void... params) {</span>
        <span class="s2">if </span><span class="s1">(mInspectorPackagerConnection != </span><span class="s2">null</span><span class="s1">) {</span>
          <span class="s1">mInspectorPackagerConnection.closeQuietly()</span><span class="s2">;</span>
          <span class="s1">mInspectorPackagerConnection = </span><span class="s2">null;</span>
        <span class="s1">}</span>
        <span class="s2">return null;</span>
      <span class="s1">}</span>
    <span class="s1">}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">openUrl(</span><span class="s2">final </span><span class="s1">ReactContext context</span><span class="s2">, final </span><span class="s1">String url</span><span class="s2">, final </span><span class="s1">String errorMessage) {</span>
    <span class="s2">new </span><span class="s1">AsyncTask&lt;Void</span><span class="s2">, </span><span class="s1">String</span><span class="s2">, </span><span class="s1">Boolean&gt;() {</span>
      <span class="s1">@Override</span>
      <span class="s2">protected </span><span class="s1">Boolean doInBackground(Void... ignore) {</span>
        <span class="s2">return </span><span class="s1">doSync()</span><span class="s2">;</span>
      <span class="s1">}</span>

      <span class="s2">public boolean </span><span class="s1">doSync() {</span>
        <span class="s2">try </span><span class="s1">{</span>
          <span class="s1">String openUrlEndpoint = getOpenUrlEndpoint(context)</span><span class="s2">;</span>
          <span class="s1">String jsonString = </span><span class="s2">new </span><span class="s1">JSONObject().put(</span><span class="s5">&quot;url&quot;</span><span class="s2">, </span><span class="s1">url).toString()</span><span class="s2">;</span>
          <span class="s1">RequestBody body = RequestBody.create(MediaType.parse(</span><span class="s5">&quot;application/json&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">jsonString)</span><span class="s2">;</span>

          <span class="s1">Request request = </span><span class="s2">new </span><span class="s1">Request.Builder().url(openUrlEndpoint).post(body).build()</span><span class="s2">;</span>
          <span class="s1">OkHttpClient client = </span><span class="s2">new </span><span class="s1">OkHttpClient()</span><span class="s2">;</span>
          <span class="s1">client.newCall(request).execute()</span><span class="s2">;</span>
          <span class="s2">return true;</span>
        <span class="s1">} </span><span class="s2">catch </span><span class="s1">(JSONException | IOException e) {</span>
          <span class="s1">FLog.e(ReactConstants.TAG</span><span class="s2">, </span><span class="s5">&quot;Failed to open URL&quot; </span><span class="s1">+ url</span><span class="s2">, </span><span class="s1">e)</span><span class="s2">;</span>
          <span class="s2">return false;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s1">@Override</span>
      <span class="s2">protected void </span><span class="s1">onPostExecute(Boolean result) {</span>
        <span class="s2">if </span><span class="s1">(!result) {</span>
          <span class="s1">RNLog.w(context</span><span class="s2">, </span><span class="s1">errorMessage)</span><span class="s2">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}.executeOnExecutor(AsyncTask.THREAD_POOL_EXECUTOR)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">symbolicateStackTrace(</span>
      <span class="s1">Iterable&lt;StackFrame&gt; stackFrames</span><span class="s2">, final </span><span class="s1">SymbolicationListener listener) {</span>
    <span class="s2">try </span><span class="s1">{</span>
      <span class="s2">final </span><span class="s1">String symbolicateURL =</span>
          <span class="s1">createSymbolicateURL(mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
      <span class="s2">final </span><span class="s1">JSONArray jsonStackFrames = </span><span class="s2">new </span><span class="s1">JSONArray()</span><span class="s2">;</span>
      <span class="s2">for </span><span class="s1">(</span><span class="s2">final </span><span class="s1">StackFrame stackFrame : stackFrames) {</span>
        <span class="s1">jsonStackFrames.put(stackFrame.toJSON())</span><span class="s2">;</span>
      <span class="s1">}</span>
      <span class="s2">final </span><span class="s1">Request request =</span>
          <span class="s2">new </span><span class="s1">Request.Builder()</span>
              <span class="s1">.url(symbolicateURL)</span>
              <span class="s1">.post(</span>
                  <span class="s1">RequestBody.create(</span>
                      <span class="s1">MediaType.parse(</span><span class="s5">&quot;application/json&quot;</span><span class="s1">)</span><span class="s2">,</span>
                      <span class="s2">new </span><span class="s1">JSONObject().put(</span><span class="s5">&quot;stack&quot;</span><span class="s2">, </span><span class="s1">jsonStackFrames).toString()))</span>
              <span class="s1">.build()</span><span class="s2">;</span>
      <span class="s1">Call symbolicateCall = Assertions.assertNotNull(mClient.newCall(request))</span><span class="s2">;</span>
      <span class="s1">symbolicateCall.enqueue(</span>
          <span class="s2">new </span><span class="s1">Callback() {</span>
            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onFailure(Call call</span><span class="s2">, </span><span class="s1">IOException e) {</span>
              <span class="s1">FLog.w(</span>
                  <span class="s1">ReactConstants.TAG</span><span class="s2">,</span>
                  <span class="s5">&quot;Got IOException when attempting symbolicate stack trace: &quot; </span><span class="s1">+ e.getMessage())</span><span class="s2">;</span>
              <span class="s1">listener.onSymbolicationComplete(</span><span class="s2">null</span><span class="s1">)</span><span class="s2">;</span>
            <span class="s1">}</span>

            <span class="s1">@Override</span>
            <span class="s2">public void </span><span class="s1">onResponse(Call call</span><span class="s2">, final </span><span class="s1">Response response) </span><span class="s2">throws </span><span class="s1">IOException {</span>
              <span class="s2">try </span><span class="s1">{</span>
                <span class="s1">listener.onSymbolicationComplete(</span>
                    <span class="s1">Arrays.asList(</span>
                        <span class="s1">StackTraceHelper.convertJsStackTrace(</span>
                            <span class="s2">new </span><span class="s1">JSONObject(response.body().string()).getJSONArray(</span><span class="s5">&quot;stack&quot;</span><span class="s1">))))</span><span class="s2">;</span>
              <span class="s1">} </span><span class="s2">catch </span><span class="s1">(JSONException exception) {</span>
                <span class="s1">listener.onSymbolicationComplete(</span><span class="s2">null</span><span class="s1">)</span><span class="s2">;</span>
              <span class="s1">}</span>
            <span class="s1">}</span>
          <span class="s1">})</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">catch </span><span class="s1">(JSONException e) {</span>
      <span class="s1">FLog.w(</span>
          <span class="s1">ReactConstants.TAG</span><span class="s2">,</span>
          <span class="s5">&quot;Got JSONException when attempting symbolicate stack trace: &quot; </span><span class="s1">+ e.getMessage())</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">openStackFrameCall(StackFrame stackFrame) {</span>
    <span class="s2">final </span><span class="s1">String openStackFrameURL =</span>
        <span class="s1">createOpenStackFrameURL(mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
    <span class="s2">final </span><span class="s1">Request request =</span>
        <span class="s2">new </span><span class="s1">Request.Builder()</span>
            <span class="s1">.url(openStackFrameURL)</span>
            <span class="s1">.post(</span>
                <span class="s1">RequestBody.create(</span>
                    <span class="s1">MediaType.parse(</span><span class="s5">&quot;application/json&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">stackFrame.toJSON().toString()))</span>
            <span class="s1">.build()</span><span class="s2">;</span>
    <span class="s1">Call symbolicateCall = Assertions.assertNotNull(mClient.newCall(request))</span><span class="s2">;</span>
    <span class="s1">symbolicateCall.enqueue(</span>
        <span class="s2">new </span><span class="s1">Callback() {</span>
          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onFailure(Call call</span><span class="s2">, </span><span class="s1">IOException e) {</span>
            <span class="s1">FLog.w(</span>
                <span class="s1">ReactConstants.TAG</span><span class="s2">,</span>
                <span class="s5">&quot;Got IOException when attempting to open stack frame: &quot; </span><span class="s1">+ e.getMessage())</span><span class="s2">;</span>
          <span class="s1">}</span>

          <span class="s1">@Override</span>
          <span class="s2">public void </span><span class="s1">onResponse(Call call</span><span class="s2">, final </span><span class="s1">Response response) </span><span class="s2">throws </span><span class="s1">IOException {</span>
            <span class="s0">// We don't have a listener for this.</span>
          <span class="s1">}</span>
        <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">String getWebsocketProxyURL() {</span>
    <span class="s2">return </span><span class="s1">String.format(</span>
        <span class="s1">Locale.US</span><span class="s2">,</span>
        <span class="s5">&quot;ws://%s/debugger-proxy?role=client&quot;</span><span class="s2">,</span>
        <span class="s1">mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String getInspectorDeviceUrl() {</span>
    <span class="s2">return </span><span class="s1">String.format(</span>
        <span class="s1">Locale.US</span><span class="s2">,</span>
        <span class="s5">&quot;http://%s/inspector/device?name=%s&amp;app=%s&quot;</span><span class="s2">,</span>
        <span class="s1">mSettings.getPackagerConnectionSettings().getInspectorServerHost()</span><span class="s2">,</span>
        <span class="s1">AndroidInfoHelpers.getFriendlyDeviceName()</span><span class="s2">,</span>
        <span class="s1">mPackageName)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">downloadBundleFromURL(</span>
      <span class="s1">DevBundleDownloadListener callback</span><span class="s2">,</span>
      <span class="s1">File outputFile</span><span class="s2">,</span>
      <span class="s1">String bundleURL</span><span class="s2">,</span>
      <span class="s1">BundleDownloader.BundleInfo bundleInfo) {</span>
    <span class="s1">mBundleDownloader.downloadBundleFromURL(callback</span><span class="s2">, </span><span class="s1">outputFile</span><span class="s2">, </span><span class="s1">bundleURL</span><span class="s2">, </span><span class="s1">bundleInfo)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String getOpenUrlEndpoint(Context context) {</span>
    <span class="s2">return </span><span class="s1">String.format(</span>
        <span class="s1">Locale.US</span><span class="s2">, </span><span class="s5">&quot;http://%s/open-url&quot;</span><span class="s2">, </span><span class="s1">AndroidInfoHelpers.getServerHost(context))</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">downloadBundleFromURL(</span>
      <span class="s1">DevBundleDownloadListener callback</span><span class="s2">,</span>
      <span class="s1">File outputFile</span><span class="s2">,</span>
      <span class="s1">String bundleURL</span><span class="s2">,</span>
      <span class="s1">BundleDownloader.BundleInfo bundleInfo</span><span class="s2">,</span>
      <span class="s1">Request.Builder requestBuilder) {</span>
    <span class="s1">mBundleDownloader.downloadBundleFromURL(</span>
        <span class="s1">callback</span><span class="s2">, </span><span class="s1">outputFile</span><span class="s2">, </span><span class="s1">bundleURL</span><span class="s2">, </span><span class="s1">bundleInfo</span><span class="s2">, </span><span class="s1">requestBuilder)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/** </span><span class="s7">@return </span><span class="s3">the host to use when connecting to the bundle server from the host itself. */</span>
  <span class="s2">private </span><span class="s1">String getHostForJSProxy() {</span>
    <span class="s0">// Use custom port if configured. Note that host stays &quot;localhost&quot;.</span>
    <span class="s1">String host =</span>
        <span class="s1">Assertions.assertNotNull(mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
    <span class="s2">int </span><span class="s1">portOffset = host.lastIndexOf(</span><span class="s5">':'</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(portOffset &gt; -</span><span class="s6">1</span><span class="s1">) {</span>
      <span class="s2">return </span><span class="s5">&quot;localhost&quot; </span><span class="s1">+ host.substring(portOffset)</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s2">return </span><span class="s1">AndroidInfoHelpers.DEVICE_LOCALHOST</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">/** </span><span class="s7">@return </span><span class="s3">whether we should enable dev mode when requesting JS bundles. */</span>
  <span class="s2">private boolean </span><span class="s1">getDevMode() {</span>
    <span class="s2">return </span><span class="s1">mSettings.isJSDevModeEnabled()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/** </span><span class="s7">@return </span><span class="s3">whether we should request minified JS bundles. */</span>
  <span class="s2">private boolean </span><span class="s1">getJSMinifyMode() {</span>
    <span class="s2">return </span><span class="s1">mSettings.isJSMinifyEnabled()</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String createBundleURL(String mainModuleID</span><span class="s2">, </span><span class="s1">BundleType type</span><span class="s2">, </span><span class="s1">String host) {</span>
    <span class="s2">return </span><span class="s1">createBundleURL(mainModuleID</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, false, true</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String createSplitBundleURL(String mainModuleID</span><span class="s2">, </span><span class="s1">String host) {</span>
    <span class="s2">return </span><span class="s1">createBundleURL(mainModuleID</span><span class="s2">, </span><span class="s1">BundleType.BUNDLE</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, true, false</span><span class="s1">)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String createBundleURL(</span>
      <span class="s1">String mainModuleID</span><span class="s2">, </span><span class="s1">BundleType type</span><span class="s2">, </span><span class="s1">String host</span><span class="s2">, boolean </span><span class="s1">modulesOnly</span><span class="s2">, boolean </span><span class="s1">runModule) {</span>
    <span class="s1">String runtimeBytecodeVersion =</span>
        <span class="s1">ReactBuildConfig.HERMES_BYTECODE_VERSION != </span><span class="s6">0</span>
            <span class="s1">? </span><span class="s5">&quot;&amp;runtimeBytecodeVersion=&quot; </span><span class="s1">+ ReactBuildConfig.HERMES_BYTECODE_VERSION</span>
            <span class="s1">: </span><span class="s5">&quot;&quot;</span><span class="s2">;</span>
    <span class="s2">return </span><span class="s1">String.format(</span>
        <span class="s1">Locale.US</span><span class="s2">,</span>
        <span class="s5">&quot;http://%s/%s.%s?platform=android&amp;dev=%s&amp;minify=%s&amp;app=%s&amp;modulesOnly=%s&amp;runModule=%s%s&quot;</span><span class="s2">,</span>
        <span class="s1">host</span><span class="s2">,</span>
        <span class="s1">mainModuleID</span><span class="s2">,</span>
        <span class="s1">type.typeID()</span><span class="s2">,</span>
        <span class="s1">getDevMode()</span><span class="s2">,</span>
        <span class="s1">getJSMinifyMode()</span><span class="s2">,</span>
        <span class="s1">mPackageName</span><span class="s2">,</span>
        <span class="s1">modulesOnly ? </span><span class="s5">&quot;true&quot; </span><span class="s1">: </span><span class="s5">&quot;false&quot;</span><span class="s2">,</span>
        <span class="s1">runModule ? </span><span class="s5">&quot;true&quot; </span><span class="s1">: </span><span class="s5">&quot;false&quot;</span><span class="s2">,</span>
        <span class="s1">runtimeBytecodeVersion)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String createBundleURL(String mainModuleID</span><span class="s2">, </span><span class="s1">BundleType type) {</span>
    <span class="s2">return </span><span class="s1">createBundleURL(</span>
        <span class="s1">mainModuleID</span><span class="s2">, </span><span class="s1">type</span><span class="s2">, </span><span class="s1">mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">String createResourceURL(String host</span><span class="s2">, </span><span class="s1">String resourcePath) {</span>
    <span class="s2">return </span><span class="s1">String.format(Locale.US</span><span class="s2">, </span><span class="s5">&quot;http://%s/%s&quot;</span><span class="s2">, </span><span class="s1">host</span><span class="s2">, </span><span class="s1">resourcePath)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">String createSymbolicateURL(String host) {</span>
    <span class="s2">return </span><span class="s1">String.format(Locale.US</span><span class="s2">, </span><span class="s5">&quot;http://%s/symbolicate&quot;</span><span class="s2">, </span><span class="s1">host)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">private static </span><span class="s1">String createOpenStackFrameURL(String host) {</span>
    <span class="s2">return </span><span class="s1">String.format(Locale.US</span><span class="s2">, </span><span class="s5">&quot;http://%s/open-stack-frame&quot;</span><span class="s2">, </span><span class="s1">host)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">String getDevServerBundleURL(</span><span class="s2">final </span><span class="s1">String jsModulePath) {</span>
    <span class="s2">return </span><span class="s1">createBundleURL(</span>
        <span class="s1">jsModulePath</span><span class="s2">,</span>
        <span class="s1">BundleType.BUNDLE</span><span class="s2">,</span>
        <span class="s1">mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">String getDevServerSplitBundleURL(String jsModulePath) {</span>
    <span class="s2">return </span><span class="s1">createSplitBundleURL(</span>
        <span class="s1">jsModulePath</span><span class="s2">, </span><span class="s1">mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">isPackagerRunning(</span><span class="s2">final </span><span class="s1">PackagerStatusCallback callback) {</span>
    <span class="s1">String host = mSettings.getPackagerConnectionSettings().getDebugServerHost()</span><span class="s2">;</span>
    <span class="s2">if </span><span class="s1">(host == </span><span class="s2">null</span><span class="s1">) {</span>
      <span class="s1">FLog.w(ReactConstants.TAG</span><span class="s2">, </span><span class="s5">&quot;No packager host configured.&quot;</span><span class="s1">)</span><span class="s2">;</span>
      <span class="s1">callback.onPackagerStatusFetched(</span><span class="s2">false</span><span class="s1">)</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">else </span><span class="s1">{</span>
      <span class="s1">mPackagerStatusCheck.run(host</span><span class="s2">, </span><span class="s1">callback)</span><span class="s2">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s2">private </span><span class="s1">String createLaunchJSDevtoolsCommandUrl() {</span>
    <span class="s2">return </span><span class="s1">String.format(</span>
        <span class="s1">Locale.US</span><span class="s2">,</span>
        <span class="s5">&quot;http://%s/launch-js-devtools&quot;</span><span class="s2">,</span>
        <span class="s1">mSettings.getPackagerConnectionSettings().getDebugServerHost())</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public void </span><span class="s1">launchJSDevtools() {</span>
    <span class="s1">Request request = </span><span class="s2">new </span><span class="s1">Request.Builder().url(createLaunchJSDevtoolsCommandUrl()).build()</span><span class="s2">;</span>
    <span class="s1">mClient</span>
        <span class="s1">.newCall(request)</span>
        <span class="s1">.enqueue(</span>
            <span class="s2">new </span><span class="s1">Callback() {</span>
              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onFailure(Call call</span><span class="s2">, </span><span class="s1">IOException e) {</span>
                <span class="s0">// ignore HTTP call response, this is just to open a debugger page and there is no</span>
                <span class="s0">// reason</span>
                <span class="s0">// to report failures from here</span>
              <span class="s1">}</span>

              <span class="s1">@Override</span>
              <span class="s2">public void </span><span class="s1">onResponse(Call call</span><span class="s2">, </span><span class="s1">Response response) </span><span class="s2">throws </span><span class="s1">IOException {</span>
                <span class="s0">// ignore HTTP call response - see above</span>
              <span class="s1">}</span>
            <span class="s1">})</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">String getSourceMapUrl(String mainModuleName) {</span>
    <span class="s2">return </span><span class="s1">createBundleURL(mainModuleName</span><span class="s2">, </span><span class="s1">BundleType.MAP)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">String getSourceUrl(String mainModuleName) {</span>
    <span class="s2">return </span><span class="s1">createBundleURL(mainModuleName</span><span class="s2">, </span><span class="s1">BundleType.BUNDLE)</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s2">public </span><span class="s1">String getJSBundleURLForRemoteDebugging(String mainModuleName) {</span>
    <span class="s0">// The host we use when connecting to the JS bundle server from the emulator is not the</span>
    <span class="s0">// same as the one needed to connect to the same server from the JavaScript proxy running on the</span>
    <span class="s0">// host itself.</span>
    <span class="s2">return </span><span class="s1">createBundleURL(mainModuleName</span><span class="s2">, </span><span class="s1">BundleType.BUNDLE</span><span class="s2">, </span><span class="s1">getHostForJSProxy())</span><span class="s2">;</span>
  <span class="s1">}</span>

  <span class="s3">/**</span>
   <span class="s3">* This is a debug-only utility to allow fetching a file via packager. It's made synchronous for</span>
   <span class="s3">* simplicity, but should only be used if it's absolutely necessary.</span>
   <span class="s3">*</span>
   <span class="s3">* </span><span class="s7">@return </span><span class="s3">the file with the fetched content, or null if there's any failure.</span>
   <span class="s3">*/</span>
  <span class="s2">public </span><span class="s1">@Nullable File downloadBundleResourceFromUrlSync(</span>
      <span class="s2">final </span><span class="s1">String resourcePath</span><span class="s2">, final </span><span class="s1">File outputFile) {</span>
    <span class="s2">final </span><span class="s1">String resourceURL =</span>
        <span class="s1">createResourceURL(</span>
            <span class="s1">mSettings.getPackagerConnectionSettings().getDebugServerHost()</span><span class="s2">, </span><span class="s1">resourcePath)</span><span class="s2">;</span>
    <span class="s2">final </span><span class="s1">Request request = </span><span class="s2">new </span><span class="s1">Request.Builder().url(resourceURL).build()</span><span class="s2">;</span>

    <span class="s2">try </span><span class="s1">(Response response = mClient.newCall(request).execute()) {</span>
      <span class="s2">if </span><span class="s1">(!response.isSuccessful()) {</span>
        <span class="s2">return null;</span>
      <span class="s1">}</span>
      <span class="s1">Sink output = </span><span class="s2">null;</span>

      <span class="s2">try </span><span class="s1">{</span>
        <span class="s1">output = Okio.sink(outputFile)</span><span class="s2">;</span>
        <span class="s1">Okio.buffer(response.body().source()).readAll(output)</span><span class="s2">;</span>
      <span class="s1">} </span><span class="s2">finally </span><span class="s1">{</span>
        <span class="s2">if </span><span class="s1">(output != </span><span class="s2">null</span><span class="s1">) {</span>
          <span class="s1">output.close()</span><span class="s2">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>

      <span class="s2">return </span><span class="s1">outputFile</span><span class="s2">;</span>
    <span class="s1">} </span><span class="s2">catch </span><span class="s1">(Exception ex) {</span>
      <span class="s1">FLog.e(</span>
          <span class="s1">ReactConstants.TAG</span><span class="s2">,</span>
          <span class="s5">&quot;Failed to fetch resource synchronously - resourcePath: </span><span class="s2">\&quot;</span><span class="s5">%s</span><span class="s2">\&quot;</span><span class="s5">, outputFile: </span><span class="s2">\&quot;</span><span class="s5">%s</span><span class="s2">\&quot;</span><span class="s5">&quot;</span><span class="s2">,</span>
          <span class="s1">resourcePath</span><span class="s2">,</span>
          <span class="s1">outputFile.getAbsolutePath()</span><span class="s2">,</span>
          <span class="s1">ex)</span><span class="s2">;</span>
      <span class="s2">return null;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>