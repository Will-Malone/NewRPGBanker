<html>
<head>
<title>native_modules.gradle</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
native_modules.gradle</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">groovy.json.JsonSlurper</span>
<span class="s0">import </span><span class="s1">org.gradle.initialization.DefaultSettings</span>
<span class="s0">import </span><span class="s1">org.apache.tools.ant.taskdefs.condition.Os</span>

<span class="s0">def </span><span class="s1">generatedFileName = </span><span class="s2">&quot;PackageList.java&quot;</span>
<span class="s0">def </span><span class="s1">generatedFilePackage = </span><span class="s2">&quot;com.facebook.react&quot;</span>
<span class="s0">def </span><span class="s1">generatedFileContentsTemplate = </span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">package </span><span class="s1">$generatedFilePackage</span><span class="s2">; 
 
import android.app.Application; 
import android.content.Context; 
import android.content.res.Resources; 
 
import com.facebook.react.ReactPackage; 
import com.facebook.react.shell.MainPackageConfig; 
import com.facebook.react.shell.MainReactPackage; 
import java.util.Arrays; 
import java.util.ArrayList; 
 
{{ packageImports }} 
 
public class PackageList { 
  private Application application; 
  private ReactNativeHost reactNativeHost; 
  private MainPackageConfig mConfig; 
 
  public PackageList(ReactNativeHost reactNativeHost) { 
    this(reactNativeHost, null); 
  } 
 
  public PackageList(Application application) { 
    this(application, null); 
  } 
 
  public PackageList(ReactNativeHost reactNativeHost, MainPackageConfig config) { 
    this.reactNativeHost = reactNativeHost; 
    mConfig = config; 
  } 
 
  public PackageList(Application application, MainPackageConfig config) { 
    this.reactNativeHost = null; 
    this.application = application; 
    mConfig = config; 
  } 
 
  private ReactNativeHost getReactNativeHost() { 
    return this.reactNativeHost; 
  } 
 
  private Resources getResources() { 
    return this.getApplication().getResources(); 
  } 
 
  private Application getApplication() { 
    if (this.reactNativeHost == null) return this.application; 
    return this.reactNativeHost.getApplication(); 
  } 
 
  private Context getApplicationContext() { 
    return this.getApplication().getApplicationContext(); 
  } 
 
  public ArrayList&lt;ReactPackage&gt; getPackages() { 
    return new ArrayList&lt;&gt;(Arrays.&lt;ReactPackage&gt;asList( 
      new MainReactPackage(mConfig){{ packageClassInstances }} 
    )); 
  } 
} 
&quot;&quot;&quot;</span>

<span class="s0">def </span><span class="s1">cmakeTemplate = </span><span class="s2">&quot;&quot;&quot;# This code was generated by [React Native CLI](https://www.npmjs.com/package/@react-native-community/cli) 
 
cmake_minimum_required(VERSION 3.13) 
set(CMAKE_VERBOSE_MAKEFILE on) 
 
{{ libraryIncludes }} 
 
set(AUTOLINKED_LIBRARIES  
  {{ libraryModules }} 
) 
&quot;&quot;&quot;</span>

<span class="s0">def </span><span class="s1">rncliCppTemplate = </span><span class="s2">&quot;&quot;&quot;/** 
 * This code was generated by [React Native CLI](https://www.npmjs.com/package/@react-native-community/cli). 
 * 
 * Do not edit this file as changes may cause incorrect behavior and will be lost 
 * once the code is regenerated. 
 * 
 */ 
 
#include &quot;rncli.h&quot; 
{{ rncliCppIncludes }} 
 
namespace facebook { 
namespace react { 
 
{{ rncliReactLegacyComponentNames }} 
 
std::shared_ptr&lt;TurboModule&gt; rncli_ModuleProvider(const std::string moduleName, const JavaTurboModule::InitParams &amp;params) { 
{{ rncliCppModuleProviders }} 
  return nullptr; 
} 
 
void rncli_registerProviders(std::shared_ptr&lt;ComponentDescriptorProviderRegistry const&gt; providerRegistry) { 
{{ rncliCppComponentDescriptors }} 
{{ rncliReactLegacyComponentDescriptors }} 
  return; 
} 
 
} // namespace react 
} // namespace facebook 
&quot;&quot;&quot;</span>

<span class="s0">def </span><span class="s1">rncliHTemplate = </span><span class="s2">&quot;&quot;&quot;/** 
 * This code was generated by [React Native CLI](https://www.npmjs.com/package/@react-native-community/cli). 
 * 
 * Do not edit this file as changes may cause incorrect behavior and will be lost 
 * once the code is regenerated. 
 * 
 */ 
 
#pragma once 
 
#include &lt;ReactCommon/JavaTurboModule.h&gt; 
#include &lt;ReactCommon/TurboModule.h&gt; 
#include &lt;jsi/jsi.h&gt; 
#include &lt;react/renderer/componentregistry/ComponentDescriptorProviderRegistry.h&gt; 
 
namespace facebook { 
namespace react { 
 
std::shared_ptr&lt;TurboModule&gt; rncli_ModuleProvider(const std::string moduleName, const JavaTurboModule::InitParams &amp;params); 
void rncli_registerProviders(std::shared_ptr&lt;ComponentDescriptorProviderRegistry const&gt; providerRegistry); 
 
} // namespace react 
} // namespace facebook 
&quot;&quot;&quot;</span>

<span class="s0">class </span><span class="s1">ReactNativeModules {</span>
  <span class="s0">private </span><span class="s1">Logger logger</span>
  <span class="s0">private </span><span class="s1">String packageName</span>
  <span class="s0">private </span><span class="s1">File root</span>
  <span class="s0">private </span><span class="s1">ArrayList&lt;HashMap&lt;String, String&gt;&gt; reactNativeModules</span>
  <span class="s0">private </span><span class="s1">ArrayList&lt;String&gt; unstable_reactLegacyComponentNames</span>
  <span class="s0">private </span><span class="s1">HashMap&lt;String, ArrayList&gt; reactNativeModulesBuildVariants</span>

  <span class="s0">private static </span><span class="s1">String LOG_PREFIX = </span><span class="s2">&quot;:ReactNative:&quot;</span>

  <span class="s1">ReactNativeModules(Logger logger, File root) {</span>
    <span class="s0">this</span><span class="s1">.logger = logger</span>
    <span class="s0">this</span><span class="s1">.root = root</span>

    <span class="s0">def </span><span class="s1">(nativeModules, reactNativeModulesBuildVariants, androidProject) = </span><span class="s0">this</span><span class="s1">.getReactNativeConfig()</span>
    <span class="s0">this</span><span class="s1">.reactNativeModules = nativeModules</span>
    <span class="s0">this</span><span class="s1">.reactNativeModulesBuildVariants = reactNativeModulesBuildVariants</span>
    <span class="s0">this</span><span class="s1">.packageName = androidProject[</span><span class="s2">&quot;packageName&quot;</span><span class="s1">]</span>
    <span class="s0">this</span><span class="s1">.unstable_reactLegacyComponentNames = androidProject[</span><span class="s2">&quot;unstable_reactLegacyComponentNames&quot;</span><span class="s1">]</span>
  <span class="s1">}</span>

  <span class="s3">/** 
   * Include the react native modules android projects and specify their project directory 
   */</span>
  <span class="s0">void </span><span class="s1">addReactNativeModuleProjects(DefaultSettings defaultSettings) {</span>
    <span class="s1">reactNativeModules.forEach { reactNativeModule -&gt;</span>
      <span class="s1">String nameCleansed = reactNativeModule[</span><span class="s2">&quot;nameCleansed&quot;</span><span class="s1">]</span>
      <span class="s1">String androidSourceDir = reactNativeModule[</span><span class="s2">&quot;androidSourceDir&quot;</span><span class="s1">]</span>
      <span class="s1">defaultSettings.include(</span><span class="s2">&quot;:</span><span class="s1">${nameCleansed}</span><span class="s2">&quot;</span><span class="s1">)</span>
      <span class="s1">defaultSettings.project(</span><span class="s2">&quot;:</span><span class="s1">${nameCleansed}</span><span class="s2">&quot;</span><span class="s1">).projectDir = </span><span class="s0">new </span><span class="s1">File(</span><span class="s2">&quot;</span><span class="s1">${androidSourceDir}</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">/** 
   * Adds the react native modules as dependencies to the users `app` project 
   */</span>
  <span class="s0">void </span><span class="s1">addReactNativeModuleDependencies(Project appProject) {</span>
    <span class="s1">reactNativeModules.forEach { reactNativeModule -&gt;</span>
      <span class="s0">def </span><span class="s1">nameCleansed = reactNativeModule[</span><span class="s2">&quot;nameCleansed&quot;</span><span class="s1">]</span>
      <span class="s0">def </span><span class="s1">dependencyConfiguration = reactNativeModule[</span><span class="s2">&quot;dependencyConfiguration&quot;</span><span class="s1">]</span>
      <span class="s1">appProject.dependencies {</span>
        <span class="s0">if </span><span class="s1">(reactNativeModulesBuildVariants.containsKey(nameCleansed)) {</span>
          <span class="s1">reactNativeModulesBuildVariants</span>
            <span class="s1">.get(nameCleansed)</span>
            <span class="s1">.forEach { buildVariant -&gt; </span>
              <span class="s0">if</span><span class="s1">(dependencyConfiguration != </span><span class="s0">null</span><span class="s1">) {</span>
                <span class="s2">&quot;</span><span class="s1">${buildVariant}${dependencyConfiguration}</span><span class="s2">&quot;</span>
              <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
                <span class="s2">&quot;</span><span class="s1">${buildVariant}</span><span class="s2">Implementation&quot; </span><span class="s1">project(path: </span><span class="s2">&quot;:</span><span class="s1">${nameCleansed}</span><span class="s2">&quot;</span><span class="s1">)</span>
              <span class="s1">}</span>
            <span class="s1">}</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
          <span class="s0">if</span><span class="s1">(dependencyConfiguration != </span><span class="s0">null</span><span class="s1">) {</span>
            <span class="s2">&quot;</span><span class="s1">${dependencyConfiguration}</span><span class="s2">&quot;</span>
          <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
             <span class="s1">implementation project(path: </span><span class="s2">&quot;:</span><span class="s1">${nameCleansed}</span><span class="s2">&quot;</span><span class="s1">)</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">/** 
   * Code-gen a java file with all the detected ReactNativePackage instances automatically added 
   * 
   * @param outputDir 
   * @param generatedFileName 
   * @param generatedFileContentsTemplate 
   */</span>
  <span class="s0">void </span><span class="s1">generatePackagesFile(File outputDir, String generatedFileName, String generatedFileContentsTemplate) {</span>
    <span class="s1">ArrayList&lt;HashMap&lt;String, String&gt;&gt; packages = </span><span class="s0">this</span><span class="s1">.reactNativeModules</span>
    <span class="s1">String packageName = </span><span class="s0">this</span><span class="s1">.packageName</span>

    <span class="s1">String packageImports = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">String packageClassInstances = </span><span class="s2">&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">(packages.size() &gt; </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s0">def </span><span class="s1">interpolateDynamicValues = {</span>
        <span class="s1">it</span>
                <span class="s3">// Before adding the package replacement mechanism,</span>
                <span class="s3">// BuildConfig and R classes were imported automatically</span>
                <span class="s3">// into the scope of the file. We want to replace all</span>
                <span class="s3">// non-FQDN references to those classes with the package name </span>
                <span class="s3">// of the MainApplication.</span>
                <span class="s3">//</span>
                <span class="s3">// We want to match &quot;R&quot; or &quot;BuildConfig&quot;:</span>
                <span class="s3">//  - new Package(R.string…),</span>
                <span class="s3">//  - Module.configure(BuildConfig);</span>
                <span class="s3">//    ^ hence including (BuildConfig|R)</span>
                <span class="s3">// but we don't want to match &quot;R&quot;:</span>
                <span class="s3">//  - new Package(getResources…),</span>
                <span class="s3">//  - new PackageR…,</span>
                <span class="s3">//  - new Royal…,</span>
                <span class="s3">//    ^ hence excluding \w before and after matches</span>
                <span class="s3">// and &quot;BuildConfig&quot; that has FQDN reference:</span>
                <span class="s3">//  - Module.configure(com.acme.BuildConfig);</span>
                <span class="s3">//    ^ hence excluding . before the match.</span>
                <span class="s1">.replaceAll(~</span><span class="s2">/([^.\w])(BuildConfig|R)([^\w])/</span><span class="s1">, {</span>
                  <span class="s1">wholeString, prefix, className, suffix -&gt;</span>
                    <span class="s2">&quot;</span><span class="s1">${prefix}${packageName}</span><span class="s2">.</span><span class="s1">${className}${suffix}</span><span class="s2">&quot;</span>
                <span class="s1">})</span>
      <span class="s1">}</span>
      <span class="s1">packageImports = packages.collect {</span>
        <span class="s2">&quot;// </span><span class="s1">${it.name}</span><span class="s0">\n</span><span class="s1">${interpolateDynamicValues(it.packageImportPath)}</span><span class="s2">&quot;</span>
      <span class="s1">}.join(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">)</span>
      <span class="s1">packageClassInstances = </span><span class="s2">&quot;,</span><span class="s0">\n      </span><span class="s2">&quot; </span><span class="s1">+ packages.collect {</span>
        <span class="s1">interpolateDynamicValues(it.packageInstance)</span>
      <span class="s1">}.join(</span><span class="s2">&quot;,</span><span class="s0">\n      </span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s1">}</span>

    <span class="s1">String generatedFileContents = generatedFileContentsTemplate</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ packageImports }}&quot;</span><span class="s1">, packageImports)</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ packageClassInstances }}&quot;</span><span class="s1">, packageClassInstances)</span>

    <span class="s1">outputDir.mkdirs()</span>
    <span class="s0">final </span><span class="s1">FileTreeBuilder treeBuilder = </span><span class="s0">new </span><span class="s1">FileTreeBuilder(outputDir)</span>
    <span class="s1">treeBuilder.file(generatedFileName).newWriter().withWriter { w -&gt;</span>
      <span class="s1">w &lt;&lt; generatedFileContents</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">void </span><span class="s1">generateCmakeFile(File outputDir, String generatedFileName, String generatedFileContentsTemplate) {</span>
    <span class="s1">ArrayList&lt;HashMap&lt;String, String&gt;&gt; packages = </span><span class="s0">this</span><span class="s1">.reactNativeModules</span>
    <span class="s1">String packageName = </span><span class="s0">this</span><span class="s1">.packageName</span>
    <span class="s1">String codegenLibPrefix = </span><span class="s2">&quot;react_codegen_&quot;</span>
    <span class="s1">String libraryIncludes = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">String libraryModules = </span><span class="s2">&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">(packages.size() &gt; </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s1">libraryIncludes = packages.collect {</span>
        <span class="s0">if </span><span class="s1">(it.libraryName != </span><span class="s0">null </span><span class="s1">&amp;&amp; it.cmakeListsPath != </span><span class="s0">null</span><span class="s1">) {</span>
          <span class="s3">// If user provided a custom cmakeListsPath, let's honor it.</span>
          <span class="s1">String nativeFolderPath = it.cmakeListsPath.replace(</span><span class="s2">&quot;CMakeLists.txt&quot;</span><span class="s1">, </span><span class="s2">&quot;&quot;</span><span class="s1">)</span>
          <span class="s2">&quot;add_subdirectory(</span><span class="s1">$nativeFolderPath ${it.libraryName}</span><span class="s2">_autolinked_build)&quot;</span>
        <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
          <span class="s0">null</span>
        <span class="s1">}</span>
      <span class="s1">}.minus(</span><span class="s0">null</span><span class="s1">).join(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">)</span>
      <span class="s1">libraryModules = packages.collect {</span>
        <span class="s1">it.libraryName ? </span><span class="s2">&quot;</span><span class="s1">${codegenLibPrefix}${it.libraryName}</span><span class="s2">&quot; </span><span class="s1">: </span><span class="s0">null</span>
      <span class="s1">}.minus(</span><span class="s0">null</span><span class="s1">).join(</span><span class="s2">'</span><span class="s0">\n  </span><span class="s2">'</span><span class="s1">)</span>
    <span class="s1">}</span>

    <span class="s1">String generatedFileContents = generatedFileContentsTemplate</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ libraryIncludes }}&quot;</span><span class="s1">, libraryIncludes)</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ libraryModules }}&quot;</span><span class="s1">, libraryModules)</span>

    <span class="s1">outputDir.mkdirs()</span>
    <span class="s0">final </span><span class="s1">FileTreeBuilder treeBuilder = </span><span class="s0">new </span><span class="s1">FileTreeBuilder(outputDir)</span>
    <span class="s1">treeBuilder.file(generatedFileName).newWriter().withWriter { w -&gt;</span>
      <span class="s1">w &lt;&lt; generatedFileContents</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">void </span><span class="s1">generateRncliCpp(File outputDir, String generatedFileName, String generatedFileContentsTemplate) {</span>
    <span class="s1">ArrayList&lt;HashMap&lt;String, String&gt;&gt; packages = </span><span class="s0">this</span><span class="s1">.reactNativeModules</span>
    <span class="s1">ArrayList&lt;String&gt; unstable_reactLegacyComponentNames = </span><span class="s0">this</span><span class="s1">.unstable_reactLegacyComponentNames</span>
    <span class="s1">String rncliCppIncludes = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">String rncliCppModuleProviders = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">String rncliCppComponentDescriptors = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">String rncliReactLegacyComponentDescriptors = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">String rncliReactLegacyComponentNames = </span><span class="s2">&quot;&quot;</span>
    <span class="s1">String codegenComponentDescriptorsHeaderFile = </span><span class="s2">&quot;ComponentDescriptors.h&quot;</span>
    <span class="s1">String codegenReactComponentsDir = </span><span class="s2">&quot;react/renderer/components&quot;</span>

    <span class="s0">if </span><span class="s1">(packages.size() &gt; </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s1">rncliCppIncludes = packages.collect {</span>
        <span class="s0">if </span><span class="s1">(!it.libraryName) {</span>
          <span class="s0">return null</span>
        <span class="s1">}</span>
        <span class="s0">def </span><span class="s1">result = </span><span class="s2">&quot;#include &lt;</span><span class="s1">${it.libraryName}</span><span class="s2">.h&gt;&quot;</span>
        <span class="s0">if </span><span class="s1">(it.componentDescriptors &amp;&amp; it.componentDescriptors.size() &gt; </span><span class="s4">0</span><span class="s1">) {</span>
          <span class="s1">result += </span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">#include &lt;</span><span class="s1">${codegenReactComponentsDir}</span><span class="s2">/</span><span class="s1">${it.libraryName}</span><span class="s2">/</span><span class="s1">${codegenComponentDescriptorsHeaderFile}</span><span class="s2">&gt;&quot;</span>
        <span class="s1">}</span>
        <span class="s1">result</span>
      <span class="s1">}.minus(</span><span class="s0">null</span><span class="s1">).join(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">)</span>
      <span class="s1">rncliCppModuleProviders = packages.collect {</span>
        <span class="s1">it.libraryName ? </span><span class="s2">&quot;&quot;&quot;  auto module_</span><span class="s1">${it.libraryName} </span><span class="s2">= </span><span class="s1">${it.libraryName}</span><span class="s2">_ModuleProvider(moduleName, params); 
  if (module_</span><span class="s1">${it.libraryName} </span><span class="s2">!= nullptr) { 
    return module_</span><span class="s1">${it.libraryName}</span><span class="s2">; 
  }&quot;&quot;&quot; </span><span class="s1">: </span><span class="s0">null</span>
      <span class="s1">}.minus(</span><span class="s0">null</span><span class="s1">).join(</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span>
      <span class="s1">rncliCppComponentDescriptors = packages.collect {</span>
        <span class="s0">def </span><span class="s1">result = </span><span class="s2">&quot;&quot;</span>
        <span class="s0">if </span><span class="s1">(it.componentDescriptors &amp;&amp; it.componentDescriptors.size() &gt; </span><span class="s4">0</span><span class="s1">) {</span>
          <span class="s1">result += it.componentDescriptors.collect {</span>
            <span class="s2">&quot;  providerRegistry-&gt;add(concreteComponentDescriptorProvider&lt;</span><span class="s1">${it}</span><span class="s2">&gt;());&quot;</span>
          <span class="s1">}.join(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">)</span>
        <span class="s1">} </span>
        <span class="s1">result</span>
      <span class="s1">}.join(</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s1">}</span>

    <span class="s1">rncliReactLegacyComponentDescriptors = unstable_reactLegacyComponentNames.collect {</span>
      <span class="s2">&quot;  providerRegistry-&gt;add(concreteComponentDescriptorProvider&lt;UnstableLegacyViewManagerInteropComponentDescriptor&lt;</span><span class="s1">${it}</span><span class="s2">&gt;&gt;());&quot;</span>
    <span class="s1">}.join(</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s1">rncliReactLegacyComponentNames = unstable_reactLegacyComponentNames.collect {</span>
      <span class="s2">&quot;extern const char </span><span class="s1">${it}</span><span class="s2">[] = </span><span class="s0">\&quot;</span><span class="s1">${it}</span><span class="s0">\&quot;</span><span class="s2">;&quot;</span>
    <span class="s1">}.join(</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">(unstable_reactLegacyComponentNames &amp;&amp; unstable_reactLegacyComponentNames.size() &gt; </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s1">rncliCppIncludes += </span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">#include &lt;react/renderer/components/legacyviewmanagerinterop/UnstableLegacyViewManagerInteropComponentDescriptor.h&gt;&quot;</span>
    <span class="s1">}</span>

    <span class="s1">String generatedFileContents = generatedFileContentsTemplate</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ rncliCppIncludes }}&quot;</span><span class="s1">, rncliCppIncludes)</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ rncliCppModuleProviders }}&quot;</span><span class="s1">, rncliCppModuleProviders)</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ rncliCppComponentDescriptors }}&quot;</span><span class="s1">, rncliCppComponentDescriptors)</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ rncliReactLegacyComponentDescriptors }}&quot;</span><span class="s1">, rncliReactLegacyComponentDescriptors)</span>
      <span class="s1">.replace(</span><span class="s2">&quot;{{ rncliReactLegacyComponentNames }}&quot;</span><span class="s1">, rncliReactLegacyComponentNames)</span>

    <span class="s1">outputDir.mkdirs()</span>
    <span class="s0">final </span><span class="s1">FileTreeBuilder treeBuilder = </span><span class="s0">new </span><span class="s1">FileTreeBuilder(outputDir)</span>
    <span class="s1">treeBuilder.file(generatedFileName).newWriter().withWriter { w -&gt;</span>
      <span class="s1">w &lt;&lt; generatedFileContents</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">void </span><span class="s1">generateRncliH(File outputDir, String generatedFileName, String generatedFileContentsTemplate) {</span>
    <span class="s1">String generatedFileContents = generatedFileContentsTemplate</span>

    <span class="s1">outputDir.mkdirs()</span>
    <span class="s0">final </span><span class="s1">FileTreeBuilder treeBuilder = </span><span class="s0">new </span><span class="s1">FileTreeBuilder(outputDir)</span>
    <span class="s1">treeBuilder.file(generatedFileName).newWriter().withWriter { w -&gt;</span>
      <span class="s1">w &lt;&lt; generatedFileContents</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">/** 
   * Runs a specified command using Runtime exec() in a specified directory. 
   * Throws when the command result is empty. 
   */</span>
  <span class="s1">String getCommandOutput(String[] command, File directory) {</span>
    <span class="s0">try </span><span class="s1">{</span>
      <span class="s0">def </span><span class="s1">output = </span><span class="s2">&quot;&quot;</span>
      <span class="s0">def </span><span class="s1">cmdProcess = Runtime.getRuntime().exec(command, </span><span class="s0">null</span><span class="s1">, directory)</span>
      <span class="s0">def </span><span class="s1">bufferedReader = </span><span class="s0">new </span><span class="s1">BufferedReader(</span><span class="s0">new </span><span class="s1">InputStreamReader(cmdProcess.getInputStream()))</span>
      <span class="s0">def </span><span class="s1">buff = </span><span class="s2">&quot;&quot;</span>
      <span class="s0">def </span><span class="s1">readBuffer = </span><span class="s0">new </span><span class="s1">StringBuffer()</span>
      <span class="s0">while </span><span class="s1">((buff = bufferedReader.readLine()) != </span><span class="s0">null</span><span class="s1">) {</span>
        <span class="s1">readBuffer.append(buff)</span>
      <span class="s1">}</span>
      <span class="s1">output = readBuffer.toString()</span>
      <span class="s0">if </span><span class="s1">(!output) {</span>
        <span class="s0">this</span><span class="s1">.logger.error(</span><span class="s2">&quot;</span><span class="s1">${LOG_PREFIX}</span><span class="s2">Unexpected empty result of running '</span><span class="s1">${command}</span><span class="s2">' command.&quot;</span><span class="s1">)</span>
        <span class="s0">def </span><span class="s1">bufferedErrorReader = </span><span class="s0">new </span><span class="s1">BufferedReader(</span><span class="s0">new </span><span class="s1">InputStreamReader(cmdProcess.getErrorStream()))</span>
        <span class="s0">def </span><span class="s1">errBuff = </span><span class="s2">&quot;&quot;</span>
        <span class="s0">def </span><span class="s1">readErrorBuffer = </span><span class="s0">new </span><span class="s1">StringBuffer()</span>
        <span class="s0">while </span><span class="s1">((errBuff = bufferedErrorReader.readLine()) != </span><span class="s0">null</span><span class="s1">) {</span>
          <span class="s1">readErrorBuffer.append(errBuff)</span>
        <span class="s1">}</span>
        <span class="s0">throw new </span><span class="s1">Exception(readErrorBuffer.toString())</span>
      <span class="s1">}</span>
      <span class="s0">return </span><span class="s1">output</span>
    <span class="s1">} </span><span class="s0">catch </span><span class="s1">(Exception exception) {</span>
      <span class="s0">this</span><span class="s1">.logger.error(</span><span class="s2">&quot;</span><span class="s1">${LOG_PREFIX}</span><span class="s2">Running '</span><span class="s1">${command}</span><span class="s2">' command failed.&quot;</span><span class="s1">)</span>
      <span class="s0">throw </span><span class="s1">exception</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s3">/** 
   * Runs a process to call the React Native CLI Config command and parses the output 
   */</span>
  <span class="s1">ArrayList&lt;HashMap&lt;String, String&gt;&gt; getReactNativeConfig() {</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">this</span><span class="s1">.reactNativeModules != </span><span class="s0">null</span><span class="s1">) </span><span class="s0">return this</span><span class="s1">.reactNativeModules</span>

    <span class="s1">ArrayList&lt;HashMap&lt;String, String&gt;&gt; reactNativeModules = </span><span class="s0">new </span><span class="s1">ArrayList&lt;HashMap&lt;String, String&gt;&gt;()</span>
    <span class="s1">HashMap&lt;String, ArrayList&gt; reactNativeModulesBuildVariants = </span><span class="s0">new </span><span class="s1">HashMap&lt;String, ArrayList&gt;()</span>
    
    <span class="s3">/** 
     * Resolve the CLI location from Gradle file 
     * 
     * @todo: Sometimes Gradle can be called outside of the JavaScript hierarchy (-p flag) which 
     * will fail to resolve the script and the dependencies. We should resolve this soon. 
     * 
     * @todo: `fastlane` has been reported to not work too. 
     */</span>
    <span class="s0">def </span><span class="s1">cliResolveScript = </span><span class="s2">&quot;try {console.log(require('@react-native-community/cli').bin);} catch (e) {console.log(require('react-native/cli').bin);}&quot;</span>
    <span class="s1">String[] nodeCommand = [</span><span class="s2">&quot;node&quot;</span><span class="s1">, </span><span class="s2">&quot;-e&quot;</span><span class="s1">, cliResolveScript]</span>
    <span class="s0">def </span><span class="s1">cliPath = </span><span class="s0">this</span><span class="s1">.getCommandOutput(nodeCommand, </span><span class="s0">this</span><span class="s1">.root)</span>

    <span class="s1">String[] reactNativeConfigCommand = [</span><span class="s2">&quot;node&quot;</span><span class="s1">, cliPath, </span><span class="s2">&quot;config&quot;</span><span class="s1">]</span>
    <span class="s0">def </span><span class="s1">reactNativeConfigOutput = </span><span class="s0">this</span><span class="s1">.getCommandOutput(reactNativeConfigCommand, </span><span class="s0">this</span><span class="s1">.root)</span>

    <span class="s0">def </span><span class="s1">json</span>
    <span class="s0">try </span><span class="s1">{</span>
      <span class="s1">json = </span><span class="s0">new </span><span class="s1">JsonSlurper().parseText(reactNativeConfigOutput)</span>
    <span class="s1">} </span><span class="s0">catch </span><span class="s1">(Exception exception) {</span>
      <span class="s0">throw new </span><span class="s1">Exception(</span><span class="s2">&quot;Calling `</span><span class="s1">${reactNativeConfigCommand}</span><span class="s2">` finished with an exception. Error message: </span><span class="s1">${exception.toString()}</span><span class="s2">. Output: </span><span class="s1">${reactNativeConfigOutput}</span><span class="s2">&quot;</span><span class="s1">);</span>
    <span class="s1">}</span>
    <span class="s0">def </span><span class="s1">dependencies = json[</span><span class="s2">&quot;dependencies&quot;</span><span class="s1">]</span>
    <span class="s0">def </span><span class="s1">project = json[</span><span class="s2">&quot;project&quot;</span><span class="s1">][</span><span class="s2">&quot;android&quot;</span><span class="s1">]</span>

    <span class="s0">if </span><span class="s1">(project == </span><span class="s0">null</span><span class="s1">) {</span>
      <span class="s0">throw new </span><span class="s1">Exception(</span><span class="s2">&quot;React Native CLI failed to determine Android project configuration. This is likely due to misconfiguration. Config output:</span><span class="s0">\n</span><span class="s1">${json.toMapString()}</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s1">}</span>

    <span class="s0">def </span><span class="s1">engine = </span><span class="s0">new </span><span class="s1">groovy.text.SimpleTemplateEngine()</span>

    <span class="s1">dependencies.each { name, value -&gt;</span>
      <span class="s0">def </span><span class="s1">platformsConfig = value[</span><span class="s2">&quot;platforms&quot;</span><span class="s1">];</span>
      <span class="s0">def </span><span class="s1">androidConfig = platformsConfig[</span><span class="s2">&quot;android&quot;</span><span class="s1">]</span>

      <span class="s0">if </span><span class="s1">(androidConfig != </span><span class="s0">null </span><span class="s1">&amp;&amp; androidConfig[</span><span class="s2">&quot;sourceDir&quot;</span><span class="s1">] != </span><span class="s0">null</span><span class="s1">) {</span>
        <span class="s0">this</span><span class="s1">.logger.info(</span><span class="s2">&quot;</span><span class="s1">${LOG_PREFIX}</span><span class="s2">Automatically adding native module '</span><span class="s1">${name}</span><span class="s2">'&quot;</span><span class="s1">)</span>
        
        <span class="s1">HashMap reactNativeModuleConfig = </span><span class="s0">new </span><span class="s1">HashMap&lt;String, String&gt;()</span>
        <span class="s0">def </span><span class="s1">nameCleansed = name.replaceAll(</span><span class="s2">'[~*!</span><span class="s0">\'</span><span class="s2">()]+'</span><span class="s1">, </span><span class="s2">'_'</span><span class="s1">).replaceAll(</span><span class="s2">'^@([</span><span class="s0">\\</span><span class="s2">w-.]+)/'</span><span class="s1">, </span><span class="s2">'$1_'</span><span class="s1">)</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;name&quot;</span><span class="s1">, name)</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;nameCleansed&quot;</span><span class="s1">, nameCleansed)</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;androidSourceDir&quot;</span><span class="s1">, androidConfig[</span><span class="s2">&quot;sourceDir&quot;</span><span class="s1">])</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;packageInstance&quot;</span><span class="s1">, androidConfig[</span><span class="s2">&quot;packageInstance&quot;</span><span class="s1">])</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;packageImportPath&quot;</span><span class="s1">, androidConfig[</span><span class="s2">&quot;packageImportPath&quot;</span><span class="s1">])</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;libraryName&quot;</span><span class="s1">, androidConfig[</span><span class="s2">&quot;libraryName&quot;</span><span class="s1">])</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;componentDescriptors&quot;</span><span class="s1">, androidConfig[</span><span class="s2">&quot;componentDescriptors&quot;</span><span class="s1">])</span>
        <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;cmakeListsPath&quot;</span><span class="s1">, androidConfig[</span><span class="s2">&quot;cmakeListsPath&quot;</span><span class="s1">])</span>

        <span class="s0">if </span><span class="s1">(androidConfig[</span><span class="s2">&quot;buildTypes&quot;</span><span class="s1">] &amp;&amp; !androidConfig[</span><span class="s2">&quot;buildTypes&quot;</span><span class="s1">].isEmpty()) {</span>
          <span class="s1">reactNativeModulesBuildVariants.put(nameCleansed, androidConfig[</span><span class="s2">&quot;buildTypes&quot;</span><span class="s1">])</span>
        <span class="s1">}</span>
        <span class="s0">if</span><span class="s1">(androidConfig.containsKey(</span><span class="s2">&quot;dependencyConfiguration&quot;</span><span class="s1">)) {</span>
          <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;dependencyConfiguration&quot;</span><span class="s1">, androidConfig[</span><span class="s2">&quot;dependencyConfiguration&quot;</span><span class="s1">])</span>
        <span class="s1">} </span><span class="s0">else if </span><span class="s1">(project.containsKey(</span><span class="s2">&quot;dependencyConfiguration&quot;</span><span class="s1">)) {</span>
          <span class="s0">def </span><span class="s1">bindings = [</span><span class="s2">&quot;dependencyName&quot;</span><span class="s1">: nameCleansed]</span>
          <span class="s0">def </span><span class="s1">template = engine.createTemplate(project[</span><span class="s2">&quot;dependencyConfiguration&quot;</span><span class="s1">]).make(bindings)</span>

          <span class="s1">reactNativeModuleConfig.put(</span><span class="s2">&quot;dependencyConfiguration&quot;</span><span class="s1">, template.toString())</span>
        <span class="s1">}</span>

        <span class="s0">this</span><span class="s1">.logger.trace(</span><span class="s2">&quot;</span><span class="s1">${LOG_PREFIX}</span><span class="s2">'</span><span class="s1">${name}</span><span class="s2">': </span><span class="s1">${reactNativeModuleConfig.toMapString()}</span><span class="s2">&quot;</span><span class="s1">)</span>
        
        <span class="s1">reactNativeModules.add(reactNativeModuleConfig)</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s0">this</span><span class="s1">.logger.info(</span><span class="s2">&quot;</span><span class="s1">${LOG_PREFIX}</span><span class="s2">Skipping native module '</span><span class="s1">${name}</span><span class="s2">'&quot;</span><span class="s1">)</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s1">[reactNativeModules, reactNativeModulesBuildVariants, json[</span><span class="s2">&quot;project&quot;</span><span class="s1">][</span><span class="s2">&quot;android&quot;</span><span class="s1">]];</span>
  <span class="s1">}</span>
<span class="s1">}</span>


<span class="s3">/* 
 * Sometimes Gradle can be called outside of JavaScript hierarchy. Detect the directory 
 * where build files of an active project are located. 
 */</span>
<span class="s0">def </span><span class="s1">projectRoot = rootProject.projectDir</span>

<span class="s0">def </span><span class="s1">autoModules = </span><span class="s0">new </span><span class="s1">ReactNativeModules(logger, projectRoot)</span>

<span class="s3">/** ----------------------- 
 *    Exported Extensions 
 * ------------------------ */</span>

<span class="s1">ext.applyNativeModulesSettingsGradle = { DefaultSettings defaultSettings, String root = </span><span class="s0">null </span><span class="s1">-&gt;</span>
  <span class="s0">if </span><span class="s1">(root != </span><span class="s0">null</span><span class="s1">) {</span>
    <span class="s1">logger.warn(</span><span class="s2">&quot;</span><span class="s1">${ReactNativeModules.LOG_PREFIX}</span><span class="s2">Passing custom root is deprecated. CLI detects root automatically now.&quot;</span><span class="s1">);</span>
    <span class="s1">logger.warn(</span><span class="s2">&quot;</span><span class="s1">${ReactNativeModules.LOG_PREFIX}</span><span class="s2">Please remove second argument to `applyNativeModulesSettingsGradle`.&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">autoModules.addReactNativeModuleProjects(defaultSettings)</span>
<span class="s1">}</span>

<span class="s1">ext.applyNativeModulesAppBuildGradle = { Project project, String root = </span><span class="s0">null </span><span class="s1">-&gt;</span>
  <span class="s0">if </span><span class="s1">(root != </span><span class="s0">null</span><span class="s1">) {</span>
    <span class="s1">logger.warn(</span><span class="s2">&quot;</span><span class="s1">${ReactNativeModules.LOG_PREFIX}</span><span class="s2">Passing custom root is deprecated. CLI detects root automatically now&quot;</span><span class="s1">);</span>
    <span class="s1">logger.warn(</span><span class="s2">&quot;</span><span class="s1">${ReactNativeModules.LOG_PREFIX}</span><span class="s2">Please remove second argument to `applyNativeModulesAppBuildGradle`.&quot;</span><span class="s1">);</span>
  <span class="s1">}</span>
  <span class="s1">autoModules.addReactNativeModuleDependencies(project)</span>

  <span class="s0">def </span><span class="s1">generatedSrcDir = </span><span class="s0">new </span><span class="s1">File(buildDir, </span><span class="s2">&quot;generated/rncli/src/main/java&quot;</span><span class="s1">)</span>
  <span class="s0">def </span><span class="s1">generatedCodeDir = </span><span class="s0">new </span><span class="s1">File(generatedSrcDir, generatedFilePackage.replace(</span><span class="s2">'.'</span><span class="s1">, </span><span class="s2">'/'</span><span class="s1">))</span>
  <span class="s0">def </span><span class="s1">generatedJniDir = </span><span class="s0">new </span><span class="s1">File(buildDir, </span><span class="s2">&quot;generated/rncli/src/main/jni&quot;</span><span class="s1">)</span>

  <span class="s1">task generatePackageList {</span>
    <span class="s1">doLast {</span>
      <span class="s1">autoModules.generatePackagesFile(generatedCodeDir, generatedFileName, generatedFileContentsTemplate)</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">task generateNewArchitectureFiles {</span>
    <span class="s1">doLast {</span>
      <span class="s1">autoModules.generateCmakeFile(generatedJniDir, </span><span class="s2">&quot;Android-rncli.cmake&quot;</span><span class="s1">, cmakeTemplate) </span>
      <span class="s1">autoModules.generateRncliCpp(generatedJniDir, </span><span class="s2">&quot;rncli.cpp&quot;</span><span class="s1">, rncliCppTemplate)</span>
      <span class="s1">autoModules.generateRncliH(generatedJniDir, </span><span class="s2">&quot;rncli.h&quot;</span><span class="s1">, rncliHTemplate)</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s1">preBuild.dependsOn generatePackageList</span>

  <span class="s0">if </span><span class="s1">(project.hasProperty(</span><span class="s2">&quot;newArchEnabled&quot;</span><span class="s1">) &amp;&amp; project.newArchEnabled == </span><span class="s2">&quot;true&quot;</span><span class="s1">) {</span>
    <span class="s1">preBuild.dependsOn generateNewArchitectureFiles</span>
  <span class="s1">}</span>

  <span class="s1">android {</span>
    <span class="s1">sourceSets {</span>
      <span class="s1">main {</span>
        <span class="s1">java {</span>
          <span class="s1">srcDirs += generatedSrcDir</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>