<html>
<head>
<title>GestureHandlerOrchestrator.ts</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #a9b7c6;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb; font-style: italic;}
.s5 { color: #808080;}
.s6 { color: #ffc66d;}
.s7 { color: #9876aa; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
GestureHandlerOrchestrator.ts</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">{ </span><span class="s2">State </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../../State'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">PointerType </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../interfaces'</span><span class="s1">;</span>

<span class="s0">import </span><span class="s2">GestureHandler </span><span class="s0">from </span><span class="s3">'../handlers/GestureHandler'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s2">PointerTracker </span><span class="s0">from </span><span class="s3">'./PointerTracker'</span><span class="s1">;</span>
<span class="s0">import </span><span class="s1">{ </span><span class="s2">isPointerInBounds </span><span class="s1">} </span><span class="s0">from </span><span class="s3">'../utils'</span><span class="s1">;</span>

<span class="s0">export default class </span><span class="s2">GestureHandlerOrchestrator </span><span class="s1">{</span>
  <span class="s0">private static </span><span class="s1">instance</span><span class="s0">: </span><span class="s2">GestureHandlerOrchestrator</span><span class="s1">;</span>

  <span class="s0">private </span><span class="s1">gestureHandlers</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">[] </span><span class="s0">= </span><span class="s1">[];</span>
  <span class="s0">private </span><span class="s1">awaitingHandlers</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">[] </span><span class="s0">= </span><span class="s1">[];</span>
  <span class="s0">private </span><span class="s1">handlersToCancel</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">[] </span><span class="s0">= </span><span class="s1">[];</span>

  <span class="s0">private </span><span class="s1">handlingChangeSemaphore </span><span class="s0">= </span><span class="s4">0</span><span class="s1">;</span>
  <span class="s0">private </span><span class="s1">activationIndex </span><span class="s0">= </span><span class="s4">0</span><span class="s1">;</span>

  <span class="s5">// Private beacuse of Singleton</span>
  <span class="s5">// eslint-disable-next-line no-useless-constructor, @typescript-eslint/no-empty-function</span>
  <span class="s0">private constructor</span><span class="s1">() {}</span>

  <span class="s0">private </span><span class="s1">scheduleFinishedHandlersCleanup()</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">handlingChangeSemaphore </span><span class="s0">=== </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s2">this</span><span class="s1">.</span><span class="s6">cleanupFinishedHandlers</span><span class="s1">();</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">cleanHandler(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">reset</span><span class="s1">();</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setActive</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setAwaiting</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setActivationIndex</span><span class="s1">(</span><span class="s2">Number</span><span class="s1">.MAX_VALUE);</span>
  <span class="s1">}</span>

  <span class="s0">public </span><span class="s1">removeHandlerFromOrchestrator(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">splice</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">indexOf</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">), </span><span class="s4">1</span><span class="s1">);</span>
    <span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">splice</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">indexOf</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">), </span><span class="s4">1</span><span class="s1">);</span>
    <span class="s2">this</span><span class="s1">.</span><span class="s2">handlersToCancel</span><span class="s1">.</span><span class="s6">splice</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">handlersToCancel</span><span class="s1">.</span><span class="s6">indexOf</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">), </span><span class="s4">1</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">cleanupFinishedHandlers()</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.length </span><span class="s0">- </span><span class="s4">1</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&gt;= </span><span class="s4">0</span><span class="s1">; </span><span class="s0">--</span><span class="s2">i</span><span class="s1">) {</span>
      <span class="s0">const </span><span class="s1">handler </span><span class="s0">= </span><span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">];</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">handler</span><span class="s1">) {</span>
        <span class="s0">continue</span><span class="s1">;</span>
      <span class="s1">}</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">isFinished</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">()) </span><span class="s0">&amp;&amp; !</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">isAwaiting</span><span class="s1">()) {</span>
        <span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">splice</span><span class="s1">(</span><span class="s2">i</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>

        <span class="s2">this</span><span class="s1">.</span><span class="s6">cleanHandler</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">hasOtherHandlerToWaitFor(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">boolean </span><span class="s1">{</span>
    <span class="s0">let </span><span class="s1">hasToWait </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>
    <span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">otherHandler</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">if </span><span class="s1">(</span>
        <span class="s2">otherHandler </span><span class="s0">&amp;&amp;</span>
        <span class="s0">!</span><span class="s2">this</span><span class="s1">.</span><span class="s6">isFinished</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">()) </span><span class="s0">&amp;&amp;</span>
        <span class="s2">this</span><span class="s1">.</span><span class="s6">shouldHandlerWaitForOther</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">otherHandler</span><span class="s1">)</span>
      <span class="s1">) {</span>
        <span class="s2">hasToWait </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>
        <span class="s0">return</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s0">return </span><span class="s2">hasToWait</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">tryActivate(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">hasOtherHandlerToWaitFor</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">)) {</span>
      <span class="s2">this</span><span class="s1">.</span><span class="s6">addAwaitingHandler</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">() </span><span class="s0">!== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED </span><span class="s0">&amp;&amp;</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">() </span><span class="s0">!== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">FAILED</span>
    <span class="s1">) {</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">shouldActivate</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">)) {</span>
        <span class="s2">this</span><span class="s1">.</span><span class="s6">makeActive</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s0">switch </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">()) {</span>
          <span class="s0">case </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">:</span>
            <span class="s2">handler</span><span class="s1">.</span><span class="s6">fail</span><span class="s1">();</span>
            <span class="s0">break</span><span class="s1">;</span>
          <span class="s0">case </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">:</span>
            <span class="s2">handler</span><span class="s1">.</span><span class="s6">cancel</span><span class="s1">();</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">shouldActivate(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">boolean </span><span class="s1">{</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">const </span><span class="s1">otherHandler </span><span class="s0">of </span><span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">) {</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">shouldHandlerBeCancelledBy</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">otherHandler</span><span class="s1">)) {</span>
        <span class="s0">return </span><span class="s7">false</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s7">true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">cleanupAwaitingHandlers(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&lt; </span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.length; </span><span class="s0">++</span><span class="s2">i</span><span class="s1">) {</span>
      <span class="s0">if </span><span class="s1">(</span>
        <span class="s0">!</span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">].</span><span class="s6">isAwaiting</span><span class="s1">() </span><span class="s0">&amp;&amp;</span>
        <span class="s2">this</span><span class="s1">.</span><span class="s6">shouldHandlerWaitForOther</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">], </span><span class="s2">handler</span><span class="s1">)</span>
      <span class="s1">) {</span>
        <span class="s2">this</span><span class="s1">.</span><span class="s6">cleanHandler</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]);</span>
        <span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">splice</span><span class="s1">(</span><span class="s2">i</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">public </span><span class="s1">onHandlerStateChange(</span>
    <span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">,</span>
    <span class="s2">newState</span><span class="s0">: </span><span class="s2">State</span><span class="s1">,</span>
    <span class="s2">oldState</span><span class="s0">: </span><span class="s2">State</span><span class="s1">,</span>
    <span class="s2">sendIfDisabled</span><span class="s0">?: </span><span class="s2">boolean</span>
  <span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">isEnabled</span><span class="s1">() </span><span class="s0">&amp;&amp; !</span><span class="s2">sendIfDisabled</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">handlingChangeSemaphore </span><span class="s0">+= </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">isFinished</span><span class="s1">(</span><span class="s2">newState</span><span class="s1">)) {</span>
      <span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">otherHandler</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">shouldHandlerWaitForOther</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">)) {</span>
          <span class="s0">if </span><span class="s1">(</span><span class="s2">newState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">) {</span>
            <span class="s2">otherHandler</span><span class="s1">?.</span><span class="s6">cancel</span><span class="s1">();</span>
            <span class="s0">if </span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">() </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">) {</span>
              <span class="s5">// Handle edge case, where discrete gestures end immediately after activation thus</span>
              <span class="s5">// their state is set to END and when the gesture they are waiting for activates they</span>
              <span class="s5">// should be cancelled, however `cancel` was never sent as gestures were already in the END state.</span>
              <span class="s5">// Send synthetic BEGAN -&gt; CANCELLED to properly handle JS logic</span>
              <span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">sendEvent</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED</span><span class="s1">, </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">);</span>
            <span class="s1">}</span>
            <span class="s2">otherHandler</span><span class="s1">?.</span><span class="s6">setAwaiting</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
          <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
            <span class="s2">this</span><span class="s1">.</span><span class="s6">tryActivate</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">);</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
      <span class="s1">});</span>
    <span class="s1">}</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">newState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">) {</span>
      <span class="s2">this</span><span class="s1">.</span><span class="s6">tryActivate</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE </span><span class="s0">|| </span><span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">) {</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">isActive</span><span class="s1">()) {</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s6">sendEvent</span><span class="s1">(</span><span class="s2">newState</span><span class="s1">, </span><span class="s2">oldState</span><span class="s1">);</span>
      <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
        <span class="s2">oldState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE </span><span class="s0">&amp;&amp;</span>
        <span class="s1">(</span><span class="s2">newState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED </span><span class="s0">|| </span><span class="s2">newState </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">FAILED</span><span class="s1">)</span>
      <span class="s1">) {</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s6">sendEvent</span><span class="s1">(</span><span class="s2">newState</span><span class="s1">, </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">} </span><span class="s0">else if </span><span class="s1">(</span>
      <span class="s2">oldState </span><span class="s0">!== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">UNDETERMINED </span><span class="s0">||</span>
      <span class="s2">newState </span><span class="s0">!== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED</span>
    <span class="s1">) {</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s6">sendEvent</span><span class="s1">(</span><span class="s2">newState</span><span class="s1">, </span><span class="s2">oldState</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">handlingChangeSemaphore </span><span class="s0">-= </span><span class="s4">1</span><span class="s1">;</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s6">scheduleFinishedHandlersCleanup</span><span class="s1">();</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">indexOf</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">) </span><span class="s0">&lt; </span><span class="s4">0</span><span class="s1">) {</span>
      <span class="s2">this</span><span class="s1">.</span><span class="s6">cleanupAwaitingHandlers</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">makeActive(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">const </span><span class="s1">currentState </span><span class="s0">= </span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">();</span>

    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setActive</span><span class="s1">(</span><span class="s7">true</span><span class="s1">);</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setShouldResetProgress</span><span class="s1">(</span><span class="s7">true</span><span class="s1">);</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setActivationIndex</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">activationIndex</span><span class="s0">++</span><span class="s1">);</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">otherHandler</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s5">// Order of arguments is correct - we check whether current handler should cancel existing handlers</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">shouldHandlerBeCancelledBy</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">)) {</span>
        <span class="s2">this</span><span class="s1">.</span><span class="s2">handlersToCancel</span><span class="s1">.</span><span class="s6">push</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s2">this</span><span class="s1">.</span><span class="s2">handlersToCancel</span><span class="s1">.length </span><span class="s0">- </span><span class="s4">1</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&gt;= </span><span class="s4">0</span><span class="s1">; </span><span class="s0">--</span><span class="s2">i</span><span class="s1">) {</span>
      <span class="s2">this</span><span class="s1">.</span><span class="s2">handlersToCancel</span><span class="s1">[</span><span class="s2">i</span><span class="s1">]?.</span><span class="s6">cancel</span><span class="s1">();</span>
    <span class="s1">}</span>
    <span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">otherHandler</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">shouldHandlerBeCancelledBy</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">, </span><span class="s2">handler</span><span class="s1">)) {</span>
        <span class="s2">otherHandler</span><span class="s1">?.</span><span class="s6">cancel</span><span class="s1">();</span>
        <span class="s2">otherHandler</span><span class="s1">?.</span><span class="s6">setAwaiting</span><span class="s1">(</span><span class="s7">true</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s2">handler</span><span class="s1">.</span><span class="s6">sendEvent</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">, </span><span class="s2">State</span><span class="s1">.</span><span class="s2">BEGAN</span><span class="s1">);</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">currentState </span><span class="s0">!== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">) {</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s6">sendEvent</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">, </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">);</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">currentState </span><span class="s0">!== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">) {</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s6">sendEvent</span><span class="s1">(</span><span class="s2">State</span><span class="s1">.</span><span class="s2">UNDETERMINED</span><span class="s1">, </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END</span><span class="s1">);</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">isAwaiting</span><span class="s1">()) {</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s6">setAwaiting</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
      <span class="s0">for </span><span class="s1">(</span><span class="s0">let </span><span class="s1">i </span><span class="s0">= </span><span class="s4">0</span><span class="s1">; </span><span class="s2">i </span><span class="s0">&lt; </span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.length; </span><span class="s0">++</span><span class="s2">i</span><span class="s1">) {</span>
        <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">[</span><span class="s2">i</span><span class="s1">] </span><span class="s0">=== </span><span class="s2">handler</span><span class="s1">) {</span>
          <span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">splice</span><span class="s1">(</span><span class="s2">i</span><span class="s1">, </span><span class="s4">1</span><span class="s1">);</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
    <span class="s1">}</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">handlersToCancel </span><span class="s0">= </span><span class="s1">[];</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">addAwaitingHandler(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">let </span><span class="s1">alreadyExists </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">otherHandler</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">otherHandler </span><span class="s0">=== </span><span class="s2">handler</span><span class="s1">) {</span>
        <span class="s2">alreadyExists </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>
        <span class="s0">return</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">alreadyExists</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">awaitingHandlers</span><span class="s1">.</span><span class="s6">push</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>

    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setAwaiting</span><span class="s1">(</span><span class="s7">true</span><span class="s1">);</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setActivationIndex</span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s2">activationIndex</span><span class="s0">++</span><span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">public </span><span class="s1">recordHandlerIfNotPresent(</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s0">let </span><span class="s1">alreadyExists </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">otherHandler</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">if </span><span class="s1">(</span><span class="s2">otherHandler </span><span class="s0">=== </span><span class="s2">handler</span><span class="s1">) {</span>
        <span class="s2">alreadyExists </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>
        <span class="s0">return</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s0">if </span><span class="s1">(</span><span class="s2">alreadyExists</span><span class="s1">) {</span>
      <span class="s0">return</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">push</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">);</span>

    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setActive</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setAwaiting</span><span class="s1">(</span><span class="s7">false</span><span class="s1">);</span>
    <span class="s2">handler</span><span class="s1">.</span><span class="s6">setActivationIndex</span><span class="s1">(</span><span class="s2">Number</span><span class="s1">.MAX_SAFE_INTEGER);</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">shouldHandlerWaitForOther(</span>
    <span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">,</span>
    <span class="s2">otherHandler</span><span class="s0">: </span><span class="s2">GestureHandler</span>
  <span class="s1">)</span><span class="s0">: </span><span class="s2">boolean </span><span class="s1">{</span>
    <span class="s0">return </span><span class="s1">(</span>
      <span class="s2">handler </span><span class="s0">!== </span><span class="s2">otherHandler </span><span class="s0">&amp;&amp;</span>
      <span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">shouldWaitForHandlerFailure</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">) </span><span class="s0">||</span>
        <span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">shouldRequireToWaitForFailure</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">))</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">canRunSimultaneously(</span>
    <span class="s2">gh1</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">,</span>
    <span class="s2">gh2</span><span class="s0">: </span><span class="s2">GestureHandler</span>
  <span class="s1">)</span><span class="s0">: </span><span class="s2">boolean </span><span class="s1">{</span>
    <span class="s0">return </span><span class="s1">(</span>
      <span class="s2">gh1 </span><span class="s0">=== </span><span class="s2">gh2 </span><span class="s0">||</span>
      <span class="s2">gh1</span><span class="s1">.</span><span class="s6">shouldRecognizeSimultaneously</span><span class="s1">(</span><span class="s2">gh2</span><span class="s1">) </span><span class="s0">||</span>
      <span class="s2">gh2</span><span class="s1">.</span><span class="s6">shouldRecognizeSimultaneously</span><span class="s1">(</span><span class="s2">gh1</span><span class="s1">)</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">shouldHandlerBeCancelledBy(</span>
    <span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">,</span>
    <span class="s2">otherHandler</span><span class="s0">: </span><span class="s2">GestureHandler</span>
  <span class="s1">)</span><span class="s0">: </span><span class="s2">boolean </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s2">this</span><span class="s1">.</span><span class="s6">canRunSimultaneously</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">otherHandler</span><span class="s1">)) {</span>
      <span class="s0">return </span><span class="s7">false</span><span class="s1">;</span>
    <span class="s1">}</span>

    <span class="s0">if </span><span class="s1">(</span>
      <span class="s2">handler </span><span class="s0">!== </span><span class="s2">otherHandler </span><span class="s0">&amp;&amp;</span>
      <span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">isAwaiting</span><span class="s1">() </span><span class="s0">|| </span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getState</span><span class="s1">() </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">ACTIVE</span><span class="s1">)</span>
    <span class="s1">) {</span>
      <span class="s5">// For now it always returns false</span>
      <span class="s0">return </span><span class="s2">handler</span><span class="s1">.</span><span class="s6">shouldBeCancelledByOther</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s0">const </span><span class="s1">handlerPointers</span><span class="s0">: </span><span class="s2">number</span><span class="s1">[] </span><span class="s0">= </span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getTrackedPointersID</span><span class="s1">();</span>
    <span class="s0">const </span><span class="s1">otherPointers</span><span class="s0">: </span><span class="s2">number</span><span class="s1">[] </span><span class="s0">= </span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getTrackedPointersID</span><span class="s1">();</span>

    <span class="s0">if </span><span class="s1">(</span>
      <span class="s0">!</span><span class="s2">PointerTracker</span><span class="s1">.</span><span class="s6">shareCommonPointers</span><span class="s1">(</span><span class="s2">handlerPointers</span><span class="s1">, </span><span class="s2">otherPointers</span><span class="s1">) </span><span class="s0">&amp;&amp;</span>
      <span class="s2">handler</span><span class="s1">.</span><span class="s6">getView</span><span class="s1">() </span><span class="s0">!== </span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getView</span><span class="s1">()</span>
    <span class="s1">) {</span>
      <span class="s0">return </span><span class="s2">this</span><span class="s1">.</span><span class="s6">checkOverlap</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">, </span><span class="s2">otherHandler</span><span class="s1">);</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s7">true</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">checkOverlap(</span>
    <span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">,</span>
    <span class="s2">otherHandler</span><span class="s0">: </span><span class="s2">GestureHandler</span>
  <span class="s1">)</span><span class="s0">: </span><span class="s2">boolean </span><span class="s1">{</span>
    <span class="s5">// If handlers don't have common pointers, default return value is false.</span>
    <span class="s5">// However, if at least on pointer overlaps with both handlers, we return true</span>
    <span class="s5">// This solves issue in overlapping parents example</span>

    <span class="s5">// TODO: Find better way to handle that issue, for example by activation order and handler cancelling</span>

    <span class="s0">const </span><span class="s1">handlerPointers</span><span class="s0">: </span><span class="s2">number</span><span class="s1">[] </span><span class="s0">= </span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getTrackedPointersID</span><span class="s1">();</span>
    <span class="s0">const </span><span class="s1">otherPointers</span><span class="s0">: </span><span class="s2">number</span><span class="s1">[] </span><span class="s0">= </span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getTrackedPointersID</span><span class="s1">();</span>

    <span class="s0">let </span><span class="s1">overlap </span><span class="s0">= </span><span class="s7">false</span><span class="s1">;</span>

    <span class="s2">handlerPointers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">pointer</span><span class="s0">: </span><span class="s2">number</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">const </span><span class="s1">handlerX</span><span class="s0">: </span><span class="s2">number </span><span class="s0">= </span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getTracker</span><span class="s1">().</span><span class="s6">getLastX</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">);</span>
      <span class="s0">const </span><span class="s1">handlerY</span><span class="s0">: </span><span class="s2">number </span><span class="s0">= </span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getTracker</span><span class="s1">().</span><span class="s6">getLastY</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">);</span>

      <span class="s0">if </span><span class="s1">(</span>
        <span class="s6">isPointerInBounds</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getView</span><span class="s1">(), { x: </span><span class="s2">handlerX</span><span class="s1">, y: </span><span class="s2">handlerY </span><span class="s1">}) </span><span class="s0">&amp;&amp;</span>
        <span class="s6">isPointerInBounds</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getView</span><span class="s1">(), { x: </span><span class="s2">handlerX</span><span class="s1">, y: </span><span class="s2">handlerY </span><span class="s1">})</span>
      <span class="s1">) {</span>
        <span class="s2">overlap </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s2">otherPointers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">pointer</span><span class="s0">: </span><span class="s2">number</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">const </span><span class="s1">otherX</span><span class="s0">: </span><span class="s2">number </span><span class="s0">= </span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getTracker</span><span class="s1">().</span><span class="s6">getLastX</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">);</span>
      <span class="s0">const </span><span class="s1">otherY</span><span class="s0">: </span><span class="s2">number </span><span class="s0">= </span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getTracker</span><span class="s1">().</span><span class="s6">getLastY</span><span class="s1">(</span><span class="s2">pointer</span><span class="s1">);</span>

      <span class="s0">if </span><span class="s1">(</span>
        <span class="s6">isPointerInBounds</span><span class="s1">(</span><span class="s2">handler</span><span class="s1">.</span><span class="s6">getView</span><span class="s1">(), { x: </span><span class="s2">otherX</span><span class="s1">, y: </span><span class="s2">otherY </span><span class="s1">}) </span><span class="s0">&amp;&amp;</span>
        <span class="s6">isPointerInBounds</span><span class="s1">(</span><span class="s2">otherHandler</span><span class="s1">.</span><span class="s6">getView</span><span class="s1">(), { x: </span><span class="s2">otherX</span><span class="s1">, y: </span><span class="s2">otherY </span><span class="s1">})</span>
      <span class="s1">) {</span>
        <span class="s2">overlap </span><span class="s0">= </span><span class="s7">true</span><span class="s1">;</span>
      <span class="s1">}</span>
    <span class="s1">});</span>

    <span class="s0">return </span><span class="s2">overlap</span><span class="s1">;</span>
  <span class="s1">}</span>

  <span class="s0">private </span><span class="s1">isFinished(</span><span class="s2">state</span><span class="s0">: </span><span class="s2">State</span><span class="s1">)</span><span class="s0">: </span><span class="s2">boolean </span><span class="s1">{</span>
    <span class="s0">return </span><span class="s1">(</span>
      <span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">END </span><span class="s0">|| </span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">FAILED </span><span class="s0">|| </span><span class="s2">state </span><span class="s0">=== </span><span class="s2">State</span><span class="s1">.</span><span class="s2">CANCELLED</span>
    <span class="s1">);</span>
  <span class="s1">}</span>

  <span class="s5">// This function is called when handler receives touchdown event</span>
  <span class="s5">// If handler is using mouse or pen as a pointer and any handler receives touch event,</span>
  <span class="s5">// mouse/pen event dissappears - it doesn't send onPointerCancel nor onPointerUp (and others)</span>
  <span class="s5">// This became a problem because handler was left at active state without any signal to end or fail</span>
  <span class="s5">// To handle this, when new touch event is received, we loop through active handlers and check which type of</span>
  <span class="s5">// pointer they're using. If there are any handler with mouse/pen as a pointer, we cancel them</span>
  <span class="s0">public </span><span class="s1">cancelMouseAndPenGestures(</span><span class="s2">currentHandler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">)</span><span class="s0">: </span><span class="s2">void </span><span class="s1">{</span>
    <span class="s2">this</span><span class="s1">.</span><span class="s2">gestureHandlers</span><span class="s1">.</span><span class="s6">forEach</span><span class="s1">((</span><span class="s2">handler</span><span class="s0">: </span><span class="s2">GestureHandler</span><span class="s1">) </span><span class="s0">=&gt; </span><span class="s1">{</span>
      <span class="s0">if </span><span class="s1">(</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s6">getPointerType</span><span class="s1">() </span><span class="s0">!== </span><span class="s2">PointerType</span><span class="s1">.</span><span class="s2">MOUSE </span><span class="s0">&amp;&amp;</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s6">getPointerType</span><span class="s1">() </span><span class="s0">!== </span><span class="s2">PointerType</span><span class="s1">.</span><span class="s2">PEN</span>
      <span class="s1">) {</span>
        <span class="s0">return</span><span class="s1">;</span>
      <span class="s1">}</span>

      <span class="s0">if </span><span class="s1">(</span><span class="s2">handler </span><span class="s0">!== </span><span class="s2">currentHandler</span><span class="s1">) {</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s6">cancel</span><span class="s1">();</span>
      <span class="s1">} </span><span class="s0">else </span><span class="s1">{</span>
        <span class="s5">// Handler that received touch event should have its pointer tracker reset</span>
        <span class="s5">// This allows handler to smoothly change from mouse/pen to touch</span>
        <span class="s5">// The drawback is, that when we try to use mouse/pen one more time, it doesn't send onPointerDown at the first time</span>
        <span class="s5">// so it is required to click two times to get handler to work</span>
        <span class="s5">//</span>
        <span class="s5">// However, handler will receive manually created onPointerEnter that is triggered in EventManager in onPointerMove method.</span>
        <span class="s5">// There may be possibility to use that fact to make handler respond properly to first mouse click</span>
        <span class="s2">handler</span><span class="s1">.</span><span class="s6">getTracker</span><span class="s1">().</span><span class="s6">resetTracker</span><span class="s1">();</span>
      <span class="s1">}</span>
    <span class="s1">});</span>
  <span class="s1">}</span>

  <span class="s0">public static </span><span class="s1">getInstance()</span><span class="s0">: </span><span class="s2">GestureHandlerOrchestrator </span><span class="s1">{</span>
    <span class="s0">if </span><span class="s1">(</span><span class="s0">!</span><span class="s2">GestureHandlerOrchestrator</span><span class="s1">.</span><span class="s2">instance</span><span class="s1">) {</span>
      <span class="s2">GestureHandlerOrchestrator</span><span class="s1">.</span><span class="s2">instance </span><span class="s0">= new </span><span class="s6">GestureHandlerOrchestrator</span><span class="s1">();</span>
    <span class="s1">}</span>

    <span class="s0">return </span><span class="s2">GestureHandlerOrchestrator</span><span class="s1">.</span><span class="s2">instance</span><span class="s1">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>
</pre>
</body>
</html>