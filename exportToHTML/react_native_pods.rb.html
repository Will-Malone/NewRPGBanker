<html>
<head>
<title>react_native_pods.rb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #a9b7c6;}
.s5 { color: #ffc66d;}
.s6 { color: #9876aa; font-style: italic;}
.s7 { color: #cc7832; font-style: italic;}
.s8 { color: #6897bb; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
react_native_pods.rb</font>
</center></td></tr></table>
<pre><span class="s0"># Copyright (c) Meta Platforms, Inc. and affiliates.</span>
<span class="s0">#</span>
<span class="s0"># This source code is licensed under the MIT license found in the</span>
<span class="s0"># LICENSE file in the root directory of this source tree.</span>

<span class="s2">require </span><span class="s3">'json'</span>
<span class="s2">require </span><span class="s3">'open3'</span>
<span class="s2">require </span><span class="s3">'pathname'</span>
<span class="s2">require_relative </span><span class="s3">'./react_native_pods_utils/script_phases.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/jsengine.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/flipper.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/fabric.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/codegen.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/codegen_utils.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/utils.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/new_architecture.rb'</span>
<span class="s2">require_relative </span><span class="s3">'./cocoapods/local_podspec_patch.rb'</span>

<span class="s4">$CODEGEN_OUTPUT_DIR </span><span class="s2">= </span><span class="s3">'build/generated/ios'</span>
<span class="s4">$CODEGEN_COMPONENT_DIR </span><span class="s2">= </span><span class="s3">'react/renderer/components'</span>
<span class="s4">$CODEGEN_MODULE_DIR </span><span class="s2">= </span><span class="s3">'.'</span>
<span class="s4">$FOLLY_VERSION </span><span class="s2">= </span><span class="s3">'2021.07.22.00'</span>

<span class="s4">$START_TIME </span><span class="s2">= </span><span class="s1">Time.now.to_i 
</span>
<span class="s0"># `@react-native-community/cli-platform-ios/native_modules` defines</span>
<span class="s0"># use_native_modules. We use node to resolve its path to allow for</span>
<span class="s0"># different packager and workspace setups. This is reliant on</span>
<span class="s0"># `@react-native-community/cli-platform-ios` being a direct dependency</span>
<span class="s0"># of `react-native`.</span>
<span class="s2">require </span><span class="s1">Pod::Executable.execute_command(</span><span class="s3">'node'</span><span class="s1">, [</span><span class="s3">'-p'</span><span class="s1">,</span>
  <span class="s3">'require.resolve( 
    &quot;@react-native-community/cli-platform-ios/native_modules.rb&quot;, 
    {paths: [process.argv[1]]}, 
  )'</span><span class="s1">, </span><span class="s4">__dir__</span><span class="s1">]).strip 
</span>
<span class="s0"># This function returns the min iOS version supported by React Native</span>
<span class="s0"># By using this function, you won't have to manually change your Podfile</span>
<span class="s0"># when we change the minimum version supported by the framework.</span>
<span class="s2">def </span><span class="s5">min_ios_version_supported</span>
  <span class="s2">return </span><span class="s3">'12.4'</span>
<span class="s2">end</span>

<span class="s0"># This function prepares the project for React Native, before processing</span>
<span class="s0"># all the target exposed by the framework.</span>
<span class="s2">def </span><span class="s5">prepare_react_native_project!</span>
  <span class="s0"># Temporary solution to suppress duplicated GUID error.</span>
  <span class="s0"># Can be removed once we move to generate files outside pod install.</span>
  <span class="s1">install! </span><span class="s3">'cocoapods'</span><span class="s1">, </span><span class="s6">:deterministic_uuids </span><span class="s1">=&gt; </span><span class="s6">false</span>

  <span class="s1">ReactNativePodsUtils.create_xcode_env_if_missing 
</span><span class="s2">end</span>

<span class="s0"># Function that setup all the react native dependencies</span>
<span class="s0"># </span>
<span class="s0"># Parameters</span>
<span class="s0"># - path: path to react_native installation.</span>
<span class="s0"># - fabric_enabled: whether fabric should be enabled or not.</span>
<span class="s0"># - new_arch_enabled: whether the new architecture should be enabled or not.</span>
<span class="s0"># - production: whether the dependencies must be installed to target a Debug or a Release build.</span>
<span class="s0"># - hermes_enabled: whether Hermes should be enabled or not.</span>
<span class="s0"># - flipper_configuration: The configuration to use for flipper.</span>
<span class="s0"># - app_path: path to the React Native app. Required by the New Architecture.</span>
<span class="s0"># - config_file_dir: directory of the `package.json` file, required by the New Architecture.</span>
<span class="s0"># - ios_folder: the folder where the iOS code base lives. For a template app, it is `ios`, the default. For RNTester, it is `.`.</span>
<span class="s2">def </span><span class="s5">use_react_native! </span><span class="s1">(</span>
  <span class="s6">path: </span><span class="s3">&quot;../node_modules/react-native&quot;</span><span class="s1">, 
  </span><span class="s6">fabric_enabled: false</span><span class="s1">, 
  </span><span class="s6">new_arch_enabled: </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">== </span><span class="s3">'1'</span><span class="s1">, 
  </span><span class="s6">production: </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'PRODUCTION'</span><span class="s1">] </span><span class="s2">== </span><span class="s3">'1'</span><span class="s1">, 
  </span><span class="s6">hermes_enabled: </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_HERMES'</span><span class="s1">] </span><span class="s2">&amp;&amp; </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_HERMES'</span><span class="s1">] </span><span class="s2">== </span><span class="s3">'0' </span><span class="s2">? </span><span class="s6">false </span><span class="s1">: </span><span class="s6">true</span><span class="s1">, 
  </span><span class="s6">flipper_configuration: </span><span class="s1">FlipperConfiguration.</span><span class="s4">disabled</span><span class="s1">, 
  </span><span class="s6">app_path: </span><span class="s3">'..'</span><span class="s1">, 
  </span><span class="s6">config_file_dir: </span><span class="s3">''</span><span class="s1">, 
  </span><span class="s6">ios_folder: </span><span class="s3">'ios'</span>
<span class="s1">) 
</span>
  <span class="s1"># </span><span class="s4">Set </span><span class="s1">the app_path as env variable so the podspecs can access it.</span>
  <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'APP_PATH'</span><span class="s1">] </span><span class="s2">= </span><span class="s1">app_path 
  </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'REACT_NATIVE_PATH'</span><span class="s1">] </span><span class="s2">= </span><span class="s1">path 
</span>
  <span class="s0"># Current target definition is provided by Cocoapods and it refers to the target</span>
  <span class="s0"># that has invoked the `use_react_native!` function.</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">detect_use_frameworks</span><span class="s1">(current_target_definition)</span>

  <span class="s1">CodegenUtils.</span><span class="s4">clean_up_build_folder</span><span class="s1">(path, app_path, ios_folder, </span><span class="s4">$CODEGEN_OUTPUT_DIR</span><span class="s1">)</span>

  <span class="s0"># We are relying on this flag also in third parties libraries to proper install dependencies.</span>
  <span class="s0"># Better to rely and enable this environment flag if the new architecture is turned on using flags.</span>
  <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">= </span><span class="s1">new_arch_enabled </span><span class="s2">? </span><span class="s3">&quot;1&quot; </span><span class="s1">: </span><span class="s3">&quot;0&quot;</span>
  <span class="s1">fabric_enabled </span><span class="s2">= </span><span class="s1">fabric_enabled </span><span class="s2">|| </span><span class="s1">new_arch_enabled 
  </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_FABRIC_ENABLED'</span><span class="s1">] </span><span class="s2">= </span><span class="s1">fabric_enabled </span><span class="s2">? </span><span class="s3">&quot;1&quot; </span><span class="s1">: </span><span class="s3">&quot;0&quot;</span>
  <span class="s4">ENV</span><span class="s1">[</span><span class="s3">'USE_HERMES'</span><span class="s1">] </span><span class="s2">= </span><span class="s1">hermes_enabled </span><span class="s2">? </span><span class="s3">&quot;1&quot; </span><span class="s1">: </span><span class="s3">&quot;0&quot;</span>

  <span class="s1">prefix </span><span class="s2">= </span><span class="s1">path 
</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">warn_if_not_on_arm64</span><span class="s1">()</span>

  <span class="s0"># The Pods which should be included in all projects</span>
  <span class="s1">pod </span><span class="s3">'FBLazyVector'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/FBLazyVector&quot;</span>
  <span class="s1">pod </span><span class="s3">'FBReactNativeSpec'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/React/FBReactNativeSpec&quot; </span><span class="s2">if !</span><span class="s4">new_arch_enabled</span>
  <span class="s1">pod </span><span class="s3">'RCTRequired'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/RCTRequired&quot;</span>
  <span class="s1">pod </span><span class="s3">'RCTTypeSafety'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/TypeSafety&quot;</span><span class="s1">, :</span><span class="s4">modular_headers </span><span class="s1">=&gt; </span><span class="s6">true</span>
  <span class="s1">pod </span><span class="s3">'React'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-Core'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-CoreModules'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/React/CoreModules&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTAppDelegate'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/AppDelegate&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTActionSheet'</span><span class="s1">, :path =&gt; &quot;#{prefix}/Libraries/ActionSheetIOS&quot; 
  </span><span class="s4">pod </span><span class="s3">'React-RCTAnimation'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/NativeAnimation&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTBlob'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/Blob&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTImage'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/Image&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTLinking'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/LinkingIOS&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTNetwork'</span><span class="s1">, :path =&gt; &quot;#{prefix}/Libraries/Network&quot; 
  </span><span class="s4">pod </span><span class="s3">'React-RCTSettings'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/Settings&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTText'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/Text&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-RCTVibration'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/Libraries/Vibration&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-Core/RCTWebSocket'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-rncore'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-cxxreact'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/cxxreact&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-debug'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/react/debug&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-utils'</span><span class="s1">, :path =&gt; &quot;#{prefix}/ReactCommon/react/utils&quot; 
</span>
  <span class="s4">if </span><span class="s1">hermes_enabled 
    setup_hermes!(</span><span class="s6">:react_native_path </span><span class="s1">=&gt; prefix, </span><span class="s6">:fabric_enabled </span><span class="s1">=&gt; fabric_enabled)</span>
  <span class="s2">else</span>
    <span class="s1">setup_jsc!(</span><span class="s6">:react_native_path </span><span class="s1">=&gt; prefix, </span><span class="s6">:fabric_enabled </span><span class="s1">=&gt; fabric_enabled)</span>
  <span class="s2">end</span>

  <span class="s1">pod </span><span class="s3">'React-jsiexecutor'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/jsiexecutor&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-jsinspector'</span><span class="s1">, :path =&gt; &quot;#{prefix}/ReactCommon/jsinspector&quot; 
</span>
  <span class="s4">pod </span><span class="s3">'React-callinvoker'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/callinvoker&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-runtimeexecutor'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/runtimeexecutor&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-runtimescheduler'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/react/renderer/runtimescheduler&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-perflogger'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/reactperflogger&quot;</span>
  <span class="s1">pod </span><span class="s3">'React-logger'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/logger&quot;</span>
  <span class="s1">pod </span><span class="s3">'ReactCommon/turbomodule/core'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon&quot;</span><span class="s1">, :</span><span class="s4">modular_headers </span><span class="s1">=&gt; </span><span class="s6">true</span>
  <span class="s1">pod </span><span class="s3">'React-NativeModulesApple'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/react/nativemodule/core/platform/ios&quot;</span><span class="s1">, :</span><span class="s4">modular_headers </span><span class="s1">=&gt; </span><span class="s6">true</span>
  <span class="s1">pod </span><span class="s3">'Yoga'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/ReactCommon/yoga&quot;</span><span class="s1">, :</span><span class="s4">modular_headers </span><span class="s1">=&gt; </span><span class="s6">true</span>

  <span class="s1">pod </span><span class="s3">'DoubleConversion'</span><span class="s1">, :</span><span class="s4">podspec </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/third-party-podspecs/DoubleConversion.podspec&quot;</span>
  <span class="s1">pod </span><span class="s3">'glog'</span><span class="s1">, :</span><span class="s4">podspec </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/third-party-podspecs/glog.podspec&quot;</span>
  <span class="s1">pod </span><span class="s3">'boost'</span><span class="s1">, :</span><span class="s4">podspec </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/third-party-podspecs/boost.podspec&quot;</span>
  <span class="s1">pod </span><span class="s3">'RCT-Folly'</span><span class="s1">, :</span><span class="s4">podspec </span><span class="s1">=&gt; </span><span class="s3">&quot;#{prefix}/third-party-podspecs/RCT-Folly.podspec&quot;</span><span class="s1">, :</span><span class="s4">modular_headers </span><span class="s1">=&gt; </span><span class="s6">true</span>

  <span class="s1">run_codegen!(</span>
    <span class="s1">app_path,</span>
    <span class="s1">config_file_dir,</span>
    <span class="s6">:new_arch_enabled </span><span class="s1">=&gt; new_arch_enabled,</span>
    <span class="s6">:disable_codegen </span><span class="s1">=&gt; </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'DISABLE_CODEGEN'</span><span class="s1">] </span><span class="s2">== </span><span class="s3">'1'</span><span class="s1">,</span>
    <span class="s6">:react_native_path </span><span class="s1">=&gt; prefix,</span>
    <span class="s6">:fabric_enabled </span><span class="s1">=&gt; fabric_enabled,</span>
    <span class="s6">:hermes_enabled </span><span class="s1">=&gt; hermes_enabled,</span>
    <span class="s6">:codegen_output_dir </span><span class="s1">=&gt; </span><span class="s4">$CODEGEN_OUTPUT_DIR</span><span class="s1">,</span>
    <span class="s6">:package_json_file </span><span class="s1">=&gt; File.join(</span><span class="s4">__dir__</span><span class="s1">, </span><span class="s3">&quot;..&quot;</span><span class="s1">, </span><span class="s3">&quot;package.json&quot;</span><span class="s1">),</span>
    <span class="s6">:folly_version </span><span class="s1">=&gt; </span><span class="s4">$FOLLY_VERSION</span>
  <span class="s1">)</span>

  <span class="s1">pod </span><span class="s3">'React-Codegen'</span><span class="s1">, :</span><span class="s4">path </span><span class="s1">=&gt; </span><span class="s4">$CODEGEN_OUTPUT_DIR</span><span class="s1">, :</span><span class="s4">modular_headers </span><span class="s1">=&gt; </span><span class="s6">true</span>

  <span class="s2">if </span><span class="s1">fabric_enabled 
    checkAndGenerateEmptyThirdPartyProvider!(prefix, new_arch_enabled)</span>
    <span class="s1">setup_fabric!(</span><span class="s6">:react_native_path </span><span class="s1">=&gt; prefix, </span><span class="s6">new_arch_enabled: </span><span class="s1">new_arch_enabled)</span>
  <span class="s2">else</span>
    <span class="s1">relative_installation_root </span><span class="s2">= </span><span class="s1">Pod::</span><span class="s4">Config</span><span class="s1">.</span><span class="s4">instance</span><span class="s1">.</span><span class="s4">installation_root</span><span class="s1">.</span><span class="s4">relative_path_from</span><span class="s1">(Pathname.pwd)</span>
    <span class="s1">build_codegen!(prefix, relative_installation_root)</span>
  <span class="s2">end</span>

  <span class="s0"># CocoaPods `configurations` option ensures that the target is copied only for the specified configurations,</span>
  <span class="s0"># but those dependencies are still built.</span>
  <span class="s0"># Flipper doesn't currently compile for release https://github.com/facebook/react-native/issues/33764</span>
  <span class="s0"># Setting the production flag to true when build for production make sure that we don't install Flipper in the app in the first place.</span>
  <span class="s2">if </span><span class="s1">flipper_configuration.</span><span class="s4">flipper_enabled </span><span class="s2">&amp;&amp; !</span><span class="s4">production</span>
    <span class="s1">install_flipper_dependencies(prefix)</span>
    <span class="s1">use_flipper_pods(flipper_configuration.versions, </span><span class="s6">:configurations </span><span class="s1">=&gt; flipper_configuration.configurations)</span>
  <span class="s2">end</span>

  <span class="s1">pods_to_update </span><span class="s2">= </span><span class="s1">LocalPodspecPatch.</span><span class="s4">pods_to_update</span><span class="s1">(</span><span class="s6">:react_native_path </span><span class="s1">=&gt; prefix)</span>
  <span class="s2">if !</span><span class="s4">pods_to_update</span><span class="s1">.</span><span class="s4">empty</span><span class="s1">? 
    </span><span class="s2">if </span><span class="s1">Pod::</span><span class="s4">Lockfile</span><span class="s1">.</span><span class="s4">public_instance_methods</span><span class="s1">.</span><span class="s4">include</span><span class="s1">?(</span><span class="s6">:detect_changes_with_podfile</span><span class="s1">)</span>
      <span class="s1">Pod::</span><span class="s4">Lockfile</span><span class="s1">.</span><span class="s4">prepend</span><span class="s1">(</span><span class="s4">LocalPodspecPatch</span><span class="s1">)</span>
    <span class="s2">else</span>
      <span class="s1">Pod::</span><span class="s4">UI</span><span class="s1">.</span><span class="s4">warn </span><span class="s3">&quot;Automatically updating #{pods_to_update.join(&quot;, &quot;)} has failed, please run `pod update #{pods_to_update.join(&quot; &quot;)} --no-repo-update` manually to fix the issue.&quot;</span>
    <span class="s2">end</span>
  <span class="s2">end</span>
<span class="s4">end</span>

<span class="s0"># Getter to retrieve the folly flags in case contributors need to apply them manually.</span>
<span class="s0">#</span>
<span class="s0"># Returns: the folly compiler flags</span>
<span class="s4">def </span><span class="s1">folly_flags()</span>
  <span class="s2">return </span><span class="s1">NewArchitectureHelper.</span><span class="s4">folly_compiler_flags</span>
<span class="s4">end</span>

<span class="s0"># This function can be used by library developer to prepare their modules for the New Architecture.</span>
<span class="s0"># It passes the Folly Flags to the module, it configures the search path and installs some New Architecture specific dependencies.</span>
<span class="s0">#</span>
<span class="s0"># Parameters:</span>
<span class="s0"># - spec: The spec that has to be configured with the New Architecture code</span>
<span class="s0"># - new_arch_enabled: Whether the module should install dependencies for the new architecture</span>
<span class="s4">def </span><span class="s1">install_modules_dependencies(spec, </span><span class="s6">new_arch_enabled: </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">== </span><span class="s3">&quot;1&quot;</span><span class="s1">)</span>
  <span class="s1">NewArchitectureHelper.</span><span class="s4">install_modules_dependencies</span><span class="s1">(spec, new_arch_enabled, </span><span class="s4">$FOLLY_VERSION</span><span class="s1">)</span>
<span class="s4">end</span>

<span class="s0"># It returns the default flags.</span>
<span class="s4">def </span><span class="s1">get_default_flags()</span>
  <span class="s2">return </span><span class="s1">ReactNativePodsUtils.</span><span class="s4">get_default_flags</span><span class="s1">()</span>
<span class="s4">end</span>

<span class="s0"># It installs the flipper dependencies into the project.</span>
<span class="s0">#</span>
<span class="s0"># Parameters</span>
<span class="s0"># - versions: a dictionary of Flipper Library -&gt; Versions that can be used to customize which version of Flipper to install.</span>
<span class="s0"># - configurations: an array of configuration where to install the dependencies.</span>
<span class="s4">def </span><span class="s1">use_flipper!(versions </span><span class="s2">= </span><span class="s1">{}, </span><span class="s6">configurations: </span><span class="s1">[</span><span class="s3">'Debug'</span><span class="s1">])</span>
  <span class="s1">Pod::</span><span class="s4">UI</span><span class="s1">.</span><span class="s4">warn </span><span class="s3">&quot;use_flipper is deprecated, use the flipper_configuration option in the use_react_native function&quot;</span>
  <span class="s1">use_flipper_pods(versions, </span><span class="s6">:configurations </span><span class="s1">=&gt; configurations)</span>
<span class="s4">end</span>

<span class="s0"># Function that executes after React Native has been installed to configure some flags and build settings.</span>
<span class="s0">#</span>
<span class="s0"># Parameters</span>
<span class="s0"># - installer: the Cocoapod object that allows to customize the project.</span>
<span class="s0"># - react_native_path: path to React Native.</span>
<span class="s0"># - mac_catalyst_enabled: whether we are running the Pod on a Mac Catalyst project or not.</span>
<span class="s0"># - enable_hermes_profiler: whether the hermes profiler should be turned on in Release mode</span>
<span class="s4">def </span><span class="s1">react_native_post_install(</span>
  <span class="s1">installer,</span>
  <span class="s1">react_native_path </span><span class="s2">= </span><span class="s3">&quot;../node_modules/react-native&quot;</span><span class="s1">,</span>
  <span class="s6">mac_catalyst_enabled: false</span>
<span class="s1">)</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">turn_off_resource_bundle_react_core</span><span class="s1">(installer)</span>

  <span class="s1">ReactNativePodsUtils.</span><span class="s4">apply_mac_catalyst_patches</span><span class="s1">(installer) </span><span class="s2">if </span><span class="s1">mac_catalyst_enabled 
</span>
  <span class="s2">if </span><span class="s1">ReactNativePodsUtils.</span><span class="s4">has_pod</span><span class="s1">(installer, </span><span class="s3">'Flipper'</span><span class="s1">)</span>
    <span class="s1">flipper_post_install(installer)</span>
  <span class="s2">end</span>

  <span class="s1">fabric_enabled </span><span class="s2">= </span><span class="s1">ReactNativePodsUtils.</span><span class="s4">has_pod</span><span class="s1">(installer, </span><span class="s3">'React-Fabric'</span><span class="s1">)</span>

  <span class="s1">ReactNativePodsUtils.</span><span class="s4">exclude_i386_architecture_while_using_hermes</span><span class="s1">(installer)</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">fix_library_search_paths</span><span class="s1">(installer)</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">update_search_paths</span><span class="s1">(installer)</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">set_node_modules_user_settings</span><span class="s1">(installer, react_native_path)</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">apply_flags_for_fabric</span><span class="s1">(installer, </span><span class="s6">fabric_enabled: </span><span class="s1">fabric_enabled)</span>
  <span class="s1">ReactNativePodsUtils.</span><span class="s4">apply_xcode_15_patch</span><span class="s1">(installer)</span>

  <span class="s1">NewArchitectureHelper.</span><span class="s4">set_clang_cxx_language_standard_if_needed</span><span class="s1">(installer)</span>
  <span class="s1">is_new_arch_enabled </span><span class="s2">= </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">== </span><span class="s3">&quot;1&quot;</span>
  <span class="s1">NewArchitectureHelper.</span><span class="s4">modify_flags_for_new_architecture</span><span class="s1">(installer, is_new_arch_enabled)</span>

  <span class="s1">Pod::</span><span class="s4">UI</span><span class="s1">.</span><span class="s4">puts </span><span class="s3">&quot;Pod install took #{Time.now.to_i </span><span class="s2">- </span><span class="s4">$START_TIME</span><span class="s3">} [s] to run&quot;</span><span class="s1">.</span><span class="s4">green</span>
<span class="s4">end</span>

<span class="s0"># === LEGACY METHOD ===</span>
<span class="s0"># We need to keep this while we continue to support the old architecture.</span>
<span class="s0"># =====================</span>
<span class="s4">def </span><span class="s1">use_react_native_codegen!(spec, options</span><span class="s2">=</span><span class="s1">{})</span>
  <span class="s2">return if </span><span class="s4">ENV</span><span class="s1">[</span><span class="s3">'RCT_NEW_ARCH_ENABLED'</span><span class="s1">] </span><span class="s2">== </span><span class="s3">&quot;1&quot;</span>
  <span class="s0"># TODO: Once the new codegen approach is ready for use, we should output a warning here to let folks know to migrate.</span>

  <span class="s0"># The prefix to react-native</span>
  <span class="s1">react_native_path </span><span class="s2">= </span><span class="s1">options[</span><span class="s6">:react_native_path</span><span class="s1">] </span><span class="s2">||= </span><span class="s3">&quot;..&quot;</span>

  <span class="s0"># Library name (e.g. FBReactNativeSpec)</span>
  <span class="s1">library_name </span><span class="s2">= </span><span class="s1">options[</span><span class="s6">:library_name</span><span class="s1">] </span><span class="s2">||= </span><span class="s3">&quot;#{spec.name.gsub('_','-').split('-').collect(</span><span class="s2">&amp;</span><span class="s6">:capitalize</span><span class="s3">).join}Spec&quot;</span>
  <span class="s1">Pod::</span><span class="s4">UI</span><span class="s1">.</span><span class="s4">puts </span><span class="s3">&quot;[Codegen] Found #{library_name}&quot;</span>

  <span class="s1">relative_installation_root </span><span class="s2">= </span><span class="s1">Pod::</span><span class="s4">Config</span><span class="s1">.</span><span class="s4">instance</span><span class="s1">.</span><span class="s4">installation_root</span><span class="s1">.</span><span class="s4">relative_path_from</span><span class="s1">(Pathname.pwd)</span>
  <span class="s1">output_dir </span><span class="s2">= </span><span class="s1">options[</span><span class="s6">:output_dir</span><span class="s1">] </span><span class="s2">||= </span><span class="s4">$CODEGEN_OUTPUT_DIR</span>
  <span class="s1">output_dir_module </span><span class="s2">= </span><span class="s3">&quot;#{output_dir}/#{</span><span class="s4">$CODEGEN_MODULE_DIR</span><span class="s3">}&quot;</span>
  <span class="s1">output_dir_component </span><span class="s2">= </span><span class="s3">&quot;#{output_dir}/#{</span><span class="s4">$CODEGEN_COMPONENT_DIR</span><span class="s3">}&quot;</span>

  <span class="s1">codegen_config </span><span class="s2">= </span><span class="s1">{</span>
    <span class="s3">&quot;modules&quot; </span><span class="s1">=&gt; {</span>
      <span class="s6">:js_srcs_pattern </span><span class="s1">=&gt; </span><span class="s3">&quot;Native*.js&quot;</span><span class="s1">,</span>
      <span class="s6">:generated_dir </span><span class="s1">=&gt; </span><span class="s3">&quot;#{relative_installation_root}/#{output_dir_module}/#{library_name}&quot;</span><span class="s1">,</span>
      <span class="s6">:generated_files </span><span class="s1">=&gt; [</span>
        <span class="s3">&quot;#{library_name}.h&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;#{library_name}-generated.mm&quot;</span>
      <span class="s1">]</span>
    <span class="s1">},</span>
    <span class="s3">&quot;components&quot; </span><span class="s1">=&gt; {</span>
      <span class="s6">:js_srcs_pattern </span><span class="s1">=&gt; </span><span class="s3">&quot;*NativeComponent.js&quot;</span><span class="s1">,</span>
      <span class="s6">:generated_dir </span><span class="s1">=&gt; </span><span class="s3">&quot;#{relative_installation_root}/#{output_dir_component}/#{library_name}&quot;</span><span class="s1">,</span>
      <span class="s6">:generated_files </span><span class="s1">=&gt; [</span>
        <span class="s3">&quot;ComponentDescriptors.h&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;EventEmitters.cpp&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;EventEmitters.h&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;Props.cpp&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;Props.h&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;States.cpp&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;States.h&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;RCTComponentViewHelpers.h&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;ShadowNodes.cpp&quot;</span><span class="s1">,</span>
        <span class="s3">&quot;ShadowNodes.h&quot;</span>
      <span class="s1">]</span>
    <span class="s1">}</span>
  <span class="s1">}</span>

  <span class="s0"># The path to JavaScript files</span>
  <span class="s1">js_srcs_dir </span><span class="s2">= </span><span class="s1">options[</span><span class="s6">:js_srcs_dir</span><span class="s1">] </span><span class="s2">||= </span><span class="s3">&quot;./&quot;</span>
  <span class="s1">library_type </span><span class="s2">= </span><span class="s1">options[</span><span class="s6">:library_type</span><span class="s1">]</span>

  <span class="s2">if </span><span class="s1">library_type 
    </span><span class="s2">if !</span><span class="s4">codegen_config</span><span class="s1">[</span><span class="s4">library_type</span><span class="s1">]</span>
      <span class="s2">raise </span><span class="s3">&quot;[Codegen] invalid library_type: #{library_type}. Check your podspec to make sure it's set to 'modules' or 'components'. Removing the option will generate files for both&quot;</span>
    <span class="s2">end</span>
    <span class="s1">js_srcs_pattern </span><span class="s2">= </span><span class="s1">codegen_config[</span><span class="s4">library_type</span><span class="s1">][</span><span class="s6">:js_srcs_pattern</span><span class="s1">]</span>
  <span class="s2">end</span>

  <span class="s2">if </span><span class="s1">library_type 
    generated_dirs </span><span class="s2">= </span><span class="s1">[ codegen_config[</span><span class="s4">library_type</span><span class="s1">][</span><span class="s6">:generated_dir</span><span class="s1">] ]</span>
    <span class="s1">generated_files </span><span class="s2">= </span><span class="s1">codegen_config[</span><span class="s4">library_type</span><span class="s1">][</span><span class="s6">:generated_files</span><span class="s1">].</span><span class="s4">map </span><span class="s1">{ |</span><span class="s4">filename</span><span class="s1">| </span><span class="s3">&quot;#{codegen_config[library_type][</span><span class="s6">:generated_dir</span><span class="s3">]}/#{filename}&quot; </span><span class="s1">}</span>
  <span class="s2">else</span>
    <span class="s1">generated_dirs </span><span class="s2">= </span><span class="s1">[ codegen_config[</span><span class="s3">&quot;modules&quot;</span><span class="s1">][</span><span class="s6">:generated_dir</span><span class="s1">], </span><span class="s4">codegen_config</span><span class="s1">[</span><span class="s3">&quot;components&quot;</span><span class="s1">][</span><span class="s6">:generated_dir</span><span class="s1">] ]</span>
    <span class="s1">generated_files </span><span class="s2">= </span><span class="s1">codegen_config[</span><span class="s3">&quot;modules&quot;</span><span class="s1">][</span><span class="s6">:generated_files</span><span class="s1">].</span><span class="s4">map </span><span class="s1">{ |</span><span class="s4">filename</span><span class="s1">| </span><span class="s3">&quot;#{codegen_config[&quot;modules&quot;][</span><span class="s6">:generated_dir</span><span class="s3">]}/#{filename}&quot; </span><span class="s1">}</span>
    <span class="s1">generated_files </span><span class="s2">= </span><span class="s1">generated_files.</span><span class="s4">concat</span><span class="s1">(codegen_config[</span><span class="s3">&quot;components&quot;</span><span class="s1">][</span><span class="s6">:generated_files</span><span class="s1">].map { |</span><span class="s4">filename</span><span class="s1">| </span><span class="s3">&quot;#{codegen_config[&quot;components&quot;][</span><span class="s6">:generated_dir</span><span class="s3">]}/#{filename}&quot; </span><span class="s1">})</span>
  <span class="s2">end</span>

  <span class="s2">if </span><span class="s1">js_srcs_pattern 
    file_list </span><span class="s2">= </span><span class="s3">`find #{js_srcs_dir} -type f -name #{js_srcs_pattern}`</span><span class="s1">.</span><span class="s4">split</span><span class="s1">(</span><span class="s3">&quot;</span><span class="s7">\n</span><span class="s3">&quot;</span><span class="s1">).</span><span class="s4">sort</span>
    <span class="s1">input_files </span><span class="s2">= </span><span class="s1">file_list.</span><span class="s4">map </span><span class="s1">{ |</span><span class="s4">filename</span><span class="s1">| </span><span class="s3">&quot;${PODS_TARGET_SRCROOT}/#{filename}&quot; </span><span class="s1">}</span>
  <span class="s2">else</span>
    <span class="s1">input_files </span><span class="s2">= </span><span class="s1">[ js_srcs_dir ]</span>
  <span class="s2">end</span>

  <span class="s0"># Prepare filesystem by creating empty files that will be picked up as references by CocoaPods.</span>
  <span class="s1">prepare_command </span><span class="s2">= </span><span class="s3">&quot;mkdir -p #{generated_dirs.join(&quot; &quot;)} &amp;&amp; touch -a #{generated_files.join(&quot; &quot;)}&quot;</span>
  <span class="s1">system(prepare_command) </span><span class="s0"># Always run prepare_command when a podspec uses the codegen, as CocoaPods may skip invoking this command in certain scenarios. Replace with pre_integrate_hook after updating to CocoaPods 1.11</span>
  <span class="s1">spec.</span><span class="s4">prepare_command </span><span class="s2">= </span><span class="s1">prepare_command 
</span>
  <span class="s1">env_files </span><span class="s2">= </span><span class="s1">[</span><span class="s3">&quot;$PODS_ROOT/../.xcode.env.local&quot;</span><span class="s1">, &quot;$</span><span class="s4">PODS_ROOT</span><span class="s2">/</span><span class="s1">..</span><span class="s2">/</span><span class="s1">.</span><span class="s4">xcode</span><span class="s1">.</span><span class="s4">env</span><span class="s3">&quot;] 
</span>
  <span class="s3">spec.script_phase = { 
    :name =&gt; 'Generate Specs', 
    :input_files =&gt; input_files + env_files, # This also needs to be relative to Xcode 
    :output_files =&gt; [&quot;</span><span class="s1">${</span><span class="s4">DERIVED_FILE_DIR</span><span class="s1">}</span><span class="s2">/</span><span class="s4">codegen</span><span class="s2">-</span><span class="s0">#{library_name}.log&quot;].concat(generated_files.map { |filename| &quot;${PODS_TARGET_SRCROOT}/#{filename}&quot;} ),</span>
    <span class="s0"># The final generated files will be created when this script is invoked at Xcode build time.</span>
    <span class="s6">:script </span><span class="s1">=&gt; get_script_phases_no_codegen_discovery(</span>
      <span class="s6">react_native_path: </span><span class="s1">react_native_path,</span>
      <span class="s6">codegen_output_dir: </span><span class="s1">output_dir,</span>
      <span class="s6">codegen_module_dir: </span><span class="s1">output_dir_module,</span>
      <span class="s6">codegen_component_dir: </span><span class="s1">output_dir_component,</span>
      <span class="s6">library_name: </span><span class="s1">library_name,</span>
      <span class="s6">library_type: </span><span class="s1">library_type,</span>
      <span class="s6">js_srcs_pattern: </span><span class="s1">js_srcs_pattern,</span>
      <span class="s6">js_srcs_dir: </span><span class="s1">js_srcs_dir,</span>
      <span class="s6">file_list: </span><span class="s1">file_list 
    ), 
    :</span><span class="s4">execution_position </span><span class="s1">=&gt; </span><span class="s6">:before_compile</span><span class="s1">, 
    :</span><span class="s4">show_env_vars_in_log </span><span class="s1">=&gt; </span><span class="s6">true</span>
  <span class="s1">}</span>
<span class="s4">end</span>

<span class="s0"># This provides a post_install workaround for build issues related Xcode 12.5 and Apple Silicon (M1) machines.</span>
<span class="s0"># Call this in the app's main Podfile's post_install hook.</span>
<span class="s0"># See https://github.com/facebook/react-native/issues/31480#issuecomment-902912841 for more context.</span>
<span class="s0"># Actual fix was authored by https://github.com/mikehardy.</span>
<span class="s0"># New app template will call this for now until the underlying issue is resolved.</span>
<span class="s4">def </span><span class="s1">__apply_Xcode_12_5_M1_post_install_workaround(installer)</span>
  <span class="s0"># Flipper podspecs are still targeting an older iOS deployment target, and may cause an error like:</span>
  <span class="s0">#   &quot;error: thread-local storage is not supported for the current target&quot;</span>
  <span class="s0"># The most reliable known workaround is to bump iOS deployment target to match react-native (iOS 11 now).</span>
  <span class="s1">installer.</span><span class="s4">pods_project</span><span class="s1">.</span><span class="s4">targets</span><span class="s1">.</span><span class="s4">each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">target</span><span class="s1">|</span>
    <span class="s1">target.</span><span class="s4">build_configurations</span><span class="s1">.</span><span class="s4">each </span><span class="s2">do </span><span class="s1">|</span><span class="s4">config</span><span class="s1">|</span>
      <span class="s0"># ensure IPHONEOS_DEPLOYMENT_TARGET is at least 11.0</span>
      <span class="s1">deployment_target </span><span class="s2">= </span><span class="s1">config.</span><span class="s4">build_settings</span><span class="s1">[</span><span class="s3">'IPHONEOS_DEPLOYMENT_TARGET'</span><span class="s1">].</span><span class="s4">to_f</span>
      <span class="s1">should_upgrade </span><span class="s2">= </span><span class="s1">deployment_target </span><span class="s2">&lt; </span><span class="s8">11.0 </span><span class="s2">&amp;&amp; </span><span class="s1">deployment_target </span><span class="s2">!= </span><span class="s8">0.0</span>
      <span class="s2">if </span><span class="s1">should_upgrade 
        config.</span><span class="s4">build_settings</span><span class="s1">[</span><span class="s3">'IPHONEOS_DEPLOYMENT_TARGET'</span><span class="s1">] </span><span class="s2">= </span><span class="s3">'11.0'</span>
      <span class="s2">end</span>
    <span class="s2">end</span>
  <span class="s2">end</span>

  <span class="s0"># But... doing so caused another issue in Flipper:</span>
  <span class="s0">#   &quot;Time.h:52:17: error: typedef redefinition with different types&quot;</span>
  <span class="s0"># We need to make a patch to RCT-Folly - remove the `__IPHONE_OS_VERSION_MIN_REQUIRED` check.</span>
  <span class="s0"># See https://github.com/facebook/flipper/issues/834 for more details.</span>
  <span class="s1">time_header </span><span class="s2">= </span><span class="s3">&quot;#{Pod::Config.instance.installation_root.to_s}/Pods/RCT-Folly/folly/portability/Time.h&quot;</span>
  <span class="s3">`sed -i -e  $'s/ &amp;&amp; (__IPHONE_OS_VERSION_MIN_REQUIRED &lt; __IPHONE_10_0)//' '#{time_header}'`</span>
<span class="s4">end</span>
</pre>
</body>
</html>