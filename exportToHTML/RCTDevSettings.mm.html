<html>
<head>
<title>RCTDevSettings.mm</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #bbb529;}
.s3 { color: #6a8759;}
.s4 { color: #cc7832;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
RCTDevSettings.mm</font>
</center></td></tr></table>
<pre><span class="s0">/* 
 * Copyright (c) Meta Platforms, Inc. and affiliates. 
 * 
 * This source code is licensed under the MIT license found in the 
 * LICENSE file in the root directory of this source tree. 
 */</span>

<span class="s2">#import </span><span class="s3">&quot;RCTDevSettings.h&quot;</span>

<span class="s2">#import </span><span class="s3">&lt;objc/runtime.h&gt;</span>

<span class="s2">#import </span><span class="s3">&lt;FBReactNativeSpec/FBReactNativeSpec.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTBridge+Private.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTBridgeModule.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTConstants.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTDevMenu.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTEventDispatcherProtocol.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTLog.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTProfile.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTReloadCommand.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTUtils.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;atomic&gt;</span>

<span class="s2">#import </span><span class="s3">&quot;CoreModulesPlugins.h&quot;</span>

<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingProfilingEnabled = </span><span class="s4">@</span><span class="s3">&quot;profilingEnabled&quot;</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingHotLoadingEnabled = </span><span class="s4">@</span><span class="s3">&quot;hotLoadingEnabled&quot;</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingIsInspectorShown = </span><span class="s4">@</span><span class="s3">&quot;showInspector&quot;</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingIsDebuggingRemotely = </span><span class="s4">@</span><span class="s3">&quot;isDebuggingRemotely&quot;</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingExecutorOverrideClass = </span><span class="s4">@</span><span class="s3">&quot;executor-override&quot;</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingShakeToShowDevMenu = </span><span class="s4">@</span><span class="s3">&quot;shakeToShow&quot;</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingIsPerfMonitorShown = </span><span class="s4">@</span><span class="s3">&quot;RCTPerfMonitorKey&quot;</span><span class="s4">;</span>

<span class="s4">static </span><span class="s1">NSString *</span><span class="s4">const </span><span class="s1">kRCTDevSettingsUserDefaultsKey = </span><span class="s4">@</span><span class="s3">&quot;RCTDevMenu&quot;</span><span class="s4">;</span>

<span class="s2">#if </span><span class="s1">RCT_DEV_SETTINGS_ENABLE_PACKAGER_CONNECTION</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTPackagerClient.h&gt;</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTPackagerConnection.h&gt;</span>
<span class="s2">#endif</span>

<span class="s2">#if </span><span class="s1">RCT_ENABLE_INSPECTOR</span>
<span class="s2">#import </span><span class="s3">&lt;React/RCTInspectorDevServerHelper.h&gt;</span>
<span class="s2">#endif</span>

<span class="s2">#if </span><span class="s1">RCT_DEV</span>
<span class="s4">static </span><span class="s1">BOOL devSettingsMenuEnabled = YES</span><span class="s4">;</span>
<span class="s2">#else</span>
<span class="s4">static </span><span class="s1">BOOL devSettingsMenuEnabled = NO</span><span class="s4">;</span>
<span class="s2">#endif</span>

<span class="s4">void </span><span class="s1">RCTDevSettingsSetEnabled(BOOL enabled)</span>
<span class="s1">{</span>
  <span class="s1">devSettingsMenuEnabled = enabled</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s2">#if </span><span class="s1">RCT_DEV_MENU || RCT_REMOTE_PROFILE</span>

<span class="s4">@interface </span><span class="s1">RCTDevSettingsUserDefaultsDataSource : NSObject &lt;RCTDevSettingsDataSource&gt;</span>

<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTDevSettingsUserDefaultsDataSource {</span>
  <span class="s1">NSMutableDictionary *_settings</span><span class="s4">;</span>
  <span class="s1">NSUserDefaults *_userDefaults</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (instancetype)init</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[self initWithDefaultValues:nil]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (instancetype)initWithDefaultValues:(NSDictionary *)defaultValues</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self = [super init]) {</span>
    <span class="s1">_userDefaults = [NSUserDefaults standardUserDefaults]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(defaultValues) {</span>
      <span class="s1">[self _reloadWithDefaults:defaultValues]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">self</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)updateSettingWithValue:(id)value forKey:(NSString *)key</span>
<span class="s1">{</span>
  <span class="s1">RCTAssert((key != nil)</span><span class="s4">, @</span><span class="s3">&quot;%@&quot;</span><span class="s4">, </span><span class="s1">[NSString stringWithFormat:</span><span class="s4">@</span><span class="s3">&quot;%@: Tried to update nil key&quot;</span><span class="s4">, </span><span class="s1">[self </span><span class="s4">class</span><span class="s1">]])</span><span class="s4">;</span>

  <span class="s1">id currentValue = [self settingForKey:key]</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(currentValue == value || [currentValue isEqual:value]) {</span>
    <span class="s4">return;</span>
  <span class="s1">}</span>
  <span class="s4">if </span><span class="s1">(value) {</span>
    <span class="s1">_settings[key] = value</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">[_settings removeObjectForKey:key]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">[_userDefaults setObject:_settings forKey:kRCTDevSettingsUserDefaultsKey]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (id)settingForKey:(NSString *)key</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">_settings[key]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)_reloadWithDefaults:(NSDictionary *)defaultValues</span>
<span class="s1">{</span>
  <span class="s1">NSDictionary *existingSettings = [_userDefaults objectForKey:kRCTDevSettingsUserDefaultsKey]</span><span class="s4">;</span>
  <span class="s1">_settings = existingSettings ? [existingSettings mutableCopy] : [NSMutableDictionary dictionary]</span><span class="s4">;</span>
  <span class="s4">for </span><span class="s1">(NSString *key in [defaultValues keyEnumerator]) {</span>
    <span class="s4">if </span><span class="s1">(!_settings[key]) {</span>
      <span class="s1">_settings[key] = defaultValues[key]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
  <span class="s1">[_userDefaults setObject:_settings forKey:kRCTDevSettingsUserDefaultsKey]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s2">#if </span><span class="s1">RCT_DEV_SETTINGS_ENABLE_PACKAGER_CONNECTION</span>
<span class="s4">static </span><span class="s1">RCTHandlerToken reloadToken</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">RCTHandlerToken devMenuToken</span><span class="s4">;</span>
<span class="s4">static </span><span class="s1">std::atomic&lt;</span><span class="s4">int</span><span class="s1">&gt; numInitializedModules{</span><span class="s5">0</span><span class="s1">}</span><span class="s4">;</span>
<span class="s2">#endif</span>

<span class="s4">@interface </span><span class="s1">RCTDevSettings () &lt;RCTBridgeModule</span><span class="s4">, </span><span class="s1">RCTInvalidating</span><span class="s4">, </span><span class="s1">NativeDevSettingsSpec</span><span class="s4">, </span><span class="s1">RCTDevSettingsInspectable&gt; {</span>
  <span class="s1">BOOL _isJSLoaded</span><span class="s4">;</span>
<span class="s2">#if </span><span class="s1">RCT_DEV_SETTINGS_ENABLE_PACKAGER_CONNECTION</span>
  <span class="s1">RCTHandlerToken _bridgeExecutorOverrideToken</span><span class="s4">;</span>
<span class="s2">#endif</span>
<span class="s1">}</span>

<span class="s4">@property </span><span class="s1">(nonatomic</span><span class="s4">, </span><span class="s1">strong) Class executorClass</span><span class="s4">;</span>
<span class="s4">@property </span><span class="s1">(nonatomic</span><span class="s4">, </span><span class="s1">readwrite</span><span class="s4">, </span><span class="s1">strong) id&lt;RCTDevSettingsDataSource&gt; dataSource</span><span class="s4">;</span>

<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTDevSettings</span>

<span class="s4">@synthesize </span><span class="s1">isInspectable = _isInspectable</span><span class="s4">;</span>
<span class="s4">@synthesize </span><span class="s1">bundleManager = _bundleManager</span><span class="s4">;</span>

<span class="s1">RCT_EXPORT_MODULE()</span>

<span class="s1">- (instancetype)init</span>
<span class="s1">{</span>
  <span class="s0">// Default behavior is to use NSUserDefaults with shake and hot loading enabled.</span>
  <span class="s1">NSDictionary *defaultValues = </span><span class="s4">@</span><span class="s1">{</span>
    <span class="s1">kRCTDevSettingShakeToShowDevMenu : </span><span class="s4">@</span><span class="s1">YES</span><span class="s4">,</span>
    <span class="s1">kRCTDevSettingHotLoadingEnabled : </span><span class="s4">@</span><span class="s1">YES</span><span class="s4">,</span>
  <span class="s1">}</span><span class="s4">;</span>
  <span class="s1">RCTDevSettingsUserDefaultsDataSource *dataSource =</span>
      <span class="s1">[[RCTDevSettingsUserDefaultsDataSource alloc] initWithDefaultValues:defaultValues]</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">[self initWithDataSource:dataSource]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">+ (BOOL)requiresMainQueueSetup</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">NO</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (instancetype)initWithDataSource:(id&lt;RCTDevSettingsDataSource&gt;)dataSource</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self = [super init]) {</span>
    <span class="s1">_dataSource = dataSource</span><span class="s4">;</span>

    <span class="s1">[[NSNotificationCenter defaultCenter] addObserver:self</span>
                                             <span class="s4">selector</span><span class="s1">:</span><span class="s4">@selector</span><span class="s1">(jsLoaded:)</span>
                                                 <span class="s1">name:RCTJavaScriptDidLoadNotification</span>
                                               <span class="s1">object:nil]</span><span class="s4">;</span>
    <span class="s1">[[NSNotificationCenter defaultCenter] addObserver:self</span>
                                             <span class="s4">selector</span><span class="s1">:</span><span class="s4">@selector</span><span class="s1">(jsLoaded:)</span>
                                                 <span class="s1">name:</span><span class="s4">@</span><span class="s3">&quot;RCTInstanceDidLoadBundle&quot;</span>
                                               <span class="s1">object:nil]</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">self</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)initialize</span>
<span class="s1">{</span>
<span class="s2">#if </span><span class="s1">RCT_DEV_SETTINGS_ENABLE_PACKAGER_CONNECTION</span>
  <span class="s4">if </span><span class="s1">(self.bridge) {</span>
    <span class="s1">RCTBridge *</span><span class="s4">__weak </span><span class="s1">weakBridge = self.bridge</span><span class="s4">;</span>
    <span class="s1">_bridgeExecutorOverrideToken = [[RCTPackagerConnection sharedPackagerConnection]</span>
        <span class="s1">addNotificationHandler:^(id params) {</span>
          <span class="s4">if </span><span class="s1">(params != (id)kCFNull &amp;&amp; [params[</span><span class="s4">@</span><span class="s3">&quot;debug&quot;</span><span class="s1">] boolValue]) {</span>
            <span class="s1">weakBridge.executorClass = objc_lookUpClass(</span><span class="s3">&quot;RCTWebSocketExecutor&quot;</span><span class="s1">)</span><span class="s4">;</span>
          <span class="s1">}</span>
        <span class="s1">}</span>
                         <span class="s1">queue:dispatch_get_main_queue()</span>
                     <span class="s1">forMethod:</span><span class="s4">@</span><span class="s3">&quot;reload&quot;</span><span class="s1">]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(numInitializedModules++ == </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s1">reloadToken = [[RCTPackagerConnection sharedPackagerConnection]</span>
        <span class="s1">addNotificationHandler:^(id params) {</span>
          <span class="s1">RCTTriggerReloadCommandListeners(</span><span class="s4">@</span><span class="s3">&quot;Global hotkey&quot;</span><span class="s1">)</span><span class="s4">;</span>
        <span class="s1">}</span>
                         <span class="s1">queue:dispatch_get_main_queue()</span>
                     <span class="s1">forMethod:</span><span class="s4">@</span><span class="s3">&quot;reload&quot;</span><span class="s1">]</span><span class="s4">;</span>
<span class="s2">#if </span><span class="s1">RCT_DEV_MENU</span>
    <span class="s1">devMenuToken = [[RCTPackagerConnection sharedPackagerConnection]</span>
        <span class="s1">addNotificationHandler:^(id params) {</span>
          <span class="s1">[self.bridge.devMenu show]</span><span class="s4">;</span>
        <span class="s1">}</span>
                         <span class="s1">queue:dispatch_get_main_queue()</span>
                     <span class="s1">forMethod:</span><span class="s4">@</span><span class="s3">&quot;devMenu&quot;</span><span class="s1">]</span><span class="s4">;</span>
<span class="s2">#endif</span>
  <span class="s1">}</span>
<span class="s2">#endif</span>

<span class="s2">#if </span><span class="s1">RCT_ENABLE_INSPECTOR</span>
  <span class="s4">if </span><span class="s1">(self.bridge) {</span>
    <span class="s0">// We need this dispatch to the main thread because the bridge is not yet</span>
    <span class="s0">// finished with its initialisation. By the time it relinquishes control of</span>
    <span class="s0">// the main thread, this operation can be performed.</span>
    <span class="s4">__weak __typeof</span><span class="s1">(self) weakSelf = self</span><span class="s4">;</span>
    <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
      <span class="s4">__typeof</span><span class="s1">(self) strongSelf = weakSelf</span><span class="s4">;</span>
      <span class="s4">if </span><span class="s1">(!strongSelf) {</span>
        <span class="s4">return;</span>
      <span class="s1">}</span>
      <span class="s1">id dispatchBlock = ^{</span>
        <span class="s4">__typeof</span><span class="s1">(self) strongSelf2 = weakSelf</span><span class="s4">;</span>
        <span class="s4">if </span><span class="s1">(!strongSelf2) {</span>
          <span class="s4">return;</span>
        <span class="s1">}</span>
        <span class="s1">NSURL *url = strongSelf2.bundleManager.bundleURL</span><span class="s4">;</span>
        <span class="s1">[RCTInspectorDevServerHelper connectWithBundleURL:url]</span><span class="s4">;</span>
      <span class="s1">}</span><span class="s4">;</span>
      <span class="s1">[strongSelf.bridge dispatchBlock:dispatchBlock queue:RCTJSThread]</span><span class="s4">;</span>
    <span class="s1">})</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">NSURL *url = self.bundleManager.bundleURL</span><span class="s4">;</span>
    <span class="s1">[RCTInspectorDevServerHelper connectWithBundleURL:url]</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s2">#endif</span>

  <span class="s4">__weak __typeof</span><span class="s1">(self) weakSelf = self</span><span class="s4">;</span>
  <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s1">[weakSelf _synchronizeAllSettings]</span><span class="s4">;</span>
  <span class="s1">})</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (dispatch_queue_t)methodQueue</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">dispatch_get_main_queue()</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)invalidate</span>
<span class="s1">{</span>
  <span class="s1">[super invalidate]</span><span class="s4">;</span>
<span class="s2">#if </span><span class="s1">RCT_DEV_SETTINGS_ENABLE_PACKAGER_CONNECTION</span>
  <span class="s4">if </span><span class="s1">(self.bridge) {</span>
    <span class="s1">[[RCTPackagerConnection sharedPackagerConnection] removeHandler:_bridgeExecutorOverrideToken]</span><span class="s4">;</span>
  <span class="s1">}</span>

  <span class="s4">if </span><span class="s1">(--numInitializedModules == </span><span class="s5">0</span><span class="s1">) {</span>
    <span class="s1">[[RCTPackagerConnection sharedPackagerConnection] removeHandler:reloadToken]</span><span class="s4">;</span>
<span class="s2">#if </span><span class="s1">RCT_DEV_MENU</span>
    <span class="s1">[[RCTPackagerConnection sharedPackagerConnection] removeHandler:devMenuToken]</span><span class="s4">;</span>
<span class="s2">#endif</span>
  <span class="s1">}</span>
<span class="s2">#endif</span>
<span class="s1">}</span>

<span class="s1">- (NSArray&lt;NSString *&gt; *)supportedEvents</span>
<span class="s1">{</span>
  <span class="s4">return @</span><span class="s1">[ </span><span class="s4">@</span><span class="s3">&quot;didPressMenuItem&quot; </span><span class="s1">]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)_updateSettingWithValue:(id)value forKey:(NSString *)key</span>
<span class="s1">{</span>
  <span class="s1">[_dataSource updateSettingWithValue:value forKey:key]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (id)settingForKey:(NSString *)key</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[_dataSource settingForKey:key]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isDeviceDebuggingAvailable</span>
<span class="s1">{</span>
<span class="s2">#if </span><span class="s1">RCT_ENABLE_INSPECTOR</span>
  <span class="s4">if </span><span class="s1">(self.bridge) {</span>
    <span class="s4">return </span><span class="s1">self.bridge.isInspectable</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s4">return </span><span class="s1">self.isInspectable</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s2">#else</span>
  <span class="s4">return false;</span>
<span class="s2">#endif </span><span class="s0">// RCT_ENABLE_INSPECTOR</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isRemoteDebuggingAvailable</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(RCTTurboModuleEnabled()) {</span>
    <span class="s4">return </span><span class="s1">NO</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s1">Class jsDebuggingExecutorClass = objc_lookUpClass(</span><span class="s3">&quot;RCTWebSocketExecutor&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s4">return </span><span class="s1">(jsDebuggingExecutorClass != nil)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isHotLoadingAvailable</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self.bundleManager.bundleURL) {</span>
    <span class="s4">return </span><span class="s1">!self.bundleManager.bundleURL.fileURL</span><span class="s4">;</span>
  <span class="s1">}</span>
  <span class="s4">return </span><span class="s1">NO</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(reload)</span>
<span class="s1">{</span>
  <span class="s1">RCTTriggerReloadCommandListeners(</span><span class="s4">@</span><span class="s3">&quot;Unknown From JS&quot;</span><span class="s1">)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(reloadWithReason : (NSString *)reason)</span>
<span class="s1">{</span>
  <span class="s1">RCTTriggerReloadCommandListeners(reason)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(onFastRefresh)</span>
<span class="s1">{</span>
  <span class="s1">[self.bridge onFastRefresh]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(setIsShakeToShowDevMenuEnabled : (BOOL)enabled)</span>
<span class="s1">{</span>
  <span class="s1">[self _updateSettingWithValue:</span><span class="s4">@</span><span class="s1">(enabled) forKey:kRCTDevSettingShakeToShowDevMenu]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isShakeToShowDevMenuEnabled</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[[self settingForKey:kRCTDevSettingShakeToShowDevMenu] boolValue]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(setIsDebuggingRemotely : (BOOL)enabled)</span>
<span class="s1">{</span>
  <span class="s1">[self _updateSettingWithValue:</span><span class="s4">@</span><span class="s1">(enabled) forKey:kRCTDevSettingIsDebuggingRemotely]</span><span class="s4">;</span>
  <span class="s1">[self _remoteDebugSettingDidChange]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isDebuggingRemotely</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[[self settingForKey:kRCTDevSettingIsDebuggingRemotely] boolValue]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)_remoteDebugSettingDidChange</span>
<span class="s1">{</span>
  <span class="s0">// This value is passed as a command-line argument, so fall back to reading from NSUserDefaults directly</span>
  <span class="s1">NSString *executorOverride = [[NSUserDefaults standardUserDefaults] stringForKey:kRCTDevSettingExecutorOverrideClass]</span><span class="s4">;</span>
  <span class="s1">Class executorOverrideClass = executorOverride ? NSClassFromString(executorOverride) : nil</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(executorOverrideClass) {</span>
    <span class="s1">self.executorClass = executorOverrideClass</span><span class="s4">;</span>
  <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
    <span class="s1">BOOL enabled = self.isRemoteDebuggingAvailable &amp;&amp; self.isDebuggingRemotely</span><span class="s4">;</span>
    <span class="s1">self.executorClass = enabled ? objc_getClass(</span><span class="s3">&quot;RCTWebSocketExecutor&quot;</span><span class="s1">) : nil</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(setProfilingEnabled : (BOOL)enabled)</span>
<span class="s1">{</span>
  <span class="s1">[self _updateSettingWithValue:</span><span class="s4">@</span><span class="s1">(enabled) forKey:kRCTDevSettingProfilingEnabled]</span><span class="s4">;</span>
  <span class="s1">[self _profilingSettingDidChange]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isProfilingEnabled</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[[self settingForKey:kRCTDevSettingProfilingEnabled] boolValue]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)_profilingSettingDidChange</span>
<span class="s1">{</span>
  <span class="s1">BOOL enabled = self.isProfilingEnabled</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(self.isHotLoadingAvailable &amp;&amp; enabled != RCTProfileIsProfiling()) {</span>
    <span class="s4">if </span><span class="s1">(enabled) {</span>
      <span class="s1">[self.bridge startProfiling]</span><span class="s4">;</span>
    <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
      <span class="s4">__weak __typeof</span><span class="s1">(self) weakSelf = self</span><span class="s4">;</span>
      <span class="s1">[self.bridge stopProfiling:^(NSData *logData) {</span>
        <span class="s4">__typeof</span><span class="s1">(self) strongSelf = weakSelf</span><span class="s4">;</span>
        <span class="s4">if </span><span class="s1">(!strongSelf) {</span>
          <span class="s4">return;</span>
        <span class="s1">}</span>
        <span class="s1">RCTProfileSendResult(strongSelf.bridge</span><span class="s4">, @</span><span class="s3">&quot;systrace&quot;</span><span class="s4">, </span><span class="s1">logData)</span><span class="s4">;</span>
      <span class="s1">}]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(setHotLoadingEnabled : (BOOL)enabled)</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(self.isHotLoadingEnabled != enabled) {</span>
    <span class="s1">[self _updateSettingWithValue:</span><span class="s4">@</span><span class="s1">(enabled) forKey:kRCTDevSettingHotLoadingEnabled]</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(_isJSLoaded) {</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic push</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic ignored </span><span class="s3">&quot;-Wdeprecated-declarations&quot;</span>
      <span class="s4">if </span><span class="s1">(enabled) {</span>
        <span class="s4">if </span><span class="s1">(self.callableJSModules) {</span>
          <span class="s1">[self.callableJSModules invokeModule:</span><span class="s4">@</span><span class="s3">&quot;HMRClient&quot; </span><span class="s1">method:</span><span class="s4">@</span><span class="s3">&quot;enable&quot; </span><span class="s1">withArgs:</span><span class="s4">@</span><span class="s1">[]]</span><span class="s4">;</span>
        <span class="s1">}</span>
      <span class="s1">} </span><span class="s4">else </span><span class="s1">{</span>
        <span class="s4">if </span><span class="s1">(self.callableJSModules) {</span>
          <span class="s1">[self.callableJSModules invokeModule:</span><span class="s4">@</span><span class="s3">&quot;HMRClient&quot; </span><span class="s1">method:</span><span class="s4">@</span><span class="s3">&quot;disable&quot; </span><span class="s1">withArgs:</span><span class="s4">@</span><span class="s1">[]]</span><span class="s4">;</span>
        <span class="s1">}</span>
      <span class="s1">}</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic pop</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isHotLoadingEnabled</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[[self settingForKey:kRCTDevSettingHotLoadingEnabled] boolValue]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(toggleElementInspector)</span>
<span class="s1">{</span>
  <span class="s1">BOOL value = [[self settingForKey:kRCTDevSettingIsInspectorShown] boolValue]</span><span class="s4">;</span>
  <span class="s1">[self _updateSettingWithValue:</span><span class="s4">@</span><span class="s1">(!value) forKey:kRCTDevSettingIsInspectorShown]</span><span class="s4">;</span>

  <span class="s4">if </span><span class="s1">(_isJSLoaded) {</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic push</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic ignored </span><span class="s3">&quot;-Wdeprecated-declarations&quot;</span>
    <span class="s1">[[self.moduleRegistry moduleForName:</span><span class="s3">&quot;EventDispatcher&quot;</span><span class="s1">] sendDeviceEventWithName:</span><span class="s4">@</span><span class="s3">&quot;toggleElementInspector&quot; </span><span class="s1">body:nil]</span><span class="s4">;</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic pop</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">RCT_EXPORT_METHOD(addMenuItem : (NSString *)title)</span>
<span class="s1">{</span>
  <span class="s4">__weak __typeof</span><span class="s1">(self) weakSelf = self</span><span class="s4">;</span>
  <span class="s1">[(RCTDevMenu *)[self.moduleRegistry moduleForName:</span><span class="s3">&quot;DevMenu&quot;</span><span class="s1">]</span>
      <span class="s1">addItem:[RCTDevMenuItem buttonItemWithTitle:title</span>
                                          <span class="s1">handler:^{</span>
                                            <span class="s1">[weakSelf sendEventWithName:</span><span class="s4">@</span><span class="s3">&quot;didPressMenuItem&quot; </span><span class="s1">body:</span><span class="s4">@</span><span class="s1">{</span><span class="s4">@</span><span class="s3">&quot;title&quot; </span><span class="s1">: title}]</span><span class="s4">;</span>
                                          <span class="s1">}]]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isElementInspectorShown</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[[self settingForKey:kRCTDevSettingIsInspectorShown] boolValue]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setIsPerfMonitorShown:(BOOL)isPerfMonitorShown</span>
<span class="s1">{</span>
  <span class="s1">[self _updateSettingWithValue:</span><span class="s4">@</span><span class="s1">(isPerfMonitorShown) forKey:kRCTDevSettingIsPerfMonitorShown]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (BOOL)isPerfMonitorShown</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[[self settingForKey:kRCTDevSettingIsPerfMonitorShown] boolValue]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setExecutorClass:(Class)executorClass</span>
<span class="s1">{</span>
  <span class="s1">_executorClass = executorClass</span><span class="s4">;</span>
  <span class="s4">if </span><span class="s1">(self.bridge.executorClass != executorClass) {</span>
    <span class="s0">// TODO (6929129): we can remove this special case test once we have better</span>
    <span class="s0">// support for custom executors in the dev menu. But right now this is</span>
    <span class="s0">// needed to prevent overriding a custom executor with the default if a</span>
    <span class="s0">// custom executor has been set directly on the bridge</span>
    <span class="s4">if </span><span class="s1">(executorClass == Nil &amp;&amp; self.bridge.executorClass != objc_lookUpClass(</span><span class="s3">&quot;RCTWebSocketExecutor&quot;</span><span class="s1">)) {</span>
      <span class="s4">return;</span>
    <span class="s1">}</span>

    <span class="s1">self.bridge.executorClass = executorClass</span><span class="s4">;</span>
    <span class="s1">RCTTriggerReloadCommandListeners(</span><span class="s4">@</span><span class="s3">&quot;Custom executor class reset&quot;</span><span class="s1">)</span><span class="s4">;</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)addHandler:(id&lt;RCTPackagerClientMethod&gt;)handler forPackagerMethod:(NSString *)name</span>
<span class="s1">{</span>
<span class="s2">#if </span><span class="s1">RCT_DEV_SETTINGS_ENABLE_PACKAGER_CONNECTION</span>
  <span class="s1">[[RCTPackagerConnection sharedPackagerConnection] addHandler:handler forMethod:name]</span><span class="s4">;</span>
<span class="s2">#endif</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setupHMRClientWithBundleURL:(NSURL *)bundleURL</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(bundleURL &amp;&amp; !bundleURL.fileURL) {</span>
    <span class="s1">NSURLComponents *urlComponents = [[NSURLComponents alloc] initWithURL:bundleURL resolvingAgainstBaseURL:NO]</span><span class="s4">;</span>
    <span class="s1">NSString *</span><span class="s4">const </span><span class="s1">path = [urlComponents.path substringFromIndex:</span><span class="s5">1</span><span class="s1">]</span><span class="s4">; </span><span class="s0">// Strip initial slash.</span>
    <span class="s1">NSString *</span><span class="s4">const </span><span class="s1">host = urlComponents.host</span><span class="s4">;</span>
    <span class="s1">NSNumber *</span><span class="s4">const </span><span class="s1">port = urlComponents.port</span><span class="s4">;</span>
    <span class="s1">NSString *</span><span class="s4">const </span><span class="s1">scheme = urlComponents.scheme</span><span class="s4">;</span>
    <span class="s1">BOOL isHotLoadingEnabled = self.isHotLoadingEnabled</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(self.callableJSModules) {</span>
      <span class="s1">[self.callableJSModules invokeModule:</span><span class="s4">@</span><span class="s3">&quot;HMRClient&quot;</span>
                                    <span class="s1">method:</span><span class="s4">@</span><span class="s3">&quot;setup&quot;</span>
                                  <span class="s1">withArgs:</span><span class="s4">@</span><span class="s1">[ </span><span class="s4">@</span><span class="s3">&quot;ios&quot;</span><span class="s4">, </span><span class="s1">path</span><span class="s4">, </span><span class="s1">host</span><span class="s4">, </span><span class="s1">RCTNullIfNil(port)</span><span class="s4">, @</span><span class="s1">(isHotLoadingEnabled)</span><span class="s4">, </span><span class="s1">scheme ]]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setupHMRClientWithAdditionalBundleURL:(NSURL *)bundleURL</span>
<span class="s1">{</span>
  <span class="s4">if </span><span class="s1">(bundleURL &amp;&amp; !bundleURL.fileURL) { </span><span class="s0">// isHotLoadingAvailable check</span>
    <span class="s4">if </span><span class="s1">(self.callableJSModules) {</span>
      <span class="s1">[self.callableJSModules invokeModule:</span><span class="s4">@</span><span class="s3">&quot;HMRClient&quot;</span>
                                    <span class="s1">method:</span><span class="s4">@</span><span class="s3">&quot;registerBundle&quot;</span>
                                  <span class="s1">withArgs:</span><span class="s4">@</span><span class="s1">[ [bundleURL absoluteString] ]]</span><span class="s4">;</span>
    <span class="s1">}</span>
  <span class="s1">}</span>
<span class="s1">}</span>

<span class="s2">#pragma </span><span class="s1">mark - Internal</span>

<span class="s0">/** 
 *  Query the data source for all possible settings and make sure we're doing the right 
 *  thing for the state of each setting. 
 */</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)_synchronizeAllSettings</span>
<span class="s1">{</span>
  <span class="s1">[self _remoteDebugSettingDidChange]</span><span class="s4">;</span>
  <span class="s1">[self _profilingSettingDidChange]</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (</span><span class="s4">void</span><span class="s1">)jsLoaded:(NSNotification *)notification</span>
<span class="s1">{</span>
  <span class="s0">// In bridge mode, the bridge that sent the notif must be the same as the one stored in this module.</span>
  <span class="s0">// In bridgless mode, we don't care about this.</span>
  <span class="s4">if </span><span class="s1">([notification.name isEqualToString:RCTJavaScriptDidLoadNotification] &amp;&amp;</span>
      <span class="s1">notification.userInfo[</span><span class="s4">@</span><span class="s3">&quot;bridge&quot;</span><span class="s1">] != self.bridge) {</span>
    <span class="s4">return;</span>
  <span class="s1">}</span>

  <span class="s1">_isJSLoaded = YES</span><span class="s4">;</span>
  <span class="s4">__weak __typeof</span><span class="s1">(self) weakSelf = self</span><span class="s4">;</span>
  <span class="s1">dispatch_async(dispatch_get_main_queue()</span><span class="s4">, </span><span class="s1">^{</span>
    <span class="s4">__typeof</span><span class="s1">(self) strongSelf = weakSelf</span><span class="s4">;</span>
    <span class="s4">if </span><span class="s1">(!strongSelf) {</span>
      <span class="s4">return;</span>
    <span class="s1">}</span>
    <span class="s0">// update state again after the bridge has finished loading</span>
    <span class="s1">[strongSelf _synchronizeAllSettings]</span><span class="s4">;</span>

    <span class="s0">// Inspector can only be shown after JS has loaded</span>
    <span class="s4">if </span><span class="s1">([strongSelf isElementInspectorShown]) {</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic push</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic ignored </span><span class="s3">&quot;-Wdeprecated-declarations&quot;</span>
      <span class="s1">[[strongSelf.moduleRegistry moduleForName:</span><span class="s3">&quot;EventDispatcher&quot;</span><span class="s1">] sendDeviceEventWithName:</span><span class="s4">@</span><span class="s3">&quot;toggleElementInspector&quot;</span>
                                                                                      <span class="s1">body:nil]</span><span class="s4">;</span>
<span class="s2">#pragma </span><span class="s1">clang diagnostic pop</span>
    <span class="s1">}</span>
  <span class="s1">})</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s1">- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:</span>
    <span class="s1">(</span><span class="s4">const </span><span class="s1">facebook::react::ObjCTurboModule::InitParams &amp;)params</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">std::make_shared&lt;facebook::react::NativeDevSettingsSpecJSI&gt;(params)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s2">#else </span><span class="s0">// #if RCT_DEV_MENU</span>

<span class="s4">@interface </span><span class="s1">RCTDevSettings () &lt;NativeDevSettingsSpec&gt;</span>
<span class="s4">@end</span>

<span class="s4">@implementation </span><span class="s1">RCTDevSettings</span>

<span class="s1">- (instancetype)initWithDataSource:(id&lt;RCTDevSettingsDataSource&gt;)dataSource</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">[super init]</span><span class="s4">;</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)initialize</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (BOOL)isHotLoadingAvailable</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">NO</span><span class="s4">;</span>
<span class="s1">}</span>
<span class="s1">- (BOOL)isRemoteDebuggingAvailable</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">NO</span><span class="s4">;</span>
<span class="s1">}</span>
<span class="s1">+ (BOOL)requiresMainQueueSetup</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">NO</span><span class="s4">;</span>
<span class="s1">}</span>
<span class="s1">- (id)settingForKey:(NSString *)key</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">nil</span><span class="s4">;</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)reload</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)reloadWithReason:(NSString *)reason</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)onFastRefresh</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setHotLoadingEnabled:(BOOL)isHotLoadingEnabled</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setIsDebuggingRemotely:(BOOL)isDebuggingRemotelyEnabled</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setProfilingEnabled:(BOOL)isProfilingEnabled</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)toggleElementInspector</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setupHMRClientWithBundleURL:(NSURL *)bundleURL</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setupHMRClientWithAdditionalBundleURL:(NSURL *)bundleURL</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)addMenuItem:(NSString *)title</span>
<span class="s1">{</span>
<span class="s1">}</span>
<span class="s1">- (</span><span class="s4">void</span><span class="s1">)setIsShakeToShowDevMenuEnabled:(BOOL)enabled</span>
<span class="s1">{</span>
<span class="s1">}</span>

<span class="s1">- (std::shared_ptr&lt;facebook::react::TurboModule&gt;)getTurboModule:</span>
    <span class="s1">(</span><span class="s4">const </span><span class="s1">facebook::react::ObjCTurboModule::InitParams &amp;)params</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">std::make_shared&lt;facebook::react::NativeDevSettingsSpecJSI&gt;(params)</span><span class="s4">;</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s2">#endif </span><span class="s0">// #if RCT_DEV_MENU</span>

<span class="s4">@implementation </span><span class="s1">RCTBridge (RCTDevSettings)</span>

<span class="s1">- (RCTDevSettings *)devSettings</span>
<span class="s1">{</span>
<span class="s2">#if </span><span class="s1">RCT_REMOTE_PROFILE</span>
  <span class="s4">return </span><span class="s1">[self moduleForClass:[RCTDevSettings </span><span class="s4">class</span><span class="s1">]]</span><span class="s4">;</span>
<span class="s2">#elif </span><span class="s1">RCT_DEV_MENU</span>
  <span class="s4">return </span><span class="s1">devSettingsMenuEnabled ? [self moduleForClass:[RCTDevSettings </span><span class="s4">class</span><span class="s1">]] : nil</span><span class="s4">;</span>
<span class="s2">#else</span>
  <span class="s4">return </span><span class="s1">nil</span><span class="s4">;</span>
<span class="s2">#endif</span>
<span class="s1">}</span>

<span class="s4">@end</span>

<span class="s1">Class RCTDevSettingsCls(</span><span class="s4">void</span><span class="s1">)</span>
<span class="s1">{</span>
  <span class="s4">return </span><span class="s1">RCTDevSettings.</span><span class="s4">class;</span>
<span class="s1">}</span>
</pre>
</body>
</html>